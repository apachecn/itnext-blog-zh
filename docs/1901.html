<html>
<head>
<title>On gRPC Load Balancing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">gRPCè´Ÿè½½å‡è¡¡ç ”ç©¶</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://itnext.io/on-grpc-load-balancing-683257c5b7b3?source=collection_archive---------1-----------------------#2019-02-21">https://itnext.io/on-grpc-load-balancing-683257c5b7b3?source=collection_archive---------1-----------------------#2019-02-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="8fe7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ç»§Williamåœ¨Kubernetes without Tears  ä¸Šå‘è¡¨äº†å…³äº<a class="ae ko" href="https://kubernetes.io/blog/2018/11/07/grpc-load-balancing-on-kubernetes-without-tears/" rel="noopener ugc nofollow" target="_blank"> <em class="kp"> gRPCè´Ÿè½½å‡è¡¡çš„å¸–å­ä¹‹åï¼Œæˆ‘å¼€å§‹æœ‰å…´è¶£äº†è§£å®ç°gRPCè´Ÿè½½å‡è¡¡å®é™…éœ€è¦åšå¤šå°‘å·¥ä½œã€‚</em></a></p><p id="9d91" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘æƒ³ä¸ä½ åˆ†äº«æˆ‘æ‰€å­¦åˆ°çš„å…³äºä½¿ç”¨<a class="ae ko" href="https://godoc.org/google.golang.org/grpc" rel="noopener ugc nofollow" target="_blank"> gRPC-Go </a> <code class="fe kq kr ks kt b"><a class="ae ko" href="https://godoc.org/google.golang.org/grpc/balancer" rel="noopener ugc nofollow" target="_blank">balancer</a></code>å’Œ<code class="fe kq kr ks kt b"><a class="ae ko" href="https://godoc.org/google.golang.org/grpc/resolver" rel="noopener ugc nofollow" target="_blank">resolver</a></code>åŒ…æ¥å®ç°ç®€å•çš„å®¢æˆ·ç«¯å¾ªç¯è´Ÿè½½å‡è¡¡ã€‚ç„¶åï¼Œæˆ‘å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨Linkerd 2è‡ªåŠ¨å¯¹gRPCæµé‡è¿›è¡Œè´Ÿè½½å¹³è¡¡ï¼Œè€Œæ— éœ€æ›´æ”¹ä»»ä½•åº”ç”¨ç¨‹åºä»£ç æˆ–éƒ¨ç½²é¢å¤–çš„è´Ÿè½½å¹³è¡¡å™¨ã€‚</p><p id="ced0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">æˆ‘å·²ç»åœ¨æˆ‘çš„<a class="ae ko" href="https://github.com/ihcsim/routeguide" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>ä¸Šå‘å¸ƒäº†è¿™ç¯‡æ–‡ç« ä¸­ä½¿ç”¨çš„ä»£ç ã€‚gRPCåº”ç”¨ç¨‹åºç»è¿‡ä»¥ä¸‹æµ‹è¯•:</p><ul class=""><li id="16b1" class="ku kv it js b jt ju jx jy kb kw kf kx kj ky kn kz la lb lc bi translated">å»1.11.5</li><li id="1b98" class="ku kv it js b jt ld jx le kb lf kf lg kj lh kn kz la lb lc bi translated">è®®å®šä¹¦3.6.1</li><li id="544f" class="ku kv it js b jt ld jx le kb lf kf lg kj lh kn kz la lb lc bi translated">gRPC 1.18</li></ul><h1 id="29c5" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„</h1><p id="236e" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">è®©æˆ‘ä»¬æ¢ç´¢gRPCå®¢æˆ·ç«¯è´Ÿè½½å¹³è¡¡å·¥ä½œæ‰€éœ€çš„ä¸¤ä¸ªä¸»è¦ç»„ä»¶ï¼›<a class="ae ko" href="https://github.com/grpc/grpc/blob/master/doc/naming.md" rel="noopener ugc nofollow" target="_blank">åç§°è§£æå™¨</a>å’Œ<a class="ae ko" href="https://github.com/grpc/grpc/blob/master/doc/load-balancing.md" rel="noopener ugc nofollow" target="_blank">è´Ÿè½½å¹³è¡¡ç­–ç•¥</a>ã€‚</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi ml"><img src="../Images/8158bac8fda9b25289939eaa08ef4a4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xgv7HwMIXeERfCWZ3lKweg.png"/></div></div></figure><h2 id="d01a" class="mx lj it bd lk my mz dn lo na nb dp ls kb nc nd lw kf ne nf ma kj ng nh me ni bi translated">åå­—è§£æ</h2><p id="881a" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">å½“gRPCå®¢æˆ·æœºæƒ³è¦ä¸gRPCæœåŠ¡å™¨è¿›è¡Œäº¤äº’æ—¶ï¼Œå®ƒé¦–å…ˆå°è¯•é€šè¿‡å‘è§£æå™¨å‘å‡ºåç§°è§£æè¯·æ±‚æ¥è§£ææœåŠ¡å™¨åç§°ã€‚è§£æå™¨è¿”å›å·²è§£æçš„IPåœ°å€åˆ—è¡¨ã€‚æ¯ä¸ªIPåœ°å€éƒ½ä¸ä¸€ä¸ªæŒ‡ç¤ºå™¨ç›¸å…³è”ï¼Œç”¨äºç¡®å®šå®ƒæ˜¯åç«¯åœ°å€è¿˜æ˜¯è´Ÿè½½å¹³è¡¡å™¨åœ°å€ã€‚æ­¤å¤–ï¼Œè¿˜ä¼šè¿”å›ä¸€ä¸ª<a class="ae ko" href="https://github.com/grpc/grpc/blob/master/doc/service_config.md" rel="noopener ugc nofollow" target="_blank">æœåŠ¡é…ç½®</a>å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«æœ‰å…³ä½¿ç”¨å“ªä¸ªè´Ÿè½½å¹³è¡¡ç­–ç•¥çš„ä¿¡æ¯ã€‚</p><p id="1a7d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">é»˜è®¤æƒ…å†µä¸‹ï¼ŒgRPCä½¿ç”¨<code class="fe kq kr ks kt b">dns</code>ä½œä¸ºå®ƒçš„é»˜è®¤åç§°ç³»ç»Ÿã€‚</p><p id="4227" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">å‡ºäºä»£ç æ¼”ç¤ºçš„ç›®çš„ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨<code class="fe kq kr ks kt b">manual</code>è§£æå™¨ã€‚åœ¨å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åƒè¿™æ ·åˆ›å»ºå’Œæ³¨å†Œè§£æå™¨:</p><pre class="mm mn mo mp gt nj kt nk nl aw nm bi"><span id="efe2" class="mx lj it kt b gy nn no l np nq">// create a manual.Resolver with a random scheme<br/>resolver, _ := manual.GenerateAndRegisterManualResolver()</span><span id="fde0" class="mx lj it kt b gy nr no l np nq">// define the initial list of addresses<br/>resolver.InitialAddrs([]resolver.Address{<br/>  resolver.Address{Addr:"10.0.0.10", Type: resolver.Backend},<br/>  resolver.Address{Addr:"10.0.0.11", Type: resolver.Backend},<br/>  resolver.Address{Addr:"10.0.0.12", Type: resolver.Backend},<br/>})</span><span id="1f6a" class="mx lj it kt b gy nr no l np nq">// set the default name resolution scheme to that of the resolver<br/>resolver.SetDefaultScheme(resolver.Scheme())</span></pre><ol class=""><li id="d787" class="ku kv it js b jt ju jx jy kb kw kf kx kj ky kn ns la lb lc bi translated"><code class="fe kq kr ks kt b">manual.GenerateAndRegisterManualResolver()</code>æ–¹æ³•è¿”å›ä¸€ä¸ª<code class="fe kq kr ks kt b">manual.Resolver</code>ç±»å‹çš„è§£æå™¨ã€‚è¿™ä¸ªè§£æå™¨æ˜¯ç”¨éšæœºå‘½åæ–¹æ¡ˆåˆ›å»ºçš„ã€‚ç”±äºè§£æçš„IPåœ°å€æ˜¯æ‰‹åŠ¨æ·»åŠ çš„(åœ¨æ­¥éª¤2ä¸­)ï¼Œæ‰€ä»¥è¿™ä¸ªè§£æå™¨çš„æ–¹æ¡ˆæ˜¯ä»€ä¹ˆå¹¶ä¸é‡è¦ã€‚</li><li id="ffbc" class="ku kv it js b jt ld jx le kb lf kf lg kj lh kn ns la lb lc bi translated"><code class="fe kq kr ks kt b">manual.InitialAddrs()</code>æ–¹æ³•å…è®¸æˆ‘ä»¬æ³¨å†Œä¸€ä¸ªç”¨äºå‘½åè§£æçš„åœ°å€åˆ—è¡¨ã€‚</li><li id="e8da" class="ku kv it js b jt ld jx le kb lf kf lg kj lh kn ns la lb lc bi translated">æœ€åï¼Œ<code class="fe kq kr ks kt b">resolver.SetDefaultScheme()</code>æ–¹æ³•ç”¨äºå°†åº”ç”¨ç¨‹åºçš„é»˜è®¤å‘½åè§£ææ–¹æ¡ˆè®¾ç½®ä¸ºæ–°è§£æå™¨çš„æ–¹æ¡ˆã€‚</li></ol><p id="e6b9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">æœ‰äº†è¿™ä¸ªï¼Œæ¯å½“å®¢æˆ·ç«¯éœ€è¦è§£ææœåŠ¡å™¨åç§°æ—¶ï¼Œè§£æå™¨å°†æ€»æ˜¯è¿”å›è¿™äº›(<strong class="js iu">å¹¶ä¸”åªè¿”å›è¿™äº›</strong>)æ³¨å†Œçš„åœ°å€ã€‚</p><h2 id="44db" class="mx lj it bd lk my mz dn lo na nb dp ls kb nc nd lw kf ne nf ma kj ng nh me ni bi translated">è´Ÿè½½å¹³è¡¡ç­–ç•¥</h2><p id="f53e" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">ç¬¬äºŒä¸ªç»„ä»¶æ˜¯è´Ÿè½½å¹³è¡¡ç­–ç•¥ã€‚gRPC-Goåº“ä¸­çš„ä¸¤ä¸ªå†…ç½®ç­–ç•¥æ˜¯<code class="fe kq kr ks kt b">roundrobin</code>å’Œ<code class="fe kq kr ks kt b">grpclb</code>ç­–ç•¥ã€‚<code class="fe kq kr ks kt b">grpclb </code>ç­–ç•¥é€šå¸¸ä¸åƒ<a class="ae ko" href="https://github.com/bsm/grpclb" rel="noopener ugc nofollow" target="_blank">è¿™æ ·çš„å¤–éƒ¨è´Ÿè½½å¹³è¡¡å™¨ä¸€èµ·ä½¿ç”¨ã€‚è¿˜æœ‰ä¸€ä¸ª<code class="fe kq kr ks kt b"><a class="ae ko" href="https://godoc.org/google.golang.org/grpc/balancer/base" rel="noopener ugc nofollow" target="_blank">base</a></code>ç­–ç•¥ï¼Œé€šå¸¸ç”¨äºæ„å»ºæ›´å¤æ‚çš„æ‹£é€‰ç®—æ³•ã€‚</a></p><p id="d72e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">å¯¹äºè§£æå™¨è¿”å›çš„æ¯ä¸ªéè´Ÿè½½å¹³è¡¡å™¨åœ°å€ï¼Œè´Ÿè½½å¹³è¡¡ç­–ç•¥åˆ›å»ºä¸€ä¸ªåˆ°è¯¥åœ°å€çš„æ–°å­è¿æ¥ã€‚ç„¶åï¼Œè¯¥ç­–ç•¥è¿”å›ä¸€ä¸ªé€‰å–å™¨ï¼Œè¯¥é€‰å–å™¨ä¸ºå®¢æˆ·ç«¯æä¾›ä¸€ä¸ªæ¥å£ï¼Œä»¥æ£€ç´¢ç”¨äºè¿›è¡ŒRPCè°ƒç”¨çš„å­è¿æ¥ã€‚</p><p id="0bd1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ä»¥ä¸‹ä»£ç ç‰‡æ®µæ˜¾ç¤ºäº†å¦‚ä½•é€šè¿‡å°†å®¢æˆ·ç«¯å¾ªç¯è´Ÿè½½å¹³è¡¡ç­–ç•¥æŒ‡å®šä¸º<code class="fe kq kr ks kt b">grpc.DialOption</code>æ¥å¯ç”¨å®ƒ:</p><pre class="mm mn mo mp gt nj kt nk nl aw nm bi"><span id="c0db" class="mx lj it kt b gy nn no l np nq">opts := []grpc.DialOption{<br/>  grpc.WithBalancerName(roundrobin.Name)),<br/>  // ....<br/>}<br/>conn, err := grpc.Dial(serverAddr, opts...)</span></pre><h1 id="38f3" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">è¿è¡Œåº”ç”¨ç¨‹åº</h1><p id="1d72" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">æœ¬ä¾‹ä¸­ä½¿ç”¨çš„gRPCæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºåŸºäº<a class="ae ko" href="https://grpc.io/docs/tutorials/basic/go.html" rel="noopener ugc nofollow" target="_blank"> gRPC Basic - Go </a>é¡µé¢ä¸Šçš„<code class="fe kq kr ks kt b">routeguide</code>ç¤ºä¾‹ï¼Œå¹¶åšäº†ä»¥ä¸‹ä¿®æ”¹:</p><ul class=""><li id="1448" class="ku kv it js b jt ju jx jy kb kw kf kx kj ky kn kz la lb lc bi translated">æœåŠ¡å™¨å®ç°å¥åº·æ£€æŸ¥ï¼Œå¹¶ä½¿ç”¨æ‹¦æˆªå™¨æ¥æ¨¡æ‹Ÿé”™è¯¯å“åº”ã€‚</li><li id="f9b0" class="ku kv it js b jt ld jx le kb lf kf lg kj lh kn kz la lb lc bi translated">å®¢æˆ·ç«¯å¯ä»¥åœ¨<code class="fe kq kr ks kt b">firehose</code>æˆ–<code class="fe kq kr ks kt b">repeat-N</code>æ¨¡å¼ä¸‹å¯åŠ¨ã€‚<code class="fe kq kr ks kt b">firehose</code>æ¨¡å¼å¯¼è‡´å®¢æˆ·ç«¯åœ¨ä¸€ä¸ªæ— é™å¾ªç¯ä¸­å‘æ‰€æœ‰4ä¸ªAPIå‘å‡ºéšæœºè°ƒç”¨ã€‚<code class="fe kq kr ks kt b">repeat-N</code>æ¨¡å¼æ›´é€‚åˆéœ€è¦æ›´å¤šæ§åˆ¶å’Œå¯é¢„æµ‹æ€§çš„æµ‹è¯•ï¼Œé€šè¿‡å‘é¢„å…ˆé€‰æ‹©çš„APIå‘å‡ºNä¸ªè°ƒç”¨ï¼Œç„¶åç»ˆæ­¢ã€‚</li></ul><p id="fa95" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">å¯ä»¥ä½¿ç”¨<code class="fe kq kr ks kt b">make server</code>ç›®æ ‡æ¥å¯åŠ¨æœåŠ¡å™¨ã€‚</p><pre class="mm mn mo mp gt nj kt nk nl aw nm bi"><span id="1c64" class="mx lj it kt b gy nn no l np nq">$ make server <br/>go build -o ./cmd/server/server ./cmd/server/ <br/>./cmd/server/server -port=8080 -fault-percent=0.3 <br/>2019/02/20 20:08:49 [main] fault percentage: 30% <br/>2019/02/20 20:08:49 [main] hostname: orca:8080</span></pre><p id="9311" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œåœ¨ä¸è¿›è¡Œè´Ÿè½½å¹³è¡¡çš„æƒ…å†µä¸‹å¯åŠ¨å®¢æˆ·ç«¯:</p><pre class="mm mn mo mp gt nj kt nk nl aw nm bi"><span id="dda2" class="mx lj it kt b gy nn no l np nq">$ ENABLE_LOAD_BALANCING=false make client<br/>go build -o ./cmd/client/client ./cmd/client/ <br/>./cmd/client/client \ <br/>        -server=:8080 \ <br/>        -timeout=20s \ <br/>        -mode=REPEATN \ <br/>        -api=GetFeature \ <br/>        -n=15 \ <br/>        -enable-load-balancing=false \ <br/>        -server-ipv4=127.0.0.1:8080,127.0.0.1:8081,127.0.0.1:8082<br/>2019/02/18 20:35:35 [main] connecting to server at :8080 <br/>2019/02/18 20:35:35 [main] running in REPEATN mode <br/>2019/02/18 20:35:35 [main] calling getfeature 15 times <br/>2019/02/18 20:35:35 [GetFeature] (req) latitude:402133926 longitude:-743613249 <br/>2019/02/18 20:35:35 [GetFeature] (resp) (<strong class="kt iu">server=orca:8080</strong>) location:&lt;latitude:402133926 longitude:-743613249 &gt; <br/>2019/02/18 20:35:38 [GetFeature] (req) latitude:411349992 longitude:-743694161 <br/>2019/02/18 20:35:38 [GetFeature] (resp) (<strong class="kt iu">server=orca:8080</strong>) location:&lt;latitude:411349992 longitude:-743694161 &gt; <br/>2019/02/18 20:35:41 [GetFeature] (req) latitude:416855156 longitude:-744420597 <br/>...</span></pre><p id="bda1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">é»˜è®¤æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯è¢«é…ç½®ä¸ºè°ƒç”¨<code class="fe kq kr ks kt b">GetFeature</code> API 15æ¬¡ã€‚ä»å®¢æˆ·ç«¯æ—¥å¿—ä¸­æ³¨æ„åˆ°ï¼Œæ‰€æœ‰å“åº”éƒ½æ¥è‡ª<code class="fe kq kr ks kt b">orca:8080</code>ã€‚</p><p id="b6b3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ç°åœ¨åœ¨ç«¯å£8081å’Œ8082ä¸Šå†å¯åŠ¨ä¸¤ä¸ªæœåŠ¡å™¨å®ä¾‹:</p><pre class="mm mn mo mp gt nj kt nk nl aw nm bi"><span id="784b" class="mx lj it kt b gy nn no l np nq">$ SERVER_PORT=8081 make server &amp;<br/>$ SERVER_PORT=8082 make server &amp;</span></pre><p id="e010" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">åœ¨å¯ç”¨è´Ÿè½½å¹³è¡¡çš„æƒ…å†µä¸‹é‡æ–°å¯åŠ¨å®¢æˆ·ç«¯:</p><pre class="mm mn mo mp gt nj kt nk nl aw nm bi"><span id="8e74" class="mx lj it kt b gy nn no l np nq">$ make client<br/>go build -o ./cmd/client/client ./cmd/client/ <br/>./cmd/client/client \ <br/>        -server=:8080 \ <br/>        -timeout=20s \ <br/>        -mode=REPEATN \ <br/>        -api=GetFeature \ <br/>        -n=15 \ <br/>        -enable-load-balancing=true \ <br/>        -server-ipv4=127.0.0.1:8080,127.0.0.1:8081,127.0.0.1:8082<br/>2019/02/18 20:58:07 [main] load balancing scheme: round_robin <br/>2019/02/18 20:58:07 [main] resolver type: manual <br/>2019/02/18 20:58:07 [main] connecting to server at :8080 <br/>2019/02/18 20:58:07 [main] running in REPEATN mode <br/>2019/02/18 20:58:07 [main] calling getfeature 15 times <br/>2019/02/18 20:58:07 [GetFeature] (req) latitude:402133926 longitude:-743613249 <br/>2019/02/18 20:58:07 [GetFeature] (resp) (<strong class="kt iu">server=orca:8081</strong>) location:&lt;latitude:402133926 longitude:-743613249 &gt; <br/>2019/02/18 20:58:10 [GetFeature] (req) latitude:411349992 longitude:-743694161 <br/>2019/02/18 20:58:10 [GetFeature] (resp) (<strong class="kt iu">server=orca:8082</strong>) location:&lt;latitude:411349992 longitude:-743694161 &gt; <br/>2019/02/18 20:58:13 [GetFeature] (req) latitude:416855156 longitude:-744420597 <br/>2019/02/18 20:58:13 [GetFeature] (resp) (<strong class="kt iu">server=orca:8080</strong>) name:"103-271 Tempaloni Road, Ellenville, NY 12428, USA" location:&lt;latitude:416855156 longitude:-744420597 &gt; <br/>2019/02/18 20:58:16 [GetFeature] (req) latitude:409146138 longitude:-746188906 <br/>2019/02/18 20:58:16 [GetFeature] (resp) (<strong class="kt iu">server=orca:8081</strong>) name:"Berkshire Valley Management Area Trail, Jefferson, NJ, USA" location:&lt;latitude:409146138 longitude:-746188906 &gt; <br/>...</span></pre><p id="c74f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å“åº”æ˜¯ä»<code class="fe kq kr ks kt b">orca:8080</code>ã€<code class="fe kq kr ks kt b">orca:8081</code>å’Œ<code class="fe kq kr ks kt b">orca:8082</code>è¿”å›çš„ã€‚</p><p id="bbda" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">å¤ªå¥½äº†ï¼çœ‹èµ·æ¥æˆ‘ä»¬çš„å®¢æˆ·ç«¯å¾ªç¯è´Ÿè½½å¹³è¡¡åœ¨æœ¬åœ°ä¸»æœºä¸Šå·¥ä½œğŸ‘ ğŸ‘ ğŸˆ ğŸˆã€‚</p><h1 id="4414" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">åœ¨Kubernetes</h1><p id="2dd0" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">æˆ‘ä»¬è¯•ç€åœ¨Kubernetesä¸Šè¿è¡Œä¸€ä¸‹ã€‚<a class="ae ko" href="https://github.com/ihcsim/routeguide/blob/master/k8s-server.yaml" rel="noopener ugc nofollow" target="_blank"> k8s-server.yaml </a>å’Œ<a class="ae ko" href="https://github.com/ihcsim/routeguide/blob/master/k8s-client.yaml" rel="noopener ugc nofollow" target="_blank"> k8s.client.yaml </a>æ¸…å•æ–‡ä»¶å°†éƒ¨ç½²3ä¸ªgRPCæœåŠ¡å™¨å‰¯æœ¬å’Œä¸€ä¸ªgRPCå®¢æˆ·ç«¯ã€‚æœåŠ¡å™¨å’Œå®¢æˆ·æœºéƒ½ä»å®ƒä»¬çš„é…ç½®å›¾ä¸­è¯»å–å®ƒä»¬çš„é…ç½®ã€‚</p><p id="2674" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">é»˜è®¤æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯è¢«é…ç½®ä¸ºä½¿ç”¨<code class="fe kq kr ks kt b">dns</code>è§£æå™¨ç±»å‹ã€‚æˆ‘ä»¬å°†æ— æ³•ä½¿ç”¨<code class="fe kq kr ks kt b">manual</code>è§£æå™¨ç±»å‹ï¼Œå› ä¸ºæˆ‘ä»¬äº‹å…ˆä¸çŸ¥é“æœåŠ¡å™¨çš„pod IPã€‚æˆ‘ä»¬ä¹Ÿæ²¡æœ‰ä¸€ä¸ªç›‘è§†å™¨æ¥ç›‘è§†podçš„IPåœ°å€ã€‚</p><p id="a900" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ä»¥ä¸‹æ˜¯å®¢æˆ·ç«¯çš„é»˜è®¤é…ç½®:</p><pre class="mm mn mo mp gt nj kt nk nl aw nm bi"><span id="730a" class="mx lj it kt b gy nn no l np nq">kind: ConfigMap<br/>apiVersion: v1<br/>metadata:<br/>  name: rg-client-config<br/>  labels:<br/>    app: rg-client<br/>data:<br/>  SERVER_HOST: rg-server.default.svc.cluster.local<br/>  SERVER_PORT: "80"<br/>  GRPC_TIMEOUT: 60s<br/>  MODE: repeatn<br/>  MAX_REPEAT: "20"<br/>  REMOTE_API: GetFeature<br/>  ENABLE_LOAD_BALANCING: "true"<br/>  RESOLVER_TYPE: dns</span></pre><p id="d190" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">è¦å°†æœåŠ¡å™¨å’Œå®¢æˆ·æœºéƒ¨ç½²åˆ°Kubernetesé›†ç¾¤ï¼Œè¿è¡Œ:</p><pre class="mm mn mo mp gt nj kt nk nl aw nm bi"><span id="78d7" class="mx lj it kt b gy nn no l np nq">$ make deploy</span></pre><p id="107d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">å®¢æˆ·ç«¯æ—¥å¿—æ˜¾ç¤ºæ‰€æœ‰å“åº”éƒ½æ˜¯ä»ä¸€ä¸ª(è€Œä¸æ˜¯æ‰€æœ‰)æœåŠ¡å™¨å®ä¾‹è¿”å›çš„ã€‚è¿™ä»¤äººå¤±æœ›ï¼Œä½†å¹¶ä¸å¥‡æ€ªğŸ˜¦ã€‚</p><pre class="mm mn mo mp gt nj kt nk nl aw nm bi"><span id="6afb" class="mx lj it kt b gy nn no l np nq">$ kubectl logs -f rg-client <br/>2019/02/20 05:27:21 [main] load balancing scheme: round_robin <br/>2019/02/20 05:27:21 [main] resolver type: dns <br/>2019/02/20 05:27:21 [main] connecting to server at rg-server.default.svc.cluster.local:80 <br/>2019/02/20 05:27:21 [main] running in repeatn mode <br/>2019/02/20 05:27:21 [main] calling GetFeature 20 times <br/>2019/02/20 05:27:21 [GetFeature] (req) latitude:402133926 longitude:-743613249 <br/>2019/02/20 05:27:21 [GetFeature] (resp) (<strong class="kt iu">server=rg-server-6c49b4dcf5-c7bxm:80</strong>) location:&lt;latitude:402133926 longitude:-743613249 &gt; <br/>2019/02/20 05:27:24 [GetFeature] (req) latitude:410873075 longitude:-744459023 <br/>2019/02/20 05:27:24 [GetFeature] (resp) (<strong class="kt iu">server=rg-server-6c49b4dcf5-c7bxm:80</strong>) name:"Clinton Road, West Milford, NJ 07480, USA" location:&lt;latitude:410873075 longitude:-744459023 &gt; <br/>2019/02/20 05:27:27 [GetFeature] (req) latitude:414777405 longitude:-740615601 <br/>2019/02/20 05:27:27 [GetFeature] (resp) (<strong class="kt iu">server=rg-server-6c49b4dcf5-c7bxm:80</strong>) location:&lt;latitude:414777405 longitude:-740615601 &gt; <br/>2019/02/20 05:27:30 [GetFeature] (req) latitude:415301720 longitude:-748416257 <br/>2019/02/20 05:27:30 [GetFeature] (resp) (<strong class="kt iu">server=rg-server-6c49b4dcf5-c7bxm:80</strong>) name:"282 Lakeview Drive Road, Highland Lake, NY 12743, USA" location:&lt;latitude:415301720 longitude:-748416257<br/> &gt; <br/>....</span></pre><h1 id="67b8" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">ä½¿ç”¨Linkerd 2</h1><p id="30c7" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">è®©æˆ‘ä»¬å®‰è£…Linkerd 2ï¼Œå¹¶ä½¿ç”¨å®ƒæ¥å¯ç”¨è‡ªåŠ¨gRPCè´Ÿè½½å¹³è¡¡å’Œ(ä½œä¸ºé¢å¤–å¥–åŠ±)TLSåŠ å¯†è¿æ¥ã€‚</p><p id="244c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">å®‰è£…Linkerdæ§åˆ¶å¹³é¢:</p><pre class="mm mn mo mp gt nj kt nk nl aw nm bi"><span id="f0f9" class="mx lj it kt b gy nn no l np nq">$ linkerd install --tls=optional | kubectl apply -f - </span></pre><p id="36c8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">é€šè¿‡æ›´æ–°å®¢æˆ·ç«¯é…ç½®å›¾æ¥ç¦ç”¨å®¢æˆ·ç«¯å¾ªç¯è´Ÿè½½å¹³è¡¡:</p><pre class="mm mn mo mp gt nj kt nk nl aw nm bi"><span id="52b6" class="mx lj it kt b gy nn no l np nq">kind: ConfigMap<br/>apiVersion: v1<br/>metadata:<br/>  name: rg-client-config<br/>  labels:<br/>    app: rg-client<br/>data:<br/>  SERVER_HOST: rg-server.default.svc.cluster.local<br/>  SERVER_PORT: "80"<br/>  GRPC_TIMEOUT: 60s<br/>  MODE: repeatn<br/>  MAX_REPEAT: "20"<br/>  REMOTE_API: GetFeature<br/>  <strong class="kt iu">ENABLE_LOAD_BALANCING: "false"</strong><br/>  RESOLVER_TYPE: dns</span></pre><p id="9bbd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ç½‘æ ¼åŒ–å¹¶éƒ¨ç½²æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯:</p><pre class="mm mn mo mp gt nj kt nk nl aw nm bi"><span id="e4ed" class="mx lj it kt b gy nn no l np nq">$ linkerd inject --tls=optional k8s-server.yaml | kubectl apply -f -<br/>$ linkerd inject --tls=optional k8s-client.yaml | kubectl apply -f -</span></pre><p id="7d59" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ç°åœ¨æŸ¥çœ‹å®¢æˆ·ç«¯æ—¥å¿—ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰€æœ‰3å°æœåŠ¡å™¨éƒ½è¿”å›äº†å“åº”ã€‚</p><pre class="mm mn mo mp gt nj kt nk nl aw nm bi"><span id="c28e" class="mx lj it kt b gy nn no l np nq">$ kubectl logs -f rg-client rg-client <br/>2019/02/20 05:50:21 [main] connecting to server at rg-server.default.svc.cluster.local:80 <br/>2019/02/20 05:50:21 [main] running in repeatn mode <br/>2019/02/20 05:50:21 [main] calling GetFeature 20 times <br/>2019/02/20 05:50:21 [GetFeature] (req) latitude:402133926 longitude:-743613249 <br/>2019/02/20 05:50:21 [GetFeature] (resp) (<strong class="kt iu">server=rg-server-b7b84d954-fh9q2:80</strong>) location:&lt;latitude:402133926 longitude:-743613249 &gt; <br/>2019/02/20 05:50:24 [GetFeature] (req) latitude:410873075 longitude:-744459023 <br/>2019/02/20 05:50:24 [GetFeature] (resp) (<strong class="kt iu">server=rg-server-b7b84d954-9ttc7:80</strong>) name:"Clinton Road, West Milford, NJ 07480, USA" location:&lt;latitude:410873075 longitude:-744459023 &gt; <br/>2019/02/20 05:50:27 [GetFeature] (req) latitude:414777405 longitude:-740615601 <br/>2019/02/20 05:50:27 [GetFeature] (resp) (<strong class="kt iu">server=rg-server-b7b84d954-s2vx5:80</strong>) location:&lt;latitude:414777405 longitude:-740615601 &gt; <br/>2019/02/20 05:50:30 [GetFeature] (req) latitude:415301720 longitude:-748416257 <br/>2019/02/20 05:50:30 [GetFeature] (resp) (<strong class="kt iu">server=rg-server-b7b84d954-fh9q2:80</strong>) name:"282 Lakeview Drive Road, Highland Lake, NY 12743, USA" location:&lt;latitude:415301720 longitude:-748416257 <br/>&gt; <br/>2019/02/20 05:50:33 [GetFeature] (req) latitude:402647019 longitude:-747071791 <br/>2019/02/20 05:50:33 [GetFeature] (resp) (<strong class="kt iu">server=rg-server-b7b84d954-fh9q2:80</strong>) name:"330 Evelyn Avenue, Hamilton Township, NJ 08619, USA" location:&lt;latitude:402647019 longitude:-747071791 &gt; <br/>2019/02/20 05:50:36 [GetFeature] (req) latitude:405957808 longitude:-743255336 <br/>2019/02/20 05:50:36 [GetFeature] (resp) (<strong class="kt iu">server=rg-server-b7b84d954-fh9q2:80</strong>) name:"82-104 Amherst Avenue, Colonia, NJ 07067, USA" location:&lt;latitude:405957808 longitude:-743255336 &gt; <br/>....</span></pre><p id="28b4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">æŸ¥çœ‹Linkerdä»ªè¡¨æ¿ï¼Œè¯·æ³¨æ„:</p><ul class=""><li id="5767" class="ku kv it js b jt ju jx jy kb kw kf kx kj ky kn kz la lb lc bi translated">TLSè‡ªåŠ¨å¯ç”¨ã€‚</li><li id="8729" class="ku kv it js b jt ld jx le kb lf kf lg kj lh kn kz la lb lc bi translated">å¯ä»¥è§‚å¯Ÿåˆ°ç”±æ³¨å…¥æ•…éšœå¼•èµ·çš„è¯·æ±‚å¤±è´¥ã€‚</li></ul><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi nt"><img src="../Images/3fa78d334ed069838dd65beceac2e4a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*63ftOhbRRgS7nbefd6wOYg.png"/></div></div><figcaption class="nu nv gj gh gi nw nx bd b be z dk translated">å±å¹•æˆªå›¾gRPCå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å‰¯æœ¬ä¹‹é—´çš„æµé‡æ‘˜è¦</figcaption></figure><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi ny"><img src="../Images/ebbc9ac8576d33b53c70a6472cfa1b41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wtb5k3xYDKiEETxhlQvNEA.png"/></div></div><figcaption class="nu nv gj gh gi nw nx bd b be z dk translated">æˆªå›¾2:æ¯å°æœåŠ¡å™¨çš„æˆåŠŸç‡å’Œæ¯ç§’è¯·æ±‚æ•°</figcaption></figure><p id="0b2e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ç®€å•å§ï¼ŸğŸ˜„</p><h1 id="2003" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">ç»“è®º</h1><p id="1e47" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">æˆ‘ä»¬ç ”ç©¶äº†å¦‚ä½•ä½¿ç”¨gRPC-Go <code class="fe kq kr ks kt b">balancer</code>å’Œ<code class="fe kq kr ks kt b">resolver</code>åŒ…å®ç°å®¢æˆ·ç«¯å¾ªç¯è´Ÿè½½å¹³è¡¡ã€‚è™½ç„¶æ²¡æœ‰å¾ˆå¤šä»£ç è¦å†™ï¼Œä½†æˆ‘ç¡®å®èŠ±äº†ä¸€äº›æ—¶é—´æ¥å¼„æ¸…æ¥šä¸åŒçš„éƒ¨åˆ†æ˜¯å¦‚ä½•ç»„åˆåœ¨ä¸€èµ·çš„ã€‚</p><p id="311c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">æˆ‘ä»¬çœ‹åˆ°äº†<code class="fe kq kr ks kt b">dns</code>åŸŸåç³»ç»Ÿå¦‚ä½•åœ¨Kubernetesä¸Šä¸èµ·ä½œç”¨ï¼Œå› ä¸ºKubernetesçš„é»˜è®¤å†…éƒ¨è´Ÿè½½å¹³è¡¡å·¥ä½œåœ¨L4çº§åˆ«ã€‚gRPCæ˜¯L7åè®®ã€‚</p><p id="9045" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ç„¶åï¼Œæˆ‘ä»¬å°†Linkerd 2éƒ¨ç½²åˆ°é›†ç¾¤ä¸­ã€‚ä½¿ç”¨<code class="fe kq kr ks kt b">linkerd inject</code>å‘½ä»¤ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå°†gRPCæœåŠ¡å™¨å’Œå®¢æˆ·æœºç»“åˆèµ·æ¥ï¼Œå®ç°è‡ªåŠ¨gRPCè´Ÿè½½å¹³è¡¡å’ŒTLSã€‚æˆ‘ä»¬è¿™æ ·åšæ²¡æœ‰æ”¹å˜åº”ç”¨ç¨‹åºä»£ç ï¼Œé¢å¤–çš„YAMLæ–‡ä»¶ï¼Œä¹Ÿæ²¡æœ‰éƒ¨ç½²å¤–éƒ¨è´Ÿè½½å¹³è¡¡å™¨ã€‚</p><h1 id="25d9" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">è„šæ³¨</h1><p id="d788" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">[1]https://grpc.io/blog/loadbalancing<a class="ae ko" href="https://grpc.io/blog/loadbalancing" rel="noopener ugc nofollow" target="_blank"/></p><p id="0fdf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">[2]<a class="ae ko" href="https://github.com/grpc/grpc/blob/master/doc/load-balancing.md#workflow" rel="noopener ugc nofollow" target="_blank">https://github . com/grpc/grpc/blob/master/doc/load-balancing . MD # workflow</a></p></div></div>    
</body>
</html>