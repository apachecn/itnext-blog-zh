<html>
<head>
<title>Monitoring With Prometheus Using Ansible</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ä½¿ç”¨Ansibleé€šè¿‡Prometheusè¿›è¡Œç›‘æ§</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://itnext.io/monitoring-with-prometheus-using-ansible-812bf710ef43?source=collection_archive---------0-----------------------#2018-11-12">https://itnext.io/monitoring-with-prometheus-using-ansible-812bf710ef43?source=collection_archive---------0-----------------------#2018-11-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/c6424f5e16afb7b8419c62e319156a4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JN3ElLD0ixB6VR6W"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">ç”±<a class="ae kc" href="https://unsplash.com/@chrisliverani?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">å…‹é‡Œæ–¯Â·åˆ©ç»´æ‹‰å°¼</a>åœ¨<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>ä¸Šâ€œæ‰“å¼€å¹³æ¿æ˜¾ç¤ºå™¨â€</figcaption></figure><p id="3999" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ä½ æœ€ç³Ÿç³•çš„å™©æ¢¦æ˜¯ä»€ä¹ˆï¼Ÿå¯¹æˆ‘æ¥è¯´ï¼Œå°±æ˜¯å½“æˆ‘ä»¬çš„å®¢æˆ·è®¿é—®ç¤¾äº¤åª’ä½“ï¼Œå‘Šè¯‰æˆ‘ä»¬æˆ‘ä»¬çš„æœåŠ¡ä¸­æ–­äº†ï¼Œè€Œæˆ‘ä»¬å´ä¸çŸ¥é“ã€‚ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦åœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­è®¾ç½®ç›‘æ§ã€‚å¸Œæœ›ä½ ä»¬éƒ½è¿™æ ·åšã€‚ç›‘æ§æœ‰åŠ©äºäº†è§£ä½•æ—¶å‡ºç°é—®é¢˜ã€‚å®ƒæœ‰åŠ©äºè°ƒè¯•å’Œäº†è§£é—®é¢˜ã€‚å¦‚æœæŸæ®µæ—¶é—´å†…CPUæˆ–å†…å­˜ä½¿ç”¨ç‡ä¸Šå‡ï¼Œå®ƒä¼šå‘å‡ºé€šçŸ¥ã€‚æˆ‘ä»¬å¸Œæœ›æŒç»­ç›‘æ§æˆ‘ä»¬çš„å®ä¾‹å’ŒæœåŠ¡ï¼Œä»¥å‘ç°è¡Œä¸ºã€CPUä½¿ç”¨ã€å†…å­˜ä½¿ç”¨ã€ç£ç›˜ç©ºé—´ã€ç½‘ç»œä½¿ç”¨ç­‰æ–¹é¢çš„ä»»ä½•å¼‚å¸¸ã€‚ç›‘æ§ä½¿æˆ‘ä»¬èƒ½å¤Ÿè¯†åˆ«é•¿æœŸè¶‹åŠ¿ã€åˆ†ææ€§èƒ½å¹¶çœ‹åˆ°å¯è§†åŒ–æ•ˆæœã€‚</p><p id="6dd0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ç›‘æ§åŒ…æ‹¬æ”¶é›†ã€å¤„ç†ã€èšåˆå’Œæ˜¾ç¤ºæœ‰å…³ç³»ç»Ÿçš„æ•°æ®ï¼Œä»¥åŠåŸºäºè¯¥æ•°æ®çš„è­¦æŠ¥ã€‚è¿™æœ‰åŠ©äºæŸ¥è¯¢é”™è¯¯ç‡ã€è¯·æ±‚æŒç»­æ—¶é—´ã€ç­‰å¾…æ—¶é—´ç­‰ã€‚å½“æˆ‘ä»¬å¾—åˆ°è­¦æŠ¥æ—¶ï¼Œæˆ‘ä»¬çŸ¥é“ä»€ä¹ˆæ­£åœ¨ç ´åï¼Œè¿™è¡¨æ˜ç—‡çŠ¶ï¼Œç„¶åæŸ¥çœ‹è¿›ä¸€æ­¥çš„æ•°æ®æœ‰åŠ©äºæ‰¾åˆ°åŸå› ï¼Œæœ€ç»ˆæœ‰åŠ©äºè§£å†³é—®é¢˜ã€‚</p><p id="9359" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•è§£å†³ç›‘æ§é—®é¢˜:</p><ol class=""><li id="2328" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">å¯¹ä¸€äº›é”™è¯¯å‘å‡ºè­¦æŠ¥ï¼Œæˆ–è€…æŸ¥çœ‹é”™è¯¯å›¾è¡¨ä»¥äº†è§£å“ªé‡Œå‡ºé”™äº†ã€‚</li><li id="f122" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">æŸ¥çœ‹å›¾è¡¨ä»¥ç¡®å®šé”™è¯¯æ—¶é—´èŒƒå›´ã€‚</li><li id="43f5" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">è°ƒè¯•æ—¥å¿—æ–‡ä»¶ä»¥æŸ¥æ˜è¯¥æ—¶é—´æ®µå†…çš„é”™è¯¯æ—¥å¿—ã€‚</li><li id="90a2" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">ä¿®å¤é”™è¯¯å¹¶ç¡®ä¿ä¹‹åä¸€åˆ‡æ­£å¸¸ã€‚</li></ol><p id="dac9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">è®©æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ä¸ºä»€ä¹ˆéœ€è¦è¿›è¡Œç›‘æ§:</p><ol class=""><li id="ff9d" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">å‡ºç°é—®é¢˜æ—¶ä¿æŒè­¦æƒ•ã€‚</li><li id="d7a8" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">å¸®åŠ©è°ƒæŸ¥å’Œè¯Šæ–­é—®é¢˜ã€‚</li><li id="9c3e" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">ä½¿ç”¨ä»ªè¡¨æ¿å¸®åŠ©å¯è§†åŒ–ç³»ç»Ÿè¡Œä¸ºã€‚</li><li id="95bc" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">æœ‰åŠ©äºåˆ†æé•¿æœŸè¶‹åŠ¿ã€‚</li><li id="eca6" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">æœ‰åŠ©äºè·¨å¤šä¸ªæ—¶é—´æ®µæ¯”è¾ƒç³»ç»Ÿè¡Œä¸ºã€‚</li><li id="9555" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">å¸®åŠ©è¿›è¡Œå›é¡¾æ€§åˆ†æã€‚</li></ol><h1 id="2ec4" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated"><strong class="ak">æ™®ç½—ç±³ä¿®æ–¯</strong></h1><p id="51c8" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">Prometheus æ˜¯ä¸€æ¬¾åŸºäºæ‹‰å¼æœºåˆ¶çš„å¼€æºç›‘æ§å·¥å…·ï¼Œå¯å¸®åŠ©æŠ“å–æ•°æ®ã€æŸ¥è¯¢æ•°æ®ã€ä½¿ç”¨æ•°æ®åˆ›å»ºä»ªè¡¨æ¿ï¼Œå¹¶æ ¹æ®è­¦æŠ¥è§„åˆ™æä¾›è­¦æŠ¥ã€‚å®ƒæ”¯æŒPromæŸ¥è¯¢è¯­è¨€æ¥æœç´¢æŒ‡æ ‡ã€‚</p><p id="4bea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æ™®ç½—ç±³ä¿®æ–¯æœ‰ä¸€ä¸ªåä¸ºæ™®ç½—ç±³ä¿®æ–¯æœåŠ¡å™¨çš„ä¸»è¦ä¸­å¤®ç»„ä»¶ã€‚å®ƒå¸®åŠ©ç›‘æ§è¢«ç§°ä¸ºç›®æ ‡çš„æœåŠ¡å™¨ã€‚å®ƒå¯ä»¥æ˜¯å•ä¸ªç›®æ ‡ï¼Œä¹Ÿå¯ä»¥æ˜¯é’ˆå¯¹ä¸åŒæŒ‡æ ‡(å¦‚CPUä½¿ç”¨ç‡ã€å†…å­˜ä½¿ç”¨ç‡ç­‰)è¿›è¡Œç›‘æ§çš„å¤šä¸ªç›®æ ‡ã€‚Prometheus serveråœ¨ä¸€æ®µæ—¶é—´é—´éš”å†…æŠ“å–ç›®æ ‡ï¼Œä»¥æ”¶é›†æŒ‡æ ‡å¹¶å°†å®ƒä»¬å­˜å‚¨åœ¨æ—¶åºæ•°æ®åº“ä¸­ã€‚æˆ‘ä»¬å¯ä»¥å¯¹è¿™äº›æ•°æ®è¿›è¡ŒPromQLæŸ¥è¯¢ï¼Œä»¥è·å¾—ç‰¹å®šç›®æ ‡çš„æŒ‡æ ‡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒPrometheusä¼šè·å–å…³äºè‡ªå·±å®ä¾‹çš„æŒ‡æ ‡ã€‚æˆ‘ä»¬å¯ä»¥ä¸ºä¸åŒçš„ç¬¬ä¸‰æ–¹ç³»ç»Ÿä½¿ç”¨å¯¼å‡ºå™¨ï¼Œå®ƒä»¬å°†ç¬¬ä¸‰æ–¹å·¥å…·çš„åº¦é‡è½¬æ¢ä¸ºæ™®ç½—ç±³ä¿®æ–¯åº¦é‡æ ¼å¼ã€‚Prometheusæä¾›äº†è‡ªå·±çš„å¯è§†åŒ–ä»ªè¡¨æ¿ã€‚Prometheusè¿˜æœ‰ä¸€ä¸ªè­¦æŠ¥ç®¡ç†å™¨ç»„ä»¶ï¼Œå¯ä»¥é€šè¿‡ç”µå­é‚®ä»¶ã€slackæˆ–å…¶ä»–è­¦æŠ¥å·¥å…·å‘é€è­¦æŠ¥ã€‚æˆ‘ä»¬å¯ä»¥å®šä¹‰PrometheusæœåŠ¡å™¨è¯»å–çš„è§„åˆ™ï¼Œå¹¶åœ¨å®šä¹‰çš„æ¡ä»¶è§¦å‘æ—¶å‘å‡ºè­¦æŠ¥ã€‚</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ms"><img src="../Images/0e05e83f6c69307536d0079e1581279b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eQLI-Uxv07d1PX8jQ290oQ.png"/></div></div></figure><p id="d50d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æˆ‘ä»¬å·²ç»è°ˆè¿‡å‡ºå£å•†ï¼Œä»–ä»¬æä¾›è®¸å¤šä¸åŒç»„ä»¶çš„ä¿¡æ¯ï¼Œå¦‚åŸºç¡€è®¾æ–½ã€æ•°æ®åº“ã€ç½‘ç»œæœåŠ¡å™¨ç­‰ã€‚æœ‰å¾ˆå¤šå¯ç”¨çš„å¯¼å‡ºå™¨ï¼Œä¸¤ä¸ªå¯¼å‡ºå™¨çš„ä¾‹å­æ˜¯<a class="ae kc" href="https://github.com/prometheus/node_exporter" rel="noopener ugc nofollow" target="_blank">èŠ‚ç‚¹å¯¼å‡ºå™¨</a>å’Œ<a class="ae kc" href="https://github.com/prometheus/blackbox_exporter" rel="noopener ugc nofollow" target="_blank">é»‘ç›’å¯¼å‡ºå™¨</a>ã€‚èŠ‚ç‚¹å¯¼å‡ºå™¨äº§ç”Ÿå…³äºåŸºç¡€è®¾æ–½çš„æŒ‡æ ‡ï¼ŒåŒ…æ‹¬CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œç»Ÿè®¡ç­‰ç­‰ã€‚Blackbox exporteré€šè¿‡æ¢æµ‹ä¸åŒåè®®(å¦‚HTTPã€HTTPS)ä¸Šçš„ä¸åŒç«¯ç‚¹æ¥è·å¾—å¯ç”¨æ€§ã€å“åº”æ—¶é—´ç­‰æŒ‡æ ‡ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†è®¾ç½®node_exporterå’Œblackbox_exporteræ¥ä½¿ç”¨PrometheusæœåŠ¡å™¨ã€‚</p><p id="84d0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">è®©æˆ‘ä»¬é¦–å…ˆä½¿ç”¨<a class="ae kc" href="https://www.ansible.com/" rel="noopener ugc nofollow" target="_blank"> Ansible </a>è®¾ç½®æ™®ç½—ç±³ä¿®æ–¯ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºâ€œprometheusâ€ç”¨æˆ·å’Œç»„ï¼Œè¿™æœ‰åŠ©äºéš”ç¦»PrometheusæœåŠ¡å™¨çš„æ‰€æœ‰æƒå¹¶æä¾›å®‰å…¨æ€§ã€‚è¯¥ç”¨æˆ·ä¸èƒ½ç™»å½•å®ä¾‹ï¼Œåªèƒ½åœ¨å®ä¾‹å†…éƒ¨ä½¿ç”¨ã€‚ä¸ºäº†æ›´å¥½åœ°æ§åˆ¶ï¼Œæˆ‘ä»¬åœ¨å˜é‡æ–‡ä»¶ä¸­å®šä¹‰äº†æ‰€æœ‰å‚æ•°ã€‚</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="bca6" class="nc lq iq my b gy nd ne l nf ng">- name: Creating prometheus user group<br/>  group: name="{{groupId}}"<br/>  become: true</span><span id="c4a3" class="nc lq iq my b gy nh ne l nf ng">- name: Creating prometheus user<br/>  user:<br/>    name: "{{userId}}"<br/>    group: "{{groupId}}"<br/>    system: yes<br/>    shell: "/sbin/nologin"<br/>    comment: "{{userId}} nologin User"<br/>    createhome: "no"<br/>    state: present</span></pre><p id="9a24" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ä¸‹ä¸€æ­¥æ˜¯ä¸‹è½½å’Œå®‰è£…prometheusçš„æ‰€æœ‰æƒç»™Prometheusç”¨æˆ·ã€‚å®‰è£…åï¼Œæ¸…ç†å®‰è£…è¿‡ç¨‹æ‰€éœ€çš„æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶ã€‚</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="cd36" class="nc lq iq my b gy nd ne l nf ng">- name: Install prometheus<br/>  unarchive:<br/>    src: "<a class="ae kc" href="https://github.com/prometheus/prometheus/releases/download/v{{" rel="noopener ugc nofollow" target="_blank">https://github.com/prometheus/prometheus/releases/download/v{{</a> version }}/prometheus-{{ version }}.linux-amd64.tar.gz"<br/>    dest: /tmp/<br/>    remote_src: yes</span><span id="e4fb" class="nc lq iq my b gy nh ne l nf ng">- name: Copy prometheus file to bin<br/>  copy:<br/>    src: "/tmp/prometheus-{{ version }}.linux-amd64/prometheus"<br/>    dest: "/usr/local/bin/prometheus"<br/>    owner: "{{userId}}"<br/>    group: "{{groupId}}"<br/>    remote_src: yes<br/>    mode: 0755</span><span id="d598" class="nc lq iq my b gy nh ne l nf ng">- name: Delete prometheus tmp folder<br/>  file:<br/>    path: '/tmp/prometheus-{{ version }}.linux-amd64'<br/>    state: absent</span></pre><p id="64ce" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å¤åˆ¶PrometheusæœåŠ¡å™¨ä½¿ç”¨çš„Prometheusé…ç½®æ–‡ä»¶ã€‚</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="79e2" class="nc lq iq my b gy nd ne l nf ng">- name: config file<br/>  template:<br/>    src: prometheus.conf.j2<br/>    dest: /etc/prometheus/prometheus.conf</span></pre><p id="aa9f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ä¸€æ—¦æˆ‘ä»¬ä¸ºè¿è¡ŒPrometheusåšå¥½äº†ä¸€åˆ‡å‡†å¤‡ï¼Œæˆ‘ä»¬å°†å¤åˆ¶systemctl initæ–‡ä»¶ï¼Œè¿™æ ·åœ¨æ¯æ¬¡é‡æ–°å¯åŠ¨æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç¡®å®šPrometheusæ­£åœ¨è¿è¡Œã€‚</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="c4bc" class="nc lq iq my b gy nd ne l nf ng">- name: Copy systemd init file<br/>  template:<br/>    src: init.service.j2<br/>    dest: /etc/systemd/system/prometheus.service<br/>  notify: systemd_reload</span><span id="fa2f" class="nc lq iq my b gy nh ne l nf ng">- name: Start prometheus service<br/>  service:<br/>    name: prometheus<br/>    state: started<br/>    enabled: yes</span></pre><p id="16bc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ä¸‹ä¸€æ­¥æ˜¯å¯åŠ¨æœåŠ¡å™¨ï¼Œè¿™æ ·å®ƒå°±å¯ä»¥æ ¹æ®é…ç½®æ–‡ä»¶å¼€å§‹å·¥ä½œã€‚ç„¶åï¼Œæˆ‘ä»¬é€šè¿‡åœ¨ç«¯å£9090ç‚¹å‡»ä¸€ä¸ªHTTPè°ƒç”¨å¹¶ç¡®è®¤æˆ‘ä»¬å¾—åˆ°äº†200ä¸ªå“åº”æ¥æ£€æŸ¥å®ƒæ˜¯å¦åœ¨å·¥ä½œã€‚</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="eb21" class="nc lq iq my b gy nd ne l nf ng">- name: Check if prometheus is accessible<br/>  uri:<br/>    url: <a class="ae kc" href="http://localhost:9090" rel="noopener ugc nofollow" target="_blank">http://localhost:9090</a><br/>    method: GET<br/>    status_code: 200</span></pre><p id="4596" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æœ‰äº†æ‰€æœ‰è¿™äº›ï¼Œæˆ‘ä»¬å°±æœ‰äº†æˆ‘ä»¬çš„PrometheusæœåŠ¡å™¨ï¼Œå¹¶ä»å®ƒè‡ªå·±çš„å®ä¾‹ä¸­æ”¶é›†æ•°æ®ã€‚</p><p id="a479" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æˆ‘ä»¬å¸Œæœ›ä»å…¶ä»–å®ä¾‹ä¸­æ”¶é›†ä¸åŸºç¡€è®¾æ–½ç›¸å…³çš„æŒ‡æ ‡ï¼Œä¸ºæ­¤æˆ‘ä»¬éœ€è¦åœ¨å…¶ä»–å®ä¾‹ä¸­è®¾ç½®<strong class="kf ir"> node_exporter </strong>ã€‚Prometheus serverä½¿ç”¨node_exporterä»è¿™äº›å®ä¾‹ä¸­æ”¶é›†æ•°æ®ï¼Œå¹¶ä½¿ç”¨å…¶ä»ªè¡¨æ¿å‘æˆ‘ä»¬æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ã€‚æ­¥éª¤å°†ç±»ä¼¼äºæˆ‘ä»¬ä½¿ç”¨Ansibleå¯¹Prometheusæ‰€åšçš„ã€‚</p><p id="7f3e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æˆ‘ä»¬å°†åˆ›å»ºåä¸ºâ€œnode_exporterâ€çš„ç”¨æˆ·å’Œç»„ï¼Œè¿™æœ‰åŠ©äºéš”ç¦»node_exporterçš„æ‰€æœ‰æƒå¹¶æä¾›å®‰å…¨æ€§ã€‚</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="bc8d" class="nc lq iq my b gy nd ne l nf ng">- name: Creating node_exporter user group<br/>  group: name="{{groupId}}"<br/>  become: true</span><span id="082c" class="nc lq iq my b gy nh ne l nf ng">- name: Creating node_exporter user<br/>  user:<br/>    name: "{{userId}}"<br/>    group: "{{groupId}}"<br/>    system: yes<br/>    shell: "/sbin/nologin"<br/>    comment: "{{userId}} nologin User"<br/>    createhome: "no"<br/>    state: present</span></pre><p id="f77f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ä¸‹ä¸€æ­¥æ˜¯ä¸‹è½½å¹¶å®‰è£…node_exporterï¼Œæ–¹æ³•æ˜¯å°†å…¶äºŒè¿›åˆ¶æ–‡ä»¶æ”¾åœ¨è·¯å¾„â€œ/usr/local/binâ€ä¸­ã€‚ä¸€æ—¦è®¾ç½®å®Œæˆï¼Œæˆ‘ä»¬åˆ é™¤æ‰€æœ‰å¤šä½™çš„æ–‡ä»¶ã€‚</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="0601" class="nc lq iq my b gy nd ne l nf ng">- name: Install prometheus node exporter<br/>  unarchive:<br/>    src: "<a class="ae kc" href="https://github.com/prometheus/node_exporter/releases/download/v{{" rel="noopener ugc nofollow" target="_blank">https://github.com/prometheus/node_exporter/releases/download/v{{</a> version }}/node_exporter-{{ version }}.linux-amd64.tar.gz"<br/>    dest: /tmp/<br/>    remote_src: yes</span><span id="5a62" class="nc lq iq my b gy nh ne l nf ng">- name: Copy prometheus node exporter file to bin<br/>  copy:<br/>    src: "/tmp/node_exporter-{{ version }}.linux-amd64/node_exporter"<br/>    dest: "/usr/local/bin/node_exporter"<br/>    owner: "{{userId}}"<br/>    group: "{{groupId}}"<br/>    remote_src: yes<br/>    mode: 0755</span><span id="6fa0" class="nc lq iq my b gy nh ne l nf ng">- name: Delete node exporter tmp folder<br/>  file:<br/>    path: '/tmp/node_exporter-{{ version }}.linux-amd64'<br/>    state: absent</span></pre><p id="7fcf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æ¯æ¬¡é‡æ–°å¯åŠ¨æ—¶ï¼Œå°†systemctl initæ–‡ä»¶å¤åˆ¶åˆ°start node_exporterï¼Œå¹¶å¯åŠ¨node_exporteræœåŠ¡ï¼Œä»¥ä¾¿å®ƒå¯ä»¥å¼€å§‹æ”¶é›†æ•°æ®ã€‚</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="6b70" class="nc lq iq my b gy nd ne l nf ng">- name: Copy systemd init file<br/>  template:<br/>    src: init.service.j2<br/>    dest: /etc/systemd/system/node_exporter.service</span><span id="7cc1" class="nc lq iq my b gy nh ne l nf ng">- name: Start node_exporter service<br/>  service:<br/>    name: node_exporter<br/>    state: started<br/>    enabled: yes</span></pre><p id="90c9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ä¸€æ—¦ä¸€åˆ‡éƒ½å®Œæˆäº†ï¼Œæˆ‘ä»¬å°†éªŒè¯å®ƒæ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œã€‚</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="bee0" class="nc lq iq my b gy nd ne l nf ng">- name: Check if node exporter emits metrics<br/>  uri:<br/>    url: <a class="ae kc" href="http://127.0.0.1:9100/metrics" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:9100/metrics</a><br/>    method: GET<br/>    status_code: 200</span></pre><p id="8641" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ä¸€æ—¦æˆ‘ä»¬è¿è¡Œäº†node_exporterï¼Œè®©æˆ‘ä»¬å¼€å§‹è¿è¡Œ<strong class="kf ir"> blackbox_exporter </strong>ï¼Œé€šè¿‡ä½¿ç”¨HTTPä¹‹ç±»çš„åè®®æ¢æµ‹ç«¯ç‚¹æ¥å¯¹ä¸åŒçš„æœåŠ¡è¿›è¡Œé»‘ç›’ç›‘æ§ã€‚é»‘ç›’å¯¼å‡ºå™¨é€šè¿‡â€œ/probeâ€APIè·å–æ¨¡å—å’Œç›®æ ‡URLå‚æ•°ã€‚æ¨¡å—åœ¨é»‘ç›’é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œé…ç½®ï¼Œé»˜è®¤é…ç½®åŒ…æ‹¬http_2xxæ¨¡å—ï¼Œè¯¥æ¨¡å—æ‰§è¡Œhttpæ¢æµ‹å¹¶æˆåŠŸè·å¾—2xxå“åº”ã€‚</p><p id="4a09" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æ­£å¦‚æˆ‘ä»¬å·²ç»å¯¹Prometheuså’Œnode_exporteræ‰€åšçš„é‚£æ ·ï¼Œæˆ‘ä»¬å°†ä»¥åŒæ ·çš„æ–¹å¼åˆ›å»ºç”¨æˆ·å’Œç»„ã€‚</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="e0fb" class="nc lq iq my b gy nd ne l nf ng">- name: Creating blackbox_exporter user group<br/>  group: name="{{groupId}}"<br/>  become: true</span><span id="324c" class="nc lq iq my b gy nh ne l nf ng">- name: Creating blackbox_exporter user<br/>  user:<br/>    name: "{{userId}}"<br/>    group: "{{groupId}}"<br/>    system: yes<br/>    shell: "/sbin/nologin"<br/>    comment: "{{userId}} nologin User"<br/>    createhome: "no"<br/>    state: present</span></pre><p id="1fb7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ä¸‹ä¸€æ­¥æ˜¯ä¸‹è½½å¹¶å®‰è£…blackbox_exporterï¼ŒæŠŠå®ƒçš„äºŒè¿›åˆ¶æ–‡ä»¶æ”¾åˆ°è·¯å¾„â€œ/usr/local/binâ€ä¸­ã€‚ä¸€æ—¦è®¾ç½®å®Œæˆï¼Œæˆ‘ä»¬åˆ é™¤æ‰€æœ‰å¤šä½™çš„æ–‡ä»¶ã€‚</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="a00f" class="nc lq iq my b gy nd ne l nf ng">- name: Copy prometheus blackbox exporter file to bin<br/>  copy:<br/>    src: "/tmp/blackbox_exporter-{{ version }}.linux-amd64/blackbox_exporter"<br/>    dest: "/usr/local/bin/blackbox_exporter"<br/>    owner: "{{userId}}"<br/>    group: "{{groupId}}"<br/>    remote_src: yes<br/>    mode: 0755</span><span id="0025" class="nc lq iq my b gy nh ne l nf ng">- name: Delete blackbox exporter tmp folder<br/>  file:<br/>    path: '/tmp/blackbox_exporter-{{ version }}.linux-amd64'<br/>    state: absent</span></pre><p id="1570" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ç„¶åå°†blackboxé…ç½®æ–‡ä»¶å’Œsystemctl initæ–‡ä»¶å¤åˆ¶åˆ°å„è‡ªçš„ç›®æ ‡ä½ç½®ã€‚å¯åŠ¨é»‘ç›’å¯¼å‡ºå™¨ï¼Œä»¥ä¾¿å®ƒå¯ä»¥å¼€å§‹æ¥å—è¯·æ±‚ã€‚</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="cda1" class="nc lq iq my b gy nd ne l nf ng">- name: Copy blackbox exporter config file<br/>  template:<br/>    src: blackbox.yml.j2<br/>    dest: /data/blackbox_exporter/blackbox.yml<br/>    owner: "{{userId}}"<br/>    group: "{{groupId}}"</span><span id="003d" class="nc lq iq my b gy nh ne l nf ng">- name: Copy systemd init file<br/>  template:<br/>    src: init.service.j2<br/>    dest: /etc/systemd/system/blackbox_exporter.service<br/>  notify: systemd_reload</span><span id="b12d" class="nc lq iq my b gy nh ne l nf ng">- name: Start blackbox_exporter service<br/>  service:<br/>    name: blackbox_exporter<br/>    state: started<br/>    enabled: yes</span></pre><p id="711c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æœ€åï¼Œæˆ‘ä»¬éªŒè¯blackbox_exporterå·¥ä½œæ­£å¸¸ã€‚</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="65ce" class="nc lq iq my b gy nd ne l nf ng">- name: Check if blackbox_exporter is accessible<br/>  uri:<br/>    url: <a class="ae kc" href="http://localhost:9115" rel="noopener ugc nofollow" target="_blank">http://localhost:9115</a><br/>    method: GET<br/>    status_code: 200</span></pre><p id="132b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æˆ‘ä»¬å°†ä¸ºé€šè¿‡blackbox.ymlé…ç½®æ–‡ä»¶é…ç½®çš„æ¢æµ‹å™¨ä½¿ç”¨HTTPæ¨¡å—ã€‚</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="b87c" class="nc lq iq my b gy nd ne l nf ng">modules:<br/>  http_2xx:<br/>    prober: http<br/>    timeout: 5s<br/>    http:<br/>      preferred_ip_protocol: "ipv4"<br/>      valid_http_versions: ["HTTP/1.1", "HTTP/2"]<br/>      valid_status_codes: []<br/>      method: GET</span></pre><p id="c0b9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æ­¤æ—¶ï¼Œæˆ‘ä»¬åœ¨ä¸€ä¸ªå®ä¾‹ä¸Šè¿è¡ŒPrometheus serverï¼Œåœ¨åŒä¸€ä¸ªå®ä¾‹ä¸Šè¿è¡Œblackbox_exporterï¼Œåœ¨å¦ä¸€ä¸ªå®ä¾‹ä¸Šè¿è¡Œnode_exporterã€‚æˆ‘ä»¬éœ€è¦æ›´æ–°PrometheusæœåŠ¡å™¨çš„é…ç½®(åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œåœ¨http://www.google.comä¸Šè¿è¡Œprobe ),å¹¶é‡å¯æœåŠ¡å™¨ï¼Œä»¥ä¾¿å®ƒå¯ä»¥å¼€å§‹è·å–æ•°æ®ã€‚</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="24de" class="nc lq iq my b gy nd ne l nf ng"><strong class="my ir">prometheus.conf template file</strong><br/>global:<br/>  scrape_interval: 15s</span><span id="c4b5" class="nc lq iq my b gy nh ne l nf ng">scrape_configs:<br/>  - job_name: 'prometheus'<br/>    scrape_interval: 5s<br/>    static_configs:<br/>      - targets: ['localhost:9090']<br/>  - job_name: 'node_exporter'<br/>    scrape_interval: 5s<br/>    static_configs:<br/>      - targets:<br/>      {% for host in groups['all'] %}<br/>      {% if inventory_hostname != host %}<br/>        - '{{ host }}:9100'<br/>      {% endif %}<br/>      {% endfor %}<br/>  - job_name: 'blackbox'<br/>    metrics_path: /probe<br/>    params:<br/>      module: [http_2xx]<br/>    static_configs:<br/>      - targets:<br/>        - http://www.google.com<br/>    relabel_configs:<br/>      - source_labels: [__address__]<br/>        target_label: __param_target<br/>      - source_labels: [__param_target]<br/>        target_label: instance<br/>      - target_label: __address__<br/>        replacement: localhost:9115</span></pre><p id="2e8a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è½¬åˆ°Prometheus dashboardï¼Œç¡®è®¤ä¸€åˆ‡æ­£å¸¸è¿è¡Œã€‚</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/c21a6df4dc93c1a639c6fa32fd691f3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pVlvBfp3ush5YAqNwc4Mlw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">ä½¿ç”¨æ™®ç½—ç±³ä¿®æ–¯ç›‘æ§æ‰€æœ‰ç›®æ ‡</figcaption></figure><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/793db3447b73e8dfd607384c4164df5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g0W52YhRjaAqmpqvmhUdBw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">ä½¿ç”¨node_exporteræŸ¥è¯¢æ‰€æœ‰èŠ‚ç‚¹çš„è¿è¡ŒçŠ¶æ€</figcaption></figure><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/692ee30b0faeafb543b7bb517c480d65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*50J_Tyntp11xNTei2ifiMA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">ä½¿ç”¨blacbox_exporteræ¢æµ‹http://www.google.com<a class="ae kc" href="http://www.google.com" rel="noopener ugc nofollow" target="_blank"/></figcaption></figure><p id="1464" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">å®Œæ•´çš„ä»£ç å¯ä»¥åœ¨è¿™ä¸ªgitèµ„æºåº“ä¸­æ‰¾åˆ°:<a class="ae kc" href="https://github.com/MiteshSharma/PrometheusWithAnsible" rel="noopener ugc nofollow" target="_blank">https://github.com/MiteshSharma/PrometheusWithAnsible</a></p><p id="aebd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> <em class="nj"> PS:å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·ç”¨æŒå£°æ”¯æŒå®ƒ</em> </strong>ğŸ‘<strong class="kf ir"> <em class="nj">ã€‚æ¬¢å‘¼</em> </strong></p></div></div>    
</body>
</html>