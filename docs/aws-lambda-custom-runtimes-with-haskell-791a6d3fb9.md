# ä½¿ç”¨ Haskell çš„ AWS Lambda è‡ªå®šä¹‰è¿è¡Œæ—¶

> åŸæ–‡ï¼š<https://itnext.io/aws-lambda-custom-runtimes-with-haskell-791a6d3fb9?source=collection_archive---------4----------------------->

![](img/afcd45cb767e47bdf0dc16009808acf5.png)

## è‡ªå®šä¹‰è¿è¡Œæ—¶

AWS åœ¨ 2018 å¹´ 11 æœˆçš„å¹´åº¦ re:Invent å¤§ä¼šä¸Šä¸ºæˆ‘ä»¬å¸¦æ¥çš„é‡å¤§æ¶ˆæ¯æ˜¯ä¸º Lambda å¼•å…¥äº†è‡ªå®šä¹‰è¿è¡Œæ—¶ã€‚è¿™ç¡®å®å¾ˆé‡è¦ï¼Œå› ä¸ºå®ƒå…è®¸æˆ‘ä»¬ç”¨ä»»ä½•ç¼–ç¨‹è¯­è¨€ç¼–å†™ Lambda å‡½æ•°ï¼Œè€Œä¸éœ€è¦å°†äºŒè¿›åˆ¶ä»£ç ä½œä¸ºå·²ç»æ”¯æŒçš„è¿è¡Œæ—¶(nodeã€pythonã€go ç­‰)çš„å­è¿›ç¨‹æ¥è¿è¡Œã€‚).æœ‰ä¸€ä¸ªå…³äºå¦‚ä½•åœ¨ bash ä¸­ç¼–å†™ runtime/lambda çš„å®˜æ–¹æ•™ç¨‹ï¼Œä»¥åŠä¸€äº›ç°æˆçš„ C++å’Œ Rust çš„è¿è¡Œæ—¶ã€‚

è®©æˆ‘ä»¬é‡å¤ä¸€ä¸‹è¿è¡Œæ—¶å®é™…ä¸Šåšäº†ä»€ä¹ˆï¼Œä»¥åŠå®ƒå¦‚ä½•é€‚åº”åƒ Haskell è¿™æ ·çš„ç¼–è¯‘è¯­è¨€ã€‚bash æ•™ç¨‹ä»¥åŠå¯èƒ½æ‰€æœ‰åŠ¨æ€/è§£é‡Šè¯­è¨€çš„è¿è¡Œæ—¶éƒ½åˆ©ç”¨äº†è¿™æ ·ä¸€ä¸ªäº‹å®ï¼Œå³è¿è¡Œæ—¶å¯ä»¥åŠ è½½å¹¶è¿è¡Œå¤„ç†ç¨‹åºçš„ä»£ç ã€‚è™½ç„¶è¿™å¾ˆå¥½ï¼Œå› ä¸ºå¼€å‘äººå‘˜å¯ä»¥ä¸“æ³¨äºåªç¼–å†™å¤„ç†ç¨‹åºä»£ç ï¼Œå¹¶è®©è¿è¡Œæ—¶åœ¨æŸä¸ªåœ°æ–¹ï¼Œä½†è¿™å¯èƒ½ä¼šå¯¼è‡´å†·å¯åŠ¨çš„ä¸€éƒ¨åˆ†ã€‚æˆ‘æƒ³å¤§éƒ¨åˆ†æ—¶é—´èŠ±åœ¨äº†å®ä¾‹åŒ–æ‰€æœ‰éœ€è¦çš„åŸºç¡€è®¾æ–½ä¸Šï¼Œä½†ä¹Ÿæœ‰ä¸€éƒ¨åˆ†æ—¶é—´èŠ±åœ¨äº†å¯åŠ¨å’Œè¿è¡Œè¿è¡Œæ—¶ä¸Šï¼Œå°¤å…¶æ˜¯å¦‚æœå¤„ç†ç¨‹åºæœ¬èº«ä½¿ç”¨äº†ä¸€äº›åŠ¨æ€åŠ è½½çš„åº“ã€‚

Rust å’Œ C++çš„å®˜æ–¹è¿è¡Œæ—¶é‡‡ç”¨çš„æ–¹æ³•æ˜¯å°†æ•´ä¸ªè¿è¡Œæ—¶æ”¾å…¥ä¸€ä¸ªåº“ä¸­ï¼Œå¹¶å°†å…¶ä¸å¤„ç†ç¨‹åºä¸€èµ·ç¼–è¯‘æˆä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ã€‚

å¯¹äºå·²ç»æœ‰ä¸€äº›ç¼–å†™ lambdas çš„ç»éªŒçš„äººæ¥è¯´ï¼Œè¿™å¯èƒ½æœ‰ç‚¹ä»¤äººå›°æƒ‘ï¼Œä½†è¿™æ˜¯å®Œå…¨æœ‰æ„ä¹‰çš„ã€‚åœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åªéœ€å°†è¿è¡Œ lambda æ‰€éœ€çš„æ‰€æœ‰ä¸œè¥¿æ‰“åŒ…åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­(å®é™…ä¸Šæ˜¯æ‰€æœ‰ä¸œè¥¿ï¼Œä½†æˆ‘ä»¬å°†åœ¨åé¢æ¢è®¨)ã€‚

å› æ­¤ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹æ˜¯å¦å¯ä»¥ä¸€æ­¥ä¸€æ­¥åœ°ç”¨ Haskell åˆ›å»ºä¸€ä¸ªå¯ä»¥åœ¨ lambda ä¸Šæœ¬åœ°è¿è¡Œçš„ Lambda è¿è¡Œæ—¶ğŸ™‚

## ç¯å¢ƒè®¾ç½®

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæœ¬åœ°å¼€å‘ç¯å¢ƒã€‚ä¸ºäº†è¿è¡Œæˆ‘ä»¬æƒ³è¦çš„ä¸€åˆ‡ï¼Œæˆ‘ä»¬éœ€è¦:

- `stack`(å¯ä»[æ­¤å¤„](https://docs.haskellstack.org/en/stable/README/#how-to-install) )
- `docker`
- `aws` cli å·¥å…·(ä»…å½“æˆ‘ä»¬å®é™…æƒ³è¦åœ¨ Lambda ä¸Šè¿è¡Œä»£ç æ—¶)

ç¬¬ä¸€æ­¥æ˜¯åˆ›å»ºä¸€ä¸ªå †æ ˆé¡¹ç›®å¹¶å¯¹å…¶è¿›è¡Œé…ç½®ã€‚

```
*$ stack new hs-lambda
$ cd hs-lambda
$ stack config set resolver lts-12.14*
```

ç°åœ¨è¿›å…¥é€‚å½“çš„æ‹‰å§†è¾¾çš„ä¸œè¥¿ã€‚æˆ‘ä»¬å°†ä»æ‰§è¡Œç¯å¢ƒå¼€å§‹ï¼Œå®ƒæ˜¯:

*   æ“ä½œç³»ç»Ÿâ€”äºšé©¬é€Š Linux
*   AMI-amzn-AMI-hvm-2017 . 03 . 1 . 2017 08 12-x86 _ 64-GP2
*   Linux å†…æ ¸â€”4 . 14 . 77â€“70.59 . amzn 1 . x86 _ 64
*   ç”¨äº JavaScript çš„ AWS SDKâ€”2 . 290 . 0
*   Python çš„ SDK(Boto 3)-3â€“1 . 7 . 74 Boto core-1 . 10 . 74

å¯¹æˆ‘ä»¬æ¥è¯´ï¼Œé‡è¦çš„æ˜¯æˆ‘ä»¬ç¼–è¯‘çš„ä»£ç å°†åœ¨**Amazon Linux v 2017 . 03 . 1 . 2017 08 12**ä¸Šè¿è¡Œï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›å®ƒæˆä¸ºæˆ‘ä»¬çš„ç¼–è¯‘ç¯å¢ƒï¼Œä»¥å®ç°æœ€å¤§çš„äºŒè¿›åˆ¶å…¼å®¹æ€§ã€‚

å› æ­¤ï¼Œè®©æˆ‘ä»¬åŸºäº AWS æ˜ åƒæ„å»ºä¸€ä¸ªå®¹å™¨:

```
*$ docker run -rm -name $(basename $(pwd)) -v $(pwd):/mnt -ti amazonlinux:2017.03.1.20170812 /bin/bash*
```

è¿™å°†å¯åŠ¨ä¸€ä¸ª bash ä¼šè¯ï¼Œå¹¶å°†æˆ‘ä»¬çš„å½“å‰ç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†…çš„`/mnt`ç›®å½•ä¸­ã€‚æˆ‘ä»¬ä¹Ÿæƒ³åœ¨è¿™é‡Œä½¿ç”¨`stack`,æ‰€ä»¥è®©æˆ‘ä»¬å®‰è£…å®ƒå’Œä¸€äº›ä¾èµ–é¡¹:

```
*bash-4.2# cd /mnt
bash-4.2# curl -sSL* [*https://get.haskellstack.org/*](https://get.haskellstack.org/) *| sh
bash-4.2# yum install -y gcc make xz libffi zlib zlib-devel gmp gmp-devel â€” suggested by stack install script*
```

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»éƒ¨åˆ†å»ºç«‹äº†ç¼–è¯‘å’Œå¼€å‘ç¯å¢ƒã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬å®Œæˆå¼€å‘ç¯å¢ƒçš„è®¾ç½®ã€‚æˆ‘ä»¬å°†åªä½¿ç”¨æˆ‘ä»¬çš„å®¹å™¨è¿›è¡Œæœ€ç»ˆç¼–è¯‘ï¼Œå¹¶åœ¨æˆ‘ä»¬çš„ dev box ä¸Šåšå…¶ä»–äº‹æƒ…ã€‚è®©å®¹å™¨ä¿æŒè¿è¡Œï¼Œæ‰“å¼€å¦ä¸€ä¸ªç»ˆç«¯çª—å£ï¼Œå°†`cd`æŒ‡å‘æˆ‘ä»¬çš„`hs-lambda`ç›®å½•ã€‚

## å±¥è¡Œ

`stack new`åˆ›å»ºäº†ä¸€ä¸ªåŸºæœ¬çš„é¡¹ç›®æ¡†æ¶ï¼Œæˆ‘ä»¬å‡†å¤‡å†™ä¸€äº›ä»£ç ã€‚è®©æˆ‘ä»¬æ‰“å¼€`app/Main.hs`æ–‡ä»¶ï¼Œå›åˆ°æ–‡æ¡£ä¸­ï¼Œçœ‹çœ‹æˆ‘ä»¬çš„è¿è¡Œæ—¶åº”è¯¥åšä»€ä¹ˆã€‚å‡ºäºæœ¬æ–‡çš„ç›®çš„ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„æ— æœåŠ¡å™¨ echo æœåŠ¡å™¨ğŸ™‚

é¦–å…ˆï¼Œå¼•ç”¨ AWS æ–‡æ¡£å‘Šè¯‰æˆ‘ä»¬å¦‚ä½•è®©æˆ‘ä»¬çš„å®šåˆ¶è¿è¡Œæ—¶å·¥ä½œ:

> *ä½ å¯ä»¥ç”¨ä»»ä½•ç¼–ç¨‹è¯­è¨€å®ç° AWS Lambda è¿è¡Œæ—¶ã€‚*
> 
> *è¿è¡Œæ—¶æ˜¯åœ¨è°ƒç”¨å‡½æ•°æ—¶è¿è¡Œ Lambda å‡½æ•°å¤„ç†ç¨‹åºæ–¹æ³•çš„ç¨‹åºã€‚æ‚¨å¯ä»¥å°†è¿è¡Œæ—¶ä»¥åä¸º bootstrap çš„å¯æ‰§è¡Œæ–‡ä»¶çš„å½¢å¼åŒ…å«åœ¨æ‚¨çš„å‡½æ•°éƒ¨ç½²åŒ…ä¸­ã€‚*

ä»ä¸Šé¢æˆ‘ä»¬çŸ¥é“ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåä¸º`bootstrap`çš„äºŒè¿›åˆ¶æ–‡ä»¶æ”¾åœ¨æˆ‘ä»¬çš„ lambda zip åŒ…ä¸­ï¼Œè¿™ä¸ªæ–‡ä»¶åº”è¯¥åŒ…å«è¿è¡Œæ—¶ã€‚è®©æˆ‘ä»¬æ›´è¿›ä¸€æ­¥ï¼Œæ£€æŸ¥æˆ‘ä»¬çš„è¿è¡Œæ—¶å¿…é¡»ç»å†çš„æ‰€æœ‰æ­¥éª¤ã€‚

1.  **æ£€ç´¢è®¾ç½®** â€”è¯»å–ç¯å¢ƒå˜é‡ä»¥è·å–å…³äºåŠŸèƒ½å’Œç¯å¢ƒçš„è¯¦ç»†ä¿¡æ¯ã€‚

*   `_HANDLER` -å¤„ç†å™¨çš„ä½ç½®ï¼Œæ¥è‡ªåŠŸèƒ½é…ç½®ã€‚æ ‡å‡†æ ¼å¼æ˜¯`file.method`ï¼Œå…¶ä¸­`file`æ˜¯ä¸å¸¦æ‰©å±•åçš„æ–‡ä»¶åï¼Œ`method`æ˜¯æ–‡ä»¶ä¸­å®šä¹‰çš„æ–¹æ³•æˆ–å‡½æ•°çš„åç§°ã€‚
*   `LAMBDA_TASK_ROOT` -åŒ…å«åŠŸèƒ½ä»£ç çš„ç›®å½•ã€‚
*   `AWS_LAMBDA_RUNTIME_API` -è¿è¡Œæ—¶ API çš„ä¸»æœºå’Œç«¯å£

æœ‰å…³å¯ç”¨å˜é‡çš„å®Œæ•´åˆ—è¡¨ï¼Œè¯·å‚è§ Lambda å‡½æ•°å¯ç”¨çš„ç¯å¢ƒå˜é‡

2.**åˆå§‹åŒ–å‡½æ•°** â€”åŠ è½½å¤„ç†ç¨‹åºæ–‡ä»¶å¹¶è¿è¡Œå®ƒåŒ…å«çš„ä»»ä½•å…¨å±€æˆ–é™æ€ä»£ç ã€‚å‡½æ•°åº”è¯¥ä¸€æ¬¡æ€§åˆ›å»ºåƒ SDK å®¢æˆ·ç«¯å’Œæ•°æ®åº“è¿æ¥è¿™æ ·çš„é™æ€èµ„æºï¼Œå¹¶åœ¨å¤šæ¬¡è°ƒç”¨ä¸­é‡ç”¨å®ƒä»¬ã€‚

3.**å¤„ç†é”™è¯¯** â€”å¦‚æœå‡ºç°é”™è¯¯ï¼Œè°ƒç”¨åˆå§‹åŒ–é”™è¯¯ API å¹¶ç«‹å³é€€å‡ºã€‚

æˆ‘ä»¬å°†æŸ¥çœ‹è¿™äº›è¦ç‚¹ï¼Œçœ‹çœ‹å®ƒä»¬æ˜¯å¦éƒ½é€‚ç”¨ã€‚

1.  æˆ‘ä»¬çš„è®¡åˆ’æ˜¯åˆ›å»ºä¸€ä¸ªå¸¦æœ‰è‡ªå®šä¹‰è¿è¡Œæ—¶çš„åŸºæœ¬çš„æœ€å° lambda å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†æŠŠæ‰€æœ‰ä¸œè¥¿æ”¾å…¥æˆ‘ä»¬çš„`bootstrap`äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦åŠ è½½ä»»ä½•å¤„ç†ç¨‹åºï¼Œæ‰€ä»¥æˆ‘ä»¬çœŸçš„ä¸éœ€è¦è¯»å–`_HANDLER`å’Œ`LAMBDA_TASK_ROOT`å˜é‡ã€‚æˆ‘ä»¬å”¯ä¸€éœ€è¦çš„æ˜¯`AWS_LAMBDA_RUNTIME_API`çš„å€¼ã€‚
2.  åŒæ ·ï¼Œæˆ‘ä»¬ä¸ä¼šåŠ è½½ä»»ä½•å¤„ç†ç¨‹åºï¼Œæ‰€ä»¥åˆå§‹åŒ– SDK ç­‰ã€‚å¯ä»¥åœ¨æˆ‘ä»¬çš„`bootstrap`ä»£ç ä¸­å®Œæˆã€‚
3.  æˆ‘ä»¬å¯èƒ½åº”è¯¥åšä¸€äº›é”™è¯¯å¤„ç†ï¼Œä½†ç”±äºè¿™åªæ˜¯ä¸€ä¸ªç©å…·ä¾‹å­ï¼Œæˆ‘ä»¬å°†è·³è¿‡å®ƒã€‚ä¸ºäº†ç®€å•èµ·è§ã€‚

å¥½äº†ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªéœ€è¦è¯»å–ä¸€ä¸ªç¯å¢ƒå˜é‡å¹¶è¿è¡Œä¸€äº›ä»£ç æ¥åˆå§‹åŒ–æ˜‚è´µçš„ä¸œè¥¿ï¼Œå¦‚æ•°æ®åº“è¿æ¥ã€SDK ç­‰ã€‚æ²¡ä»€ä¹ˆéš¾çš„ã€‚

å®Œæˆåˆå§‹åŒ–åï¼Œæˆ‘ä»¬å¯ä»¥è¿›å…¥å¤„ç†ä»»åŠ¡çš„ä¸»å¾ªç¯ã€‚åƒå¾€å¸¸ä¸€æ ·ï¼Œè®©æˆ‘ä»¬åé€€ä¸€æ­¥ï¼Œé˜…è¯»æ–‡æ¡£:

1.  **è·å–äº‹ä»¶** â€”è°ƒç”¨ä¸‹ä¸€ä¸ªè°ƒç”¨ API æ¥è·å–ä¸‹ä¸€ä¸ªäº‹ä»¶ã€‚å“åº”æ­£æ–‡åŒ…å«äº‹ä»¶æ•°æ®ã€‚å“åº”å¤´åŒ…å«è¯·æ±‚ ID å’Œå…¶ä»–ä¿¡æ¯ã€‚
2.  **ä¼ æ’­è·Ÿè¸ªå¤´** â€”ä» API å“åº”ä¸­çš„`Lambda-Runtime-Trace-Id`å¤´è·å– X å°„çº¿è·Ÿè¸ªå¤´ã€‚ä¸º X-Ray SDK ä½¿ç”¨çš„ç¯å¢ƒå˜é‡è®¾ç½®ç›¸åŒçš„å€¼ã€‚
3.  **åˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡** â€”ä½¿ç”¨ç¯å¢ƒå˜é‡å’Œ API å“åº”å¤´ä¸­çš„ä¸Šä¸‹æ–‡ä¿¡æ¯åˆ›å»ºä¸€ä¸ªå¯¹è±¡ã€‚
4.  **è°ƒç”¨å‡½æ•°å¤„ç†ç¨‹åº** â€”å°†äº‹ä»¶å’Œä¸Šä¸‹æ–‡å¯¹è±¡ä¼ é€’ç»™å¤„ç†ç¨‹åºã€‚
5.  **å¤„ç†å“åº”** â€”è°ƒç”¨è°ƒç”¨å“åº” API æ¥å‘å¸ƒæ¥è‡ªå¤„ç†ç¨‹åºçš„å“åº”ã€‚
6.  **å¤„ç†é”™è¯¯** â€”å¦‚æœå‡ºç°é”™è¯¯ï¼Œè°ƒç”¨è°ƒç”¨é”™è¯¯ APIã€‚
7.  **æ¸…ç†** â€”é‡Šæ”¾æœªä½¿ç”¨çš„èµ„æºï¼Œå‘å…¶ä»–æœåŠ¡å‘é€æ•°æ®ï¼Œæˆ–è€…åœ¨è·å–ä¸‹ä¸€ä¸ªäº‹ä»¶ä¹‹å‰æ‰§è¡Œé¢å¤–çš„ä»»åŠ¡ã€‚

ç°åœ¨ï¼Œè¿™å¾ˆå®¹æ˜“ã€‚æˆ‘ä»¬åªæ˜¯:

*   å‘ä¸€ä¸ªç«¯ç‚¹å‘å‡º HTTP è¯·æ±‚å¹¶æ¥æ”¶ä¸€ä¸ªäº‹ä»¶
*   è¯»å–ä¸€äº›å¤´æ–‡ä»¶å¹¶è®¾ç½®ä¸€äº›ç¯å¢ƒå˜é‡
*   åˆ›å»ºä¸€äº›é¢å¤–çš„ä¸Šä¸‹æ–‡
*   å¤„ç†äº‹ä»¶æ—¶è€ƒè™‘(æˆ–ä¸è€ƒè™‘)ä¸Šä¸‹æ–‡
*   ç”Ÿæˆä¸€ä¸ªè¾“å‡ºï¼Œå¹¶é€šè¿‡å¦ä¸€ä¸ª HTTP è¯·æ±‚å‘å¸ƒå®ƒï¼Œæ— è®ºå®ƒæ˜¯ä¸€ä¸ªæ­£ç¡®çš„å“åº”è¿˜æ˜¯ä¸€ä¸ªé”™è¯¯(å°½ç®¡ç«¯ç‚¹ä¸åŒ)
*   å¿…è¦æ—¶æ¸…ç†

å…³äº API çš„ä¸€äº›ç»†èŠ‚å¯ä»¥åœ¨[è¿™é‡Œ](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-api.html)æ‰¾åˆ°ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ¶ä½œäº†ä¸€ä¸ª echo æœåŠ¡å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ç®€å•åœ°è·å–äº‹ä»¶å¹¶å‘å›å®ƒã€‚ä»£ç å¾ˆç®€å•:

## æ±‡ç¼–

é™¤äº†é”™è¯¯å¤„ç†(æˆ‘ä»¬è·³è¿‡å®ƒï¼Œå› ä¸ºå®ƒåªæ˜¯ä¸€ä¸ªç©å…·)ä¹‹å¤–ï¼Œæˆ‘ä»¬å‡ ä¹æ‹¥æœ‰äº†æˆ‘ä»¬éœ€è¦çš„ä¸€åˆ‡ã€‚ç°åœ¨è¿™è¿˜ä¸èƒ½ç¼–è¯‘ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº†ä¸€äº›å¤–éƒ¨åº“ã€‚æˆ‘ä»¬éœ€è¦å°†å®ƒä»¬æ·»åŠ åˆ°æˆ‘ä»¬çš„`package.yaml`æ–‡ä»¶ä¸­ã€‚æˆ‘ä»¬éœ€è¦åšçš„å¦ä¸€ä¸ªå°æ”¹å˜æ˜¯é‡å‘½åæˆ‘ä»¬çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚æˆ‘ä»¬å¯ä»¥ç¨åæ‰‹åŠ¨å®Œæˆï¼Œä½†æ˜¯è®©æˆ‘ä»¬è‡ªåŠ¨å®Œæˆã€‚`package.yaml`çš„ç›¸å…³éƒ¨åˆ†ç°åœ¨åº”è¯¥çœ‹èµ·æ¥åƒè¿™æ ·:

ç°åœ¨æˆ‘ä»¬å·²ç»å‡†å¤‡å¥½åœ¨æœ¬åœ°ç¼–è¯‘å’Œè¿è¡Œäº†(è¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´)ã€‚

```
*$ stack build
$ stack exec bootstrap
bootstrap: AWS_LAMBDA_RUNTIME_API: getEnv: does not exist (no  environment variable)*
```

æœ‰ç”¨ï¼æˆ‘ä»¬æœ‰ä¸€ä¸ªé”™è¯¯ï¼Œæˆ‘ä»¬ä¸¢å¤±äº†ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œä½†ç°åœ¨æ²¡é—®é¢˜ã€‚è®©æˆ‘ä»¬å°è¯•åœ¨æˆ‘ä»¬çš„å®¹å™¨ä¸­ç¼–è¯‘å®ƒ(è¿™ä¹Ÿå¯èƒ½éœ€è¦ä¸€æ®µæ—¶é—´)ã€‚

```
*bash-4.2# stack setup
bash-4.2# stack build
bash-4.2# ldd .stack-work/install/x86_64-linux/lts-12.14/8.4.3/bin/bootstrap
 linux-vdso.so.1 => (0x00007ffe14dae000)
 libm.so.6 => /lib64/libm.so.6 (0x00007fca5f2f1000)
 libpthread.so.0 => /lib64/libpthread.so.0 (0x00007fca5f0d5000)
 libz.so.1 => /lib64/libz.so.1 (0x00007fca5eebf000)
 librt.so.1 => /lib64/librt.so.1 (0x00007fca5ecb7000)
 libutil.so.1 => /lib64/libutil.so.1 (0x00007fca5eab4000)
 libdl.so.2 => /lib64/libdl.so.2 (0x00007fca5e8b0000)
 libgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007fca5e63a000)
 libc.so.6 => /lib64/libc.so.6 (0x00007fca5e26d000)
 /lib64/ld-linux-x86â€“64.so.2 (0x00007fca5f5f3000)*
```

ä¸€åˆ‡æ­£å¸¸ï¼Œä½†æ˜¯æˆ‘ä»¬çš„äºŒè¿›åˆ¶æ–‡ä»¶æœ‰ä¸€ä¸ªé—®é¢˜,`ldd`å‘½ä»¤å¼ºè°ƒäº†è¿™ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬çš„äºŒè¿›åˆ¶æ˜¯åŠ¨æ€é“¾æ¥çš„ã€‚è¿™å¾ˆå¥½ï¼Œå› ä¸ºå®ƒé™ä½äº†æ–‡ä»¶å¤§å°ï¼Œä½†åœ¨æˆ‘ä»¬æ— æ³•æ§åˆ¶çš„ç³»ç»Ÿä¸Šï¼Œä¸èƒ½å®‰è£…ä»»ä½•åº“æˆ–ä»»ä½•ä¸œè¥¿ï¼Œè¿™æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚è¿˜è®°å¾—æˆ‘ä»¬å¦‚ä½•å®‰è£…`zlib`å’Œ`gmp`å—ï¼Ÿåœ¨ AWS ä¸Šè¿è¡Œæˆ‘ä»¬çš„ lambda çš„ VM ä¸Šå°†ç¼ºå°‘è¿™ä¸¤ä¸ªã€‚æœ‰ä¸¤ç§é€‰æ‹©ã€‚æˆ‘ä»¬å¯ä»¥æ†ç»‘ç¼ºå¤±çš„åº“ï¼Œå°†æˆ‘ä»¬çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸é‚£äº›åº“é“¾æ¥èµ·æ¥ï¼Œæˆ–è€…ç¼–è¯‘ä¸€ä¸ªé™æ€é“¾æ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚è™½ç„¶ç¬¬äºŒç§æ–¹æ³•ä¼šäº§ç”Ÿä¸€ä¸ªæ›´å¤§çš„æ–‡ä»¶ï¼Œä½†æˆ‘ä»¬å°†ç»§ç»­ä½¿ç”¨å®ƒï¼Œå› ä¸ºå®ƒä½¿æ•´ä¸ªäº‹æƒ…æ›´åŠ å¥å£®ã€‚

ä¸ºäº†è®©å®ƒå·¥ä½œï¼Œæˆ‘ä»¬å°†ä¸å¾—ä¸å®‰è£…ä¸€äº›åº“çš„é™æ€ç‰ˆæœ¬ï¼Œè€Œä¸ä»…ä»…æ˜¯ä¸¢å¤±çš„é‚£äº›ã€‚ç»è¿‡åå¤è¯•éªŒï¼Œæˆ‘å‘ç°æˆ‘ä»¬åªéœ€è¦ä¸‰ä¸ªã€‚

```
*bash-4.2# yum install -y glibc-static gmp-static zlib-static*
```

ç°åœ¨ç½‘ä¸Šæœ‰å¾ˆå¤šå…³äºå¦‚ä½•ç”¨ ghc/cabal/stack ç¼–è¯‘ä¸€ä¸ªé™æ€äºŒè¿›åˆ¶çš„[èµ„æº](https://vadosware.io/post/static-binaries-for-haskell-a-convoluted-approach/)ã€‚æˆ‘é€‰æ‹©äº†ä¸€ä¸ªçœ‹èµ·æ¥å¾ˆå¹²å‡€çš„ï¼Œå¹¶ä¸”æœ‰ä¸€å¤©å¯èƒ½ä¼šè¢«ç”¨åœ¨å·¥å…·ä¸Šçš„ã€‚å½“æˆ‘ä»¬è¿è¡Œ`stack build`æ—¶ï¼Œå®ƒæ ¹æ®æˆ‘ä»¬`package.yaml`å’Œ`stack.yaml`ä¸­çš„å†…å®¹ä¸ºæˆ‘ä»¬ç”Ÿæˆäº†ä¸€ä¸ª`hs-lambda.cabal`æ–‡ä»¶ã€‚Stack ä¼šè­¦å‘Šæˆ‘ä»¬ä¸è¦ä¹±åŠ¨`.cabal`æ–‡ä»¶ã€‚äº‹å®ä¸Šï¼Œè‡ªä»å®ƒè¿›å…¥ç”±`stack new`åˆ›å»ºçš„`.gitignore`æ–‡ä»¶åï¼Œgit ç”šè‡³æ²¡æœ‰è·Ÿè¸ªå®ƒã€‚ç„¶è€Œï¼Œå°±ç›®å‰è€Œè¨€ï¼Œä½¿é™æ€é“¾æ¥å·¥ä½œçš„æœ€å¥½æ–¹æ³•æ˜¯åœ¨`executable`éƒ¨åˆ†çš„`.cabal`æ–‡ä»¶ä¸­æ·»åŠ ä¸€è¡Œã€‚

ç°åœ¨æˆ‘ä»¬å°†é‡æ–°ç¼–è¯‘ã€‚

```
*bash-4.2# stack clean
bash-4.2# stack build -ghc-options=â€™-fPICâ€™ â€” this will create a statically linked binary
bash-4.2# ldd .stack-work/install/x86_64-linux/lts-12.14/8.4.3/bin/bootstrap
 not a dynamic executable*
```

æˆ‘ä»¬å®Œäº†ã€‚å¦‚ä½ æ‰€è§ï¼Œæˆ‘ä»¬çš„äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯ç‹¬ç«‹çš„ï¼Œå¯ä»¥åœ¨ä»»ä½• linux å‘è¡Œç‰ˆä¸Šè¿è¡Œã€‚

## éƒ¨ç½²

ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥å›åˆ°æˆ‘ä»¬çš„å¼€å‘ç®±ï¼Œå°†æ•´ä¸ªä¸œè¥¿æ‰“åŒ…å¹¶éƒ¨ç½²å®ƒã€‚

```
*$ zip function.zip .stack-work/install/x86_64-linux/lts-12.14/8.4.3/bin/bootstrap
 adding: bootstrap (deflated 73%)
$ aws lambda create-function -function-name test-custom-runtime -zip-file fileb://function.zip -handler function.handler -runtime provided -role arn:aws:iam::123456789:role/aws-lambda-role
 {
 â€œFunctionNameâ€: â€œtest-custom-runtimeâ€,
 â€œFunctionArnâ€: â€œarn:aws:lambda:eu-central-1:123456789:function:test-custom-runtimeâ€,
 â€œRuntimeâ€: â€œprovidedâ€,
 â€œRoleâ€: â€œarn:aws:iam::123456789:role/aws-lambda-roleâ€,
 â€œHandlerâ€: â€œfunction.handlerâ€,
 â€œCodeSizeâ€: 4667617,
 â€œDescriptionâ€: â€œâ€,
 â€œTimeoutâ€: 3,
 â€œMemorySizeâ€: 128,
 â€œLastModifiedâ€: â€œ2019â€“01â€“15T21:40:01.625+0000â€,
 â€œCodeSha256â€: â€œTMVO8YwRTW3tu9CKpT5ShPe+iVVemrq9xKW2iDdS9Lc=â€,
 â€œVersionâ€: â€œ$LATESTâ€,
 â€œTracingConfigâ€: {
 â€œModeâ€: â€œPassThroughâ€
 },
 â€œRevisionIdâ€: â€œd8579e6e-bc80â€“4951-be5f-cabb5d93f0b6â€
 }*
```

æˆ‘ä»¬å‡†å¤‡å¥½æµ‹è¯•å®ƒäº†ã€‚

```
*$ aws lambda invoke -function-name â€˜test-custom-runtimeâ€™ -payload â€˜{â€œtextâ€:â€Helloâ€}â€™ response.txt
 {
 â€œStatusCodeâ€: 200,
 â€œExecutedVersionâ€: â€œ$LATESTâ€
 }$ cat response.txt
 {â€œtextâ€:â€Helloâ€}*
```

æœ‰ç”¨ï¼å¦‚æ‚¨æ‰€è§ï¼Œæˆ‘ä»¬çš„ lambda è¿è¡ŒæˆåŠŸï¼Œå¹¶å°†æˆ‘ä»¬çš„æœ‰æ•ˆè´Ÿè½½åé¦ˆç»™äº†æˆ‘ä»¬ã€‚

*åŸè½½äº 2019 å¹´ 1 æœˆ 31 æ—¥*[*ã€https://www.tooploox.comã€‘*](https://www.tooploox.com/blog/aws-lambda-custom-runtimes-with-haskell)*ã€‚*