# Kubernetes API ä¼˜å…ˆçº§å’Œå…¬å¹³æ€§

> åŸæ–‡ï¼š<https://itnext.io/kubernetes-api-priority-and-fairness-b1ef2b8a26a2?source=collection_archive---------3----------------------->

T ä»–çš„å¸–å­æ˜¯å…³äºæ–°çš„ Kubernetes [API ä¼˜å…ˆçº§å’Œå…¬å¹³æ€§](https://kubernetes.io/docs/concepts/cluster-administration/flow-control/) (APF)ç‰¹æ€§ã€‚æˆ‘å°†ä¸æ‚¨åˆ†äº«æˆ‘æ‰€å­¦åˆ°çš„çŸ¥è¯†ï¼Œå¹¶å‘æ‚¨å±•ç¤ºå¦‚ä½•å®šä¹‰ç­–ç•¥æ¥å¯¹ Kubernetes API æœåŠ¡å™¨çš„å…¥ç«™è¯·æ±‚è¿›è¡Œä¼˜å…ˆçº§æ’åºå’ŒèŠ‚æµã€‚ç„¶åï¼Œæˆ‘è¿˜å°†ä»‹ç»ä¸€äº›æŒ‡æ ‡å’Œè°ƒè¯•ç«¯ç‚¹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒä»¬æ¥ç¡®å®š APF æ˜¯å¦å½±å“äº†æ‚¨çš„æ§åˆ¶å™¨ã€‚

ğŸ†•*åœ¨ Kubernetes 1.20 ä¸­é»˜è®¤å¯ç”¨ APFï¼Œä½œä¸º beta ç‰¹æ€§ã€‚å¯¹äºæ—©æœŸç‰ˆæœ¬çš„ Kubernetesï¼Œå¯ä»¥é€šè¿‡* `APIPriorityAndFairness` *ç‰¹æ€§é—¨* [*å¯ç”¨*](https://kubernetes.io/docs/concepts/cluster-administration/flow-control/#enabling-disabling-api-priority-and-fairness) *ã€‚*

# ä»€ä¹ˆæ˜¯ APF

åœ¨ APF ä¹‹å‰ï¼ŒAPI æœåŠ¡å™¨ä½¿ç”¨`--max-requests-inflight`å’Œ`--max-mutating-requests-inflight`å‘½ä»¤è¡Œæ ‡å¿—æ¥è°ƒèŠ‚å…¥ç«™è¯·æ±‚çš„æ•°é‡ã€‚è¿™ä¸ªå®ç°å¯¹è¯·æ±‚çš„å”¯ä¸€åŒºåˆ«æ˜¯è¯·æ±‚æ˜¯å¦æ˜¯å˜å¼‚çš„ã€‚ä¾‹å¦‚ï¼Œå®ƒä»¬æ— æ³•ç¡®ä¿ä¼˜å…ˆçº§è¾ƒä½çš„æµé‡ä¸ä¼šæ·¹æ²¡å…³é”®æµé‡ï¼Œå¦‚[æœ¬æœŸç¤ºä¾‹](https://github.com/kubernetes/kubernetes/issues/77723)ä¸­æ‰€è¿°ã€‚

APF æä¾›äº†ä¸€ç§æµé‡æ§åˆ¶æœºåˆ¶ï¼Œä»¥ç¡®ä¿ API æœåŠ¡å™¨èƒ½å¤Ÿåœ¨ä¿è¯å…¬å¹³æ€§çš„åŒæ—¶æŠ‘åˆ¶è¯·æ±‚ã€‚å®ƒå…è®¸å¹³å°æ‰€æœ‰è€…å®šä¹‰ API çº§ç­–ç•¥ï¼Œå°†å…¥ç«™è¯·æ±‚åˆ†ç±»ä¸ºä¸åŒçš„*ä¼˜å…ˆçº§*å’Œ*æµ*ã€‚

![](img/333c69ab1ce8cb8b1ace69543c7ff6ea.png)

é€šè¿‡æµé‡å’Œä¼˜å…ˆçº§ç®¡ç†è¯·æ±‚

ä¸€èˆ¬æ¥è¯´ï¼Œæ‰€æœ‰ä¼ å…¥çš„è¯·æ±‚éƒ½æ ¹æ®ä¸€ç»„*æµæ¨¡å¼*è¿›è¡Œè¯„ä¼°ã€‚æ¯ä¸ªè¯·æ±‚å°†ä¸ä¸€ä¸ªæµæ¨¡å¼ç›¸åŒ¹é…ï¼Œè¯¥æ¨¡å¼å°†è¯·æ±‚åˆ†é…åˆ°ä¸€ä¸ª*ä¼˜å…ˆçº§*ã€‚å½“æŸä¸ªä¼˜å…ˆçº§çš„è¯·æ±‚è¢«æŠ‘åˆ¶æ—¶ï¼Œå…¶ä»–ä¼˜å…ˆçº§çš„è¯·æ±‚ä¸å—å½±å“ã€‚

ä¸ºäº†è¿›ä¸€æ­¥åŠ å¼ºä¼˜å…ˆçº§è¯·æ±‚ä¹‹é—´çš„å…¬å¹³æ€§ï¼ŒåŒ¹é…æµæ¨¡å¼å°†è¯·æ±‚ä¸*æµ*ç›¸å…³è”ï¼Œå…¶ä¸­æ¥è‡ªç›¸åŒæºçš„è¯·æ±‚è¢«åˆ†é…ç›¸åŒçš„*æµåŒºåˆ†ç¬¦*ã€‚

åœ¨è¿™äº›æµä¸­ï¼Œä¸èƒ½ç«‹å³æ‰§è¡Œçš„è¯·æ±‚å°†ä½¿ç”¨[æ··æ´—åˆ†ç‰‡](https://aws.amazon.com/blogs/architecture/shuffle-sharding-massive-and-magical-fault-isolation/)è¿›è¡Œæ’é˜Ÿï¼Œè¿™æ˜¯ä¸€ç§å¸¸ç”¨äºéš”ç¦»å·¥ä½œè´Ÿè½½ä»¥æé«˜å®¹é”™èƒ½åŠ›çš„æŠ€æœ¯[ã€‚å½“æœ‰è¶³å¤Ÿçš„å®¹é‡å¯ç”¨æ—¶ï¼Œä½¿ç”¨ä¸€ä¸ª](https://aws.amazon.com/builders-library/workload-isolation-using-shuffle-sharding/#What_is_shuffle_sharding.3F)[å…¬å¹³æ’é˜Ÿ](https://en.wikipedia.org/wiki/Fair_queuing)ç®—æ³•æ¥ä½¿æµä¸­çš„è¯·æ±‚å‡ºåˆ—ã€‚

# äº†è§£æµæ¨¡å¼å’Œä¼˜å…ˆçº§é…ç½®

ğŸ› ï¸ ï¸ *æœ¬èŠ‚ä½¿ç”¨çš„å‘½ä»¤é€šè¿‡ Kubernetes 1.19 æµ‹è¯•ï¼Œä½¿ç”¨* [*ç§ç±»*](https://kind.sigs.k8s.io/)*v 0 . 9 . 0 .*`[*yq*](https://mikefarah.gitbook.io/yq/)`*v 4 . 3 . 1 åˆ›å»ºï¼Œç”¨äºè¿‡æ»¤ YAML è¾“å‡ºä»¥æé«˜å¯è¯»æ€§ã€‚*

ï¸ï¸ğŸ› ï¸ *æ™®ç½—ç±³ä¿®æ–¯æ“ä½œå‘˜ä½¿ç”¨* [*éƒ¨ç½² kube-æ™®ç½—ç±³ä¿®æ–¯*](https://github.com/prometheus-operator/kube-prometheus)*0.7 ç‰ˆæœ¬ã€‚æŸ¥çœ‹ kube-prometheus* [*è‡ªè¿°æ–‡ä»¶*](https://github.com/prometheus-operator/kube-prometheus#access-the-dashboards) *ï¼Œäº†è§£å¦‚ä½•é€šè¿‡ç«¯å£è½¬å‘è®¿é—® prometheus æ§åˆ¶å°ã€‚*

åœ¨åˆ›å»ºæˆ‘ä»¬è‡ªå·±çš„`FlowSchema`å’Œ`PriorityLevelConfiguration`èµ„æºä¹‹å‰ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨é»˜è®¤çš„æ¦‚å¿µæ¥å›é¡¾ä¸€äº›é‡è¦çš„æ¦‚å¿µ:

é»˜è®¤æµæ¨¡å¼åˆ—è¡¨

ä»¥`system-leader-election`æµæ¨¡å¼ä¸ºä¾‹ï¼Œå®ƒçš„`.spec`å¦‚ä¸‹æ‰€ç¤º:

â€œç³»ç»Ÿ-é¢†å¯¼è€…-é€‰ä¸¾â€æµç¨‹å›¾çš„è§„æ ¼

`rules`æè¿°äº†ç”¨äºè¯†åˆ«åŒ¹é…è¯·æ±‚çš„æ ‡å‡†åˆ—è¡¨ã€‚å½“ä¸”ä»…å½“ä»¥ä¸‹æƒ…å†µæ—¶ï¼Œæµæ¨¡å¼åŒ¹é…è¯·æ±‚:

*   è‡³å°‘æœ‰ä¸€ä¸ª`subjects`ä¸å‘å‡ºè¯·æ±‚çš„ä¸»é¢˜ç›¸åŒ¹é…ï¼Œå¹¶ä¸”
*   å®ƒçš„`resourceRules`æˆ–`nonResourceRules`ä¸­è‡³å°‘æœ‰ä¸€ä¸ªä¸è¢«è¯·æ±‚çš„åŠ¨è¯å’Œ(é)èµ„æºåŒ¹é…

`distinguishedMethod`å®šä¹‰äº†å¦‚ä½•è®¡ç®—æµè¯†åˆ«ç¬¦:

*   `ByUser`æ¥è‡ªåŒä¸€ä¸ª`subject`çš„è¯·æ±‚è¢«åˆ†ç»„åˆ°åŒä¸€ä¸ªæµä¸­ï¼Œè¿™æ ·ç”¨æˆ·å°±ä¸ä¼šäº’ç›¸æ·¹æ²¡
*   `ByNamespace`æ¥è‡ªåŒä¸€ä¸ªåç§°ç©ºé—´çš„è¯·æ±‚è¢«åˆ†ç»„åˆ°åŒä¸€ä¸ªæµä¸­ï¼Œè¿™æ ·ä¸€ä¸ªåç§°ç©ºé—´ä¸­çš„å·¥ä½œè´Ÿè½½å°±ä¸ä¼šæ·¹æ²¡å…¶ä»–åç§°ç©ºé—´ä¸­çš„å·¥ä½œè´Ÿè½½
*   ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ï¼Œå…¶ä¸­æ‰€æœ‰è¯·æ±‚éƒ½è¢«åˆ†ç»„åˆ°ä¸€ä¸ªæµä¸­

å½“åŒ¹é…è¯·æ±‚æ—¶ï¼Œå…·æœ‰è¾ƒä½`matchingPrecedence`çš„æµæ¨¡å¼æ¯”å…·æœ‰è¾ƒé«˜`matchingPrecendence`çš„æµæ¨¡å¼å…·æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ã€‚

`priorityLevelConfiguration`æ˜¯æŒ‡æŒ‡å®šæµé‡æ§åˆ¶å±æ€§çš„ä¼˜å…ˆçº§é…ç½®èµ„æºã€‚

è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹`leader-election`ä¼˜å…ˆçº§é…ç½®çš„`.spec`:

â€œé¢†å¯¼è€…é€‰ä¸¾â€ä¼˜å…ˆçº§é…ç½®çš„è§„æ ¼

`limited.assuredConcurrencyShares`å®šä¹‰äº†ç”¨äºè®¡ç®—*ä¿è¯å¹¶å‘å€¼çš„*å¹¶å‘ä»½é¢*ã€‚*[Kubernetes API æ–‡æ¡£](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#limitedprioritylevelconfiguration-v1beta1-flowcontrol-apiserver-k8s-io)æä¾›äº†å…³äºå¦‚ä½•è®¡ç®—*ä¿è¯å¹¶å‘å€¼*çš„æ›´å¤šä¿¡æ¯ã€‚

è¦æŸ¥çœ‹æ¯ä¸ªä¼˜å…ˆçº§çš„è®¡ç®—å¹¶å‘é™åˆ¶ï¼Œè¯·æŸ¥çœ‹`apiserver_flowcontrol_request_concurrenty_limit`æŒ‡æ ‡:

![](img/49f5a0cd47335aaf360fdae78cd28c5c.png)

æ‰€æœ‰ä¼˜å…ˆçº§çš„å¹¶å‘é™åˆ¶

`limited.assuredConcurrencyShares`çš„å€¼ä¸`apiserver_flowcontrol_request_concurrency_limit`æŒ‡æ ‡çš„å€¼ç›¸å…³è”ï¼Œå¢åŠ ä¼˜å…ˆçº§çš„å¹¶å‘ä»½é¢å°†å¢åŠ å…¶å¹¶å‘é™åˆ¶ã€‚ç”±äº API æœåŠ¡å™¨çš„æ€»å¹¶å‘é™åˆ¶æ˜¯ç”±æ‰€æœ‰ä¼˜å…ˆçº§å…±äº«çš„ï¼Œå› æ­¤å¢åŠ ä¸€ä¸ªä¼˜å…ˆçº§çš„é™åˆ¶å°†ä¼šå‡å°‘å…¶ä»–ä¼˜å…ˆçº§çš„é™åˆ¶ã€‚

`limited.limitResponse`å®šä¹‰äº†å¤„ç†ä¸èƒ½ç«‹å³æ‰§è¡Œçš„è¯·æ±‚çš„ç­–ç•¥ã€‚`limit.limitResponse.type`æ”¯æŒä¸¤ä¸ªå€¼:

*   `Queue`è¯·æ±‚åœ¨å“ªé‡Œæ’é˜Ÿ
*   `Reject`å½“è¯·æ±‚å›  HTTP 429 é”™è¯¯è€Œè¢«ä¸¢å¼ƒæ—¶

ä½¿ç”¨`Queue`é™åˆ¶å“åº”ç±»å‹ï¼Œå¯ä»¥é€šè¿‡è°ƒæ•´`limited.limitResponse.queuing`çš„å±æ€§æ¥è¿›ä¸€æ­¥é…ç½®æ’é˜Ÿè¡Œä¸ºã€‚APF [æ–‡æ¡£](https://kubernetes.io/docs/concepts/cluster-administration/flow-control/#prioritylevelconfiguration)å’Œ[ææ¡ˆ](https://github.com/kubernetes/enhancements/tree/master/keps/sig-api-machinery/1040-priority-and-fairness#assignment-to-a-queue)æä¾›äº†å…³äºæ”¹å˜`queues`ã€`queueLengthLimit`å’Œ`handSize`å€¼çš„å½±å“çš„æ›´å¤šä¿¡æ¯ã€‚

åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ç ”ç©¶å¦‚ä½•ç¡®å®šå“ªä¸ªæ¨¡å¼ä¸æˆ‘ä»¬çš„è¯·æ±‚ç›¸åŒ¹é…ã€‚

# ç¡®å®šåŒ¹é…çš„æµæ¨¡å¼

ç¡®å®šå“ªä¸ªæµæ¨¡å¼åŒ¹é…æˆ‘ä»¬çš„è¯·æ±‚çš„æœ€å¿«æ–¹æ³•æ˜¯æ£€æŸ¥æ¥è‡ª API æœåŠ¡å™¨çš„ä¸¤ä¸ª APF å“åº”å¤´`X-Kubernetes-PF-FlowSchema-UID`å’Œ`X-Kubernetes-PF-PriorityLevel-UID`ã€‚å®ƒä»¬å‘æˆ‘ä»¬å±•ç¤ºäº†åŒ¹é…æµæ¨¡å¼çš„ uid å’Œä¼˜å…ˆçº§é…ç½®:

ç¡®å®šåŒ¹é…çš„æµæ¨¡å¼å’Œä¼˜å…ˆçº§

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘çš„`GET` pods è¯·æ±‚ä¸`exempt`æµæ¨¡å¼å’ŒåŒåçš„ä¼˜å…ˆçº§é…ç½®ç›¸åŒ¹é…ã€‚

ä¸ºäº†ç†è§£è¿™ä¸ªæµæ¨¡å¼å¯¹æˆ‘çš„è¯·æ±‚çš„å½±å“ï¼Œè®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹å®ƒçš„`.spec`:

â€œè±å…â€æµæ¨¡å¼å’Œä¼˜å…ˆçº§çš„è§„æ ¼

è¯·æ³¨æ„`exempt`æµæ¨¡å¼:

1.  å…·æœ‰æœ€é«˜ä¼˜å…ˆçº§ï¼Œå…¶`matchingPrecedence`è®¾ç½®ä¸º 1
2.  åŒ¹é…æ¥è‡ª`system:masters`ç»„çš„è¯·æ±‚

æ­¤å¤–ï¼Œ`exempt`ä¼˜å…ˆçº§é…ç½®å°†å…¶`type`è®¾ç½®ä¸º`Exempt`ï¼Œæ²¡æœ‰ä»»ä½•é˜Ÿåˆ—é…ç½®ã€‚

æ‰€æœ‰è¿™äº›éƒ½æ˜¯æœ‰æ„ä¹‰çš„ï¼Œå› ä¸ºæˆ‘çš„ kubectl æ˜¯ä½¿ç”¨æˆ‘çš„ cluster-admin kubeconfig å‡­è¯è¿›è¡Œèº«ä»½éªŒè¯çš„ï¼Œè¯¥å‡­è¯ä¸`system:masters`ç»„ç›¸å…³è”ã€‚æ¥è‡ª`system:masters`ç»„çš„è¯·æ±‚è¢«è®¤ä¸ºæ˜¯å…³é”®æµé‡ï¼Œå®ƒä»¬ä¸å—æµé‡æ§åˆ¶ï¼Œå¹¶ç”±`exempt`æµæ¨¡å¼æ ¹æ®å…¶`exempt`ä¼˜å…ˆçº§é…ç½®ç«‹å³è°ƒåº¦ã€‚

å¥½äº†ï¼Œæˆ‘æƒ³æˆ‘ä»¬ç°åœ¨å·²ç»å‡†å¤‡å¥½è¯•éªŒæˆ‘ä»¬è‡ªå·±çš„æµæ¨¡å¼å’Œä¼˜å…ˆçº§é…ç½®äº†ğŸ¤˜ã€‚

# åˆ›å»ºå®šåˆ¶æµæ¨¡å¼å’Œä¼˜å…ˆçº§

è®©æˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ªå…·æœ‰ 3 ä¸ªæœåŠ¡å¸æˆ·çš„`demo`åç§°ç©ºé—´ï¼Œå³`podlister-0`ã€`podlister-1.`å’Œ`podlister-2`ï¼Œå¹¶å…·æœ‰ä»`demo`åç§°ç©ºé—´è®¿é—®`LIST`å’Œ`GET`pod çš„æƒé™:

åˆ›å»ºâ€œæ¼”ç¤ºâ€å‘½åç©ºé—´ã€å…¶æœåŠ¡å¸æˆ·å’Œæ‰€éœ€çš„ RBAC

ç„¶åï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰æµæ¨¡å¼æ¥ç®¡ç†æ¥è‡ªè¿™ 3 ä¸ªæœåŠ¡å¸æˆ·çš„è¯·æ±‚:

éƒ¨ç½² restrict-pod-lister æµæ¨¡å¼å’Œä¼˜å…ˆçº§é…ç½®

åœ¨`restrict-pod-lister`ä¼˜å…ˆçº§ä¸­ä½¿ç”¨çš„å”¯ä¸€éç¼ºçœå€¼æ˜¯é˜Ÿåˆ—çš„å¤§å°(`spec.limited.limitResponse.queuing.queueLengthLimit`)ï¼Œå®ƒè¢«è®¾ç½®ä¸º 5 ä¸ªè¯·æ±‚ã€‚è¿™å°†æœ‰åŠ©äºæ›´å¿«åœ°è§¦å‘èŠ‚æµæ•ˆåº”ã€‚

ä½¿ç”¨`kubectl --as`é€‰é¡¹ï¼Œæˆ‘ä»¬å¯ä»¥[æ¨¡æ‹Ÿ](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#user-impersonation)æœåŠ¡å¸æˆ·å‘`LIST` pods ç«¯ç‚¹å‘é€è¯·æ±‚:

å‘é€å¸¦æœ‰ç”¨æˆ·æ¨¡æ‹Ÿçš„åˆ—è¡¨çª—æ ¼è¯·æ±‚

å¤ªå¥½äº†ï¼æˆ‘ä»¬çš„è¯·æ±‚æŒ‰ç…§é¢„æœŸç”±`restrict-pod-lister`æµæ¨¡å¼å’Œä¼˜å…ˆçº§è¿›è¡ŒåŒ¹é…ğŸ‘ã€‚

# æ£€æŸ¥ APF æŒ‡æ ‡

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡å°†ä¸€ä¸ªè‡ªå®šä¹‰æ§åˆ¶å™¨éƒ¨ç½²åˆ°`demo`åç§°ç©ºé—´æ¥æ¨¡æ‹Ÿ API æœåŠ¡å™¨çš„ä¸€äº›æµé‡ï¼Œä½œä¸º 3 ä¸ªä¸åŒçš„`Deployment`ã€‚æ¯ä¸ªéƒ¨ç½²ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„ 3 ä¸ªæœåŠ¡å¸æˆ·ä¹‹ä¸€:

éƒ¨ç½²è‡ªå®šä¹‰æ§åˆ¶å™¨

æ§åˆ¶å™¨ä½¿ç”¨ Go çš„`[time.Tick()](https://golang.org/pkg/time/#Tick)`å‡½æ•°å‘ API æœåŠ¡å™¨çš„`LIST` pod ç«¯ç‚¹å‘é€è¿ç»­æµé‡ï¼Œä»¥æ£€ç´¢`demo`åç§°ç©ºé—´ä¸­çš„æ‰€æœ‰ podã€‚æºä»£ç å¯åœ¨[è¿™é‡Œ](https://github.com/ihcsim/controllers/blob/master/podlister/main.go)è·å¾—ã€‚

åˆ‡æ¢åˆ° Prometheus æ§åˆ¶å°ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨`apiserver_flowcontrol_dispatched_requests_total`æŒ‡æ ‡æ¥æ£€ç´¢æˆ‘ä»¬çš„æµæ¨¡å¼åŒ¹é…çš„è¯·æ±‚æ€»æ•°:

```
apiserver_flowcontrol_dispatched_requests_total{job=â€apiserverâ€,flowSchema=â€restrict-pod-listerâ€}
```

![](img/f81cd1dc58301d78c4c2dcc59164cc92.png)

æˆ‘ä»¬çš„æµæ¨¡å¼åŒ¹é…çš„è¯·æ±‚æ€»æ•°

æ­£å¦‚å¯¹åå‘é‡çš„é¢„æœŸï¼Œæˆ‘ä»¬è§‚å¯Ÿåˆ°å…¶é€Ÿç‡æ€»å’Œå‘ˆä¸Šå‡è¶‹åŠ¿:

```
sum(rate(apiserver_flowcontrol_dispatched_requests_total{job="apiserver",flowSchema="restrict-pod-lister"}[15m])) by (flowSchema)
```

![](img/af57fe269e4c59f274704743ceb68bfe.png)

å·²è°ƒåº¦è¯·æ±‚é€Ÿç‡æ€»å’Œçš„ä¸Šå‡è¶‹åŠ¿

`apiserver_flowcontrol_current_inqueue_requests`æŒ‡æ ‡æ˜¾ç¤ºäº†é˜Ÿåˆ—ä¸­ç­‰å¾…çš„è¯·æ±‚æ•°é‡ã€‚`0`å€¼è¡¨ç¤ºæˆ‘ä»¬çš„é˜Ÿåˆ—å½“å‰æ˜¯ç©ºçš„:

```
apiserver_flowcontrol_current_inqueue_requests{job="apiserver",flowSchema="restrict-pod-lister"}
```

![](img/9e94b3409b259b7792b9ea5c7fafe409.png)

åœ¨æˆ‘ä»¬çš„é˜Ÿåˆ—ä¸­ç­‰å¾…çš„è¯·æ±‚æ•°

æ›´é‡è¦çš„æ˜¯ï¼Œè¢«æ‹’ç»çš„è¯·æ±‚æ•°é‡ä¹Ÿæ˜¯`0`ï¼Œå¦‚`apiserver_flowcontrol_rejected_requests_total`æŒ‡æ ‡æ‰€ç¤º:

```
apiserver_flowcontrol_rejected_requests_total{job="apiserver",flowSchema="restrict-pod-lister"}
```

![](img/1d4b87cb4f874c6534828ee2d51f6f62.png)

è¢«æˆ‘ä»¬çš„æµæ¨¡å¼æ‹’ç»çš„è¯·æ±‚æ•°

`apiserver_flowcontrol_request_execution_seconds`æŒ‡æ ‡æä¾›äº†å¯¹é˜Ÿåˆ—ä¸­çš„è¯·æ±‚æ‰§è¡Œæ—¶é—´çš„æ´å¯Ÿ:

```
histogram_quantile(0.99, sum(rate(apiserver_flowcontrol_request_execution_seconds_bucket{job="apiserver",flowSchema="restrict-pod-lister"}[15m])) by (le,flowSchema))
```

![](img/57c5d2b55bb5ea2ac4f8d0f176abfb65.png)

æˆ‘ä»¬é˜Ÿåˆ—ä¸­è¯·æ±‚æ‰§è¡Œæ—¶é—´çš„ p99(ç§’)

åœ¨è¿™ä¸ªç‰¹å®šçš„æµ‹è¯•è¿è¡Œä¸­ï¼Œæˆ‘ä»¬é˜Ÿåˆ—ä¸­è¯·æ±‚æ‰§è¡Œæ—¶é—´çš„ p99 å¤§çº¦æ˜¯ 0.02 ç§’ã€‚

ç›¸åï¼Œ`apiserver_flowcontrol_request_wait_duration_seconds`æŒ‡æ ‡æ˜¾ç¤ºäº†è¯·æ±‚åœ¨é˜Ÿåˆ—ä¸­èŠ±è´¹çš„æ—¶é—´:

```
histogram_quantile(0.99, sum(rate(apiserver_flowcontrol_request_wait_duration_seconds_bucket{job="apiserver",flowSchema="restrict-pod-lister"}[15m])) by (le,flowSchema))
```

![](img/24788dafa2cb64618c9ded3ecddc2123.png)

æˆ‘ä»¬é˜Ÿåˆ—ä¸­è¯·æ±‚ç­‰å¾…æŒç»­æ—¶é—´(ç§’)çš„ p99

è¿™ä¸ªæµ‹è¯•è¿è¡Œçš„è¯·æ±‚ç­‰å¾…æŒç»­æ—¶é—´ p99 å¤§çº¦æ˜¯ 4.95 æ¯«ç§’ã€‚ç¨åæˆ‘ä»¬å°†å†æ¬¡è®¨è®ºè¿™ä¸¤ä¸ªæŒ‡æ ‡ï¼Œçœ‹çœ‹å®ƒä»¬å¦‚ä½•å½±å“æˆ‘ä»¬çš„å®¢æˆ·ç«¯ä¸Šä¸‹æ–‡è¶…æ—¶ã€‚

è®©æˆ‘ä»¬æ·»åŠ æ›´å¤šçš„å‰¯æœ¬æ¥å¢åŠ æµé‡ï¼Œä»¥æ¿€æ´»æ’é˜Ÿæ•ˆåº”:

å¢åŠ è‡ªå®šä¹‰æ§åˆ¶å™¨å‰¯æœ¬çš„æ•°é‡

å½“æˆ‘ä»¬çš„é˜Ÿåˆ—é¥±å’Œæ—¶ï¼Œè¢«æ‹’ç»çš„è¯·æ±‚æ•°é‡å¼€å§‹å¢åŠ ã€‚`reason`æ ‡ç­¾å‘Šè¯‰æˆ‘ä»¬è¿™äº›è¯·æ±‚è¢«æ‹’ç»çš„åŸå› (å³`queue-full`æˆ–`timeout`):

```
sum(rate(apiserver_flowcontrol_rejected_requests_total{job="apiserver",flowSchema="restrict-pod-lister"}[15m])) by (flowSchema,reason)
```

![](img/6181ef43dae4f4b23b3782a79540c0f5.png)

åœ¨æ§åˆ¶å™¨çš„æ—¥å¿—ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°èŠ‚æµæ¶ˆæ¯:

æ¥è‡ªè‡ªå®šä¹‰æ§åˆ¶å™¨çš„èŠ‚æµæ—¥å¿—

è¯·æ±‚**ç­‰å¾…**æŒç»­æ—¶é—´(`apiserver_flowcontrol_request_wait_duration_seconds`)çš„ p99 åœ¨ 4.0 åˆ° 7.5 ç§’ä¹‹é—´å¾˜å¾Šã€‚

p99 è¯·æ±‚**æ‰§è¡Œ**çš„æ—¶é—´(`apiserver_flowcontrol_request_execution_seconds`)çº¦ä¸º 0.96 ç§’ã€‚

å¦‚æœæˆ‘ä»¬ç”¨å°äºé˜Ÿåˆ—ç­‰å¾…æŒç»­æ—¶é—´çš„[ä¸Šä¸‹æ–‡è¶…æ—¶](https://golang.org/pkg/context/#WithTimeout)æ¥æ›´æ–°æ§åˆ¶å™¨ï¼Œæˆ‘ä»¬å°†å¼€å§‹åœ¨æ—¥å¿—ä¸­çœ‹åˆ°ä¸€äº›`context deadline exceeded`é”™è¯¯:

å¸¦æœ‰â€œè¶…å‡ºä¸Šä¸‹æ–‡æˆªæ­¢æ—¶é—´â€é”™è¯¯çš„æ§åˆ¶å™¨æ—¥å¿—

å› æ­¤ï¼Œå¦‚æœæ‚¨å¼€å§‹åœ¨æ§åˆ¶å™¨çš„æ—¥å¿—ä¸­çœ‹åˆ°è®¸å¤š`context deadline exceeded`é”™è¯¯ï¼Œæ‚¨ç°åœ¨çŸ¥é“å¦‚ä½•ä½¿ç”¨ APF æŒ‡æ ‡å’Œè°ƒè¯•ç«¯ç‚¹æ¥ç¡®å®š APF æ˜¯å¦é™åˆ¶äº†æ‚¨çš„è¯·æ±‚ã€‚

è¿™äº›æ˜¯æˆ‘å‘ç°éå¸¸æœ‰ç”¨çš„æŒ‡æ ‡ã€‚è¿˜æœ‰å…¶ä»– APF æŒ‡æ ‡åœ¨æœ¬æ–‡ä¸­æ²¡æœ‰æ¶‰åŠã€‚æŸ¥çœ‹ [APF æ–‡æ¡£](https://kubernetes.io/docs/concepts/cluster-administration/flow-control/#metrics)è·å–å®Œæ•´åˆ—è¡¨ã€‚

# æ£€æŸ¥è°ƒè¯•ç«¯ç‚¹

é™¤äº†åº¦é‡ä¹‹å¤–ï¼ŒAPF è¿˜å…¬å¼€äº†ä¸€äº›è°ƒè¯•ç«¯ç‚¹ï¼Œè¿™äº›ç«¯ç‚¹æä¾›äº†å¯¹é˜Ÿåˆ—å’Œè¯·æ±‚çŠ¶å†µçš„è¿›ä¸€æ­¥äº†è§£ã€‚

`/debug/api_priority_and_fairness/dump_priority_levels`ç«¯ç‚¹å‘Šè¯‰æˆ‘ä»¬ä¼˜å…ˆçº§ä¸­`executing`å’Œ`waiting`è¯·æ±‚çš„æ€»æ•°:

è°ƒè¯•ç«¯ç‚¹æ˜¾ç¤ºäº†æˆ‘ä»¬çš„ä¼˜å…ˆçº§é˜Ÿåˆ—çš„æƒ…å†µ

è¿è¡Œè¿™ä¸ªå‘½ä»¤æ—¶ï¼Œæˆ‘ä»¬çš„é˜Ÿåˆ—ä¸­æœ‰ 70 ä¸ª`waiting`å’Œ 29 ä¸ª`executing`è¯·æ±‚ã€‚

`/debug/api_priority_and_fairness/dump_queues`ç«¯ç‚¹ä¸ºæˆ‘ä»¬çš„æµæ¨¡å¼ä¸­çš„æ¯ä¸ªé˜Ÿåˆ—æä¾›äº†è¿›ä¸€æ­¥çš„å¯è§æ€§:

è°ƒè¯•ç«¯ç‚¹æ˜¾ç¤ºäº†ä¼˜å…ˆçº§ä¸­æ¯ä¸ªé˜Ÿåˆ—çš„æƒ…å†µ

ä¸ºäº†å¯è¯»æ€§ï¼Œä¸Šé¢çš„è¾“å‡ºè¢«æˆªæ–­äº†ã€‚æ³¨æ„ï¼Œè¾“å‡ºä¸­æ˜¾ç¤ºçš„é˜Ÿåˆ—æ•°é‡ç­‰äºä¼˜å…ˆçº§çš„å€¼`spec.limited.limitResponse.queuing.queues`ã€‚

æœ€åï¼Œ`/debug/api_priority_and_fairness/dump_requests`ç«¯ç‚¹å‘Šè¯‰æˆ‘ä»¬åˆ†é…ç»™æ¯ä¸ªè¯·æ±‚çš„æµåŒºåˆ†ç¬¦ï¼Œä»¥åŠå…³äºè¯·æ±‚çš„`subject`çš„ä¿¡æ¯:

æ˜¾ç¤ºè¯·æ±‚ä¿¡æ¯çš„è°ƒè¯•ç«¯ç‚¹

# ä»èŠ‚æµæ•ˆåº”ä¸­æ¢å¤

å¦‚æœæˆ‘ä»¬å°†æ§åˆ¶å™¨ç¼©å°åˆ° 0 ä¸ªå‰¯æœ¬ï¼Œéšç€ API æœåŠ¡å™¨ä»èŠ‚æµæ•ˆåº”ä¸­æ¢å¤ï¼Œè¢«æ‹’ç»çš„è¯·æ±‚æ•°é‡å°†é€æ¸å‡å°‘:

ç¼©å°å®šåˆ¶æ§åˆ¶å™¨å‰¯æœ¬

```
sum(rate(apiserver_flowcontrol_rejected_requests_total{job="apiserver",flowSchema="restrict-pod-lister"}[15m])) by (flowSchema,reason)
```

![](img/98e5eaaef2e46d62cd1e45e16b9fb070.png)

åœ¨æ¢å¤è¿‡ç¨‹ä¸­ï¼Œè¢«æ‹’ç»çš„è¯·æ±‚æ•°é‡ä¼šå‡å°‘

# ç»“è®º

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å‘æ‚¨å±•ç¤ºäº†å¦‚ä½•åˆ›å»ºå®šåˆ¶çš„`FlowSchema`å’Œ`PriorityLevelConfiguration`èµ„æºæ¥ç®¡ç† API æœåŠ¡å™¨çš„å…¥ç«™æµé‡ã€‚æˆ‘ä»¬æ£€æŸ¥äº†è¿™äº›èµ„æºçš„è§„æ ¼ã€‚

ä½¿ç”¨è‡ªå®šä¹‰æ§åˆ¶å™¨æ¥æ¨¡æ‹Ÿåˆ° API æœåŠ¡å™¨çš„æ¶æ„æµé‡ï¼Œæˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨ä¸åŒçš„ APF æŒ‡æ ‡å’Œè°ƒè¯•ç«¯ç‚¹æ¥æ·±å…¥äº†è§£é˜Ÿåˆ—å’Œè¯·æ±‚ã€‚

æˆ‘ä»¬è¿˜ç ”ç©¶äº†è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œç”±äºé•¿æ—¶é—´çš„é˜Ÿåˆ—ç­‰å¾…ï¼Œåœ¨ API æœåŠ¡å™¨å¤„ç†å®Œæˆ‘ä»¬çš„è¯·æ±‚ä¹‹å‰ï¼Œæˆ‘ä»¬çš„å®¢æˆ·ç«¯ä¸Šä¸‹æ–‡æˆªæ­¢æ—¶é—´è¶…æ—¶äº†ã€‚

æµæ¨¡å¼æä¾›äº†å…¶ä»–é…ç½®ï¼Œä¾‹å¦‚æ‹’ç»å…¥ç«™æµé‡è€Œä¸æ˜¯å¯¹å…¶è¿›è¡Œæ’é˜Ÿï¼Œä»¥åŠé€šè¿‡åç§°ç©ºé—´è€Œä¸æ˜¯ç”¨æˆ·æ¥è°ƒèŠ‚å…¥ç«™æµé‡ï¼Œæ‰€æœ‰è¿™äº›éƒ½å°†ç•™ç»™è¯»è€…ç»ƒä¹ ã€‚