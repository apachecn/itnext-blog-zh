# Angular & RxJS:æ£€æµ‹å†…å­˜æ³„æ¼

> åŸæ–‡ï¼š<https://itnext.io/angular-rxjs-detecting-memory-leaks-bdd312a070a0?source=collection_archive---------1----------------------->

æˆ‘å·²ç»ä½¿ç”¨ RxJS æ„å»ºäº†ä¸€ä¸ªç¤ºä¾‹ Angular åº”ç”¨ç¨‹åºæ¥æ¨¡æ‹Ÿå„ç§å†…å­˜æ³„æ¼ã€‚è¿™äº›æŠ€æœ¯ä¸­çš„å¤§å¤šæ•°éƒ½é€‚ç”¨äºä»»ä½•ä½¿ç”¨ RxJS çš„åŸºäºç»„ä»¶çš„æ¡†æ¶ã€‚

[ä¸‹è½½æºä»£ç ğŸš€](https://github.com/Everduin94/memory-leaks-rxjs)

æˆ‘ä»¬å°†æ¶µç›–:

1.  æ£€æµ‹å†…å­˜æ³„æ¼çš„ç­–ç•¥
2.  å–æ¶ˆè®¢é˜…å’Œåƒåœ¾æ”¶é›†
3.  è§£å†³åŸºäºè®¢é˜…çš„å†…å­˜æ³„æ¼çš„è§£å†³æ–¹æ¡ˆ

# æ£€æµ‹å†…å­˜æ³„æ¼çš„ç­–ç•¥

åœ¨è°·æ­Œæµè§ˆå™¨ä¸­ä½¿ç”¨è°·æ­Œæµè§ˆå™¨å¼€å‘å·¥å…·ğŸ›  (Ctrl+Shift+I)

![](img/671722bcd886924201a2956703bb9734.png)

## **åˆ†é…æ—¶é—´è¡¨ğŸ“ˆ**

åˆ†é…æ—¶é—´è¡¨å…è®¸æˆ‘ä»¬æŸ¥çœ‹å †çš„æœ€å°å¤§å°æ˜¯å¦éšç€æ—¶é—´çš„æ¨ç§»è€Œå¢é•¿ã€‚åœ¨åˆ›å»ºæˆ–é”€æ¯ä»»ä½•ç»„ä»¶ä¹‹å‰ï¼Œæˆ‘ä»¬å°†ä»åŸºçº¿å¼€å§‹ã€‚

![](img/ec0cb722cecda3ee5a98fc9cf24e7b9c.png)

ç°åœ¨ï¼Œå½“æ—¶é—´çº¿è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬å°†å¤šæ¬¡åˆ›å»º/é”€æ¯ LargeLeak ç»„ä»¶ã€‚æ³¨æ„ï¼Œæˆ‘åœ¨è¿‡æ»¤å™¨ä¸­è¾“å…¥äº† largeï¼Œå› ä¸ºæˆ‘ä»¬æ­£åœ¨å¯»æ‰¾ LargeLeakComponent çš„åˆ†é…

![](img/a6642712caf963df6b051fbacd7cc17c.png)

LargeLeakComponent.ts

![](img/2b36bd24e752723819c8fe1143914761.png)

ç°åœ¨æˆ‘ä»¬å›åˆ°èµ·ç‚¹(é”€æ¯ LargeLeakComponent) â†’æ‰‹åŠ¨è¿è¡Œåƒåœ¾æ”¶é›†(å·¦ä¸Šè§’çš„ğŸ—‘åƒåœ¾æ¡¶å›¾æ ‡)â†’é‡æ–°å¯åŠ¨åˆ†é…æ—¶é—´çº¿(å·¦ä¸Šè§’çš„âš«åœˆå›¾æ ‡)ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„æœ€å°å †å¤§å°å¢åŠ äº†ï¼Œåˆ†é…æ²¡æœ‰è¢«é‡Šæ”¾ã€‚

![](img/1a2c221f4b3ef11a404963f78b18f1e1.png)

## **å †å¿«ç…§ğŸ“¸**

ä¸€æ—¦æˆ‘ä»¬ç¡®å®šäº†æ³„æ¼ï¼Œå †å¿«ç…§å°±éå¸¸æœ‰ç”¨ã€‚ä¸åŒäºåˆ†é…æ—¶é—´è¡¨ğŸŒï¼Œå½“æˆ‘ä»¬ä¸åº”ç”¨ç¨‹åºäº¤äº’æ—¶ï¼Œå †å¿«ç…§ä¸ä¼šå¯¼è‡´å»¶è¿Ÿã€‚æœ€ç»ˆï¼Œå¿«ç…§å’Œåˆ†é…æ—¶é—´è¡¨éƒ½å¯ä»¥ç”¨æ¥æ£€æµ‹æ³„æ¼ã€‚

åœ¨åº”ç”¨ç¨‹åºä¸­åšä»»ä½•äº‹æƒ…ä¹‹å‰ï¼Œæˆ‘ä»¬å°†ä»å †å¿«ç…§å¼€å§‹ã€‚è¿™å°†æ˜¯æˆ‘ä»¬çš„åŸºçº¿æˆ–èµ·ç‚¹ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å·²ç»åˆ†é…äº† 0 ä¸ª ServiceObservableLeak ç»„ä»¶ã€‚

![](img/a44f117dffc944032a5f83b3bd485558.png)

ServiceObservableLeak.ts

![](img/83720a96ac7735c30d21d2cab792d2a8.png)

å¤šæ¬¡åˆ‡æ¢åˆ›å»º/é”€æ¯åâ†’æ‰‹åŠ¨è¿è¡Œåƒåœ¾æ”¶é›†ğŸ—‘â†’å¹¶æ‹æ‘„å¦ä¸€ä¸ªâš«.å¿«ç…§æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç»„ä»¶æ²¡æœ‰é€šè¿‡åƒåœ¾æ”¶é›†æ¥é‡Šæ”¾ã€‚

![](img/0bb9e82e791351b96c1e8f762d2838dd.png)

æ³¨æ„ï¼Œåªæœç´¢ç»„ä»¶å¹¶ä¸æ€»æ˜¯æŸ¥æ‰¾å†…å­˜æ³„æ¼çš„æœ‰æ•ˆæ–¹æ³•ã€‚å¦‚æœæˆ‘ä»¬å‡è®¾å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œæˆ‘ä»¬è¿˜åº”è¯¥æ£€æŸ¥å†…å­˜ä¸­çš„è®¢é˜…è€…æ•°é‡ã€‚ğŸ”ä½¿ç”¨å¿«ç…§æ¯”è¾ƒ(ç­›é€‰å™¨æ—è¾¹çš„ä¸‹æ‹‰èœå•)ï¼Œæˆ‘ä»¬å¯ä»¥æ¯”è¾ƒä¸¤ä¸ªç‹¬ç«‹çš„å¿«ç…§ã€‚è¿™è¡¨æ˜æˆ‘ä»¬å·²ç»åˆ†é…äº† 30 ä¸ªè®¢æˆ·ï¼Œåˆ é™¤äº† 0 ä¸ªã€‚åœ¨â€œå–æ¶ˆè®¢é˜…å’Œåƒåœ¾æ”¶é›†â€ä¸­æœ‰æ›´å¤šå…³äºè¿™æ–¹é¢çš„å†…å®¹ã€‚

![](img/504198017b340bc48eadbac1b0be585d.png)

# **å–æ¶ˆè®¢é˜…å’Œåƒåœ¾æ”¶é›†**

äººä»¬ç»å¸¸æåˆ°ï¼Œè®¢é˜…æŒæœ‰å¯¹ç»„ä»¶çš„å¼•ç”¨ã€‚å› æ­¤ï¼Œç»„ä»¶ä¸èƒ½è¢«é‡Šæ”¾ï¼Œé€ æˆå†…å­˜æ³„æ¼ã€‚ä¸èƒ½é‡Šæ”¾ä»»ä½•ä¸€ä¸ªç›¸äº’å¼•ç”¨çš„å¯¹è±¡ç§°ä¸ºå¾ªç¯ã€‚[ã€1ã€‘](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Memory_Management)

å‘¨æœŸæ˜¯â€œå¼•ç”¨è®¡æ•°åƒåœ¾æ”¶é›†â€ç®—æ³•çš„ä¸€ä¸ªé™åˆ¶ã€‚ç°ä»£æµè§ˆå™¨ä½¿ç”¨â€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•ğŸ¯ã€‚æ ‡è®°å’Œæ¸…é™¤ç®—æ³•å°†ä»æ ¹(å…¨å±€å¯¹è±¡)æ”¶é›†æ‰€æœ‰ä¸å¯åˆ°è¾¾çš„å¯¹è±¡ã€‚è¿™è§£å†³äº†å¾ªç¯çš„å±€é™æ€§ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡æµ‹è¯•å±€éƒ¨æœ‰é™å¯è§‚å¯Ÿå€¼æ¥éªŒè¯åƒåœ¾æ”¶é›†å™¨å¤„ç†å‘¨æœŸçš„æƒ³æ³•ã€‚å½“æˆ‘ä»¬åˆ‡æ¢æœ¬åœ°æœ‰é™ç»„ä»¶â†’æ‰‹åŠ¨è¿è¡Œåƒåœ¾æ”¶é›†ğŸ—‘â†’æ—¶ï¼Œè·å–å †å¿«ç…§âš«.

![](img/69c8bbd8b4307ec47a3951621dd47941.png)

FiniteObservableComponent.ts

![](img/8f3844a296a649f33acfd67f36be84dd.png)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç»„ä»¶æ²¡æœ‰æ³„æ¼ï¼Œå³ä½¿æˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨è®¢é˜…ç®¡ç†ç­–ç•¥(æ¯”å¦‚å–æ¶ˆè®¢é˜…)ã€‚

> â€œæ‰€ä»¥æˆ‘å¯ä»¥è®©åƒåœ¾æ”¶é›†æ¥ç®¡ç†æˆ‘çš„è®¢é˜…ï¼Ÿâ€

**å·**

![](img/548460b0a31079ae514e787222347ebe.png)

å¦‚æœè®¢é˜…/ç»„ä»¶ä»ç„¶æœ‰ä¸€äº›å¯¹æ ¹çš„å¼•ç”¨ï¼Œå®ƒå°†ä¸ä¼šè¢«åƒåœ¾æ”¶é›†ã€‚æˆ‘ä»¬å¯ä»¥åœ¨å‰ä¸€ä¸ªç¤ºä¾‹çš„ ServiceObservableLeak ç»„ä»¶ä¸­çœ‹åˆ°è¿™ä¸€ç‚¹ã€‚å› ä¸ºæˆ‘ä»¬çš„ observable (observable$)æ˜¯åœ¨æœåŠ¡(SourceService)ä¸­åˆ†é…çš„ï¼Œæ‰€ä»¥ç»„ä»¶ä»ç„¶æœ‰ä¸€ä¸ªé€šè¿‡ observable è¿”å›åˆ°æ ¹çš„å¼•ç”¨ã€‚æˆ‘ä»¬éœ€è¦å–æ¶ˆè®¢é˜…ç»„ä»¶(ServiceObservableLeakComponent)æ‰èƒ½è¿›è¡Œåƒåœ¾æ”¶é›†ã€‚

![](img/58650bee0dbf4262eb315cac1d42e8d4.png)

ä¸ç®¡ç†è®¢é˜…æ˜¯ä¸€ç§ä¸å¥½çš„åšæ³•ï¼Œåº”è¯¥é¿å…ã€‚ä»¥ FromEvent ç»„ä»¶ä¸ºä¾‹ã€‚è¯¥ç»„ä»¶åˆå§‹åŒ–ä¸€ä¸ªæœ¬åœ°å¯è§‚å¯Ÿå¯¹è±¡ï¼Œè¯¥å¯¹è±¡åœ¨ FromEventComponent ä¸­ç›‘è§†æŒ‰é’®ä¸Šçš„ç‚¹å‡»äº‹ä»¶ã€‚

![](img/ada1fc6033fb7cac1f43af2cc59a6273.png)

FromEventComponent.ts

![](img/aaa1d3026086af8a7bbf45d9d2f1db28.png)

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œç»„ä»¶è¢«é‡Šæ”¾ï¼Œä½†æ˜¯è®¢æˆ·æ²¡æœ‰è¢«é‡Šæ”¾ã€‚æ›´å¤æ‚çš„æ˜¯ï¼Œåªæœ‰å½“ç‚¹å‡»äº‹ä»¶è‡³å°‘è¢«è§¦å‘ä¸€æ¬¡æ—¶ï¼Œè®¢é˜…è€…æ‰ä¼šæ³„æ¼ã€‚è¿™é€ æˆäº†å¾ˆéš¾è·Ÿè¸ªçš„å†…å­˜æ³„æ¼ã€‚â€”è§£å†³æ–¹æ¡ˆæ˜¯å§‹ç»ˆç®¡ç†æ‚¨çš„è®¢é˜…ã€‚

# **è§£å†³æ–¹æ¡ˆ**

![](img/b1b3f5ba4c2a76692a90f03e395cccfd.png)

æˆ‘è®¡åˆ’åœ¨ä»¥åçš„æ–‡ç« ä¸­æ›´è¯¦ç»†åœ°ä»‹ç»è¿™äº›æ–¹æ³•ã€‚ç°åœ¨ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªé«˜å±‚æ¬¡çš„æ¦‚è¿°ã€‚ğŸŒ

## å–æ¶ˆè®¢é˜…

å–æ¶ˆè®¢é˜… ngOnDestroy æ–¹æ³•ä¸­çš„æ‰€æœ‰è®¢é˜…æ˜¯ä¸€ç§æœ‰æ•ˆçš„ç­–ç•¥ã€‚è¿™ç±»ä¼¼äºå¼‚æ­¥ç®¡é“åœ¨ç»„ä»¶çº§æ‰€åšçš„äº‹æƒ…ã€‚

![](img/192638b1af7bb4eea867f77c31c3346d.png)

## å¼‚æ­¥ç®¡é“

å°†æ ¹æ®ä¸ä¹‹å…³è”çš„ DOM å…ƒç´ çš„ç”Ÿå‘½å‘¨æœŸæ¥ç®¡ç†æ‚¨çš„è®¢é˜…ã€‚æ— è®ºåœ¨å“ªé‡Œå£°æ˜ï¼Œå¼‚æ­¥ç®¡é“éƒ½å°†è¿›è¡Œæ–°çš„è®¢é˜…ã€‚ä½¿ç”¨â€œasâ€é‡å¤ä½¿ç”¨æä¾›çš„å€¼ã€‚

æˆ‘å·²ç»å†™äº†å…³äºå¼‚æ­¥ç®¡é“ä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒçš„è¯¦ç»†å†…å®¹[åœ¨è¿™é‡Œã€2ã€‘](https://medium.com/@erxk_verduin/angular-rxjs-async-pipe-deep-dive-2510b56f793a)

![](img/c0843b7805aefe7781af377857f675e0.png)

## æ‹¿

takeã€takeUntil å’Œ takeWhile éƒ½å°†æ ¹æ®æ»¡è¶³çš„æ¡ä»¶è‡ªåŠ¨ç®¡ç†è®¢é˜…ã€‚ä¾‹å¦‚ï¼ŒtakeUntil å°†ä¸€ä¸ªå¯è§‚å¯Ÿå¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå¹¶ç»´æŒä¸€ä¸ªè®¢é˜…ï¼Œç›´åˆ°è¯¥å¯è§‚å¯Ÿå¯¹è±¡å‘å‡ºä¸€ä¸ªå€¼ã€‚

![](img/6cdbf0a48f9d9b2579c1446213ed8152.png)

> â˜ï¸[flotes](https://flotes.app)â€”â€”å°è¯•æ¼”ç¤ºï¼Œä¸éœ€è¦ç™»å½•ã€‚æˆ–è€…å…è´¹æŠ¥åã€‚Flotes æ˜¯æˆ‘è®°ç¬”è®°å’Œé«˜æ•ˆå­¦ä¹ çš„æ–¹å¼ï¼Œå³ä½¿åœ¨æˆ‘å¾ˆå¿™çš„æ—¶å€™ã€‚

![](img/8e468f6e74135bbbc2ecbfce7e2db2bf.png)

[flots](https://flotes.app)

# **èµ„æº/å‚è€ƒèµ„æ–™**

*   [1]:[https://developer . Mozilla . org/en-US/docs/Web/JavaScript/Memory _ Management](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Memory_Management)
*   [2]:[https://medium . com/@ erxk _ verduin/angular-rxjs-async-pipe-deep-dive-2510 b 56 f 793 a](https://medium.com/@erxk_verduin/angular-rxjs-async-pipe-deep-dive-2510b56f793a)
*   è¯­æ³•é«˜äº®å›¾åƒç”± [https://carbon.now.sh](https://carbon.now.sh/) ç”Ÿæˆ