<html>
<head>
<title>Setup Privacy With OpenVPN Using Ansible</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ä½¿ç”¨Ansibleé€šè¿‡OpenVPNè®¾ç½®éšç§</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://itnext.io/setup-privacy-with-openvpn-using-ansible-b9e613a66f85?source=collection_archive---------3-----------------------#2019-03-28">https://itnext.io/setup-privacy-with-openvpn-using-ansible-b9e613a66f85?source=collection_archive---------3-----------------------#2019-03-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f41bdcf89066550e3b3bba5158afd15e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TvnBrQDxgf5lCnSf"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">ç…§ç‰‡ç”±<a class="ae kc" href="https://unsplash.com/@dtopkin1?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">æˆ´æ©Â·æ‰˜æ™®é‡‘</a>åœ¨<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>ä¸Šæ‹æ‘„</figcaption></figure><p id="635e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">åœ¨å½“ä»Šä¸–ç•Œï¼Œå‘˜å·¥ç»å¸¸éœ€è¦è¿œç¨‹åŠå…¬çš„çµæ´»æ€§ã€‚è¿™äº›è¿œç¨‹ä½ç½®å¯ä»¥æ˜¯å’–å•¡é¦†ã€é…’åº—å¤§å ‚æˆ–å‘˜å·¥ä½¿ç”¨å…¬å…±wifiçš„ä»»ä½•å…¶ä»–å…¬å…±åœºæ‰€ã€‚å…¬å…±wifisé€šå¸¸ä¸å®‰å…¨ï¼Œé€šè¿‡å®ƒä»¬ä¼ è¾“çš„æ•°æ®å¾ˆå®¹æ˜“è¢«é»‘å®¢çªƒå–ã€‚é˜²æ­¢å…¬å¸æ•°æ®æš´éœ²çš„æœ€ä½³é˜²å¾¡æ˜¯ä½¿ç”¨å®‰å…¨wifiï¼Œä½†è¿™å¹¶ä¸æ€»æ˜¯å¯è¡Œçš„ã€‚æ›´å®ç”¨çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨VPNï¼Œå®ƒé€šè¿‡å…¬å…±äº’è”ç½‘åœ¨å‘˜å·¥ç³»ç»Ÿå’ŒæœåŠ¡å™¨ä¹‹é—´æä¾›å®‰å…¨è¿æ¥ã€‚è¿™ç¡®ä¿äº†å®¢æˆ·ç«¯ä½¿ç”¨çš„æ•°æ®åœ¨ç½‘ç»œä¸Šå¯é åœ°ä¼ è¾“å¹¶ä¸”ä¸å¯è§ã€‚å¦ä¸€ä¸ªç”¨ä¾‹æ˜¯å½“å‘˜å·¥éœ€è¦è®¿é—®ç‰¹å®šçš„èµ„æºï¼Œè€Œè¿™äº›èµ„æºåœ¨å‘˜å·¥å±…ä½æˆ–æ—…è¡Œçš„å›½å®¶/åœ°åŒºæ˜¯ä¸å¯ç”¨çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‘˜å·¥å¯ä»¥é€šè¿‡VPNè®¿é—®æ‰€æœ‰è¿™äº›èµ„æºï¼Œå› ä¸ºæµé‡æ˜¯é€šè¿‡å®ƒè·¯ç”±çš„ï¼Œç½‘ç«™æä¾›å•†è®¤ä¸ºå®ƒæ˜¯ç”±VPNæœåŠ¡å™¨è®¿é—®çš„ã€‚</p><p id="2cd6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">å¯ç”¨VPNè®¿é—®å…¬å¸èµ„æºæœ‰åŠ©äºåŠ å¼ºæ•°æ®å®‰å…¨æ€§ï¼Œå› ä¸ºç°åœ¨æ•°æ®åœ¨å…¬å…±äº’è”ç½‘ä¸Šä¸å¯ç”¨ã€‚VPNæœ‰åŠ©äºæé«˜å¯ç®¡ç†æ€§å’Œå¯è¿½æº¯æ€§ï¼Œå› ä¸ºæ¯ä¸ªäººéƒ½é€šè¿‡è¯¥VPNæœåŠ¡å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è·Ÿè¸ªè°è®¿é—®äº†èµ„æºï¼Œè¿™æœ‰åŠ©äºéš”ç¦»å’Œè¯†åˆ«ä»»ä½•å¯ç–‘çš„æ´»åŠ¨ã€‚</p><p id="1036" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å¼€æºåŒ…<a class="ae kc" href="https://openvpn.net/" rel="noopener ugc nofollow" target="_blank"> OpenVPN </a>å»ºç«‹ä¸€ä¸ªVPNã€‚æˆ‘ä»¬å°†ä½¿ç”¨Ubuntuæ“ä½œç³»ç»Ÿè¿›è¡Œè®¾ç½®ã€‚è¿™ä¸ªè®¾ç½®éœ€è¦ä¸¤ä¸ªåŒ…OpenVPNå’Œeasy-rsaã€‚ç®€å•-rsaå…è®¸æˆ‘ä»¬åˆ›å»ºè‡ªå·±çš„<a class="ae kc" href="https://en.wikipedia.org/wiki/Certificate_authority" rel="noopener ugc nofollow" target="_blank">è®¤è¯æœºæ„</a>ï¼Œç”ŸæˆVPNæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä½¿ç”¨çš„è¯ä¹¦å’Œå¯†é’¥ã€‚è¿™æœ‰åŠ©äºæˆ‘ä»¬åŠ å¯†ã€è§£å¯†æ¶ˆæ¯ï¼ŒéªŒè¯å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä»¥æä¾›å®‰å…¨çš„é€šä¿¡ã€‚OpenVPNæœåŠ¡å™¨å…è®¸ç”¨æˆ·ä½¿ç”¨æ­£ç¡®çš„è¯ä¹¦ï¼Œè¿™æœ‰åŠ©äºç¡®ä¿é€šä¿¡å¾—åˆ°æˆæƒã€‚åœ¨å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯ä¹Ÿä½¿ç”¨è¿™äº›è¯ä¹¦å’Œå¯†é’¥éªŒè¯å®ƒæ˜¯å¦è¿æ¥åˆ°æ­£ç¡®çš„æœåŠ¡å™¨ã€‚æˆ‘ä»¬éœ€è¦æ¿€æ´»é˜²ç«å¢™æ¥é˜»æ­¢é™¤SSH (22)å’ŒVPN(1194)ä¹‹å¤–çš„æ‰€æœ‰ç«¯å£ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ufwå·¥å…·è¿›è¡Œè®¾ç½®ã€‚æˆ‘ä»¬éœ€è¦æ›´æ–°IPtableè§„åˆ™ï¼Œä»¥ä¾¿é€šè¿‡äº’è”ç½‘å¯¹VPNå®¢æˆ·ç«¯è¿›è¡ŒNATã€‚æˆ‘ä»¬è¿˜éœ€è¦é€šè¿‡åœ¨â€œsysctlâ€é…ç½®æ–‡ä»¶ä¸­æ·»åŠ net.ipv4.ip_forward=1å¹¶æ›´æ”¹ufwé…ç½®ä»¥å…è®¸è½¬å‘ç­–ç•¥æ¥å¯ç”¨æ•°æ®åŒ…è½¬å‘ã€‚</p><p id="58fd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">åœ¨æˆ‘ä»¬è¿›å…¥å®é™…è®¾ç½®ä¹‹å‰ï¼Œè®©æˆ‘ä»¬äº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯â€œ<a class="ae kc" href="https://help.ubuntu.com/community/UFW" rel="noopener ugc nofollow" target="_blank"> ufw </a>â€ã€‚ufwä»£è¡¨ç®€å•é˜²ç«å¢™ï¼Œå®ƒä¸ºç®¡ç†é˜²ç«å¢™è§„åˆ™æä¾›äº†ä¸€ä¸ªç”¨æˆ·å‹å¥½çš„æ¡†æ¶ã€‚é˜²ç«å¢™æ˜¯ä¸€ç»„ç½‘ç»œè§„åˆ™ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰è°å¯ä»¥è¿æ¥åˆ°æˆ‘ä»¬çš„æœåŠ¡å™¨ï¼Œæˆ–è€…æˆ‘ä»¬çš„æœåŠ¡å™¨å¯ä»¥ä¸è°è¿æ¥ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç®€å•çš„ufwå‘½ä»¤ç®€å•åœ°å…è®¸/ä¸å…è®¸æ‰€æœ‰ä¼ å…¥å’Œä¼ å‡ºçš„æµé‡ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯ç”¨å¯¹ç‰¹å®šç«¯å£çš„è®¿é—®:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="952d" class="lk ll iq lg b gy lm ln l lo lp">sudo ufw allow ssh</span></pre><p id="c680" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æˆ‘ä»¬å¯ä»¥åœ¨è¿è¡Œä»»ä½•ç»ˆç«¯æä¾›çš„è§„åˆ™ä¹‹å‰ï¼Œåœ¨ufwä½¿ç”¨çš„before.rulesæ–‡ä»¶ä¸­æ·»åŠ æ›´é«˜çº§çš„è§„åˆ™ã€‚è®¾ç½®è§„åˆ™åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ufwçš„çŠ¶æ€:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="8ec2" class="lk ll iq lg b gy lm ln l lo lp">sudo ufw status</span></pre><p id="365d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">å¦‚æœæˆ‘ä»¬å‘ç°ufwè¢«ç¦ç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯ç”¨å®ƒ:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="979e" class="lk ll iq lg b gy lm ln l lo lp">sudo ufw enable</span></pre><p id="e066" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">è®©æˆ‘ä»¬ä»ä½¿ç”¨ansibleè®¾ç½®VPNæœåŠ¡å™¨å¼€å§‹ã€‚ä½œä¸ºç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ–°æˆ‘ä»¬çš„åº“ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä¸‹è½½å’Œå®‰è£…æœ€æ–°çš„åŒ…ã€‚æˆ‘ä»¬éœ€è¦å®‰è£…OpenVPNå’Œeasy-rsaåŒ…ã€‚</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="159e" class="lk ll iq lg b gy lm ln l lo lp">- name: Update apt packages<br/>  become: true<br/>  apt:<br/>    upgrade: yes</span><span id="b6f5" class="lk ll iq lg b gy lq ln l lo lp">- name: Install openvpn<br/>  package:<br/>   name: "{{ item }}"<br/>   state: present<br/>  with_items:<br/>    - openvpn<br/>    - easy-rsa</span></pre><p id="ca17" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„è‡ªå®šä¹‰è¯ä¹¦é¢å‘æœºæ„ï¼Œè¿™å°†æœ‰åŠ©äºç”ŸæˆæœåŠ¡å™¨è¯ä¹¦å’Œå¯†é’¥å¯¹ä»¥åŠDiffie-Hellmanå‚æ•°å’Œtls-authå¯†é’¥ã€‚æˆ‘ä»¬åˆ›å»ºCAç›®å½•ï¼Œæ‰€æœ‰çš„è¯ä¹¦/å¯†é’¥éƒ½åœ¨è¿™ä¸ªç›®å½•ä¸­ç”Ÿæˆã€‚</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="9a61" class="lk ll iq lg b gy lm ln l lo lp">- name: "Remove CA directory"<br/>  become: yes<br/>  file:<br/>    state: absent<br/>    path: "{{ ansible_env.HOME }}/openvpn-ca/"</span><span id="16f8" class="lk ll iq lg b gy lq ln l lo lp">- name: "Create CA dir"<br/>  become: yes<br/>  command: make-cadir {{ ansible_env.HOME }}/openvpn-ca</span></pre><p id="e92f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æˆ‘ä»¬éœ€è¦è®¾ç½®å˜é‡ï¼Œè¿™äº›å˜é‡å°†ç”¨äºè®¾ç½®åœ¨CAåˆ›å»ºå’Œç”Ÿæˆè¯ä¹¦å’Œå¯†é’¥æœŸé—´ä½¿ç”¨çš„å€¼ã€‚</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="7500" class="lk ll iq lg b gy lm ln l lo lp">- name: Customize CA variable configuration<br/>  lineinfile:<br/>    dest: "{{ ansible_env.HOME }}/openvpn-ca/vars"<br/>    regexp: "^{{ item.property | regex_escape() }}="<br/>    line: "{{ item.property }}={{ item.value }}"<br/>  with_items:<br/>    - { property: 'export KEY_NAME', value: '"server"' }<br/>    - { property: 'export KEY_COUNTRY', value: '"US"' }<br/>    - { property: 'export KEY_PROVINCE', value: '"CA"' }<br/>    - { property: 'export KEY_CITY', value: '"SF"' }<br/>    - { property: 'export KEY_ORG', value: '"MT"' }<br/>    - { property: 'export KEY_EMAIL', value: '"<a class="ae kc" href="mailto:mt@mt.com" rel="noopener ugc nofollow" target="_blank">mt@mt.com</a>"' }<br/>    - { property: 'export KEY_OU', value: '"MT"' }<br/>    - { property: 'export KEY_CONFIG', value: '{{ ansible_env.HOME }}/openvpn-ca/openssl-1.0.0.cnf' }<br/>    - { property: 'export KEY_DIR', value: '{{ ansible_env.HOME }}/openvpn-ca/keys' }</span></pre><p id="abc4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ç°åœ¨è®©æˆ‘ä»¬ä½¿ç”¨CAç›®å½•ä¸­æä¾›çš„è„šæœ¬æ¥æ„å»ºæˆ‘ä»¬çš„è®¤è¯æœºæ„ã€‚</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="c7e8" class="lk ll iq lg b gy lm ln l lo lp">- name: "Build the certificate authority"<br/>  become: yes<br/>  shell: &gt;<br/>    source vars;<br/>    ./clean-all;<br/>    yes "" | ./build-ca;<br/>  args: <br/>    chdir: "{{ ansible_env.HOME }}/openvpn-ca/"<br/>    executable: /bin/bash</span></pre><p id="5e25" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ä¸‹ä¸€æ­¥æ˜¯ä¸ºæœåŠ¡å™¨ç”Ÿæˆè¯ä¹¦ã€‚æˆ‘ä»¬åˆ›å»ºäº†<a class="ae kc" href="https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange" rel="noopener ugc nofollow" target="_blank"> Diffie-Hellman </a>å‚æ•°ï¼Œè¿™äº›å‚æ•°ç”¨äºä½¿ç”¨å…¬å…±å’Œä¸å®‰å…¨çš„é€šé“äº¤æ¢å¯†é’¥ã€‚ä¸ºäº†å¢åŠ è¯ä¹¦çš„å®‰å…¨æ€§ï¼Œæˆ‘ä»¬å°†ç”Ÿæˆä¸€ä¸ªå¯†é’¥æ¥ä½¿ç”¨å…±äº«ç§˜å¯†ã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯åœ¨keysæ–‡ä»¶å¤¹ä¸­ç”Ÿæˆçš„ã€‚æˆ‘ä»¬éœ€è¦å°†å®ƒä»¬ç§»åŠ¨åˆ°OpenVPNæ–‡ä»¶å¤¹ä¸­ï¼Œå¹¶åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å‘å®ƒä»¬ã€‚</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="7942" class="lk ll iq lg b gy lm ln l lo lp">- name: "Build server certificate"<br/>  become: yes<br/>  shell: &gt;<br/>    source vars;<br/>    ./build-key-server --batch server;<br/>  args: <br/>    chdir: "{{ ansible_env.HOME }}/openvpn-ca/"<br/>    executable: /bin/bash</span><span id="07c2" class="lk ll iq lg b gy lq ln l lo lp">- name: "Build Diffie-Hellman parameters and key generation"<br/>  become: yes<br/>  shell: &gt;<br/>    source vars;<br/>    yes "" | ./build-dh;<br/>    openvpn --genkey --secret keys/ta.key;<br/>  args: <br/>    chdir: "{{ ansible_env.HOME }}/openvpn-ca/"<br/>    executable: /bin/bash</span><span id="335a" class="lk ll iq lg b gy lq ln l lo lp">- name: "Copy key and certificates to /etc/openvpn"<br/>  become: yes<br/>  copy:<br/>    remote_src: yes<br/>    src: "{{ ansible_env.HOME }}/openvpn-ca/keys/{{ item }}"<br/>    dest: "/etc/openvpn/"<br/>  with_items:<br/>    - "ca.crt"<br/>    - "server.crt"<br/>    - "server.key"<br/>    - "ta.key"<br/>    - "dh2048.pem"</span></pre><p id="fbd2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æˆ‘ä»¬å°†å¤åˆ¶ç¤ºä¾‹é…ç½®æ–‡ä»¶ä½œä¸ºæˆ‘ä»¬çš„OpenVPNé…ç½®æ–‡ä»¶ã€‚åœ¨æ­¤é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œå¿…è¦çš„æ›´æ”¹ï¼Œä»¥æŒ‡å‘æ­£ç¡®çš„è¯ä¹¦ã€ç”¨æˆ·/ç»„å’ŒDHCPé…ç½®ã€‚</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="90eb" class="lk ll iq lg b gy lm ln l lo lp">- name: "Generate server.conf from sample config"<br/>  become: yes<br/>  shell: &gt;<br/>     gzip -d -c /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz | sudo tee /etc/openvpn/server.conf &gt; /dev/null<br/>- name: Adjust OpenVPN server configuration<br/>  lineinfile:<br/>    dest: "/etc/openvpn/server.conf"<br/>    regexp: "^{{ item.regex | regex_escape() }}"<br/>    line: "{{ item.value }}"<br/>  with_items:<br/>    - { regex: ';user nobody', value: 'user nobody' }<br/>    - { regex: ';group nogroup', value: 'group nogroup' }<br/>    - { regex: ';push "redirect-gateway def1 bypass-dhcp"', value: 'push "redirect-gateway def1 bypass-dhcp"' }<br/>    - { regex: 'cert server.crt', value: 'cert server.crt' }<br/>    - { regex: 'key server.key', value: 'key server.key' }</span></pre><p id="a51f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æˆ‘ä»¬å°†ä½¿ç”¨ufwå¯ç”¨é˜²ç«å¢™ï¼Œå…è®¸VPNå’ŒSSHç«¯å£ã€‚æ›´æ–°è·¯ç”±è§„åˆ™ï¼Œå¯ç”¨IPè½¬å‘å¹¶æ¥å—è½¬å‘ç­–ç•¥ã€‚</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="597d" class="lk ll iq lg b gy lm ln l lo lp">- name: Configuration IP forwarding<br/>  become: true<br/>  sysctl:<br/>    name: net.ipv4.ip_forward<br/>    value: 1<br/>    state: present</span><span id="36c1" class="lk ll iq lg b gy lq ln l lo lp">- name: Add ufw before content<br/>  become: true<br/>  blockinfile:<br/>    path: /etc/ufw/before.rules<br/>    insertbefore: BOF<br/>    content: |<br/>      # NAT table rules<br/>      *nat<br/>      :POSTROUTING ACCEPT [0:0]<br/>      -A POSTROUTING -s 10.8.0.0/8 -o eth0 -j MASQUERADE<br/>      COMMIT<br/>- name: Customize ufw forwarding policy<br/>  become: true<br/>  lineinfile:<br/>    line: "DEFAULT_FORWARD_POLICY=\"ACCEPT\""<br/>    path: "/etc/default/ufw"<br/>    regexp: "^DEFAULT_FORWARD_POLICY=\"DROP\""</span><span id="b463" class="lk ll iq lg b gy lq ln l lo lp">- name: Open ufw ports for openvpn and ssh<br/>  become: true<br/>  shell:  ufw allow openvpn &amp;&amp; ufw allow OpenSSH</span><span id="25b5" class="lk ll iq lg b gy lq ln l lo lp">- name: Enable ufw<br/>  become: true<br/>  shell: ufw --force enable</span></pre><p id="5dd9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">å®Œæˆæ‰€æœ‰å·¥ä½œåï¼Œæˆ‘ä»¬å°†é‡å¯OpenVPNæœåŠ¡å™¨ä»¥ä½¿æ‰€æœ‰æ›´æ–°çš„æ›´æ”¹ç”Ÿæ•ˆã€‚è¿™æ ·ï¼Œæˆ‘ä»¬çš„OpenVPNæœåŠ¡å™¨å°±å¯åŠ¨å¹¶è¿è¡Œäº†ã€‚</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="c701" class="lk ll iq lg b gy lm ln l lo lp">- name: Start openvpn systemd service<br/>  become: true<br/>  systemd:<br/>    name: openvpn@server<br/>    state: started<br/>    daemon_reload: yes<br/>    enabled: yes</span></pre><p id="61fd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ç”±äºæˆ‘ä»¬å·²ç»å‡†å¤‡å¥½äº†æœåŠ¡å™¨ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºå®¢æˆ·ç«¯é…ç½®ï¼Œå®ƒå¯ä»¥ç”¨æ¥è¿æ¥åˆ°æˆ‘ä»¬çš„VPNæœåŠ¡å™¨å¹¶é€šè¿‡å®ƒé‡å®šå‘æµé‡ã€‚æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå¯ä»¥è¢«ä»»ä½•OpenVPNå®¢æˆ·ç«¯å·¥å…·ä½¿ç”¨çš„â€œovpnâ€æ–‡ä»¶ã€‚ä½œä¸ºç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦ç”Ÿæˆä¸€ä¸ªè¯ä¹¦/å¯†é’¥å¯¹ã€‚</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="b34a" class="lk ll iq lg b gy lm ln l lo lp">- name: "Generate client certificate key"<br/>  become: yes<br/>  shell: source vars; ./build-key --batch {{client_name}}<br/>  args: <br/>    chdir: "{{ ansible_env.HOME }}/openvpn-ca/"<br/>    executable: /bin/bash</span><span id="b257" class="lk ll iq lg b gy lq ln l lo lp">- name: "Create client certificate configs dir"<br/>  become: yes<br/>  file: <br/>    owner: "{{ ansible_env.USER }}"<br/>    group: "{{ ansible_env.USER }}"<br/>    path: "{{ ansible_env.HOME }}/openvpn-ca/{{client_name}}"<br/>    state: directory<br/>    mode: 0700</span></pre><p id="b0fd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æˆ‘ä»¬å°†å¤åˆ¶ä¸€ä¸ªç¤ºä¾‹å®¢æˆ·ç«¯é…ç½®æ–‡ä»¶ï¼Œç„¶åæˆ‘ä»¬å°†ä¿®æ”¹è¯¥æ–‡ä»¶ä»¥æ›´æ–°é…ç½®å‚æ•°ï¼Œå¦‚æœåŠ¡å™¨IPåœ°å€ã€å®¢æˆ·ç«¯è¯ä¹¦ã€å®¢æˆ·ç«¯å¯†é’¥ã€taå¯†é’¥ï¼Œä»è€Œä½¿ç”¨å…±äº«å¯†é’¥è¿›è¡Œå…¶ä»–æ‰€éœ€çš„æ›´æ”¹ã€‚</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="5123" class="lk ll iq lg b gy lm ln l lo lp">- name: "Copy client sample configs from remote host itself"<br/>  become: yes<br/>  copy:<br/>      remote_src: yes<br/>      src: /usr/share/doc/openvpn/examples/sample-config-files/client.conf<br/>      dest: "{{ ansible_env.HOME }}/openvpn-ca/{{client_name}}/{{client_name}}.ovpn"</span><span id="692b" class="lk ll iq lg b gy lq ln l lo lp">- name: Set the server ip and port<br/>  lineinfile:<br/>    dest: "{{ ansible_env.HOME }}/openvpn-ca/{{client_name}}/{{client_name}}.ovpn"<br/>    regexp: "^{{ item.regex | regex_escape() }}"<br/>    line: "{{ item.value }}"<br/>  with_items:<br/>    - { regex: 'remote my-server-1 1194', value: 'remote {{ groups["openVPN"][0] }} 1194' }<br/>    - { regex: ';user nobody', value: 'user nobody' }<br/>    - { regex: ';group nogroup', value: 'group nogroup' }<br/>    - { regex: 'ca ca.crt', value: '#ca ca.crt' }<br/>    - { regex: 'cert client.crt', value: '#cert client.crt' }<br/>    - { regex: 'key client.key', value: '#key client.key' }<br/>    - { regex: 'tls-auth ta.key 1', value: '#tls-auth ta.key 1' }</span><span id="69ff" class="lk ll iq lg b gy lq ln l lo lp">- name: "Create client ovpn file"<br/>  become: yes<br/>  shell: "{{ item }}"<br/>  with_items:<br/>    - echo -e '&lt;ca&gt;' &gt;&gt; {{ ansible_env.HOME }}/openvpn-ca/{{client_name}}/{{client_name}}.ovpn<br/>    - cat {{ ansible_env.HOME }}/openvpn-ca/keys/ca.crt &gt;&gt; {{ ansible_env.HOME }}/openvpn-ca/{{client_name}}/{{client_name}}.ovpn<br/>    - echo -e '&lt;/ca&gt;\n&lt;cert&gt;' &gt;&gt; {{ ansible_env.HOME }}/openvpn-ca/{{client_name}}/{{client_name}}.ovpn<br/>    - cat {{ ansible_env.HOME }}/openvpn-ca/keys/{{client_name}}.crt &gt;&gt; {{ ansible_env.HOME }}/openvpn-ca/{{client_name}}/{{client_name}}.ovpn<br/>    - echo -e '&lt;/cert&gt;\n&lt;key&gt;' &gt;&gt; {{ ansible_env.HOME }}/openvpn-ca/{{client_name}}/{{client_name}}.ovpn<br/>    - cat {{ ansible_env.HOME }}/openvpn-ca/keys/{{client_name}}.key &gt;&gt; {{ ansible_env.HOME }}/openvpn-ca/{{client_name}}/{{client_name}}.ovpn<br/>    - echo -e '&lt;/key&gt;\n&lt;tls-auth&gt;' &gt;&gt; {{ ansible_env.HOME }}/openvpn-ca/{{client_name}}/{{client_name}}.ovpn<br/>    - cat {{ ansible_env.HOME }}/openvpn-ca/keys/ta.key &gt;&gt; {{ ansible_env.HOME }}/openvpn-ca/{{client_name}}/{{client_name}}.ovpn<br/>    - echo -e '&lt;/tls-auth&gt;' &gt;&gt; {{ ansible_env.HOME }}/openvpn-ca/{{client_name}}/{{client_name}}.ovpn<br/>    - echo -e 'key-direction 1' &gt;&gt; {{ ansible_env.HOME }}/openvpn-ca/{{client_name}}/{{client_name}}.ovpn<br/>  args:<br/>    chdir: "{{ ansible_env.HOME }}/openvpn-ca/"<br/>    executable: /bin/bash</span></pre><p id="1136" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ä¸€æ—¦ä¸€åˆ‡å®Œæˆï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†â€œovpnâ€æ–‡ä»¶æå–åˆ°æœ¬åœ°å®ä¾‹ï¼Œå¹¶ä¸å®¢æˆ·ç«¯å…±äº«ï¼Œè¿™æ ·ä»–ä»¬å°±å¯ä»¥ä½¿ç”¨å®ƒæ¥è¿æ¥æˆ‘ä»¬çš„vpnæœåŠ¡å™¨ã€‚</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="dd8f" class="lk ll iq lg b gy lm ln l lo lp">- name: Fetch client configurations<br/>  fetch:<br/>    src: "{{ ansible_env.HOME }}/openvpn-ca/{{client_name}}/{{ item|basename }}"<br/>    dest: "{{ destination_key }}/"<br/>    flat: yes<br/>  with_items:<br/>    - "{{client_name}}.ovpn"</span></pre><p id="25f3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æˆ‘ä»¬å¯ä»¥åœ¨ä»»ä½•VPNå®¢æˆ·ç«¯ä¸Šä½¿ç”¨è¿™ä¸ªæ–‡ä»¶æ¥è¿æ¥VPNæœåŠ¡å™¨ã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯macï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨<a class="ae kc" href="https://tunnelblick.net/" rel="noopener ugc nofollow" target="_blank"> Tunnelblick </a>ï¼Œè¿™æ˜¯ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„VPNå®¢æˆ·ç«¯ã€‚</p><p id="6d91" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">å®Œæ•´çš„ä»£ç å¯ä»¥åœ¨è¿™ä¸ªgitèµ„æºåº“ä¸­æ‰¾åˆ°:ã€https://github.com/MiteshSharma/OpenVPNAnsible<a class="ae kc" href="https://github.com/MiteshSharma/OpenVPNAnsible" rel="noopener ugc nofollow" target="_blank"/></p><p id="f64e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> <em class="lr"> PS:å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·é¼“æŒæ”¯æŒ</em> </strong>ğŸ‘<strong class="kf ir"> <em class="lr">ã€‚æ¬¢å‘¼</em> </strong></p></div></div>    
</body>
</html>