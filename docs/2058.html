<html>
<head>
<title>Shift your CI scripts to docker build</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">å°†æ‚¨çš„CIè„šæœ¬è½¬ç§»åˆ°docker build</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://itnext.io/shift-your-ci-scripts-to-docker-build-92453bca9f75?source=collection_archive---------0-----------------------#2019-03-25">https://itnext.io/shift-your-ci-scripts-to-docker-build-92453bca9f75?source=collection_archive---------0-----------------------#2019-03-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/dfa62b3c297750bdee4b3a2e7c341a41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6VMsQZnhnpMP8asKqZ26zw.png"/></div></div></figure><p id="0a10" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">å…¸å‹åœºæ™¯:æ‚¨çš„å›¢é˜Ÿç»´æŠ¤å‡ åä¸ªJenkinsfile/ã€‚gitlab-ci.yml/whatever,æ¯ä¸€ä¸ªé¡¹ç›®éƒ½æœ‰å…¶ç‰¹å®šçš„éœ€æ±‚ã€‚æ‚¨å·²ç»å°è¯•ä»ä¸€ä¸ªrepoåˆ°å¦ä¸€ä¸ªrepoé‡ç”¨è¿™äº›æŒç»­é›†æˆè„šæœ¬ã€‚ä½†æ˜¯è¿™å¾ˆéš¾ï¼Œå› ä¸ºæ¯ä¸ªé¡¹ç›®éƒ½æœ‰è‡ªå·±çš„æŠ€æœ¯æ ˆã€ç‰ˆæœ¬ã€å¯¹å…¶ä»–å·¥å…·çš„ä¾èµ–æ€§ç­‰ç­‰ã€‚</p><p id="1a0b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">è¿˜æœ‰ï¼Œæ‚¨æ¢¦æƒ³èƒ½å¤Ÿåœ¨æœ¬åœ°æµ‹è¯•æ‚¨çš„CIç®¡é“ï¼Œè€Œä¸æ˜¯åœ¨CIæœåŠ¡å™¨ä¸­è°ƒè¯•ã€‚</p><p id="fa88" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æˆ‘è¯´çš„å¯¹å—ï¼Ÿç„¶åï¼Œ<a class="ae kw" href="https://docs.docker.com/develop/develop-images/multistage-build/" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir">å¤šçº§ç å¤´å·¥æ‰“é€ </strong> </a>éƒ½æ˜¯å†²ç€ä½ æ¥çš„ã€‚</p><p id="b4ac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">è¿™ç§æŠ€æœ¯å·²ç»å­˜åœ¨å¾ˆå¤šå¹´äº†ï¼Œä½†æ˜¯ç”¨æˆ·é€šå¸¸æ²¡æœ‰æ„è¯†åˆ°å®ƒçš„å…¨éƒ¨æ½œåŠ›ã€‚</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="b47c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æƒ³æ³•å¾ˆç®€å•:<strong class="ka ir">å°†å¤šä¸ªDockerfileæ–‡ä»¶åˆå¹¶åˆ°åŒä¸€ä¸ªDockerfileæ–‡ä»¶</strong>ã€‚åœ¨æ„å»ºè¿‡ç¨‹ä¸­ï¼Œä»–ä»¬æ¯ä¸ªäººéƒ½å¯ä»¥æ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚</p><p id="b960" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ã€‚æˆ‘å·²ç»åŒ…å«äº†ä¸€äº›é¢å¤–çš„å¤æ‚æ€§æ¥æ¼”ç¤ºé«˜çº§æ¦‚å¿µï¼Œä½†æ˜¯åˆ°ç›®å‰ä¸ºæ­¢ï¼Œè¿˜æ˜¯æŠŠé‡ç‚¹æ”¾åœ¨æœ¬è´¨ä¸Šã€‚è¯·å‚è€ƒ<a class="ae kw" href="https://docs.docker.com/develop/develop-images/multistage-build/" rel="noopener ugc nofollow" target="_blank">å®˜æ–¹æ–‡ä»¶</a>äº†è§£kickstartã€‚è¿™ä¸ªèŒä½çš„ç‰¹ç‚¹æ˜¯å±•ç¤ºç«äº‰æƒ…æŠ¥çš„èƒ½åŠ›ã€‚</p><p id="3b5d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ç¬¬ä¸€é˜¶æ®µè¿›è¡Œå£°çº³æµ‹è¯•:</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="07d1" class="ln lo iq lj b gy lp lq l lr ls">FROM newtmitch/sonar-scanner AS sonar<br/>COPY src src<br/>RUN sonar-scanner</span></pre><p id="293e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ä¸‹ä¸€é˜¶æ®µæ˜¯å®‰è£…ä¾èµ–é¡¹å¹¶æ„å»ºåº”ç”¨ç¨‹åº:</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="09f3" class="ln lo iq lj b gy lp lq l lr ls">FROM node:11 AS build<br/>WORKDIR /usr/src/app<br/>COPY . .<br/>RUN yarn install \<br/> yarn run lint \<br/> yarn run build \<br/> yarn run generate-docs<br/>LABEL stage=build</span></pre><p id="9d09" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ä¸‹ä¸€ä¸ªï¼Œå•å…ƒæµ‹è¯•:</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="75ce" class="ln lo iq lj b gy lp lq l lr ls">FROM build AS unit-tests<br/>RUN yarn run unit-tests<br/>LABEL stage=unit-tests</span></pre><p id="152e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ç¬¬ä¸‰ï¼ŒæŠŠæ–‡ä»¶æ¨ç»™S3:</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="64ac" class="ln lo iq lj b gy lp lq l lr ls">FROM containerlabs/aws-sdk AS push-docs<br/>ARG push-docs=false<br/>COPY --from=build docs docs<br/>RUN [[ "$push-docs" == true ]] &amp;&amp; aws s3 cp -r docs s3://my-docs-bucket/</span></pre><p id="ce5c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æœ€åï¼Œæœ€åä¸€ä¸ªé˜¶æ®µæ˜¯å”¯ä¸€ä¸€ä¸ªå°†åæ˜ åœ¨ç»“æœå›¾åƒä¸­çš„é˜¶æ®µã€‚å®ƒä½¿ç”¨è¾ƒå°çš„åŸºç¡€å›¾åƒï¼Œå¹¶ä¸”åªæœ‰æ‰€éœ€çš„ä¼ªåƒ:</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="7fca" class="ln lo iq lj b gy lp lq l lr ls">FROM node:11-slim<br/>EXPOSE 8080<br/>WORKDIR /usr/src/app<br/>COPY --from=build /usr/src/app/node_modules node_modules<br/>COPY --from=build /usr/src/app/dist dist<br/>USER node<br/>CMD ["node", "./dist/server/index.js"]</span></pre><p id="9514" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Jenkinsæ–‡ä»¶å˜å¾—ç®€å•å¤šäº†(Kubernetesä¸ŠJenkinsçš„ä¾‹å­):</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="4614" class="ln lo iq lj b gy lp lq l lr ls">#!/usr/bin/env groovy</span><span id="43cb" class="ln lo iq lj b gy lt lq l lr ls">podTemplate(label: "example", name: "example", <br/>  containers: [<br/>    containerTemplate(name: 'dind', <br/>privileged: true, image: 'docker:18.06-dind', command: 'dockerd-entrypoint.sh'),<br/>    containerTemplate(name: 'docker', image: 'docker:18.06', command: 'cat', ttyEnabled: true)<br/>  ],<br/>  envVars: [<br/>          envVar(key: 'DOCKER_HOST', value: 'tcp://localhost:2375')<br/>  ]<br/>){</span><span id="8943" class="ln lo iq lj b gy lt lq l lr ls">node('example'){</span><span id="75c9" class="ln lo iq lj b gy lt lq l lr ls">container('docker'){</span><span id="b35d" class="ln lo iq lj b gy lt lq l lr ls">stage('checkout'){<br/>        checkout scm<br/>      }</span><span id="41bd" class="ln lo iq lj b gy lt lq l lr ls">stage('Docker build + push'){<br/>        sh """#!/bin/bash<br/>          docker build -t test --build-arg push-docs=true .<br/>          docker push test<br/>        """<br/>      }</span><span id="e870" class="ln lo iq lj b gy lt lq l lr ls">stage('deploy'){<br/>        .......<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="9c62" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">å®ƒå¯ä»¥ç”¨äºå‡ ä¹æ¯ä¸ªé¡¹ç›®ï¼</p><p id="4f2d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ä¸»è¦ä¼˜åŠ¿:</p><ul class=""><li id="d1c5" class="lu lv iq ka b kb kc kf kg kj lw kn lx kr ly kv lz ma mb mc bi translated">å®ƒå¯ä»¥ä»ä¸€ä¸ªCIç³»ç»Ÿé‡ç”¨åˆ°å¦ä¸€ä¸ªCIç³»ç»Ÿ(ä¾‹å¦‚ï¼Œä»Jenkinsè¿ç§»åˆ°GitHub actions)ã€‚è¿™å¯¹å¼€æºé¡¹ç›®æ¥è¯´å°¤å…¶æ–¹ä¾¿ã€‚</li><li id="8db8" class="lu lv iq ka b kb md kf me kj mf kn mg kr mh kv lz ma mb mc bi translated">ä½ å¯ä»¥é€šè¿‡åœ¨æœ¬åœ°è¿è¡Œdocker buildæ¥æµ‹è¯•å®ƒã€‚</li><li id="29f5" class="lu lv iq ka b kb md kf me kj mf kn mg kr mh kv lz ma mb mc bi translated">ä¸æ„å»ºå’Œæµ‹è¯•æºä»£ç ç›¸å…³çš„ä¸€åˆ‡éƒ½åœ¨dockeræ–‡ä»¶ä¸­ã€‚å› æ­¤ï¼ŒCIè„šæœ¬ä¿æŒäº†å¯¹æºä»£ç çš„æŠ½è±¡ã€‚</li><li id="221c" class="lu lv iq ka b kb md kf me kj mf kn mg kr mh kv lz ma mb mc bi translated">äººä¸ºé”™è¯¯çš„ç©ºé—´æ›´å°:æ¯ä¸€æ­¥éƒ½ä¸å¯é¿å…åœ°åœ¨æ— ç‰¹æƒçš„dockerå®¹å™¨ä¸­æ‰§è¡Œã€‚ä½ ç”šè‡³å¯ä»¥é€šè¿‡ä½¿ç”¨åƒ<a class="ae kw" href="https://github.com/GoogleContainerTools/kaniko" rel="noopener ugc nofollow" target="_blank"> Kaniko </a>è¿™æ ·çš„å·¥å…·æ¥é¿å…dockerå®ˆæŠ¤è¿›ç¨‹ã€‚</li></ul><p id="ffb9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æ€»çš„æ¥è¯´ï¼Œç‰¹å®šäºé¡¹ç›®çš„ä¸€åˆ‡éƒ½æ˜¯è‡ªåŒ…å«çš„ï¼ŒCIè„šæœ¬å¯ä»¥ä»ä¸€ä¸ªå­˜å‚¨åº“é‡ç”¨åˆ°å¦ä¸€ä¸ªå­˜å‚¨åº“ï¼Œä»è€Œä½¿åŸºç¡€è®¾æ–½æ›´ç®€å•ã€æ›´ä¾¿å®œã€æ›´æ˜“äºç»´æŠ¤ã€‚ç»™å®ƒä¸€ä¸ªæœºä¼šï¼Œå°†å°½å¯èƒ½å¤šçš„å·¥ä½œè´Ÿè½½è½¬ç§»åˆ°Dockerfileæ–‡ä»¶ä¸­ï¼</p><h1 id="5442" class="mi lo iq bd mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne bi translated">é¢å¤–æç¤º</h1><p id="9711" class="pw-post-body-paragraph jy jz iq ka b kb nf kd ke kf ng kh ki kj nh kl km kn ni kp kq kr nj kt ku kv ij bi translated">æœ‰ä¸€äº›è­¦å‘Šï¼Œä½†è¿™äº›éƒ½å¾ˆå®¹æ˜“å…‹æœã€‚æˆ‘å°†å‘Šè¯‰ä½ å…¶ä¸­çš„ä¸¤ä¸ª:</p><p id="ecb9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">æŒ‰éœ€è·³è¿‡ç‰¹å®šæ­¥éª¤</strong></p><p id="5157" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ä¾‹å¦‚ï¼Œæˆ‘åœ¨S3ä¸ŠåŒ…å«äº†ä¸€ä¸ªå°†ç”Ÿæˆçš„æ–‡æ¡£æ¨åˆ°æ¡¶ä¸­çš„é˜¶æ®µã€‚åªæœ‰åœ¨æˆ‘çš„CIç³»ç»Ÿä¸­æ‰§è¡Œæ„å»ºæ—¶ï¼Œè¿™æ‰æ˜¯æœ‰ç”¨çš„ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘æä¾›å‡­è¯æ¥å†™å…¥è¿™ä¸ªbucketã€‚</p><p id="92fe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ä¸ºæ­¤ï¼Œæˆ‘ç”¨ARGå‘½ä»¤è®¾ç½®äº†ä¸€ä¸ªbuildå‚æ•°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒæ˜¯å‡çš„ï¼Œä½†æ˜¯åœ¨æˆ‘çš„CIæœåŠ¡å™¨ä¸­ï¼Œæˆ‘è¿è¡Œ<code class="fe nk nl nm lj b">docker build --build-arg push-docs=true</code>ï¼Œç„¶åå‘½ä»¤<code class="fe nk nl nm lj b">aws s3 cp</code>è¢«æ‰§è¡Œã€‚</p><p id="7533" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">å¯¼å‡ºæµ‹è¯•æŠ¥å‘Šæˆ–ä»»ä½•å…¶ä»–å·¥ä»¶</strong></p><p id="b754" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">åœ¨docker buildä¸­æ‰§è¡Œæ‰€æœ‰æ“ä½œçš„æœ€é‡è¦çš„è­¦å‘Šæ˜¯å·¥ä»¶ä¼šä¿ç•™åœ¨ä¸­é—´dockeræ˜ åƒä¸­ã€‚ä¾‹å¦‚ï¼Œå¯¹æˆ‘æ¥è¯´ï¼Œå°†æµ‹è¯•ç»“æœæ”¾åœ¨Jenkinså·¥ä½œåŒºæ¥ç”Ÿæˆç»Ÿè®¡æ•°æ®æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚</p><p id="e068" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ç”¨æ ‡ç­¾å¾ˆå®¹æ˜“ä»ä»»ä½•ä¸­é—´é˜¶æ®µæ‹¿èµ°ä»»ä½•ç¥å™¨ã€‚</p><p id="9436" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æˆ‘æŠŠç¬¬äºŒé˜¶æ®µæ ‡ä¸º<code class="fe nk nl nm lj b">stage=test</code>ã€‚æ‰€ä»¥åœ¨dockeræ„å»ºä¹‹åï¼Œæˆ‘å¯ä»¥è¿è¡Œä¸€ä¸ªå°è„šæœ¬æ¥è·å¾—æ–‡ä»¶test-results.xml</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="a26e" class="ln lo iq lj b gy lp lq l lr ls">docker cp $(docker create â€” name temp $(docker image ls â€” filter label=stage=test -q | head -n 1)):/usr/src/app/tests-results.xml .; docker rm temp</span></pre><p id="02a7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">å®ƒä½¿ç”¨<code class="fe nk nl nm lj b">docker image ls</code>æ¥è·å¾—è¿™ä¸ªé˜¶æ®µçš„å›¾åƒçš„IDå’Œ<code class="fe nk nl nm lj b">docker cp</code>æ¥å¤åˆ¶æ–‡ä»¶ã€‚</p><p id="3281" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ä¸€ä¸ªæ›´å¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨æ›´å¤šçš„æ ‡ç­¾ä»å…¶ä»–ç±»ä¼¼çš„æ„å»ºä¸­ç­›é€‰å‡ºæ‚¨çš„ç‰¹å®šæ„å»ºã€‚</p><p id="51c9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æ‚¨å·²ç»åˆ°è¾¾ç»ˆç‚¹ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯æœ€åçš„å»ºè®®:ä½¿ç”¨<a class="ae kw" href="https://docs.docker.com/develop/develop-images/build_enhancements/" rel="noopener ugc nofollow" target="_blank"> BuildKit </a>ã€‚ğŸ˜‰</p><p id="68ed" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://ignaciomillan.com" rel="noopener ugc nofollow" target="_blank">ignaciomillan.com</a></p></div></div>    
</body>
</html>