# è®¾ç½® AdonisJs websockets(å¸¦ React åº”ç”¨ç¨‹åºæ¼”ç¤º)

> åŸæ–‡ï¼š<https://itnext.io/setting-up-adonisjs-websockets-with-react-app-demo-27bb0bb7500f?source=collection_archive---------0----------------------->

![](img/a1ecdf1d8bbb4e1e1e15913fea5a6bbb.png)

*æœ¬æ–‡è‡´åŠ›äºè®¾ç½® AdonisJs websocket å®¢æˆ·ç«¯&æœåŠ¡å™¨ APIã€‚æœ€åï¼Œæ‚¨ä¼šå‘ç°ä¸€ä¸ª monorepo çš„é“¾æ¥ï¼Œå…¶ä¸­åŒ…å«å·¥ä½œç¤ºä¾‹ä»£ç (ä»¥åŠ CI/CD è„šæœ¬ï¼)å’Œä¸€ä¸ªç°åœºæ¼”ç¤ºåº”ç”¨ç¨‹åºã€‚*

*å®ƒæ˜¯ä¸ºé‚£äº›å·²ç»å¯¹ AdonisJs(æˆ– Node.js)æœ‰ç»éªŒå¹¶æœ‰æ‰€ååº”çš„è¯»è€…è€Œå†™çš„ã€‚è¿™é‡Œä¸è§£é‡ŠåŸºç¡€ï¼Œåªè§£é‡Š websocket ç›¸å…³é€»è¾‘ã€‚*

â€”

è®© AdonisJs å¥—æ¥å­—è¿è¡Œèµ·æ¥å¹¶ä¸æ˜¯ä¸–ç•Œä¸Šæœ€å®¹æ˜“çš„äº‹æƒ…ï¼Œä½†æ˜¯å½“å°è¯•æ–°äº‹ç‰©æ—¶å´æ˜¯å¦‚æ­¤ã€‚æˆ‘è§‰å¾—æ–‡æ¡£æœ‰ç‚¹è–„ï¼Œå› æ­¤è¿™ç¯‡æ–‡ç« æœ‰ä¾‹å­ã€‚æˆ‘å¸Œæœ›æˆ‘èƒ½å¸®åŠ©é‚£äº›åƒæˆ‘ä¸€æ ·æŒ£æ‰çš„äººã€‚

æˆ‘ä»¬ä¸ä¼šä¸€æ­¥ä¸€æ­¥åœ°åˆ›å»ºæ–°çš„ REST APIã€‚ç›¸åï¼Œæˆ‘å°†ä»‹ç»æˆ‘å¯¹è¿™ä¸ªæ¼”ç¤ºåº”ç”¨ç¨‹åºçš„æƒ³æ³•:

> å‡è®¾ä½ æœ‰å¤šä¸ªèŠå¤©å®¤ã€‚æ¯ä¸ªèŠå¤©å®¤éƒ½æœ‰å¤šæ¡æ¶ˆæ¯ï¼Œç”¨æˆ·å½“ç„¶å¯ä»¥å‘å¸ƒæ–°æ¶ˆæ¯ã€‚å‰ç«¯é€šè¿‡ websocket é€šä¿¡æ¥æ”¶ç”±æœåŠ¡å™¨å¹¿æ’­çš„æ–°æ¶ˆæ¯ã€‚

è¿™ä¸ºæˆ‘ä»¬å¸¦æ¥äº†ä¸€ä¸ªåŸºæœ¬çš„ REST API ç»“æ„(æ— è®¤è¯):

*   å¸–å­`/rooms` â€”åˆ›å»ºä¸€ä¸ªæ–°èŠå¤©å®¤
*   GET `/rooms/:uuid` â€”é€‰æ‹©å¹¶è¿”å›ä¸€ä¸ªç°æœ‰èŠå¤©å®¤åŠå…¶æ¶ˆæ¯
*   POST `/rooms/:uuid` â€”åœ¨æˆ¿é—´ä¸­åˆ›å»ºæ–°æ¶ˆæ¯ï¼Œ**æ ¹æ®æˆ¿é—´ ID å‘ä¸»é¢˜å¹¿æ’­æ¶ˆæ¯**(æ„å‘³ç€åªæœ‰æˆ¿é—´ ID çš„è®¢é˜…è€…æ”¶åˆ°æ¶ˆæ¯)

![](img/ab2c3b16a746a1fb863d5e2f1881b763.png)

ä½ å¯ä»¥ä½¿ç”¨é‚®é€’å‘˜ä½¿ç”¨[https://adonis-sockets-api.herokuapp.com/rooms](https://adonis-sockets-api.herokuapp.com/rooms)æ¥å°è¯•ä¸€ä¸‹

# å‡†å¤‡åç«¯ä»¥å¹¿æ’­æ¶ˆæ¯

æˆ‘å°†å‚è€ƒ AdonisJs çš„å®˜æ–¹æ–‡æ¡£ã€‚æˆ‘ä»¬å¸Œæœ›æ‚¨å·²ç»ç”Ÿæˆäº† AdonisJs é¡¹ç›®ï¼Œå› ä¸ºæˆ‘ä»¬å°†éµå¾ªè¯¥ç»“æ„ã€‚

## å®‰è£…ä¾èµ–é¡¹

è¦å®‰è£… WebSocket Providerï¼Œæ‚¨éœ€è¦åœ¨ adonis é¡¹ç›®æ ¹ç›®å½•ä¸‹è¿è¡Œ
`adonis install @adonisjs/websocket`ã€‚

(æŠ„è¢­è‡ª[https://adonisjs.com/docs/4.1/websocket](https://adonisjs.com/docs/4.1/websocket))

1.  `config/socket.js`åŒ…å« WebSocket æœåŠ¡å™¨**é…ç½®**ã€‚
2.  `start/socket.js`å¯åŠ¨ WebSocket æœåŠ¡å™¨å¹¶æ³¨å†Œ**é€šé“**ã€‚
3.  `start/wsKernel.js` **æ³¨å†Œä¸­é—´ä»¶**æ‰§è¡Œé¢‘é“è®¢é˜…ã€‚

æ¥ä¸‹æ¥ï¼Œåœ¨`start/app.js`æ–‡ä»¶ä¸­æ³¨å†Œæä¾›è€…:

```
const providers = [
  '@adonisjs/websocket/providers/WsProvider'
]
```

æœ€åï¼ŒæŒ‡ç¤º[ç‚¹ç«å™¨](https://adonisjs.com/docs/4.1/ignitor)å¼•å¯¼æ ¹`server.js`æ–‡ä»¶ä¸­çš„ WebSocket æœåŠ¡å™¨:

```
const { Ignitor } = require('@adonisjs/ignitor')new Ignitor(require('@adonisjs/fold'))
   .appRoot(__dirname)
   .**wsServer()** // boot the WebSocket server
   .fireHttpServer()
   .catch(console.error)
```

â€”

## å®é™…ä»£ç 

æ‚¨å¯ä»¥åœ¨`start/socket.js`æ–‡ä»¶ä¸­æ³¨å†Œå¥—æ¥å­—é€šé“ã€‚æˆ‘çš„çœ‹èµ·æ¥åƒè¿™æ ·:

```
**'use strict'

const *Ws*** = **use**(**'Ws'**)

***Ws*** .**channel**(**'room:*'**, **'RoomUpdateController'**)
  *// .middleware(['auth'])*
```

å¦‚ä½ æ‰€è§ï¼Œæˆ‘æŒ‡çš„æ˜¯ä¸€ä¸ªæ§åˆ¶å™¨ï¼Œè€Œä¸æ˜¯åœ¨`socket.js`æ–‡ä»¶ä¸­å†™æ‰€æœ‰çš„é€»è¾‘ã€‚è¿™æ˜¯å¯é€‰çš„ï¼Œæˆ‘æ›´å–œæ¬¢æ§åˆ¶å™¨ç»“æ„æ¥ä¿æŒæˆ‘çš„é¡¹ç›®é€»è¾‘åˆ†ç¦»ï¼Œæ˜“äºå›æº¯ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯`.channel('room:*')`éƒ¨åˆ†â€”â€”è¿™æ˜¯æ‚¨å°†è®¢é˜…çš„é¢‘é“ã€‚ç”±äºæˆ‘å°†è®¢é˜…ä¸åŒçš„æˆ¿é—´(åŸºäºä»–ä»¬çš„ ID)ï¼Œæˆ‘éœ€è¦`:*`åŠ¨æ€å‚æ•°ã€‚

è¿˜æœ‰ä¸€æ¡è¯„è®ºçº¿å†™ç€`// .middleware(['auth'])`ã€‚**æˆ‘ä»¬ä¸ä¼šåšä»»ä½•æˆæƒç”¨æˆ·æ£€æŸ¥**ï¼Œä½†æ˜¯å¦‚æœä½ æƒ³åšè¿™äº›ï¼Œè¿™æ˜¯ä½ å¦‚ä½•åœ¨[https://adonisjs.com/docs/4.1/websocket-server](https://adonisjs.com/docs/4.1/websocket-server)æ³¨å†Œä¸­é—´ä»¶çš„è¿›ä¸€æ­¥è¯´æ˜ã€‚

â€”

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬ç”Ÿæˆæˆ‘ä»¬å¼•ç”¨çš„æ§åˆ¶å™¨â€”

`adonis make:controller RoomUpdate --type=ws`

æˆ‘çš„ RoomUpdateController çš„å†…å®¹å¦‚ä¸‹æ‰€ç¤º:

*   `constructor()`å°†é€šè¿‡æ§åˆ¶å°æ—¥å¿—æé†’æˆ‘ä»¬å·²ç»è¿›è¡Œäº†æ–°çš„è®¢é˜…â€”â€”å…¶ä¸­`socket.topic`å°†æ˜¯æˆ‘ä»¬è®¢é˜…çš„æˆ¿é—´ IDã€‚
*   å½“ä»å®¢æˆ·ç«¯æ¥æ”¶åˆ°**æ¶ˆæ¯æ—¶,`onMessage()`ä¼šæé†’æˆ‘ä»¬â€”â€”æˆ‘ä»¬ä¸ä¼šä»å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºå‘å‡ºæ¶ˆæ¯ï¼Œåªä¼šä»æœåŠ¡å™¨å‘å‡ºæ¶ˆæ¯ã€‚å¦‚æœä½ æƒ³æµ‹è¯•å®ƒï¼Œå®ƒå°±åœ¨é‚£é‡Œã€‚**
*   æ¯å½“å®¢æˆ·ç«¯å…³é—­è¿æ¥æ—¶,`onClose()`ä¼šæé†’æˆ‘ä»¬ã€‚ç”¨è¿™ä¸ªæ¥æµ‹è¯•ä½ æ˜¯å¦çœŸçš„å…³é—­äº†è¿æ¥ã€‚

## å¹¿æ’­æœ¬èº«

æˆ‘ä»¬çš„ websocket é€»è¾‘ä¼¼ä¹å·²ç»è®¾ç½®å¥½äº†â€”â€”æˆ‘ä»¬å·²ç»å®‰è£…äº†æ‰€æœ‰çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬å·²ç»åœ¨`start/socket.js`æ–‡ä»¶ä¸­æ³¨å†Œäº†é€šé“ï¼Œæˆ‘ä»¬å·²ç»å°†å®ƒé“¾æ¥åˆ°ä¸€ä¸ªæ§åˆ¶å™¨ï¼Œå¹¶åœ¨å…¶ä¸­ç¼–å†™äº†ä¸€äº›åŸºæœ¬çš„ç›‘å¬é€»è¾‘ã€‚ç°åœ¨æˆ‘ä»¬å»å¹¿æ’­æ–°æ¶ˆæ¯å§ï¼

ç”±äºæœ¬æ–‡æ¼”ç¤ºäº†å•å‘ websocket é€šä¿¡(æœåŠ¡å™¨â†’å®¢æˆ·ç«¯)ï¼Œ**ä¸€æ—¦ç”¨æˆ·åœ¨æˆ¿é—´**å‘å¸ƒæ–°æ¶ˆæ¯ï¼Œæˆ‘ä»¬å°±ä¼šå¹¿æ’­æ¶ˆæ¯ã€‚æ‚¨å¯ä»¥åœ¨æœ¬æ–‡æœ«å°¾é“¾æ¥çš„ç¤ºä¾‹æºä»£ç ä¸­æ‰¾åˆ°æ‰€æœ‰çš„ API é€»è¾‘ã€‚ç°åœ¨ï¼Œæˆ‘å°†åªå…³æ³¨ createMessage ç«¯ç‚¹ã€‚

app/controller/Http/room controller . js

è¿™æ˜¯ä»æˆ‘çš„åŒ…å« API é€»è¾‘çš„`RoomController.js`æ–‡ä»¶ä¸­æ‘˜å½•çš„ã€‚æˆ‘åªå±•ç¤ºäº†`createMessage()`æ–¹æ³•ï¼Œå› ä¸ºå®ƒæ˜¯å”¯ä¸€ä¸€ç§å¹¿æ’­æ–¹æ³•ã€‚

`createMessage()`è¿”å›ç»“æœ(åˆ›å»ºçš„æ¶ˆæ¯å¯¹è±¡)ï¼Œä½†æˆ‘ä»¬å°†åœ¨å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºä¸­å¿½ç•¥å®ƒï¼Œè€Œæ˜¯é€šè¿‡å¥—æ¥å­—é€šä¿¡æ¥æ”¶æ–°æ¶ˆæ¯ã€‚å¦‚æœæ‚¨åˆ é™¤è¿™ä¸€è¡Œå¹¶è¿”å›ä¸€ä¸ªç®€å•çš„ 200 ä»£ç ï¼Œåº”è¯¥æ²¡æœ‰ä»€ä¹ˆå˜åŒ–ã€‚

æ³¨æ„è¢«è°ƒç”¨çš„`broadcast()`å‡½æ•°â€”â€”å®ƒæ˜¯ä»æ‰§è¡Œå¤§éƒ¨åˆ†é­”æ³•çš„`socket.utils`æ–‡ä»¶ä¸­å¯¼å‡ºçš„ã€‚è®©æˆ‘ä»¬æ·±å…¥ç ”ç©¶ä¸€ä¸‹ã€‚

â€”

è¿™ä¸ª`broadcast`åŠŸèƒ½æ˜¯æ ¹æ®æˆ‘ä»¬çš„éœ€æ±‚é‡èº«å®šåˆ¶çš„ã€‚å®ƒé¢„è®¡:

*   ä¸€ä¸ª`id`ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè¿™å°†æ˜¯æˆ‘ä»¬çš„æˆ¿é—´ ID (uuid) â€”æˆ‘ä»¬éœ€è¦å®ƒä½œä¸ºåŠ¨æ€ä¸»é¢˜å‚æ•°ï¼Œå› ä¸ºæˆ‘ä»¬åªæƒ³å°†æ¶ˆæ¯å¹¿æ’­åˆ°ä¸€ä¸ªæˆ¿é—´ã€‚
*   ä¸€ä¸ªå…è®¸å®¢æˆ·ç«¯åˆ†ç¦»å¤„ç†é€»è¾‘çš„`type`å­—ç¬¦ä¸²â€”â€”æˆ‘ä»¬åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨äº†`room:newMessage`å­—ç¬¦ä¸²ã€‚è¿™å¯ä»¥å¾ˆå®¹æ˜“åœ°æ‰©å±•åˆ°å„ç§ç±»å‹ï¼Œå¦‚`room:deleteMessage`æˆ–`room:editMessage`ï¼Œå…è®¸å‰ç«¯æ ¹æ®ç±»å‹å†³å®šå¦‚ä½•å¤„ç†ä¼ å…¥çš„æ•°æ®(æˆ‘ä»¬å°†åœ¨åé¢çœ‹åˆ°è¿™ä¸€ç‚¹)ã€‚
*   ä¸€ä¸ªå°†è¢«å¹¿æ’­çš„`data`ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯`message`å¯¹è±¡ã€‚

1.  æˆ‘ä»¬æƒ³è¦è®¿é—®æˆ‘ä»¬ä¸»é¢˜çš„é¢‘é“ï¼Œå³`room:*`ã€‚å¦‚æœæ²¡æœ‰é¢‘é“ï¼Œæˆ‘ä»¬å°±æ— æ³•ç»§ç»­ï¼Œå› ä¸ºæˆ‘ä»¬æ‰¾ä¸åˆ°æˆ‘ä»¬çš„è¯é¢˜ã€‚
2.  æˆ‘ä»¬æ ¹æ®æ”¶åˆ°çš„`id`æ‰¾åˆ°ä¸»é¢˜ã€‚åŒæ ·ï¼Œå¦‚æœæ²¡æœ‰ä¸»é¢˜ï¼Œæˆ‘ä»¬å°±ä¸èƒ½ç»§ç»­(è¿™æ„å‘³ç€å®¢æˆ·ç«¯æ²¡æœ‰æ­£ç¡®è¿æ¥ï¼Œæˆ–è€…æ ¹æœ¬æ²¡æœ‰è¿æ¥)ã€‚
3.  ä¸€æ—¦æˆ‘ä»¬æœ‰äº†ä¸»é¢˜ï¼Œæˆ‘ä»¬å°±å¹¿æ’­æ•°æ®â€”æˆ‘ä»¬å¯ä»¥ä» 3 ç§æ–¹å¼ä¸­é€‰æ‹©é€šä¿¡:
    - *å‘å‡º* â€”ä»…å°†æ¶ˆæ¯å‘é€ç»™äº§ç”Ÿè¯·æ±‚çš„å®¢æˆ·ç«¯
    - *å¹¿æ’­* â€”å°†æ¶ˆæ¯å‘é€ç»™é™¤ä¹‹å¤–çš„æ‰€æœ‰äººï¼Œäº§ç”Ÿè¯·æ±‚çš„å®¢æˆ·ç«¯
    - *å¹¿æ’­ç»™æ‰€æœ‰äºº* â€”å°†æ¶ˆæ¯å‘é€ç»™æ”¶å¬æ‰€è¿°ä¸»é¢˜çš„**æ‰€æœ‰äºº**ã€‚

> æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯`broadcastToAll`æ–¹æ³•ï¼Œå› æ­¤æ— è®ºæ‚¨æ˜¯å¦åœ¨æˆ¿é—´é‡Œåˆ¶ä½œæ¶ˆæ¯ï¼Œå®¢æˆ·ç«¯éƒ½æ²¡æœ‰åŒºåˆ«ã€‚å®ƒåªæ˜¯æ¥æ”¶ä¸€æ¡æ¶ˆæ¯å¹¶æ˜¾ç¤ºå®ƒã€‚

ç°åœ¨ï¼Œæ‰€æœ‰ 3 ç§æ–¹æ³•éƒ½éœ€è¦ä¸¤ä¸ªå‚æ•°â€” `event`å’Œ`data`ã€‚

*   æˆ‘æ€»æ˜¯ä½¿ç”¨å­—ç¬¦ä¸²â€œmessageâ€ä½œä¸º`event`å‚æ•°ã€‚æˆ‘å‘ç°è¿™æ›´å®¹æ˜“ï¼Œå› ä¸ºæˆ‘æ€»æ˜¯å¬å®¢æˆ·ç«¯çš„`message`ï¼Œä¸å¿…æ‹…å¿ƒè¿‡äºå¤æ‚çš„äº‹æƒ…ã€‚
*   æˆ‘çš„`data`å‚æ•°æ˜¯ä¸€ä¸ªè¿æ¥çš„å¯¹è±¡â€”â€”ç”±ç±»å‹å±æ€§(`room:newMessage`)å’Œç”±`broadcast()` socket util å‡½æ•°æ¥æ”¶çš„æ•°æ®ç»„æˆã€‚

ç”±`broadcastToAll()`å‡½æ•°æ¥æ”¶çš„`data`å¯¹è±¡ä¸€æ—¦è¢«è¿æ¥ï¼Œçœ‹èµ·æ¥å°±åƒè¿™æ ·:

å®¢æˆ·ç«¯æ”¶åˆ°æ¶ˆæ¯åä¼šçœ‹åˆ°ä»€ä¹ˆ

â€”

# å‡†å¤‡å®¢æˆ·ç«¯æ¥æ”¶æ¶ˆæ¯

*æˆ‘ä¸ä¼šæ·±å…¥ç ”ç©¶ GET å’Œ POST è¯·æ±‚æ¥ä¸ API é€šä¿¡ï¼Œä¹Ÿä¸ä¼šæ·±å…¥ç ”ç©¶ React è¯­æ³•ã€‚æœ€åï¼Œæ‚¨çš„å‰ç«¯æ˜¯ç”¨ä»€ä¹ˆåˆ›å»ºçš„å¹¶ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯å¦‚ä½•æ¥æ”¶æ¶ˆæ¯ï¼Œè¿™åœ¨æ‰€æœ‰æ¡†æ¶ä¸­éƒ½éå¸¸ç›¸ä¼¼ã€‚*

![](img/e8eea0ca6a63f762f9695e1378771193.png)

è¿è¡Œæ¼”ç¤ºå‰ç«¯åº”ç”¨ç¨‹åºï¼Œ`cd frontend`ã€`yarn install`å’Œ`yarn start`ã€‚å¦‚æœä½ æƒ³åˆ›å»ºè‡ªå·±çš„åº”ç”¨ç¨‹åºï¼Œç”¨`npx create-react-app frontend`ç”Ÿæˆä¸€ä¸ªã€‚

æˆ‘çš„æ¼”ç¤ºå‰ç«¯çš„æµç¨‹å¦‚ä¸‹:

1.  æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæˆ¿é—´å¹¶ç­‰å¾…å“åº”ã€‚æˆåŠŸåˆ›å»ºèŠå¤©å®¤åï¼Œç”¨æˆ·å°†è¢«é‡å®šå‘åˆ°æ–°çš„ç©ºèŠå¤©å®¤ã€‚
2.  ä¸€æ—¦ä½ è¿›å…¥è¿™ä¸ªèŠå¤©å®¤ï¼Œä¸€ä¸ªå¥—æ¥å­—è¿æ¥å°±è¢«åˆå§‹åŒ–äº†ã€‚
3.  ä¿¡æ¯è¡¨å•å¸Œæœ›æ‚¨å¡«å†™æ‚¨çš„**å§“å**å’Œæ‚¨æƒ³è¦å‘é€çš„**ä¿¡æ¯**ã€‚é™¤éè¿™ä¸¤ä¸ªéƒ½å¡«å†™äº†ï¼Œå¦åˆ™é‚®ä»¶ä¸ä¼šå‘é€åˆ°æœåŠ¡å™¨ã€‚
4.  ä¸€æ—¦æ‚¨å‘é€äº†ä¸€æ¡æ¶ˆæ¯(æŒ‰ä¸‹å›è½¦é”®)ï¼Œ**æ¶ˆæ¯**å­—æ®µå°†è¢«æ¸…é™¤ã€‚**åç§°**å­—æ®µä¿æŒå¡«å……çŠ¶æ€ã€‚
5.  æ¥è‡ªæœåŠ¡å™¨**çš„å“åº”è¢«å¿½ç•¥**ã€‚
6.  ç”±äºè¿™ä¸ªè¿æ¥ï¼Œæ‚¨åº”è¯¥ä¼šæ”¶åˆ°ä¸€ä¸ªä¼ å…¥çš„å¥—æ¥å­—æ¶ˆæ¯ã€‚è¿™å°±æ˜¯å‰ç«¯å¤„ç†ä¼ å…¥æ•°æ®çš„æ–¹å¼ï¼Œå¿½ç•¥æ¥è‡ªæœåŠ¡å™¨çš„å“åº”ï¼Œä¸ç­‰å¾…ä»»ä½•æ•°æ®ã€‚
7.  *ä½ å¯ä»¥åœ¨å„ç§é€‰é¡¹å¡ä¸Šæ‰“å¼€æˆ¿é—´ï¼Œæ‰“å¼€ä½ çš„æµè§ˆå™¨æ§åˆ¶å°è§‚çœ‹æ•°æ®æµã€‚*

## å®é™…ä»£ç 

æˆ‘ä»¬æœ€æ„Ÿå…´è¶£çš„æ˜¯å‘ç”Ÿè¿æ¥çš„`Room.js`ç»„ä»¶æ–‡ä»¶ã€‚ç”±äºå¤„ç†ç¨‹åºé“¾æ¥å’Œ useEffect()ä»¥åŠç©·ä¸¾ dep çš„æ€§è´¨ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¼ ç»Ÿçš„`React.Component`ã€‚

è®©æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥:

1.  æˆ‘ä»¬æ­£åœ¨ä»`lib/socket`æ–‡ä»¶å¤¹å¯¼å…¥ä¸€ä¸ª`connection`å˜é‡ã€‚å°½å¯èƒ½å¤–åŒ…ä¸åŒçš„é€»è¾‘æ˜¯æˆ‘çš„ä¹ æƒ¯ã€‚
2.  æˆ‘ä»¬åœ¨ç»„ä»¶å¤–éƒ¨å®šä¹‰äº†ä¸€ä¸ª`subscription`å˜é‡ã€‚æˆ‘ä»¬éœ€è¦å®ƒåœ¨ç»„ä»¶çš„ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥è®¿é—®ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å…³é—­è¿æ¥ã€‚
3.  åœ¨`componentDidMount()`æ—¶ï¼Œæˆ‘ä»¬é€šè¿‡è¿è¡Œ`connection.connect()`è¿æ¥åˆ°æˆ‘ä»¬çš„ websocket æœåŠ¡å™¨ã€‚
4.  ç„¶åæˆ‘ä»¬é€šè¿‡è¿è¡Œ`connection.subscribe()`è¿›è¡Œè®¢é˜…ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨`subscription`å˜é‡ä¸­ã€‚
5.  `connection.subscribe()`éœ€è¦ä¸¤ä¸ªå‚æ•°â€”â€”ä¸€ä¸ª*ä¸»é¢˜*(å¦‚`room:123`)å’Œä¸€ä¸ª*å¥æŸ„*ã€‚
6.  **æˆ‘ä»¬å°†** `**this.handleMessageAdd**` **ä½œä¸ºå¤„ç†ç¨‹åºå‚æ•°ä¼ é€’ã€‚**è¿™æ„å‘³ç€æ¯å½“æ¥æ”¶åˆ°æ‰€è¿°è®¢é˜…ä¸­çš„æ¶ˆæ¯æ—¶ï¼Œæ•°æ®å°†è¢«ä¼ é€’ç»™å¤„ç†å‡½æ•°ã€‚
7.  æˆ‘ä»¬è·å–ç°æœ‰çš„ä¿¡æ¯ï¼Œä»¥é˜²æˆ‘ä»¬æ‰“å¼€ä¸€ä¸ªå·²ç»è£…æ»¡ä¿¡æ¯çš„æˆ¿é—´ã€‚
8.  åœ¨`componentWillUnmount()`ä¹‹åï¼Œæˆ‘ä»¬ä½¿ç”¨å­˜å‚¨çš„è®¢é˜…å˜é‡å¹¶å…³é—­è¿æ¥ã€‚
9.  ç„¶åæ˜¯`handleMessageAdd`æ–¹æ³•ï¼Œå®ƒæœŸå¾…ä¸€æ¡æ¶ˆæ¯ï¼Œå¹¶æ ¹æ®**æ¶ˆæ¯çš„ç±»å‹**(æ‚¨å¯ä»¥çœ‹åˆ°å¼€å…³)å†³å®šå¦‚ä½•å¤„ç†ä¼ å…¥çš„æ•°æ®ã€‚æˆ‘ä»¬ç°åœ¨åªæ·»åŠ äº†ä¸€æ¡æ–°æ¶ˆæ¯(`room:newMessage`)ï¼Œä½†æ˜¯ä½ å¯ä»¥éšæ„æ‰©å±•ã€‚å¦‚æ‚¨æ‰€è§ï¼Œæœ‰ä¸€ä¸ª`this.setState()`è°ƒç”¨ï¼Œå®ƒå°†æ–°æ¶ˆæ¯æ·»åŠ åˆ°æ—§æ¶ˆæ¯çš„æ•°ç»„ä¸­ï¼Œè¿™è§¦å‘äº†æ¶ˆæ¯çš„å‘ˆç°ã€‚

â€”

æ­£å¦‚æ‰€æ–™ï¼Œç¥å¥‡çš„äº‹æƒ…å‘ç”Ÿåœ¨`lib/socket.js`æ–‡ä»¶ä¸­ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹å†…å®¹:

lib/socket.js

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®‰è£… adonis websocket å®¢æˆ·ç«¯åŒ…ã€‚è¾“å…¥`yarn add @adonisjs/websocket-client`ç»§ç»­ã€‚

## è¯·æ³¨æ„ connect()æ–¹æ³•

æˆ‘ä»¬å°è¯•ä½¿ç”¨`this.ws = Ws(...).connect()`è¿›è¡Œè¿æ¥ã€‚

é‡è¦çš„æ˜¯ï¼Œå¦‚æœæ‚¨åœ¨æœ¬åœ°è¿è¡Œåç«¯ï¼Œå¥—æ¥å­—åè®®å°†æ˜¯`ws://`ï¼Œå¦‚æœæ‚¨ä½¿ç”¨æ¼”ç¤º heroku åº”ç”¨ç¨‹åºï¼Œåè®®å°†æ˜¯`wss://`ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä¸ºå®ƒåˆ›å»ºäº†ä¸€ä¸ªå•ç‹¬çš„ util å‡½æ•°ã€‚

ä½ ä¹Ÿå¯ä»¥çœ‹åˆ°æˆ‘æ­£åœ¨ä½¿ç”¨çš„`process.env.REACT_APP_API_URL`æ˜¯æˆ‘çš„**adonis-sockets-api.herokuapp.com**ã€‚å¦‚æœåªåœ¨æœ¬åœ°æä¾›åç«¯æœåŠ¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ env å˜é‡æˆ–åªä½¿ç”¨é™æ€å­—ç¬¦ä¸²ã€‚æ‚¨éœ€è¦çŸ¥é“çš„æ˜¯ï¼Œè¿™æ˜¯è¿æ¥åˆ° websocket é€šé“çš„å®é™… URLï¼Œå› æ­¤å®ƒéœ€è¦æ˜¯æ­£ç¡®çš„ã€‚

æˆ‘çš„å®Œæ•´ç½‘å€æ˜¯è¿™æ ·çš„:**WSS://Adonis-sockets-API . heroku app . com/***(ä¹Ÿå¯ä»¥ç”¨è¿™ä¸ª)*ã€‚

åœ¨æ‚¨çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæ‚¨åœ¨æœ¬åœ°è¿è¡Œå®ƒï¼Œå®ƒå¯èƒ½ç±»ä¼¼äº: **ws://localhost:3333/**

è¿˜æœ‰æ³¨é‡Šçš„`// .withApiToken()`è¡Œï¼Œå¦‚æœæ‚¨æƒ³ä½¿ç”¨ auth socket ä¸­é—´ä»¶ï¼Œå¯ä»¥ä½¿ç”¨å®ƒã€‚æ‚¨éœ€è¦æä¾›å­˜å‚¨çš„ä»¤ç‰Œï¼Œä»¥ä¾¿å®ƒä½œä¸ºæœåŠ¡å™¨ websocket è¿æ¥çš„ä¸€éƒ¨åˆ†å‘é€ã€‚

â€”

## ä¸‹ä¸€ä»¶æœ‰è¶£çš„äº‹æƒ…æ˜¯ subscribe()æ–¹æ³•

æˆ‘ä»¬æ¥æ”¶`channel`å’Œ`handler`å‚æ•°ï¼Œå®ƒä»¬å°†æ˜¯æˆ‘ä»¬çš„â€œ **room:*uuid** â€(ä¾‹å¦‚â€œroom:123â€)å­—ç¬¦ä¸²å’Œå¤„ç†å‡½æ•°ã€‚

æˆ‘ä»¬å°†è¿æ¥å­˜å‚¨åœ¨ä¸€ä¸ª`result`å˜é‡ä¸­ï¼Œå¹¶å¤„ç†ä¼ å…¥çš„äº‹ä»¶:

```
**const** result = **this**.**ws**.subscribe(channel); // this is our connection, we retry each second if we don't have it yet

result.on(**'message'**, message => {
  ***console***.log(**'Incoming'**, message);
  handler(message)
});

result.on(**'error'**, (error) => {
  ***console***.error(error)
});

**return** result
```

å¦‚æœä½ è¿˜è®°å¾—ï¼Œæˆ‘è¯´è¿‡æˆ‘æŠŠæ‰€æœ‰ä¸œè¥¿éƒ½å«åšâ€œæ¶ˆæ¯â€æœåŠ¡å™¨ç«¯ã€‚æˆ‘å†³å®šè¿™æ ·åšï¼Œè¿™æ ·æˆ‘å°±å¯ä»¥åœ¨ä¸€ä¸ªå•ç‹¬çš„å¤„ç†ç¨‹åºä¸­æ‹¥æœ‰æˆ‘æ‰€æœ‰çš„é€»è¾‘ï¼Œè¿™ä¸ªå¤„ç†ç¨‹åºå°±æ˜¯`result.on('message', data => handler(data))`ã€‚è¿™ä½¿å¾—å°†æ•°æ®ä¼ é€’ç»™æˆ‘çš„ç»„ä»¶`handleMessageAdd`å¤„ç†ç¨‹åºå¹¶åœ¨æ‰€è¿°å¤„ç†ç¨‹åºä¸­åˆ†ç¦»ä¸åŒçš„æ¶ˆæ¯ç±»å‹é€»è¾‘å˜å¾—å®¹æ˜“ã€‚

å½“ç„¶ï¼Œé‡‡ç”¨å“ªç§æ–¹æ³•å–å†³äºä½ è‡ªå·±ã€‚

æˆ‘ä»¬å°†åœ¨*ä¼ å…¥çš„*æ¶ˆæ¯å’Œ*é”™è¯¯*ä¸Šæ˜¾ç¤º console.log()ã€‚

> å‰ç«¯è¿™è¾¹åº”è¯¥å°±è¿™æ ·äº†ã€‚æœ€é‡è¦çš„æ˜¯å¤„ç†è¿æ¥çš„`lib/socket.js`æ–‡ä»¶å’Œè¿æ¥å¹¶å¤„ç†æ¥æ”¶æ¶ˆæ¯çš„ç»„ä»¶ï¼Œå½“ç„¶å¯ä»¥æ˜¯å¤šä¸ªç»„ä»¶ã€‚

æ‚¨å¯ä»¥æ ¹æ®è‡ªå·±çš„æ„æ„¿æ‰©å±•è¿™ä¸ªåº”ç”¨ç¨‹åºï¼Œæä¾›èº«ä»½éªŒè¯ã€æ¶ˆæ¯åˆ é™¤ã€æˆ¿é—´åç§°ã€æˆ¿é—´ç¼–è¾‘ç­‰åŠŸèƒ½ã€‚

â€”

æœ‰ç”¨çš„æ¥æº:

*   æ¼”ç¤ºåº”ç”¨â€”[https://adonis-sockets-frontend.herokuapp.com/](https://adonis-sockets-frontend.herokuapp.com/#/)(æ‰“å¼€ä½ çš„æ§åˆ¶å°ï¼)â€”â€”*ä½ å¯èƒ½ä¼šç»å† 10 ç§’é’Ÿçš„åŠ è½½æ—¶é—´ï¼Œå› ä¸ºè¿™äº›åº”ç”¨ç¨‹åºæ˜¯æ‰˜ç®¡åœ¨ Heroku ä¸Šçš„ã€‚*
*   å•ä¸€å›è´­æ¥æºâ€”[https://gitlab.com/djanoskova/adonisjs-sockets-monorepo](https://gitlab.com/djanoskova/adonisjs-sockets-monorepo)
*   å¥—æ¥å­—ä¸Šçš„ AdonisJs æ–‡æ¡£â€”[https://adonisjs.com/docs/4.1/websocket](https://adonisjs.com/docs/4.1/websocket)ï¼Œ[https://adonisjs.com/docs/4.1/websocket-server](https://adonisjs.com/docs/4.1/websocket-server)
*   è¯„è®ºï¼é—®ä½ éœ€è¦ä»€ä¹ˆï¼Œç»™åˆ«äººæå»ºè®®ã€‚

æ„Ÿè°¢æ‚¨çš„é˜…è¯»ã€‚ä¸€å¦‚æ—¢å¾€ï¼Œç¥ä½ å¥½è¿ï¼Œé¼“åŠ±ä½ ç»§ç»­åŠªåŠ›ï¼ğŸ‰