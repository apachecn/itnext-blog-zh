# å¦‚ä½•ä¿æŠ¤æ‚¨çš„ web åº”ç”¨ç¨‹åº(ç¬¬ 1 éƒ¨åˆ†)â€” CPAS 3

> åŸæ–‡ï¼š<https://itnext.io/how-to-secure-your-web-applications-part-1-cpas-3-715b72973623?source=collection_archive---------0----------------------->

![](img/caba8a88ec6299db33acf47061d61311.png)

Mauro Sbicego åœ¨ [Unsplash](https://unsplash.com/s/photos/hacking?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) ä¸Šæ‹æ‘„çš„ç…§ç‰‡

å¦‚æœæ‚¨æœ‰ä¸€ä¸ªå…¶ä»–ç”¨æˆ·ä½¿ç”¨çš„å®æ—¶åº”ç”¨ç¨‹åºï¼Œé‚£ä¹ˆä»–ä»¬å¾ˆæœ‰å¯èƒ½ä¼šå—åˆ°æ”»å‡»ï¼Œå¦‚æœä¸æ˜¯æ¯å¤©ï¼Œè‡³å°‘æ¯å‘¨ä¸€æ¬¡ã€‚

ä»æˆ‘è‡ªå·±çš„ç»éªŒæ¥çœ‹ï¼Œæˆ‘æ³¨æ„åˆ°æˆ‘ç›‘æ§çš„å‡ ä¹æ‰€æœ‰åº”ç”¨ç¨‹åºæ¯å¤©éƒ½å—åˆ°æ”»å‡»ï¼Œè¦ä¹ˆæ˜¯ç”¨è‡ªåŠ¨è„šæœ¬æŸ¥æ‰¾æ¼æ´ï¼Œè¦ä¹ˆæ˜¯æ‰‹åŠ¨æ”»å‡»ã€‚

å‡ ä¹æ‰€æœ‰çš„æ”»å‡»ï¼Œæ— è®ºæ˜¯æ‰‹åŠ¨çš„è¿˜æ˜¯è‡ªåŠ¨çš„ï¼Œéƒ½æ˜¯æ— å®³çš„ã€‚å®ƒä»¬æ˜¯ç”±å¥½å¥‡çš„ç”¨æˆ·å®Œæˆçš„ï¼Œæˆ‘è®¤ä¸ºä»–ä»¬è¿™ä¹ˆåšä¸»è¦æ˜¯ä¸ºäº†å¥½ç©æˆ–è€…çœ‹çœ‹åº”ç”¨ç¨‹åºæ˜¯å¦‚ä½•åˆ¶ä½œçš„ã€‚å¤§å¤šæ•°çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„:

![](img/354a2042afd6e6da36869cc92e694f76.png)

è¯•å›¾è¿è¡Œ PHP æ–‡ä»¶çš„è‡ªåŠ¨åŒ–è„šæœ¬

![](img/2a97f45c6e67a04dca68430c6676b15e.png)

ä¸€ä¸ªéšæœºçš„ç”¨æˆ·æ£€æŸ¥åº”ç”¨ç¨‹åºæ˜¯å¦æ˜¯ç”¨ WordPress åˆ¶ä½œçš„

é—®é¢˜åœ¨äºå…¶ä»–æ”»å‡»ï¼Œè¿™äº›æ”»å‡»æ˜¯ç”±é»‘å®¢å®Œæˆçš„ï¼Œä»–ä»¬å®æ„¿æ‰‹åŠ¨åˆ†ææ¶æ„ï¼Œè€Œä¸æ˜¯ä½¿ç”¨æŸäº›ç‰¹å®šè¯­è¨€çš„è‡ªåŠ¨è„šæœ¬ï¼Œå¹¶æ ¹æ®ä»–ä»¬å‘ç°çš„æ¼æ´æ„å»ºä»–ä»¬çš„æ”»å‡»ã€‚

è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘å°†å±•ç¤ºä¸€äº›æ‚¨ç°åœ¨å¯ä»¥åº”ç”¨çš„æœ€ä½³å®è·µï¼Œä»¥ä¾¿ä¸ºæ‚¨çš„åº”ç”¨ç¨‹åºæ„å»ºä¸€ä¸ªé˜²å¼¹å®‰å…¨ç³»ç»Ÿã€‚è¿™äº›åŸåˆ™é€‚ç”¨äºä»»ä½•è¯­è¨€å’Œç¯å¢ƒã€‚

å‡ºäºæ¼”ç¤ºç›®çš„ï¼Œæˆ‘å°†ä»æˆ‘æœ€å¸¸ç”¨çš„å·¥å…·ä¸­é€‰æ‹©ä¸€äº›:Angularã€NestJS(å¸¦ express)ã€MongoDBã€å¸¦ Ubuntu çš„ VPS å’Œ Nginxã€‚

> å› ä¸ºï¼Œè¿™ç¯‡æ–‡ç« ä¼šå¾ˆé•¿ï¼Œæˆ‘å†³å®šæŠŠå®ƒåˆ†æˆä¸¤éƒ¨åˆ†ã€‚åœ¨**çš„ç¬¬ä¸€éƒ¨åˆ†**ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºå¦‚ä½•**ä¿æŠ¤**web åº”ç”¨ï¼Œåœ¨**çš„ç¬¬äºŒéƒ¨åˆ†**ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºå¦‚ä½•**ä¿æŠ¤**åº”ç”¨çš„**ç”Ÿäº§ç¯å¢ƒ**ã€‚*ğŸ˜Š*
> 
> æ­¤å¤–ï¼Œæœ¬æ–‡å°†æ›´åŠ å®ç”¨å’Œé¢å‘ä»£ç ã€‚å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘ä¼šç•™ä¸‹ä¸€äº›é“¾æ¥ï¼Œä½ å¯ä»¥åœ¨é‚£é‡Œæ‰¾åˆ°æ›´å¤šçš„ç†è®ºä¿¡æ¯ã€‚

# I .å¦‚ä½•ä¿æŠ¤åº”ç”¨ç¨‹åº

å…³äºå®‰å…¨æ€§çš„ä¸€ä¸ªè¯¯è§£æ˜¯ï¼Œç¼–ç¨‹è¯­è¨€èµ·ç€æœ€å¤§çš„ä½œç”¨ã€‚è€Œäº‹å®ä¸Šï¼Œå¤§éƒ¨åˆ†å®‰å…¨æ€§(99%)æ˜¯æ‚¨ç¼–å†™çš„å®ç°ã€‚

## 1.ä¿æŒç§äººæ•°æ®ç‹¬ç«‹

å¤§å¤šæ•°æ—¶å€™ï¼Œæ‚¨çš„åç«¯ä»£ç éœ€è¦ä¸€äº›æ•æ„Ÿæ•°æ®ï¼Œå¦‚ç§é’¥ã€æ•°æ®åº“å‡­è¯ç­‰â€¦

è¿™é‡Œæœ€å¥½çš„æ–¹æ³•æ˜¯ä½¿ç”¨ç±»ä¼¼ [dotenv](https://www.npmjs.com/package/dotenv) çš„ä¸œè¥¿ï¼Œå¹¶å°†è¿™äº›æ•°æ®å­˜å‚¨åœ¨å•ç‹¬çš„æ–‡ä»¶ä¸­ã€‚

![](img/e0f04524e818f34636408958cf705e09.png)

è¿™æ ·ï¼Œä¸ºæ¯ä¸ªç¯å¢ƒåˆ›å»º 3 æˆ– 4 ä¸ªå•ç‹¬çš„æ–‡ä»¶ï¼Œå¹¶ç”¨ç›¸åº”çš„æ•°æ®å¡«å……å®ƒä»¬(*æˆ‘ä»¬é©¬ä¸Šä¼šçœ‹åˆ°ä¸€ä¸ªä¾‹å­*)ã€‚

**è¿™é‡Œçš„å…³é”®**æ˜¯**æ°¸è¿œä¸è¦æŠŠè¿™äº›æ–‡ä»¶ä¸Šä¼ åˆ°ä»»ä½•åœ°æ–¹**ï¼Œå¹¶ä¸”æ°¸è¿œä¸è¦ä»æ¯ä¸ªåœ°æ–¹ä¿å­˜ä¸€ä¸ªä»¥ä¸Šçš„ä¾‹å­ã€‚æˆ‘çš„æ„æ€æ˜¯å¦‚ä¸‹ã€‚æ–‡ä»¶ **.env.production** åº”è¯¥åªå­˜åœ¨äºç”Ÿäº§æœåŠ¡å™¨ä¸Šï¼Œ **.env.test** åº”è¯¥åªå­˜åœ¨äºæš‚å­˜æœåŠ¡å™¨(å¦‚æœæœ‰)ä¸Šï¼Œä¸ **.env.development** ç›¸åŒã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬æœ‰ç¬¬å››ä¸ªæ–‡ä»¶ **.env.sample.** åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å°†å†™å‡ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºéœ€è¦å“ªäº›å˜é‡ï¼Œä½†æ˜¯æ²¡æœ‰å®ƒä»¬çš„å€¼ã€‚

## 2.ä»…ä¸ºæ‚¨çš„èµ„æºå¯ç”¨è·¨æ¥æºèµ„æºå…±äº«(CORS)

å¦‚æœä½ æ›¾ç»çœ‹åˆ°è¿™ä¸ªé”™è¯¯ï¼Œé‚£ä¹ˆä½ å¿…é¡»å¤„ç†æ‰€è°“çš„ [CORS](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS) ã€‚

![](img/2bea23941cac7cb9f6cbba50d5609731.png)

ç®€å•åœ°è¯´ï¼Œåªæœ‰å½“èµ„æºæ˜¯ä»åŒä¸€ä¸ªæ¥æºä¸Šä¼ çš„æ—¶å€™ï¼Œè¿™ä¸ªå¤´æ‰å…è®¸ API è¯·æ±‚èµ„æºã€‚ä¾‹å¦‚**ç«™ç‚¹ A** ä¸èƒ½å‘**ç«™ç‚¹ B** è¯·æ±‚èµ„æºï¼Œå¦‚æœ**ç«™ç‚¹ B** æ²¡æœ‰æ˜ç¡®å…è®¸**ç«™ç‚¹ A** ã€‚

å®Œæ•´çš„é…ç½®å¦‚ä¸‹æ‰€ç¤º:

![](img/4c5f33d1c218c69bc79879580d3a57cf.png)

ã€‚ç¯å¢ƒå˜é‡

åœ¨ Express ä¸­

![](img/0eac583df4d6032d76dba9ddc993b01a.png)

[æ­¤å¤„ä»£ç ](https://carbon.now.sh/?bg=rgba(171%2C%20184%2C%20195%2C%201)&t=monokai&wt=none&l=javascript&ds=true&dsyoff=20px&dsblur=68px&wc=true&wa=true&pv=56px&ph=56px&ln=false&fl=1&fm=Hack&fs=14px&lh=133%25&si=false&es=2x&wm=false&code=const%2520express%2520%253D%2520require(%2522express%2522)%253B%250Aconst%2520dotenv%2520%253D%2520require(%2522dotenv%2522)%253B%250A%250Aconst%2520app%2520%253D%2520express()%253B%250A%250Alet%2520envPath%253B%250A%250Aswitch%2520(process.env.NODE_ENV)%2520%257B%250A%2520%2520case%2520%2522test%2522%253A%250A%2520%2520%2520%2520envPath%2520%253D%2520path.resolve(__dirname%252C%2520%2522.%252F.env.test%2522)%253B%250A%2520%2520%2520%2520break%253B%250A%2520%2520case%2520%2522production%2522%253A%250A%2520%2520%2520%2520envPath%2520%253D%2520path.resolve(__dirname%252C%2520%2522.%252F.env.production%2522)%253B%250A%2520%2520%2520%2520break%253B%250A%2520%2520case%2520%2522development%2522%253A%250A%2520%2520%2520%2520envPath%2520%253D%2520path.resolve(__dirname%252C%2520%2522.%252F.env.development%2522)%253B%250A%2520%2520%2520%2520break%253B%250A%2520%2520default%253A%250A%2520%2520%2520%2520throw%2520new%2520Error(%2522Specify%2520the%2520NODE_ENV%2520variable%2522)%253B%250A%257D%250A%250Aconst%2520envConfig%2520%253D%2520dotenv.parse(fs.readFileSync(envPath))%253B%250A%250Aapp.use(%250A%2520%2520cors(%257B%250A%2520%2520%2520%2520origin%253A%2520JSON.parse(envConfig%255B%2522CORS_ORIGINS%2522%255D)%252C%250A%2520%2520%2520%2520credentials%253A%2520true%252C%250A%2520%2520%257D)%250A)%253B)

## 3.è·¨ç«™è¯·æ±‚ä¼ªé€ (CSRF)å’Œè·¨ç«™è„šæœ¬(XSS)

å¦‚æœè¿™äº›æœ¯è¯­å¯¹ä½ æ¥è¯´æ˜¯æ–°çš„ï¼Œé‚£ä¹ˆæˆ‘å»ºè®®ä½ å…ˆå»é˜…è¯»è¿™ç¯‡[æ–‡ç« ](https://medium.com/@l4mp1/difference-between-xss-and-csrf-attacks-ff29e5abcd33)ã€‚

**TLï¼›åšå£«**

> **è·¨ç«™ç‚¹è¯·æ±‚ä¼ªé€ (ä¹Ÿç§°ä¸º CSRF æˆ– XSRF)** æ˜¯ä¸€ç§å¯¹ç½‘ç«™çš„æ¶æ„åˆ©ç”¨ï¼Œä» web åº”ç”¨ç¨‹åºä¿¡ä»»çš„ç”¨æˆ·å¤„ä¼ è¾“æœªç»æˆæƒçš„å‘½ä»¤ã€‚
> 
> **è·¨ç«™è„šæœ¬(ä¹Ÿç§°ä¸º XSS)** æ˜¯æ”»å‡»è€…å¯ä»¥æ¥ç®¡ç½‘é¡µçš„ä¸€ç§æ–¹å¼ã€‚XSS æ”»å‡»çš„ç›®æ ‡æ˜¯æ§åˆ¶å—å®³è€…æµè§ˆå™¨ä¸­çš„ JavaScriptã€‚

ä¸ºäº†å‡å°‘ **CSRF** æ¼æ´ä½ å¯ä»¥ä½¿ç”¨ [csurf](https://www.npmjs.com/package/csurf) æ¨¡å—ã€‚è¿™ç§æŠ€æœ¯æ„å‘³ç€ä»¤ç‰Œçš„åˆ›å»ºå’ŒéªŒè¯ã€‚

æœåŠ¡å™¨åˆ›å»ºä¸€ä¸ªä»¤ç‰Œï¼Œå°†å…¶ä¸ cookie ä¸€èµ·å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå½“å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚æ—¶ï¼Œåç«¯ä»£ç å°†éªŒè¯è¯¥ä»¤ç‰Œã€‚è¿™æ ·ï¼Œæ‰€æœ‰æ²¡æœ‰æœ‰æ•ˆä»¤ç‰Œçš„è¯·æ±‚éƒ½ä¼šè¢«æ‹’ç»ã€‚

åç«¯æœåŠ¡å™¨çš„å®ç°å¦‚ä¸‹æ‰€ç¤ºã€‚

![](img/bdd4feed04d4755353d4bdf5b4bae19c.png)

[æ­¤å¤„ä»£ç ](https://carbon.now.sh/?bg=rgba(171%2C%20184%2C%20195%2C%201)&t=monokai&wt=none&l=javascript&ds=true&dsyoff=20px&dsblur=68px&wc=true&wa=true&pv=56px&ph=56px&ln=false&fl=1&fm=Hack&fs=14px&lh=133%25&si=false&es=2x&wm=false&code=-----------------------------express%2520config----------------------------------%250A%250Aapp.use(cookieParser(configService.get(%27COOKIE_SECRET%27)))%253B%250Aapp.use(csurf(%257B%2520cookie%253A%2520%257B%2520key%253A%2520%27_csrf%27%252C%2520sameSite%253A%2520true%2520%257D%2520%257D))%253B%250A%250A%250A-----------------------------controller--------------------------------------%250A%2520%2520%250A%2540Get(%27who-am-I%27)%250A%2540UseInterceptors(UserInterceptor)%250Aasync%2520whoAmI(%2540Request()%2520req%253A%2520any)%2520%257B%250A%2520%2520const%2520user%2520%253D%2520req.user%2520%253F%2520classToPlain(new%2520UserEntity(req.user))%2520%253A%2520undefined%253B%250A%250A%2520%2520return%2520%257B%250A%2520%2520%2520%2520user%252C%250A%2520%2520%2520%2520csrfToken%253A%2520req.csrfToken()%252C%250A%2520%2520%257D%253B%250A%257D)

> **æ³¨æ„ï¼**è¿™ä¸ªä¾‹å­æ˜¯åœ¨ NestJS ä¸­å®Œæˆçš„ã€‚åœ¨è¿™é‡Œï¼Œæ‚¨å¿…é¡»ç”¨æ‚¨çš„ä»£ç æ›¿æ¢å…¶ä»–éƒ¨åˆ†ã€‚

**ä»£ç è§£é‡Š:**

*   æœåŠ¡å™¨(express)è¢«é…ç½®ä¸ºä½¿ç”¨å¸¦æœ‰ç§˜å¯†ä»¤ç‰Œçš„ cookieParser
*   æœåŠ¡å™¨è¢«é…ç½®ä¸ºä½¿ç”¨ csurf æ¨¡å—åŸºäºåä¸º **_csrf** çš„ cookie è¿›è¡Œä»¤ç‰ŒéªŒè¯ï¼Œè¯¥ cookie æ˜¯ç”¨å±æ€§ **sameSite** è®¾ç½®çš„
*   å½“åº”ç”¨ç¨‹åºç¬¬ä¸€æ¬¡åŠ è½½æˆ–å‘æœåŠ¡å™¨å‘å‡ºç¬¬ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œä½¿ç”¨æ–¹æ³• **req.csrfToken()** å‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ª CSRF ä»¤ç‰Œ(è¯¥æ–¹æ³•ç”± **csurf** æ¨¡å—æä¾›)

è¿™æ ·ï¼ŒæœåŠ¡å™¨å°†æ‹’ç»æ‰€æœ‰æ²¡æœ‰æœ‰æ•ˆä»¤ç‰Œçš„è¯·æ±‚ã€‚

è¦ä½¿æ‚¨çš„å‰ç«¯ç°åœ¨å·¥ä½œï¼Œæ‚¨éœ€è¦å°†è¿™ä¸ª csrfToken ä½œä¸ºå¤´åŒ…å«åœ¨æ‚¨çš„è¯·æ±‚ä¸­ã€‚

![](img/1a5652940dfd22cf28668ba31aadd612.png)

[æ­¤å¤„ä»£ç ](https://carbon.now.sh/?bg=rgba(171%2C%20184%2C%20195%2C%201)&t=monokai&wt=none&l=javascript&ds=true&dsyoff=20px&dsblur=68px&wc=true&wa=true&pv=56px&ph=56px&ln=false&fl=1&fm=Hack&fs=14px&lh=133%25&si=false&es=2x&wm=false&code=const%2520res%2520%253D%2520await%2520fetch(%250A%2520%2520%2560https%253A%252F%252Fapi.my-backend.com%252Flogout%2560%252C%250A%2520%2520%257B%250A%2520%2520%2520%2520method%253A%2520%27GET%27%252C%250A%2520%2520%2520%2520headers%253A%2520%257B%250A%2520%2520%2520%2520%2520%2520%27CSRF-Token%27%253A%2520window.csrfToken%252C%250A%2520%2520%2520%2520%257D%252C%250A%2520%2520%2520%2520credentials%253A%2520%27include%27%252C%250A%2520%2520%257D%252C%250A)%253B)

*æ³¨æ„æˆ‘ä»¬åœ¨å‰ç«¯è®¾ç½®çš„* ***å‡­è¯*** *å±æ€§ï¼Œæˆ‘ä»¬åœ¨è®¾ç½®* ***cors()*** æ—¶ä¹Ÿåœ¨åç«¯è®¾ç½®äº†è¿™ä¸ªå±æ€§

*ç”¨æ‚¨çš„ä»¤ç‰Œçš„ä½ç½®æ›¿æ¢* `*window.csrfToken*` *ã€‚*

**XSS** æ”»å‡»å¯ä»¥å˜åŒ–ï¼Œè§£å†³æ–¹æ¡ˆä¹Ÿå¯ä»¥å˜åŒ–ã€‚ä¿æŠ¤è‡ªå·±å…å—è¿™ç§æ”»å‡»çš„æœ€ä½³æ–¹æ³•æ˜¯å‡€åŒ–è¾“å…¥ã€‚

è¿˜æœ‰ä¸€ä»¶äº‹å°±æ˜¯ä½¿ç”¨[å¤´ç›”](https://www.npmjs.com/package/helmet)æ¨¡å—ã€‚å¤´ç›”æ˜¯ 12 ä¸ªè¾ƒå°çš„ä¸­é—´ä»¶å‡½æ•°çš„é›†åˆï¼Œå®ƒä»¬è®¾ç½® HTTP å“åº”å¤´ã€‚å…¶ä¸­ä¸€ä¸ªä¸­é—´ä»¶æ˜¯ä¸ºäº†ä¿æŠ¤ XSSã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»æ›´å¤šç›¸å…³ä¿¡æ¯[ã€‚](https://github.com/helmetjs/helmet#how-it-works)

ä¸ºäº†å‡€åŒ–åç«¯çš„è¾“å…¥ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨[ç±»éªŒè¯å™¨](https://www.npmjs.com/package/class-validator)å’Œ[ç±»è½¬æ¢](https://www.npmjs.com/package/class-transformer)æ¨¡å—ã€‚

## 4.ä½¿ç”¨é™é€Ÿå™¨

ä¸€ä¸ª[é€Ÿç‡é™åˆ¶å™¨](https://www.npmjs.com/package/express-rate-limit)ç”¨äºé˜²æ­¢åƒåœ¾é‚®ä»¶æˆ–å¯¹ API è·¯ç”±çš„æš´åŠ›æ”»å‡»ã€‚

å‡è®¾æˆ‘ä»¬çš„åç«¯æœåŠ¡å™¨ä¸Šæœ‰ä¸€ä¸ª **/login** è·¯ç”±ï¼Œæˆ‘ä»¬å¸Œæœ›é˜»æ­¢ä»£ç†åƒåœ¾é‚®ä»¶å‘é€è¿™ä¸ªè·¯ç”±ã€‚

![](img/a2c49c031d101286ee224f637383646c.png)

[æ­¤å¤„ä»£ç ](https://carbon.now.sh/?bg=rgba(171%2C%20184%2C%20195%2C%201)&t=monokai&wt=none&l=javascript&ds=true&dsyoff=20px&dsblur=68px&wc=true&wa=true&pv=56px&ph=56px&ln=false&fl=1&fm=Hack&fs=14px&lh=133%25&si=false&es=2x&wm=false&code=const%2520rateLimit%2520%253D%2520require(%2522express-rate-limit%2522)%253B%250A%250Aapp.set(%2522trust%2520proxy%2522%252C%25201)%253B%250A%250Aconst%2520loginLimiter%2520%253D%2520rateLimit(%257B%250A%2520%2520windowMs%253A%25205%2520*%252060%2520*%25201000%252C%2520%252F%252F%25205%2520minutes%250A%2520%2520max%253A%25205%252C%250A%257D)%253B%250A%250Aapp.use(%2522%252Fapi%252Flogin%2522%252C%2520loginLimiter)%253B)

ä½¿ç”¨è¿™äº›è®¾ç½®ï¼Œæ‰€æœ‰ä»£ç†éƒ½æœ‰ 5 æ¬¡ç™»å½•å°è¯•ï¼Œåœ¨ 5 åˆ†é’Ÿçª—å£å†…å¯¹è·¯ç”±**/API/ç™»å½•**çš„ 5 æ¬¡è¯·æ±‚ä¹‹åï¼Œä»£ç† IP å°†è¢«åˆ—å…¥é»‘åå• 5 åˆ†é’Ÿã€‚åœ¨ 5 åˆ†é’Ÿçª—å£å†…çš„ 5 æ¬¡è¯·æ±‚ä¹‹åï¼Œç”¨æˆ·å°†æ”¶åˆ°ä¸€ä¸ª **429** å“åº”**(è¯·æ±‚å¤ªå¤š)ã€‚**

> **å¦‚æœåç«¯æœåŠ¡å™¨ä½äº Herokuã€Bluemixã€AWS ELBã€Nginx ç­‰åå‘ä»£ç†ä¹‹åï¼Œåˆ™éœ€è¦ app.set("trust proxy "ï¼Œ1)**

## 5.é€‚å½“çš„è®¤è¯ç³»ç»Ÿ

è¯´åˆ°èº«ä»½éªŒè¯ï¼Œæˆ‘ä»¬ç›®å‰æ‹¥æœ‰çš„æœ€ä½³è§£å†³æ–¹æ¡ˆä¹‹ä¸€æ˜¯åŸºäº JWT (JSON Web Token)çš„è§£å†³æ–¹æ¡ˆã€‚

ç®€è€Œè¨€ä¹‹ï¼Œç”¨æˆ·å°†å…¶å‡­è¯äº¤æ¢ä¸ºä»¤ç‰Œï¼Œå¹¶åœ¨éªŒè¯ä¹‹åï¼ŒåŸºäºè¯¥ä»¤ç‰Œå®Œæˆè®¸å¯ã€‚

æœ€å¸¸è§çš„æƒ…å†µæ˜¯å°†è¿™ä¸ªä»¤ç‰Œå‘é€ç»™ç”¨æˆ·ï¼Œç„¶åç”¨æˆ·å°†å®ƒä½œä¸ºæŠ¥å¤´æ·»åŠ åˆ°æ‰€æœ‰æœªæ¥çš„è¯·æ±‚ä¸­ã€‚

è¿™ç§æ–¹æ³•å¾ˆå¥½ï¼Œä½†æ˜¯å®ƒä¸ºæ¼æ´ç•™ä¸‹äº†ç©ºé—´ã€‚å¦‚æœä»¤ç‰Œè¢«å‘é€å›å®¢æˆ·ç«¯ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å°†éœ€è¦å­˜å‚¨åœ¨æœ¬åœ°å­˜å‚¨æˆ– cookies ä¸­ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œ**ç§˜å¯†ä»¤ç‰Œ**æ˜¯å¯ç”¨çš„ï¼Œå¹¶ä¸”å¯ä»¥è¢«åœ¨ä½ çš„ç½‘ç«™ä¸Šè¿è¡Œçš„ä»»ä½• JavaScript ä»£ç è®¿é—®ã€‚

æ›´å¥½çš„æ–¹æ³•æ˜¯ä½¿ä»¤ç‰Œåªèƒ½é€šè¿‡åç«¯ä»£ç è®¿é—®ã€‚è¿™æ ·ï¼Œå®ƒå°±ä¸ä¼šè¢«çªƒå–æˆ–æ“çºµã€‚

![](img/f0665bcdaffc896847b6f104eb7ecfeb.png)

[æ­¤å¤„ä»£ç ](https://carbon.now.sh/?bg=rgba(171%2C%20184%2C%20195%2C%201)&t=monokai&wt=none&l=javascript&ds=true&dsyoff=20px&dsblur=68px&wc=true&wa=true&pv=56px&ph=56px&ln=false&fl=1&fm=Hack&fs=14px&lh=133%25&si=false&es=2x&wm=false&code=%2540Post(%27%252Flogin%27)%250A%2540UseGuards(AuthGuard(%27local%27))%250Aasync%2520login(%2540Request()%2520req%253A%2520any%252C%2520%2540Res()%2520res%253A%2520any)%2520%257B%250A%2520%2520const%2520token%253A%2520string%2520%253D%2520await%2520this.authService.createJwtToken(req.user)%253B%250A%250A%2520%2520res.cookie(%27Authorization%27%252C%2520token%252C%2520%257B%250A%2520%2520%2520%2520expires%253A%2520new%2520Date(new%2520Date().setMonth(new%2520Date().getMonth()%2520%252B%25201))%252C%250A%2520%2520%2520%2520httpOnly%253A%2520true%252C%250A%2520%2520%2520%2520signed%253A%2520true%252C%250A%2520%2520%2520%2520sameSite%253A%2520true%252C%250A%2520%2520%257D)%253B%250A%2520%2520res.send()%253B%250A%257D%250A%250A%2540Get(%27%252Flogout%27)%250Alogout(%2540Res()%2520res%253A%2520any)%2520%257B%250A%2520%2520res.clearCookie(%27Authorization%27)%253B%250A%2520%2520res.send()%253B%250A%257D)

è¿™æ ·å‰ç«¯ä»£ç ç”šè‡³ä¸éœ€è¦è´¹å¿ƒå»ç®¡ç†æ•æ„Ÿæ•°æ®ã€‚

å¦‚æœæœåŠ¡å™¨éœ€è¦ä¿æŠ¤ä¸€äº›è·¯ç”±ï¼Œå¹¶ä½¿å®ƒä»¬åªå¯¹ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·å¯ç”¨ï¼Œé‚£ä¹ˆå®ƒæ‰€è¦åšçš„å°±æ˜¯ä» cookies ä¸­è·å–ä»¤ç‰Œå¹¶éªŒè¯å®ƒã€‚

![](img/066c9afc3b06d8c61a26c4e5580e68e8.png)

ä»£ç [åœ¨è¿™é‡Œ](https://carbon.now.sh/?bg=rgba(171%2C%20184%2C%20195%2C%201)&t=monokai&wt=none&l=javascript&ds=true&dsyoff=20px&dsblur=68px&wc=true&wa=true&pv=56px&ph=56px&ln=false&fl=1&fm=Hack&fs=14px&lh=133%25&si=false&es=2x&wm=false&code=----------------------------protected%2520demo%2520route------------------------------------------%250A%2540Post(%27delete-my-account%27)%250A%2540UsePipes(ValidationPipe)%250A%2540UseGuards(AuthGuard(%27jwt%27)%252C%2520AccountConfirmedGuard)%250Aasync%2520deleteMyAccount(%250A%2520%2520%2540Body()%2520payload%253A%2520DeleteUserAccountDto%252C%250A%2520%2520%2540Request()%2520req%253A%2520any%252C%250A)%2520%257B%257D%250A%250A---------------------------------jwt%2520strategy---------------------------------------------%250Aconst%2520cookieExtractor%2520%253D%2520function(req%253A%2520any)%2520%257B%250A%2520%2520let%2520token%2520%253D%2520null%253B%250A%2520%2520if%2520(req%2520%2526%2526%2520req.signedCookies)%2520%257B%250A%2520%2520%2520%2520token%2520%253D%2520req.signedCookies%255B%27Authorization%27%255D%253B%250A%2520%2520%257D%250A%2520%2520return%2520token%253B%250A%257D%253B%250A%250A%2540Injectable()%250Aexport%2520class%2520JwtStrategy%2520extends%2520PassportStrategy(Strategy)%2520%257B%250Aconstructor(%250A%2520%2520private%2520readonly%2520configService%253A%2520ConfigService%252C%250A%2520%2520private%2520readonly%2520userService%253A%2520UserService%252C%250A)%2520%257B%250A%2520%2520super(%257B%250A%2520%2520%2520%2520jwtFromRequest%253A%2520cookieExtractor%252C%250A%2520%2520%2520%2520ignoreExpiration%253A%2520false%252C%250A%2520%2520%2520%2520secretOrKey%253A%2520configService.get(%27JWT_SECRET%27)%252C%250A%2520%2520%257D)%253B%250A%257D%250A%250A%252F%252F%2520*%2520%2540UseGuards(AuthGuard(%27jwt%27))%2520will%2520call%2520this%2520functions%2520automaticaly%2520%250A%252F%252F%2520*if%2520a%2520valid%2520token%2520is%2520there%2520and%2520it%2520will%2520send%2520as%2520payload%2520the%2520object%2520used%2520to%2520sign%2520the%2520token%250Aasync%2520validate(payload%253A%2520any)%2520%257B%250A%2520%2520const%2520user%253A%2520User%2520%253D%2520await%2520this.userService.findUserById(%257B%250A%2520%2520%2520%2520id%253A%2520payload.userId%252C%250A%2520%2520%257D)%253B%250A%250A%2520%2520if%2520(!user)%2520%257B%250A%2520%2520%2520%2520throw%2520new%2520UnauthorizedException(%27You%2520must%2520be%2520logged%2520in%27)%253B%250A%2520%2520%257D%250A%2520%2520return%2520user%253B%250A%257D%250A%257D%250A)

å¦‚æœå®¢æˆ·ç«¯ä¸æ˜¯æµè§ˆå™¨å‘¢ï¼Ÿ

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘çš„å»ºè®®æ˜¯ä¸ºæ¯ä¸ªåœºæ™¯åˆ›å»ºå¤šä¸ªå…·æœ‰æœ€ä½³è§£å†³æ–¹æ¡ˆçš„ç™»å½•è·¯ç”±ã€‚

## 6.æŒä¹…æ•°æ®(cookiesã€æœ¬åœ°å­˜å‚¨ã€ä¼šè¯å­˜å‚¨)ç®¡ç†

å¦‚æœéœ€è¦åœ¨æµè§ˆå™¨çš„ cookies ä¸­ä¿å­˜ä¸€äº›æ•æ„Ÿæ•°æ®ï¼Œè¯·åˆ©ç”¨è¿™äº›å±æ€§:

*   **httpOnly â€”** å¦‚æœ HTTP å“åº”å¤´ä¸­åŒ…å« httpOnly æ ‡å¿—(å¯é€‰)ï¼Œåˆ™ä¸èƒ½é€šè¿‡å®¢æˆ·ç«¯è„šæœ¬è®¿é—® cookie
*   **å·²ç­¾åâ€”** å¦‚æœåŒ…å«æ­¤æ ‡å¿—ï¼Œé‚£ä¹ˆ cookie å°†æœ‰ä¸€ä¸ªç­¾åï¼Œåç«¯ä»£ç å¯ä»¥æ£€æµ‹å®¢æˆ·ç«¯æ˜¯å¦ä¿®æ”¹äº† cookie
*   **sameSite â€”** å…è®¸æ‚¨å£°æ˜æ‚¨çš„ cookie æ˜¯å¦åº”è¯¥é™äºç¬¬ä¸€æ–¹æˆ–ç›¸åŒç«™ç‚¹çš„ä¸Šä¸‹æ–‡
*   **å®‰å…¨â€”** Cookie å°†ä»…åœ¨ HTTPS ä¼ è¾“ä¸­å‘é€

æœ€ä½³åšæ³•æ˜¯ï¼Œé¿å…ä½¿ç”¨æœ¬åœ°å­˜å‚¨æˆ–ä¼šè¯å­˜å‚¨æ¥å­˜å‚¨æ•æ„Ÿæ•°æ®ã€‚ä»…ä½¿ç”¨æ­¤å­˜å‚¨æ¥ä¿å­˜ä¸€äº›é¦–é€‰é¡¹ã€‚ä¾‹å¦‚ç”¨æˆ·åå¥½çš„ä¸»é¢˜é¢œè‰²ã€‚

## 7.é¿å…åœ¨æ•°æ®åº“æ“ä½œä¸­ä¼ æ’­è¯­æ³•

**ä¸è¦è¿™æ ·ã€‚**

![](img/d6116161e67972312abb6d6f293606c4.png)

[æ­¤å¤„ä»£ç ](https://carbon.now.sh/?bg=rgba(171%2C%20184%2C%20195%2C%201)&t=seti&wt=none&l=javascript&ds=true&dsyoff=20px&dsblur=68px&wc=true&wa=true&pv=56px&ph=56px&ln=false&fl=1&fm=Hack&fs=14px&lh=133%25&si=false&es=2x&wm=false&code=const%2520user%253A%2520IUser%2520%257C%2520undefined%2520%253D%2520await%2520this.userModel%250A%2520%2520.findOne(%257B%2520...payload%2520%257D)%250A%2520%2520.lean()%250A%2520%2520.exec()%253B)

è¿™æ˜¯ XSS æ”»å‡»æˆ–æ³¨å°„æ”»å‡»çš„å®Œç¾åœºæ™¯ã€‚

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ³¨å…¥æ˜¯ web åº”ç”¨ç¨‹åºä¸­æœ€å¸¸è§çš„å®‰å…¨é—®é¢˜ï¼Œæ­£å¦‚ OWASP 10 é¡¹ç›®ä¸­çš„ listenã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯¥æ¼æ´ä¸ä¼šå¸¦æ¥å¦‚æ­¤å¤§çš„é£é™©ï¼Œå› ä¸ºåªæ˜¯ä¸€ä¸ª findOne æ–¹æ³•ã€‚ä½†æ˜¯æƒ³è±¡ä¸€ä¸‹å¦‚æœæ˜¯ **findOneAndUpdate ä¼šæ€ä¹ˆæ ·ã€‚ç”¨æˆ·å¯ä»¥æä¾›ä»–æƒ³è¦çš„ä»»ä½•å‚æ•°ï¼Œå¹¶å¯¹ä»–çš„æ–‡æ¡£è¿›è¡Œä»»ä½•å¯èƒ½çš„ä¿®æ”¹ã€‚ä¾‹å¦‚ç»™è‡ªå·±ç®¡ç†å‘˜æƒé™(å¦‚æœæœ‰çš„è¯)ã€‚**

å¯èƒ½ä¼šæœ‰éœ€è¦åˆ†å¸ƒæŒ‡ç¤ºå™¨çš„åœºæ™¯ï¼Œæ¯”å¦‚æœ‰è®¸å¤šé”®å€¼å¯¹çš„å¤§æ›´æ–°å¯¹è±¡ã€‚å¯¹äºè¿™äº›æƒ…å†µï¼Œè¯·ç¡®ä¿å¯¹è¾“å…¥è¿›è¡Œæ•´ç†å’Œåºåˆ—åŒ–ã€‚

![](img/e7ebf7cca2f4f5ba0cceaecd608727b8.png)

[æ­¤å¤„ä»£ç ](https://carbon.now.sh/?bg=rgba(171%2C%20184%2C%20195%2C%201)&t=seti&wt=none&l=javascript&ds=true&dsyoff=20px&dsblur=68px&wc=true&wa=true&pv=56px&ph=56px&ln=false&fl=1&fm=Hack&fs=14px&lh=133%25&si=false&es=2x&wm=false&code=---------------------controller---------------------%250A%2540Put(%27update-profile%27)%250A%2540UseFilters(MongoExceptionFilter)%250A%2540UsePipes(new%2520ValidationPipe(%257B%2520whitelist%253A%2520true%2520%257D))%250A%2540UseGuards(AuthGuard(%27jwt%27)%252C%2520AccountConfirmedGuard)%250Aasync%2520updateUserProfile(%250A%2520%2520%2540Body()%2520payload%253A%2520UpdateUserProfileDto%252C%250A%2520%2520%2540Request()%2520req%253A%2520any%252C%250A)%2520%257B%257D%250A%250A-----------------DTO------------------------------%250Aexport%2520class%2520UpdateUserProfileDto%2520%257B%250A%2520%2520%2540IsString()%250A%2520%2520%2540IsOptional()%250A%2520%2520firstName%253A%2520string%253B%250A%250A%2520%2520%2540IsString()%250A%2520%2520%2540IsOptional()%250A%2520%2520lastName%253A%2520string%253B%250A%257D)

åœ¨è¿™ç§æƒ…å†µä¸‹

```
@UsePipes(new ValidationPipe({ whitelist: true }))
```

å°†ä½¿ç”¨**updateuser profile to**å¯¹è±¡éªŒè¯æ¥è‡ª**ä¸»ä½“**çš„**æœ‰æ•ˆè´Ÿè½½**ï¼Œå¹¶å°†ç§»é™¤ä»»ä½•é¢å¤–çš„å±æ€§ã€‚

# åŒ…è£¹

æœ‰è®¸å¤šåŸåˆ™å¯ä»¥ç”¨æ¥ä¿æŠ¤æ‚¨çš„ web åº”ç”¨ç¨‹åºã€‚è¯·è®°ä½ï¼Œæœ€é‡è¦çš„æ˜¯æ‚¨çš„ä»£ç å®ç°ã€‚

åœ¨ç¬¬äºŒéƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºå¦‚ä½•ä¿æŠ¤åº”ç”¨ç¨‹åºçš„ç”Ÿäº§ç¯å¢ƒï¼Œè¿™ä¸€éƒ¨åˆ†å°†å¾ˆå¿«æ¨å‡ºï¼Œè¯·åŠ¡å¿…å…³æ³¨æˆ‘çš„æ–‡ç« ï¼Œä»¥å…é”™è¿‡ã€‚

## æ›´æ–°

ç¬¬äºŒéƒ¨åˆ†æ˜¯è¿™é‡Œçš„ã€‚

## æ›´åƒè¿™æ ·

å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œé‚£ä¹ˆçœ‹çœ‹ CPAS çš„å¦ä¸€ç¯‡æ–‡ç« (å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆç³»åˆ—)ï¼›

[](/how-to-deploy-angular-app-in-production-cpas-2-affb711d18fc) [## å¦‚ä½•åœ¨ç”Ÿäº§ä¸­éƒ¨ç½² Angular appâ€”CPAS æ–°åè®®

### äº†è§£å¦‚ä½•åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šéƒ¨ç½²ç”Ÿäº§ç¯å¢ƒä¸­çš„ Angular åº”ç”¨ç¨‹åº

itnext.io](/how-to-deploy-angular-app-in-production-cpas-2-affb711d18fc) [](/remove-elements-from-an-array-recursively-cpas-1-856cc44613c5) [## é€’å½’åœ°ä»æ•°ç»„ä¸­åˆ é™¤ğŸ—‘elementsâ€”CPAs 1

### äº†è§£å¦‚ä½•ä»æ•°ç»„ä¸­ç§»é™¤å¤šä¸ªå…ƒç´ ã€‚

itnext.io](/remove-elements-from-an-array-recursively-cpas-1-856cc44613c5)