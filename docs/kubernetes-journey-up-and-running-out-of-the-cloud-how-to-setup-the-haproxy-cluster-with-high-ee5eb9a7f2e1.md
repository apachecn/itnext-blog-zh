# Kubernetes ä¹‹æ—…â€”å¯åŠ¨å¹¶è¿è¡Œäº‘â€”å¦‚ä½•è®¾ç½®å…·æœ‰é«˜å¯ç”¨æ€§çš„ HAProxy é›†ç¾¤

> åŸæ–‡ï¼š<https://itnext.io/kubernetes-journey-up-and-running-out-of-the-cloud-how-to-setup-the-haproxy-cluster-with-high-ee5eb9a7f2e1?source=collection_archive---------1----------------------->

![](img/622196f8233dce66fdadd1848d671721.png)

Denys Nevozhai åœ¨ [Unsplash](https://unsplash.com/search/photos/high-avaibility?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) ä¸Šæ‹æ‘„çš„ç…§ç‰‡

ä½ å¥½ã€‚æˆ‘ä»¬ç»ˆäºå›åˆ°äº†æˆ‘ä»¬çš„ **Kubernetes ä¹‹æ—…â€”â€”ä»äº‘ä¸­è·‘å‡ºæ¥**ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬ç»ˆäºå¼€å§‹ç€æ‰‹è¿›è¡Œä¸€äº›å®é™…çš„ç¼–ç å’Œé…ç½®ï¼Œæˆ‘å¸Œæœ›ä¿æŒè‰¯å¥½çš„é€Ÿåº¦ï¼Œå‘å¸ƒä¸‹ä¸€ç¯‡æ–‡ç« æ¥å®Œæˆè¿™ä¸€æ—…ç¨‹ã€‚

åœ¨æœ€åä¸€ç¯‡æ–‡ç« çš„[ä¸­ï¼Œæˆ‘ä»¬å·²ç»å¼€å§‹æ‰§è¡Œå°†æ„æˆæˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆçš„ç»„ä»¶çš„å®é™…é…ç½®ã€‚æˆ‘ä»¬å·²ç»é…ç½®äº†æˆ‘ä»¬çš„**ç½‘å…³**å®ä¾‹ä»¥åŠä¸€ä¸ª **BusyBox** å®ä¾‹ï¼Œè¿™å°†å…è®¸æˆ‘ä»¬è¿æ¥åˆ°ç»„æˆæˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆçš„æ‰€æœ‰å®ä¾‹ï¼Œè¿™äº›å®ä¾‹é©»ç•™åœ¨ä¸æˆ‘ä»¬çš„ä¸»æœºä¸åŒçš„ç½‘ç»œä¸­ã€‚](/kubernetes-journey-up-and-running-out-of-the-cloud-starting-the-actual-setup-737c0f3e0fb1)

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨å¦‚ä½•å€ŸåŠ© **Corosync** å’Œ **Pacemaker** ä¸º **kube-apiserver** é…ç½®å…·æœ‰é«˜å¯ç”¨æ€§çš„ **HAProxy é›†ç¾¤**ã€‚åœ¨æˆ‘ä»¬çš„[æŠ€æœ¯å †æ ˆæ–‡ç« ](/kubernetes-journey-up-and-running-out-of-the-cloud-technology-stack-9c472aafac4e)ä¸­ï¼Œæˆ‘ä»¬å·²ç»è°ˆè®ºäº†å¾ˆå¤šå…³äºè¿™äº›ç»„ä»¶çš„å†…å®¹ã€‚è¯·å‚è€ƒå®ƒåˆ·æ–°ã€‚

è¯´å¤Ÿäº†ã€‚è®©æˆ‘ä»¬ç©å¾—å¼€å¿ƒï¼

æœ¬èŠ‚å±•ç¤ºäº†å¦‚ä½•è®¾ç½®ç”±æµ®åŠ¨ IP å’Œ[**Corosync**](https://clusterlabs.org/corosync.html)/[**å®šæ‹å™¨**](https://clusterlabs.org/pacemaker/) é›†ç¾¤å †æ ˆæ”¯æŒçš„é«˜å¯ç”¨æ€§ **HAProxy è´Ÿè½½å¹³è¡¡å™¨**ã€‚

æµ®åŠ¨ IP ä¹Ÿç§°ä¸ºâ€œå…±äº«â€æˆ–â€œè™šæ‹Ÿâ€IP åœ°å€ã€‚æµ®åŠ¨ IP æ˜¯åˆ†é…ç»™æœ€ç»ˆå¯èƒ½å‡ºç°æ•…éšœçš„èŠ‚ç‚¹çš„æ­£å¸¸ IP åœ°å€ã€‚å¯¹äºæ•…éšœè½¬ç§»ï¼Œå…·æœ‰ç›¸ä¼¼ç‰¹å¾(è¢«åŠ¨)çš„èŠ‚ç‚¹ä¸ä¸»(ä¸»åŠ¨)èŠ‚ç‚¹ä¸€èµ·ä»¥ä¸»åŠ¨/è¢«åŠ¨æ¨¡å¼è¿è¡Œã€‚å¦‚æœå‘ç”Ÿæ•…éšœï¼Œè¿™ä¸ªæµ®åŠ¨ IP å°†è‡ªåŠ¨é€æ˜åœ°åˆ†é…ç»™è¢«åŠ¨èŠ‚ç‚¹ï¼Œä½¿å…¶æˆä¸ºä¸»åŠ¨èŠ‚ç‚¹ï¼Œé¿å…åœæœºã€‚

æ¯ä¸ª **HAProxy** è´Ÿè½½å¹³è¡¡å™¨å°†è¢«é…ç½®ä¸ºåœ¨ **kube-apiserver** ä¹‹é—´åˆ†å‰²æµé‡ã€‚å¦‚æœä¸»è´Ÿè½½å‡è¡¡å™¨å…³é—­ï¼Œ**æµ®åŠ¨ IP** å°†è‡ªåŠ¨ç§»åŠ¨åˆ°ç¬¬äºŒä¸ªè´Ÿè½½å‡è¡¡å™¨ï¼Œå…è®¸å®ƒç»§ç»­æœåŠ¡è€Œä¸åœæœºã€‚

![](img/0320ae403f6a6f89875c318acdec2c64.png)

å¦‚æœä½ ä¸æƒ³ç­‰åˆ°æ‰€æœ‰çš„æ–‡ç« éƒ½å‘è¡¨äº†ï¼Œåˆæƒ³é©¬ä¸ŠåŠ¨æ‰‹ï¼Œå¯ä»¥éšæ„å…‹éš†é¡¹ç›®çš„ Github repoã€‚å®ƒå®Œå…¨å®ç”¨ï¼Œæ–‡æ¡£ä¹Ÿåœ¨ä¸æ–­æ”¹è¿›ã€‚

[](https://github.com/mvallim/kubernetes-under-the-hood) [## ç½©ä¸‹çš„å§†ç“¦åˆ©å§†/åº“ä¼¯å†…ç‰¹æ–¯

### å®ƒç”šè‡³è¿˜åŒ…æ‹¬ä¸€å¼ å¹»ç¯ç‰‡ï¼Œè§£é‡Šäº†å®ƒå¸å¼•ç›®æ ‡å—ä¼—çš„åŸå› â€¦

github.com](https://github.com/mvallim/kubernetes-under-the-hood) 

# HAProxy

*â€œha proxy æ˜¯ä¸€ä¸ªå…è´¹çš„ã€éå¸¸å¿«é€Ÿå’Œå¯é çš„è§£å†³æ–¹æ¡ˆï¼Œä¸ºåŸºäº TCP å’Œ HTTP çš„åº”ç”¨ç¨‹åºæä¾›é«˜å¯ç”¨æ€§ã€è´Ÿè½½å¹³è¡¡å’Œä»£ç†ã€‚å®ƒç‰¹åˆ«é€‚ç”¨äºé«˜æµé‡çš„ç½‘ç«™ï¼Œå¹¶ä¸ºä¸–ç•Œä¸Šè®¸å¤šè®¿é—®é‡æœ€å¤§çš„ç½‘ç«™æä¾›æ”¯æŒã€‚å¤šå¹´æ¥ï¼Œå®ƒå·²ç»æˆä¸ºäº‹å®ä¸Šçš„æ ‡å‡†å¼€æºè´Ÿè½½å¹³è¡¡å™¨ï¼Œç°åœ¨ä¸å¤§å¤šæ•°ä¸»æµ Linux å‘è¡Œç‰ˆä¸€èµ·æä¾›ï¼Œå¹¶ä¸”é€šå¸¸é»˜è®¤éƒ¨ç½²åœ¨äº‘å¹³å°ä¸­ã€‚å› ä¸ºå®ƒä¸åšå¹¿å‘Šï¼Œæˆ‘ä»¬åªçŸ¥é“å®ƒåœ¨ç®¡ç†å‘˜æŠ¥å‘Šæ—¶è¢«ä½¿ç”¨:-)"*

> å‚è€ƒ:[http://www.haproxy.org/](http://www.haproxy.org/)
> *å®Œæ•´è§£é‡Šåœ¨æˆ‘ä»¬çš„* [*æŠ€æœ¯æ ˆ*](/kubernetes-journey-up-and-running-out-of-the-cloud-technology-stack-9c472aafac4e) *ä¸­ã€‚*

# ç§‘ç½— sync

Corosync é›†ç¾¤å¼•æ“æ˜¯ä¸€ä¸ªç»„é€šä¿¡ç³»ç»Ÿï¼Œå…·æœ‰åœ¨åº”ç”¨ç¨‹åºä¸­å®ç°é«˜å¯ç”¨æ€§çš„é™„åŠ åŠŸèƒ½ã€‚è¯¥é¡¹ç›®æä¾›äº†å››ä¸ª C åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ç‰¹æ€§:

*   ç”¨äºåˆ›å»ºå¤åˆ¶çŠ¶æ€æœºçš„å…·æœ‰æ‰©å±•è™šæ‹ŸåŒæ­¥ä¿è¯çš„å°é—­è¿›ç¨‹ç»„é€šä¿¡æ¨¡å‹ã€‚
*   ä¸€ä¸ªç®€å•çš„å¯ç”¨æ€§ç®¡ç†å™¨ï¼Œå®ƒåœ¨åº”ç”¨ç¨‹åºå¤±è´¥æ—¶é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚
*   ä¸€ä¸ªé…ç½®å’Œç»Ÿè®¡å†…å­˜æ•°æ®åº“ï¼Œæä¾›è®¾ç½®ã€æ£€ç´¢å’Œæ¥æ”¶ä¿¡æ¯æ›´æ”¹é€šçŸ¥çš„èƒ½åŠ›ã€‚
*   å½“è¾¾åˆ°æˆ–å¤±å»ä»²è£æ—¶é€šçŸ¥åº”ç”¨ç¨‹åºçš„ä»²è£ç³»ç»Ÿã€‚

> *å®Œæ•´è§£é‡Šåœ¨æˆ‘ä»¬çš„* [*æŠ€æœ¯æ ˆ*](/kubernetes-journey-up-and-running-out-of-the-cloud-technology-stack-9c472aafac4e) *ä¸­ã€‚*

# èµ·æå™¨

Pacemaker æ˜¯ä¸€ä¸ªé«˜çº§çš„ã€å¯ä¼¸ç¼©çš„é«˜å¯ç”¨æ€§é›†ç¾¤èµ„æºç®¡ç†å™¨ã€‚

å®ƒæ”¯æŒâ€œN èŠ‚ç‚¹â€é›†ç¾¤ï¼Œå…·æœ‰ç®¡ç†èµ„æºå’Œä¾èµ–å…³ç³»çš„å¼ºå¤§åŠŸèƒ½ã€‚

å®ƒå°†åœ¨åˆå§‹åŒ–æ—¶ã€æœºå™¨å¯åŠ¨æˆ–å…³é—­æ—¶ã€ç›¸å…³èµ„æºå‡ºç°æ•…éšœæ—¶è¿è¡Œè„šæœ¬ï¼Œå¹¶ä¸”å¯ä»¥é…ç½®ä¸ºå®šæœŸæ£€æŸ¥èµ„æºå¥åº·çŠ¶å†µã€‚

> *å®Œæ•´è§£é‡Šåœ¨æˆ‘ä»¬çš„* [*æŠ€æœ¯æ ˆ*](/kubernetes-journey-up-and-running-out-of-the-cloud-technology-stack-9c472aafac4e) *ä¸­ã€‚*

## èµ„æºä»£ç†

èµ„æºä»£ç†æ˜¯å…è®¸ Pacemaker ç®¡ç†å®ƒä¸€æ— æ‰€çŸ¥çš„æœåŠ¡çš„æŠ½è±¡ã€‚å®ƒä»¬åŒ…å«å½“é›†ç¾¤å¸Œæœ›å¯åŠ¨ã€åœæ­¢æˆ–æ£€æŸ¥æœåŠ¡çš„å¥åº·çŠ¶å†µæ—¶è¯¥åšä»€ä¹ˆçš„é€»è¾‘ã€‚

`**ocf:heartbeat:IPaddr2**`

è¿™ä¸ªç‰¹å®šäº Linux çš„èµ„æºç®¡ç† IP åˆ«å IP åœ°å€ã€‚å®ƒå¯ä»¥æ·»åŠ æˆ–åˆ é™¤ä¸€ä¸ª IP åˆ«åã€‚æ­¤å¤–ï¼Œå¦‚æœä½œä¸ºå…‹éš†èµ„æºè°ƒç”¨ï¼Œå®ƒè¿˜å¯ä»¥å®ç°ç¾¤é›†åˆ«å IP åŠŸèƒ½ã€‚

> *æ›´å¤šä¿¡æ¯*[*http://linux-ha.org/doc/man-pages/re-ra-IPaddr2.html*](http://linux-ha.org/doc/man-pages/re-ra-IPaddr2.html)

`**ocf:heartbeat:haproxy**`

åœ¨é«˜å¯ç”¨æ€§è®¾ç½®ä¸­å°† haproxy å®ˆæŠ¤ç¨‹åºä½œä¸º OCF èµ„æºè¿›è¡Œç®¡ç†ã€‚

> *æ›´å¤šä¿¡æ¯*[*https://raw . githubusercontent . com/russki/cluster-agents/master/ha proxy*](https://raw.githubusercontent.com/russki/cluster-agents/master/haproxy)

# åˆ›å»ºè™šæ‹Ÿæœº

```
~/kubernetes-under-the-hood$ for instance in hapx-node01 hapx-node02; do \
./create-image.sh \
   -k ~/.ssh/id_rsa.pub \
   -u hapx/user-data \
   -n hapx/network-config \
   -i hapx/post-config-interfaces \
   -r hapx/post-config-resources \
   -o ${instance} \
   -l debian \
   -b debian-base-image done
```

# å› ç´ 

*   `**-k**`ç”¨äºå°†**å…¬é’¥**ä»æ‚¨çš„ä¸»æœºå¤åˆ¶åˆ°æ–°åˆ›å»ºçš„è™šæ‹Ÿæœºã€‚
*   `**-u**`ç”¨äºæŒ‡å®š**ç”¨æˆ·æ•°æ®**æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†ä½œä¸ºå‚æ•°ä¼ é€’ç»™åˆ›å»ºæˆ‘ä»¬ä¹‹å‰æåˆ°çš„ cloud-init ISO æ–‡ä»¶çš„å‘½ä»¤(æŸ¥çœ‹è„šæœ¬çš„æºä»£ç ä»¥æ›´å¥½åœ°ç†è§£å®ƒçš„ç”¨æ³•)ã€‚é»˜è®¤ä¸º'**/æ•°æ®/ç”¨æˆ·æ•°æ®**'ã€‚
*   `**-m**`ç”¨äºæŒ‡å®š**å…ƒæ•°æ®**æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†ä½œä¸ºå‚æ•°ä¼ é€’ç»™åˆ›å»ºæˆ‘ä»¬ä¹‹å‰æåˆ°çš„ cloud-init ISO æ–‡ä»¶çš„å‘½ä»¤(æŸ¥çœ‹è„šæœ¬çš„æºä»£ç ä»¥æ›´å¥½åœ°ç†è§£å®ƒçš„ç”¨æ³•)ã€‚é»˜è®¤ä¸ºâ€œ**/æ•°æ®/å…ƒæ•°æ®**â€ã€‚
*   `**-n**`ç”¨äºä¼ é€’é…ç½®æ–‡ä»¶ï¼Œcloud-init å°†ä½¿ç”¨è¯¥æ–‡ä»¶ä¸ºå®ä¾‹é…ç½®**ç½‘ç»œ**ã€‚
*   `**-i**`ç”¨äºä¼ é€’ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬çš„è„šæœ¬å°†ä½¿ç”¨è¯¥æ–‡ä»¶ä¿®æ”¹ç”± **VirtualBox** ç®¡ç†çš„**ç½‘ç»œæ¥å£**ï¼Œè¯¥æ¥å£è¿æ¥åˆ°å°†ä»è¯¥æ˜ åƒåˆ›å»ºçš„å®ä¾‹ã€‚
*   `**-r**`ç”¨äºä¼ é€’ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬çš„è„šæœ¬å°†ä½¿ç”¨è¯¥æ–‡ä»¶æ¥é…ç½®ç”± **VirtualBox** åˆ†é…ç»™æˆ‘ä»¬å®ä¾‹çš„**æ•°é‡çš„å¤„ç†å™¨å’Œ**æ•°é‡çš„å†…å­˜ã€‚
*   `**-o**`ç”¨äºä¼ é€’å°†åˆ†é…ç»™æˆ‘ä»¬å®ä¾‹çš„**ä¸»æœºå**ã€‚è¿™ä¹Ÿå°†æ˜¯ **VirtualBox** ç”¨æ¥å¼•ç”¨æˆ‘ä»¬çš„å®ä¾‹çš„åç§°ã€‚
*   `**-l**`ç”¨äºé€šçŸ¥æˆ‘ä»¬è¦ä½¿ç”¨å“ªä¸ª Linux å‘è¡Œç‰ˆ( **debian** æˆ– **ubuntu** )é…ç½®æ–‡ä»¶(æ³¨æ„è¿™æ˜¯ç”¨æ¥æŒ‡å®š[æ•°æ®](https://github.com/mvallim/kubernetes-under-the-hood/blob/master/data)ä¸‹çš„å“ªä¸ªæ–‡ä»¶å¤¹è¢«å¼•ç”¨)ã€‚é»˜è®¤ä¸º' **debian** 'ã€‚
*   `**-b**`ç”¨äºæŒ‡å®šåº”è¯¥ä½¿ç”¨å“ªä¸ª**åŸºç¡€å›¾åƒ**ã€‚è¿™æ˜¯æˆ‘ä»¬æ‰§è¡Œä¸Šä¸€ç¯‡æ–‡ç« ä¸­çš„å®‰è£…æ­¥éª¤æ—¶ï¼Œåœ¨ **VirtualBox** ä¸Šåˆ›å»ºçš„æ˜ åƒåç§°ã€‚
*   `**-s**`ç”¨äºä¼ é€’ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬çš„è„šæœ¬å°†ä½¿ç”¨è¯¥æ–‡ä»¶åœ¨ **VirtualBox** ä¸Šé…ç½®**è™šæ‹Ÿç£ç›˜**ã€‚ä½ ä¼šæ³¨æ„åˆ°è¿™ä»…ç”¨äº **Gluster** é…ç½®æ­¥éª¤ã€‚
*   `**-a**`æˆ‘ä»¬çš„å®ä¾‹**åˆ›å»ºåæ˜¯å¦åº”è¯¥åˆå§‹åŒ–**ã€‚é»˜è®¤ä¸º**çœŸ**ã€‚

**é¢„æœŸè¾“å‡º:**

```
Total translation table size: 0
Total rockridge attributes bytes: 417
Total directory bytes: 0
Path table size(bytes): 10
Max brk space used 0
187 extents written (0 MB)
0%...10%...20%...30%...40%...50%...60%...70%...80%...90%...100%
Machine has been successfully cloned as "hapx-node01"
Waiting for VM "hapx-node01" to power on...
VM "hapx-node01" has been successfully started.
Total translation table size: 0
Total rockridge attributes bytes: 417
Total directory bytes: 0
Path table size(bytes): 10
Max brk space used 0
187 extents written (0 MB)
0%...10%...20%...30%...40%...50%...60%...70%...80%...90%...100%
Machine has been successfully cloned as "hapx-node02"
Waiting for VM "hapx-node02" to power on...
VM "hapx-node02" has been successfully started.
```

## é…ç½®æ‚¨çš„æœ¬åœ°è·¯ç”±

æ‚¨éœ€è¦åœ¨æœ¬åœ°è®¡ç®—æœºä¸Šæ·»åŠ ä¸€ä¸ªè·¯ç”±æ¥è®¿é—® Virtualbox å†…éƒ¨ç½‘ç»œã€‚

```
sudo ip route add 192.168.4.0/27 via 192.168.4.30 dev vboxnet0

sudo ip route add 192.168.4.32/27 via 192.168.4.62 dev vboxnet0
```

## è®¿é—® BusyBox

æˆ‘ä»¬éœ€è¦è®© BusyBox IP é€šè¿‡ ssh è®¿é—®å®ƒ:

```
vboxmanage guestproperty get busybox "/VirtualBox/GuestInfo/Net/0/V4/IP"
```

é¢„æœŸäº§å‡º:

```
Value: 192.168.4.57
```

ä½¿ç”¨è¿”å›å€¼é€šè¿‡ ssh è®¿é—®è™šæ‹Ÿæœº:

```
~$ ssh debian@192.168.4.57
```

é¢„æœŸäº§å‡º:

```
Linux busybox 4.9.0-11-amd64 #1 SMP Debian 4.9.189-3+deb9u2 (2019-11-11) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
```

# **è®¿é—® HAProxy èŠ‚ç‚¹**

è®¿é—® BusyBox å¹¶è¿›å…¥ ssh ä¼šè¯åï¼Œåªéœ€æŒ‰åç§°è®¿é—®å®ä¾‹ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›è®¿é—® hapx-node01ã€‚

```
debian@busybox:~$ ssh hapx-node01
```

# é…ç½®èµ·æå™¨

åœ¨è¿›è¡Œèµ·æå™¨é…ç½®ä¹‹å‰ï¼Œæœ‰å¿…è¦è¿›è¡Œä¸€äº›è§‚å¯Ÿã€‚

***1*** â€”è®©æˆ‘ä»¬æ£€æŸ¥ IP é…ç½®ï¼Œä½¿ç”¨`ip addr`:

```
debian@hapx-node01:~$ ip addr show enp0s3.41

3: enp0s3.41@enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 08:00:27:a4:ce:07 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::a00:27ff:fea4:ce07/64 scope link
      valid_lft forever preferred_lft forever
```

å¦‚æ‚¨æ‰€è§ï¼Œæˆ‘ä»¬ä»ç„¶æ²¡æœ‰åœ¨ä»»ä½•ç½‘ç»œæ¥å£ä¸Šé…ç½®é›†ç¾¤çš„ IP ( `192.168.4.20`)ã€‚

***2*** â€”è®©æˆ‘ä»¬ä½¿ç”¨`crm status`æ£€æŸ¥èµ·æå™¨é…ç½®

```
debian@hapx-node01:~$ sudo crm status

Stack: corosync
Current DC: hapx-node02 (version 1.1.16-94ff4df) - partition with quorum
Last updated: Sun Feb  2 19:53:25 2020
Last change: Sun Feb  2 19:51:43 2020 by hacluster via crmd on hapx-node02

2 nodes configured
0 resources configured

Online: [ hapx-node01 hapx-node02 ]

No resources
```

è¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ°æˆ‘ä»¬åªæœ‰ä¸¤ä¸ªæ´»åŠ¨çš„å’Œå·²é…ç½®çš„èŠ‚ç‚¹(`hapx-node01`å’Œ`hapx-node02`)ï¼Œä½†æ˜¯æ²¡æœ‰èµ„æºæ¥ç»„æˆæˆ‘ä»¬çš„é›†ç¾¤(`virtual-ip-resource`å’Œ`haproxy-resource`)ã€‚

***3*** â€”è®©æˆ‘ä»¬ä½¿ç”¨`crm configure`é…ç½®èµ·æå™¨ä¸Šçš„èµ„æº

è¿™é‡Œæˆ‘ä»¬å°†è™šæ‹Ÿ IP å®šä¹‰ä¸º`192.168.4.20`ã€‚è¿™å°†æ˜¯æˆ‘ä»¬çš„ K8S ç¾¤é›†(æ§åˆ¶å¹³é¢ç«¯ç‚¹)çš„ IP åœ°å€ã€‚

æ­¤æ—¶ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ [crmsh](https://crmsh.github.io/) å·¥å…·é…ç½®æˆ‘ä»¬çš„ **HAProxy é›†ç¾¤**çš„ç‰¹æ€§ã€‚crmsh æ˜¯ Pacemaker é«˜å¯ç”¨æ€§å †æ ˆçš„é›†ç¾¤ç®¡ç†å¤–å£³ã€‚

ä»¥ä¸‹æ­¥éª¤å¯ä»¥åœ¨ä»»ä½•èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œå› ä¸ºç°åœ¨ Corosync åº”è¯¥ä¿æŒé›†ç¾¤é…ç½®åŒæ­¥ã€‚

> **æ³¨**:ä¸‹é¢æ¯ä¸€è¡Œä»£è¡¨ä¸€ä¸ªå‘½ä»¤ï¼Œåº”è¯¥åœ¨å‘½ä»¤è¡Œå•ç‹¬è¾“å…¥ã€‚

```
debian@hapx-node01:~$ cat <<EOF | sudo crm configure
property stonith-enabled=no
property no-quorum-policy=ignore
property default-resource-stickiness=100
primitive virtual-ip-resource ocf:heartbeat:IPaddr2 params ip="192.168.4.20" broadcast=192.168.4.31 nic=enp0s3.41 cidr_netmask=27 meta migration-threshold=2 op monitor interval=20 timeout=60 on-fail=restart
primitive haproxy-resource ocf:heartbeat:haproxy op monitor interval=20 timeout=60 on-fail=restart
colocation loc inf: virtual-ip-resource haproxy-resource
order ord inf: virtual-ip-resource haproxy-resource
commit
bye
EOF
```

***4*** â€”è®©æˆ‘ä»¬ä½¿ç”¨`ip addr`å†æ¬¡æ£€æŸ¥æˆ‘ä»¬çš„ IP é…ç½®:

```
debian@hapx-node01:~$ ip addr show enp0s3.413: enp0s3.41@enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 08:00:27:a4:ce:07 brd ff:ff:ff:ff:ff:ff
    inet 192.168.4.20/27 brd 192.168.4.31 scope global enp0s3.41
      valid_lft forever preferred_lft forever
    inet6 fe80::a00:27ff:fea4:ce07/64 scope link
      valid_lft forever preferred_lft forever
```

ç§å•Šã€‚ç°åœ¨ï¼Œæˆ‘ä»¬çš„é›†ç¾¤çš„ IP å·²ç»åœ¨`enp0s3.41`ç•Œé¢ä¸­æ­£ç¡®é…ç½®å’Œç®¡ç†äº†ã€‚

***5*** â€”è®©æˆ‘ä»¬ä½¿ç”¨`crm status`ä»æˆ‘ä»¬çš„é›†ç¾¤ä¸­è·å¾—æ›´å¤šä¿¡æ¯:

```
debian@hapx-node01:~$ sudo crm statusStack: corosync
Current DC: hapx-node01 (version 1.1.16-94ff4df) - partition with quorum
Last updated: Sun Feb  2 19:19:16 2020
Last change: Sun Feb  2 19:04:37 2020 by root via cibadmin on hapx-node012 nodes configured
2 resources configuredOnline: [ hapx-node01 hapx-node02 ]Full list of resources:virtual-ip-resource    (ocf::heartbeat:IPaddr2):       Started hapx-node01
haproxy-resource       (ocf::heartbeat:haproxy):       Started hapx-node01
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°èŠ‚ç‚¹å’Œèµ„æºéƒ½å¤„äºæ´»åŠ¨çŠ¶æ€å¹¶å·²é…ç½®å¥½ã€‚

ä»”ç»†è§‚å¯Ÿï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°`hapx-node01`èŠ‚ç‚¹å°±æ˜¯åˆ†é…äº†è¿™ä¸¤ä¸ªèµ„æº(`virtual-ip-resource`å’Œ`haproxy-resource`)çš„èŠ‚ç‚¹ã€‚è¿™éå¸¸åˆç†ï¼Œå› ä¸ºæˆ‘ä»¬å°†è¿™äº›èµ„æºé…ç½®ä¸ºæ€»æ˜¯åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šåˆ†é…ã€‚

**èµ·æå™¨å‚æ•°è§£é‡Š(TLï¼›åšå£«):**

*   `property stonith-enabled=no`

`STONITH`å…·æœ‰ä¿æŠ¤æ‚¨çš„æ•°æ®å…å—æŸåå’Œåº”ç”¨ç¨‹åºå› å¤šä¸ªèŠ‚ç‚¹åŒæ—¶æ— æ„è®¿é—®è€Œä¸å¯ç”¨çš„åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œä»…ä»…å› ä¸ºä¸€ä¸ªèŠ‚ç‚¹æ²¡æœ‰å“åº”ï¼Œå¹¶ä¸æ„å‘³ç€å®ƒå·²ç»åœæ­¢è®¿é—®å…¶æ•°æ®ã€‚100%ç¡®ä¿æ‚¨çš„æ•°æ®å®‰å…¨çš„å”¯ä¸€æ–¹æ³•æ˜¯ï¼Œåœ¨å…è®¸å¦ä¸€ä¸ªèŠ‚ç‚¹è®¿é—®æ•°æ®ä¹‹å‰ï¼Œç¡®ä¿è¯¥èŠ‚ç‚¹ç¡®å®å¤„äºç¦»çº¿çŠ¶æ€ã€‚
`STONITH`ä¹Ÿåœ¨æœåŠ¡æ— æ³•åœæ­¢çš„æƒ…å†µä¸‹å‘æŒ¥ä½œç”¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé›†ç¾¤ä½¿ç”¨`STONITH`å¼ºåˆ¶èŠ‚ç‚¹ç¦»çº¿ï¼Œä»è€Œå¯ä»¥å®‰å…¨åœ°åœ¨å…¶ä»–åœ°æ–¹å¯åŠ¨æœåŠ¡ã€‚

`STONITH`æ˜¯â€œå°„ä¸­å¯¹æ–¹å¤´éƒ¨â€çš„ç¼©å†™ï¼Œæ˜¯æœ€æµè¡Œçš„æ•°æ®ä¿æŠ¤æœºåˆ¶ã€‚
ä¸ºç¡®ä¿æ‚¨æ•°æ®çš„å®Œæ•´æ€§ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šæ¿€æ´»`STONITH`ã€‚
åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œç”±äºæˆ‘ä»¬æ—¢ä¸è®¿é—®æ•°æ®åº“ä¹Ÿä¸è®¿é—®æ–‡ä»¶ç­‰æ•°æ®ï¼Œä¿æŒ`STONITH`æ´»åŠ¨æ²¡æœ‰æ„ä¹‰ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†å…¶è®¾ç½®ä¸º`stonith-enabled=no`

*   `property no-quorum-policy=ignore`

`no-quorum-policy`å‚æ•°å†³å®šäº†å½“æ²¡æœ‰è¶³å¤Ÿçš„èŠ‚ç‚¹ç»„æˆé›†ç¾¤æ—¶é›†ç¾¤çš„è¡Œä¸ºã€‚ä¸ºäº†é¿å…å‡ºç°[è£‚è„‘](https://en.wikipedia.org/wiki/Split-brain_(computing))æƒ…å†µï¼Œé›†ç¾¤å°†ä»…åœ¨è¾¾åˆ°æ³•å®šäººæ•°æ—¶æ‰åšå‡ºå“åº”ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå‡è®¾ä¸€ä¸ªé›†ç¾¤æœ‰äº”ä¸ªèŠ‚ç‚¹ï¼Œç”±äºç½‘ç»œæ•…éšœï¼Œåˆ›å»ºäº†ä¸¤ä¸ªç‹¬ç«‹çš„ç»„:ä¸€ä¸ªç»„æœ‰ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œå¦ä¸€ä¸ªç»„æœ‰ä¸¤ä¸ªèŠ‚ç‚¹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåªæœ‰å…·æœ‰ä¸‰ä¸ªèŠ‚ç‚¹çš„ç»„èƒ½å¤Ÿè·å¾—å¤šæ•°ç¥¨ã€‚å› æ­¤ï¼Œåªæœ‰åŒ…å«ä¸‰ä¸ªèŠ‚ç‚¹çš„ç»„æ‰èƒ½åˆ©ç”¨ç¾¤é›†èµ„æºã€‚è¿™ç§é…ç½®éå¸¸é‡è¦ï¼Œå› ä¸ºå¦‚æœåªæœ‰ä¸¤ä¸ªèŠ‚ç‚¹çš„ç»„ä¹Ÿèƒ½å¤Ÿä½¿ç”¨å®ƒä»¬ï¼Œå°±ä¼šæœ‰èµ„æºæŸåçš„é£é™©ã€‚`no-quorum-policy`å‚æ•°çš„é»˜è®¤å€¼æ˜¯`stop`ã€‚

åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åªæœ‰ä¸¤ä¸ªèŠ‚ç‚¹ã€‚å› æ­¤ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªç”±äºä»»ä½•åŸå› ç¦»çº¿ï¼Œæˆ‘ä»¬çš„æ•´ä¸ªé›†ç¾¤å°†ç”±äºç¼ºå°‘æ³•å®šäººæ•°(> 50%)è€Œåœæ­¢è¿è¡Œã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å°†ç­–ç•¥é…ç½®ä¸º`ignore`ï¼Œä¸éœ€è¦åšä»»ä½•å…¶ä»–äº‹æƒ…ã€‚åœ¨ç”Ÿäº§åœºæ™¯ä¸­ï¼Œæœ€å¥½è‡³å°‘æœ‰ 3 ä¸ªèŠ‚ç‚¹ï¼Œä»¥ç¡®ä¿æ›´é«˜çš„å¯ç”¨æ€§ã€‚

*   `property default-resource-stickiness=100`

`default-resource-stickiness`å†³å®šäº†é›†ç¾¤èµ„æºå°†è¢«åˆ†é…åˆ°å“ªé‡Œã€‚é»˜è®¤è¡Œä¸ºæ˜¯å°†èµ„æºæ”¾å›å®ƒä»¬è¢«åˆ†é…åˆ°çš„åŸå§‹èŠ‚ç‚¹ã€‚è¿™æ„å‘³ç€ï¼Œå‡ºç°æ•…éšœåï¼Œèµ„æºå°†è¢«åˆ†é…åˆ°é›†ç¾¤ä¸­çš„å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå½“åŸå§‹èŠ‚ç‚¹æ¢å¤æ­£å¸¸çŠ¶æ€æ—¶ï¼Œèµ„æºå°†è¢«ç§»å›è¯¥èŠ‚ç‚¹ã€‚è¿™å¹¶ä¸ç†æƒ³ï¼Œå› ä¸ºç”¨æˆ·å°†ä¸¤æ¬¡é¢ä¸´ä¸ä¸€è‡´çš„åœºæ™¯ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæ‚¨å¯ä»¥ä¸º`default-resource-stickiness`å‚æ•°è®¾ç½®ä¸€ä¸ªæƒé‡(åœ¨-1.000.000 å’Œ 1.000.000 ä¹‹é—´):`0`æ„å‘³ç€èµ„æºå°†è¢«ç§»å›å…¶åŸå§‹èŠ‚ç‚¹ï¼›æ­£å€¼è¡¨ç¤ºèµ„æºåº”è¯¥ä¿ç•™åœ¨åŸæ¥çš„ä½ç½®ã€‚

åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä»»æ„å°†å…¶è®¾ç½®ä¸º`100`ã€‚

*   `primitive virtual-ip-resource ocf:heartbeat:IPaddr2 params ip="192.168.4.20" broadcast=192.168.4.31 nic=enp0s3.41 cidr_netmask=27 meta migration-threshold=2 op monitor interval=20 timeout=60 on-fail=restart`

`primitive` -è¡¨ç¤ºåº”è¯¥ä½œä¸ºå•ä¸ªå®ä¾‹å­˜åœ¨äºæ•´ä¸ªé›†ç¾¤ä¸­çš„èµ„æºã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª IP å¯ä»¥è¢«é…ç½®ä¸ºä¸€ä¸ªåŸå§‹èµ„æºï¼Œå¹¶ä¸”åœ¨ä»»ä½•ç»™å®šçš„æ—¶é—´é›†ç¾¤ä¸­åº”è¯¥åªæœ‰ä¸€ä¸ªè¯¥èµ„æºçš„å®ä¾‹ã€‚

`virtual-ip-resource` -æˆ‘ä»¬ç»™æˆ‘ä»¬çš„èµ„æºèµ·çš„ä¸€ä¸ªç‹¬ç‰¹çš„åå­—ã€‚

`ocf:heartbeat:IPaddr2`-OCF é›†ç¾¤èµ„æºä»£ç†ã€‚

`meta migration-threshold` -åˆ›å»ºèµ„æºæ—¶ï¼Œæ‚¨å¯ä»¥å°†å…¶é…ç½®ä¸ºåœ¨ç»™å®šæ•°é‡çš„æ•…éšœå‘ç”Ÿåç§»åŠ¨åˆ°ä¸åŒçš„èŠ‚ç‚¹ã€‚è¯¥å‚æ•°ç”¨äºæ­¤ç›®çš„ã€‚è¾¾åˆ°é™åˆ¶åï¼Œå½“å‰èŠ‚ç‚¹å°†æ— æ³•æ‹¥æœ‰èµ„æºï¼Œç›´åˆ°å‘ç”Ÿä»¥ä¸‹æƒ…å†µä¹‹ä¸€

ç®¡ç†å‘˜é‡ç½®èµ„æºçš„`failcount`å€¼ã€‚
â—‹è¾¾åˆ°èµ„æºçš„`failure-timeout`å€¼ã€‚
â—‹é»˜è®¤`migration-threshold`ä¸º`INFINITY`ã€‚åœ¨å†…éƒ¨ï¼Œè¿™è¢«å®šä¹‰ä¸ºä¸€ä¸ªéå¸¸é«˜ä½†æœ‰é™çš„å€¼ã€‚å°†æ­¤é¡¹è®¾ç½®ä¸º 0 å°†ç¦ç”¨ç»™å®šèµ„æºçš„é˜ˆå€¼è¡Œä¸ºã€‚

*   `params` -èµ„æºä»£ç†çš„å‚æ•°:

`ip`-IP v4 åœ°å€ä»¥å››ç‚¹ç¬¦å·é…ç½®ï¼Œä¾‹å¦‚â€œ192.168.1.1â€ã€‚(å¿…éœ€ï¼Œå­—ç¬¦ä¸²ï¼Œæ— é»˜è®¤å€¼)

`nic`-IP åœ°å€å°†åœ¨å…¶ä¸Šè”æœºçš„åŸºæœ¬ç½‘ç»œæ¥å£ã€‚å¦‚æœç•™ç©ºï¼Œè„šæœ¬å°†å°è¯•ä»è·¯ç”±è¡¨ä¸­ç¡®å®šè¿™ä¸€ç‚¹ã€‚ä¸è¦åœ¨æ­¤å¤„ä»¥`eth0:1`æˆ–ä»»ä½•å½¢å¼æŒ‡å®šåˆ«åæ¥å£ï¼›ç›¸åï¼Œè¯·ä»…æŒ‡å®šåŸºæ¥å£ã€‚å‰ææ¡ä»¶:å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªé™æ€ IP åœ°å€åˆ†é…ç»™ç½‘ç»œæ¥å£ï¼Œè¯¥åœ°å€ä¸ç”±ç¾¤é›†ç®¡ç†ã€‚å¦‚æœæ‚¨ä¸èƒ½åœ¨æ¥å£ä¸Šåˆ†é…ä»»ä½•é™æ€ IP åœ°å€ï¼Œè¯·ä¿®æ”¹è¿™ä¸ªå†…æ ¸å‚æ•°:`sysctl -w net.ipv4.conf.all.promote_secondaries=1`(æˆ–æ¯è®¾å¤‡)ã€‚(å¯é€‰ï¼Œå­—ç¬¦ä¸²ï¼Œé»˜è®¤ eth0)

`cidr_netmask`-CIDR æ ¼å¼æ¥å£çš„ç½‘ç»œæ©ç (ä¾‹å¦‚ 24 è€Œä¸æ˜¯ 255.255.255.0)ã€‚å¦‚æœæœªæŒ‡å®šï¼Œè„šæœ¬ä¹Ÿå°†å°è¯•ä»è·¯ç”±è¡¨ä¸­ç¡®å®šè¿™ä¸€ç‚¹ã€‚(å¯é€‰ï¼Œå­—ç¬¦ä¸²ï¼Œæ— é»˜è®¤å€¼)

`broadcast` -ä¸ IP ç›¸å…³çš„å¹¿æ’­åœ°å€ã€‚å¦‚æœç•™ç©ºï¼Œè„šæœ¬å°†æ ¹æ®ç½‘ç»œæ©ç æ¥ç¡®å®šã€‚(å¯é€‰ï¼Œå­—ç¬¦ä¸²ï¼Œæ— é»˜è®¤å€¼)

*   `op` -é…ç½®ç›‘æ§æ“ä½œ:

`monitor` -è¦æ‰§è¡Œçš„åŠ¨ä½œã€‚å¸¸ç”¨å€¼:`monitor`ã€`start`ã€`stop`

`interval` -å¦‚æœè®¾ç½®ä¸ºéé›¶å€¼ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªå¾ªç¯æ“ä½œï¼Œä»¥è¯¥é¢‘ç‡(ç§’)é‡å¤ã€‚éé›¶å€¼åªæœ‰åœ¨åŠ¨ä½œåç§°è®¾ç½®ä¸º monitor æ—¶æ‰æœ‰æ„ä¹‰ã€‚èµ„æºå¯åŠ¨å®Œæˆåï¼Œå°†ç«‹å³æ‰§è¡Œé‡å¤çš„ç›‘è§†æ“ä½œï¼Œåç»­çš„ç›‘è§†æ“ä½œå°†è¢«å®‰æ’åœ¨å‰ä¸€ä¸ªç›‘è§†æ“ä½œå®Œæˆæ—¶å¼€å§‹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåœ¨ 01:00:00 æ‰§è¡Œå¸¦æœ‰`interval=20s`çš„ç›‘æ§åŠ¨ä½œï¼Œä¸‹ä¸€ä¸ªç›‘æ§åŠ¨ä½œä¸ä¼šåœ¨ 01:00:20 å‘ç”Ÿï¼Œè€Œæ˜¯åœ¨ç¬¬ä¸€ä¸ªç›‘æ§åŠ¨ä½œå®Œæˆå 20 ç§’å‘ç”Ÿã€‚

å¦‚æœè®¾ç½®ä¸ºé›¶(é»˜è®¤å€¼)ï¼Œåˆ™æ­¤å‚æ•°å…è®¸æ‚¨æä¾›ç”¨äºé›†ç¾¤åˆ›å»ºçš„æ“ä½œçš„å€¼ã€‚ä¾‹å¦‚ï¼Œå¦‚æœé—´éš”è®¾ç½®ä¸ºé›¶ï¼Œæ“ä½œçš„åç§°è®¾ç½®ä¸º startï¼Œè¶…æ—¶å€¼è®¾ç½®ä¸º 40ï¼Œé‚£ä¹ˆ Pacemaker åœ¨å¯åŠ¨è¯¥èµ„æºæ—¶å°†ä½¿ç”¨ 40 ç§’çš„è¶…æ—¶ã€‚å…·æœ‰é›¶é—´éš”çš„ç›‘è§†æ“ä½œå…è®¸æ‚¨è®¾ç½®æ¢å¤´çš„è¶…æ—¶/å¤±è´¥/å¯ç”¨å€¼ï¼ŒPacemaker åœ¨å¯åŠ¨æ—¶è·å–æ‰€æœ‰èµ„æºçš„å½“å‰çŠ¶æ€ï¼Œè€Œä¸éœ€è¦é»˜è®¤å€¼ã€‚

`timeout` -å¦‚æœæ“ä½œæ²¡æœ‰åœ¨è¯¥å‚æ•°è®¾å®šçš„æ—¶é—´å†…å®Œæˆï¼Œåˆ™æ“ä½œè¢«ä¸­æ­¢å¹¶è§†ä¸ºå¤±è´¥ã€‚å¦‚æœä½¿ç”¨ pcs èµ„æºæ“ä½œé»˜è®¤å€¼å‘½ä»¤è®¾ç½®ï¼Œé»˜è®¤å€¼ä¸ºè¶…æ—¶å€¼ï¼›å¦‚æœæœªè®¾ç½®ï¼Œé»˜è®¤å€¼ä¸º 20 ç§’ã€‚å¦‚æœæ‚¨å‘ç°ç³»ç»Ÿä¸­åŒ…å«çš„èµ„æºéœ€è¦çš„æ—¶é—´è¶…è¿‡äº†ç³»ç»Ÿå…è®¸çš„æ‰§è¡Œæ—¶é—´(å¦‚å¯åŠ¨ã€åœæ­¢æˆ–ç›‘è§†)ï¼Œè¯·è°ƒæŸ¥åŸå› ï¼Œå¦‚æœé¢„è®¡æ‰§è¡Œæ—¶é—´ä¼šå¾ˆé•¿ï¼Œæ‚¨å¯ä»¥å¢åŠ è¯¥å€¼ã€‚

è¶…æ—¶å€¼ä¸æ˜¯ä»»ä½•ç±»å‹çš„å»¶è¿Ÿï¼Œå¦‚æœæ“ä½œåœ¨è¶…æ—¶æœŸé™ç»“æŸå‰è¿”å›ï¼Œç¾¤é›†ä¹Ÿä¸ä¼šç­‰å¾…æ•´ä¸ªè¶…æ—¶æœŸé™ã€‚

`on-fail` -æ­¤æ“ä½œå¤±è´¥æ—¶è¦é‡‡å–çš„æ“ä½œã€‚

å…è®¸çš„å€¼:
â—‹ `ignore` -å‡è®¾èµ„æºæ²¡æœ‰å¤±è´¥ã€‚
â—‹ `block` -ä¸è¦å¯¹èµ„æºæ‰§è¡Œä»»ä½•è¿›ä¸€æ­¥çš„æ“ä½œã€‚
â—‹ `stop` -åœæ­¢èµ„æºï¼Œä¸è¦åœ¨å…¶ä»–åœ°æ–¹å¯åŠ¨å®ƒã€‚
â—‹ `restart` -åœæ­¢èµ„æºå¹¶å†æ¬¡å¯åŠ¨å®ƒ(å¯èƒ½åœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Š)ã€‚
â—‹ `fence` - STONITH èµ„æºå‡ºç°æ•…éšœçš„èŠ‚ç‚¹ã€‚
â—‹ `standby` -å°†æ‰€æœ‰èµ„æºä»èµ„æºå‡ºç°æ•…éšœçš„èŠ‚ç‚¹ä¸Šç§»èµ°ã€‚

> å‚è€ƒ:[http://www.linux-ha.org/doc/man-pages/re-ra-IPaddr2.html](http://www.linux-ha.org/doc/man-pages/re-ra-IPaddr2.html)
> å‚è€ƒ:[https://access . red hat . com/documentation/en-us/red _ hat _ enterprise _ Linux/7/html/high _ avail ability _ add-on _ Reference/S1-resource operate-Haar](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/high_availability_add-on_reference/s1-resourceoperate-haar)

*   `primitive haproxy-resource ocf:heartbeat:haproxy op monitor interval=20 timeout=60 on-fail=restart` è§£é‡ŠåŒä¸Šã€‚
*   `colocation loc inf: virtual-ip-resource haproxy-resource`

`colocation`é™åˆ¶å…è®¸æ‚¨å‘Šè¯‰é›†ç¾¤èµ„æºå¦‚ä½•ç›¸äº’ä¾èµ–ã€‚å®ƒæœ‰ä¸€ä¸ªé‡è¦çš„å‰¯ä½œç”¨:å®ƒä¼šå½±å“èµ„æºåˆ†é…ç»™èŠ‚ç‚¹çš„é¡ºåºã€‚

ä»”ç»†æƒ³æƒ³:é›†ç¾¤ä¸èƒ½å°†`A`å’Œ`B`å…±å­˜ï¼Œé™¤éå®ƒçŸ¥é“`B`åœ¨å“ªé‡Œã€‚å› æ­¤ï¼Œåœ¨è®¾ç½®`colocation`é™åˆ¶æ—¶ï¼Œè€ƒè™‘`A`æ˜¯å¦éœ€è¦ä¸`B`åŒåœ°åŠå…¬æˆ–è€…`B`æ˜¯å¦éœ€è¦ä¸`A`åŒåœ°åŠå…¬æ˜¯éå¸¸é‡è¦çš„ã€‚

åœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œç”±äº`haproxy-resource`åº”è¯¥ä¸`virtual-ip-resource`ä½äºåŒä¸€ä½ç½®ï¼Œå› æ­¤`haproxy-resource`å°†è¢«åˆ†é…åˆ°ä¸`virtual-ip-resource`ç›¸åŒçš„èŠ‚ç‚¹ä¸Šã€‚

*   `order ord inf: virtual-ip-resource haproxy-resource`

`order`çº¦æŸå‘Šè¯‰é›†ç¾¤èµ„æºçš„åˆ†é…é¡ºåºã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬é€šçŸ¥`virtual-ip-resource`åº”è¯¥æ€»æ˜¯åœ¨`haproxy-resource`ä¹‹å‰åˆ†é…ã€‚
æ’åºçº¦æŸåªå½±å“èµ„æºçš„åˆ›å»ºé¡ºåºã€‚å®ƒä»¬ä¸ä¼šå¯¼è‡´èµ„æºä½äºåŒä¸€èŠ‚ç‚¹ä¸Šã€‚

## ç†è§£ç”¨æˆ·æ•°æ®æ–‡ä»¶(TLï¼›ç¾éš¾æ¢å¤)

äº‘åˆå§‹åŒ– **HAProxy** é…ç½®æ–‡ä»¶å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ã€‚è¿™ä¸º **Kube ä¸»èŠ‚ç‚¹**å»ºç«‹äº†è´Ÿè½½å¹³è¡¡ã€‚

ä¸‹é¢æ‚¨å¯ä»¥æ‰¾åˆ°ç›¸åŒçš„æ–‡ä»¶æ³¨é‡Šï¼Œä»¥ä¾¿äºç†è§£:

# æŸ¥çœ‹ HAProxy ç»Ÿè®¡é¡µé¢

ç°åœ¨ä¸€åˆ‡éƒ½è®¾ç½®å¥½äº†ï¼Œæ‚¨å¯ä»¥é€šè¿‡æˆ‘ä»¬åˆšåˆšé…ç½®çš„**è™šæ‹Ÿ IP** è®¿é—® HAProxy ç»Ÿè®¡æ•°æ®ã€‚

åœ¨[æ‰“å¼€æµè§ˆå™¨ï¼Œhttp://192.168.4.20:32700](http://192.168.4.20:32700/)

*ç”¨æˆ·:* `*admin*` *å¯†ç :* `*admin*`

å®ƒå°†æ˜¾ç¤º:

![](img/513b7629237f6b4ba092bb3989716155.png)

è¯·æ³¨æ„æ‰€æœ‰æ§åˆ¶å¹³é¢ç«¯ç‚¹å‡ä¸º ***å‘ä¸‹***

*   kube-mast01:6443
*   kube-mast02:6443
*   kube-mast03:6443

ä¸€æ—¦æˆ‘ä»¬è®¾ç½®äº† Kubernetes ä¸»èŠ‚ç‚¹ï¼Œè¿™ä¸ªé—®é¢˜å°±ä¼šè§£å†³ã€‚

# æµ‹è¯•é«˜å¯ç”¨æ€§

å…³é—­ä¸¤ä¸ªè™šæ‹Ÿæœºä¸­çš„ä¸€ä¸ª(`hapx-node01`æˆ–`hapx-node02`)ï¼Œå¹¶åœ¨æ‰“å¼€ **HAProxy** ç»Ÿè®¡çš„æµè§ˆå™¨ä¸­æŒ‰`F5`ã€‚ä¸åº”æ³¨æ„åˆ°ä»»ä½•å·®å¼‚æˆ–é”™è¯¯ã€‚:)

# **ç»“è®º**

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æ·±å…¥æ¢è®¨äº†é…ç½®ä¸€ä¸ªç”± **Corosync** å’Œ **Pacemaker** æ”¯æŒçš„å…·æœ‰é«˜å¯ç”¨æ€§çš„ **HAProxy é›†ç¾¤**ã€‚æˆ‘ä»¬å•ç‹¬é…ç½®äº†æ¯ä¸ªç»„ä»¶ï¼Œè¿˜é…ç½®äº†ä¸€ä¸ªå¼¹æ€§ IPï¼Œå…è®¸ **HAProxy é›†ç¾¤**åœ¨å…¶ä»»ä½•èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶é€æ˜åœ°è¿›è¡Œæ•…éšœè½¬ç§»ã€‚

æˆ‘å¸Œæœ›æ‚¨åœ¨é…ç½®é›†ç¾¤çš„è¿‡ç¨‹ä¸­è·å¾—äº†ä¹è¶£ï¼Œå¹¶å­¦åˆ°äº†ä¸€äº›æœ‰ç”¨çš„ä¸œè¥¿ã€‚

åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•é…ç½®å…·æœ‰é«˜å¯ç”¨æ€§çš„ **Kubernetes ä¸»**å®ä¾‹ã€‚æ•¬è¯·æœŸå¾…ï¼

å¦‚æœä½ è®¤ä¸ºè¿™æ˜¯æœ‰å¸®åŠ©çš„ï¼Œè¯·ç•™ä¸‹ä½ çš„ğŸ‘ä»¥åŠä¸‹é¢çš„åé¦ˆã€‚ä¸æ–­å®Œå–„è¿™ä¸ªç³»åˆ—çš„å†…å®¹éå¸¸é‡è¦ã€‚

æˆ‘å†æ¬¡å¼ºçƒˆæ¨èæ‚¨å…³æ³¨æˆ‘çš„ Mediumï¼Œè¿™æ ·æ‚¨å°±ä¸ä¼šé”™è¿‡æœ¬ç³»åˆ—ä¸­å‘è¡¨çš„ä»»ä½•æ–°æ–‡ç« ã€‚å¦‚æœä½ é”™è¿‡äº†æœ¬ç³»åˆ—çš„ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œä½ å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹ã€‚

å›å¤´è§ï¼ï¼

å†è§ã€‚