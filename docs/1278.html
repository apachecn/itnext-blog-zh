<html>
<head>
<title>Mock promisified AWS service operation calls with Jest</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ç”¨Jestæ¨¡æ‹Ÿæ‰¿è¯ºçš„AWSæœåŠ¡æ“ä½œè°ƒç”¨</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://itnext.io/mock-promisified-aws-service-operation-calls-with-jest-6f11a22a371?source=collection_archive---------1-----------------------#2018-08-28">https://itnext.io/mock-promisified-aws-service-operation-calls-with-jest-6f11a22a371?source=collection_archive---------1-----------------------#2018-08-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/eb8de494e344506f285f30eb1768b162.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5IVmxQk8nIcC_qJ4n2fWBw.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">é‚£æ˜¯ä½ è¯»äº†æˆ‘çš„æ•…äº‹åæƒ³â€œè¿™å®¶ä¼™å±éƒ½ä¸æ‡‚â€ğŸ˜†(<a class="ae kc" href="https://www.pexels.com/photo/photo-of-a-woman-thinking-941555/" rel="noopener ugc nofollow" target="_blank">https://www . pexels . com/photo/photo-of-a-woman-thinking-941555/</a>)</figcaption></figure><p id="6e2f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">åœ¨<a class="lb lc ep" href="https://medium.com/u/c174a2050171?source=post_page-----6f11a22a371--------------------------------" rel="noopener" target="_blank"> Mbanq </a>æˆ‘ä»¬åœ¨AWSä¸Šè¿è¡Œå¤§éƒ¨åˆ†æœåŠ¡ï¼Œå¹¶å°½å¯èƒ½å¤šåœ°ä½¿ç”¨AWS Lambdaã€‚</p><p id="f88c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æœ€è¿‘æˆ‘ä¸€ç›´åœ¨åšä¸€ä¸ªå°çš„npmåŒ…ï¼Œå®ƒå°†å¸®åŠ©æˆ‘ä»¬åˆ©ç”¨SSMå’ŒKMSæ¥ç®¡ç†æˆ‘ä»¬çš„ç³»ç»Ÿé…ç½®ã€‚ä½œä¸ºAWSçš„å¤§å¤šæ•°æœåŠ¡ï¼ŒSSMå’ŒKMSåˆä½œå¾—å¾ˆå¥½ã€‚</p><p id="4341" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ä¸ºäº†æµ‹è¯•æ–°ç¼–å†™çš„npmåŒ…ï¼Œæˆ‘ä»¬ä¸å¾—ä¸æ¨¡æ‹Ÿæ‰¿è¯ºçš„ç‰ˆæœ¬<code class="fe ld le lf lg b">ssm.getParameters(request)</code></p><pre class="lh li lj lk gt ll lg lm ln aw lo bi"><span id="5e55" class="lp lq iq lg b gy lr ls l lt lu">const AWS = require('aws-sdk')<br/>const ssm = AWS.SSM({ region: 'eu-west-1 }) ssm.getParameters(request).promise() // we have to mock the response from this call</span></pre><p id="6f19" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">å˜²ç¬‘AWSæœ‰ä¸åŒçš„æ–¹å¼ã€‚ä¾‹å¦‚ï¼Œæœ‰æ¥è‡ªéå¸¸é…·çš„<a class="ae kc" href="http://DWYL" rel="noopener ugc nofollow" target="_blank"> DWYL </a>çš„<a class="ae kc" href="https://github.com/dwyl/aws-sdk-mock" rel="noopener ugc nofollow" target="_blank"> aws-mock-sdk </a>åŒ…ã€‚ä¸è¿‡ï¼Œæˆ‘å†³å®šå¸¦ç€çº¯ç²¹çš„ç©ç¬‘å»ã€‚</p><figure class="lh li lj lk gt jr gh gi paragraph-image"><div class="gh gi lv"><img src="../Images/04d76818f9088d2a0e86383d2dccea6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:428/format:webp/1*yZyG4rhfvTehkTsKtLxD9Q.png"/></div></figure><p id="2ea5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">è¦ä½¿SSMçš„åŠŸèƒ½å¯æµ‹è¯•ï¼Œæ‚¨å¿…é¡»è€ƒè™‘ä»¥ä¸‹å› ç´ :</p><ul class=""><li id="dda8" class="lw lx iq kf b kg kh kk kl ko ly ks lz kw ma la mb mc md me bi translated">åœ¨ä½ çš„å‡½æ•°è°ƒç”¨ä¸­ä½¿ç”¨<strong class="kf ir"> ssm </strong>ä½œä¸ºå‚æ•°ï¼Œä¾‹å¦‚<code class="fe ld le lf lg b">const load = (ssm, keys, expiryMs)</code>å®ƒå°†å¸®åŠ©ä½ åœ¨ç¼–å†™æµ‹è¯•æ—¶ä½¿ç”¨è¢«æ¨¡ä»¿çš„<code class="fe ld le lf lg b">ssm</code>ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥<code class="fe ld le lf lg b">module.exports = { ssm }</code>è¿åŒä½ æƒ³å¯¼å‡ºçš„å…¶ä»–å‡½æ•°ï¼Œä½†æˆ‘çœŸçš„ä¸å–œæ¬¢è¿™ä¸ªä¸»æ„</li><li id="5d21" class="lw lx iq kf b kg mf kk mg ko mh ks mi kw mj la mb mc md me bi translated">å¦‚æœä½ æƒ³æ£€æŸ¥ä¸€ä¸ª<code class="fe ld le lf lg b">async/await</code>å‡½æ•°ä¸­æŠ›å‡ºçš„é”™è¯¯ï¼Œä½ å¿…é¡»ä½¿ç”¨:<code class="fe ld le lf lg b">expect(yourFunc()).rejects.toEqual(new Error(`Error Message`))</code>ã€‚å¸¸è§„çš„<code class="fe ld le lf lg b">expect(yourFunc()).toThrowError(`Error Message`)</code> <a class="ae kc" href="https://github.com/facebook/jest/issues/1700#issuecomment-377890222" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">è¡Œä¸é€šçš„</strong> </a></li></ul></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><p id="08fc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">å¥½å§ï¼Œç°åœ¨ä½ å¯èƒ½ä¼šé—®è‡ªå·±:</p><blockquote class="mr ms mt"><p id="e348" class="kd ke mu kf b kg kh ki kj kk kl km kn mv kp kq kr mw kt ku kv mx kx ky kz la ij bi translated">ä½ æ€ä¹ˆèƒ½å˜²ç¬‘æ‰¿è¯ºçš„AWSæœåŠ¡æ“ä½œè°ƒç”¨å‘¢ï¼Ÿ</p></blockquote><p id="b552" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æ‚¨å¯èƒ½æƒ³è¦æ¨¡æ‹Ÿæ¥è‡ª<code class="fe ld le lf lg b">ssm.getParameters(request).promise()</code>çš„æˆåŠŸå“åº”ï¼Œæˆ–è€…æ¨¡æ‹Ÿè¿™ä¸ªå‡½æ•°è°ƒç”¨æŠ›å‡ºçš„<code class="fe ld le lf lg b">Error</code>ã€‚</p><h2 id="fd61" class="lp lq iq bd my mz na dn nb nc nd dp ne ko nf ng nh ks ni nj nk kw nl nm nn no bi translated">æˆåŠŸå“åº”</h2><p id="3364" class="pw-post-body-paragraph kd ke iq kf b kg np ki kj kk nq km kn ko nr kq kr ks ns ku kv kw nt ky kz la ij bi translated">é¦–å…ˆï¼Œç”¨<code class="fe ld le lf lg b">promise</code>é”®åˆ›å»ºä¸€ä¸ªjså¯¹è±¡ï¼Œç”¨å°†è¿”å›ä¸€ä¸ª<code class="fe ld le lf lg b">Promise</code>çš„<code class="fe ld le lf lg b">jest.fn().mockImplementation()</code>æ¨¡æ‹Ÿ<code class="fe ld le lf lg b">promise</code>çš„å€¼ï¼Œå½“è§£æåè¿”å›ä¸€ä¸ªæˆåŠŸçš„å“åº”ã€‚</p><p id="a8df" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ç„¶åæ¯å½“è°ƒç”¨<code class="fe ld le lf lg b">getParameters()</code>å‡½æ•°æ—¶ï¼Œè¿”å›åˆ›å»ºçš„<code class="fe ld le lf lg b">ssmPromise</code>ã€‚</p><pre class="lh li lj lk gt ll lg lm ln aw lo bi"><span id="b274" class="lp lq iq lg b gy lr ls l lt lu">const AWS = require('aws-sdk')<br/>let ssm = new AWS.SSM() <br/>const ssmPromise = {  <br/>  promise: jest.fn().mockImplementation((request) =&gt; {    <br/>    return new Promise((resolve, reject) =&gt; {      <br/>      const response = {        <br/>        Parameters: [          <br/>          {            <br/>            Name: 'bar',            <br/>            Type: 'String',            <br/>            Value: 'barfoorista',            <br/>            Version: 1,            <br/>            LastModifiedDate: '2018-08-22T13:49:55.717Z',                   <br/>            ARN: 'arn:aws:ssm:eu-west-1:whatever:parameter/bar'               <br/>          },          <br/>          {            <br/>            Name: 'foo',            <br/>            Type: 'String',            <br/>            Value: 'foobarista',            <br/>            Version: 1,            <br/>            LastModifiedDate: '2018-08-22T13:49:41.486Z',            <br/>            ARN: 'arn:aws:ssm:eu-west-1:whatever:parameter/foo'          <br/>           }        <br/>         ],        <br/>         InvalidParameters: []      <br/>       }      <br/>       resolve(response)    <br/>     })  <br/>  })<br/>}<br/>ssm = { getParameters: () =&gt; { return ssmPromise } }</span></pre><h2 id="40ba" class="lp lq iq bd my mz na dn nb nc nd dp ne ko nf ng nh ks ni nj nk kw nl nm nn no bi translated">æŠ›å‡ºä¸€ä¸ªé”™è¯¯</h2><p id="8842" class="pw-post-body-paragraph kd ke iq kf b kg np ki kj kk nq km kn ko nr kq kr ks ns ku kv kw nt ky kz la ij bi translated">é€šè¿‡ä½¿ç”¨æ‚¨åœ¨æµ‹è¯•é¡¶éƒ¨åˆ›å»ºçš„<code class="fe ld le lf lg b">ssm</code>å®ä¾‹ï¼Œæ‚¨è¿˜å¯ä»¥ä¸€æ¬¡æ€§æ¨¡ä»¿<code class="fe ld le lf lg b">ssm.getParameters()</code>ã€‚</p><p id="9a9f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">è¿™æ˜¯ä¸€ä¸ªä½ å¦‚ä½•æ¨¡ä»¿<code class="fe ld le lf lg b">ssm.getParameters()</code>æŠ›å‡º<code class="fe ld le lf lg b">Error</code>çš„ä¾‹å­</p><pre class="lh li lj lk gt ll lg lm ln aw lo bi"><span id="f952" class="lp lq iq lg b gy lr ls l lt lu">ssm = {      <br/>  getParameters: () =&gt; {        <br/>    return {          <br/>      promise: jest.fn().mockImplementation((request) =&gt; {            <br/>        return new Promise((resolve, reject) =&gt; {              <br/>          return reject(new Error('foobar'))            <br/>        }).catch(() =&gt; console.log('Ok'))          <br/>      })        <br/>    }      <br/>  }    <br/>}</span></pre><p id="f1db" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">åœ¨<code class="fe ld le lf lg b">gist</code>(åŒå…³è¯­)ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°æµ‹è¯•çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬ç”¨å®ƒæ¥æµ‹è¯•æˆ‘ä»¬çš„åŒ…ã€‚</p><figure class="lh li lj lk gt jr"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="8e32" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">è¯¥è½¯ä»¶åŒ…ä»åœ¨å¼€å‘ä¸­ã€‚ä¸€æ—¦å®ƒå‘å¸ƒï¼Œä½ å°±å¯ä»¥é€šè¿‡è¿è¡Œ<code class="fe ld le lf lg b">npm i --save sreda</code>æ¥å®‰è£…å®ƒ</p></div></div>    
</body>
</html>