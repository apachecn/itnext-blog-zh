<html>
<head>
<title>Easier Service Worker caching with Routing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">æ›´è½»æ¾çš„æœåŠ¡äººå‘˜ç¼“å­˜å’Œè·¯ç”±</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://itnext.io/easier-service-worker-caching-with-routing-323d347d95d3?source=collection_archive---------7-----------------------#2022-02-22">https://itnext.io/easier-service-worker-caching-with-routing-323d347d95d3?source=collection_archive---------7-----------------------#2022-02-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/431353e86c3a345234a3665b476d189c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VOuhqmCo4X-RE4a-7MyJEA.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">https://pxhere.com/en/photo/187030?utm_content=shareClip&amp;UTM _ medium = referral&amp;UTM _ source = px here</figcaption></figure><p id="1f1e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æœåŠ¡äººå‘˜æ˜¯æµè§ˆå™¨å·¥å…·ç®±ä¸­ä¸€ä¸ªéå¸¸å¼ºå¤§çš„å·¥å…·ï¼Œä½†æ˜¯æ‚¨å¯èƒ½å¾ˆéš¾ç†è§£å®ƒï¼Œå°¤å…¶æ˜¯ä»¥å¯ç»´æŠ¤çš„æ–¹å¼å»ºæ¨¡å’Œç»„ç»‡ä¸åŒçš„æµç¨‹ã€‚ä½¿ç”¨åŸºäºè·¯ç”±çš„æ¨¡å¼(ç±»ä¼¼äºNode Expressæ¡†æ¶ä¸­çš„æ¨¡å¼)å¯ä»¥å¸®åŠ©æ‚¨åšåˆ°è¿™ä¸€ç‚¹ã€‚è¿™å°±æ˜¯æˆ‘åœ¨è¿™é‡Œåšçš„å®éªŒã€‚ç±»ä¼¼çš„äº‹æƒ…ä»¥å‰ä¹Ÿåšè¿‡ã€‚ä¾‹å¦‚ï¼ŒåƒWorkboxè¿™æ ·çš„åº“å°†è·¯ç”±ä½œä¸ºAPIçš„ä¸€éƒ¨åˆ†æ¥å®ç°ã€‚ä½†æ˜¯è¿™é‡Œæˆ‘å°†æ¢ç´¢ä¸€ä¸ª<em class="lb">è·¯ç”±ä¼˜å…ˆé€‰æ‹©</em>æ¥åˆ›å»ºä¸€ä¸ªæ›´åŠ çµæ´»å’Œè½»é‡çº§çš„é€‰é¡¹ã€‚</p><p id="dffb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ä¸ºæ­¤ï¼Œæˆ‘ä½¿ç”¨äº†<em class="lb"> ittyè·¯ç”±å™¨</em>(<a class="ae kc" href="https://github.com/kwhitley/itty-router" rel="noopener ugc nofollow" target="_blank">https://github.com/kwhitley/itty-router</a>)ã€‚itty router æ˜¯ä¸€ä¸ªéå¸¸å°ã€è½»é‡çº§ã€ä½†ä»ç„¶å¼ºå¤§çš„è·¯ç”±åº“ï¼Œæˆ‘æ˜¯åœ¨ä¸Cloudflare Workersä¸€èµ·è¯•éªŒæ—¶å¶ç„¶å‘ç°çš„ã€‚Cloudflare Workersæ˜¯ä¸€ä¸ªåŸºäºService Worker APIçš„FaaSå¹³å°ï¼Œå› æ­¤<em class="lb"> itty router </em>å¯ä»¥åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨ï¼Œæ— éœ€ä»»ä½•é¢å¤–çš„å·¥ä½œã€‚</p><h1 id="e0c7" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">ittyè·¯ç”±å™¨ç®€ä»‹</h1><p id="8aa6" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">ä½¿ç”¨<em class="lb"> ittyè·¯ç”±å™¨</em>ï¼Œå•æ¡è·¯ç”±å¯ä»¥è¿™æ ·å®šä¹‰:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="937e" class="mo ld iq mk b gy mp mq l mr ms">router.get('/hello', request =&gt; {<br/>  return new Response('Hello World!')<br/>})</span></pre><p id="8f38" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">itty router æœ‰ä¸¤ä¸ªç‰¹åˆ«çš„æ–¹é¢ä½¿å®ƒåœ¨æœåŠ¡äººå‘˜ä¸­éå¸¸æœ‰ç”¨ã€‚ç¬¬ä¸€ï¼Œå®ƒä½¿ç”¨ä¸­é—´ä»¶æ¨¡å¼ï¼Œå› æ­¤æ‚¨å¯ä»¥é“¾æ¥å¤„ç†ç¨‹åºã€‚å¦‚æœç¬¬ä¸€ä¸ªæ²¡æœ‰è¿”å›å“åº”ï¼Œè¯·æ±‚å°†è¢«è½¬ç§»åˆ°ä¸‹ä¸€ä¸ª:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="82f1" class="mo ld iq mk b gy mp mq l mr ms">router.get('/hello', handler1, handler2)</span></pre><p id="2684" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">å¦ä¸€ä»¶é‡è¦çš„äº‹æƒ…æ˜¯ï¼Œè™½ç„¶è¯·æ±‚æ˜¯å¤„ç†ç¨‹åºå”¯ä¸€æœŸæœ›çš„å‚æ•°ï¼Œä½†æ˜¯å¯ä»¥ç”¨å°†æ²¿ç€é“¾ä¼ é€’çš„é™„åŠ å‚æ•°æ³¨å†Œä¸»è·¯ç”±å™¨å¤„ç†ç¨‹åº:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="0a7c" class="mo ld iq mk b gy mp mq l mr ms">router.get('/hello', (request, user) =&gt; {<br/>  return new Response(`Hello ${ user.name }!`)<br/>})</span><span id="2fb7" class="mo ld iq mk b gy mt mq l mr ms">addEventListener('fetch', event =&gt;<br/>  event.respondWith(router.handle(event.request, user))<br/>)</span></pre><h1 id="2709" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">åŸºæœ¬è®¾ç½®</h1><p id="1719" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">å› æ­¤ï¼Œè®°ä½è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒå¦‚ä½•å¸®åŠ©æˆ‘ä»¬å®ç°ä¸æœåŠ¡å·¥ä½œè€…ç›¸å…³çš„ä¸åŒæ¨¡å¼/ç­–ç•¥ï¼Œå¦‚CacheFirstæˆ–NetworkFirstã€‚ä½†é¦–å…ˆæ˜¯åŸºæœ¬çš„è®¾ç½®ã€‚å¯ä»¥åƒè¿™æ ·ä»HTMLåŠ è½½å’Œæ³¨å†ŒæœåŠ¡å·¥ä½œè€…:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="ad58" class="mo ld iq mk b gy mp mq l mr ms">&lt;script type="module"&gt;<br/>    const reg = await navigator.serviceWorker.register('/sw.js', {<br/>        type: 'module',<br/>    });<br/>&lt;/script&gt;</span></pre><p id="2fdc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">åœ¨è¿™ä¸ªPoCä¸­ï¼Œæˆ‘ä½¿ç”¨ESæ¨¡å—ï¼Œè¿™å¿…é¡»åæ˜ åœ¨è„šæœ¬æ ‡è®°å’ŒæœåŠ¡äººå‘˜çš„æ³¨å†Œä¸­ã€‚æœåŠ¡äººå‘˜çš„æ ¹æºéå¸¸ç®€å•:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="72ff" class="mo ld iq mk b gy mp mq l mr ms">import { cacheName, coreAssets } from './config.js';<br/>import router from './router';</span><span id="3f4f" class="mo ld iq mk b gy mt mq l mr ms">self.addEventListener('install', function (event) {<br/>    // Cache core assets<br/>    event.waitUntil(caches.open(cacheName).then(function (cache) {<br/>        for (let asset of coreAssets) {<br/>            let req = new Request(asset)<br/>            cache.add(req);<br/>        }<br/>        return cache;<br/>    }));<br/>});</span><span id="a2ed" class="mo ld iq mk b gy mt mq l mr ms">self.addEventListener('fetch', async event =&gt; {<br/>    event.respondWith(router.handle(event.request, {onLine: navigator.onLine}, event))<br/>})</span></pre><p id="00df" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">é¢„ç¼“å­˜çš„ä¸€äº›é…ç½®ï¼Œä»¥åŠåœ¨ä¸Šä¸‹æ–‡å¯¹è±¡ä¸Šè®¾ç½®çš„åœ¨çº¿çŠ¶æ€ã€‚ä¸»è¦å·¥ä½œç”±å¯¼å…¥çš„è·¯ç”±å™¨å®Œæˆï¼Œå¯èƒ½å¦‚ä¸‹æ‰€ç¤º:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="fee3" class="mo ld iq mk b gy mp mq l mr ms">import { Router } from 'itty-router';<br/>import { handler1, handler2 } from './handlers.js';</span><span id="f005" class="mo ld iq mk b gy mt mq l mr ms">const router = Router()</span><span id="4450" class="mo ld iq mk b gy mt mq l mr ms">//Add routes<br/>router.get('/assets', handler1 )<br/>router.get('*', handler2)<br/>...</span><span id="e2e9" class="mo ld iq mk b gy mt mq l mr ms">export default router;</span></pre><h1 id="adc5" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">åŸºæœ¬è½¯ä»¶ç­–ç•¥</h1><p id="a7cf" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">é‚£ä¹ˆï¼ŒCacheFirstå’ŒNetworkFirstã€‚è®©æˆ‘ä»¬é¦–å…ˆå®šä¹‰ä¸€ä¸ªä»ç¼“å­˜ä¸­æ£€ç´¢å“åº”çš„å¤„ç†ç¨‹åº:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="ffe2" class="mo ld iq mk b gy mp mq l mr ms">const ifCacheRespond = async (request, context, event) =&gt; {<br/>    const response = await caches.match(request);<br/>    if (response) {<br/>        return response<br/>    }<br/>}</span></pre><p id="bf77" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ç±»ä¼¼äºç½‘ç»œå“åº”çš„å¤„ç†ç¨‹åºã€‚å®ƒåœ¨å¯åŠ¨æå–ä¹‹å‰æ£€æŸ¥åœ¨çº¿çŠ¶æ€:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="098c" class="mo ld iq mk b gy mp mq l mr ms">const ifNetworkRespond = async (request, context, event) =&gt; {<br/>    if(context.onLine){<br/>        let response = await fetch(request);<br/>        if (response &amp;&amp; response.ok) {<br/>            return response;<br/>        }<br/>    }<br/>}</span></pre><p id="a0b8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">å› æ­¤ï¼ŒCacheFirstç­–ç•¥å¯ä»¥è¡¨è¾¾å¦‚ä¸‹:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="a6b1" class="mo ld iq mk b gy mp mq l mr ms">router.get('/assets/*', ifCacheRespond, ifNetworkRespond, handleError)</span></pre><p id="1735" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">å¦‚æœ<code class="fe mu mv mw mk b">ifCacheRespond</code>åœ¨ç¼“å­˜ä¸­æ‰¾åˆ°ä¸€ä¸ªå“åº”ï¼Œå®ƒå°†è¿”å›è¿™ä¸ªå“åº”ã€‚å¦‚æœæ²¡æœ‰ï¼Œå®ƒå°†è¯·æ±‚ä¼ é€’ç»™<code class="fe mu mv mw mk b">ifNetworkRespond</code>ã€‚<code class="fe mu mv mw mk b">handleError</code>æœ‰æ²¡æœ‰ä»¥è¿™æ ·æˆ–é‚£æ ·çš„æ–¹å¼æ”¶æ‹¾å½»åº•çš„å¤±è´¥ã€‚æˆ–è€…ï¼Œæ‚¨å¯ä»¥åœ¨æœ«å°¾ä½¿ç”¨é»˜è®¤è·¯ç”±æ¥å¤„ç†è¿™äº›æƒ…å†µï¼Œå› ä¸ºå¦‚æœæœ‰é—®é¢˜çš„è·¯ç”±æ²¡æœ‰è¿”å›ä»»ä½•å“åº”ï¼Œè·¯ç”±å™¨ä¼šå°†è¯·æ±‚ä¼ é€’åˆ°ä¸‹ä¸€ä¸ªè·¯ç”±ã€‚</p><p id="0f80" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">é‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•è¡¨è¾¾ç½‘ç»œä¼˜å…ˆæˆ˜ç•¥å‘¢ï¼Ÿæ˜¯çš„ï¼Œå½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥äº¤æ¢é¡ºåºğŸ˜ï¼š</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="bbbb" class="mo ld iq mk b gy mp mq l mr ms">router.get('/assets/*', ifNetworkRespond, ifCacheRespond, handleError)</span></pre><p id="5dfe" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">å¯¹äºç¨å¾®å¤æ‚ä¸€ç‚¹çš„ç­–ç•¥ï¼Œæˆ‘ä»¬éœ€è¦å¢åŠ æµç¨‹ã€‚ä½†æ˜¯å®ƒä»¬ä»ç„¶å¯ä»¥ç”¨ç±»ä¼¼çš„æ–¹å¼æ¥è¡¨è¾¾ã€‚ä¾‹å¦‚ï¼Œå¯¹äºCacheAsYouGoï¼Œæ‚¨éœ€è¦åœ¨è¿”å›å“åº”ä¹‹å‰å°†å…¶æ·»åŠ åˆ°ç¼“å­˜ä¸­ã€‚å¯ç”¨æ­¤ç­–ç•¥çš„è·¯çº¿å¯ä»¥å®šä¹‰å¦‚ä¸‹:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="7a31" class="mo ld iq mk b gy mp mq l mr ms">router.get('/articles/*', ifCacheRespond, getNetworkResponse, addToCache, ifNetworkRespond, handleError)</span></pre><p id="0eef" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ç¬¬ä¸€ä¸ªå’Œä»¥å‰ä¸€æ ·ã€‚å¦‚æœæ‚¨åœ¨ç¼“å­˜ä¸­æœ‰å“åº”ï¼Œå°±æä¾›å®ƒã€‚å¦‚æœæ²¡æœ‰ï¼Œæµç¨‹å°†è½¬åˆ°ä¸‹ä¸€ä¸ªå¤„ç†ç¨‹åº:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="f0b8" class="mo ld iq mk b gy mp mq l mr ms">const getNetwork = async (request, context, event) =&gt; {<br/>    if (context.onLine) {<br/>        const response = context.networkResponse || await fetch(request);<br/>        if (response &amp;&amp; response.ok) {<br/>            console.log("response.ok", response)<br/>            context.networkResponse = response;<br/>        }<br/>    }<br/>}</span></pre><p id="6ba5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">è¿™ä¸ªå¤„ç†ç¨‹åºä¸è¿”å›ç½‘ç»œå“åº”ï¼Œè€Œæ˜¯å°†å®ƒæ·»åŠ åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼Œä¾›é“¾ä¸­æ›´ä¸‹æ¸¸çš„å¤„ç†ç¨‹åºä½¿ç”¨ï¼Œå¦‚<code class="fe mu mv mw mk b">addToCache</code>:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="2b88" class="mo ld iq mk b gy mp mq l mr ms">const addToCache = async (request, context, event) =&gt; {<br/>    const response = context.networkResponse;<br/>    if (response &amp;&amp; response.ok) {<br/>        let responseClone = response.clone();<br/>        caches.open(cacheName).then(async (cache) =&gt; {<br/>            cache.put(request, responseClone);<br/>        });<br/>    }<br/>}</span></pre><p id="cd7e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æˆ‘ä»¬éœ€è¦æ›´æ”¹<code class="fe mu mv mw mk b">ifNetworkRespond</code>æ¥ä½¿ç”¨ä¸Šä¸‹æ–‡å¯¹è±¡ä¸Šçš„å“åº”(å¦‚æœå¯ç”¨çš„è¯):</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="db2a" class="mo ld iq mk b gy mp mq l mr ms">const ifNetworkRespond = async (request, context, event) =&gt; {<br/>    if (context.onLine) {<br/>        const response = context.networkResponse || await fetch(request);<br/>        if (response) {<br/>            context.networkResponse = response;<br/>        }<br/>        if (response &amp;&amp; response.ok) {<br/>            return response;<br/>        }<br/>    }<br/>}</span></pre><p id="55fd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">è¦å¯ç”¨StaleWhileRevalidateè¿™æ ·çš„ç­–ç•¥ï¼Œæˆ‘ä»¬éœ€è¦ç¨å¾®æ‰©å±•ä¸€ä¸‹ã€‚ä½¿ç”¨StaleWhileRevalidateæ—¶ï¼Œæ‚¨å¸Œæœ›ä½¿ç”¨ç¼“å­˜ï¼Œä½†åœ¨åå°æ›´æ–°ç¼“å­˜è€Œä¸ç­‰å¾…å®ƒï¼Œä»¥ä¾¿ä¸‹ä¸€æ¬¡å‘½ä¸­å°†ä½¿ç”¨æ›´æ–°çš„èµ„æº:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="506e" class="mo ld iq mk b gy mp mq l mr ms">router.get('/', revalidateCache, ifCache, <!-- -->ifNetworkRespond<!-- -->, handleError)</span></pre><p id="2d75" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">åœ¨è¿™é‡Œï¼Œæ‚¨å¸Œæœ›å¼€å§‹é‡æ–°éªŒè¯ï¼Œä½†å¦‚æœæœ‰ç¼“å­˜ï¼Œå°±ä¸è¦ç­‰å¾…ã€‚æ‰€ä»¥<code class="fe mu mv mw mk b">revalidateCache</code>ä¸ºå®ƒåˆ›é€ äº†ä¸€ä¸ªæ‰¿è¯ºï¼Œç„¶åç»§ç»­å‰è¿›:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="16b2" class="mo ld iq mk b gy mp mq l mr ms">const revalidateCache = async (request, context, event) =&gt; {<br/>    if (context.onLine) {<br/>        const cache = await caches.open(cacheName);<br/>        const networkResponsePromise = fetch(request);<br/>        context.networkResponsePromise = networkResponsePromise;<br/>        event.waitUntil(async function () {<br/>            const networkResponse = await networkResponsePromise;<br/>            await cache.put(request, networkResponse.clone());<br/>        }());<br/>    }<br/>}</span></pre><p id="cb93" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">å¹¶ä¸”<code class="fe mu mv mw mk b">ifNetworkRespond</code>ä¹Ÿéœ€è¦å¤„ç†æ‰¿è¯ºï¼Œæ‰€ä»¥å®ƒä¸ä¼šåœ¨æ²¡æœ‰ç¼“å­˜å“åº”å¯ç”¨çš„æƒ…å†µä¸‹å¼€å§‹æ–°çš„è·å–ï¼Œè€Œæ˜¯ä½¿ç”¨é‡æ–°éªŒè¯ç¼“å­˜çš„ç›¸åŒè·å–:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="9d1d" class="mo ld iq mk b gy mp mq l mr ms">const ifNetworkRespond = async (request, context, event) =&gt; {<br/>    if (context.onLine) {<br/>        let response;<br/>        if (context.networkResponsePromise) {<br/>            response = await context.networkResponsePromise<br/>        } else {<br/>            response = context.networkResponse || await fetch(request);<br/>        }<br/>        if (response) {<br/>            context.networkResponse = response;<br/>        }<br/>        if (response &amp;&amp; response.ok) {<br/>            return response;<br/>        }<br/>    }<br/>}</span></pre><h1 id="0e6f" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">æ ‡é¢˜è¿‡æ»¤</h1><p id="7f86" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">æœåŠ¡å·¥ä½œè€…ä½¿ç”¨ç¼“å­˜çš„å¦ä¸€ç§å…¸å‹æ–¹å¼æ˜¯ä¸ä½¿ç”¨è·¯ç”±ï¼Œè€Œæ˜¯ä½¿ç”¨å¤´å­—æ®µã€‚æ¯”å¦‚ç”¨<code class="fe mu mv mw mk b">Content-Type: text/html</code>ç¼“å­˜ä¸€åˆ‡ã€‚è¿™åœ¨è¿™é‡Œä¹Ÿæ˜¯å¯èƒ½çš„ã€‚æ‚¨å¯ä»¥åœ¨å…·æœ‰å¯ç¼“å­˜å†…å®¹ç±»å‹çš„åˆå§‹ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­æ·»åŠ ä¸€ä¸ªæ•°ç»„ï¼Œå¹¶åœ¨ç¼“å­˜ä¹‹å‰æ£€æŸ¥è¯¥æ•°ç»„:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="3089" class="mo ld iq mk b gy mp mq l mr ms">self.addEventListener('fetch', async event =&gt; {<br/>    event.respondWith(router.handle(event.request, {onLine: navigator.onLine, cachableContent: ['text/html']}, event))<br/>})</span></pre><p id="9361" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¸€ä¸ªâ€œå…¨éƒ¨æ•è·â€è·¯å¾„æ¥ç¼“å­˜æ‰€æœ‰HTML:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="1afa" class="mo ld iq mk b gy mp mq l mr ms">router.get('/*', ifCacheRespond, getNetworkResponse, addToCache, ifNetworkRespond, handleError)</span></pre><p id="74ee" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">å¯¹äºæ›´ç»†ç²’åº¦çš„å¤„ç†ï¼Œç»“åˆå¤´å’Œè·¯ç”±ï¼Œè¿‡æ»¤å™¨å¯ä»¥æ”¹ä¸ºåœ¨æµä¸­é¦–å…ˆè®¾ç½®ä¸€ä¸ªå¥æŸ„:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="ac92" class="mo ld iq mk b gy mp mq l mr ms">const cacheHTMLOnly = async (request, context, event) =&gt; {<br/>    context.cachableContent = ['text/html'];<br/>}</span><span id="77d8" class="mo ld iq mk b gy mt mq l mr ms">router.get('/assets/*', cacheHTMLOnly, ifCacheRespond, getNetworkResponse, addToCache, ifNetworkRespond, handleError)</span></pre><h1 id="ac95" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">æ›´é«˜çº§</h1><p id="9ecf" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">è¿™æ˜¯éå¸¸ç²—ç•¥çš„ï¼Œä¸€ä¸ªå®Œæ•´çš„å®ç°å½“ç„¶éœ€è¦æ·»åŠ æ›´å¤šçš„ä¸œè¥¿ï¼Œæ¯”å¦‚å¤„ç†ç¼“å­˜åˆ°æœŸå¤´ç­‰ã€‚å°¤å…¶æ˜¯æ‚¨éœ€è¦ç®¡ç†ç¼“å­˜ç‰ˆæœ¬æ§åˆ¶å’Œåˆ é™¤ï¼Œè¿™æ ·æ‚¨å°±ä¸ä¼šåœ¨éœ€è¦æ›´æ”¹æ—¶é™·å…¥ç³Ÿç³•çš„çŠ¶æ€ï¼Œä¹Ÿä¸ä¼šçªç„¶æ— æ³•æ›´æ–°å®¢æˆ·ç«¯ä¸Šçš„èµ„æºã€‚</p><p id="5fe1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æ­¤å¤–ï¼ŒåƒWorkboxè¿™æ ·çš„åº“æ”¯æŒæ›´é«˜çº§çš„bookeepingåŠŸèƒ½ï¼Œæ¯”å¦‚é™åˆ¶å°†è¢«ç¼“å­˜çš„è¯·æ±‚çš„æ•°é‡ï¼Œä¿å­˜ç”±äºç½‘ç»œæ•…éšœè€Œå¤±è´¥çš„post-requestsï¼Œæ·»åŠ è‡ªå·±çš„è¿‡æœŸå¤„ç†ç­‰ç­‰ã€‚ä¸ºæ­¤ï¼Œæ‚¨éœ€è¦åƒIndexedDBè¿™æ ·çš„ä¸œè¥¿ä½œä¸ºæµç¨‹çš„ä¸€éƒ¨åˆ†ã€‚æˆ‘ä¸ä¼šåœ¨è¿™é‡Œè¯¦ç»†ä»‹ç»ï¼Œä½†æˆ‘ä¼šç”¨ä¸‹é¢çš„åœºæ™¯æ¥æè¿°ä¸€ä¸‹ï¼Œå¦‚æœç½‘ç»œä¸­æ–­ï¼Œæ‚¨å¸Œæœ›èƒ½å¤Ÿç¦»çº¿å­˜å‚¨æ–°æ–‡ç« :</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="d304" class="mo ld iq mk b gy mp mq l mr ms">router.post('/article/*', ifNetworkRespond, saveRequestForLater, handleError)</span></pre><p id="75b4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">å¦‚æœ<code class="fe mu mv mw mk b">ifNetworkRespond</code>æ²¡æœ‰è¿”å›ï¼Œ<code class="fe mu mv mw mk b">saveRequestForLater</code>å°†è·å–è¯·æ±‚å¹¶ä¿å­˜åˆ°IndexedDBä¸­ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€åŒ–çš„ç‰ˆæœ¬ã€‚æ‚¨å¯èƒ½éœ€è¦ä¿å­˜æ›´å¤šçš„è¯·æ±‚ï¼Œæ¯”å¦‚å¤´ã€å‚æ•°ç­‰ã€‚è¿™å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºç›¸å…³çš„åº”ç”¨å’ŒåŠŸèƒ½:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="a6e7" class="mo ld iq mk b gy mp mq l mr ms">const <!-- -->saveRequestForLater<!-- --> = async (request, context, event) =&gt; {<br/>    if(!context.onLine){<br/>        event.waitUntil(async function () {<br/>            const payload = await request.clone().json();<br/>            const dbrequest = indexedDB.open("articles");<br/>            dbrequest.onsuccess = async (event) =&gt; {<br/>                const db = event.target.result;<br/>                const tx = db.transaction('createarticle', 'readwrite');<br/>                const store = tx.objectStore('createarticle');<br/>                store.add(payload)<br/>            } <br/>        }());       <br/>    }<br/>}</span></pre><p id="c6a0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">å½“ç„¶ï¼Œè¿™é‡Œæœ€é‡è¦çš„æ˜¯ï¼Œå½“åº”ç”¨ç¨‹åºå†æ¬¡ä¸Šçº¿æ—¶ï¼Œè¦æœ‰æŸç§æœºåˆ¶æ¥é‡‡å–è¡ŒåŠ¨ï¼Œç„¶åé‡æ”¾è¯·æ±‚ã€‚ä½†è¿™ä¹Ÿå¯èƒ½æ˜¯åŸºäºåº”ç”¨ç¨‹åºçš„è¦æ±‚å’Œç‰¹å®šçš„åŠŸèƒ½ã€‚</p><h1 id="641e" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">ç¼“å­˜è¿‡æœŸå’Œè¾¹è½¦è¯·æ±‚</h1><p id="df90" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">ç¼“å­˜å¤„ç†å¯èƒ½éœ€è¦è€ƒè™‘å“åº”çš„ç¼“å­˜å¤´ï¼Œä½†æ˜¯å¦‚æœæ‚¨ä¸æƒ³åœ¨æœåŠ¡å·¥ä½œå™¨æœ¬èº«ä¸­æ·»åŠ å•ç‹¬çš„è¿‡æœŸå¤„ç†ï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼ŸæŒ‘æˆ˜åœ¨äºï¼Œåœ¨å°†å“åº”æ”¾å…¥ç¼“å­˜ä¹‹å‰ï¼Œæ‚¨ä¸èƒ½é€šè¿‡è®¾ç½®è‡ªå®šä¹‰å¤´æ¥ä¿®æ”¹å“åº”ï¼Œå› ä¸ºå®ƒæ˜¯åªè¯»çš„ã€‚ä¸€ç§æ›¿ä»£æ–¹æ³•æ˜¯ä½¿ç”¨IndexedDBè·å–é¢å¤–çš„å…ƒæ•°æ®ï¼Œå¦ä¸€ç§æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ª<em class="lb"> sidecarè¯·æ±‚</em>æ¥ç¼“å­˜é¢å¤–çš„å…ƒæ•°æ®:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="8451" class="mo ld iq mk b gy mp mq l mr ms">const addToCache = async (request, context) =&gt; {<br/>    const response = context.networkResponse;<br/>    if (response &amp;&amp; response.ok) {<br/>        let responseClone = response.clone();<br/>        caches.open(cacheName).then(async (cache) =&gt; {<br/>            cache.put(request, responseClone);<br/>            const sidecarReq = new Request(request.url + '-sidecar', {<br/>                method: "GET",<br/>            });<br/>            const sidecarResp = new Response(null, {<br/>                status: 200,<br/>                headers: {<br/>                    'x-sw-expires': Date.now() + context.cacheMaxAgeMS,<br/>                },<br/>            });<br/>            cache.put(sidecarReq, sidecarResp);<br/>        });<br/>    }<br/>}</span></pre><p id="876d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ç„¶ååœ¨æ£€æŸ¥ç¼“å­˜æ—¶æ£€æŸ¥è¾¹è½¦ä¸­çš„æ ‡é¢˜ã€‚</p><p id="84bc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> <em class="lb"> NBï¼ä½†æ˜¯è¦ç¡®ä¿è¿™æ ·çš„sidecar-routesä¸ä¼šè¢«å…¶ä»–å¤„ç†ç¨‹åºæ— æ„ä¸­ç¼“å­˜ï¼Œæˆ–è€…ç”¨äºå­˜å‚¨è®¤è¯æˆ–å…¶ä»–æ•æ„Ÿçš„ä¸œè¥¿ï¼Œå› ä¸ºå®ƒæ˜¾ç„¶ä¼šè¢«ç¯¡æ”¹ã€‚</em></strong></p><h1 id="73a8" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">æ‘˜è¦</h1><p id="f501" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">æ‰€ä»¥ä½¿ç”¨åƒ<em class="lb"> itty router </em>è¿™æ ·çš„è·¯ç”±å™¨åœ¨ç¼–å†™æœåŠ¡äººå‘˜æ—¶è‚¯å®šä¼šæœ‰æ‰€å¸®åŠ©ã€‚ä¸ä½¿ç”¨åƒWorkboxè¿™æ ·çš„åº“ç›¸æ¯”ï¼Œå®ƒè®©æ‚¨æ›´æ¥è¿‘å¹³å°å·¥ä½œï¼Œå¹¶ä¸”éå¸¸çµæ´»å’Œå¯å®šåˆ¶ã€‚ä½†æ˜¯å®ƒä»ç„¶è®©æ‚¨ä»¥ä¸€ç§æ¥è¿‘æ›´é«˜çº§å·¥å…·çš„å¯è¯»æ€§çš„æ–¹å¼ç»„ç»‡æµç¨‹ã€‚å¹¶ä¸”ä»ç„¶æ˜¯éå¸¸è½»é‡çº§çš„ï¼Œä¸å®ƒå¯ä»¥å¸®åŠ©æ‚¨èŠ‚çœçš„ä¸‹è½½å­—èŠ‚ç›¸æ¯”ï¼Œå®ƒåªå¢åŠ äº†å¾ˆå°‘çš„å¼€é”€ã€‚</p></div></div>    
</body>
</html>