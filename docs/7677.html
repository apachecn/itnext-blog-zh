<html>
<head>
<title>Kubernetes Tips | Using scripts inside configmaps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetesæç¤º|åœ¨é…ç½®å›¾ä¸­ä½¿ç”¨è„šæœ¬</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://itnext.io/kubernetes-tips-using-scripts-inside-configmaps-9df03e17ac35?source=collection_archive---------0-----------------------#2022-12-16">https://itnext.io/kubernetes-tips-using-scripts-inside-configmaps-9df03e17ac35?source=collection_archive---------0-----------------------#2022-12-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/d8100e3fe169f140dcfd69abd050c981.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6HtxSH_ULwguHGYnGWWD4g.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://cncf-branding.netlify.app/projects/kubernetes/" rel="noopener ugc nofollow" target="_blank">https://cncf-branding.netlify.app/projects/kubernetes/</a></figcaption></figure><p id="7193" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">åœ¨è¿‡å»åå¹´çš„å¤§éƒ¨åˆ†æ—¶é—´é‡Œï¼Œæˆ‘åœ¨å¾·æ²ƒæ™®æ–¯/SREä¸–ç•Œå·¥ä½œï¼Œæˆ‘å­¦åˆ°çš„ä¸€ä»¶äº‹æ˜¯ï¼Œå¿«é€Ÿè¡ŒåŠ¨æ˜¯ç”Ÿå­˜çš„å”¯ä¸€é€”å¾„ã€‚åœ¨ä¸€ä¸ªè¡Œä¸šã€ä¸€ä¸ªç»„ç»‡ä¸­ï¼Œäº‹æƒ…ä¼šåœ¨ä¸€ç¬é—´å‘ç”Ÿå˜åŒ–ï¼Œè€Œä½ çš„å·¥ä½œé‡æ°¸è¿œä¸ä¼šå‡å°‘ã€‚æ˜¾ç„¶ï¼Œæˆ‘ä»¬éƒ½æ˜¯ä¸ºäº†æ•ˆç‡å’Œè´¨é‡è€Œå»ºè®¾ï¼Œä½†æˆ‘ä»¬ä¹Ÿå¿…é¡»ç‰¢è®°é€Ÿåº¦ã€‚åœ¨è¿™ä¸ªé¢†åŸŸï¼Œè„šæœ¬å°±æ˜¯ç”Ÿå‘½ã€‚æ²¡æœ‰è„šæœ¬ï¼Œè‡ªåŠ¨åŒ–å°±æ— æ³•æˆåŠŸã€‚åœ¨æˆ‘çš„æ•´ä¸ªèŒä¸šç”Ÿæ¶¯ä¸­ï¼Œæˆ‘çœŸçš„æƒ³ä¸å‡ºæœ‰å“ªä¸€å‘¨æˆ‘æ²¡æœ‰ç¼–å†™ä¸€äº›è„šæœ¬æ¥å®ç°ä¸€äº›è‡ªåŠ¨åŒ–ã€‚åœ¨ä½ æ„è¯†åˆ°ä¹‹å‰ï¼Œä½ å·²ç»æœ‰æˆç™¾ä¸Šåƒçš„ä¸œè¥¿è¦ç»´æŠ¤äº†ã€‚</p><p id="320b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">å½“ä½¿ç”¨åŒ…å«Kubernetesçš„æ¶æ„æ—¶ï¼Œæˆ‘ä»¬å¦‚ä½•ç®¡ç†å’Œç»´æŠ¤æ‰€æœ‰è¿™äº›è„šæœ¬æ¥åšæ‰€æœ‰è¿™äº›ç¾å¦™çš„äº‹æƒ…ï¼Ÿä¸€ç§æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„ä¸“ç”¨å›è´­åè®®ï¼Œç„¶åæ„å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰è¿™äº›è„šæœ¬çš„å®¹å™¨æ˜ åƒï¼Œç§°ä¸ºç±»ä¼¼â€œè‡ªåŠ¨åŒ–â€çš„ä¸œè¥¿ã€‚è¿™å¹¶ä¸å®Œå…¨æ˜¯ä¸ªåä¸»æ„ï¼Œå› ä¸ºæˆ‘ä»¬éƒ½åº”è¯¥éµå¾ªGitOpså®è·µï¼Œæˆ‘æ°¸è¿œä¸ä¼šåå¯¹è¿™ä¸€ç‚¹(GitOps alwaysã€‚ä¸€ç›´éƒ½æ˜¯ã€‚ä¸€ç›´éƒ½æ˜¯ã€‚).</p><p id="ef02" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">åœ¨è¿‡å»çš„å‡ å¹´é‡Œï¼Œæˆ‘å‘ç°ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„æ–¹æ³•æ˜¯å°†è¿™äº›è„šæœ¬å­˜å‚¨ä¸º<em class="lb">é…ç½®å›¾</em>ã€‚è¿™ä½¿æˆ‘èƒ½å¤Ÿæ›´è½»æ¾åœ°ç®¡ç†è‡ªåŠ¨åŒ–æ‰€éœ€çš„æ‰€æœ‰è¿™äº›å®šåˆ¶è„šæœ¬ï¼Œå¹¶æ›´å¿«åœ°è¿›è¡Œéƒ¨ç½²ã€‚åœ¨æ¥ä¸‹æ¥çš„æ–‡ç« ä¸­ï¼Œæˆ‘å°†æ¼”ç¤ºä¸€äº›åœ¨<em class="lb">é…ç½®å›¾</em>ä¸­æ”¾ç½®è„šæœ¬çš„åœºæ™¯ï¼Œæ¥æ¼”ç¤ºå¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ã€‚</p><p id="2023" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">å¯¹äºæˆ‘ä»¬çš„K8sç¯å¢ƒï¼Œæˆ‘ä»¬å°†ä½¿ç”¨</em> <a class="ae kc" href="https://kind.sigs.k8s.io/" rel="noopener ugc nofollow" target="_blank"> <em class="lb">ç§ç±»</em> </a> <em class="lb">ã€‚æœ‰å…³KiNDå…¥é—¨çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§æ–‡æ¡£ã€‚è¿™æ˜¯æˆ‘æ¯”è¾ƒå–œæ¬¢çš„æœ¬åœŸå¼€å‘K8sã€‚</em></p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h2 id="e27d" class="lj lk iq bd ll lm ln dn lo lp lq dp lr ko ls lt lu ks lv lw lx kw ly lz ma mb bi translated">åœºæ™¯1:ç”¨Bashæ‰§è¡Œä¸€ä¸ªç®€å•çš„ä»»åŠ¡</h2><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="5531" class="ml lk iq mh b be mm mn l mo mp">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: slim-shady-configmap<br/>data:<br/>  slim-shady.sh: |<br/>    #!/bin/bash<br/><br/>    echo "Hi!"<br/>    echo "My name is"<br/>    echo "What?"<br/>    echo "My name is"<br/>    echo "Who?"<br/>    echo "My name is"<br/>    echo "Chika-chika"<br/>    echo "Slim Shady"</span></pre><p id="9077" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">åœ¨ä¸Šé¢çš„<em class="lb"> configmap </em>ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸ºâ€œslim-shady.shâ€çš„bashè„šæœ¬ï¼Œå®ƒæ¨¡ä»¿äº†Eminemçš„æ­Œè¯<a class="ae kc" href="https://youtu.be/sNPnbI1arSE" rel="noopener ugc nofollow" target="_blank">â€œæˆ‘çš„åå­—æ˜¯â€</a>(<strong class="kf ir">è¯·æ³¨æ„</strong>è¿™ä¸æ˜¯ä¸€ä¸ªçœŸå®çš„ç”¨ä¾‹ğŸ™‚ä½†å´æ˜¯æˆ‘æœ€å–œæ¬¢çš„æ­Œæ›²ä¹‹ä¸€)ã€‚è¦ä½¿ç”¨<em class="lb">é…ç½®å›¾</em>è¿è¡Œè¿™ä¸ªè„šæœ¬ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸‹é¢çš„ä¾‹å­<a class="ae kc" href="https://kubernetes.io/docs/concepts/workloads/controllers/job/" rel="noopener ugc nofollow" target="_blank"> Kubernetes Job </a>å¹¶æµè§ˆä¸€ä¸‹ã€‚</p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="0de0" class="ml lk iq mh b be mm mn l mo mp">apiVersion: batch/v1<br/>kind: Job<br/>metadata:<br/>  name: chicka-chicka-slim-shady<br/>spec:<br/>  template:<br/>    spec:<br/>      containers:<br/>        - name: shady<br/>          image: centos<br/>          command: ["/script/slim-shady.sh"]<br/>          volumeMounts:<br/>            - name: script<br/>              mountPath: "/script"<br/>      volumes:<br/>        - name: script<br/>          configMap:<br/>            name: slim-shady-configmap<br/>            defaultMode: 0500<br/>      restartPolicy: Never</span></pre><p id="0db4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">åœ¨ä¸Šé¢çš„ä½œä¸šæ¸…å•ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¸ºé…ç½®å›¾åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„<a class="ae kc" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/" rel="noopener ugc nofollow" target="_blank">å·ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†è¯¥å·å®‰è£…åœ¨ä½äº<em class="lb"> "/script" </em>çš„shadyå®¹å™¨ä¸‹ï¼Œç„¶åæ‰§è¡Œè„šæœ¬æ–‡ä»¶<em class="lb"> slim-shady.sh </em>ï¼Œè¿™æ˜¯æˆ‘ä»¬çš„<em class="lb">é…ç½®å›¾</em>ä¸­çš„æ–‡ä»¶åã€‚</a></p><p id="2275" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æˆ‘æƒ³åœ¨è¿™é‡ŒæŒ‡å‡ºä¸¤ä»¶äº‹:</p><p id="d5bb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">a)åœ¨å·å†…ï¼Œæˆ‘ä»¬å¿…é¡»æŒ‡å®šä¸€ä¸ªè‡³å°‘ä¸º<em class="lb"> 0500 </em>çš„<em class="lb"> defaultMode </em>(è¯»å–+æ‰§è¡Œç»™ç”¨æˆ·)ã€‚è¿™å®šä¹‰äº†å½“podè¿è¡Œæ—¶å®¹å™¨å†…çš„æ–‡ä»¶æƒé™ã€‚å¦‚æœæˆ‘ä»¬ä¸è®¾ç½®è¿™ä¸ªï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°æƒé™è¢«æ‹’ç»çš„é”™è¯¯ã€‚è¿™æ˜¯å› ä¸ºé»˜è®¤æƒ…å†µä¸‹ï¼Œconfigmapå°†ä¸<em class="lb"> 0644 </em>ä¸€èµ·æŒ‚è½½ï¼Œæ‚¨å°†ä¼šçœ‹åˆ°å¦‚ä¸‹é”™è¯¯ã€‚</p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="0aa3" class="ml lk iq mh b be mm mn l mo mp"> Warning  Failed     7s    kubelet            Error: failed to create containerd task: failed to create shim task: OCI runtime create failed: runc create failed: unable to start container process: exec: "/script/slim-shady.sh": permission denied: unknown</span></pre><p id="75b6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">b)åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è¿˜èƒ½å¤Ÿä½¿ç”¨ç°æœ‰çš„ä¼—æ‰€å‘¨çŸ¥çš„å®¹å™¨æ˜ åƒï¼Œè€Œä¸æ˜¯åˆ›å»ºæˆ‘ä»¬è‡ªå·±çš„æ˜ åƒã€‚è¿™å¯¹æˆ‘ä»¬æ¥è¯´æ›´å®¹æ˜“ï¼Œå› ä¸ºæˆ‘ä»¬ä¸éœ€è¦ç”¨æ–°ä»£ç ç­‰æ„å»ºæ–°çš„æ˜ åƒï¼Œè€Œæ˜¯åªéœ€è¦éƒ¨ç½²<em class="lb">é…ç½®å›¾</em>å’Œ<a class="ae kc" href="https://kubernetes.io/docs/concepts/workloads/controllers/job/" rel="noopener ugc nofollow" target="_blank"> <em class="lb">ä½œä¸š</em> </a>ã€‚</p><p id="9c32" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">åœ¨æˆ‘ä»¬åº”ç”¨å·¥ä½œæ¸…å•ä¹‹åï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹æ—¥å¿—ã€‚</p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="4914" class="ml lk iq mh b be mm mn l mo mp">&gt; kubectl logs -f chicka-chicka-slim-shady-h7j5m<br/>Hi!<br/>My name is<br/>What?<br/>My name is<br/>Who?<br/>My name is<br/>Chika-chika<br/>Slim Shady</span></pre><h2 id="04bb" class="lj lk iq bd ll lm ln dn lo lp lq dp lr ko ls lt lu ks lv lw lx kw ly lz ma mb bi translated">åœºæ™¯2:åœ¨MLflowä¸­æ¨å¹¿æœ€æ–°çš„MLæ¨¡å‹</h2><p id="2df3" class="pw-post-body-paragraph kd ke iq kf b kg mq ki kj kk mr km kn ko ms kq kr ks mt ku kv kw mu ky kz la ij bi translated">ç°åœ¨æ˜¯ä¸€ä¸ªæ›´çœŸå®çš„ä¾‹å­ï¼Œä½†ä»ç„¶æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„è®¾ç½®ã€‚ä»¥ä¸‹å†…å®¹éµå¾ªä¸ä¸Šè¿°ç›¸åŒçš„æ–¹æ³•ï¼Œä½†è¯¥è„šæœ¬çš„ç›®çš„æ˜¯ä»MLflow Registryä¸­è·å–æœ€æ–°çš„MLæ¨¡å‹ï¼Œå¹¶å°†å…¶å‡çº§åˆ°â€œç”Ÿäº§â€ã€‚</p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="16fb" class="ml lk iq mh b be mm mn l mo mp">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: promote-model<br/>data:<br/>  promote_model.py: |<br/>    """<br/>    This file is used to demonstrate how to promote the latest version of a Model to "Production" stage so that it can be<br/>    served out of the Model Registry.<br/>    """<br/>    import os<br/>    import mlflow<br/>    from mlflow.tracking import MlflowClient<br/><br/>    # Set the Remote Tracking Server Information<br/>    mlflow.set_tracking_uri("http://mlflow")<br/><br/>    # Promote the latest Version of Staging to Production<br/>    client = MlflowClient()<br/>    model_name = os.getenv("MODEL_NAME")<br/><br/>    # Get the latest version in Stage "Staging" and promote to "Production"<br/>    models = client.get_latest_versions(model_name, stages=["Staging"])<br/>    for model in models:<br/>        name = model.name<br/>        latest_version = int(model.version)<br/>        run_id = model.run_id<br/>        current_stage = model.current_stage<br/>        print(name, latest_version)<br/>        # Transition<br/>        client.transition_model_version_stage(<br/>            name=name,<br/>            version=latest_version,<br/>            stage="Production"<br/>        )</span></pre><p id="d5a7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ä¸Šé¢çš„ä»£ç æ¥å—ä¸€ä¸ª<em class="lb">ç¯å¢ƒå˜é‡</em>ä½œä¸ºæ¨¡å‹å(<strong class="kf ir"><em class="lb">MODEL _ NAME = OS . getenv(" MODEL _ NAME ")</em></strong>)æ¥æŒ‡å®šè¦æå‡å“ªä¸ªæ¨¡å‹ã€‚è¦å®šä¹‰æ¨¡å‹åï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°å°†å¸¦æœ‰æ¨¡å‹åçš„<a class="ae kc" href="https://kubernetes.io/docs/tasks/inject-data-application/define-environment-variable-container/" rel="noopener ugc nofollow" target="_blank"> <em class="lb"> env </em> </a>ä¼ é€’ç»™ä½œä¸šä¸­çš„å®¹å™¨:</p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="5484" class="ml lk iq mh b be mm mn l mo mp">apiVersion: batch/v1<br/>kind: Job<br/>metadata:<br/>  name: promote-model-a<br/>spec:<br/>  template:<br/>    spec:<br/>      containers:<br/>        - name: promote<br/>          image: wbassler/mlflow-utils:0.0.1<br/>          command:<br/>            - python<br/>          args:<br/>            - /mlflow/promote.py<br/>          env: <br/>            - name: MODEL_NAME<br/>              value: model-a<br/>          volumeMounts:<br/>            - name: promote<br/>              mountPath: "/mlflow"<br/>      volumes:<br/>        - name: promote<br/>          configMap:<br/>            name: promote-model<br/>            defaultMode: 0500<br/>      restartPolicy: Never</span></pre><p id="f450" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æ­£å¦‚ä½ åœ¨ä¸Šé¢çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬ä½¿ç”¨â€œæ¨¡å‹-aâ€ä½œä¸ºæˆ‘ä»¬çš„ç¯å¢ƒå˜é‡ã€‚å½“æˆ‘ä»¬çš„ä»£ç è¢«æ‰§è¡Œæ—¶ï¼Œå®ƒå°†åœ¨MLflowæ¨¡å‹æ³¨å†Œè¡¨ä¸­æ‰¾åˆ°â€œæ¨¡å‹-aâ€çš„æœ€æ–°ç‰ˆæœ¬ï¼Œå¹¶å°†å…¶æå‡åˆ°â€œç”Ÿäº§â€ã€‚</p><p id="f5d4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">è¿™é‡Œè¦æŒ‡å‡ºä¸¤ä»¶äº‹:</p><p id="7d30" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">a)é€šè¿‡ä½¿ç”¨ç°æœ‰çš„å®¹å™¨æ˜ åƒï¼Œæˆ‘ä»¬åˆä¸€æ¬¡èŠ‚çœäº†å¤§é‡æ—¶é—´ï¼Œå¹¶ä¸”ä¸å¿…æ„å»ºè‡ªå·±çš„æ˜ åƒæ¥æ·»åŠ æ–°ä»£ç ã€‚ä¹Ÿè®¸æ‚¨åœ¨è¿™é‡Œæ‰€éœ€è¦çš„åªæ˜¯é€šè¿‡GitOpsæ¥éƒ¨ç½²æ‚¨çš„<em class="lb"> configmap </em>ã€‚</p><p id="04c5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">b)æˆ‘ä»¬ç¼–å†™è„šæœ¬çš„æ–¹å¼ä¹Ÿå¯ä»¥å¾ˆç®€å•åœ°è¢«å…¶ä»–ä½œä¸šé‡ç”¨<em class="lb">ã€‚</em>åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå…¶ä»–å›¢é˜Ÿ/ç”¨æˆ·/ç®¡é“ç­‰å¯ä»¥éå¸¸å®¹æ˜“åœ°é‡ç”¨è„šæœ¬æ¥å‡çº§ä»–ä»¬è‡ªå·±çš„<em class="lb"> MODEL_NAME </em>ï¼Œåªéœ€ç®€å•åœ°æ”¹å˜<em class="lb"> Job </em> manifest <em class="lb">ä¸­çš„<em class="lb"> env </em>ã€‚</em></p><h2 id="35b3" class="lj lk iq bd ll lm ln dn lo lp lq dp lr ko ls lt lu ks lv lw lx kw ly lz ma mb bi translated">åœºæ™¯3:ä¸ºæ–°ç”¨æˆ·åˆ›å»ºæ–°ç›®å½•</h2><p id="2c81" class="pw-post-body-paragraph kd ke iq kf b kg mq ki kj kk mr km kn ko ms kq kr ks mt ku kv kw mu ky kz la ij bi translated">åœ¨æœ€åä¸€ä¸ªåœºæ™¯ä¸­ï¼Œæˆ‘å°†æ¼”ç¤ºå¦‚ä½•æ‰§è¡Œå­˜å‚¨åœ¨<em class="lb">é…ç½®å›¾</em>ä¸­çš„è„šæœ¬ï¼Œè¯¥è„šæœ¬ä»å­˜å‚¨åœ¨<em class="lb">é…ç½®å›¾</em>ä¸­çš„é…ç½®æ–‡ä»¶ä¸­è¯»å–ã€‚åœ¨è§£é‡Šè¿™æ ·åšçš„ç›®çš„ä¹‹å‰ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸‹é¢çš„<em class="lb">é…ç½®å›¾</em>:</p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="aa28" class="ml lk iq mh b be mm mn l mo mp">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: create-users-dir<br/>data:<br/>  users.ini: |<br/>    user1<br/>    user2<br/>    user3<br/>    user5<br/>  create-dir.sh: |<br/>    #!/bin/bash<br/>    set -ex<br/>    cat /scripts/users.ini | while read line<br/>    do<br/>       mkdir -pv /nfs/folder/$line<br/>    done</span></pre><p id="59e1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">åœ¨ä¸Šé¢çš„<em class="lb">é…ç½®å›¾</em>ä¸­ï¼Œæˆ‘ä»¬æ­£åœ¨åˆ›å»ºä¸¤ä¸ªæ–‡ä»¶ã€‚<em class="lb"> users.ini </em>ç”¨äºå®šä¹‰ç”¨æˆ·ç›®å½•åˆ—è¡¨çš„é…ç½®æ–‡ä»¶ã€‚<em class="lb"> create-dir.sh </em>æ˜¯ä¸€ä¸ªbashè„šæœ¬ï¼Œç”¨äºä¸º<em class="lb"> users.ini </em>æ–‡ä»¶ä¸­çš„æ¯ä¸ªæ¡ç›®åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ã€‚</p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="a9be" class="ml lk iq mh b be mm mn l mo mp">---<br/>apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  generateName: create-users-dirs<br/>spec:<br/>  containers:<br/>  - name: create-users<br/>    image: centos<br/>    command: ["/scripts/create-dir.sh"]<br/>    volumeMounts:<br/>    - name: script<br/>      mountPath: "/scripts"<br/>  volumes:<br/>    - name: script<br/>      configMap:<br/>        name: create-users-dir<br/>        defaultMode: 0500<br/>        items:<br/>          - key: create-dir.sh<br/>            path: create-dir.sh<br/>          - key: users.ini<br/>            path: users.ini</span></pre><p id="8c29" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">è¿è¡Œæ—¶:</p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="6d42" class="ml lk iq mh b be mm mn l mo mp">+ cat /scripts/users.ini<br/>+ read line<br/>+ mkdir -pv /nfs/folder/user1<br/>mkdir: created directory '/nfs'<br/>mkdir: created directory '/nfs/folder'<br/>mkdir: created directory '/nfs/folder/user1'<br/>+ read line<br/>+ mkdir -pv /nfs/folder/user2<br/>mkdir: created directory '/nfs/folder/user2'<br/>+ read line<br/>+ mkdir -pv /nfs/folder/user3<br/>mkdir: created directory '/nfs/folder/user3'<br/>+ read line<br/>+ mkdir -pv /nfs/folder/user5<br/>mkdir: created directory '/nfs/folder/user5'<br/>+ read line</span></pre><p id="78fa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">è¿™ä¸ªä¾‹å­éœ€è¦æŒ‡å‡ºä¸¤ç‚¹:</p><p id="d276" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">a)æˆ‘ä»¬å†æ¬¡åˆ©ç”¨ç°æœ‰çš„å®¹å™¨æ˜ åƒï¼Œè€Œä¸å¿…åˆ›å»ºè‡ªå·±çš„æ˜ åƒã€‚</p><p id="8ad9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">b)åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨ç±»ä¼¼Kustomize<a class="ae kc" href="https://kubernetes.io/docs/tasks/manage-kubernetes-objects/kustomization/#configmapgenerator" rel="noopener ugc nofollow" target="_blank"><em class="lb">configMapGenerator</em></a><em class="lb"/>çš„ä¸œè¥¿ï¼Œåœ¨å‡ ä¸ªä¸åŒçš„K8sç¯å¢ƒä¸­é‡ç”¨ç›¸åŒçš„ä»£ç (å¦‚æœæ‚¨æƒ³è·å¾—çœŸæ­£çš„ä¹è¶£ï¼Œè¯·å°†å…¶é›†æˆåˆ°æ‚¨çš„GitOpsç³»ç»Ÿä¸­ğŸ˜º).</p><p id="9d29" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ä½œä¸º<em class="lb"> Pod </em>èµ„æºè¿è¡Œåœ¨è¿™é‡Œæ˜¾ç„¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ï¼Œä½†æ˜¯æˆ‘çœŸçš„å¾ˆå–œæ¬¢ä¸Šé¢çš„åœºæ™¯ï¼Œå› ä¸ºå®ƒå¯ä»¥ä»¥è®¸å¤šä¸åŒçš„æ–¹å¼è¢«åˆ©ç”¨ï¼Œæ¯”å¦‚ä½œä¸º<em class="lb">ä½œä¸š</em>æˆ–è€…ä½œä¸º<a class="ae kc" href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/" rel="noopener ugc nofollow" target="_blank">init container</a>ã€‚ä½œä¸ºCIç®¡é“çš„ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥åœ¨æ¯æ¬¡å‘<em class="lb"> config.ini </em>æ·»åŠ æ–°ç”¨æˆ·æ—¶è¿è¡Œæ–°çš„<em class="lb">ä½œä¸š</em>ï¼Œæˆ–è€…å¯ä»¥åœ¨æ¯æ¬¡podå¯åŠ¨æ—¶è¿è¡Œ<em class="lb"> initContainer </em>ä»¥ç¡®ä¿æ‰€æœ‰ç›®å½•å·²ç»å­˜åœ¨ã€‚</p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><p id="2fcf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">å°†è„šæœ¬ç”šè‡³ä»£ç å­˜å‚¨ä¸º<em class="lb"> configmaps </em>å¹¶ä¸æ˜¯ä»€ä¹ˆæ–°é²œäº‹ï¼Œä¹Ÿä¸æ˜¯æˆ‘è‡ªå·±æƒ³å‡ºæ¥çš„ã€‚æˆ‘å¤šå¹´æ¥å®‰è£…å’Œä½¿ç”¨çš„å‡ ä¸ªKubernetesåº”ç”¨ç¨‹åºå’Œæ“ä½œç¨‹åºä¹Ÿéµå¾ªè¿™ç§æ–¹æ³•ã€‚è¿™ç§æ–¹æ³•æœ‰è®¸å¤šä¼˜ç‚¹å’Œç¼ºç‚¹ï¼Œä½†æ˜¯å¸Œæœ›æˆ‘å·²ç»ç»™äº†é‚£é‡Œçš„ä¸€äº›äººä¸€ä¸ªæƒ³æ³•ï¼Œå¯ä»¥èŠ‚çœä»–ä»¬ä¸€äº›æ—¶é—´ï¼Œå¹¶ä¸”ç»™è‡ªåŠ¨åŒ–å¸¦æ¥ä¸€äº›æ–¹ä¾¿ã€‚</p></div></div>    
</body>
</html>