# ä½¿ç”¨ Scala æœŸè´§å¤„ç†åˆ©ç‡é™åˆ¶

> åŸæ–‡ï¼š<https://itnext.io/handling-rate-limits-with-scala-futures-8904538bca7f?source=collection_archive---------0----------------------->

## ä¸ºäº†èµ°å¾—æ›´å¿«ï¼Œåœ¨èµ°å¾—å¿«æ—¶å‡é€Ÿã€‚

![](img/c4b568f668e33b9fe9f879633cfb4245.png)

(æ¥æº:[æ´¾å…‹æ–¯](https://www.pexels.com/photo/yellow-and-black-road-concrete-barrier-638487/))

å½“å¼€å‘/é›†æˆå¤–éƒ¨ API æ—¶ï¼Œé€Ÿç‡é™åˆ¶æ˜¯ç”Ÿæ´»ä¸­ä¸å¹¸çš„ä¸€éƒ¨åˆ†ã€‚é€Ÿç‡é™åˆ¶åœ¨å…¶å®ç°ä¸­å„ä¸ç›¸åŒï¼Œä½†é€šå¸¸å½’ç»“ä¸ºå¯¹ç‰¹å®šæ—¶é—´çª—å£å†…å¯ä»¥å‘å‡ºçš„è¯·æ±‚çš„æ•°é‡(ä»¥åŠå¯èƒ½çš„ç±»å‹)çš„æŸç§é¢„å®šä¹‰é™åˆ¶ã€‚

åœ¨ç¼–å†™å…·æœ‰å¤šä¸ªé›†æˆç‚¹çš„å¹¶å‘ä»£ç æ—¶ï¼Œå¤„ç†è¿™ä¸ªé—®é¢˜å¯èƒ½ä¼šå¾ˆå›°éš¾ã€‚ä½ çš„ç¬¬ä¸€ååº”å¯èƒ½æ˜¯[å¼•å…¥é‡è¯•](https://hackernoon.com/exponential-back-off-with-scala-futures-7426340d0069)ï¼›ç„¶è€Œï¼Œè¿™å¹¶ä¸èƒ½ç¡®ä¿å…¬å¹³æ€§ï¼Œå¹¶å¯¼è‡´æ•°æ®ç«äº‰ã€‚ä¸ºäº†æ­£ç¡®å¤„ç†å’Œéµå®ˆé€Ÿç‡é™åˆ¶ï¼Œè§£å†³æ–¹æ¡ˆå¿…é¡»å…·æœ‰ä»¥ä¸‹ç‰¹æ€§:

*   è¯·æ±‚çš„ä¸²è¡ŒåŒ–(ä»¥ç¡®ä¿å…¬å¹³æ€§)
*   è·Ÿè¸ªé…é¢ä½¿ç”¨æƒ…å†µ
*   æ£€æµ‹ä¸è¶…å‡ºé…é¢ç›¸å…³çš„é”™è¯¯
*   è®¡åˆ’é‡è¯•ï¼ŒåŒæ—¶ä¿æŒåºåˆ—åŒ–
*   æ”¯æŒè¶…æ—¶(ä»¥é˜²é˜Ÿåˆ—å˜å¤§)
*   è·Ÿè¸ªé˜Ÿåˆ—é•¿åº¦å’Œä¼°è®¡ç­‰å¾…æ—¶é—´

é™¤äº†ç¬¬ä¸€æ¡ï¼Œè¿™äº›éƒ½æ˜¯æœ‰æ„ä¹‰çš„ã€‚å€¼å¾—æ¾„æ¸…çš„æ˜¯ï¼Œè¿™é‡Œçš„åºåˆ—åŒ–åªåŒ…æ‹¬è¯·æ±‚æ‰§è¡Œé¡ºåºï¼Œä¸åŒ…æ‹¬å®Œæˆé¡ºåºã€‚è¿™æ„å‘³ç€è¯·æ±‚çš„å¹¶è¡Œæ‰§è¡Œä»ç„¶å­˜åœ¨ã€‚å½“ç„¶ï¼Œå¦‚æœä¸æ˜¯è¿™æ ·çš„è¯ï¼Œæˆ‘åœ¨è¿™ç¯‡æ–‡ç« ä¸­ä½¿ç”¨`Future` s å°±æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰äº†ã€‚ğŸ˜‰

# é©¬å…·

å¦‚æœæˆ‘ä»¬ä¸èƒ½æŠŠä¸€å †ä»£ç è½¬å‚¨åˆ°ä¸€ä¸ª REPL ä¸­å»ç©ï¼Œé‚£ä¹ˆå±•ç¤ºè¿™äº›ä»£ç å°±æ²¡æœ‰æ„æ€äº†ã€‚è¿™ç¯‡æ–‡ç« ä¸­çš„ä»£ç æ²¡æœ‰ä»»ä½•ä¾èµ–å…³ç³»ï¼Œæˆ‘åœ¨æ¯ä¸€èŠ‚çš„æœ«å°¾éƒ½æ”¾äº†ä¸€ä¸ªé“¾æ¥ï¼Œé“¾æ¥åˆ°ä¸€ä¸ªè¦ç‚¹ï¼Œè¿™æ˜¯è¯¥ç‚¹çš„ç´¯ç§¯ä»£ç ï¼Œæ‚¨å¯ä»¥å°†å…¶ç²˜è´´åˆ°æ‚¨çš„ REPL ä¸­(protip: type `:paste`åˆ° REPL ä¸­ä»¥è½¬å‚¨å¤§å—ä»£ç )ã€‚

å½“ç„¶ï¼Œè¿™ç¯‡æ–‡ç« åªä¸ºä½ è‡ªå·±çš„ API è°ƒç”¨æä¾›äº†åŒ…è£…ï¼Œæ‰€ä»¥ä¸ºäº†ç¡®ä¿æˆ‘ä»¬è¿˜æœ‰ä¸œè¥¿å¯ä»¥ç©ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæ¨¡æ‹Ÿ API è°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ–‡ç« ä¸­ä½¿ç”¨ã€‚

æˆ‘ä»¬å¯ä»¥å°†å®ƒå¤åˆ¶ç²˜è´´åˆ°æˆ‘ä»¬çš„ Scala REPL ä¸­ï¼Œå¼€å§‹äº«å—ä¹è¶£å§ï¼

# åºåˆ—åŒ–è¯·æ±‚

![](img/ce1b77e5c7392f576dd596c72167ad36.png)

(æ¥æº:[åƒç´ ](https://www.pexels.com/photo/blueberry-bowl-breakfast-cereal-216951/))

æ˜¯æ—¶å€™æå‡ºè¦æ±‚äº†ï¼

> å‘ƒâ€¦

å¼€ç©ç¬‘ï¼Œæ— è®ºå¦‚ä½•â€¦ä¸ºäº†ä½¿æˆ‘ä»¬çš„è¯·æ±‚è¿ç»­ï¼Œæˆ‘ä»¬éœ€è¦æŸç§ FIFO æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥æ§åˆ¶æˆ‘ä»¬çš„è¯·æ±‚ï¼›æ‰€ä»¥ï¼Œä¸€ä¸ªé˜Ÿåˆ—ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨æŸä¸ªæ—¶é—´è·¨åº¦å†…é™åˆ¶å½“å‰æ´»åŠ¨è¯·æ±‚çš„æ•°é‡(æˆ‘ä»¬çš„åŸºæœ¬é€Ÿç‡é™åˆ¶æ”¯æŒ)ã€‚

è®©æˆ‘ä»¬ä»ä¸€äº›åŸºæœ¬çš„ä¼šè®¡ç»“æ„å’Œä¸€ä¸ªç”¨äºæ€»ç»“è¿™ä¸€åˆ‡çš„ç±»å¼€å§‹:

æˆ‘ä»¬çš„ç­çº§æ‹¥æœ‰æˆ‘ä»¬å¼€å§‹å­¦ä¹ æ‰€éœ€çš„ä¸€åˆ‡ã€‚è¯¥ç±»çš„è¾“å…¥æ˜¯ä¸€ä¸ªé™åˆ¶å’Œä¸€ä¸ªæŒç»­æ—¶é—´ã€‚è¿™æ„æˆäº†æˆ‘ä»¬é™é€Ÿè¡Œä¸ºçš„åŸºç¡€ã€‚åœ¨ç±»å†…éƒ¨ï¼Œæˆ‘ä»¬æœ‰ä¸€äº›ä¸œè¥¿éœ€è¦è·Ÿè¸ªã€‚é¦–å…ˆæˆ‘ä»¬æœ‰`requestQueue`,é¡¾åæ€ä¹‰ï¼Œå®ƒæ˜¯ä¸€ä¸ªç­‰å¾…è¯·æ±‚çš„é˜Ÿåˆ—ã€‚ç°åœ¨ï¼Œè¯·æ±‚è¢«è¡¨ç¤ºä¸º`RequestQueueItem`,è¿™å°†åœ¨åé¢è§£é‡Šã€‚

æˆ‘ä»¬è¿˜æœ‰`requestCount`å’Œ`windowStopTime`å­—æ®µï¼Œç”¨äºç¡®ä¿å¯¹äºä»`timeFrame`å¾—åˆ°çš„ç»™å®šæ—¶é—´çª—å£ï¼Œæˆ‘ä»¬ä¸ä¼šè¶…è¿‡æˆ‘ä»¬çš„é™åˆ¶ã€‚

`request`æ˜¯æˆ‘ä»¬ä»Šå¤©ç¼–å†™çš„ API ä¸­çš„ star æ–¹æ³•ã€‚å®ƒç›¸å½“ç®€å•ï¼Œå› ä¸ºå®ƒéœ€è¦ä¸€ä¸ªäº§ç”Ÿ`Future`çš„å‡½æ•°ã€‚è¿™ä¸ªæä¾›çš„å‡½æ•°æ˜¯ç”¨æˆ·å®šä¹‰çš„ä»£ç ï¼Œç”¨äºå‘æˆ‘ä»¬çš„é€Ÿç‡å—é™ API å‘å‡ºè¯·æ±‚ã€‚`request`ç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„`Promise`å¯¹è±¡ï¼Œå¹¶å°†å…¶`Future`ä¼ é€’å›å®¢æˆ·ç«¯ã€‚ç°åœ¨æˆ‘ä»¬çš„ä»£ç å¯ä»¥æ§åˆ¶`Future`çš„æ‰§è¡Œï¼Œå¹¶ä¸”åªåœ¨æˆ‘ä»¬éœ€è¦çš„æ—¶å€™å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯(è€Œä¸æ˜¯ç›´æ¥ç»„åˆ`Future`å¹¶è¿”å›)ã€‚

æœ€åï¼Œå¯¹`tryRequest`çš„è°ƒç”¨æ£€æŸ¥æ˜¯å¦å¯ä»¥å‘å‡ºè¯·æ±‚ï¼Œå¹¶å‘å‡ºè¯·æ±‚ã€‚è¿™æ˜¯ä¸ºäº†ç¡®ä¿å½“é˜Ÿåˆ—æœ‰å®¹é‡æ—¶ï¼Œä¸€ä¸ªè¯·æ±‚è¢«æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­å°±è¢«è§¦å‘ï¼Œè€Œä¸æ˜¯ä½¿ç”¨æŸç§è°ƒåº¦ä»£ç ã€‚

è®©æˆ‘ä»¬çœ‹çœ‹ `hasCapacity`æ˜¯å¦‚ä½•å·¥ä½œçš„:

`hasCapacity`æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦å¯ä»¥åœ¨å½“å‰æ—¶é—´çª—å£å†…æå‡ºè¯·æ±‚ã€‚ä½†æ˜¯ï¼Œå¦‚æœå®ƒæ³¨æ„åˆ°æˆ‘ä»¬åœ¨æ—¶é—´çª—å£ä¹‹å¤–ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çª—å£ï¼Œå¹¶é‡ç½®æˆ‘ä»¬çš„è¯·æ±‚è®¡æ•°å™¨ã€‚

æˆ‘ä»¬åˆå§‹ä»£ç çš„æœ€åä¸€ä½æ˜¯é€šè¿‡`makeRequest`è¯·æ±‚çš„å®é™…æ‰§è¡Œ:

è¿™ä¸ªæœ‰ç‚¹é•¿ï¼Œä½†è¿˜æ˜¯å¾ˆå®¹æ˜“åˆ†è§£ã€‚å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªè¯·æ±‚ï¼Œæˆ‘ä»¬å¢åŠ è¯·æ±‚è®¡æ•°ï¼Œç„¶åæ‰§è¡Œç”¨æˆ·æä¾›çš„è¯·æ±‚å‡½æ•°ã€‚å¦‚æœè¿™å¯¼è‡´å¤±è´¥ï¼Œæˆ‘ä»¬å°†è¯·æ±‚é‡æ–°æ’é˜Ÿï¼Œå¹¶å°è¯•å‘å‡ºå¦ä¸€ä¸ªè¯·æ±‚ã€‚å¦‚æœæˆ‘ä»¬æˆåŠŸäº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æŠŠç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚æœ€åï¼Œæˆ‘ä»¬å°è¯•æå‡ºå¦ä¸€ä¸ªè¯·æ±‚ã€‚æˆ‘ä»¬åœ¨æœªæ¥ä¹‹å¤–è¿™æ ·åšæ˜¯ä¸ºäº†å…è®¸å¹¶è¡Œæ‰§è¡Œï¼Œå¹¶ç¡®ä¿æˆ‘ä»¬ä½¿ç”¨åˆ†é…çš„é™åˆ¶(ä¾‹å¦‚ï¼Œé«˜ååé‡+é«˜å»¶è¿Ÿ)ã€‚

æ³¨æ„ï¼Œåœ¨å¤±è´¥çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¿…é¡»è¿›è¡ŒåŒæ­¥ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨`Future`çš„å›è°ƒä¸­ä»ä¸åŒçš„ä¸Šä¸‹æ–‡ä¸­ä¿®æ”¹é˜Ÿåˆ—çš„çŠ¶æ€ã€‚

[åˆ°ç›®å‰ä¸ºæ­¢ä»£ç çš„è¦ç‚¹ã€‚](https://gist.github.com/JohnMurray/b4392a913b8f56c428d57555c1e1cf63)

è®©æˆ‘ä»¬å°†å®ƒç²˜è´´åˆ° REPL ä¸­ï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆ:

```
scala> val service = new ApiService[String](5, 10.seconds)scala> (1.to(10)).map({ _ => service.request(
  () => MockAPI.simpleService
)}).toListres5: List[scala.concurrent.Future[String]] = List(
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(<not completed>),
  Future(<not completed>),
  Future(<not completed>),
  Future(<not completed>),
  Future(<not completed>)
)
```

å› ä¸ºæˆ‘ä»¬çš„ MockAPI å³æ—¶è¿”å›ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒåƒé¢„æœŸçš„é‚£æ ·å·¥ä½œã€‚ç»™å®š 10 ä¸ªè¦æ‰§è¡Œçš„é¡¹ç›®ï¼Œæˆ‘ä»¬åªå–å› 5 ä¸ªã€‚å‰©ä¸‹çš„ 5 ä¸ªå¿…é¡»ç­‰å¾…ä¸‹ä¸€ä¸ªæ‰§è¡Œçª—å£ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬ç­‰å¾… 10 ç§’é’Ÿå·¦å³ï¼Œç„¶åé‡æ–°æ£€æŸ¥ä»–ä»¬çš„çŠ¶æ€ï¼Œä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿ

```
scala> res5res6: List[scala.concurrent.Future[String]] = List(
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(<not completed>),
  Future(<not completed>),
  Future(<not completed>),
  Future(<not completed>),
  Future(<not completed>)
)
```

å¥½å§ï¼Œé‚£ä¼¼ä¹ä¸èµ·ä½œç”¨ã€‚é—®é¢˜æ˜¯ï¼Œä¸€æ—¦è¾¾åˆ°å®¹é‡ï¼Œä¸€æ—¦æ–°çš„æ—¶é—´çª—å£æ‰“å¼€ï¼Œå°±æ²¡æœ‰æµç¨‹å†æ¬¡å¯åŠ¨è¯·æ±‚ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé™¤éæœ‰äººæå‡ºå¦ä¸€ä¸ªè¦æ±‚ã€‚è¿™æ˜¯ä¸ç†æƒ³çš„ã€‚è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

è¿™å¤ªé…·äº†ã€‚æˆ‘ä»¬ä» Java æ ‡å‡†åº“ä¸­æå–äº†ä¸€äº›éå¸¸æ–¹ä¾¿çš„å®ç”¨ç¨‹åºï¼Œå…è®¸æˆ‘ä»¬å¼‚æ­¥è°ƒåº¦ä»»åŠ¡ã€‚ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å½“å‰æ—¶é—´çª—å£å†…ç”¨å®Œäº†å®¹é‡ï¼Œæˆ‘ä»¬å¯ä»¥å®‰æ’ä¸€ä¸ªä»»åŠ¡åœ¨ä¸‹ä¸€ä¸ªçª—å£å¼€å§‹æ—¶è¿›è¡Œé‡æ–°æ£€æŸ¥ã€‚å¦‚æœç”±äºæŸç§åŸå› ï¼Œæˆ‘ä»¬çš„èƒ½åŠ›å‘ç”Ÿå˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥å–æ¶ˆä»»åŠ¡ã€‚è¿™æ®µä»£ç çš„ä¸€ä¸ªæ£˜æ‰‹ä¹‹å¤„æ˜¯ä½¿ç”¨äº†`@volatile`ï¼Œè¿™ç¡®ä¿äº†è¯»å–çš„æ˜¯`recheckFut`çš„ä¸€è‡´ç‰ˆæœ¬(å› ä¸ºæˆ‘ä»¬åœ¨å¤šçº¿ç¨‹ä¸­æ›´æ–°å®ƒ)ã€‚è™½ç„¶è¿™ç¡®å®äº§ç”Ÿäº†æŸç§ç«äº‰æ¡ä»¶ï¼Œä½†æ˜¯æ’åˆ—å¾ˆå®¹æ˜“ç†è§£ï¼Œå¹¶ä¸”æ¯”å¼•å…¥é¢å¤–çš„é”æ›´å¥½(åœ¨æˆ‘çœ‹æ¥)ã€‚

ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬é‡æ–°è¿è¡Œå‰é¢çš„ç¤ºä¾‹ï¼Œç­‰å¾… 10 ç§’é’Ÿï¼Œæˆ‘ä»¬åº”è¯¥ä¼šçœ‹åˆ°æ‰€æœ‰çš„ä»»åŠ¡éƒ½å®Œæˆäº†ã€‚

```
scala> (1.to(10)).map({ _ => service.request(
  () => MockAPI.simpleService
)}).toListres5: List[scala.concurrent.Future[String]] = ...
// Wait 10 seconds and then look at res5res5: List[scala.concurrent.Future[String]] = List(
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(Success(1, 2, 3, 4, 5, 6))
)
```

ç°åœ¨æƒ…å†µçœ‹èµ·æ¥å¥½å¤šäº†ï¼Œä½†ä»æœ‰ä¸€ä¸ªé—®é¢˜ä¸å¤ªæ˜æ˜¾ã€‚å¦‚æœç”¨æˆ·æä¾›çš„å‡½æ•°å¤±è´¥(å‡ºäºä»»ä½•åŸå› )ï¼Œé‚£ä¹ˆæˆ‘ä»¬å‡è®¾è¿™æ˜¯ä¸€ä¸ªä¸é€Ÿç‡é™åˆ¶ç›¸å…³çš„å¤±è´¥ï¼Œå¹¶å¯¹è¯·æ±‚é‡æ–°æ’é˜Ÿã€‚ç°å®æƒ…å†µæ˜¯ï¼Œå¯¹äºç½‘ç»œä¸Šä»»ä½•ç§ç±»çš„ API è¯·æ±‚ï¼Œé€Ÿç‡é™åˆ¶åªæ˜¯æˆ‘ä»¬å¯èƒ½é‡åˆ°çš„ä¸€å°ç±»é”™è¯¯ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚è¿›ä¸€æ­¥æ¢è®¨è¿™ä¸€ç‚¹ã€‚

[åˆ°ç›®å‰ä¸ºæ­¢çš„ä»£ç è¦ç‚¹ã€‚](https://gist.github.com/JohnMurray/884884fef9a47fe65aecacf27fe0a4e0)

# æ£€æµ‹é…é¢é”™è¯¯

ç”¨æˆ·éœ€è¦ä¸€ç§æ–¹æ³•æ¥å®šä¹‰ä»€ä¹ˆæ˜¯é€Ÿç‡é™åˆ¶é”™è¯¯ï¼Œä»€ä¹ˆä¸æ˜¯ã€‚æ­¤å¤–ï¼Œç”¨æˆ·ä¸åº”è¯¥ä¸ºäº†æ£€æµ‹é€Ÿç‡é™åˆ¶å¼‚å¸¸è€Œå±€é™äºå¤±è´¥çš„`Future`ã€‚è¿™å¯ä»¥å¾ˆå®¹æ˜“åœ°ç”¨ä¸‹é¢çš„ç±»å‹æ¥è¡¨ç¤º:

```
Either[Throwable, T] => Boolean
```

æˆ‘ä»¬å¯ä»¥ä¿æŒç›¸åŒçš„é»˜è®¤è¡Œä¸ºï¼ŒåŒæ—¶å°†å…¶æ‰©å±•ä¸ºå¯ç”±ç”¨æˆ·è¦†ç›–:

çœå»æ‰“å­—ï¼Œ`LimitDetector`ä»£è¡¨æˆ‘ä»¬çš„`PartialFunction`ã€‚`request`ç°åœ¨è·å–ä¸€ä¸ª`LimitDetector`å¹¶å°†å…¶æ”¾å…¥é˜Ÿåˆ—é¡¹ä¸­ä»¥å¤‡åç”¨ã€‚å¦‚æœç”¨æˆ·æ²¡æœ‰æŒ‡å®šï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼ã€‚é»˜è®¤å€¼æœ€åˆç”±ç±»è®¾ç½®(åˆ°æˆ‘ä»¬æœ€åˆçš„è¡Œä¸º)ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨`withDefaultLimitDetection`åœ¨å®ä¾‹çº§è®¾ç½®ã€‚ç°åœ¨æ›´æ–°`makeRequest`åŠŸèƒ½:

é™¤äº†å¯¹æ–¹æ³•è¿›è¡Œä¸€äº›ä¸€èˆ¬æ€§çš„é‡ç»„ä»¥ä½¿å…¶æ›´å…·å¯è¯»æ€§(å‡å°‘åµŒå¥—)ï¼Œä¸»è¦çš„å˜åŒ–æ˜¯åœ¨è¯·æ±‚å®Œæˆ(`result.onComplete`)æ—¶ï¼Œæˆ‘ä»¬æ£€æŸ¥æˆåŠŸ*å’Œ*å¤±è´¥æ¡ˆä¾‹ä»¥ç¡®å®šæ˜¯å¦éœ€è¦é‡è¯•ã€‚ç”±äºè¿™ç§é”™è¯¯å¤„ç†æ˜¯ç‰¹å®šäºè¶…å‡ºé€Ÿç‡çš„é”™è¯¯ï¼Œæˆ‘ä»¬å°†è€ƒè™‘æ­£åœ¨åˆ›å»ºçš„æ— é™é‡è¯•å¾ªç¯çš„é¢„æœŸè¡Œä¸ºã€‚

[åˆ°ç›®å‰ä¸ºæ­¢ä»£ç çš„è¦ç‚¹ã€‚](https://gist.github.com/JohnMurray/83a0970b82d2984343609d52491e1b23)

è®©æˆ‘ä»¬ä½¿ç”¨é»˜è®¤çš„æé™æ£€æµ‹æ¥å°è¯•è¿™ä¸ªæ–°ä»£ç :

```
scala> val service = new ApiService[String](5, 10.seconds)scala> (1.to(10)).map({ _ => service.request(
     |   () => MockAPI.throwingRateLimitedService
     | )()}).toListres3: List[scala.concurrent.Future[String]] = List(
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(<not completed>),
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(<not completed>),
  Future(<not completed>),
  Future(<not completed>),
  Future(<not completed>),
  Future(<not completed>),
  Future(<not completed>))
```

æˆ‘ä»¬å®é™…ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œ5 ä¸ªåˆå§‹è¯·æ±‚ä¸­æœ‰ 2 ä¸ªå¤±è´¥äº†ï¼Œå¹¶åœ¨åå°é‡è¯•ã€‚å¦‚æœæˆ‘ä»¬åœ¨å‡ ç§’é’ŸåæŸ¥çœ‹`res3`çš„ç»“æœï¼Œæˆ‘ä»¬å¯èƒ½ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„å†…å®¹:

```
scala> res3
res8: List[scala.concurrent.Future[String]] = List(
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(<not completed>),
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(Success(1, 2, 3, 4, 5, 6)),
  Future(<not completed>),
  Future(Success(1, 2, 3, 4, 5, 6)),   
  Future(<not completed>),
  Future(<not completed>),
  Future(<not completed>),
  Future(<not completed>))
```

ä½ å¯ä»¥çœ‹åˆ°å–å¾—äº†è¿›å±•ï¼Œä½†å¯èƒ½æ²¡æœ‰ä½ æƒ³è±¡çš„é‚£ä¹ˆå¤šã€‚è¿™æ˜¯å› ä¸ºå¤±è´¥çš„è¯·æ±‚ä¼šåœ¨é˜Ÿåˆ—çš„æœ€å‰é¢é‡æ–°æ’é˜Ÿã€‚å¦‚æœä»–ä»¬ç»§ç»­å¤±è´¥ï¼Œé‚£ä¹ˆå°±ä¸ä¼šå–å¾—ä»€ä¹ˆè¿›å±•ã€‚ç”±äºè¢«é‡æ–°æ’é˜Ÿçš„è¯·æ±‚çš„å¼‚æ­¥æ€§è´¨ï¼Œå‡ºç°äº†ä¸€äº›æ— åºçš„è¿›å±•ã€‚æœ€ç»ˆï¼Œæ‰€æœ‰ä»»åŠ¡éƒ½å°†å®Œæˆã€‚

åŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ·»åŠ çš„æé™æ£€æµ‹ä»£ç æ¥ç¡®ä¿ç›¸åŒçš„ä»£ç å·¥ä½œã€‚

```
(1.to(10)).map({ _ =>
  service.request(() => MockAPI.nonThrowingRateLimitedService) {
    case Left(_)    => false
    case Right(msg) => msg == "RATELIMIT_EXCEEDED"
  }
}).toList
```

æˆ‘ä¼šè®©ä½ åœ¨ä½ çš„ REPL é‡Œç©è¿™ä¸ªã€‚

# æ”¯æŒè¶…æ—¶

![](img/490009bf0de2e6d88ad6ddccd332b950.png)

(è‚¯Â·åŠ³ä¼¦æ–¯åœ¨ [Unsplash](https://unsplash.com/search/photos/otu-of-time?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) ä¸Šæ‹æ‘„)

æ— è®ºæˆ‘ä»¬å–œæ¬¢ä»€ä¹ˆï¼Œç¨ç‡é™åˆ¶éƒ½æ˜¯ä¸€ä¸ªå¿…é¡»è§£å†³çš„é—®é¢˜ã€‚æœ‰æ—¶è¿™æ„å‘³ç€æ‚¨å¯èƒ½æƒ³è¦è¿›è¡Œæ¯”æ‚¨çš„èƒ½åŠ›æ›´å¤šçš„ API è°ƒç”¨ã€‚è™½ç„¶é€‚å½“çš„æ’é˜Ÿå’Œé‡è¯•ä¼šæœ‰æ‰€å¸®åŠ©â€¦

> ä»€ä¹ˆï¼æˆ‘ä¸€ç›´åœ¨å…³æ³¨ä½ å‘Šè¯‰æˆ‘æˆ‘ä»¬å»ºç«‹çš„å¥‡ç‰¹çš„é˜Ÿåˆ—å’Œé‡è¯•æœºåˆ¶ä¸æ˜¯ç­”æ¡ˆå—ï¼Ÿï¼ï¼Ÿ(â•¯ â–¡ )â•¯ï¸µ â”»â”â”»

è¯·å†·é™ä¸‹æ¥ã€‚è¿™äº›äº‹æƒ…*æ˜¯*é‡è¦çš„ï¼Œä½†æ˜¯å½“è¯·æ±‚ç»§ç»­æ¯”æ‚¨çš„é…é¢å…è®¸çš„æ›´å¿«æ—¶ï¼Œæ‚¨å¯èƒ½æƒ³è¦æä¾›æŸç§å¿«é€Ÿå¤±è´¥æœºåˆ¶ï¼Œä»¥ä¾¿æ‚¨çš„åº”ç”¨ç¨‹åºå¯ä»¥ä¼˜é›…åœ°å¤±è´¥ã€‚

å½“ç„¶ï¼Œå¦ä¸€ç§é€‰æ‹©æ˜¯å¿½ç•¥è¿™ä¸ªé—®é¢˜ï¼Œè®©è¯·æ±‚å †ç§¯èµ·æ¥ï¼Œç›´åˆ°é˜Ÿåˆ—å˜å¾—å¦‚æ­¤ä¹‹å¤§ï¼Œä»¥è‡³äºè€—å°½äº†å†…å­˜å¹¶ä½¿æœºå™¨å´©æºƒã€‚è¿™ä»…å‘ç”Ÿåœ¨æ‚¨çš„å“åº”æ—¶é—´ä¹‹åï¼Œå‡è®¾è¿™äº› API è°ƒç”¨çš„ç»“æœä¼ æ’­åˆ°å®¢æˆ·ç«¯ï¼Œç²—ç•¥åœ°æ‹æ‘„ã€‚

> å¤©å•Šï¼Œä½ æ²¡å¿…è¦è¿™ä¹ˆåˆ»è–„ã€‚æˆ‘ä¼šé€‰æ‹©ç¬¬ä¸€ä¸ªé€‰é¡¹ã€‚

ä¸é”™çš„é€‰æ‹©ï¼æˆ‘ä»¬å¯ä»¥ç®€å•åœ°å‘æˆ‘ä»¬çš„`request`å‡½æ•°æ·»åŠ å¦ä¸€ä¸ªå‚æ•°æ¥æŒ‡å®šæˆ‘ä»¬å¸Œæœ›ç­‰å¾…çš„æœ€å¤§æ—¶é—´:

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬å·²ç»å‘æˆ‘ä»¬çš„`RequestQueueItem`å¯¹è±¡æ·»åŠ äº†ä¸€ä¸ªæ–°å­—æ®µ:

`request`æ–¹æ³•ç°åœ¨éœ€è¦ç­‰å¾…æœ€é•¿æ—¶é—´(é»˜è®¤ä¸ºæ°¸è¿œ)ï¼Œç„¶åè®¡ç®—ä¸€ä¸ªæœŸé™ï¼Œè®©æˆ‘ä»¬*å¼€å§‹*æ‰§è¡Œè¯·æ±‚ã€‚æˆ‘ä»¬å·²ç»é™ˆè¿°äº†æˆ‘ä»¬çš„æ„å›¾ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬çš„æˆªæ­¢æ—¥æœŸåˆ°äº†ï¼Œæˆ‘ä»¬ä»ç„¶å¸Œæœ›å‘ç”Ÿä¸€äº›äº‹æƒ…:

*   æˆ‘ä»¬ä¸æƒ³æµªè´¹èµ„æºæ¥æ‰§è¡Œä¸€ä¸ªè¶…è¿‡æˆªæ­¢æ—¥æœŸçš„è¯·æ±‚
*   æˆ‘ä»¬åº”è¯¥å®Œæˆç”¨æˆ·çš„`Future`ä½œä¸ºä¸€ä¸ªè¶…æ—¶çš„ï¼Œå¤±è´¥çš„æœªæ¥
*   æˆ‘ä»¬åº”è¯¥å°†è¯·æ±‚ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œä»¥é¿å…å¯¹è±¡å †ç§¯å’Œè€—å°½å†…å­˜

ä¸ºäº†æœ‰æ•ˆåœ°åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªå‡½æ•°æ¥æ•´ç†æˆ‘ä»¬çš„é˜Ÿåˆ—ï¼Œå¹¶æ¯éš” N ä¸ªæ—¶é—´å•ä½è°ƒç”¨å®ƒã€‚æ—¶é—´å•ä½ç”±å®¢æˆ·ç«¯é…ç½®ï¼Œå…¶å·¥ä½œåŸç†ç±»ä¼¼äºæˆ‘ä»¬çš„`windowStopTime`å’Œ`timeFrame`å€¼ã€‚

æœ‰äº†è¿™äº›æ–°å€¼ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªç®€å•çš„æ¸…ç†ç¨‹åºæ¥æ‰§è¡Œæ¯ä¸ª`cleanupTimeFram`:

`cleanupRequests`æ£€æŸ¥æ˜¯å¦åˆ°äº†æ¸…ç†é˜Ÿåˆ—çš„æ—¶é—´ã€‚å¦‚æœæ˜¯ï¼Œå®ƒä»é˜Ÿåˆ—ä¸­åˆ é™¤æ‰€æœ‰è¿‡æ—¶çš„è¯·æ±‚ï¼Œç”¨ä¸€ä¸ª`TimeoutException`å®Œæˆå®ƒä»¬ï¼Œå¹¶é‡æ–°è®¾ç½®ä¸‹ä¸€æ¬¡æ¸…ç†çš„æ—¶é—´ã€‚

æœ€åä¸€ä»¶è¦æ³¨æ„çš„äº‹æƒ…æ˜¯ç¡®ä¿æˆ‘ä»¬ä¸ä¼šå¯¹å·²ç»è¶…è¿‡æ—¶é—´é™åˆ¶çš„è¯·æ±‚æ‰§è¡Œå·¥ä½œï¼Œä½†æ˜¯åœ¨è¢«å¼¹å‡ºé˜Ÿåˆ—ä¹‹å‰è®¾æ³•é¿å…äº†æ¸…ç†åŠŸèƒ½:

`makeRequest`å‡½æ•°ç°åœ¨ä¼šå¿«é€Ÿä¸¢å¼ƒè¶…è¿‡æˆªæ­¢æ—¥æœŸçš„è¯·æ±‚ï¼Œç›´åˆ°æ‰¾åˆ°æœ‰æ•ˆçš„è¯·æ±‚æˆ–è€…é˜Ÿåˆ—ä¸ºç©ºã€‚

# ç»“è®º

æˆ‘ä»¬æœ‰äº†å®ƒï¼Œä¸€ä¸ªç®€å•çš„é€Ÿç‡é™åˆ¶æœåŠ¡ï¼Œå›´ç»• Scala `Future` s å·¥ä½œã€‚

[https://gist . github . com/John Murray/34 E3 beb 7 F5 eed 4935 f 70 DC 45 b 0256067](https://gist.github.com/JohnMurray/34e3beb7f5eed4935f70dc45b0256067)

å‡ºå‘å‰ï¼Œè¯·æ³¨æ„ä»¥ä¸‹å‡ ç‚¹:

*   è¿™é‡Œç»™å‡ºçš„ä»£ç æ˜¯ä¸ºäº†æ¼”ç¤ºçš„ç›®çš„ã€‚å¦‚æœä½ å–œæ¬¢ï¼Œå¯ä»¥éšæ„ä½¿ç”¨å®ƒï¼Œä½†æ˜¯è¦æ³¨æ„å®ƒæ²¡æœ‰ç»è¿‡å¾ˆå¥½çš„æµ‹è¯•ã€‚è¿˜æœ‰ä¸€äº›æˆ‘(ä¸ªäºº)ä¼šæ”¹å˜çš„åœ°æ–¹ï¼Œæ¯”å¦‚æ—¶é—´çª—å£ä¸Šä½¿ç”¨çš„ 1 ç§’ç²’åº¦ã€‚
*   ä¸Šé¢çš„è§£å†³æ–¹æ¡ˆåªå‡è®¾äº†ä¸€ä¸ªåº”ç”¨ç¨‹åº/æœºå™¨ã€‚æˆ‘è®¤ä¸ºè¿™æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œä½†æ˜¯å¦‚æœä½ æƒ³åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ä½¿ç”¨è¿™æ ·çš„ä»£ç ï¼Œä½ éœ€è¦è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ã€‚æ— è®ºæ˜¯é€šè¿‡é…é¢åˆ†åŒºè¿˜æ˜¯æŸç§æ•°æ®å…±äº«(å‡è®¾æ‚¨çš„çª—å£è¶³å¤Ÿå¤§ï¼Œå¯ä»¥è¿›è¡Œåè°ƒ)ã€‚
*   è¿™æ®µä»£ç ä¸­çš„é‡è¯•åªæ˜¯å›´ç»•é€Ÿç‡é™åˆ¶é”™è¯¯ã€‚å¦‚æœä½ æœ‰å…´è¶£äº†è§£æ›´å¤šå…³äº Scala futures çš„é€€ä¼‘ä¿¡æ¯ï¼Œè¯·å‚è§æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« [Scala Futures](https://hackernoon.com/exponential-back-off-with-scala-futures-7426340d0069)çš„æŒ‡æ•°åé€€ã€‚
*   è®¡ç®—å’Œå…¬å¼€/æŠ¥å‘Šç­‰å¾…æ—¶é—´ä¼°è®¡å€¼å¹¶å°†å…¶å…¬å¼€ç»™å®¢æˆ·å¯èƒ½æ˜¯ä¸€ä¸ªæœ‰è¶£çš„ç»ƒä¹ (å¦‚æœæ‚¨æ­£åœ¨å¯»æ‰¾ä¸€ä¸ªæœ‰è¶£çš„ç©å…·é¡¹ç›®æ¥ç©)ã€‚

# çº¦ç¿°Â·é»˜é‡Œçš„å…¶ä»–èŒä½

[](https://hackernoon.com/systems-programming-d5917e41353f) [## ç³»ç»Ÿç¼–ç¨‹

### ç”¨æ— æœ¯è¯­çš„æ¢ç´¢æ­å¼€ç¥ç§˜é¢çº±ã€‚

hackernoon.com](https://hackernoon.com/systems-programming-d5917e41353f) [](https://hackernoon.com/im-bored-of-language-x-514be05b59cd) [## æˆ‘åŒå€¦äº† X è¯­è¨€

### æˆ‘æƒ³èµ°å¾—å¿«

hackernoon.com](https://hackernoon.com/im-bored-of-language-x-514be05b59cd)