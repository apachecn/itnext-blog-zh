# â€œæ— æœåŠ¡å™¨æ’ä»¶â€:KEDA ç¼©å°ä½ çš„å®¹å™¨åˆ°é›¶

> åŸæ–‡ï¼š<https://itnext.io/serverless-keda-for-scaling-down-your-containers-to-zero-5bf35a75072c?source=collection_archive---------3----------------------->

## ä½¿ç”¨ autoscaler æœ€å¤§é™åº¦åœ°é™ä½æ‚¨çš„å®¹å™¨åŸºç¡€è®¾æ–½æˆæœ¬

æˆ‘ç®€è¦æè¿°äº†ä»€ä¹ˆæ˜¯æ— æœåŠ¡å™¨ï¼Œä»¥åŠå¦‚ä½•å°†å®¹å™¨ç¼©å‡åˆ°é›¶ã€‚è¿™åŒ…æ‹¬åº“ä¼¯å†…ç‰¹ï¼ŒKEDAï¼Œå¡å¤«å¡ï¼ŒDaprã€‚

# é—®é¢˜:æˆ‘å¦‚ä½•é™ä½æˆæœ¬ï¼Ÿ

![](img/fb59600fa442efa66e090ca3a87e08c0.png)

æ‰€æœ‰çš„åº”ç”¨ç¨‹åºéƒ½éœ€è¦æ¯æ¬¡è¿è¡Œã€‚æˆ‘ä»¬åº”è¯¥å…³æ‰å¼€å…³ã€‚

æˆ‘çš„ç—›ç‚¹å¾ˆç®€å•ã€‚è¿™æ˜¯å…³äºå¦‚ä½•é™ä½æˆ‘çš„åŸºç¡€è®¾æ–½æˆæœ¬ã€‚æˆ‘å°†åœ¨åŸºç¡€è®¾æ–½ä¸Šæ”¾ç½®è®¸å¤šåº”ç”¨ç¨‹åºã€‚ä½†æ˜¯æ²¡æœ‰å¿…è¦ä¸€ç›´è¿è¡Œåº”ç”¨ç¨‹åºã€‚æˆ‘å¸Œæœ›æˆ‘çš„åº”ç”¨ç¨‹åºä»…åœ¨éœ€è¦æ—¶è¿è¡Œã€‚å³ä½¿å¦‚æ­¤ï¼Œæˆ‘ä¹Ÿä¸èƒ½ä¸€ç›´å…³æ³¨è¿™äº›åº”ç”¨ç¨‹åºçš„æ¯ä¸€ä¸ªè¯·æ±‚â€¦å½“ä¸éœ€è¦çš„æ—¶å€™ï¼Œæˆ‘è¯¥å¦‚ä½•å…³é—­æˆ‘çš„åº”ç”¨ç¨‹åºå‘¢ï¼Ÿ

# è§£å†³æ–¹æ¡ˆ:â€œæ— æœåŠ¡å™¨â€ï¼Œæ›´å…·ä½“åœ°è¯´æ˜¯â€œè‡ªåŠ¨ç¼©æ”¾â€

## â€œæ— æœåŠ¡å™¨â€ä¸€ä½“å¼æœºå‹(ä½œä¸ºå­¦ä¹ çš„ç¬¬ä¸€æ­¥)

æˆ‘è®¤ä¸ºæ— æœåŠ¡å™¨æ˜¯è¿™ä¸ªé—®é¢˜çš„æœ€åæ‰‹æ®µã€‚æ— æœåŠ¡å™¨çš„å…ˆé©±ï¼ŒAWS è¯´ï¼›

> å®ƒæ¶ˆé™¤äº†åŸºç¡€æ¶æ„ç®¡ç†ä»»åŠ¡ï¼Œå¦‚æœåŠ¡å™¨æˆ–ç¾¤é›†é…ç½®ã€ä¿®è¡¥ã€æ“ä½œç³»ç»Ÿç»´æŠ¤å’Œå®¹é‡é…ç½®ã€‚

ç®€è€Œè¨€ä¹‹ï¼Œæ— æœåŠ¡å™¨æ„å‘³ç€**â€œæœåŠ¡å™¨ç»´æŠ¤â€â€”â€”å°‘äº†**ã€‚å…¶å®è¿˜æœ‰æœåŠ¡å™¨ã€‚æœåŠ¡å™¨æ°¸è¿œä¸ä¼šæ¶ˆå¤±ã€‚åº”ç”¨ç¨‹åºè¿è¡Œåœ¨æœåŠ¡å™¨ä¸Šã€‚æ¶ˆå¤±çš„æ˜¯ç»´æŠ¤åŠ³åŠ¨ã€‚åœ¨æ— æœåŠ¡å™¨ç¯å¢ƒä¸­ï¼Œåº”ç”¨ç¨‹åºå¼€å‘äººå‘˜ä¸éœ€è¦è€ƒè™‘æœåŠ¡å™¨ç»´æŠ¤ï¼Œå¯ä»¥ä¸“æ³¨äºå¼€å‘ã€‚

Serverless åªæ˜¯ä¸€ä¸ªå½¢å®¹è¯ï¼Œæ‰€ä»¥è¿™ä¸ªè¯æœ¬èº«å¹¶æ²¡æœ‰æåˆ°ä»»ä½•å…·ä½“çš„è½¯ä»¶ã€ç¡¬ä»¶æˆ–å‚å•†ã€‚

AWS lambda æ˜¯å…¬å…±äº‘ä¸­çš„æ— æœåŠ¡å™¨åº”ç”¨å¹³å°ä¹‹ä¸€ã€‚AWS lambda æ‹¥æœ‰[æ‰©å±•åº”ç”¨çš„åŸå§‹æœºåˆ¶](https://docs.aws.amazon.com/lambda/latest/dg/invocation-scaling.html)æ¥å¢åŠ å¹¶å‘æ€§ã€‚ä¸Šæ¬¡è°ƒç”¨å 10 åˆ†é’Ÿï¼ŒAWS lambda çš„èµ„æºå›æ”¶(åº”ç”¨ç¨‹åºåœæ­¢)æ ¹æ®[è¿™ç¯‡æ–‡ç« ](https://mikhail.io/serverless/coldstarts/aws/)è‡ªåŠ¨å‘ç”Ÿã€‚

å½“ç„¶ï¼Œè¿˜å­˜åœ¨å…¶ä»–å®ç°æ–¹å¼ã€‚æˆ‘ä»¬å¯ä»¥åœ¨æœ¬åœ°ä½¿ç”¨**æ— æœåŠ¡å™¨åº”ç”¨å¹³å°**ã€‚ä¾‹å¦‚ï¼Œ *OpenFaaS* ã€*open whish*å’Œ *kubeless* éƒ½æ˜¯åœ¨å†…éƒ¨ç¯å¢ƒä¸­è¿è¡Œåº”ç”¨çš„æ— æœåŠ¡å™¨åº”ç”¨å¹³å°ã€‚ä»–ä»¬åœ¨ä¸€ä¸ªå¹³å°ä¸­æä¾›ä¸€ä½“åŒ–å †æ ˆã€‚

## æ›´æ·±ä¸€æ­¥çš„â€œæ— æœåŠ¡å™¨â€:å…³é”®æ˜¯â€œè‡ªåŠ¨ç¼©æ”¾â€

æ·±å…¥â€œæ— æœåŠ¡å™¨â€å†…éƒ¨ã€‚å½“æˆ‘ä»¬å°è¯•â€œæ— æœåŠ¡å™¨â€çš„è‡ªåŠ©å †æ ˆæ—¶ï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨**å®¹å™¨å’Œ Kubernetes** ã€‚è¿™äº›æ˜¯è½¯ä»¶å †æ ˆçš„æ„å»ºæ¨¡å—ã€‚å®¹å™¨ç”¨äºåº”ç”¨ç¨‹åºçš„ç»´æŠ¤è‡ªåŠ¨åŒ–ã€‚Kubernetes ç”¨äºåè°ƒå¤šä¸ªå®¹å™¨å’Œå¤šä¸ªæœåŠ¡å™¨ã€‚

åœ¨å®¹å™¨æŠ€æœ¯å’Œ Kubernetes ä¹‹ä¸Šï¼Œ **autoscaler** æ¥äº†ã€‚Kubernetes æ¨å‡º HPA(å§å¼å®¹å™¨è‡ªåŠ¨ç§¤)ç­‰å®¹å™¨è‡ªåŠ¨ç§¤éå¸¸é‡è¦ã€‚å½“å·¥ä½œè´Ÿè½½å¢åŠ æ—¶ï¼ŒKubernetes ä¼šæ£€æµ‹åˆ°å¹¶è‡ªåŠ¨å¢åŠ å®¹å™¨æ•°é‡ã€‚è¿™æ˜¯è¿ˆå‘æ— æœåŠ¡å™¨ä¸–ç•Œçš„æƒŠäººä¸€æ­¥ã€‚

![](img/e754905f0ed0c81430601641d29b992b.png)

Autoscaler ç›‘è§†äº‹ä»¶å’ŒæŒ‡æ ‡ã€‚è‡ªåŠ¨ç¼©æ”¾æ§åˆ¶æ”¾å¤§æˆ–ç¼©å°ã€‚

åµŒå…¥åœ¨ Kubernetes ä¸­çš„ autoscaler çš„é™åˆ¶æ˜¯å®ƒä¸èƒ½å¤„ç†å‘ä¸‹åˆ°é›¶çš„ç¼©æ”¾ã€‚è¿™æ„å‘³ç€ï¼Œå³ä½¿å·¥ä½œè´Ÿè½½éå¸¸ä½å¹¶ä¸”æš‚æ—¶æ¥è¿‘é›¶è¯·æ±‚ï¼ŒKubernetes ä¹Ÿä¸èƒ½æ€æ­»æœ€åä¸€ä¸ªå®¹å™¨ã€‚æ¢å¥è¯è¯´ï¼Œåªè¦å®¹å™¨çš„æ•°é‡åœ¨ 1 åˆ° N çš„èŒƒå›´å†…ï¼ŒKubernetes æœ¬èº«å°±å¯ä»¥æ‰©å¤§å’Œç¼©å°å®¹å™¨éƒ¨ç½²ï¼Œä½†æ˜¯å®ƒä¸èƒ½å°†å®¹å™¨éƒ¨ç½²ç¼©å°åˆ°é›¶ã€‚è¿™æ˜¯ç¼ºå¤±çš„éƒ¨åˆ†ã€‚

![](img/39c3d256ef74fb7ed1b7b7ffee819944.png)

æ–°çš„å…¶ä»–è‡ªåŠ¨ç¼©æ”¾å™¨å¯ä»¥å¤„ç†è¿™ç§æƒ…å†µâ€œç¼©å°åˆ°é›¶â€ã€‚è¿™äº›è‡ªåŠ¨ç¼©æ”¾å™¨å……å½“ Kubernetes çš„åŠ©æ‰‹æ’ä»¶ã€‚å¦‚æœä¸€å®šæ—¶é—´è¿‡å»äº†ï¼Œæ²¡æœ‰è¯·æ±‚ï¼Œå®šæ ‡å™¨æ£€æµ‹åˆ°å®ƒï¼Œæ€æ­»æœ€åä¸€ä¸ªå®¹å™¨ã€‚

## è‡ªåŠ¨ç¼©æ”¾ 1 : Knative

Knative æ˜¯ Kuberntes ä¸–ç•Œä¸­ scaler çš„å‰æ²¿ã€‚å½“ Knative åœ¨é›¶å®¹å™¨çŠ¶æ€ä¸‹æ£€æµ‹åˆ°ä¼ å…¥è¯·æ±‚æ—¶ï¼ŒKnative è‡ªåŠ¨å°†è¯·æ±‚ä¿å­˜åœ¨ä¸€ç§è·¯ç”±å™¨ä¸­ï¼Œå¹¶å¯åŠ¨æ–°çš„å®¹å™¨ã€‚éå¸¸èªæ˜ã€‚Knative å…·æœ‰ç½‘ç»œè·¯ç”±å™¨åŠŸèƒ½ï¼Œå¯ä»¥ç›‘è§†è¯·æ±‚åŒ…å’Œç›®æ ‡åœ°å€ã€‚

## è‡ªåŠ¨ç¼©æ”¾å™¨ 2: KEDA

KEDA æ˜¯åŒä¸€æ¡ˆä»¶çš„å¦ä¸€ä¸ªå…‰æ˜çš„å¸Œæœ›ã€‚KEDA ä¹Ÿæ”¯æŒâ€œç¼©å‡è‡³é›¶â€ã€‚KEDA è§‚å¯Ÿåƒ Apache Kafka è¿™æ ·çš„è®¸å¤šæœåŠ¡ï¼Œå¹¶æ£€æµ‹è¿™äº›æœåŠ¡ä¸­çš„å˜åŒ–(ä¾‹å¦‚ï¼ŒKafka ä¸»é¢˜ä¸­æ˜¯å¦æœ‰æ–°çš„è¯·æ±‚åœ¨æ’é˜Ÿã€‚)

## å®šæ ‡å™¨çš„æ¯”è¾ƒ:Knative å’Œ KEDA

Knative å’Œ KEDA çš„åŒºåˆ«åœ¨äºå¦‚ä½•æ£€æµ‹ä¼ å…¥çš„è¯·æ±‚ã€‚Knative æ˜¯éå¸¸é¢å‘ç½‘ç»œçš„æ¶æ„ã€‚å¦ä¸€æ–¹é¢ï¼ŒKEDA ä¸å¤ªä¾èµ–ç½‘ç»œã€‚ç›¸åï¼ŒKEDA åªæ˜¯ä¾èµ–å…¶ä»–æœåŠ¡ï¼Œå¦‚é˜¿å¸•å¥‡å¡å¤«å¡ã€‚è¿™æ„å‘³ç€ KEDA çš„é‡é‡æ›´è½»ã€‚

# è®©æˆ‘ä»¬è¯•ç€æŠŠ KEDA ç¼©å°åˆ°é›¶å§ï¼

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘é‡‡ç”¨ Kubernetes ä¸ºåŸºç¡€ï¼ŒKEDA ä¸ºè‡ªåŠ¨ç¼©æ”¾ã€‚æˆ‘ç¡®è®¤ KEDA æ„è¯†åˆ°ç¼©å°åˆ°é›¶ã€‚

## KEDA æƒ…æ™¯

è¿™æ¬¡æˆ‘ä½¿ç”¨å‘å¸ƒ/è®¢é˜…é‡‡æ ·ç³»ç»Ÿä½œä¸ºè‡ªåŠ¨ç¼©æ”¾çš„ç›®æ ‡ã€‚è¯¥ç³»ç»Ÿæœ‰ä¸¤ä¸ªåº”ç”¨ç¨‹åºï¼Œä¸€ä¸ªæ˜¯å‘é€æ¶ˆæ¯çš„å‘å¸ƒè€…ï¼Œå¦ä¸€ä¸ªæ˜¯æ¥æ”¶æ¶ˆæ¯çš„è®¢é˜…è€…ã€‚è¯¥ç¤ºä¾‹è¿˜å°† Apache Kafka ä½œä¸ºå‘å¸ƒè€…å’Œè®¢é˜…è€…ä¹‹é—´çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚

åœ¨è¿™ä¸ªç³»ç»Ÿä¸­ï¼ŒKEDA æ§åˆ¶ç”¨æˆ·å®¹å™¨çš„æ•°é‡ã€‚

![](img/ea7901ea60c50306a9b8900206c9737e.png)

KEDA åœ¨é˜¿å¸•å¥‡å¡å¤«å¡çš„ä¸€ä¸ªç‰¹å®šä¸»é¢˜(=é¢‘é“)ä¸­è§‚çœ‹åˆ°æ¥çš„æ¶ˆæ¯ã€‚å½“ä¸€äº›æ¶ˆæ¯åˆ°è¾¾ä¸»é¢˜æ—¶ï¼ŒKEDA å”¤é†’ Kubernetes ä¸ŠæŒ‡å®šä¸ºâ€œdeploymentNameâ€çš„ç›®æ ‡éƒ¨ç½²ã€‚å½“åœ¨æŒ‡å®šä¸ºâ€œå†·å´æ—¶é—´â€çš„å†·å´æ—¶é—´å†…æ²¡æœ‰æ¶ˆæ¯æ—¶ï¼ŒKEDA å°†è®¢æˆ·åº”ç”¨ç¨‹åºä¸­çš„å®¹å™¨å·(å‰¯æœ¬)å‡å°‘åˆ°é›¶ã€‚æœ€åï¼ŒKubernetes æ€æ­»æ‰€æœ‰è¿è¡Œçš„å®¹å™¨ã€‚

## ç”¨å–„è‰¯åˆ›é€ åº“ä¼¯å†…ç‰¹

é¦–å…ˆï¼Œæˆ‘å‡†å¤‡äº† Kubernetes é›†ç¾¤ã€‚kind æ˜¯ Kubernetes é›†ç¾¤æ„å»ºå™¨ã€‚

```
kind create cluster --name serverless --config kind-config.yaml
```

åœ¨`kind-config.yaml`ä¸­ï¼Œæˆ‘æ·»åŠ äº†å”¯ä¸€çš„ç«¯å£é…ç½®ï¼Œç”¨äºç¨ååœ¨ Kubernetes å¤–éƒ¨å…¬å¼€ publisher åº”ç”¨ç¨‹åºã€‚

```
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  kubeadmConfigPatches:
  - |
    kind: InitConfiguration
    nodeRegistration:
      kubeletExtraArgs:
        node-labels: "ingress-ready=true"
  extraPortMappings:
  - containerPort: 80
    hostPort: 31502
    protocol: TCP
  - containerPort: 443
    hostPort: 31503
    protocol: TCP
```

## åœ¨ Kubernetes é›†ç¾¤ä¸Šå®‰è£… KEDA

è¿™æ˜¯å¼€çƒçš„æ—¶é—´ã€‚KEDA å®‰è£…è¶…çº§å®¹æ˜“ã€‚åˆ›å»ºä¸€ä¸ªåç§°ç©ºé—´`keda`ï¼Œåœ¨åç§°ç©ºé—´ä¸­å®‰è£… KEDA çš„å¤´ç›”åŒ…ã€‚

```
helm repo add kedacore https://kedacore.github.io/charts
kubectl create namespace keda  
helm install keda kedacore/keda --namespace keda
```

## å®‰è£…ç¤ºä¾‹åº”ç”¨ç¨‹åºå’Œ Dapr

æˆ‘ä½¿ç”¨äº†æ¥è‡ª Dapr å­˜å‚¨åº“(åº”ç”¨ç¨‹åºä¹‹é—´çš„æ¶ˆæ¯ä¼ é€’å·¥å…·)çš„ç¤ºä¾‹å‘å¸ƒ/è®¢é˜…åº”ç”¨ç¨‹åºã€‚è¿™ä¸ªä¾‹å­æœ‰éå¸¸æœ‰ç”¨çš„å®¹å™¨å›¾åƒã€‚æˆ‘ç”¨è¿™ä¸ªæ ·æœ¬è¿›è¡Œ KEDA ç¼©æ”¾æµ‹è¯•ã€‚

åœ¨ Kubernetes ä¸Šå®‰è£… dapr å°±åƒåœ¨ KEDA ä¸€æ ·ç®€å•ã€‚åªéœ€è¿è¡Œä¸€ä¸ªèˆµå‘½ä»¤ã€‚

```
helm repo add dapr [https://daprio.azurecr.io/helm/v1/repo](https://daprio.azurecr.io/helm/v1/repo)
kubectl create namespace dapr-system
helm install dapr dapr/dapr --namespace dapr-system
```

å®‰è£… Apache Kafka ä½œä¸ºå‘å¸ƒè€…å’Œè®¢é˜…è€…ä¹‹é—´çš„æ’é˜Ÿç³»ç»Ÿã€‚

```
helm install my-kafka incubator/kafka
```

æ¥ä¸‹æ¥ï¼Œæˆ‘å®‰è£…äº†è®¢é˜…è€…å’Œå‘å¸ƒè€…åº”ç”¨ç¨‹åºã€‚

è¿™æ˜¯ publisher åº”ç”¨ç¨‹åºéƒ¨ç½²`node-subscriber.yaml`

```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: node-subscriber
  labels:
    app: node-subscriber
spec:
  # replicas: 1
  selector:
    matchLabels:
      app: node-subscriber
  template:
    metadata:
      labels:
        app: node-subscriber
      annotations:
        dapr.io/enabled: "true"
        dapr.io/app-id: "node-subscriber"
        dapr.io/app-port: "3000"
    spec:
      containers:
      - name: node-subscriber
        image: dapriosamples/pubsub-node-subscriber:0.10.0
        ports:
        - containerPort: 3000
        imagePullPolicy: Always
```

è¿™æ˜¯å‘å¸ƒè€…åº”ç”¨éƒ¨ç½²`react-publisher.yaml`

```
kind: Service
apiVersion: v1
metadata:
  name: react-form
  labels:
    app: react-form
spec:
  selector:
    app: react-form
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8080
  type: ClusterIP---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: react-form
  labels:
    app: react-form
spec:
  replicas: 1
  selector:
    matchLabels:
      app: react-form
  template:
    metadata:
      labels:
        app: react-form
      annotations:
        dapr.io/enabled: "true"
        dapr.io/app-id: "react-form"
        dapr.io/app-port: "8080"
    spec:
      containers:
      - name: react-form
        image: dapriosamples/pubsub-react-form:0.10.0
        ports:
        - containerPort: 8080
        imagePullPolicy: Always
```

è¿™äº›åº”ç”¨ç¨‹åºä¸ä¸‹åˆ— Dapr å¯¹è±¡ç›¸å…³è”ã€‚Dapr å°†æ¥è‡ªå‘å¸ƒè€…çš„æ¶ˆæ¯æ•°æ®å­˜å‚¨åˆ° Apache Kafka éƒ¨ç½²`my-kafka`ä¸­ã€‚

```
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: pubsub
spec:
  type: pubsub.kafka
  metadata:
    - name: brokers
      value: "**my-kafka.default.svc.cluster.local:9092**"
    - name: authRequired
      value: "false"
```

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œå‘å¸ƒ/è®¢é˜…åº”ç”¨ç¨‹åºåº”è¯¥å¯ä»¥æ­£å¸¸è¿è¡Œã€‚

æœ€åï¼Œæˆ‘æ·»åŠ äº†ä»¥ä¸‹ KEDA å¯¹è±¡æ¥è‡ªåŠ¨ç¼©å°è§„æ¨¡ã€‚

```
apiVersion: keda.k8s.io/v1alpha1
kind: ScaledObject
metadata:
  name: kafka-scaler
  namespace: default
  labels:
    deploymentName: node-subscriber
spec:
  scaleTargetRef:
    deploymentName: **node-subscriber**
  minReplicaCount: 0
  cooldownPeriod:  **10**
  pollingInterval: **30**
  triggers:
  - type: kafka
    metadata:
      topic: **A**
      bootstrapServers:  **my-kafka.default.svc.cluster.local:9092**
      consumerGroup: node-subscriber
      lagThreshold: '1'
```

æ­¤`ScaledObject`ç›‘è§† ub/sub ä½¿ç”¨çš„`my-kafka`æœåŠ¡ä¸­çš„ä¸»é¢˜`A`å’Œä¸Šé¢æè¿°çš„`node-subscriber`çš„ kick scalingã€‚å†·å´æ—¶é—´æ˜¯`10s`ã€‚

æˆ‘ç¡®è®¤äº† publisher åº”ç”¨ç¨‹åºå®¹å™¨å’Œ Kafka å®¹å™¨æ­£åœ¨`default`åç§°ç©ºé—´ä¸­è¿è¡Œã€‚çœ‹èµ·æ¥æ²¡æœ‰è®¢æˆ·ç”³è¯·ã€‚æ²¡é”™ã€‚å½“ KEDA åˆå§‹åŒ–`ScaledObject`æ—¶ï¼Œ`deploymentName`ä¸­æŒ‡å®šçš„å±•å¼€æ€»æ˜¯è®¾ç½®ä¸ºé›¶ä½œä¸ºåˆå§‹çŠ¶æ€ã€‚

![](img/a2e69382e4d077c9879929c2fb4a3288.png)

è¯æ®å¯ä»¥åœ¨éƒ¨ç½²ä¸­æ‰¾åˆ°ã€‚éƒ¨ç½²`node-subscriber`å®é™…å­˜åœ¨ã€‚ä½†æ˜¯`replicas`è¢«è®¾ç½®ä¸ºé›¶ã€‚

![](img/6838c395886b1037cd13ede2e464631e.png)

## å‘è®¢é˜…è€…åº”ç”¨ç¨‹åºå‘é€äº‹ä»¶

è®©æˆ‘ä»¬åœ¨ publisher åº”ç”¨ç¨‹åºä¸­å‘é€æ¶ˆæ¯ã€‚

ä»æµè§ˆå™¨è®¿é—® publisher åº”ç”¨ç¨‹åºã€‚åœ¨ä¸‹é¢çš„æ–‡æœ¬æ¡†ä¸­æ”¾ä¸€æ¡éšæœºæ¶ˆæ¯å¹¶å‘é€æ¶ˆæ¯ã€‚å¦‚æœ KEDA æ­£å¸¸å·¥ä½œï¼Œæ‚¨å¯ä»¥ä»…é€šè¿‡è¿™ä¸€æ­¥å¯åŠ¨è®¢æˆ·ã€‚

![](img/01b1b67e05616e53ee61ef2ab181e0a0.png)

æŒ‰â€œæäº¤â€å‘è®¢æˆ·å‘é€æ¶ˆæ¯

## è§‚å¯Ÿè®¢æˆ·çš„ç¼©å°å’Œæ‰©å¤§

```
kubectl get pod -w
```

åœ¨å‘é€æ¶ˆæ¯åçš„ 30 ç§’å†…ï¼Œæˆ‘è§‚çœ‹äº†ä¸Šè¿°å‘½ä»¤çš„ç»“æœã€‚æˆ‘ç¡®è®¤`node-subscriber`åº”ç”¨ç¨‹åºè‡ªåŠ¨å¯åŠ¨ï¼Œå¹¶åœ¨ 30 ç§’åè‡ªåŠ¨ç»ˆæ­¢ğŸ»

![](img/77880595dc87d9c6db9d0d72b2d13e1e.png)

åœ¨å®¹å™¨æ—¥å¿—ä¸­ï¼Œ`node-subscriber`åº”ç”¨ç¨‹åºæˆåŠŸè·å–äº†ä»`react-publisher`å‘é€çš„æ¶ˆæ¯ã€‚ğŸ¥³

![](img/165e191edfdb49b25427f693acff7937.png)

åœ¨è¿™ä¸ªå¯è¡Œæ€§æ£€æŸ¥ä¸­ï¼Œæˆ‘é€šè¿‡è§‚å¯Ÿ Apache Kafka äº‹ä»¶æµç¡®è®¤äº† KEDA è‡ªåŠ¨å¯åŠ¨å¹¶ç»ˆæ­¢äº†å®¹å™¨ã€‚ğŸ‘

æˆ‘åœ¨è¿™é‡Œåˆ†äº«äº†è¿™ä¸ªå®Œæ•´çš„æ ·æœ¬[(github)](https://github.com/onelittlenightmusic/keda-dapr-scaling-sample)ã€‚

## æˆ‘å°è¯•è¿‡çš„å…¶ä»–æŒ‘æˆ˜(ä½†å¤±è´¥äº†)

æˆ‘å…ˆå°è¯•äº† Knative å’Œ Dapr æ ·æœ¬ï¼Œä½†æ˜¯è¯•éªŒæœ€ç»ˆå¤±è´¥äº†ã€‚ç®€å•åœ°è¯´ï¼ŒDapr å’Œ Knative å¹¶ä¸æ˜¯å¾ˆå¥½çš„ç»„åˆï¼Œå› ä¸ºå®ƒä»¬éƒ½æƒ³é€šè¿‡åˆ›å»ºè‡ªå·±çš„ sidecars å’ŒæœåŠ¡æ¥æ§åˆ¶ç½‘ç»œã€‚è¿™æ˜¯å› ä¸º Knative åœ¨é›¶å®¹å™¨çŠ¶æ€æœŸé—´ä½¿ç”¨ç±»ä¼¼ Istio çš„æœåŠ¡ç½‘æ ¼ä½œä¸ºæ¶ˆæ¯ä¼ è¾“ã€‚

# æ‘˜è¦:KEDA æ˜¯ç®€å•è€Œå¼ºå¤§çš„è‡ªåŠ¨ç¼©æ”¾å™¨

æˆ‘è°ˆåˆ°äº†æˆ‘çš„åº”ç”¨ç¨‹åºç»´æŠ¤é—®é¢˜ã€‚â€œæ— æœåŠ¡å™¨â€æ˜¯ä¸€ä¸ªå¾ˆæœ‰å‰é€”çš„æ¦‚å¿µï¼Œä½†å®ç°æ˜¯å¤šç§å¤šæ ·çš„ã€‚åœ¨ç°æœ‰çš„å®ç°ä¸­ï¼Œæˆ‘é€‰æ‹©äº†è‡ªå·±åŠ¨æ‰‹å †æ ˆå’Œ KEDA ä½œä¸ºè‡ªåŠ¨ç¼©æ”¾å™¨ã€‚é€šè¿‡ç¤ºä¾‹å‘å¸ƒ/è®¢é˜…åº”ç”¨ç¨‹åºï¼Œæˆ‘ç¡®è®¤äº† KEDA è§‚å¯Ÿåƒ Apache Kafka è¿™æ ·çš„æ’é˜Ÿç³»ç»Ÿï¼Œå¹¶ä» 1 åˆ° 0 æˆ–ä» 0 åˆ° 1 æ”¹å˜éƒ¨ç½²è§„æ¨¡ã€‚å‚æ•°æ˜¯å¯å®šåˆ¶çš„ï¼ŒKEDA æ”¯æŒé™¤é˜¿å¸•å¥‡å¡å¤«å¡ä¹‹å¤–çš„è®¸å¤š[ç¼©æ”¾å™¨](https://keda.sh/docs/1.5/scalers/)ã€‚è¿™ä¹ˆç®€å•åˆç™¾æ­ã€‚ä¸åƒ Knativeï¼ŒKEDA å¯èƒ½ä¸æ”¯æŒåœ¨çº¿ HTTP è¯·æ±‚â€¦ä½†æ˜¯å¦‚æœæˆ‘ä»¬çš„ç›®æ ‡æ˜¯å‘å¸ƒ/è®¢é˜…ç±»å‹çš„åº”ç”¨ï¼ŒKEDA æ˜¯æœ€æœ‰å‰é€”çš„è‡ªåŠ¨ç¼©æ”¾å™¨ã€‚äº«å—è‡ªåŠ¨ç¼©æ”¾ï¼åœ¨æ²¡æœ‰æœåŠ¡å™¨çš„ä¸–ç•Œé‡Œè‡ªç”±é£ç¿”ã€‚

![](img/bfad67502e92db3697f9f70ac06e143f.png)

ç…§ç‰‡ç”±[æ†é•¿](https://unsplash.com/@rodlong?utm_source=medium&utm_medium=referral)åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šæ‹æ‘„

æ„Ÿè°¢ [Zbynek Roubalik](https://app.slack.com/team/UNBV55YKU) @ redhat å¯¹ Kubernetes #keda slack é¢‘é“çš„å»ºè®®ã€‚