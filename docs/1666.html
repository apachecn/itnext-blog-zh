<html>
<head>
<title>MySQL Docker Container For Integration Testing Using Go</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ä½¿ç”¨Goè¿›è¡Œé›†æˆæµ‹è¯•çš„MySQL Dockerå®¹å™¨</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://itnext.io/mysql-docker-container-for-integration-testing-using-go-f784b70a03b?source=collection_archive---------1-----------------------#2018-12-27">https://itnext.io/mysql-docker-container-for-integration-testing-using-go-f784b70a03b?source=collection_archive---------1-----------------------#2018-12-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/04d6516c3cc5c2079183f7e1782742cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*J_YyC-lAiGTG53Ir"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">åœ¨<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>ä¸Šç”±<a class="ae kc" href="https://unsplash.com/@erwanhesry?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Erwan Hesry </a>æ‹æ‘„çš„ç…§ç‰‡</figcaption></figure><p id="7491" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">åœ¨ç”Ÿäº§ä¸­ï¼Œbugæ˜¯æœ€æ˜‚è´µçš„ã€‚åœ¨å¼€å‘è¿‡ç¨‹ä¸­ä½¿ç”¨æµ‹è¯•ç”¨ä¾‹æ¥æ•æ‰å®ƒä»¬æ˜¯æˆ‘ä»¬èƒ½åšçš„é™ä½æˆæœ¬çš„æœ€å¥½çš„äº‹æƒ…ä¹‹ä¸€ã€‚æµ‹è¯•åœ¨æ‰€æœ‰è½¯ä»¶ä¸­éƒ½éå¸¸é‡è¦ã€‚è¿™æœ‰åŠ©äºç¡®ä¿æˆ‘ä»¬ä»£ç çš„æ­£ç¡®æ€§ï¼Œå¹¶æœ‰åŠ©äºå‡å°‘å›å½’ã€‚å•å…ƒæµ‹è¯•æœ‰åŠ©äºåœ¨æ²¡æœ‰ä»»ä½•å¤–éƒ¨ä¾èµ–æ€§çš„æƒ…å†µä¸‹ç‹¬ç«‹æµ‹è¯•ç»„ä»¶ã€‚å•å…ƒæµ‹è¯•ä¸è¶³ä»¥ç¡®ä¿æˆ‘ä»¬æœ‰ä¸€ä¸ªç¨³å®šçš„ã€ç»è¿‡è‰¯å¥½æµ‹è¯•çš„ç³»ç»Ÿã€‚äº‹å®ä¸Šï¼Œå¤±è´¥å‘ç”Ÿåœ¨ä¸åŒç»„ä»¶çš„é›†æˆè¿‡ç¨‹ä¸­ã€‚å½“æˆ‘ä»¬ä»æœªåœ¨çœŸå®æ•°æ®åº“ä¸Šè¿è¡Œæµ‹è¯•æ—¶ï¼Œå…·æœ‰æ•°æ®åº“åç«¯çš„åº”ç”¨ç¨‹åºä¼šé¢ä¸´è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯èƒ½æ°¸è¿œä¸ä¼šæ³¨æ„åˆ°ç”±äºäº‹åŠ¡æœªæäº¤ã€æ•°æ®åº“ç‰ˆæœ¬é”™è¯¯ç­‰é—®é¢˜è€Œå¯¼è‡´çš„äº‹æƒ…æ— æ³•å·¥ä½œã€‚é›†æˆæµ‹è¯•åœ¨ç«¯åˆ°ç«¯æµ‹è¯•ä¸­æ‰®æ¼”ç€é‡è¦çš„è§’è‰²ã€‚</p><p id="52f8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">åœ¨å½“ä»Šä¸–ç•Œï¼Œæˆ‘ä»¬ç”¨æ•°æ®åº“ä½œä¸ºå­˜å‚¨åç«¯ç¼–å†™äº†è®¸å¤šè½¯ä»¶åº”ç”¨ç¨‹åºã€‚æ¨¡ä»¿è¿™äº›æ•°æ®åº“è°ƒç”¨è¿›è¡Œå•å…ƒæµ‹è¯•å¯èƒ½å¾ˆéº»çƒ¦ã€‚åœ¨æ¨¡å¼ä¸­åšä¸€äº›å°çš„æ”¹å˜ä¼šå¯¼è‡´é‡å†™ä¸€äº›æˆ–è€…æ‰€æœ‰çš„æ¨¡æ‹Ÿã€‚ç”±äºæŸ¥è¯¢ä¸è¿›å…¥å®é™…çš„æ•°æ®åº“å¼•æ“ï¼Œæ‰€ä»¥æ²¡æœ‰æŸ¥è¯¢è¯­æ³•æˆ–çº¦æŸçš„éªŒè¯ã€‚éœ€è¦æ¨¡æ‹Ÿæ¯ä¸ªæŸ¥è¯¢ä¼šå¯¼è‡´é‡å¤å·¥ä½œã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ä¸€ä¸ªçœŸå®çš„æ•°æ®åº“è¿›è¡Œæµ‹è¯•ï¼Œè¿™ä¸ªæ•°æ®åº“åœ¨æµ‹è¯•å®Œæˆåä¼šè¢«é”€æ¯ã€‚<a class="ae kc" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> Docker </strong> </a>éå¸¸é€‚åˆè¿è¡Œæµ‹è¯•ç”¨ä¾‹ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥åœ¨å‡ ç§’é’Ÿå†…æ—‹è½¬å®¹å™¨ï¼Œå¹¶åœ¨å®Œæˆåæ€æ­»å®ƒä»¬ã€‚</p><p id="c11a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">è®©æˆ‘ä»¬äº†è§£å¦‚ä½•å¯åŠ¨MySQL dockerå®¹å™¨ï¼Œå¹¶ä½¿ç”¨goä»£ç å¯¹å…¶è¿›è¡Œæµ‹è¯•ã€‚æˆ‘ä»¬é¦–å…ˆéœ€è¦ç¡®ä¿è¿è¡Œæˆ‘ä»¬çš„æµ‹è¯•ç”¨ä¾‹çš„ç³»ç»Ÿå®‰è£…äº†dockerï¼Œè¿™å¯ä»¥é€šè¿‡è¿è¡Œå‘½ä»¤"<strong class="kf ir"> docker ps </strong>"æ¥æ£€æŸ¥ã€‚å¦‚æœæ²¡æœ‰å®‰è£…dockerï¼Œä»è¿™é‡Œçš„<a class="ae kc" href="https://docs.docker.com/install/" rel="noopener ugc nofollow" target="_blank">å®‰è£…docker</a>ã€‚</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="b36f" class="lk ll iq lg b gy lm ln l lo lp">func (d *Docker) isInstalled() bool {<br/>  command := exec.Command("docker", "ps")<br/>  err := command.Run()<br/>  if err != nil {<br/>    return false<br/>  }<br/>  return true<br/>}</span></pre><p id="87b3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ä¸€æ—¦dockerå®‰è£…å®Œæ¯•ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ä¸€ä¸ªç”¨æˆ·åå’Œå¯†ç æ¥è¿è¡ŒMySQLå®¹å™¨ï¼Œè¿™ä¸ªç”¨æˆ·åå’Œå¯†ç å¯ä»¥ç”¨æ¥è¿æ¥MySQLæœåŠ¡å™¨ã€‚</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="774e" class="lk ll iq lg b gy lm ln l lo lp">docker run --name our-mysql-container -e MYSQL_ROOT_PASSWORD=root -e MYSQL_USER=gouser -e MYSQL_PASSWORD=gopassword -e MYSQL_DATABASE=godb -p 3306:3306 --tmpfs /var/lib/mysql mysql:5.7</span></pre><p id="c46b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">è¿™è¿è¡Œäº†ä¸€ä¸ªMySQL 5.7ç‰ˆæœ¬çš„dockeræ˜ åƒï¼Œå®¹å™¨åä¸ºâ€œour-mysql-containerâ€ã€‚â€œ-eâ€æŒ‡å®šäº†æˆ‘ä»¬éœ€è¦ä¸ºMySQL dockerå®¹å™¨è®¾ç½®çš„è¿è¡Œæ—¶å˜é‡ã€‚æˆ‘ä»¬å°†rootè®¾ç½®ä¸ºæˆ‘ä»¬çš„rootå¯†ç ã€‚åˆ›å»ºä¸€ä¸ªå¯†ç ä¸ºâ€œgopasswordâ€çš„ç”¨æˆ·â€œgouser â€,æˆ‘ä»¬ç”¨å®ƒä»æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºè¿æ¥åˆ°MySQLæœåŠ¡å™¨ã€‚æˆ‘ä»¬å…¬å¼€äº†dockerå®¹å™¨çš„3306ç«¯å£ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è¿æ¥åˆ°Dockerå®¹å™¨å†…éƒ¨è¿è¡Œçš„mysqlæœåŠ¡å™¨ã€‚æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯<a class="ae kc" href="https://docs.docker.com/v17.09/engine/admin/volumes/tmpfs/" rel="noopener ugc nofollow" target="_blank"> tmpfsæŒ‚è½½</a>ï¼Œå®ƒåªåœ¨ä¸»æœºçš„å†…å­˜ä¸­å­˜å‚¨æ•°æ®ã€‚å½“å®¹å™¨åœæ­¢æ—¶ï¼Œtmpfsè£…è½½å°†è¢«åˆ é™¤ã€‚å› ä¸ºæˆ‘ä»¬æ­£åœ¨è¿è¡Œå®ƒçš„æµ‹è¯•ç›®çš„ï¼Œæ‰€ä»¥æ²¡æœ‰å¿…è¦åœ¨æ°¸ä¹…å­˜å‚¨æ•°æ®ã€‚</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="b399" class="lk ll iq lg b gy lm ln l lo lp">type ContainerOption struct {<br/>  Name              string<br/>  ContainerFileName string<br/>  Options           map[string]string<br/>  MountVolumePath   string<br/>  PortExpose        string<br/>}</span><span id="8e1d" class="lk ll iq lg b gy lq ln l lo lp">func (d *Docker) getDockerRunOptions(c ContainerOption) []string {<br/>  portExpose := fmt.Sprintf("%s:%s", c.PortExpose, c.PortExpose)<br/>  var args []string<br/>  for key, value := range c.Options {<br/>    args = append(args, []string{"-e", fmt.Sprintf("%s=%s", key, value)}...)<br/>  }<br/>  args = append(args, []string{"--tmpfs", c.MountVolumePath, c.ContainerFileName}...)<br/>  dockerArgs := append([]string{"run", "-d", "--name", c.Name, "-p", portExpose}, args...)<br/>  return dockerArgs<br/>}</span><span id="4ed5" class="lk ll iq lg b gy lq ln l lo lp">func (d *Docker) Start(c ContainerOption) (string, error) {<br/>  dockerArgs := d.getDockerRunOptions(c)<br/>  command := exec.Command("docker", dockerArgs...)<br/>  command.Stderr = os.Stderr<br/>  result, err := command.Output()<br/>  if err != nil {<br/>    return "", err<br/>  }<br/>  d.ContainerID = strings.TrimSpace(string(result))<br/>  d.ContainerName = c.Name<br/>  command = exec.Command("docker", "inspect", d.ContainerID)<br/>  result, err = command.Output()<br/>  if err != nil {<br/>    d.Stop()<br/>    return "", err<br/>  }<br/>  return string(result), nil<br/>}</span><span id="d33e" class="lk ll iq lg b gy lq ln l lo lp">func (m *MysqlDocker) StartMysqlDocker() {<br/>  mysqlOptions := map[string]string{<br/>    "MYSQL_ROOT_PASSWORD": "root",<br/>    "MYSQL_USER":          "gouser",<br/>    "MYSQL_PASSWORD":      "gopassword",<br/>    "MYSQL_DATABASE":      "godb",<br/>  }<br/>  containerOption := ContainerOption{<br/>    Name:              "our-mysql-container",<br/>    Options:           mysqlOptions,<br/>    MountVolumePath:   "/var/lib/mysql",<br/>    PortExpose:        "3306",<br/>    ContainerFileName: "mysql:5.7",<br/>  }<br/>  m.Docker = Docker{}<br/>  m.Docker.Start(containerOption)<br/>}</span></pre><p id="5fb5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æˆ‘ä»¬å¯ä»¥ä½¿ç”¨containerIdæ¥æ£€æŸ¥å®¹å™¨çš„ç»†èŠ‚ã€‚</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="6cb4" class="lk ll iq lg b gy lm ln l lo lp">docker inspect containerId</span></pre><p id="36f9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ä¸€æ—¦æˆ‘ä»¬è¿è¡Œäº†dockerå®¹å™¨ï¼Œæˆ‘ä»¬éœ€è¦ç­‰åˆ°æˆ‘ä»¬çš„Dockerå®¹å™¨å¯åŠ¨å¹¶è¿è¡Œã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ£€æŸ¥è¿™ä¸€ç‚¹ã€‚</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="40ab" class="lk ll iq lg b gy lm ln l lo lp">docker ps -a</span></pre><p id="bd16" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ä¸€æ—¦dockerå¯åŠ¨å¹¶è¿è¡Œï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨å®ƒæ¥è¿è¡Œä¸çœŸå®æ•°æ®åº“çš„é›†æˆæµ‹è¯•ç”¨ä¾‹ã€‚</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="0f53" class="lk ll iq lg b gy lm ln l lo lp">func (d *Docker) WaitForStartOrKill(timeout int) error {<br/>  for tick := 0; tick &lt; timeout; tick++ {<br/>    containerStatus := d.getContainerStatus()<br/>    if containerStatus == dockerStatusRunning {<br/>     return nil<br/>    }<br/>    if containerStatus == dockerStatusExited {<br/>     return nil<br/>    }<br/>    time.Sleep(time.Second)<br/>  }<br/>  d.Stop()<br/>  return errors.New("Docker faile to start in given time period so stopped")<br/>}</span><span id="f8e8" class="lk ll iq lg b gy lq ln l lo lp">func (d *Docker) getContainerStatus() string {<br/>  command := exec.Command("docker", "ps", "-a", "--format", "{{.ID}}|{{.Status}}|{{.Ports}}|{{.Names}}")<br/>  output, err := command.CombinedOutput()<br/>  if err != nil {<br/>    d.Stop()<br/>    return dockerStatusExited<br/>  }<br/>  outputString := string(output)<br/>  outputString = strings.TrimSpace(outputString)<br/>  dockerPsResponse := strings.Split(outputString, "\n")<br/>  for _, response := range dockerPsResponse {<br/>    containerStatusData := strings.Split(response, "|")<br/>    containerStatus := containerStatusData[1]<br/>    containerName := containerStatusData[3]<br/>    if containerName == d.ContainerName {<br/>      if strings.HasPrefix(containerStatus, "Up ") {<br/>        return dockerStatusRunning<br/>      }<br/>    }<br/>  }<br/>  return dockerStatusStarting<br/>}</span></pre><p id="e4dd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„è¿æ¥å­—ç¬¦ä¸²ä»goä»£ç è¿æ¥åˆ°dockerä¸­è¿è¡Œçš„MySQLæœåŠ¡å™¨ã€‚</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="9a73" class="lk ll iq lg b gy lm ln l lo lp">gouser:gopassword@tcp(localhost:3306)/godb?charset=utf8&amp;parseTime=True&amp;loc=Local</span></pre><p id="d5fc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">æ‰€æœ‰è¿™äº›éƒ½æœ‰åŠ©äºä½¿ç”¨çœŸå®çš„æ•°æ®åº“è¿è¡Œé›†æˆæµ‹è¯•ï¼Œè¯¥æ•°æ®åº“å¯ä»¥åœ¨æ¯æ¬¡è¿è¡Œæ—¶é‡æ–°åˆ›å»ºã€‚è¿™æœ‰åŠ©äºç¡®ä¿æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸ºäº§å“å‘å¸ƒåšå¥½å‡†å¤‡ã€‚</p><p id="e356" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">å®Œæ•´çš„ä»£ç å¯ä»¥åœ¨è¿™ä¸ªgitèµ„æºåº“ä¸­æ‰¾åˆ°:ã€https://github.com/MiteshSharma/DockerMysqlGo<a class="ae kc" href="https://github.com/MiteshSharma/DockerMysqlGo" rel="noopener ugc nofollow" target="_blank"/></p><p id="5e26" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> <em class="lr"> PS:å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·é¼“æŒæ”¯æŒ</em> </strong>ğŸ‘<strong class="kf ir"> <em class="lr">ã€‚æ¬¢å‘¼</em> </strong></p></div></div>    
</body>
</html>