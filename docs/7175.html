<html>
<head>
<title>Build a library with esbuild (vol. 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ç”¨esbuildæ„å»ºä¸€ä¸ªåº“(ç¬¬2å·)</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://itnext.io/build-a-library-with-esbuild-vol-2-c0e3caa25150?source=collection_archive---------1-----------------------#2022-07-05">https://itnext.io/build-a-library-with-esbuild-vol-2-c0e3caa25150?source=collection_archive---------1-----------------------#2022-07-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/fd91f93a28de3749a973f88adf760c13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OCuN_lShUlE2vb_V"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">çº¦ç‘Ÿå¤«Â·æ ¼é›·å¤«åœ¨<a class="ae kf" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>ä¸Šçš„ç…§ç‰‡</figcaption></figure><p id="dd8d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">ä¸€å¹´å‰æˆ‘åˆ†äº«äº†ä¸€ä¸ª<a class="ae kf" href="https://medium.com/geekculture/build-a-library-with-esbuild-23235712f3c" rel="noopener">å¸–å­</a>ï¼Œè§£é‡Šäº†å¦‚ä½•ç”¨<a class="ae kf" href="https://esbuild.github.io/" rel="noopener ugc nofollow" target="_blank"> esbuild </a>æ„å»ºä¸€ä¸ªåº“ã€‚è™½ç„¶å®ƒä»ç„¶æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆï¼Œä½†è‡ªä»å®ƒå‘å¸ƒä»¥æ¥ï¼Œæˆ‘å¯¹æˆ‘çš„å·¥å…·è¿›è¡Œäº†ä¸€äº›æ”¹è¿›ã€‚</p><p id="cf8b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">ä¸‹é¢æ˜¯æˆ‘å¸Œæœ›å¯¹ä½ çš„é¡¹ç›®æœ‰ç”¨çš„å‡ ä¸ªé™„ä»¶ã€‚</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h2 id="3c6b" class="ll lm it bd ln lo lp dn lq lr ls dp lt kr lu lv lw kv lx ly lz kz ma mb mc md bi translated">æºå’Œè¾“å‡º</h2><p id="5c8a" class="pw-post-body-paragraph kg kh it ki b kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz mi lb lc ld im bi translated">ä¸ºåº“å®šä¹‰ä¸€ä¸ªä»¥ä¸Šçš„å…¥å£ç‚¹æœ‰æ—¶ä¼šå¾ˆæœ‰ç”¨â€”â€”ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸åªæ˜¯ä½¿ç”¨ä¸€ä¸ªå”¯ä¸€çš„<code class="fe mj mk ml mm b">index.ts</code>æ–‡ä»¶ä½œä¸ºå…¥å£ï¼Œè€Œæ˜¯ä½¿ç”¨å¤šä¸ªæºæ¥æä¾›é€»è¾‘ä¸Šç‹¬ç«‹çš„ä»£ç ç»„ã€‚esbuildé€šè¿‡å‚æ•°<a class="ae kf" href="https://esbuild.github.io/api/#entry-points" rel="noopener ugc nofollow" target="_blank">å…¥å£ç‚¹</a>æ”¯æŒè¯¥é€‰é¡¹ã€‚</p><p id="79f2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">ä¾‹å¦‚ï¼Œåœ¨æˆ‘çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ç»å¸¸åˆ—å‡ºæˆ‘çš„<code class="fe mj mk ml mm b">src</code>æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰TypeScriptæ–‡ä»¶ï¼Œå¹¶å°†å®ƒä»¬ä½œä¸ºå•ç‹¬çš„æ¡ç›®ã€‚</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="40d9" class="ll lm it mm b gy mv mw l mx my">import {<br/>  readdirSync,<br/>  statSync<br/>} from "fs";<br/>import { join } from "path";<br/><br/>// Select all typescript files of src directory as entry points<br/>const entryPoints = readdirSync(join(process.cwd(), "src"))<br/>  .filter(<br/>    (file) =&gt;<br/>      file.endsWith(".ts") &amp;&amp;<br/>      statSync(join(process.cwd(), "src", file)).isFile()<br/>  )<br/>  .map((file) =&gt; `src/${file}`);</span></pre><p id="502b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">ç”±äºæ¯ä¸ªæ„å»ºä¹‹å‰çš„è¾“å‡ºæ–‡ä»¶å¤¹å¯èƒ½å·²ç»è¢«åˆ é™¤äº†ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿå¸Œæœ›åœ¨ç»§ç»­ä¹‹å‰é€šè¿‡åˆ›å»ºå®ƒæ¥ç¡®ä¿å®ƒå­˜åœ¨ã€‚</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="2c71" class="ll lm it mm b gy mv mw l mx my">import {<br/>  existsSync,<br/>  mkdirSync<br/>} from "fs";<br/>import { join } from "path";<br/><br/>// Create dist before build if not exist<br/>const dist = join(process.cwd(), "dist");<br/><br/>if (!existsSync(dist)) {<br/>  mkdirSync(dist);<br/>}<br/><br/>// Select entryPoints and build</span></pre></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h2 id="835b" class="ll lm it bd ln lo lp dn lq lr ls dp lt kr lu lv lw kv lx ly lz kz ma mb mc md bi translated">æœªå®šä¹‰å…¨å±€</h2><p id="6d99" class="pw-post-body-paragraph kg kh it ki b kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz mi lb lc ld im bi translated">æ„å»ºESMç›®æ ‡æ—¶ï¼Œæ‚¨çš„åº“å¯èƒ½ä¼šä½¿ç”¨æŸäº›ä¾èµ–é¡¹ï¼Œä»è€Œå¯¼è‡´æ„å»ºé”™è¯¯<em class="mz">â€œæœªæ•è·çš„å¼•ç”¨é”™è¯¯:æœªå®šä¹‰å…¨å±€â€</em>ã€‚æ ¹æœ¬åŸå› æ˜¯ä¾èµ–å…³ç³»æœŸæœ›ä¸€ä¸ª<code class="fe mj mk ml mm b">global</code>å¯¹è±¡(å¦‚åœ¨NodeJSä¸­),è€Œæµè§ˆå™¨éœ€è¦<code class="fe mj mk ml mm b">window</code>ã€‚</p><p id="0b13" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œesbuildæœ‰ä¸€ä¸ª<a class="ae kf" href="https://esbuild.github.io/api/#define" rel="noopener ugc nofollow" target="_blank"> define </a>é€‰é¡¹ï¼Œå¯ä»¥ç”¨æ¥ç”¨å¸¸é‡è¡¨è¾¾å¼æ›¿æ¢å…¨å±€æ ‡è¯†ç¬¦ã€‚</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="6d43" class="ll lm it mm b gy mv mw l mx my">import esbuild from "esbuild";<br/><br/>esbuild<br/>  .build({<br/>    entryPoints,<br/>    outdir: "dist/esm",<br/>    bundle: true,<br/>    sourcemap: true,<br/>    minify: true,<br/>    splitting: true,<br/>    format: "esm",<br/>    define: { global: "window" },<br/>    target: ["esnext"],<br/>  })<br/>  .catch(() =&gt; process.exit(1));</span></pre></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h2 id="d430" class="ll lm it bd ln lo lp dn lq lr ls dp lt kr lu lv lw kv lx ly lz kz ma mb mc md bi translated">esmå’Œcjs</h2><p id="e06b" class="pw-post-body-paragraph kg kh it ki b kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz mi lb lc ld im bi translated">ä¸ºäº†å‘å¸ƒä¸€ä¸ªæ—¢æ”¯æŒCommonJS (cjs)åˆæ”¯æŒECMAScriptæ¨¡å—(esm)çš„åº“ï¼Œæˆ‘å°†åŒ…è¾“å‡ºåˆ°å‘è¡Œç›®å½•çš„ä¸¤ä¸ªå­æ–‡ä»¶å¤¹ä¸­â€”â€”ä¾‹å¦‚<code class="fe mj mk ml mm b">dist/cjs</code>å’Œ<code class="fe mj mk ml mm b">dist/esm</code>ã€‚ä½¿ç”¨esbuildï¼Œè¿™å¯ä»¥é€šè¿‡æŒ‡å®šé€‰é¡¹<a class="ae kf" href="https://esbuild.github.io/api/#outdir" rel="noopener ugc nofollow" target="_blank"> outdir </a>æˆ–<a class="ae kf" href="https://esbuild.github.io/api/#outfile" rel="noopener ugc nofollow" target="_blank"> outfile </a>åˆ°è¿™äº›ç›¸å¯¹è·¯å¾„æ¥å®ç°ã€‚</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="76c2" class="ll lm it mm b gy mv mw l mx my">import esbuild from "esbuild";<br/>import {<br/>  existsSync,<br/>  mkdirSync,<br/>  readdirSync,<br/>  statSync,<br/>  writeFileSync,<br/>} from "fs";<br/>import { join } from "path";<br/><br/>const dist = join(process.cwd(), "dist");<br/><br/>if (!existsSync(dist)) {<br/>  mkdirSync(dist);<br/>}<br/><br/>const entryPoints = readdirSync(join(process.cwd(), "src"))<br/>  .filter(<br/>    (file) =&gt;<br/>      !file.endsWith(".ts") &amp;&amp;<br/>      statSync(join(process.cwd(), "src", file)).isFile()<br/>  )<br/>  .map((file) =&gt; `src/${file}`);<br/><br/>// esm output bundles with code splitting<br/>esbuild<br/>  .build({<br/>    entryPoints,<br/>    outdir: "dist/esm",<br/>    bundle: true,<br/>    sourcemap: true,<br/>    minify: true,<br/>    splitting: true,<br/>    format: "esm",<br/>    define: { global: "window" },<br/>    target: ["esnext"],<br/>  })<br/>  .catch(() =&gt; process.exit(1));<br/><br/>// cjs output bundle<br/>esbuild<br/>  .build({<br/>    entryPoints: ["src/index.ts"],<br/>    outfile: "dist/cjs/index.cjs.js",<br/>    bundle: true,<br/>    sourcemap: true,<br/>    minify: true,<br/>    platform: "node",<br/>    target: ["node16"],<br/>  })<br/>  .catch(() =&gt; process.exit(1));<br/><br/>// an entry file for cjs at the root of the bundle<br/>writeFileSync(join(dist, "index.js"), "export * from './esm/index.js';");<br/><br/>// an entry file for esm at the root of the bundle<br/>writeFileSync(<br/>  join(dist, "index.cjs.js"),<br/>  "module.exports = require('./cjs/index.cjs.js');"<br/>);</span></pre><p id="f085" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">ç”±äºåˆ†å‘ä¸¤ä¸ªä¸åŒçš„æ–‡ä»¶å¤¹ä¼šå¯¼è‡´åº“çš„<code class="fe mj mk ml mm b">dist</code>è·¯å¾„ä¸­ä¸å†æœ‰æ¡ç›®æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘è¿˜å–œæ¬¢æ·»åŠ ä¸¤ä¸ªæ–‡ä»¶æ¥é‡æ–°å¯¼å‡ºä»£ç ã€‚åœ¨é¡¹ç›®ä¸­å¯¼å…¥åº“æ—¶ï¼Œè¿™å¾ˆæœ‰ç”¨ã€‚</p><p id="2000" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">æ­¤å¤–ï¼Œ<code class="fe mj mk ml mm b">package.json</code>æ¡ç›®ä¹Ÿåº”è¯¥ç›¸åº”åœ°æ›´æ–°ã€‚</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="9fd4" class="ll lm it mm b gy mv mw l mx my">{<br/>  "name": "mylibary",<br/>  "version": "0.0.1",<br/>  "main": "dist/cjs/index.cjs.js",<br/>  "module": "dist/esm/index.js",<br/>  "types": "dist/types/index.d.ts",<br/>}</span></pre></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h2 id="cc94" class="ll lm it bd ln lo lp dn lq lr ls dp lt kr lu lv lw kv lx ly lz kz ma mb mc md bi translated">CSSå’ŒSASS</h2><p id="a54c" class="pw-post-body-paragraph kg kh it ki b kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz mi lb lc ld im bi translated">ä½ çŸ¥é“esbuildä¹Ÿå¯ä»¥æ†ç»‘<a class="ae kf" href="https://esbuild.github.io/content-types/#css" rel="noopener ugc nofollow" target="_blank"> CSS </a>æ–‡ä»¶å—ï¼Ÿç”šè‡³æœ‰ä¸€ä¸ª<a class="ae kf" href="https://github.com/glromeo/esbuild-sass-plugin" rel="noopener ugc nofollow" target="_blank"> SASSæ’ä»¶</a>ä½¿å®ƒæ˜“äºæ„å»ºã€‚scssæ–‡ä»¶ğŸ˜ƒã€‚</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="02ab" class="ll lm it mm b gy mv mw l mx my">npm i -D esbuild-sass-plugin postcss autoprefixer postcss-preset-env</span></pre><p id="4eae" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘æ†ç»‘äº†ä¸¤ä¸ªä¸åŒçš„SASSæ–‡ä»¶â€” <code class="fe mj mk ml mm b">src/index.scss</code>å’Œ<code class="fe mj mk ml mm b">src/doc/index.scss</code>ã€‚æˆ‘ä½¿ç”¨æ’ä»¶æ¥è½¬æ¢ä»£ç â€”â€”å³ç»™CSSæ·»åŠ å‰ç¼€â€”â€”æˆ‘è¿˜ä½¿ç”¨é€‰é¡¹<a class="ae kf" href="https://esbuild.github.io/api/#metafile" rel="noopener ugc nofollow" target="_blank">å›¾å…ƒæ–‡ä»¶</a>,å®ƒå‘Šè¯‰esbuildä»¥JSONæ ¼å¼ç”Ÿæˆä¸€äº›å…³äºæ„å»ºçš„å…ƒæ•°æ®ã€‚</p><p id="64e0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">ä½¿ç”¨å®ƒï¼Œæˆ‘å¯ä»¥æ£€ç´¢ç”Ÿæˆçš„CSSæ–‡ä»¶çš„è·¯å¾„å’Œåç§°ï¼Œä¾‹å¦‚ï¼Œç¨åå°†å®ƒä»¬åŒ…å«åœ¨æˆ‘çš„HTMLæ–‡ä»¶ä¸­ã€‚</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="39b0" class="ll lm it mm b gy mv mw l mx my">import esbuild  from 'esbuild';<br/><br/>import {sassPlugin}  from 'esbuild-sass-plugin';<br/>import postcss  from 'postcss';<br/>import autoprefixer  from 'autoprefixer';<br/>import postcssPresetEnv  from 'postcss-preset-env';<br/><br/>const buildCSS = async () =&gt; {<br/>  const {metafile} = await esbuild.build({<br/>    entryPoints: ['src/index.scss', 'src/doc/index.scss'],<br/>    bundle: true,<br/>    minify: true,<br/>    format: 'esm',<br/>    target: ['esnext'],<br/>    outdir: 'dist/build',<br/>    metafile: true,<br/>    plugins: [<br/>      sassPlugin({<br/>        async transform(source, resolveDir) {<br/>          const {css} = <br/>            await postcss([autoprefixer, <br/>                           postcssPresetEnv()<br/>                          ]).process(source, {<br/>              from: undefined<br/>          });<br/>          return css;<br/>        }<br/>      })<br/>    ]<br/>  });<br/><br/>  const {outputs} = metafile;<br/>  return Object.keys(outputs);<br/>};</span></pre></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h2 id="6a08" class="ll lm it bd ln lo lp dn lq lr ls dp lt kr lu lv lw kv lx ly lz kz ma mb mc md bi translated">ç»“è®º</h2><p id="89ca" class="pw-post-body-paragraph kg kh it ki b kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz mi lb lc ld im bi translated"><a class="ae kf" href="https://esbuild.github.io/" rel="noopener ugc nofollow" target="_blank"> esbuild </a>è¿˜æ˜¯æ»‘å¤´ï¼</p><p id="bcbf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">åˆ°æ— é™è¿œå¤„<br/>å¤§å«</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="dd55" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">æ›´å¤šå†’é™©ï¼Œè¯·åœ¨æ¨ç‰¹ä¸Šå…³æ³¨æˆ‘</p></div></div>    
</body>
</html>