# Kubernetes ç®€åŒ–äº†å¤šé›†ç¾¤ç½‘ç»œ

> åŸæ–‡ï¼š<https://itnext.io/kubernetes-multi-cluster-networking-made-simple-c8f26827813?source=collection_archive---------1----------------------->

**TLï¼›DR:** ä¸ºäº†ä¾¿äºæ‰©å±•ï¼ŒKubernetes å¤šé›†ç¾¤ç½‘ç»œåº”è¯¥ç®€å•ã€‚å¦‚æœæ‚¨ä¸æƒ³æ‹…å¿ƒå¤æ‚çš„è·¯ç”±ã€è¦†ç›–ç½‘ç»œã€éš§é“æˆ–è€…å¿…é¡»åŠ å¯†é›†ç¾¤ä¹‹é—´çš„æµé‡(å‡è®¾æ‚¨çš„åº”ç”¨ç¨‹åºå·²ç»åœ¨è¿™æ ·åš)ï¼Œé‚£ä¹ˆé€æ˜åœ°è¿è¡Œ IPv6 åº”è¯¥ä¼šæœ‰æ‰€å¸®åŠ©ã€‚

æˆ‘åˆšä» [Kubecon NA 2018](https://events.linuxfoundation.org/events/kubecon-cloudnativecon-north-america-2018/) å›æ¥ï¼Œåœ¨é‚£é‡Œæˆ‘æœ‰æœºä¼šå‚åŠ äº†éå¸¸é¼“èˆäººå¿ƒçš„ä¼šè®®ï¼Œä»ä¸åŒè§’åº¦ä»‹ç»äº† Kubernetes å¤šé›†ç¾¤ç½‘ç»œã€‚å…¶ä¸­åŒ…æ‹¬:

*   [ä½¿ç”¨ Istio Multicluster åœ¨é›†ç¾¤ä¹‹é—´â€œçˆ†å‘â€å·¥ä½œè´Ÿè½½](https://codelabs.developers.google.com/codelabs/istio-multi-burst/#0) ( [ç§‘æ—Â·å°¼å°”æ£®](https://twitter.com/colnels))
*   [ä¸€è·¯å‘ä¸‹çš„é›†ç¾¤:ç–¯ç‹‚çš„å¤šé›†ç¾¤æ‹“æ‰‘](https://www.youtube.com/watch?v=-gPnYTI70FE) ( [é©¬ç‰¹Â·è€ƒå°”è²å°”å¾·](https://www.oort.io/))
*   [è·¨ Kubernetes é›†ç¾¤è¿è¡Œåˆ†å¸ƒå¼ç³»ç»Ÿ](https://www.youtube.com/watch?v=nNjWrAjzgr8) : ( [Alex Robinson](https://twitter.com/alexwritescode) )
*   [è·¨äº‘æä¾›å•†è¿æ¥ Kubernetes é›†ç¾¤](https://www.youtube.com/watch?v=U34lQ8KbQow) ( [æ‰˜é©¬æ–¯Â·æ ¼æ‹‰å¤«](https://twitter.com/tgraf__))

æˆ‘æ— æ³•åœæ­¢æ€è€ƒ IPv6 å°†ç»™å¤šé›†ç¾¤ç½‘ç»œå¸¦æ¥çš„å¥½å¤„ã€‚æ¯•ç«Ÿå‡¯å°”è¥¿åœ¨ä»–çš„ä¸»é¢˜æ¼”è®²ä¸­è¯´è¿‡:

> äººä»¬æ— è§†è¿‡å»ï¼Œä¸€äº‹æ— æˆã€‚ç„¶åç¯æ³¡ç­äº†ï¼Œè¯´ï¼›å˜¿ï¼Œä¹Ÿè®¸è¿™æ˜¯ä¸€ä¸ªæ–°é—®é¢˜ï¼Œä½†ä¹Ÿè®¸æ—§çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯ç­”æ¡ˆã€‚è¿™å°±æ˜¯è¯€çªã€‚
> 
> â€•å‡¯å°”è¥¿Â·æµ·å¡”å°”

# **å¤šé›†ç¾¤ç½‘ç»œ(ç§æœ‰ IPv4 åœ°å€ç©ºé—´)**

å¦‚æœä½ ä¸ç†Ÿæ‚‰ Kubernetes â€”å•é›†ç¾¤â€”è”ç½‘ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„å¸–å­ï¼› [Kubernetes è”ç½‘:å¹•å](https://medium.com/@nicolasleiva/kubernetes-networking-behind-the-scenes-39a1ab1792bb)æˆ–è€…æŸ¥çœ‹è¿™äº› [Kubernetes è”ç½‘é“¾æ¥](https://github.com/nleiva/kubernetes-networking-links)ã€‚

ç°åœ¨ï¼Œä¸ºä»€ä¹ˆè¦è¿è¡Œå¤šä¸ªé›†ç¾¤ã€‚å—¯ï¼Œæˆ‘ä¸æ‰“ç®—åœ¨è¿™é‡Œè®¨è®ºè¿™ä¸ªé—®é¢˜ï¼Œå› ä¸º Matt Caulfield åœ¨ä»–çš„æ¼”è®²ä¸­å¾ˆå¥½åœ°è§£é‡Šäº†åŸå› ï¼Œè€Œ Thomas Graf åœ¨ä»–çš„æ¼”è®²ä¸­å±•ç¤ºäº†éå¸¸æœ‰è¯´æœåŠ›çš„ä½¿ç”¨æ¡ˆä¾‹ï¼›é«˜å¯ç”¨æ€§ã€å…±äº«æœåŠ¡ã€ç–æ•£(é›†ç¾¤å‡çº§)ç­‰ã€‚

![](img/39b4570f3daa86e8ba9e70bf52c601d4.png)

é‚£ä¹ˆï¼Œæ€æ ·æ‰èƒ½å®ç°èˆ±å¯¹èˆ±çš„é€šä¿¡å‘¢ï¼Ÿé¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰å¦‚ä½•å°†`pod`ç½‘ç»œè·¯ç”±åˆ°æœ¬åœ°é›†ç¾¤ä¹‹å¤–ï¼Œè¿™ä¸æ˜¯ä½ çš„`CNI`æ’ä»¶é€šå¸¸ä¼šåšçš„äº‹æƒ…ã€‚æ‚¨è¿˜éœ€è¦åˆ¶å®šä¸€ä¸ªå¯»å€æ–¹æ¡ˆï¼Œå› ä¸ºæ‚¨ä¸å¸Œæœ›åœ¨æ‚¨çš„é›†ç¾¤ä¹‹é—´è¿è¡Œé‡å çš„ IP åœ°å€ï¼Œå¦åˆ™è¿™å°†ä¸èµ·ä½œç”¨â€¦æˆ‘ä»¬æ˜¯åœ¨é€šè¿‡éš§é“ä¼ è¾“æµé‡å—ï¼Ÿè¿è¡Œæ–°çš„è¦†ç›–ç½‘ç»œï¼ŸåŠ å¯†æµé‡ä»¥ä¾¿åœ¨äº’è”ç½‘ä¸Šä¼ è¾“ï¼Ÿè¿™ä¸ªæ¸…å•è¿˜åœ¨ç»§ç»­ã€‚

å¬èµ·æ¥å¤ªå¤æ‚äº†ï¼Œä¸æ˜¯å—ï¼Ÿç„¶è€Œï¼Œè¯·è®°ä½ï¼Œè¿™ä¸»è¦æ˜¯å› ä¸ºæˆ‘ä»¬çš„`pod`ç½‘ç»œä½¿ç”¨äº†ç§æœ‰ IPv4 åœ°å€ã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºæ ¹æœ¬æ²¡æœ‰è¶³å¤Ÿçš„å…¬å…± IPv4 åœ°å€æ¥åº”å¯¹å¾®æœåŠ¡çš„æ¿€å¢ã€‚

è®©æˆ‘ä»¬çœ‹çœ‹æ”¯æŒè¿™ä¸€ç‚¹çš„ä¸åŒæ‹“æ‰‘ã€‚

## 2 ç°‡ï¼Ÿ

1 ä¸ª VPN éš§é“ï¼Œå°èœä¸€ç¢Ÿã€‚å¯èƒ½æ˜¯åœ¨ä¸¤ä¸ªäº‘æä¾›å•†ä¹‹é—´ï¼Œæˆ–è€…åªæ˜¯å…¶ä¸­ä¸€ä¸ªå’Œæ‚¨çš„æœ¬åœ°é›†ç¾¤ä¹‹é—´ã€‚å¦‚æœæ‚¨åœ¨åŒä¸€ä¸ªäº‘æä¾›å•†ä¸­æœ‰ä¸¤ä¸ªé›†ç¾¤ï¼Œæ‚¨é€šå¸¸**ä¸éœ€è¦è¿™æ ·åšã€‚**

![](img/f1f7195058c435fee510418641fbaf4e.png)

å¯èƒ½æœ‰ 2 ä¸ª VPN éš§é“ç”¨äºå†—ä½™ã€‚è¿˜æ˜¯å¯æ§çš„ã€‚

![](img/0e770b5db94cc5d20b249fb346ab2f2a.png)

## 3 ç°‡ï¼Ÿ

ä¹Ÿè®¸ä½ çš„åˆ†å¸ƒå¼åº”ç”¨éœ€è¦ä¸€ä¸ªä»²è£å™¨ï¼Ÿå¦‚æœä½ è¿˜å»ºç«‹äº†å†—ä½™è¿æ¥ï¼Œä½ æˆ–è®¸å¯ä»¥ç§°ä¹‹ä¸ºâ€œ*æˆåŠŸçš„è¿ä½“ä¸‰è§’å½¢*â€ã€‚åŒæ ·ï¼Œä¸ä¸€å®šæ˜¯ä¸‰ä¸ªä¸åŒçš„äº‘æä¾›å•†ã€‚

![](img/fe65e1518091a3f10b68b8258d774bd1.png)

## 3+ ?

æ‚¨çš„æ‹“æ‰‘æœ‰ä¸åŒçš„è®¾è®¡æ–¹æ¡ˆï¼›è½´è¾å¼ã€å…¨ç½‘çŠ¶ç­‰ã€‚æ‰€æœ‰è¿™äº›éƒ½å„æœ‰åˆ©å¼Šã€‚

**è½®æ¯‚å’Œè¾æ¡**

![](img/20e8a8019d08114bd40f03acf256eb20.png)

**å…¨ç½‘çŠ¶**

![](img/98073dbdcd4a4c44a27814ad1933d270.png)

åœ¨ä¸æˆä¸ºè¿è¥å™©æ¢¦çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªè§„æ¨¡è¿˜èƒ½æ‰©å¤§å¤šå°‘ï¼Ÿåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå®Œæ•´çš„ç½‘æ ¼è¦æ±‚`N*(N-1)/2`ä¸`N`çš„äº’è¿ç­‰äºé›†ç¾¤çš„æ•°é‡ã€‚

æœ‰ä¸€äº›è§£å†³æ–¹æ¡ˆè¯•å›¾è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚`SD-WAN`ã€‚ä½†æ˜¯ä¸ºäº†è¿™ç¯‡æ–‡ç« ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚æœæˆ‘ä»¬åªä½¿ç”¨å…¬å…± IPv6 åœ°å€ä¼šæ˜¯ä»€ä¹ˆæ ·å­ã€‚

# **å¤šé›†ç¾¤è”ç½‘(å…¬å…± IPv6 åœ°å€ç©ºé—´)**

ä¸ºä»€ä¹ˆä½¿ç”¨ IPv6ï¼Ÿå› ä¸º"*æˆ‘ä»¬å¯ä»¥ä¸ºåœ°çƒè¡¨é¢çš„æ¯ä¸€ä¸ªåŸå­åˆ†é…ä¸€ä¸ªå…¬å…± IPv6 åœ°å€ï¼Œå¹¶ä¸”ä»ç„¶æœ‰è¶³å¤Ÿçš„åœ°å€æ¥å†åˆ†é… 100 å¤šä¸ªåœ°çƒ*"[[æº](https://itknowledgeexchange.techtarget.com/whatis/ipv6-addresses-how-many-is-that-in-numbers/)

è®©æˆ‘ä»¬çœ‹çœ‹è¿™æ˜¯ä»€ä¹ˆæ ·å­ï¼Œå¹¶è®¨è®ºå¯¹ç‰¹æ®Šè·¯ç”±ã€åŠ å¯†æˆ–éš§é“ä»¥åŠå†—ä½™è¿æ¥çš„éœ€æ±‚ã€‚æˆ‘ä»¬éœ€è¦è¿™äº›å—ï¼Ÿæœ‰å“ªäº›å¼Šç«¯ï¼Ÿå®¢è§‚åœ°çœ‹ï¼Œè¿™æ˜¯ä¸€ä¸ª 3 é›†ç¾¤è®¾ç½®çš„æ‹“æ‰‘ç»“æ„ã€‚

![](img/ab65a9856fcdfbc5d544a08e0744e976.png)

## æŒ‰æŒ‡å®šè·¯çº¿å‘é€

æˆ‘ä»¬å°†è·¨åœ°åŒºè”ç½‘ç§»äº¤ç»™æ‚¨çš„åº•å±‚åŸºç¡€è®¾æ–½/äº’è”ç½‘ã€‚ä¸éœ€è¦ç‰¹æ®Šçš„è·¯ç”±ï¼Œä¸éœ€è¦åœ¨é›†ç¾¤ä¹‹é—´å»ºç«‹å†—ä½™è¿æ¥ã€‚å®ƒå¯èƒ½æ‰©å±•åˆ°ä»»æ„æ•°é‡çš„é›†ç¾¤â€¦ä¸€åˆ‡éƒ½æ˜¯å…è´¹çš„ï¼›æœ‰ä»€ä¹ˆæ¡ä»¶ï¼Ÿæ˜¯æ—¶å€™è°ˆè°ˆå®‰å…¨é—®é¢˜äº†ã€‚

## å®‰å…¨æ€§

æˆ‘çŸ¥é“ä½ åœ¨æƒ³ä»€ä¹ˆâ€¦æˆ‘ä»¬æ­£åœ¨æŠŠæˆ‘ä»¬çš„å†…éƒ¨åŸºç¡€è®¾æ–½æš´éœ²ç»™äº’è”ç½‘ã€‚âš ï¸

å—¯ï¼Œé™¤éä½ æ­£åœ¨è®¾ç½®ç±»ä¼¼äº[ç§æœ‰é›†ç¾¤](https://cloud.google.com/kubernetes-engine/docs/how-to/private-clusters)çš„ä¸œè¥¿ï¼Œå¦åˆ™ä½ çš„`pods`é€šå¸¸å¯ä»¥é€šè¿‡ç½‘ç»œåœ°å€è½¬æ¢( [NAT](https://en.wikipedia.org/wiki/Network_address_translation) )è®¿é—®äº’è”ç½‘ï¼Œè€Œ [NAT](https://en.wikipedia.org/wiki/Network_address_translation) å¹¶ä¸ä¼šçœŸæ­£é˜»æ­¢æ•°æ®åŒ…ã€‚NAT æ ¹æœ¬ä¸è¶³ä»¥ä¿æŠ¤æ‚¨çš„åŸºç¡€è®¾æ–½ã€‚ç„¶è€Œï¼Œå®ƒç¡®å®éšè—äº†å†…éƒ¨å¯»å€ï¼Œä»£ä»·æ˜¯å°†è½¬æ¢çŠ¶æ€ä¿å­˜åœ¨å…¶ä»–åœ°æ–¹ã€‚

è®©æˆ‘ä»¬è¿è¡Œè¿™é‡Œ[æè¿°çš„ç¤ºä¾‹](https://kubernetes.io/docs/tasks/debug-application-cluster/get-shell-running-container/#getting-a-shell-to-a-container)æ¥åœ¨æ‰˜ç®¡çš„ Kubernetes é›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ª`ngnix` podã€‚

```
kubectl create -f [https://k8s.io/examples/application/shell-demo.yaml](https://k8s.io/examples/application/shell-demo.yaml)
kubectl exec -it shell-demo -- /bin/bash
apt-get update
apt-get install iputils-ping iproute2 -y
```

ç°åœ¨å°è¯• ping ä¸€ä¸ªå…¬å…±ç½‘ç«™(`apt-get`é‚£æ—¶å·²ç»æ¥å…¥äº’è”ç½‘)

```
root@shell-demo:/# **ping azure.microsoft.com -c 1**
PING l-0007.l-msedge.net (13.107.42.16) 56(84) bytes of data.
64 bytes from 13.107.42.16 (13.107.42.16): icmp_seq=1 ttl=119 time=3.09 ms--- l-0007.l-msedge.net ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 3.094/3.094/3.094/0.000 ms
```

æ‰€ä»¥ä½ åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¸äº’è”ç½‘ç›¸è¿ã€‚

å¦ä¸€æ–¹é¢ï¼Œå¦‚æœä½ æ‹…å¿ƒæœ‰äººé€šè¿‡ IPv6 ä»äº’è”ç½‘è®¿é—®ä½ çš„`pods`ï¼Œè¯·è®°ä½ä½ æœ‰å¤šå±‚å®‰å…¨æªæ–½æ¥éš”ç¦»ä»–ä»¬ã€‚ä¾‹å¦‚ï¼Œåœ¨ AWS ä¸­ï¼Œæ‚¨æœ‰ [ACL](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-network-acls.html) ç”¨äºæ§åˆ¶è¿›å‡ºä¸€ä¸ªæˆ–å¤šä¸ªå­ç½‘çš„æµé‡ï¼Œå› æ­¤æ‚¨å¯ä»¥é˜»æ­¢ä»»ä½•ä¸æ˜¯æ¥è‡ªæ‚¨çš„å¦ä¸€ä¸ªå­ç½‘çš„æµé‡è¿›å…¥æ‚¨çš„å­ç½‘ã€‚é‚£ä¹ˆæ‚¨çš„èŠ‚ç‚¹/è™šæ‹Ÿæœºå°†æœ‰ä¸€ä¸ª[å®‰å…¨ç»„](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html)ï¼Œå› æ­¤æ‚¨ä¹Ÿå¯ä»¥åœ¨å®ä¾‹çº§åˆ«é™åˆ¶è®¿é—®ã€‚æœ€åï¼Œä½†åŒæ ·é‡è¦çš„æ˜¯ï¼Œä½ è¿˜å¯ä»¥åœ¨ Kubernetes ä¸­åº”ç”¨ä¸€ä¸ª[ç½‘ç»œç­–ç•¥](https://kubernetes.io/docs/concepts/services-networking/network-policies/)æ¥åœ¨ pod çº§åˆ«ä¿æŠ¤ä½ ã€‚

![](img/3720d983481d81b269480b8c69e9c53c.png)

AWS å°†ä¸ºæ‚¨çš„`VPC`æä¾›ä¸€ä¸ª`/56` IPv6 å­ç½‘ã€‚é‚£ç›¸å½“äº**256**IPv6 å­ç½‘ã€‚ä¾‹å¦‚ï¼Œæ‚¨çš„ [ACL](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-network-acls.html) å¯èƒ½åªå…è®¸åˆ†é…ç»™ä¸åŒ`VPC`æˆ– Kubernetes é›†ç¾¤çš„`/56`ä¹‹é—´çš„æµé‡ã€‚æ‰€ä»¥ä½ çš„`pods`å®é™…ä¸Šåªèƒ½è¢«å…¶ä»–`pods`è®¿é—®ã€‚ç„¶åå¯ä»¥ä½¿ç”¨[å®‰å…¨ç»„](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html)å’Œ[ç½‘ç»œç­–ç•¥](https://kubernetes.io/docs/concepts/services-networking/network-policies/)æ¥åº”ç”¨æ›´ç»†ç²’åº¦çš„ç­–ç•¥ã€‚

è‡³äºéš§é“ã€VPN è¿æ¥ã€è¦†ç›–ç½‘ç»œç­‰ã€‚ä¸ [NAT](https://en.wikipedia.org/wiki/Network_address_translation) ç›¸åŒï¼›å®ƒä»¬éšè—æ‚¨çš„ç«¯ç‚¹ï¼Œä»£ä»·æ˜¯ IPsec çš„æ€§èƒ½æŸå¤±ã€æ•°æ®åŒ…å¼€é”€ç­‰ã€‚å¦‚æœæ‚¨å¯ä»¥æ¥å—åœ¨æ‚¨çš„ pods ä¸­ä½¿ç”¨å…¬å…± IPv6 åœ°å€(+ [ACL](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-network-acls.html) )ï¼Œé‚£ä¹ˆå‰é¢çš„æŠ€æœ¯éƒ½ä¸æ˜¯ä¸¥æ ¼å¿…éœ€çš„ã€‚æˆ‘çŸ¥é“è¿™å¯èƒ½ä¸é€‚ç”¨äºæ‰€æœ‰äººï¼Œæ²¡å…³ç³»ï¼Œè¿™æ˜¯ä¸€ç§äº¤æ¢ã€‚

## å¤„ç† IPv6 åœ°å€

æ˜¯å•Šï¼Œæˆ‘çŸ¥é“ã€‚è®°ä½ä¸€ä¸ª IPv4 åœ°å€å·²ç»å¤Ÿéš¾çš„äº†ï¼Œæ‰€ä»¥ 128 ä½é•¿çš„ IPv6 åœ°å€å¬èµ·æ¥ä¸å¤ªå¯èƒ½ã€‚

å¥½å§ï¼Œè™½ç„¶æ¯ä¸ª`pod`éƒ½æœ‰è‡ªå·±çš„ IP åœ°å€ï¼Œä½†æ˜¯è¿™äº› IP åœ°å€å¹¶ä¸ç¨³å®šï¼Œå› ä¸º`pods`æ­»äº†ä¹Ÿä¸ä¼šå¤æ´»ã€‚ç”±äºè¿™ä¸ªåŸå› ï¼ŒKubernetes æœ‰äº†ä¸€ä¸ª`Service`çš„æ¦‚å¿µï¼Œå®ƒå®šä¹‰äº†ä¸€ä¸ªç”±`Label Selector`å†³å®šçš„`pods`çš„é€»è¾‘é›†åˆã€‚[ [Kubernetes æœåŠ¡](https://kubernetes.io/docs/concepts/services-networking/service/) ]ã€‚æ­¤å¤–ï¼Œåœ¨ Kubernetes " *ä¸­ï¼Œé›†ç¾¤ä¸­å®šä¹‰çš„æ¯ä¸ªæœåŠ¡éƒ½è¢«åˆ†é…äº†ä¸€ä¸ª DNS åç§°* " [ [æœåŠ¡çš„ DNS](https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#what-things-get-dns-names)]ã€‚

è¿™æ„å‘³ç€æ‚¨çš„`pods`å°†é€šè¿‡ä»–ä»¬çš„`Service` DNS åç§°åˆ°è¾¾ï¼Œå› æ­¤æ‚¨å®é™…ä¸Šä¸éœ€è¦å¤„ç†åœ°å€æœ¬èº«ï¼Œè¿™ä¸€åˆ‡éƒ½å‘ç”Ÿåœ¨å¹•åã€‚

åœ¨é’ˆå¯¹ Kubernetes é›†ç¾¤çš„ [IPv4/IPv6 åŒæ ˆåŠŸèƒ½ææ¡ˆ](https://github.com/leblancd/community/blob/fc4d40bac4ca76d9c46fa7335ea74a186388c313/keps/sig-network/0013-20180612-ipv4-ipv6-dual-stack.md#configuration-of-endpoint-ip-family-in-service-definitions)ä¸­ï¼Œå®ƒä»¬è¯´æ˜äº†å¦‚ä½•ä¸º Kubernetes `Service`æŒ‡å®šåœ°å€æ—ã€‚

```
endpointFamily: <ipv4|ipv6|dual-stack>       [Default: dual-stack]
```

ç¤ºä¾‹:

```
spec:
  selector:
    app: MyApp
  ports:
  - protocol: TCP
    port: 80
    targetPort: 9376
  endpointFamily: ipv6
```

# **å½“å‰æŒ‘æˆ˜**

## Kubernetes IPv6 æ”¯æŒ

å¥½æ¶ˆæ¯æ˜¯ä»–ä»¬åœ¨è¿™ä¸€é¢†åŸŸå–å¾—äº†éå¸¸å¥½çš„è¿›å±•ï¼Œä»…æ”¯æŒ IPv6 åœ¨ Kubernetes ç‰ˆä¸­æ˜¯`Alpha`[[IPv6 æ”¯æŒå¢åŠ äº†#508](https://github.com/kubernetes/enhancements/issues/508) ]å¹¶ä¸”åº”è¯¥åœ¨ K8s 1.13 ä¸­æ˜¯`Beta`ã€‚ã€[è¯„è®º](https://github.com/kubernetes/enhancements/issues/508#issuecomment-411178780)ã€‘ã€‚è¿˜æœ‰ææ¡ˆæå‡ºâ€œ[å¢åŠ  IPv4/IPv6 åŒæ ˆæ”¯æŒå’Œæ„ŸçŸ¥# 62822](https://github.com/kubernetes/kubernetes/issues/62822)â€[[PR](https://github.com/kubernetes/community/pull/2254)ï¼Œ [KEP](https://github.com/kubernetes/enhancements/blob/1a03c720c3426efb16a68942bc8db37ac2b957f7/keps/sig-network/0013-20180612-ipv4-ipv6-dual-stack.md) ã€‚

ä¸ºä»€ä¹ˆæ˜¯åŒæ ˆï¼Ÿä¸å¹¸çš„æ˜¯ï¼Œç°åœ¨å·²ç»å¿« 2020 å¹´äº†ï¼Œä½†ä»ç„¶æœ‰ä¸€äº›å…³é”®æœåŠ¡ä¸æ”¯æŒ IPv6 å°±åƒæ‚¨çš„`pods`å¯èƒ½éœ€è¦è®¿é—®çš„ä¸€äº›åŒ…ã€æºä»£ç å’Œå®¹å™¨åº“ã€‚ğŸ‘

ä»å¥½çš„æ–¹é¢æ¥çœ‹ï¼Œç›®å‰æœ‰ä¸€äº›`CNI`æ’ä»¶å·²ç»èƒ½å¤Ÿåœ¨`pod`ä¸Šé…ç½®åŒæ ˆåœ°å€ã€‚ç„¶è€Œï¼Œé‡è¦çš„æ˜¯è¦è®°ä½ï¼Œæ ¹æ®`PodStatus` V1 æ ¸å¿ƒ API çš„å®šä¹‰ï¼ŒKubernetes æ¯ä¸ª`pod`åªçŸ¥é“ä¸€ä¸ªåœ°å€ã€‚åŒæ ˆæè®®ç§°ï¼Œä»–ä»¬å°†ä¿ç•™`PodIP`å­—æ®µï¼Œä½†ä¹Ÿä¼šæ·»åŠ ä¸€ä¸ªæ–°æ•°ç»„`PodIPs`ï¼Œç”¨äºå­˜å‚¨é¢å¤–çš„`pod`IP[[PR](https://github.com/kubernetes/kubernetes/pull/69029)]ã€‚

```
type PodStatus struct {
        ...
        HostIP     string
        PodIP      string
        PodIPs     []PodIPInfo
        ...    
}
```

å’Œ

```
type PodIPInfo struct {
        IP         string
        Properties map[string]string
    }
```

åœ¨è¿‡å»ï¼Œå½“ä½¿ç”¨åŒæ ˆé›†ç¾¤æ—¶ï¼Œæˆ‘æ‰€åšçš„æ˜¯ä½¿ IPv6 åœ°å€æˆä¸ºåˆ†é…ç»™`pod`çš„ IPv4 åœ°å€çš„æ•£åˆ—å‡½æ•°ï¼Œå› æ­¤æˆ‘åªéœ€è¦è·Ÿè¸ªå…¶ä¸­ä¸€ä¸ªå¹¶è‡ªåŠ¨å¯¼å‡ºå¦ä¸€ä¸ªã€‚è¿™å¤§æ¦‚æ˜¯ä¸æ¨èçš„ï¼Œä½†æ˜¯å¦‚æœä½ å¥½å¥‡çš„è¯ï¼Œæˆ‘åœ¨æˆ‘çš„ Gophercon lightning talk æ¼”ç¤ºä¸­æ˜¯è¿™ä¹ˆåšçš„:[å®¹å™¨ç½‘ç»œæ¥å£å’Œ Go](https://www.youtube.com/watch?v=0SXPsLvB0UI) ã€‚

æœ€åï¼ŒåŒæ ·é‡è¦çš„æ˜¯ï¼ŒKube-proxy å°†è¢«ä¿®æ”¹ä¸ºå¹¶è¡Œé©±åŠ¨`iptables`å’Œ`ip6tables`(å¦‚æœä¸ä½¿ç”¨`eBPF`)ã€‚å¦ä¸€æ–¹é¢ï¼Œ`Service`é›†ç¾¤å†…çš„è®¿é—®å°†é€šè¿‡æ‰€æœ‰ IPv4 æœåŠ¡ IP æˆ–æ‰€æœ‰ IPv6 æœåŠ¡ IP æ¥å®Œæˆã€‚ç¡®ä¿æ‚¨æ£€æŸ¥äº†å»ºè®®ä¹¦çš„[éç›®æ ‡](https://github.com/kubernetes/enhancements/blob/1a03c720c3426efb16a68942bc8db37ac2b957f7/keps/sig-network/0013-20180612-ipv4-ipv6-dual-stack.md#non-goals)ã€‚

## äº‘æä¾›å•† IPv6 æ”¯æŒ

äº‘æœåŠ¡æä¾›å•†å¯¹è™šæ‹Ÿæœº/å®ä¾‹çš„ IPv6 æ”¯æŒå……å…¶é‡ä¹Ÿåªæ˜¯å‡¤æ¯›éºŸè§’ã€‚æˆ‘å¸Œæœ›èƒ½å¤Ÿè¿›è¡Œ IPv6 å­ç½‘è·¯ç”±ï¼Œä»¥ä¾¿ä¸ºæ¯ä¸ªè™šæ‹Ÿæœºå®ä¾‹åˆ†é…ä¸åŒçš„ IPv6 å­ç½‘ã€‚AWS åœ¨ IPv6 æ”¯æŒæ–¹é¢èµ°åœ¨äº†å‰é¢ï¼Œä½†æ˜¯å®ƒä¸ä¼šè®©ä½ åˆ†è§£ä»–ä»¬åœ¨ VPC ä¸­åˆ†é…ç»™ä½ çš„`/56`ï¼Œåˆ†é…ç»™ä½ å®ä¾‹çš„ä¸ªäºº`/64`[[è®ºå›](https://forums.aws.amazon.com/thread.jspa?messageID=799319#799319)ã€‚

![](img/19ed945b415d833d9633725c3f417610.png)

AWS æ”¯æŒå›¢é˜Ÿå¸®åŠ©æˆ‘å®Œæˆäº†ä¸€ä¸ªå·¥ä½œåŒºï¼Œé€šè¿‡ä½¿ç”¨ [ENI](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html) å°†è™šæ‹Ÿæœºä¸Šçš„`/64`çš„è¾ƒå°å—ç”¨ä½œ`pod`ç½‘ç»œã€‚è™½ç„¶ä½¿ç”¨å°äº`/64`çš„å­ç½‘ä¸æ˜¯æ¨èçš„åšæ³•ï¼Œç”šè‡³å¯èƒ½æ— æ³•ä¸ [Docker](https://docs.docker.com/v17.09/engine/userguide/networking/default_network/ipv6/#how-ipv6-works-on-docker) ä¸€èµ·ä½¿ç”¨ï¼Œå› ä¸º"*Docker å®¹å™¨çš„å­ç½‘è‡³å°‘åº”è¯¥æœ‰* `*/80*` *çš„å¤§å°ï¼Œ å› æ­¤ï¼ŒIPv6 åœ°å€å¯ä»¥ä»¥å®¹å™¨çš„ MAC åœ°å€ç»“æŸï¼Œå¹¶ä¸”æ‚¨å¯ä»¥é˜²æ­¢ Docker å±‚*ä¸­çš„ NDP é‚»å±…ç¼“å­˜æ— æ•ˆé—®é¢˜â€ï¼Œè¿™è‡³å°‘ä¼šè®©æˆ‘åœ¨æ­¤æœŸé—´åšä¸€äº›å®éªŒã€‚ æˆ‘å°†å•ç‹¬å†™ä¸€ç¯‡æ–‡ç« æè¿°è¿™æ˜¯å¦‚ä½•å·¥ä½œçš„â¡ï¸å¦‚ä½•åœ¨ AWS ä¸Šè¿è¡Œæ”¯æŒ IPv6 çš„ Docker å®¹å™¨ã€‚

å¦ä¸€æ–¹é¢ï¼Œå¦‚æœæ‚¨æ­£åœ¨è¿è¡Œä¸€ä¸ªæ‰˜ç®¡çš„ Kubernetes é›†ç¾¤ï¼Œé‚£ä¹ˆ IPv6 å¯èƒ½éœ€è¦æ›´é•¿çš„æ—¶é—´ï¼Œå› ä¸ºå®ƒä»¬è¿è¡Œçš„ Kubernetes ç‰ˆæœ¬å°†åªåŒ…å«æˆç†Ÿçš„ç‰¹æ€§ã€‚æ¯”å¦‚ GCP è¯´:"*ä¸ºç¡®ä¿ç¨³å®šæ€§å’Œç”Ÿäº§è´¨é‡ï¼Œæ™®é€š GKE é›†ç¾¤ä»…å¯ç”¨* `*beta*` *æˆ–æ›´é«˜ç‰ˆæœ¬çš„åŠŸèƒ½ã€‚* `*Alpha*` *åŠŸèƒ½æ— æ³•åœ¨æ™®é€šé›†ç¾¤ä¸Šå¯ç”¨ï¼Œå› ä¸ºå®ƒä»¬æ— æ³•æŠ•å…¥ç”Ÿäº§æˆ–å‡çº§*ã€‚GCP æ–‡ä»¶ã€‚å› æ­¤ï¼ŒIPv6 åœ¨ GCP æ˜¯ä¸€ä¸ªç¦å¿Œï¼Œå› ä¸ºä»–ä»¬ç”šè‡³ä¸æ”¯æŒå®ƒã€‚

# **ç»“è®º**

è™½ç„¶è¦å®ç°è¿™ä¸€ç‚¹è¿˜éœ€è¦åšä¸€äº›å·¥ä½œï¼Œä½†æˆ‘ç›¸ä¿¡è¿™æ˜¯å€¼å¾—çš„ï¼Œå¹¶ä¸”æœ‰åŠ©äºæ§åˆ¶å¤æ‚æ€§ã€‚IPv6 çš„å¥½å¤„ä¸ä»…é€‚ç”¨äºå•ä¸ªé›†ç¾¤ï¼Œä¹Ÿé€‚ç”¨äºå¤šé›†ç¾¤ Kubernetes ç³»ç»Ÿã€‚å¦‚æœæ‚¨çŸ¥é“ä¸€å®¶æ”¯æŒ IPv6 çš„äº‘æä¾›å•†ï¼Œè¯·å‘Šè¯‰æˆ‘ã€‚

å»¶ä¼¸é˜…è¯»:

*   [Kubernetes ç½‘ç»œ:å¹•å](/kubernetes-networking-behind-the-scenes-39a1ab1792bb?source=friends_link&sk=b5b666c68375f7c60f76faa8571baa21)
*   [å¦‚ä½•åœ¨ AWS ä¸Šè¿è¡Œæ”¯æŒ IPv6 çš„ Docker å®¹å™¨](https://medium.com/@nleiva/how-to-run-ipv6-enabled-docker-containers-on-aws-87e090ab0397?source=friends_link&sk=126bd9850d2fc46a2ff99bee89c735ca)
*   [æˆ‘ä»¬éœ€è¦ IPv6 çš„ä¸‰ä¸ªåŸå› â€¦åœ¨ Kubernetes](https://nleiva.medium.com/three-reasons-we-need-ipv6-in-kubernetes-69b6f3cbadb7)