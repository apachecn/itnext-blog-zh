# Kubernetes ä¸Šçš„ Hashicorp ä¿é™©åº“å…·æœ‰è‡ªåŠ¨è§£å°åŠŸèƒ½

> åŸæ–‡ï¼š<https://itnext.io/hashicorp-vault-on-kubernetes-with-auto-unseal-b7e64edbe63e?source=collection_archive---------1----------------------->

çœŸçš„æ˜¯è‡ªæ¢å¤å’Œè‡ªåŠ¨åŒ–å‹å¥½çš„å—ï¼Ÿæœ‰ä»€ä¹ˆéšæƒ…ï¼Ÿ

æœºå¯†ç®¡ç†å’Œæ•°æ®ä¿æŠ¤è‡³å…³é‡è¦ã€‚ç„¶è€Œï¼Œå¸‚åœºä¸Šçš„å¤§å¤šæ•°è§£å†³æ–¹æ¡ˆå¹¶ä¸æ˜¯ä¸º [DevSecOps](https://www.devsecops.org/) è®¾è®¡çš„ï¼Œè¿™æ„å‘³ç€å®ƒä»¬å¹¶æ²¡æœ‰å°†å®‰å…¨æ€§ä½œä¸ºä»£ç æ¥å¼€å‘ã€‚ç›¸åï¼Œå®ƒä»¬æ˜¯ç”±æ‰‹åŠ¨é…ç½®å’Œé›ªèŠ±å˜åŒ–é©±åŠ¨çš„ã€‚æ­¤å¤–ï¼Œåœ¨ä¸€äº›ç»„ç»‡ä¸­ï¼Œä»–ä»¬ä¸å¾—ä¸é›‡ä½£ä¸“é—¨çš„ä¾›åº”å•†é¡¾é—®æ¥ç»´æŠ¤è¿™ä¸ª[é›ªèŠ±æœåŠ¡å™¨](https://martinfowler.com/bliki/SnowflakeServer.html)ã€‚

## DevSecOps å®£è¨€

> **å€šåœ¨**ä¸Šç©ºæ€»æ˜¯è¯´â€œä¸â€
> **æ•°æ®&å®‰å…¨ç§‘å­¦**ä¸Šç©ºææƒ§ï¼Œ ä¸ç¡®å®šæ€§å’Œç–‘è™‘
> **å¼€æ”¾è´¡çŒ®&åä½œ**ä»…é’ˆå¯¹å®‰å…¨éœ€æ±‚
> **ä½¿ç”¨ API çš„å¯æ¶ˆè´¹å®‰å…¨æœåŠ¡**é’ˆå¯¹å¼ºåˆ¶å®‰å…¨æ§åˆ¶&æ–‡ä¹¦å·¥ä½œ
> **ä¸šåŠ¡é©±åŠ¨çš„å®‰å…¨åˆ†æ•°**è¶…è¿‡æ©¡çš®å›¾ç« å®‰å…¨
> **çº¢è‰²&è“è‰²å›¢é˜Ÿæ¼æ´åˆ©ç”¨æµ‹è¯•**è¿‡åº¦ä¾èµ–æ‰«æ&ç†è®ºæ¼æ´
> **å…¨å¤©å€™ä¸»åŠ¨å®‰å…¨ç›‘æ§**åœ¨è·æ‚‰äº‹ä»¶åè¿‡åº¦ååº”

Hashicorp Vault OSS ä¸ºæœºå¯†ç®¡ç†ã€åŠ å¯†å³æœåŠ¡ã€ç‰¹æƒè®¿é—®ç®¡ç†ã€åŠ¨æ€æœºå¯†ã€ç§Ÿèµå’Œç»­è®¢ç­‰æä¾›äº†åŠŸèƒ½å…¨é¢ä¸”ä»£ç å‹å¥½çš„è§£å†³æ–¹æ¡ˆã€‚

æˆ‘å·²ç»å°è¯•äº†å‡ ä¸ªä»¤äººå°è±¡æ·±åˆ»çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬ AWS è®¤è¯åç«¯ï¼ŒKubernetes è®¤è¯åç«¯ï¼ŒåŠ¨æ€ MySQL ç§˜å¯†ï¼ŒåŠ¨æ€ AWS è®¿é—®å‡­è¯ï¼Œç­‰ç­‰ã€‚ä»–ä»¬éå¸¸å®¹æ˜“è®¾ç½®å’Œè‡ªåŠ¨åŒ–å‹å¥½ã€‚

# å“ˆå¸Œå…¬å¸å¼€æºè‡ªåŠ¨è§£å°å‰

å¦‚æ‚¨æ‰€çŸ¥ï¼Œè‡ªåŠ¨è§£å°ä»¥å‰ä»…é€‚ç”¨äº Vault Enterprise å®¢æˆ·ã€‚2018 å¹´ 12 æœˆï¼ŒHashicorp å…¬å¸ƒäº† Vault 1.0 å’Œ Vault OSS ä¸­çš„è‡ªåŠ¨è§£å°åŠŸèƒ½ã€‚

![](img/473cd99205851e46d70c25d6f759935e.png)

> å¼€å‘è‡ªåŠ¨è§£å°æ˜¯ä¸ºäº†å¸®åŠ©é™ä½è§£å°ä¿é™©åº“çš„æ“ä½œå¤æ‚æ€§ï¼ŒåŒæ—¶ä¿æŒä¸»å¯†é’¥çš„å®‰å…¨ã€‚è¯¥åŠŸèƒ½å°†ä¿æŠ¤ä¸»å¯†é’¥çš„è´£ä»»ä»*æ“ä½œå‘˜*å§”æ‰˜ç»™å—ä¿¡ä»»çš„*è®¾å¤‡*æˆ–*æœåŠ¡*ã€‚

åœ¨æˆ‘ä»¬æ·±å…¥äº†è§£è‡ªåŠ¨è§£å°æœ‰å¤šæ£’ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨æ—§ç‰ˆæœ¬çš„ vault ä¸­æˆ‘ä»¬å¿…é¡»æ‰‹åŠ¨åšäº›ä»€ä¹ˆã€‚

æ­£å¦‚æˆ‘ä»¬æ‰€çŸ¥ï¼Œæœ‰ä¸¤ç§å¸¸è§çš„æ–¹æ³•ä½¿ä¿é™©åº“èˆ±å¯†å°:

*   ç”±äºæ•…éšœã€éƒ¨ç½²æˆ–å‡çº§ï¼Œä¿ç®¡åº“ pod é‡æ–°å¯åŠ¨
*   æ„å‘å°å­˜æ“ä½œ:*é‡‘åº“æ“ä½œå‘˜å°å­˜*

åœ¨è¿™äº›æƒ…å†µä¸‹ï¼ŒVault pods å°†æ— æ³•é€šè¿‡ Kubernetes å°±ç»ªæ€§æ¢æµ‹ï¼Œå¹¶åœæ­¢ä¸ºæµé‡æä¾›æœåŠ¡ã€‚æ¯å½“æˆ‘æœ‰ä¸€ä¸ªè¿™æ ·çš„ä»ªè¡¨æ¿ï¼Œæˆ‘çš„å¿ƒå°±æ­»äº†ä¸€ç‚¹ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆã€‚

![](img/a78d3e9ac246d7b42c4dd17e49a1f9fa.png)

å¦‚ä¸‹é¢çš„å‘½ä»¤æ‰€ç¤ºï¼Œè¦è®©è¿™äº› pod é‡æ–°æŠ•å…¥ä¸šåŠ¡ï¼Œæˆ‘ä»¬å¿…é¡»æ‰‹åŠ¨`kubectl port-foward`æ¯ä¸ª vault podï¼Œå¹¶ä½¿ç”¨å”¯ä¸€çš„è§£å°å¯†é’¥è¿è¡Œ`vault operator unseal`è‡³å°‘ 3 æ¬¡ã€‚è¿™éœ€è¦ 3 åæ“ä½œå‘˜è¿›è¡Œ 9 æ¬¡æ‰‹åŠ¨æ“ä½œã€‚

è¯´çœŸçš„ï¼Œè°æƒ³åœ¨å‡Œæ™¨ 3 ç‚¹èµ·åºŠï¼Œå‚åŠ ç½‘ç»œä¼šè®®ï¼Œæ‰¾åˆ°è§£å°é”®ï¼Œå¹¶è¿è¡Œè§£å°å‘½ä»¤å‘¢ï¼ŸğŸ˜…

**ä¸ä»…è¿è¥æˆæœ¬å¦‚æ­¤ä¹‹é«˜ï¼Œè€Œä¸”ç”±äºä¿é™©åº“åœæœºå¯¼è‡´çš„ä¸šåŠ¡åœæœºä¹Ÿæ˜¯ä¸å¯æ¥å—çš„ã€‚**

```
**# Check Vault Status, seems it is already sealed**
(âˆ |:)bash-3.2$ vault status
Key                Value
---                -----
Seal Type          shamir
**Sealed             true**
Total Shares       5
Threshold          3
**Unseal Progress    0/3**
Unseal Nonce       n/a
Version            0.10.1
HA Enabled         true**# First Unseal, they key is hidden of course** 
(âˆ |:)bash-3.2$ vault operator unseal
Unseal Key (will be hidden):
Key                Value
---                -----
Seal Type          shamir
Sealed             true
Total Shares       5
Threshold          3
**Unseal Progress    1/3**
Unseal Nonce       12345678-2c03-320a-6dea-12345678
Version            0.10.1
HA Enabled         true**# Second Unseal** (âˆ |:)bash-3.2$ vault operator unseal
Unseal Key (will be hidden):
Key                Value
---                -----
Seal Type          shamir
Sealed             true
Total Shares       5
Threshold          3
**Unseal Progress    2/3**
Unseal Nonce       12345678-2c03-320a-6dea-12345678
Version            0.10.1
HA Enabled         true**# Third Unseal is a charm!**
(âˆ |:)bash-3.2$ vault operator unseal
Unseal Key (will be hidden):
Key                    Value
---                    -----
Seal Type              shamir
**Sealed                 false**
Total Shares           5
Threshold              3
Version                0.10.1
Cluster Name           vault-cluster-e17ad79e
Cluster ID             ab0dd9a0-dfaa-25ef-0d30-12345678
HA Enabled             true
HA Cluster             [https://10.0.3.25:8201](https://10.0.3.25:8201)
**HA Mode                standby**
Active Node Address    [http://10.0.3.25:8200](http://10.0.3.25:8200)
```

# K8S å›¾è¡¨ä¸­çš„è‡ªåŠ¨è§£å°

æˆ‘ä»¬çš„ä¿é™©åº“éƒ¨ç½²ç®¡é“éå¸¸ç®€å•ï¼Œåªæœ‰ 2 ä¸ªå¤´ç›”å›¾éƒ¨ç½²ä»»åŠ¡ã€‚

é¦–å…ˆï¼Œä½¿ç”¨ä»¥ä¸‹å€¼å°†[é¢†äº‹å¤´ç›”å›¾](https://github.com/helm/charts/tree/master/stable/consul)éƒ¨ç½²ä¸ºä¿é™©åº“å­˜å‚¨åç«¯ã€‚yamlã€‚è¯¥å›¾ç”± OSS ç¤¾åŒºæ„å»ºï¼Œå¦‚æœæ‚¨æ›´å–œæ¬¢å®˜æ–¹çš„ Hashicorp ç‰ˆæœ¬ï¼Œæ‚¨å¯ä»¥ä»[æ­¤å¤„](https://github.com/hashicorp/consul-helm)è·å¾—ã€‚

è¯·æ³¨æ„ï¼Œé¢†äº‹å‰¯æœ¬å¤§å°ä¸º 5ã€‚æˆ‘ä»¬è·¨è‡³å°‘ 3 ä¸ªå¯ç”¨æ€§åŒºåŸŸ(AZ)é¢„é…ç½®äº†ä¸€ä¸ªè‡ªåŠ¨æ‰©å±•ç»„ã€‚AZ ç¼–å·å› åœ°åŒºå’Œä¸åŒçš„äº‘æä¾›å•†è€Œå¼‚(æœ€ä½è¦æ±‚ä¸º 3)ã€‚

è‡ªåŠ¨ç¼©æ”¾ç»„ä¸­çš„ VM å®ä¾‹ç”± Kubernetes ç”¨`*kubectl label nodes <node-name> class=consul*`T9 æ¥æ ‡è®°ã€‚ä¸‹é¢çš„èŠ‚ç‚¹å…³è”æ€§å’Œ pod åå…³è”æ€§å°†ç¡®ä¿ 5 ä¸ªå’¨è¯¢ pod åˆ†å¸ƒåœ¨è‡³å°‘ 3 ä¸ª az çš„ 5 ä¸ªèŠ‚ç‚¹ä¸Šã€‚

ç¬¬äºŒæ­¥ï¼Œä½¿ç”¨ vaule.yaml éƒ¨ç½²[é‡‘åº“èˆµå›¾](https://github.com/helm/charts/tree/master/incubator/vault)ï¼Œå¦‚ä¸‹å›¾ã€‚å¯ç”¨äº†ä»¥ä¸‹ä¸€äº›å…³é”®åŠŸèƒ½:

*   å’¨è¯¢ä»£ç†è¢«ç”¨ä½œä¸å’¨è¯¢æœåŠ¡å¯¹è¯çš„è¾…åŠ©å·¥å…·
*   **ä½¿ç”¨ AWS KMS æœåŠ¡è®¾ç½®è‡ªåŠ¨è§£å°**
*   Statsd-exporter ä½œä¸º sidecar è¿è¡Œï¼Œå‘ Prometheus å…¬å¼€æŒ‡æ ‡
*   Vault é€šè¿‡ AWS è¯ä¹¦ç®¡ç†å™¨(ACM)ä½œä¸ºå…·æœ‰ SSL çš„è´Ÿè½½å¹³è¡¡å™¨æœåŠ¡å…¬å¼€

# è‡ªåŠ¨è§£å°:ç‚¸å¼¹ï¼

åœ¨å‡ ç§’é’Ÿå†…ï¼Œæˆ‘ä»¬å°†å¯åŠ¨å¹¶è¿è¡Œ Consul å’Œ Vault æœåŠ¡ã€‚

é¦–å…ˆï¼Œè®©*ç”¨å¯†é’¥ä»½é¢å’Œå¯†é’¥é˜ˆå€¼çš„é…ç½®åˆå§‹åŒ–* vaultã€‚

![](img/c0ee0e8a4e9a7ca8b33759213bb6a3d3.png)

è¿™ä¸ªæ“ä½œä¹Ÿå¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­å®Œæˆã€‚

```
vault operator init -key-shares=5 -key-threshold=3
```

åœ¨åˆå§‹åŒ–æ­¥éª¤ä¹‹åï¼Œåˆå§‹æ ¹ä»¤ç‰Œå’Œæ¢å¤å¯†é’¥éƒ½å‘ˆç°ç»™æˆ‘ä»¬ï¼Œå¹¶ä¸”å¯ä»¥ä½œä¸ºæ–‡ä»¶ä¸‹è½½ã€‚

![](img/7d35a7ae13156c68f16d9b4216552e52.png)

è¯·æ³¨æ„ï¼Œè¿™äº›å¯†é’¥åªèƒ½è®¿é—®å’Œä¸‹è½½ä¸€æ¬¡ï¼Œæ‚¨å°†æ— æ³•å†æ¬¡è·å¾—å®ƒä»¬ã€‚ä¸å‘½ä»¤è¡Œç›¸åŒï¼Œå®ƒåªä¼šè¢«æ‰“å°åˆ°ç»ˆç«¯ä¸€æ¬¡ã€‚

æ³¨æ„æ­¤æ—¶ï¼Œ**é‡‘åº“å·²ç»è‡ªåŠ¨è§£å°**ã€‚äº‹å®ä¸Šï¼Œæˆ‘èŠ±äº†ä¸€æ®µæ—¶é—´æ‰æ„è¯†åˆ°è¿™ä¸€ç‚¹ï¼Œå› ä¸ºæˆ‘çš„è‚Œè‚‰è®°å¿†ä»ç„¶å‘Šè¯‰æˆ‘ç”¨å…¶ä»–æ“ä½œè€…è§£å° 9 æ¬¡ã€‚ä¸ºäº†ç¡®è®¤å†…éƒ¨åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Œæˆ‘æ‰“å¼€äº† vault pod æ—¥å¿—ï¼Œå‘ç°å®ƒæ­£åœ¨ä½¿ç”¨æŒ‡å®šçš„ kms_key_id è°ƒç”¨ AWS KMS æœåŠ¡æ¥è‡ªåŠ¨è§£å°è‡ªå·±ã€‚

ç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹è‡ªåŠ¨è§£å°çš„æ€æ‰‹çº§ç‰¹æ€§ã€‚**æ— è®ºä»€ä¹ˆåŸå› å¯¼è‡´ä¿é™©åº“ pod é‡æ–°å¯åŠ¨ï¼Œå®ƒä»¬æ€»æ˜¯ä»¥æœªå¯†å°çŠ¶æ€è¿”å›ã€‚**æˆ‘å·²ç»å°è¯•è¿‡åœ¨åˆ†ç¦»èˆ±å†…éƒ¨æ€æ­»é‡‘åº“çš„è¿‡ç¨‹ï¼›æ­£åœ¨ç»ˆæ­¢è¿è¡Œ vault pod çš„è™šæ‹Ÿæœºã€‚æˆ‘ç”šè‡³åšäº†ä¸€ä¸ª`helm delete --purge vault`ï¼Œåªè¦æˆ‘å†æ¬¡éƒ¨ç½²å®ƒï¼Œå®ƒæ€»æ˜¯å‡ºç°æœªå¯†å°çŠ¶æ€ã€‚

# æœ‰ä»€ä¹ˆæ¡ä»¶

è¿™å¬èµ·æ¥å¥½å¾—ä»¤äººéš¾ä»¥ç½®ä¿¡ï¼Œå¯¹å—ï¼Ÿä¸€å®šæœ‰ä»€ä¹ˆè¹Šè··ã€‚æˆ‘ä»¬éœ€è¦æ³¨å…¥ä¸€äº›å¤±è´¥æ‰èƒ½æ‰¾åˆ°ã€‚

è®©æˆ‘ä»¬å€’å›å»æ£€æŸ¥ä¸€ä¸‹æˆ‘ä»¬ä¹‹å‰åšçš„ä¸€äº›å‡†å¤‡å·¥ä½œã€‚è¦ä½¿è‡ªåŠ¨è§£å°èµ·ä½œç”¨ï¼Œéœ€è¦ä½¿ç”¨ä»¥ä¸‹ KMS æƒé™éƒ¨ç½²ä¿ç®¡åº“çª—æ ¼ã€‚

![](img/0a2d7a843f8ce5de299cd9783efa119b.png)

è¿™äº› KMS æƒé™é™„åŠ åˆ° IAM ç­–ç•¥ï¼Œå¯ä»¥é€šè¿‡ 3 ç§ä¸åŒçš„æ–¹å¼è¿›è¡Œéƒ¨ç½²ï¼Œé€‰æ‹©æ‚¨æœ€å–œæ¬¢çš„æ–¹å¼:

*   AWS å®ä¾‹æ¦‚è¦æ–‡ä»¶:è™šæ‹Ÿæœºçº§åˆ«ï¼Œæ ‡å‡†è¿‡ç¨‹
*   [Kube2IAM](https://github.com/jtblin/kube2iam) è§’è‰²æ³¨é‡Š:Pod çº§åˆ«ï¼Œæ›´ç»†ç²’åº¦å’Œè‡ªæ²»
*   [AWS è®¿é—®å¯†é’¥å’Œè®¿é—®å¯†ç ](https://www.vaultproject.io/docs/configuration/seal/awskms.html#awskms-example)(ä»… POCï¼Œä¸æ¨è)

## æ•…éšœæ³¨å…¥æ¡ˆä¾‹ 1: KMS åœæœº

æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œè®©æˆ‘ä»¬é€šè¿‡åˆ é™¤ IAM ç­–ç•¥ä¸­çš„è¿™äº›æƒé™æ¥æ¨¡æ‹Ÿ AWS KMS æœåŠ¡å…³é—­ï¼Œä»è€Œå¼€å§‹æ•…éšœæ³¨å…¥ã€‚è¿™æ—¶ï¼Œåªæœ‰â€œKMS å€’ä¸‹äº†â€ã€‚ç„¶è€Œï¼Œåªè¦ä¿é™©åº“èˆ±æ²¡æœ‰é‡å¯ï¼Œæ‰€æœ‰ 3 ä¸ªèˆ±éƒ½å°†ä¿æŒå¥åº·å’Œæœªå¯†å°ã€‚

å› æ­¤ï¼Œåœ¨ç°å®ç”Ÿæ´»ä¸­ï¼Œå³ä½¿çŸ­æœŸå†…æ— æ³•è·å¾— KMS æœåŠ¡ï¼Œå¯¹æˆ‘ä»¬æ¥è¯´ä¹Ÿä¸æ˜¯ä»€ä¹ˆå¤§äº‹ã€‚

## æ•…éšœæ³¨å…¥æƒ…å†µ 2: KMS ä¸‹é™+ EC2 åœ¨ 1 AZ å†…ä¸‹é™

åœ¨ä¸‹ä¸€ä¸ªè®¾ç½®ä¸­ï¼Œæˆ‘åˆ é™¤äº†ä¸€ä¸ª podï¼Œè®©å®ƒé‡æ–°å¯åŠ¨ï¼Œè¿™å¯ä»¥æ¨¡æ‹Ÿä¸€ä¸ªè™šæ‹Ÿæœºæ•…éšœã€‚
*å¯é€‰:å¦‚æœæˆ‘ä»¬çš„ ASG é¢„é€‰äº† 4+AZï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ¨¡æ‹Ÿä¸€ä¸ª AZ çº§åˆ«çš„æ•…éšœã€‚åœ¨æ­¤æœŸé—´ï¼Œæ–°çš„åŠèˆ±å°†åœ¨ç¬¬å›› AZ å‘å°„ã€‚è¿™å¯ä»¥é€šè¿‡å±è”½ NACL*[*æ··ä¹±å¤§çŒ©çŒ©*](https://en.wikipedia.org/wiki/Chaos_engineering#Chaos_Gorilla) *æ¥å®ç°ã€‚*

æ­£å¦‚é¢„æœŸçš„é‚£æ ·ï¼Œä¿é™©åº“ pod ä»¥å¯†å°çŠ¶æ€è¿”å›ï¼Œå®ƒé€šè¿‡äº†*æ´»æ€§æ¢æµ‹*ï¼Œä½†æœªé€šè¿‡*å‡†å¤‡å°±ç»ªæ¢æµ‹*ã€‚

![](img/b5311930fdf057c863e1ecb9343af049.png)

Kubernetes:å°±ç»ªæ¢æµ‹å¤±è´¥

è®©æˆ‘ä»¬æ›´æ·±å…¥åœ°ç ”ç©¶ä¸‹é¢çš„ä¿é™©åº“ pod æ—¥å¿—ã€‚æ ¹æ®æˆ‘ä»¬çš„å¤±è´¥æ³¨å…¥ï¼Œè¿™ä¸ªè¯¦ç»†çš„é”™è¯¯æ¶ˆæ¯éå¸¸æœ‰æ„ä¹‰ã€‚å¦‚æœè¿™äº› KMS æƒé™è®¾ç½®ä¸æ­£ç¡®ï¼Œæ‚¨ä¹Ÿå¯èƒ½ä¼šåœ¨ POC è¿‡ç¨‹ä¸­çœ‹åˆ°ç±»ä¼¼çš„æ¶ˆæ¯ã€‚

```
2019-02-21T21:59:28.288Z [INFO]  core: stored unseal keys supported, attempting fetch2019-02-21T21:59:28.623Z [WARN]  failed to unseal core: error="fetching stored unseal keys failed: failed to decrypt encrypted stored keys: error decrypting data encryption key: AccessDeniedException: The ciphertext refers to a customer master key that does not exist, does not exist in this region, or you are not allowed to access.status code: 400, request id: 123456-123456-123456-123456"
```

è¿™æ—¶é¢†äº‹ UI ä¹Ÿç»™æˆ‘ä»¬å±•ç¤ºäº†åŒ¹é…ç»“æœã€‚åªæœ‰ä¸€ä¸ªä¿é™©èˆ±è¢«å¯†å°å¹¶å¤„äº*å¤‡ç”¨*æ¨¡å¼ã€‚å‰©ä¸‹çš„ä¸¤ä¸ªèˆ±ä»æœªå¯†å°ï¼Œç»§ç»­æä¾›äº¤é€šæœåŠ¡ã€‚Vault service ä»åœ¨è¿è¡Œï¼Œå¯¹æœ€ç»ˆç”¨æˆ·æ²¡æœ‰å½±å“ã€‚

![](img/05806cebff4cbf05183d435a9c59b5d6.png)

**å‰§é€**:ä¸€å¼€å§‹ï¼Œæˆ‘ä»¥ä¸ºè¿™æ˜¯å› ä¸ºå¦å¤–ä¸¤ä¸ªèˆ±å¯ä»¥å»ºç«‹æ³•å®šäººæ•°(2/3)å¹¶é€‰å‡ºä¸€ä¸ªé¦–é¢†ã€‚ç„¶è€Œï¼Œè¿™ä¸æ˜¯çœŸæ­£çš„åŸå› ã€‚æˆ‘å°†åœ¨ä¸‹ä¸€æ¬¡æµ‹è¯•ä¸­è§£é‡ŠåŸå› ã€‚

## å¤±è´¥æ³¨å°„æ¡ˆä¾‹ 3: KMS ä¸‹é™+ EC2 åœ¨ 2 AZs å†…ä¸‹é™

è®©æˆ‘ä»¬å†æ€æ­»ä¸€ä¸ªè±†èšè®©å®ƒé‡æ–°å¯åŠ¨ã€‚ä¸å‡ºæ‰€æ–™ï¼Œç°åœ¨æˆ‘ä»¬æœ‰ 2 ä¸ª*å¯†å°å¤‡ç”¨*ä¿é™©åº“åŠèˆ±ã€‚ç„¶è€Œï¼Œ **Vault service åœ¨è¿™ç§ä¸¥å³»çš„å½¢åŠ¿ä¸‹ä¾ç„¶å±¹ç«‹ä¸å€’**ã€‚è¿™å’ŒåŠ¨ç‰©å›­ç®¡ç†å‘˜è¿™ç§åŸºäºæ³•å®šäººæ•°çš„é¢†è¢–é€‰ä¸¾åˆ¶åº¦ä¸ä¸€æ ·å§ï¼Ÿè®©æˆ‘ä»¬ä»”ç»†çœ‹çœ‹ä¸‹é¢çš„é«˜å¯ç”¨æ€§å®šä¹‰ã€‚

***æç¤º*** *:è¿™ 3 ä¸ªè·³é©¬æ¨¡å¼åç§°æŒ‡çš„æ˜¯åŒä¸€ä¸ªæ¦‚å¿µï¼Œå¯ä»¥äº’æ¢ä½¿ç”¨:* ***ä¸»åŠ¨ã€ä¸»ã€é¢†å¯¼è€…ã€‚***

> ä¸ºäº†å®ç°é«˜å¯ç”¨æ€§ï¼Œ**Vault æœåŠ¡å™¨èŠ‚ç‚¹ä¹‹ä¸€åœ¨æ•°æ®å­˜å‚¨ä¸­è·å–ä¸€ä¸ªé”ã€‚æˆåŠŸçš„æœåŠ¡å™¨èŠ‚ç‚¹éšåæˆä¸ºæ´»åŠ¨èŠ‚ç‚¹**ï¼›æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹éƒ½æˆä¸ºå¤‡ç”¨èŠ‚ç‚¹ã€‚æ­¤æ—¶ï¼Œå¦‚æœå¤‡ç”¨èŠ‚ç‚¹æ”¶åˆ°è¯·æ±‚ï¼Œå®ƒä»¬å°†æ ¹æ®é›†ç¾¤çš„å½“å‰é…ç½®å’ŒçŠ¶æ€è½¬å‘è¯·æ±‚æˆ–é‡å®šå‘å®¢æˆ·ç«¯
> 
> **é«˜å¯ç”¨æ€§æ— æ³•æé«˜å¯æ‰©å±•æ€§ã€‚**ä¸€èˆ¬æ¥è¯´ï¼ŒVault çš„ç“¶é¢ˆæ˜¯æ•°æ®å­˜å‚¨æœ¬èº«ï¼Œè€Œä¸æ˜¯ Vault æ ¸å¿ƒã€‚ä¾‹å¦‚:ä¸ºäº†æé«˜ä½¿ç”¨ Consul çš„ Vault çš„å¯ä¼¸ç¼©æ€§ï¼Œé€šå¸¸åº”è¯¥æ‰©å±• Consul è€Œä¸æ˜¯ Vaultã€‚

ä»æˆ‘ä»¬çš„æµ‹è¯•ç»“æœæ¥çœ‹ï¼Œè¿™ä¸ªå‰©ä½™çš„æœªå¯†å°çš„*è·³é©¬åŠèˆ±å¾ˆå¿«å°±å–å¾—äº†é¢†å¯¼åœ°ä½ï¼Œå¹¶è‡ªå·±ä¸ºäº¤é€šæœåŠ¡ã€‚å¤–éƒ¨æµé‡æ²¡æœ‰ç»å†ä»»ä½•å­˜å‚¨åœæœºã€‚è¿™ä¸ä¸Šé¢çš„ vault HA è®¾è®¡ç›¸åŒ¹é…ã€‚ğŸ‘†*

***ç®€è€Œè¨€ä¹‹ï¼Œ*** ***é‡‘åº“é›†ç¾¤ä¸éœ€è¦å»ºç«‹æ³•å®šäººæ•°æ¥é€‰ä¸¾é¢†è¢–ã€‚æ— è®ºå“ªä¸ªå•å…ƒè·å¾—é”ï¼Œéƒ½å°†æˆä¸ºæ´»åŠ¨/ä¸»å•å…ƒã€‚***

## æ•…éšœæ³¨å…¥:ä¸€ä¸ªæç«¯çš„ä¾‹å­

åœ¨æˆ‘ä»¬å½“å‰çš„å•åŒºåŸŸ vault é›†ç¾¤è®¾ç½®ä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸€ä¸ªæ½œåœ¨çš„åœæ­¢æœåŠ¡ç¾éš¾åœºæ™¯å¯èƒ½æ˜¯:

*   AWS KMS ä¸‹é™äº†å¾ˆé•¿æ—¶é—´ã€‚
*   åŒæ—¶ï¼Œæˆ‘ä»¬å¤±å»äº† 3 ä¸ªä¸åŒå¯ç”¨æ€§åŒºåŸŸä¸­çš„æ‰€æœ‰ 3 ä¸ªä¿é™©å­˜å‚¨ç®±ã€‚
*   åŒæ—¶ï¼ŒConsul ç¾¤é›†(å…·æœ‰ 5 ä¸ªæœºæ¶çš„ HA)åœæ­¢è¿è¡Œï¼Œä»è€Œé˜»æ­¢äº† Vault Service çš„è¿è¡Œã€‚

![](img/21810363dff0c835ad81ce282f02c525.png)

å¦‚ä½ æ‰€çŸ¥ï¼Œå‘ç”Ÿè¿™ç§ç‰¹å®šç¾éš¾åœºæ™¯çš„æ¦‚ç‡éå¸¸ä½ã€‚ç„¶è€Œï¼Œæ„è¯†åˆ°æœ€åçš„æƒ…å†µå¹¶æœ‰åˆç†çš„é¢„æœŸæ€»æ˜¯è®©æˆ‘ä»¬æ„Ÿè§‰æ›´å¥½ã€‚

# å…¨å±€æ‰©å±• Vault

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»æ„å»ºäº†ä¸€ä¸ªå•åŒºåŸŸ HA Vault é›†ç¾¤ï¼Œå®ƒæ»¡è¶³äº†æˆ‘ä»¬å¯¹ kubernetes å‹å¥½ã€ä»£ç é©±åŠ¨å’Œè‡ªæˆ‘æ¢å¤çš„éœ€æ±‚ã€‚ä¸ºäº†æ›´è¿›ä¸€æ­¥ï¼Œè¿™é‡Œæœ‰ä¸€äº›é€‰æ‹©ã€‚

ä¸ºäº†ä½¿ Vault Cluster HA å¯è·¨å¤šä¸ªåŒºåŸŸæ‰©å±•ï¼ŒHashircorp æä¾›äº†ä¸€ä¸ªå¼€æºå·¥å…· [consul-replicate](https://github.com/hashicorp/consul-replicate) ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªå°†å€¼ä»ä¸€ä¸ªåŒºåŸŸå¤åˆ¶åˆ°å¦ä¸€ä¸ªåŒºåŸŸçš„è§£å†³æ–¹æ¡ˆã€‚ç›®å‰ï¼Œæˆ‘æ­£åœ¨åŸºäºæ­¤æ„å»ºä¸€ä¸ªå®šåˆ¶çš„å¤šåŒºåŸŸ HA/DR è‡ªåŠ¨åŒ–ã€‚å¸Œæœ›è¿™é¡¹å·¥ä½œèƒ½äº§ç”Ÿå¦ä¸€ç¯‡æ–‡ç« ã€‚

HashiCorp Vault Enterprise è¿˜é€šè¿‡æä¾›ä¸¤ç§å¤åˆ¶æ¨¡å¼è§£å†³äº†è¿™äº›é—®é¢˜:æ€§èƒ½(é«˜çº§è®¸å¯)å’Œç¾éš¾æ¢å¤(ä¸“ä¸šè®¸å¯)ã€‚å¦‚æœæœ‰å…´è¶£ï¼Œä½ å¯ä»¥ä»[è¿™é‡Œ](https://learn.hashicorp.com/vault/operations/ops-reference-architecture#deployment-topology-for-multiple-datacenters)æ‰¾åˆ°æ›´å¤šç»†èŠ‚ã€‚

![](img/bc8f37ab1d1e49656b7ac6b66639aebb.png)

å°±æ˜¯è¿™æ ·ã€‚æˆ‘å¸Œæœ›è¿™æ˜¯ä¿¡æ¯ï¼Œå¯ä»¥å¸®åŠ©æ‚¨äº†è§£ä¿é™©åº“è‡ªåŠ¨è§£å°åŠŸèƒ½åŠå…¶åœ¨æ•…éšœæœŸé—´çš„è¡Œä¸ºã€‚

åœ¨æˆ‘çš„ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†åˆ†äº«æˆ‘é€šè¿‡æ™®ç½—ç±³ä¿®æ–¯ä½¿ç”¨*é‡‘åº“ç›‘æ§çš„ç»éªŒï¼Œå› ä¸ºè‡ªæˆ‘æ¢å¤è®¾è®¡æ€»æ˜¯åœ¨è‰¯å¥½çš„ç›‘æ§å †æ ˆä¸‹å·¥ä½œå¾—æ›´å¥½ã€‚*

# å‚è€ƒ

[https://www.devsecops.org/](https://www.devsecops.org/)
[https://github.com/helm/charts/tree/master/incubator/vault](https://github.com/helm/charts/tree/master/incubator/vault)
[https://learn . hashi corp . com/vault/operations/ops-auto å¯å°-AWS-kms](https://learn.hashicorp.com/vault/operations/ops-autounseal-aws-kms)
[https://www . hashi corp . com/resources/vault-1-0-how-to-auto-å¯å°-new-features](https://www.hashicorp.com/resources/vault-1-0-how-to-auto-unseal-new-features)
[https://www . vault project . io/docs/configuration/seal/AWS kms . html](https://www.vaultproject.io/docs/configuration/seal/awskms.html)