# äº¤å‰ç¼–è¯‘ Rust ç¨‹åºä»¥åœ¨ Turris Omnia ä¸Šè¿è¡Œ

> åŸæ–‡ï¼š<https://itnext.io/cross-compile-rust-programs-to-run-on-turris-omnia-e592b555e2aa?source=collection_archive---------5----------------------->

![](img/0040febddbdaf4e10041a24e02adcfb3.png)

Rust é‡åˆ° Omniaã€‚Rust å¾½æ ‡å½’ Mozilla æ‰€æœ‰ï¼Œå¹¶åœ¨ 4.0 ç‰ˆçš„ CC ä¸‹è·å¾—è®¸å¯ã€‚

åœ¨æˆ‘ä¹‹å‰çš„[åšå®¢æ–‡ç« ](https://medium.com/@bajtos/how-to-run-unifi-controller-on-turris-omnia-f9c178594bff)ä¸­ï¼Œæˆ‘æè¿°äº†å¦‚ä½•ä½¿ç”¨ LXC å®¹å™¨åœ¨ Turris Omnia ä¸Šè¿è¡Œä»»æ„çš„ Ubuntu åŒ…ã€‚è™½ç„¶æ˜“äºé…ç½®ï¼Œä½†æˆ‘å‘ç°è¿™æ ·çš„è®¾ç½®ç›¸å½“æµªè´¹ã€‚æˆ‘ä¸æƒ³åœ¨æˆ‘çš„è·¯ç”±å™¨ä¸Šè¿è¡Œå¦ä¸€ä¸ªå®Œæ•´çš„ Linux å‘è¡Œç‰ˆæ¥è¿è¡Œå°å‹(å®¶åº­)è‡ªåŠ¨åŒ–ç¨‹åºã€‚

æˆ‘ä»¬è¿˜æœ‰å…¶ä»–é€‰æ‹©å—ï¼Ÿ

*   ç”¨ Python å†™ç¨‹åºã€‚Turris OS é™„å¸¦äº† Python 2.7 ç‰ˆæœ¬ï¼Œè®¸å¤šç®¡ç†å·¥å…·ä¹Ÿæ˜¯ç”¨ Python ç¼–å†™çš„ã€‚ç„¶è€Œï¼Œæˆ‘ä»æœªçˆ±ä¸Š Pythonï¼Œè€Œä¸”å®ƒæ˜¯ä¸€ç§å¸¦æœ‰åƒåœ¾æ”¶é›†å™¨çš„é«˜çº§è§£é‡Šè¯­è¨€â€”â€”ä¹Ÿä¸æ˜¯æœ€æœ‰æ•ˆçš„é€‰æ‹©ğŸ¤·â€â™‚ï¸
*   ä½¿ç”¨ C æˆ– C++ç­‰ä½çº§è¯­è¨€ï¼Œå¹¶ä¸º Turris äº¤å‰ç¼–è¯‘ç¨‹åºã€‚äº‹å®è¯æ˜ï¼Œäº¤å‰ç¼–è¯‘å¾ˆå®¹æ˜“è®¾ç½®ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨æœ€ä½çš„å†…å­˜ä½¿ç”¨è·å¾—æœ€ä½³æ€§èƒ½ã€‚ä½†æ˜¯ï¼Œåªè¦æˆ‘ä»¬ä¸å¼•å…¥å†…å­˜æ³„æ¼ï¼Œæˆ–è€…åœ¨è®¿é—®å·²ç»é‡Šæ”¾å›æ¥çš„å†…å­˜æ—¶ä½¿è¿›ç¨‹å´©æºƒğŸ™ˆ(æ›´ä¸ç”¨è¯´å®‰è£…ç¬¬ä¸‰æ–¹ä¾èµ–é¡¹çš„å¤æ‚æ€§äº†ï¼Œå› ä¸º C/C++æ²¡æœ‰åŒ…ç®¡ç†å™¨ã€‚)
*   ä½¿ç”¨ [Rust](https://www.rust-lang.org/) æ¥è·å¾—ä¸¤ä¸ªä¸–ç•Œçš„æœ€ä½³æ•ˆæœ:åƒ Python è¿™æ ·çš„é«˜çº§è¯­è¨€çš„ç”Ÿäº§åŠ›å’Œå¯é æ€§ä»¥åŠåƒ C è¿™æ ·çš„ä½çº§è¯­è¨€çš„æ€§èƒ½ğŸ’ª

æˆ‘ä»¬æ¥çœ‹çœ‹é”ˆé“ã€‚è¦åœ¨ Turris ä¸Šè¿è¡Œ Rust ç¨‹åºï¼Œæˆ‘ä»¬éœ€è¦:

1.  æ‰¾åˆ°è·¯ç”±å™¨ç¡¬ä»¶ä½¿ç”¨çš„å¹³å°ï¼Œè¿™å°†æ˜¯äº¤å‰ç¼–è¯‘çš„ç›®æ ‡ã€‚
2.  å®‰è£…äº¤å‰ç¼–è¯‘æ„å»ºå·¥å…·ï¼ŒéªŒè¯æˆ‘ä»¬å¯ä»¥äº¤å‰ç¼–è¯‘ä¸€ä¸ªç®€å•çš„ C ç¨‹åºï¼Œå¹¶åœ¨è·¯ç”±å™¨ä¸Šè¿è¡Œã€‚
3.  å®‰è£… Rust å¹¶è®¾ç½®äº¤å‰ç¼–è¯‘ï¼ŒéªŒè¯æˆ‘ä»¬å¯ä»¥äº¤å‰ç¼–è¯‘ä¸€ä¸ªç®€å•çš„ Rust ç¨‹åºå¹¶åœ¨è·¯ç”±å™¨ä¸Šè¿è¡Œå®ƒã€‚

*æ³¨æ„:ä»¥ä¸‹è¯´æ˜é€‚ç”¨äº Ubuntu 18.04 LTS ç‰ˆã€‚æˆ‘æ­£åœ¨ä½¿ç”¨*[*Linux çš„ Windows å­ç³»ç»Ÿ*](https://docs.microsoft.com/en-us/windows/wsl/install-win10) *åœ¨æˆ‘çš„ Windows æœºå™¨ä¸Šè¿è¡Œ Ubuntuã€‚*

# æ‰¾åˆ°ç›®æ ‡å¹³å°ğŸ•µï¸â€â™‚ï¸

äº¤å‰ç¼–è¯‘ç›®æ ‡é€šå¸¸è¡¨ç¤ºä¸ºä»¥ä¸‹æ ¼å¼çš„ä¸‰å…ƒç»„:

```
{architecture}-{vendor}-{system}-{abi}
```

æˆ‘ä»¬å·²ç»çŸ¥é“ Turris Omnia çš„å¤„ç†å™¨æœ‰ ARMv7 æ¶æ„ã€‚å¯¹äº Linux ç³»ç»Ÿï¼Œä¾›åº”å•†é€šå¸¸æ˜¯`unknown`,å› ä¸ºå“ªä¸ªä¾›åº”å•†åˆ›å»ºäº†å‘è¡Œç‰ˆå¹¶ä¸é‡è¦ã€‚æœ€åç¼ºå¤±çš„éƒ¨åˆ†æ˜¯ä»€ä¹ˆ ABI(åº”ç”¨äºŒè¿›åˆ¶æ¥å£)æ˜¯ Turris æ“ä½œç³»ç»Ÿä½¿ç”¨ï¼Ÿåœ¨ Linux ä¸Šï¼Œè¿™æŒ‡çš„æ˜¯ libc å®ç°ï¼Œæ‚¨å¯ä»¥é€šè¿‡`ldd --version.`æ‰¾åˆ°å®ƒ

```
$ ssh root@192.168.1.1 "ldd --version"
musl libc (armhf)
Version 1.1.19
Dynamic Program Loader
Usage: ldd [options] [--] pathname
```

Turris Omnia çš„ä¸‰é‡ç›®æ ‡æ˜¯`armv7-unknown-linux-musleabihf`ï¼Œå¯¹æˆ‘ä»¬æ¥è¯´å¹¸è¿çš„æ˜¯ï¼Œè¿™ä¸ªç›®æ ‡å¾—åˆ°äº† Rust ä½œä¸º[äºŒçº§å¹³å°](https://forge.rust-lang.org/release/platform-support.html#tier-2)çš„æ”¯æŒ:

> ç¬¬äºŒå±‚å¹³å°å¯ä»¥è¢«è®¤ä¸ºæ˜¯â€œä¿è¯è¦å»ºé€ çš„â€ã€‚è‡ªåŠ¨åŒ–æµ‹è¯•æ²¡æœ‰è¿è¡Œï¼Œæ‰€ä»¥ä¸èƒ½ä¿è¯äº§ç”Ÿä¸€ä¸ªå·¥ä½œçš„æ„å»ºï¼Œä½†æ˜¯å¹³å°é€šå¸¸å·¥ä½œå¾—å¾ˆå¥½ï¼Œè¡¥ä¸æ€»æ˜¯å—æ¬¢è¿çš„ï¼

# è®¾ç½® c äº¤å‰ç¼–è¯‘å™¨âš™

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè®©æˆ‘ä»¬ç¡®ä¿å®‰è£…äº†å¸¸è§„çš„æ„å»ºå·¥å…·ã€‚

```
$ sudo apt-get install build-essential
```

ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬çš„ç›®æ ‡æ˜¯`gnueabihf`è€Œä¸æ˜¯`musleabihf`ï¼Œæˆ‘ä»¬çš„ä»»åŠ¡ä¼šç®€å•å¾—å¤šï¼Œå› ä¸º Ubuntu ä¸º`gnueabihf`ç›®æ ‡æä¾›äº†å¸¦æœ‰äº¤å‰ç¼–è¯‘å·¥å…·é“¾çš„åŒ…ã€‚ [MUSL](https://www.musl-libc.org/) å¯¹æˆ‘æ¥è¯´æœ‰ç‚¹ç¥ç§˜ï¼Œæˆ‘å¯¹è¿™ç§é£æ ¼çš„æ ‡å‡† C åº“å‡ ä¹ä¸€æ— æ‰€çŸ¥ã€‚

å¹¸è¿çš„æ˜¯ï¼Œæœ‰ä¸€ä¸ªåä¸º [musl-cross-make](https://github.com/richfelker/musl-cross-make) çš„é¡¹ç›®æä¾›äº†ä¸€ä¸ª*â€œåŸºäº makefile çš„ musl cross compiler çš„ç®€å•æ„å»ºâ€*,å¹¶ä¸”å®ƒéå¸¸æœ‰æ•ˆï¼é¦–å…ˆä» GitHub ä¸‹è½½æºä»£ç :

```
$ wget https://github.com/richfelker/musl-cross-make/archive/master.tar.gz
$ tar xzf master.tar.gz
$ cd musl-cross-make-master
```

åœ¨å¼€å§‹æ„å»ºä¹‹å‰ï¼Œè®©æˆ‘ä»¬è°ƒæ•´ä¸€äº›é…ç½®é€‰é¡¹ã€‚å°†é…ç½®æ¨¡æ¿æ–‡ä»¶`config.mak.dist`å¤åˆ¶åˆ°`config.mak`ï¼Œè®¾ç½®ä»¥ä¸‹é€‰é¡¹(å¯ä»¥å–æ¶ˆæ¨¡æ¿æä¾›çš„ç›¸å…³è¡Œçš„æ³¨é‡Š):

```
TARGET=arm-linux-musleabihf
OUTPUT=/usr/local
MUSL_VER = 1.1.19
```

(æœ€å¥½åœ¨ä½ çš„ Turris ä¸Šä½¿ç”¨ä¸`ldd --version`æŠ¥é“çš„ç›¸åŒçš„ MUSL ç‰ˆæœ¬ã€‚æˆ‘çš„æ˜¯`1.1.19`å†™çš„æ—¶å€™ã€‚)

å»ºé€ æ—¶é—´ï¼

```
$ make
$ make install
```

ç°åœ¨ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨`/usr/local`ä¸­å®‰è£…å¥½æ‰€æœ‰å·¥å…·ï¼Œå› æ­¤åœ¨`PATH`ä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚è®©æˆ‘ä»¬è¿è¡Œ gcc æ¥éªŒè¯:

```
$ arm-linux-musleabihf-gcc --version
arm-linux-musleabihf-gcc (GCC) 9.2.0
Copyright (C) 2019 Free Software Foundation, Inc.
(...)
```

# äº¤å‰ç¼–è¯‘ C ç¨‹åºğŸŒ

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªä¸ Turris å¹³å°åŒ¹é…çš„ç›®æ ‡ä¸‰è”ä½“çš„å‡è®¾ã€‚ç°åœ¨æ˜¯æ—¶å€™åœ¨å®è·µä¸­éªŒè¯æˆ‘ä»¬çš„å‡è®¾äº†ã€‚

ç”¨ C ç¼–å†™ä¸€ä¸ªç®€å•çš„â€œHello worldâ€ç¨‹åºâ€”â€”å°†ä¸‹é¢çš„ä»£ç ä¿å­˜åˆ°ä¸€ä¸ªåä¸º`hello.c`çš„æ–‡ä»¶ä¸­:

```
#include <stdio.h>
int main() {
   printf("Hello, World!\n");
   return 0;
}
```

ä¸º Turris äº¤å‰ç¼–è¯‘è¿™ä¸ªç¨‹åº:

```
arm-linux-musleabihf-gcc hello.c -o hello
```

å°†ç¨‹åºä¸Šä¼ åˆ°è·¯ç”±å™¨å¹¶åœ¨é‚£é‡Œæ‰§è¡Œã€‚æˆ‘å°†æ–‡ä»¶å­˜å‚¨åœ¨`/srv`ä¸­ï¼Œå®ƒç”± mSATA SSD é©±åŠ¨å™¨æ”¯æŒï¼Œä»¥é¿å…å¯¹å†…éƒ¨é—ªå­˜è¿›è¡Œä¸å¿…è¦çš„å†™å…¥ã€‚å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œä½ ä¼šå¾—åˆ°ç†Ÿæ‚‰çš„é—®å€™ã€‚

```
$ scp hello root@192.168.1.1:/srv
hello                                 100% 7292     1.6MB/s   00:00
$ ssh root@192.168.1.1 /srv/hello
Hello, World!
```

# å®‰è£… Rust å¹¶è®¾ç½®äº¤å‰ç¼–è¯‘ğŸ

å®‰è£… Rust æœ‰ä¸åŒçš„æ–¹æ³•ï¼Œæˆ‘å†³å®šä½¿ç”¨åŸºäº`rustup`çš„æ¨èæ–¹æ³•ã€‚

```
$ curl https://sh.rustup.rs -sSf | sh
```

æˆ‘ä»¬è¿˜éœ€è¦ä¸ºæˆ‘ä»¬çš„ç›®æ ‡å¹³å°å®‰è£…äº¤å‰ç¼–è¯‘çš„æ ‡å‡†æ¿æ¡ç®±(Rust core æ¨¡å—)ã€‚

```
$ rustup target add armv7-unknown-linux-musleabihf
```

æœ€åä¸€æ­¥ï¼Œæˆ‘ä»¬å‘Šè¯‰ Rust ç¼–è¯‘å™¨åœ¨ä¸ºæˆ‘ä»¬çš„ç›®æ ‡å¹³å°ç¼–è¯‘æ—¶ä½¿ç”¨å“ªä¸ªé“¾æ¥å™¨ã€‚å°†ä»¥ä¸‹éƒ¨åˆ†æ·»åŠ åˆ°`~/.cargo/config`:

```
[target.armv7-unknown-linux-musleabihf]
linker = "arm-linux-musleabihf-gcc"
```

# äº¤å‰ç¼–è¯‘ Rust ç¨‹åºğŸ‰

åœ¨ Rust ä¸­åˆ›å»ºä¸€ä¸ªâ€œHello worldâ€ç¨‹åºå¹¶ç¼–è¯‘å®ƒ:

```
$ cargo new --bin hello
$ cd hello
$ cargo build --target=armv7-unknown-linux-musleabihf
   Compiling hello v0.1.0 (/home/bajtos/src/hello)
    Finished dev [unoptimized + debuginfo] target(s) in 2.53s
```

å°†ç¨‹åºä¸Šä¼ åˆ°è·¯ç”±å™¨å¹¶åœ¨é‚£é‡Œæ‰§è¡Œã€‚å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œä½ åº”è¯¥ä¼šå†æ¬¡æ”¶åˆ°åŒæ ·çš„é—®å€™ã€‚

```
$ scp target/armv7-unknown-linux-musleabihf/debug/hello root@192.168.1.1:/srv
hello                                  100% 2903KB  10.8MB/s   00:00 $ ssh root@129.168.1.1 /srv/hello
Hello, World!
```

æ­å–œä½ ï¼Œç°åœ¨ä½ å¯ä»¥åœ¨ä½ çš„ Turris Omnia è·¯ç”±å™¨ä¸Šè¿è¡Œä»»ä½• Rust ç¨‹åºäº†ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ä¹³é½¿è±¡å’Œ Twitterï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¹³é½¿è±¡-twitter-sync åœ¨è¿™ä¸¤ä¸ªç½‘ç»œä¹‹é—´åŒæ­¥æ‚¨çš„å¸–å­:

[](https://github.com/klausi/mastodon-twitter-sync/) [## å…‹åŠ³æ–¯/ä¹³é½¿è±¡-æ¨ç‰¹-åŒæ­¥

### è¿™ä¸ªå·¥å…·å¯ä»¥åŒæ­¥ä¹³é½¿è±¡å’Œ Twitter ä¹‹é—´çš„å¸–å­ã€‚ä¸ç®¡ä½ æŠŠä½ çš„ä¸œè¥¿è´´åœ¨å“ªé‡Œï¼Œå®ƒéƒ½ä¼šâ€¦

github.com](https://github.com/klausi/mastodon-twitter-sync/) 

# å­¦åˆ†å’Œå‚è€ƒğŸ™‡â€â™‚ï¸

è¿™ç¯‡åšæ–‡ä¸­çš„å¾ˆå¤šä¿¡æ¯éƒ½æ˜¯åŸºäºä¸‹é¢è¿™ç¯‡å…³äºäº¤å‰ç¼–è¯‘ Rust ç¨‹åºçš„å¾ˆæ£’çš„æŒ‡å—ã€‚è°¢è°¢ï¼Œ[è±ªå°”èµ«Â·é˜¿å¸•é‡Œè¥¿å¥¥](https://github.com/japaric)ï¼

[](https://github.com/japaric/rust-cross/blob/master/README.md) [## æ—¥æœ¬/é”ˆåå­—

### å…³äºäº¤å‰ç¼–è¯‘ Rust ç¨‹åºä½ éœ€è¦çŸ¥é“çš„ä¸€åˆ‡ï¼å¦‚æœä½ æƒ³æŠŠä½ çš„ç”Ÿé”ˆå·¥å…·é“¾è®¾ç½®æˆåå­—â€¦

github.com](https://github.com/japaric/rust-cross/blob/master/README.md) 

Rust æ”¯æŒçš„å¹³å°åˆ—è¡¨å¯ä»¥åœ¨ä»¥ä¸‹å®˜æ–¹é¡¹ç›®æ–‡æ¡£ä¸­æ‰¾åˆ°:

 [## é˜²é”ˆå¹³å°æ”¯æ¶

### Rust ç¼–è¯‘å™¨å¯ä»¥åœ¨å¾ˆå¤šå¹³å°ä¸Šè¿è¡Œå¹¶ç¼–è¯‘ï¼Œå°½ç®¡ä¸æ˜¯æ‰€æœ‰çš„å¹³å°éƒ½ä¸€æ ·â€¦

forge.rust-lang.org](https://forge.rust-lang.org/release/platform-support.html) 

æœ€åï¼Œå¦‚æœæ²¡æœ‰é‡Œå¥‡Â·è´¹å°”å…‹å‡ºè‰²çš„ musl-cross-make é¡¹ç›®ï¼Œæˆ‘è¦èŠ±å¾ˆé•¿æ—¶é—´æ‰èƒ½å¼„æ¸…æ¥šå¦‚ä½•ä¸º MUSLÂ·ABI è¿›è¡Œäº¤å‰ç¼–è¯‘ã€‚

[](https://github.com/richfelker/musl-cross-make) [## richfelker/musl-cross-make

### è¿™æ˜¯ç¬¬äºŒä»£ musl-cross-makeï¼Œä¸€ç§å¿«é€Ÿã€ç®€å•ä½†å…ˆè¿›çš„åŸºäº makefile çš„åˆ¶ä½œæ–¹æ³•â€¦

github.com](https://github.com/richfelker/musl-cross-make) 

# é™„è¨€

ä½ æœ‰æ²¡æœ‰æ³¨æ„åˆ°æˆ‘ä»¬çš„ C ç¨‹åºæœ‰ 7kBï¼Œè€Œ Rust ç‰ˆæœ¬æœ‰ 2903kBï¼Ÿæœ‰å‡ ä¸ªçªé—¨å¯ä»¥å‡å°‘ Rust ç¨‹åºçš„å¯æ‰§è¡Œå¤§å°ã€‚é€šè¿‡å¯ç”¨é“¾æ¥æ—¶é—´ä¼˜åŒ–ï¼Œæˆ‘èƒ½å¤Ÿå°†å‘å¸ƒç‰ˆæœ¬çš„å¤§å°å¿«é€Ÿå‡å°‘åˆ° 1408kBã€‚æ‚¨å¯ä»¥åœ¨*â€œæœ€å°åŒ– Rust äºŒè¿›åˆ¶å¤§å°â€*ä¸­äº†è§£æ›´å¤šé«˜çº§æŠ€æœ¯:

 [## çº¦ç¿°å“ˆæ ¹/æœ€å°å°ºå¯¸-é“é”ˆ

### è¿™ä¸ªåº“æ¼”ç¤ºäº†å¦‚ä½•æœ€å°åŒ– Rust äºŒè¿›åˆ¶æ–‡ä»¶çš„å¤§å°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒRust ä¼šä¼˜åŒ–â€¦

github.com](https://github.com/johnthagen/min-sized-rust)