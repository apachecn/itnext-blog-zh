# å¤´ç›”æ˜¯ä¸å¤Ÿçš„ï¼Œä½ è¿˜éœ€è¦ Kustomize

> åŸæ–‡ï¼š<https://itnext.io/helm-is-not-enough-you-also-need-kustomize-82bae896816e?source=collection_archive---------0----------------------->

## è‡ªå®šä¹‰ YAML ä»¥å®æ–½æ¥è‡ªåº”ç”¨ç¨‹åºæ“ä½œå‘˜ã€å®‰å…¨æ“ä½œå‘˜å’Œç¾¤é›†æ“ä½œå‘˜çš„ç­–ç•¥ã€‚âœŠ

![](img/346016364dfa9ec3208f55b0d4091a7c.png)

Kubernetes è®©æˆ‘ä»¬å£°æ˜æ€§åœ°æŒ‡å®šæˆ‘ä»¬çš„æ„å›¾ï¼Œå³åº”ç”¨ç¨‹åºåº”è¯¥å¦‚ä½•é€šè¿‡ YAML éƒ¨ç½²åœ¨åº•å±‚åŸºç¡€è®¾æ–½ä¸­ã€‚è¿™äº› YAML å°†åŒ…å«åº”ç”¨ç¨‹åºå®šä¹‰ã€æ²»ç†æ‰€éœ€çš„æ ‡ç­¾ã€æ—¥å¿—è®°å½•ç­‰æ¨ªåˆ‡å…³æ³¨ç‚¹æ‰€éœ€çš„æ ‡ç­¾ã€åº”ç”¨ç¨‹åºå®‰å…¨ä¸Šä¸‹æ–‡å®šä¹‰ã€åº”ç”¨ç¨‹åºèµ„æºä¾èµ–æ€§ç­‰ã€‚å½“æˆ‘ä»¬å¼€å§‹å°†æˆ‘ä»¬çš„ Kubernetes æ‰©å±•åˆ°æ•°åä¸ªæˆ–æ•°ç™¾ä¸ª pod æ—¶ï¼Œç®¡ç†æ‰€æœ‰ YAML å°†æˆä¸ºä¸€åœºå™©æ¢¦ã€‚

ä¸ºäº†ä¾¿äºç†è§£ï¼Œè¿™äº›å£°æ˜æ€§é…ç½®å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªä¸»è¦ç±»åˆ«

1.  åº”ç”¨ç¨‹åºæ‰“åŒ…
2.  åº”ç”¨ç¨‹åºé…ç½®
3.  è¿è¡Œæ—¶é…ç½®

![](img/66badfdf61862b8024ebc7797d0d0167.png)

éš¾é“èµ«å°”å§†ä¸èƒ½è½»æ¾åœ°å¸®æˆ‘ä»¬åšåˆ°è¿™ä¸€ç‚¹å—ï¼Ÿæˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦æ–°å·¥å…·ï¼Ÿæ–°å·¥å…·èƒ½å¸¦æ¥ä»€ä¹ˆï¼ŸHelm å’Œ Kustomize å¦‚ä½•ä¸€èµ·å®ç°ä¸€äº›å¼ºå¤§çš„ç”¨ä¾‹ï¼Ÿè®©æˆ‘ä»¬åœ¨è¿™ç¯‡åšå®¢ä¸­å°è¯•å›ç­”æ‰€æœ‰è¿™äº›é—®é¢˜ã€‚

![](img/44884a7994db8e53483971caeba47b52.png)

## ä»€ä¹ˆèˆµå¥½ä¸å¥½ï¼Ÿ

é¦–å…ˆï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ° Kubernetes ä¸­æ‰€éœ€çš„ä¸åŒæŠ€æœ¯èƒ½åŠ›ã€‚

***åº”ç”¨æ‰“åŒ…&æè¿°***

> å¸®åŠ©æˆ‘ä»¬æè¿°åº”ç”¨ç¨‹åºå¹¶å°†ç›¸å…³èµ„æºæ‰“åŒ…åœ¨ä¸€èµ·çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼Œ1)åº”ç”¨ç¨‹åºå…ƒæ•°æ®å®šä¹‰ï¼Œå¦‚èµ„æºçº¦æŸï¼Œ2)å°†é…ç½®å’ŒæœåŠ¡æ‰“åŒ…åœ¨ä¸€èµ·

***ä¾èµ–å…³ç³»ç®¡ç†***

> è¯¥åŠŸèƒ½å°†å¸®åŠ©æˆ‘ä»¬å®šä¹‰ä¾èµ–æ€§ï¼Œä¾‹å¦‚ï¼Œåœ¨éƒ¨ç½² pod èµ„æºä¹‹å‰éƒ¨ç½²é…ç½®èµ„æºã€‚

***åº”ç”¨å‘ç°&ä»ªè¡¨ç›˜***

> è¯¥åŠŸèƒ½å°†å¸®åŠ©æˆ‘ä»¬å‘ç°éƒ¨ç½²åœ¨é›†ç¾¤ä¸­çš„åº”ç”¨ç¨‹åºï¼Œä»¥åŠå®ƒä»¬çš„éƒ¨ç½²å†å²ã€ä¾èµ–å…³ç³»ç­‰ã€‚,

***ç”Ÿå‘½å‘¨æœŸç®¡ç†***

> è¯¥åŠŸèƒ½å°†å¸®åŠ©æˆ‘ä»¬æ‰§è¡Œä¸åŒçš„åº”ç”¨ç¨‹åºéƒ¨ç½²ç­–ç•¥ï¼Œå¦‚é¦–æ¬¡å±•ç¤ºã€å›æ»šã€è“ç»¿è‰²éƒ¨ç½²ã€‚

**åº”ç”¨æè¿°å®šåˆ¶**

> è¯¥åŠŸèƒ½å°†å¸®åŠ©æˆ‘ä»¬å°†åº”ç”¨/å®‰å…¨/é›†ç¾¤æ ‡è®°æ·»åŠ åˆ° YAML ä¸­ï¼Œä»¥è§£å†³æ²»ç†/å®‰å…¨/è·¨é¢†åŸŸé—®é¢˜

Helm å¯ä»¥å¾ˆå¥½åœ°å®Œæˆæ‰€æœ‰è¿™äº›å·¥ä½œï¼Œä½†å¯¹äºâ€œ*åº”ç”¨æè¿°å®šåˆ¶*â€ç±»åˆ«ä¸‹çš„ç”¨ä¾‹æ¥è¯´ï¼Œå®ƒä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å·¥å…·ã€‚è®©æˆ‘ä»¬çœ‹ä¸€äº›åšå®çš„ä¾‹å­æ¥ç†è§£è¿™ä¸€ç‚¹ã€‚

**æ¡ˆä¾‹ 1:ç»´æŠ¤æˆæœ¬â€”â€”Git Fork æˆ– Copy**

å‡è®¾æˆ‘ä»¬ä½¿ç”¨ Nginx helm charts å°† Nginx WAF éƒ¨ç½²åˆ°æˆ‘ä»¬çš„é›†ç¾¤ä¸­ã€‚ä½œä¸ºäº§å“å›¢é˜Ÿéœ€æ±‚çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬åº”è¯¥æ·»åŠ ä¸€ä¸ªæ³¨é‡Šæ¥æŒ‡å®šè´Ÿè´£éƒ¨ç½²çš„å›¢é˜Ÿåç§°ã€‚æˆ‘ä»¬ä¸èƒ½å¯¹ä¸»è¦çš„ Nginx git åº“è¿›è¡Œä¿®æ”¹ï¼Œå› ä¸ºå®ƒåªä¸æˆ‘ä»¬ç»„ç»‡ä¸­çš„åº”ç”¨*æ“ä½œæ²»ç†ç­–ç•¥ç›¸å…³ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬åº”è¯¥ä» Nginx å­˜å‚¨åº“ä¸­æ´¾ç”Ÿæˆ–å¤åˆ¶å›¾è¡¨æ¨¡æ¿ï¼Œå¹¶æ ¹æ®æˆ‘ä»¬çš„å®šåˆ¶éœ€æ±‚å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚ç»´æŠ¤åˆ†æ”¯/å‰¯æœ¬çš„æˆæœ¬å¾ˆé«˜ã€‚Kustomize èƒ½å¸®ä¸Šå¿™ã€‚*

**æ¡ˆä¾‹ 2:æ³„æ¼çš„æŠ½è±¡**

å‡è®¾æˆ‘ä»¬æœ‰ä¸€äº›ç½‘ç»œç­–ç•¥è¦åº”ç”¨äºä¸€ç»„ podã€‚å®‰å…¨æ“ä½œå‘˜å¸Œæœ›å°†æ ‡ç­¾æ·»åŠ åˆ°æ‰€æœ‰ç›¸å…³çš„ podï¼Œç„¶åä»–å¯ä»¥å°†ç½‘ç»œç­–ç•¥èµ„æºæ·»åŠ åˆ°å…·æœ‰ç»™å®šæ ‡ç­¾çš„æ‰€æœ‰ podã€‚æŒ‰ç…§ä¼ ç»Ÿçš„æŒèˆµæ–¹å¼ï¼Œæˆ‘ä»¬åº”è¯¥å°†æ ‡ç­¾æ·»åŠ åˆ°å¼€å‘äººå‘˜å·¥ä½œçš„å›¾è¡¨æ¨¡æ¿ä¸­ã€‚å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬å°†å®‰å…¨å£°æ˜æ€§æ ‡ç­¾æ³„éœ²ç»™äº†åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜ã€‚

**æ¡ˆä¾‹ 3:ä¸åŒæ¨ªåˆ‡å…³æ³¨ç‚¹ä¹‹é—´çš„è€¦åˆ**

åœ¨ Kubernetes èµ„æº YAML ä¸Šï¼Œæœ‰å…³äºåº”ç”¨ç¨‹åºå¼€å‘äººå‘˜ã€åº”ç”¨ç¨‹åºæ“ä½œäººå‘˜ã€å®‰å…¨æ“ä½œäººå‘˜å’Œé›†ç¾¤æ“ä½œäººå‘˜çš„å£°æ˜æ€§æ ‡ç­¾ã€‚åº”ç”¨ã€å®‰å…¨å’Œé›†ç¾¤è¿è¥å•†çš„å…³æ³¨æœ¬è´¨ä¸Šæ˜¯äº¤å‰çš„ã€‚è€¦åˆæ‰€æœ‰è¿™äº›é—®é¢˜ä¼šé˜»ç¢å›¢é˜Ÿçš„æ•æ·æ€§ã€‚

**æ¡ˆä¾‹ 4:åœ¨è¿ç»­éƒ¨ç½²ç®¡é“ä¸­åº”ç”¨è¡¥ä¸**

å‡è®¾ Nginx pod ä¸­å­˜åœ¨ä¸€ä¸ªå®‰å…¨æ¼æ´ï¼Œå®‰å…¨å›¢é˜Ÿæ­£åœ¨å¯»æ‰¾ä¸€ç§æ–¹æ³•æ¥æ‹¦æˆªæ‰€æœ‰æŒç»­éƒ¨ç½²ç®¡é“ï¼Œå¹¶ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬æ›´æ–° Nginx æ˜ åƒç‰ˆæœ¬ã€‚Kustomize åœ¨è¿™ç§æƒ…å†µä¸‹ä¼šå·¥ä½œå¾—å¾ˆå¥½ã€‚

> è¿™æ˜¯ Kustomize çš„æœ€ä½³ä½ç½®ã€‚è¿™æœ‰åŠ©äºæˆ‘ä»¬å®šåˆ¶ YAML çš„æ–‡ä»¶ï¼Œè€Œä¸å½±å“ YAML çš„åŸä½œã€‚Kustomize æ˜¯ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œ CLI å·¥å…·ï¼Œå¯ä»¥æ·»åŠ åˆ°ä»»ä½•æŒç»­éƒ¨ç½²/é›†æˆå·¥ä½œæµä¸­ï¼Œç”šè‡³å¯ä»¥æ ¹æ®éœ€è¦ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„å·¥å…·

ä¸‹å›¾å¯ä»¥ç»™æˆ‘ä»¬ä¸€ä¸ªé«˜å±‚æ¬¡çš„è§†è§’ï¼Œè®©æˆ‘ä»¬äº†è§£ Helm å’Œ Kustomize å¦‚ä½•åˆä½œæ¥åˆ›å»ºä¸€äº›å¼ºå¤§çš„å·¥ä½œæµã€‚

![](img/5cbf14ff95f2a01e4c415984e2ae6dba.png)

## Kustomize æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

éå¸¸ç®€å•çš„ä¸‰ä¸ªæ­¥éª¤

*   å°†â€œkustomization.yamlâ€æ·»åŠ åˆ°æˆ‘ä»¬å¸Œæœ›å®šåˆ¶çš„ yaml ä¸­
*   åœ¨ YAML ä¸­å®šä¹‰æ‚¨çš„è‡ªå®šä¹‰
*   ç„¶åè¿è¡Œâ€œkustomize buildâ€

ç°åœ¨ï¼Œkustomization.yaml çš„å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼Œçœ‹çœ‹ç›¸å…³çš„â€œkustomization.yamlâ€

**ä¾‹ 1** :æˆ‘ä»¬æœ‰ä¸€ä¸ªç”±è´­ç‰©è½¦å›¢é˜Ÿéƒ¨ç½²çš„ podï¼Œä¾›ç§»åŠ¨åº”ç”¨å›¢é˜Ÿä½¿ç”¨ã€‚æ­¤å¤–ï¼Œå®‰å…¨å›¢é˜Ÿè¦æ±‚å°†ç§»åŠ¨åº”ç”¨å›¢é˜Ÿä½¿ç”¨çš„æ‰€æœ‰æœåŠ¡ä¿å­˜åœ¨â€œåç«¯å¯¹å‰ç«¯â€çš„åç§°ç©ºé—´ä¸­ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œåº”ç”¨ç¨‹åºæ“ä½œè€…æœ‰ä¸€ä¸ªæ¨ªåˆ‡æ ‡ç­¾ï¼Œå…¶ä¸­åŒ…æ‹¬ç”¨äºåˆ†å¸ƒå¼è·Ÿè¸ªçš„å›¢é˜Ÿåç§°ã€‚ä¸Šä¾‹ä¸­çš„â€œkustomization.yamlâ€å¦‚ä¸‹æ‰€ç¤º

åŠèˆ± YAML

![](img/e1f06a98c38d4474c6f7f9cd5e2cc397.png)

YAML çš„ kustomization

![](img/144a55b0e67a31d48d8529fb1c9c475a.png)

è¿è¡Œâ€œkustomize buildâ€çš„è¾“å‡º

![](img/444ec74dbcfb265e7faf7d868b7c640d.png)

å¦‚æœæ‚¨æƒ³ç›´æ¥å®‰è£…åˆ°æ‚¨çš„ kubernetes é›†ç¾¤ä¸­ï¼Œè¯·ä½¿ç”¨

> kustomize build | kubectl apply -f -

![](img/480ec21a383170cc9ca2c767f82e72b5.png)

## èµ«å°”å§†Â·â•Â·åº“ä»€æ‰˜ç±³æ³½

åŒæ—¶ä½¿ç”¨ helm å’Œ kustomize æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ä¸‰æ­¥è¿‡ç¨‹ã€‚è®©æˆ‘ä»¬è¿™æ ·å®‰è£… MariaDBã€‚

å°†å€¼æ–‡ä»¶è¦†ç›–åˆ° mariadb.yaml åï¼Œä¿å­˜ä¸€ä¸ª helm æ¨¡æ¿ã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œå€¼è¢« config.yaml æ›¿æ¢

> èˆµæ¨¡æ¿-f config . YAML stable/Maria db > Maria db . YAML

ç„¶åä¸º mariadb.yaml æ·»åŠ  kustomization YAML

![](img/d00e3ad0cd249c1dc804e86a2fa2472f.png)

æœ€åï¼Œå®šåˆ¶æ›´æ”¹å¹¶åº”ç”¨åˆ°é›†ç¾¤

> kustomize build | kubectl apply -f -

é˜…è¯»æœ‰å…³ Kubernetes DevOps çš„ç«¯åˆ°ç«¯ DevOps å·¥ä½œæµ[çš„æ›´å¤šä¿¡æ¯ã€‚](https://link.medium.com/yqPhMzi4G5)

å¸Œæœ›é˜…è¯»æœ‰ç”¨ã€‚è®©æˆ‘ä»¬åˆ›å»ºä¸€äº›å¼ºå¤§çš„å£°æ˜æ€§å·¥ä½œæµğŸš€ã€‚åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­å†è§ğŸ„