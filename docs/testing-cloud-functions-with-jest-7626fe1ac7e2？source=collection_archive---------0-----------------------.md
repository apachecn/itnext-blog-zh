# ç”¨ Jest æµ‹è¯•äº‘å‡½æ•°

> åŸæ–‡ï¼š<https://itnext.io/testing-cloud-functions-with-jest-7626fe1ac7e2?source=collection_archive---------0----------------------->

ä»Šå¤©æˆ‘ä»¬å°†ä½¿ç”¨ Jest æµ‹è¯•æ¡†æ¶æ·±å…¥æµ‹è¯•äº‘å‡½æ•°ï¼Œæ¯”å¦‚ AWS Lambda å’Œ Google Cloud å‡½æ•°ã€‚Jest åœ¨ä½¿ç”¨ React çš„å®¢æˆ·ç«¯å¼€å‘äººå‘˜ä¸­å¾ˆæµè¡Œï¼Œä½†ä¸å¤ªä¸ºäººæ‰€çŸ¥çš„æ˜¯ Jest ä¹Ÿæ˜¯æµ‹è¯• node.js æ— æœåŠ¡å™¨å‡½æ•°çš„ä¸€ä¸ªéå¸¸å¥½çš„æ¡†æ¶ã€‚

![](img/52ea54ac4cc0b28746c2cc81f2e9dfd9.png)

## ä¸ºä»€ä¹ˆå¼€ç©ç¬‘ï¼Ÿ

> " Jest æ˜¯ä¸€ä¸ªä»¤äººæ„‰å¿«çš„ JavaScript æµ‹è¯•æ¡†æ¶ï¼Œä¸“æ³¨äºç®€å•æ€§."

[](https://jestjs.io) [## ç¬‘è¯ğŸƒæ„‰å¿«çš„ JavaScript æµ‹è¯•

### ğŸƒä»¤äººæ„‰å¿«çš„ JavaScript æµ‹è¯•

ğŸƒä»¤äººæ„‰å¿«çš„ JavaScript æµ‹è¯• jetjs . io](https://jestjs.io) 

æˆ‘è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªä»¤äººæ„‰å¿«çš„æµ‹è¯•æ¡†æ¶ã€‚æ­£å¦‚æˆ‘ä»¬å°†çœ‹åˆ°çš„ï¼Œå®ƒä½¿ç”¨ç®€å•ï¼Œä½†ä¹Ÿç›¸å½“å¼ºå¤§ã€‚ä»£ç è¦†ç›–ç‡æŠ¥å‘Šéå¸¸å‡ºè‰²ï¼Œè€Œä¸”æœ‰ä¸€äº›éå¸¸å¥½çš„é…å¥—å·¥å…·ï¼Œæ¯”å¦‚ Jest çš„ zero config GUI[Majestic](https://github.com/Raathigesh/majestic)ã€‚

## å»ºç«‹

æŒ‰ç…§æˆ‘åœ¨[ä»¥å‰çš„å¸–å­](https://medium.com/@keith.coughtrey)ä¸­æè¿°çš„æ–¹æ³•ï¼Œæˆ‘å°†ä»‹ç»ä½¿ç”¨ typescript å¼€å‘å’Œä½¿ç”¨æ— æœåŠ¡å™¨æ¡†æ¶éƒ¨ç½²ã€‚

ä»å®‰è£…ä¾èµ–é¡¹å¼€å§‹:

```
npm install --save-dev jest
```

å½“æˆ‘ä»¬ä½¿ç”¨ typescript æ—¶:

```
npm install --save-dev ts-jest
npm install --save-dev @types/jest
```

æœ€åï¼Œéœ€è¦é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥åˆ›å»ºä¸€äº›åˆå§‹é…ç½®:

```
npx ts-jest config:init
```

ç„¶ååœ¨`package.json`ä¸­è®¾ç½®ä¸€ä¸ªè„šæœ¬ï¼Œè¿™æ ·æ‚¨å°±å¯ä»¥ä½¿ç”¨å‘½ä»¤`npm run test`æ¥è¿è¡Œæ‚¨çš„æµ‹è¯•ï¼Œä¼ å…¥ä»»ä½•éœ€è¦çš„ç¯å¢ƒå˜é‡:

```
"scripts": {
    ...
    "test": "BASE_URL=[https://example.com](https://example.com) jest --bail --coverage --coverageDirectory=output/coverage/jest"
  },
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¼ å…¥ BASE_URL ç¯å¢ƒå˜é‡ï¼Œè¿è¡Œå¸¦æœ‰ä»£ç è¦†ç›–æŠ¥å‘Šçš„`jest`,å¹¶å°†å…¶è®¾ç½®ä¸ºåœ¨ç¬¬ä¸€æ¬¡æµ‹è¯•å¤±è´¥æ—¶é€€å‡ºã€‚

## æµ‹è¯•ç»“æ„å’ŒåŒ¹é…å™¨

æŒ‰ç…§æƒ¯ä¾‹ï¼Œæ‚¨é¦–å…ˆåˆ›å»ºä¸€ä¸ªåä¸º`__tests__`çš„æ–‡ä»¶å¤¹æ¥æ”¾ç½®æ‚¨çš„æµ‹è¯•ã€‚

ä¸€ä¸ªç®€å•çš„æµ‹è¯•å¦‚ä¸‹æ‰€ç¤º:

```
test('two plus two is four', () => {
  expect(2 + 2).toBe(4);
});
```

è¿™é‡Œæˆ‘ä½¿ç”¨äº†`toBe`åŒ¹é…å™¨ã€‚å…¶ä»–æœ‰ç”¨çš„åŒ¹é…å™¨æœ‰:

*   `toBeUndefined`ä»…åŒ¹é…`undefined`
*   `toBeDefined`ä¸`toBeUndefined`ç›¸å
*   `toBeTruthy`åŒ¹é…ä»»ä½•è¢«`if`è¯­å¥è§†ä¸ºçœŸçš„ä¸œè¥¿
*   `toBeFalsy`åŒ¹é…ä»»ä½•è¢«`if`è¯­å¥è§†ä¸ºå‡çš„å†…å®¹

è¿˜æœ‰æ‰€æœ‰å¸¸è§çš„ä¸œè¥¿ï¼Œæ¯”å¦‚æ£€æŸ¥å¤§äºã€å°äºã€æ¥è¿‘ç­‰ï¼ŒåŠ ä¸Š`contains`ç”¨äºæ£€æŸ¥æ˜¯å¦åœ¨æ•°ç»„ä¸­æ‰¾åˆ°æŸä¸ªå€¼ã€‚å®Œæ•´åˆ—è¡¨å¯åœ¨[è¿™é‡Œ](https://jestjs.io/docs/en/expect)æ‰¾åˆ°ã€‚

å¯¹äºå¼‚æ­¥æµ‹è¯•(å‡è®¾æ˜¯`node 8`æˆ–æ›´é«˜ç‰ˆæœ¬),ä½ å¯ä»¥ç®€å•åœ°æ·»åŠ `async`å’Œ`await`å…³é”®å­—

```
test('an asynchronous function', **async** () => { const result = **await** [function that returns a promise]
  expect(result).toBeTruthy();
});
```

## ä»£ç è¦†ç›–ç‡

å¦‚ä¸Šæ‰€è¿°ï¼Œä»£ç è¦†ç›–ç‡æ˜¯ä¸€æµçš„ã€‚åœ¨æµ‹è¯•è¿è¡Œç»“æŸæ—¶ï¼Œæ‚¨ä¼šçœ‹åˆ°è¿™æ ·ä¸€ä¸ªè¦†ç›–ç‡æ€»ç»“:

![](img/ffc192f8e45deef10b14c4c1c660e82e.png)

ä»£ç è¦†ç›–ç‡æ‘˜è¦

HTML æ‘˜è¦é¡µé¢(ä½¿ç”¨ Majestic æ˜¾ç¤ºæˆ–åœ¨ä¸Šé¢çš„`scripts`éƒ¨åˆ†é…ç½®çš„`output/coverage/jest`ä¸­æ‰¾åˆ°)å¦‚ä¸‹å¼€å§‹:

![](img/2244e2ba6c1cb075ffa20b9862263e3d.png)

ä»£ç è¦†ç›–ç‡æŠ¥å‘Š

ç°åœ¨ï¼Œå¦‚æœæˆ‘ç‚¹å‡»`dynamic-link-service.ts`æ¥æŸ¥çœ‹ä¸ºä»€ä¹ˆ 17 ä¸ªä»£ç åˆ†æ”¯ä¸­çš„ 2 ä¸ªæ²¡æœ‰è¢«æµ‹è¯•ï¼Œä¸‹é¢æ˜¯å®ƒä¸º`shorten`å‡½æ•°æ˜¾ç¤ºçš„å†…å®¹:

![](img/50cb127125972c083fb0dad9e9273323.png)

å‡½æ•°æºä»£ç çš„è¦†ç›–ç‡

å¦‚æ‚¨æ‰€è§ï¼Œæˆ‘çš„æµ‹è¯•å·²ç»è¿è¡Œè¯¥å‡½æ•° 16 æ¬¡ï¼Œä½†æ˜¯æ²¡æœ‰ä¸€æ¬¡æµ‹è¯•äº†é”™è¯¯å¤„ç†ä»£ç è·¯å¾„ã€‚

## ä½¿ç”¨ vscode è¿›è¡Œè°ƒè¯•ç­‰

å¦‚æœä½ å¼€å‘çš„æ˜¯ Visual Studio ä»£ç ï¼Œ [Jest æ‰©å±•](https://github.com/jest-community/vscode-jest)å…è®¸ä½ è®¾ç½®æ–­ç‚¹æ¥è°ƒè¯•ä½ çš„æµ‹è¯•ï¼Œè¿™æœ‰æ—¶ä¼šå¾ˆæœ‰å¸®åŠ©ã€‚

å®‰è£…æ‰©å±•ï¼Œç„¶ååœ¨ vscode debug è§†å›¾ä¸­ï¼Œé€‰æ‹©ä¸€ä¸ª **dd é…ç½®**å¹¶é€‰æ‹©`Jest: Default jest configuration`ã€‚å¦‚æœæ‚¨çš„åŠŸèƒ½ä»£ç åœ¨`functions`æ–‡ä»¶å¤¹ä¸­ï¼Œä¿®æ”¹`program`å’Œ`cdw`è·¯å¾„å¦‚ä¸‹:

```
"configurations": [
        {
          "type": "node",
          "name": "all tests",
          "request": "launch",
          "program": "${workspaceFolder}/functions/node_modules/jest/bin/jest",
          "args": [
            "--runInBand"
          ],
          "cwd": "${workspaceFolder}/functions",
          "console": "integratedTerminal",
          "internalConsoleOptions": "neverOpen"
        }
      ]
    }
```

ç°åœ¨ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿè¿è¡Œæ–°çš„é…ç½®å¹¶åœ¨æ–­ç‚¹å¤„åœæ­¢ã€‚è¯¥æ‰©å±•è¿˜æä¾›äº†å…¶ä»–å¥½å¤„ï¼Œå¦‚åœ¨ä¿®æ”¹æµ‹è¯•æ—¶å®æ—¶é‡æ–°è¿è¡Œæµ‹è¯•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:

![](img/f960b09da3db02405ab86f649e415214.png)

Jest æ‰©å±•åœ¨è¿è¡Œä¸­

## å®ä¼Ÿçš„

[](https://github.com/Raathigesh/majestic) [## Raathigesh/majestic

### Majestic æ˜¯ Jest âœ…è¿è¡Œæ‰€æœ‰æµ‹è¯•æˆ–å•ä¸ªæ–‡ä»¶çš„ GUIâ±åˆ‡æ¢è§‚å¯Ÿæ¨¡å¼ğŸ“¸æ›´æ–°å¿«ç…§âŒæ£€æŸ¥æµ‹è¯•â€¦

github.com](https://github.com/Raathigesh/majestic) 

è¿™å°±æ˜¯ä½ å¦‚ä½•å®‰è£…å’Œè¿è¡Œ`Majestic`

```
npm install majestic -g # install majestic globallymajestic # execute majestic
```

è¿è¡Œ majestic è¿è¡Œç”¨äºæ¼”ç¤ºä¸Šè¿°è¦†ç›–ç‡çš„é¡¹ç›®ï¼Œæ‰“å¼€æ˜¾ç¤ºæ­¤é¡µé¢çš„`localhost:4000`:

![](img/c84542a0b28ae06fcbf079c36bbcd30e.png)

é›„ä¼Ÿçš„ä¸»é¡µ

åœ¨è¿™é‡Œï¼Œæˆ‘æŒ‰ä¸‹äº†*æ‰‹è¡¨*å³è¾¹çš„æŒ‰é’®ï¼Œä½¿å…¶æ”¶é›†ä»£ç è¦†ç›–ç‡ã€‚æ˜¾ç¤ºäº†ç»Ÿè®¡æ•°æ®ï¼Œæ‚¨å¯ä»¥ä»è¿™é‡Œæ·±å…¥æŸ¥çœ‹æŠ¥å‘Šã€‚æ‚¨è¿˜å¯ä»¥çœ‹åˆ°æµ‹è¯•çš„ä»»ä½•æ§åˆ¶å°è¾“å‡ºã€‚è¯·æ³¨æ„ï¼Œåœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œå®ƒåœ¨ Chrome ä¸­è¿è¡Œå¾—æœ€å¥½ã€‚Safari æ‰“ä¹±äº†æ§åˆ¶å°éƒ¨åˆ†ã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘ä½¿ç”¨äº†ä¸€ä¸ªé”™è¯¯æ¥æ˜¾ç¤ºæ–­è¨€å¤±è´¥æ˜¯å¦‚ä½•æ˜¾ç¤ºçš„:

![](img/4b6be475aa08f73e6b53819e15d6ea22.png)

æ–­è¨€å¤±è´¥

å¦‚æœæ‚¨çš„æµ‹è¯•éœ€è¦é…ç½®ç¯å¢ƒå˜é‡ï¼Œæ‚¨å¯ä»¥å‘`package.json`æ·»åŠ ä¸€ä¸ª`majestic`éƒ¨åˆ†ï¼Œä»¥ä¾¿å‘`Majestic`æä¾› env å€¼ï¼Œä¾‹å¦‚:

```
"majestic": {
    "args": "--debug",
    "env": {
      "BASE_URL": "[https://example.com](https://example.com)",
    }
  },
```

## éƒ¨ç½²å‰æµ‹è¯•

åªæœ‰å½“æ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡æ—¶ï¼Œæ‰å…è®¸éƒ¨ç½²ï¼Œè¿™æ˜¯ä¸€ä¸ªå¥½çš„å®è·µã€‚æ‚¨å¯ä»¥é€šè¿‡åƒè¿™æ ·è®¾ç½®`package.json`è„šæœ¬æ¥å®ç°:

```
"scripts": {
    "build": "tsc",
    "deploy": "npm run build && npm run test && serverless deploy",
    "test": "BASE_URL=[https://example.com](https://example.com) jest --bail --coverage --coverageDirectory=output/coverage/jest"
  },
```

ç°åœ¨ï¼Œå¦‚æœæ‚¨ä½¿ç”¨`npm run deploy`è¿›è¡Œéƒ¨ç½²ï¼Œæ‚¨çš„æµ‹è¯•å°†ä¼šè¿è¡Œï¼Œå¦‚æœæœ‰æµ‹è¯•å¤±è´¥ï¼Œéƒ¨ç½²å°†ä¸ä¼šç»§ç»­ã€‚

æˆ‘å¸Œæœ›æˆ‘å·²ç»å‘ä½ å±•ç¤ºäº†è¶³å¤Ÿå¤šçš„ä¸œè¥¿æ¥å¸å¼•ä½ æŠ•å…¥åˆ°ä½ è‡ªå·±çš„é¡¹ç›®ä¸­å»å°è¯•`Jest`ã€‚åœ¨æˆ‘çš„ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†ä»‹ç»æ¨¡ä»¿å’Œåˆºæ¢ï¼ŒåŒ…æ‹¬ä¸€ç§ä»¥ä¿æŒçŠ¶æ€å¹¶å¯ç”¨äºé›†æˆæµ‹è¯•çš„æ–¹å¼æ¨¡ä»¿äº‘æ•°æ®åº“çš„å®ç”¨æ–¹æ³•ã€‚