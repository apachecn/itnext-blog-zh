<html>
<head>
<title>Securely Ingressing into Bare Metal Kubernetes Clusters with Gateway API and Tailscale</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ä½¿ç”¨ç½‘å…³APIå’ŒTailscaleå®‰å…¨åœ°è¿›å…¥è£¸æœºKubernetesé›†ç¾¤</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://itnext.io/securely-ingressing-into-bare-metal-kubernetes-clusters-with-gateway-api-and-tailscale-cc68299b646a?source=collection_archive---------1-----------------------#2022-12-30">https://itnext.io/securely-ingressing-into-bare-metal-kubernetes-clusters-with-gateway-api-and-tailscale-cc68299b646a?source=collection_archive---------1-----------------------#2022-12-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/e677e789b25e863502b7995e9ebb802f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iytCszU_LvTawUoJMMDz4w.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">ç”±æ ‘è“çš®4åˆ¶æˆçš„è£¸æœºKubernetesé›†ç¾¤</figcaption></figure><p id="1ba8" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">é¿å…å°†å¸¦æœ‰æ•æ„Ÿæ•°æ®çš„äº’è”ç½‘åº”ç”¨ç¨‹åºæš´éœ²ç»™å…¬ä¼—æ˜¯ä¸€é¡¹åŸºæœ¬çš„å®‰å…¨å®è·µï¼Œå³ä½¿åº”ç”¨ç¨‹åºä½¿ç”¨ä»»ä½•ç±»å‹çš„èº«ä»½éªŒè¯ï¼Œä¹Ÿåº”è¯¥å§‹ç»ˆä¿æŒè¿™ç§åšæ³•ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæ‚¨å¯ä»¥è®¾ç½®ä¸€ä¸ªè™šæ‹Ÿä¸“ç”¨ç½‘ï¼Œå¹¶åœ¨æœ¬åœ°DNSä¸­è§£æä¸“ç”¨è´Ÿè½½å¹³è¡¡å™¨çš„IPï¼Œè¿™æ ·åªæœ‰æ‚¨çš„VPNç”¨æˆ·æ‰èƒ½å°†æµé‡è·¯ç”±åˆ°æ‚¨çš„åº”ç”¨ç¨‹åºã€‚</p><p id="06db" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">å¦‚æœæ‚¨åœ¨AWSä¸­è¿è¡Œæ‚¨çš„å¹³å°ï¼Œæœ‰åƒ<a class="ae ld" href="https://aws.amazon.com/privatelink/" rel="noopener ugc nofollow" target="_blank"> AWS PrivateLink </a>è¿™æ ·çš„æ‰˜ç®¡æœåŠ¡æä¾›æ‰˜ç®¡ç§æœ‰è¿æ¥æœåŠ¡ï¼Œå› æ­¤æ‚¨å¯ä»¥ä»å¤–éƒ¨VPCå®‰å…¨åœ°è®¿é—®æ‚¨çš„ç§æœ‰NLBã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨æœ‰è£¸æœºé›†ç¾¤ï¼Œå®ç°è¿™ç§æ¨¡å¼å¯èƒ½ä¼šæœ‰å›°éš¾ï¼Œå› ä¸ºæ‚¨å¿…é¡»è‡ªå·±å¤„ç†ç‰©ç†ç½‘ç»œã€‚</p><p id="5e28" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">æœ¬æ–‡çš„ç›®çš„æ˜¯æä¾›ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡åˆ©ç”¨å…·æœ‰å…è´¹å±‚çš„å¼€æ”¾æºç æŠ€æœ¯æ¥ç§æœ‰åœ°è®¿é—®è£¸æœºKubernetesé›†ç¾¤ï¼Œæ‰€ä»¥æ‚¨ä¸ä¼šèŠ±ä¸€åˆ†é’±ï¼</p><p id="11ef" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">æˆ‘ä»¬å°†ä½¿ç”¨<a class="ae ld" href="https://gateway-api.sigs.k8s.io/" rel="noopener ugc nofollow" target="_blank">ç½‘å…³API </a>çš„å®ç°æ¥å£°æ˜æ€§åœ°å®šä¹‰è®¿é—®é›†ç¾¤æ‰€éœ€çš„ç½‘ç»œèµ„æºã€‚å¦‚æœæ‚¨ç†Ÿæ‚‰Kubernetesï¼Œæ‚¨å¯èƒ½çŸ¥é“åœ¨APIç½‘å…³ä¸­å…¬å¼€æ‚¨çš„åº”ç”¨ç¨‹åºçš„<a class="ae ld" href="https://kubernetes.io/docs/concepts/services-networking/ingress/" rel="noopener ugc nofollow" target="_blank">å…¥å£API </a>ã€‚ä¸ºäº†å…‹æœå®ƒçš„å±€é™æ€§ï¼Œ<a class="ae ld" href="https://github.com/kubernetes/community/tree/master/sig-network" rel="noopener ugc nofollow" target="_blank"> SIG network </a>æœ€è¿‘æ¨å‡ºäº†å®ƒçš„ç»§ä»»è€…Gateway APIã€‚</p><h1 id="285a" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">ä»€ä¹ˆæ˜¯ç½‘å…³APIï¼Ÿ</h1><p id="5fd3" class="pw-post-body-paragraph kf kg it kh b ki mc kk kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc im bi translated">è¿™ä¸ªæ–°çš„APIå¼•å…¥äº†ä¸€ç»„æ–°çš„ç½‘ç»œèµ„æºï¼Œå¯ä»¥åœ¨æ‚¨çš„ç»„ç»‡ä¸­æ›´å¥½åœ°åˆ’åˆ†èŒè´£:</p><ul class=""><li id="b397" class="mh mi it kh b ki kj km kn kq mj ku mk ky ml lc mm mn mo mp bi translated"><code class="fe mq mr ms mt b"><a class="ae ld" href="https://gateway-api.sigs.k8s.io/api-types/gatewayclass/" rel="noopener ugc nofollow" target="_blank">GatewayClass</a></code>:å®šä¹‰ä¸€ä¸ª<code class="fe mq mr ms mt b">Gateway</code>ç±»çš„é›†ç¾¤ä½œç”¨åŸŸèµ„æºï¼Œç±»ä¼¼äºå®ƒçš„å‰è¾ˆ<a class="ae ld" href="https://kubernetes.io/docs/concepts/services-networking/ingress/#ingress-class" rel="noopener ugc nofollow" target="_blank"> IngressClass </a>ã€‚å®ƒé€šå¸¸ç”±åŸºç¡€è®¾æ–½æä¾›å•†ç®¡ç†ï¼Œä»¥æä¾›ä¸åŒçš„ç½‘å…³é£æ ¼ï¼Œä¾‹å¦‚å…¬å…±æˆ–ç§æœ‰ã€‚</li><li id="473c" class="mh mi it kh b ki mu km mv kq mw ku mx ky my lc mm mn mo mp bi translated"><code class="fe mq mr ms mt b"><a class="ae ld" href="https://gateway-api.sigs.k8s.io/api-types/gateway/" rel="noopener ugc nofollow" target="_blank">Gateway</a></code>:åŒ…å«è´Ÿè½½å¹³è¡¡åŸºç¡€è®¾æ–½é…ç½®çš„é›†ç¾¤èŒƒå›´çš„èµ„æºï¼Œä¾‹å¦‚ç½‘ç»œåè®®å’ŒTLSã€‚å¹³å°å›¢é˜Ÿè´Ÿè´£ç»´æŠ¤æ‰€æœ‰åº”ç”¨ç¨‹åºå…±äº«çš„<code class="fe mq mr ms mt b">Gateway</code>èµ„æºï¼Œä»¥è·¯ç”±æµé‡ã€‚</li><li id="c4af" class="mh mi it kh b ki mu km mv kq mw ku mx ky my lc mm mn mo mp bi translated"><code class="fe mq mr ms mt b"><a class="ae ld" href="https://gateway-api.sigs.k8s.io/api-types/httproute/" rel="noopener ugc nofollow" target="_blank">HTTPRoute</a></code>:ç”±åº”ç”¨ç¨‹åºå›¢é˜Ÿç®¡ç†ï¼Œè¿™ä¸ªèµ„æºåŒ…å«å°†HTTPæµé‡æ˜ å°„åˆ°Kubernetes <code class="fe mq mr ms mt b">Service</code>èµ„æºçš„è·¯ç”±é…ç½®ã€‚</li></ul><figure class="na nb nc nd gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mz"><img src="../Images/2ee899a2fe8ed89afa7ad8608d32884b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XMgU2bZsTuv-qJsU.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">ä½¿ç”¨ç½‘å…³APIèµ„æºçš„èŒè´£åˆ†ç¦»ã€‚ç½‘å…³APIæ–‡æ¡£æä¾›çš„å›¾åƒ</figcaption></figure><p id="cc2c" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œè¿™ä¸ªæƒ³æ³•æ˜¯è®©ä¸¤ä¸ªä¸åŒçš„<code class="fe mq mr ms mt b">GatewayClass</code>å¯¹è±¡èƒ½å¤Ÿå£°æ˜æˆ‘ä»¬æ˜¯å¦å¸Œæœ›<code class="fe mq mr ms mt b">Gateway</code>å°†å…¶<code class="fe mq mr ms mt b">HTTPRoutes</code>æš´éœ²ç»™äº’è”ç½‘æˆ–Tailscale VPNã€‚è¿™æ ·ï¼Œåœ¨<code class="fe mq mr ms mt b">GatewayClass</code>å’Œ<code class="fe mq mr ms mt b">Gateway</code>èµ„æºä¸­æŠ½è±¡å‡ºäº†ä¸ºåº”ç”¨ç¨‹åºæä¾›è¿æ¥æ‰€éœ€çš„ç½‘ç»œç»†èŠ‚ï¼Œå› æ­¤ä¸ä¼šå‘å¼€å‘äººå‘˜å…¬å¼€ï¼Œå› æ­¤ä»–ä»¬å¯ä»¥ä¸“æ³¨äºé…ç½®ä»–ä»¬çš„åº”ç”¨ç¨‹åºã€‚åä¹‹äº¦ç„¶ï¼Œå¹³å°å·¥ç¨‹å¸ˆèƒ½å¤Ÿåœ¨ä¸å¹²æ‰°åº”ç”¨å›¢é˜Ÿçš„æƒ…å†µä¸‹æ‰§è¡Œä»–ä»¬çš„æ“ä½œï¼Œä¾‹å¦‚ï¼Œä»–ä»¬èƒ½å¤Ÿåœ¨åº”ç”¨å›¢é˜Ÿæ²¡æœ‰æ³¨æ„çš„æƒ…å†µä¸‹é…ç½®æ–°çš„TLSè¯ä¹¦ã€‚</p><h1 id="93be" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">éœ€æ±‚å’Œæ¶æ„</h1><p id="dafc" class="pw-post-body-paragraph kf kg it kh b ki mc kk kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc im bi translated">æˆ‘ä»¬çš„é›†ç¾¤å°†æœ‰ä¸¤ç§ä¸åŒç±»å‹çš„ç”¨æˆ·:</p><ul class=""><li id="c900" class="mh mi it kh b ki kj km kn kq mj ku mk ky ml lc mm mn mo mp bi translated"><strong class="kh iu">å†…éƒ¨:</strong>ä½¿ç”¨æœ¬åœ°ç½‘ç»œæˆ–Tailscale VPNè®¿é—®é›†ç¾¤ï¼Œè¯¥ç”¨æˆ·å°†èƒ½å¤Ÿè®¿é—®å†…éƒ¨å’Œå¤–éƒ¨åº”ç”¨ç¨‹åºã€‚</li><li id="85ec" class="mh mi it kh b ki mu km mv kq mw ku mx ky my lc mm mn mo mp bi translated"><strong class="kh iu">å¤–éƒ¨</strong>:ä½äºç½‘ç»œå¤–éƒ¨ï¼Œè¯¥ç”¨æˆ·å°†ä½¿ç”¨æˆ‘ä»¬çš„å…¬å…±IPè·¯ç”±åˆ°é›†ç¾¤ï¼Œåªèƒ½è®¿é—®å¤–éƒ¨åº”ç”¨ç¨‹åºã€‚</li></ul><p id="ae51" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">æˆ‘ä»¬åº”è¯¥ä¸ºç”¨æˆ·æä¾›é€‚å½“çš„DNSè§£æï¼Œè¿™æ ·ä»–ä»¬å°±å¯ä»¥é¡ºåˆ©åœ°è¿›å…¥æˆ‘ä»¬çš„é›†ç¾¤ï¼Œè€Œä¸å¿…è®°ä½IPåœ°å€ã€‚æ›´å‡†ç¡®åœ°è¯´ï¼Œæˆ‘ä»¬å°†æä¾›è¿™äº›DNSåç§°:</p><ul class=""><li id="634b" class="mh mi it kh b ki kj km kn kq mj ku mk ky ml lc mm mn mo mp bi translated"><strong class="kh iu">internal.mmontes.duckdns.org</strong>:å®ƒå°†ç”±æœ¬åœ°DNSæœåŠ¡å™¨è§£æåˆ°æˆ‘ä»¬å†…éƒ¨çš„è´Ÿè½½å‡è¡¡å™¨IPã€‚</li><li id="c05b" class="mh mi it kh b ki mu km mv kq mw ku mx ky my lc mm mn mo mp bi translated"><strong class="kh iu">mmontes.duckdns.org</strong>:å®ƒä¼šè¢«ä¸€ä¸ªå…¬å…±DNSæœåŠ¡å™¨è§£æåˆ°æˆ‘ä»¬çš„å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨IPã€‚</li></ul><p id="66da" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">æˆ‘ä»¬çš„é€šä¿¡åº”è¯¥ä½¿ç”¨TLSåŠ å¯†ï¼Œä»¥é¿å…<a class="ae ld" href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack" rel="noopener ugc nofollow" target="_blank"> MITM </a>æ”»å‡»å¹¶ä¿è¯æœºå¯†æ€§ï¼Œå› æ­¤æˆ‘ä»¬å°†ä½¿ç”¨Let's Encryptä¸ºå†…éƒ¨å’Œå¤–éƒ¨ç«¯ç‚¹é¢å‘è¯ä¹¦ã€‚</p><p id="b92a" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">è€ƒè™‘åˆ°æ‰€æœ‰è¿™äº›éœ€æ±‚ï¼Œè¿™æ˜¯æˆ‘ä»¬è§£å†³æ–¹æ¡ˆçš„é«˜çº§æ¶æ„ã€‚</p><figure class="na nb nc nd gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ne"><img src="../Images/3fb50cea08cff89b1f594db851a7a1b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VL05eNLDC26cNLsB722rjg.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">æˆ‘ä»¬ç›®æ ‡ä½“ç³»ç»“æ„çš„ç½‘ç»œå›¾</figcaption></figure><p id="7ba5" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">æˆ‘ä»¬å°†æ”¾å¤§æ¯ä¸ªç»„ä»¶ä»¥æä¾›æ›´å¤šç»†èŠ‚ã€‚</p><h1 id="c3fc" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">å°¾ç§¤</h1><p id="9f3e" class="pw-post-body-paragraph kf kg it kh b ki mc kk kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc im bi translated">ä¸ºäº†èƒ½å¤Ÿä»ä»»ä½•ç½‘ç»œå¯¹æˆ‘ä»¬çš„è®¾å¤‡è¿›è¡Œç§æœ‰å¯»å€ï¼Œæˆ‘ä»¬å°†å¼•å…¥<a class="ae ld" href="https://tailscale.com/" rel="noopener ugc nofollow" target="_blank"> Tailscale </a>ï¼Œè¿™æ˜¯ä¸€ç§VPNæœåŠ¡ï¼Œä¸å…¶ä»–é›†ä¸­å¼è§£å†³æ–¹æ¡ˆä¸åŒï¼Œå®ƒé€šè¿‡ä½¿ç”¨<a class="ae ld" href="https://www.wireguard.com/" rel="noopener ugc nofollow" target="_blank"> Wireguard </a>åè®®ï¼Œå®ç°æ‚¨çš„è®¾å¤‡ä¹‹é—´çš„åŠ å¯†ç‚¹å¯¹ç‚¹è¿æ¥ã€‚ä¸ä¼ ç»Ÿçš„é›†ä¸­å¼VPNç›¸æ¯”ï¼Œè¿™å¯¼è‡´äº†æ›´ä½çš„å»¶è¿Ÿã€‚</p><figure class="na nb nc nd gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nf"><img src="../Images/152a50728f8b0a5cb4b334d8c91ef437.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XEGuobvjawJKiWAW.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">ä½¿ç”¨Tailscaleçš„åŠ å¯†ç‚¹å¯¹ç‚¹è¿æ¥ã€‚å›¾ç‰‡ç”±Tailscale docsæä¾›</figcaption></figure><p id="0ee4" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">Tailscaleå°†ä¸ºæ‚¨åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿä¸“ç”¨ç½‘ç»œï¼Œä¹Ÿç§°ä¸º<code class="fe mq mr ms mt b">tailnet</code>ï¼Œåœ¨è¿™é‡Œæ‚¨å¯ä»¥å®‰å…¨åœ°è·¯ç”±åˆ°æ‚¨çš„è®¾å¤‡ã€‚å®ƒè¿˜å°†åœ¨æ¯å°è®¾å¤‡ä¸Šåˆ›å»ºä¸€ä¸ªç½‘ç»œæ¥å£ï¼Œæ¯å½“å®ƒå‘<code class="fe mq mr ms mt b">tailnet</code>ä¸­çš„ä¸€ä¸ªIPå‘é€æµé‡æ—¶éƒ½ä¼šä½¿ç”¨è¿™ä¸ªæ¥å£ã€‚</p><pre class="na nb nc nd gt ng mt nh bn ni nj bi"><span id="e2b5" class="nk lf it mt b be nl nm l nn no">mmontes@k8s-worker0:~$ ifconfig<br/>...<br/>tailscale0: flags=4305&lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST&gt;  mtu 1280<br/>        inet 100.80.97.21  netmask 255.255.255.255  destination 100.80.97.21<br/>        inet6 fe80::522b:a1ae:f74a:b97c  prefixlen 64  scopeid 0x20&lt;link&gt;<br/>        inet6 fd7a:115c:a1e0:ab12:4843:cd96:6250:6115  prefixlen 128  scopeid 0x0&lt;global&gt;<br/>        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen 500  (UNSPEC)<br/>        RX packets 71147  bytes 31066579 (31.0 MB)<br/>        RX errors 0  dropped 0  overruns 0  frame 0<br/>        TX packets 62171  bytes 8793662 (8.7 MB)<br/>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span></pre><p id="f748" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">ä¸ºäº†è§£æDNSåç§°ï¼ŒTailscaleæœ‰ä¸€ä¸ªåä¸º<a class="ae ld" href="https://tailscale.com/kb/1081/magicdns/" rel="noopener ugc nofollow" target="_blank"> MagicDNS </a>çš„åŠŸèƒ½ï¼Œå¯ä»¥è‡ªåŠ¨ä¸º<code class="fe mq mr ms mt b">tailnet</code>ä¸­çš„è®¾å¤‡é…ç½®DNSåç§°ã€‚æ‚¨ä¹Ÿå¯ä»¥é…ç½®è‡ªå·±çš„DNSæœåŠ¡å™¨ï¼Œä½†æ˜¯æˆ‘ä»¬å°†åœ¨åé¢ä»‹ç»ã€‚</p><pre class="na nb nc nd gt ng mt nh bn ni nj bi"><span id="63c4" class="nk lf it mt b be nl nm l nn no">mmontes@raspi-ramallal:~ $ nslookup k8s-worker0<br/>Server:         100.100.100.100<br/>Address:        100.100.100.100#53<br/><br/>Name:   k8s-worker0.tail03db8.ts.net<br/>Address: 100.80.97.21</span></pre><p id="cb3e" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»ä»‹ç»äº†å®‰è£…äº†Tailscaleçš„è®¾å¤‡çš„ç§æœ‰è¿æ¥ï¼Œä½†æ˜¯ï¼Œå¯èƒ½æœ‰ä¸€äº›è®¾å¤‡æ— æ³•è¿è¡ŒTailscaleå®ˆæŠ¤ç¨‹åºï¼Œä½†å®ƒä»¬åœ¨æ‚¨çš„æœ¬åœ°ç½‘ç»œä¸­æœ‰ä¸€ä¸ªIPï¼Œä¾‹å¦‚ç‰©è”ç½‘è®¾å¤‡ã€‚æˆ‘ä»¬èƒ½ä»VPNè§£å†³è¿™äº›é—®é¢˜å—ï¼Ÿè¶³å¤Ÿå¹¸è¿çš„æ˜¯ï¼ŒTailscaleå·²ç»è¦†ç›–äº†ä½ ï¼Œå®ƒä»¬å…è®¸ä½ é…ç½®è®¾å¤‡ä½œä¸º<a class="ae ld" href="https://tailscale.com/kb/1019/subnets/" rel="noopener ugc nofollow" target="_blank">å­ç½‘è·¯ç”±å™¨</a>ã€‚æ‚¨å¯ä»¥é€‰æ‹©è¿è¡ŒTailscaleçš„è®¾å¤‡åœ¨<code class="fe mq mr ms mt b">tailnet</code>ä¸­é€šå‘Šæ‚¨æœ¬åœ°ç½‘ç»œçš„CIDRã€‚</p><pre class="na nb nc nd gt ng mt nh bn ni nj bi"><span id="8dd8" class="nk lf it mt b be nl nm l nn no">#!/bin/bash<br/><br/>curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | tee /usr/share/keyrings/tailscale-archive-keyring.gpg &gt;/dev/null<br/>curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | tee /etc/apt/sources.list.d/tailscale.list<br/><br/>apt update<br/>apt install -y tailscale<br/><br/>tailscale up --advertise-routes=192.168.0.0/24</span></pre><p id="698e" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">æˆ‘ä»¬åœ¨è¿™é‡Œå®£ä¼ çš„æ˜¯<code class="fe mq mr ms mt b">192.168.0.0/24</code> CIDRï¼Œå› æ­¤æˆ‘ä»¬å°†èƒ½å¤Ÿä»ç”Ÿæ´»åœ¨<code class="fe mq mr ms mt b">tailnet</code>çš„è®¾å¤‡å¯»å€è¯¥èŒƒå›´å†…çš„ä»»ä½•IPï¼Œå³ä½¿å®ƒä»¬ä¸åœ¨åŒä¸€ä¸ªæœ¬åœ°ç½‘ç»œä¸­ã€‚è¿™å°†æ˜¯æˆ‘ä»¬è®¾ç½®çš„ä¸€ä¸ªå…³é”®ç‰¹æ€§ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦åœ¨<code class="fe mq mr ms mt b">tailnet</code>ä¸­å…¬å¸ƒä¸èƒ½è‡ªå·±è¿è¡ŒTailscaleçš„<code class="fe mq mr ms mt b">LoadBalancer</code>IPã€‚</p><h1 id="ae97" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">å¼•å¯¼é›†ç¾¤</h1><p id="1c08" class="pw-post-body-paragraph kf kg it kh b ki mc kk kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc im bi translated">ä¸€æ—¦è¿æ¥å°±ç»ªï¼Œæ¥ä¸‹æ¥çš„äº‹æƒ…å°†æ˜¯é…ç½®ä¸»æœºå¹¶ä½¿ç”¨<a class="ae ld" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/" rel="noopener ugc nofollow" target="_blank"> kubeadm </a>å¼•å¯¼Kubernetesé›†ç¾¤ï¼Œä½†ä¸å¹¸çš„æ˜¯è¿™æ˜¯ä¸€ä¸ªå¹¿æ³›çš„ä¸»é¢˜ï¼Œä¸é€‚åˆæœ¬æ–‡(ä¹Ÿè®¸å¦ä¸€ç¯‡ï¼Ÿ)ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯å›è´­å¦‚æœä½ æƒ³çœ‹çœ‹ã€‚</p><div class="np nq gp gr nr ns"><a href="https://github.com/mmontes11/k8s-bootstrap" rel="noopener  ugc nofollow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd iu gy z fp nx fr fs ny fu fw is bi translated">GitHubâ€”mmontes 11/k8sâ€”å¼•å¯¼ç¨‹åº:ğŸš€ä½¿ç”¨kubeadmçš„Kubernetesé›†ç¾¤å¼•å¯¼</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">ä½¿ç”¨kubeadmçš„Kubernetesé›†ç¾¤å¼•å¯¼ã€‚</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">github.com</p></div></div><div class="ob l"><div class="oc l od oe of ob og jz ns"/></div></div></a></div><h1 id="fc99" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">æµé‡</h1><p id="2c05" class="pw-post-body-paragraph kf kg it kh b ki mc kk kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc im bi translated">æˆ‘ä»¬å°†éµå¾ª<a class="ae ld" href="https://opengitops.dev/" rel="noopener ugc nofollow" target="_blank"> GitOps </a>æ–¹æ³•å°†å·¥ä½œè´Ÿè½½éƒ¨ç½²åˆ°æˆ‘ä»¬çš„é›†ç¾¤ã€‚è¿™æ„å‘³ç€ä¸€ç»„Kubernetesæ§åˆ¶å™¨å°†ä¸æ–­åœ°åè°ƒgitå­˜å‚¨åº“çš„æ¸…å•ï¼Œå› æ­¤æˆ‘ä»¬å®é™…ä¸Šä¸éœ€è¦æ‰‹åŠ¨æ“ä½œé›†ç¾¤ï¼Œç›¸åï¼Œæˆ‘ä»¬åªéœ€å£°æ˜æ‰€éœ€çš„çŠ¶æ€ï¼Œæ§åˆ¶å™¨å°†ç¡®ä¿å®é™…çŠ¶æ€ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ã€‚</p><p id="75f0" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä»–ä»¬æ–¹ä¾¿çš„<a class="ae ld" href="https://fluxcd.io/flux/cmd/" rel="noopener ugc nofollow" target="_blank"> CLI </a>å®‰è£…<a class="ae ld" href="https://fluxcd.io/" rel="noopener ugc nofollow" target="_blank"> Flux </a>ï¼Œå®ƒæä¾›äº†ä¸€ä¸ª<code class="fe mq mr ms mt b">bootstrap</code>å­å‘½ä»¤æ¥å¿«é€Ÿå¯åŠ¨æ§åˆ¶å¹³é¢å¹¶å¼€å§‹åè°ƒgit repoã€‚</p><pre class="na nb nc nd gt ng mt nh bn ni nj bi"><span id="d778" class="nk lf it mt b be nl nm l nn no">mmontes@k8s-master:~$ flux bootstrap github \<br/>  --owner=mmontes11 \<br/>  --repository=mmontes11/k8s-infrastructure \<br/>  --branch=main \<br/>  --path=./clusters/production \<br/>  --personal \<br/>  --private=false</span></pre><p id="56c4" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">è¿è¡Œè¯¥å‘½ä»¤åï¼Œæ‚¨å°†çœ‹åˆ°åœ¨<code class="fe mq mr ms mt b">flux-system</code>åç§°ç©ºé—´ä¸­å‡ºç°æµé‡æ§åˆ¶å¹³é¢ï¼Œå¹¶ä¸”<code class="fe mq mr ms mt b">Kustomization</code>å’Œ<code class="fe mq mr ms mt b">HelmRelease</code>èµ„æºå¼€å§‹åè°ƒã€‚</p><pre class="na nb nc nd gt ng mt nh bn ni nj bi"><span id="cc06" class="nk lf it mt b be nl nm l nn no">mmontes@k8s-master:~$ kubectl get pods -n flux-system<br/>NAME                                       READY   STATUS    RESTARTS   AGE<br/>helm-controller-59f8b44dd5-sln4l           1/1     Running   0          7d11h<br/>kustomize-controller-7d475476b4-qhl8b      1/1     Running   0          7d11h<br/>notification-controller-677cf654b9-99kfp   1/1     Running   0          7d11h<br/>source-controller-dc97b975b-cwv88          1/1     Running   0          7d11h<br/><br/>mmontes@k8s-master:~$ kubectl get kustomizations -A<br/>NAMESPACE         NAME                             AGE     READY   STATUS<br/>flux-system       cert-manager                     12d     True    Applied revision: main/04437305d3780aca25115d5fe77ae193c48a3cc2<br/>flux-system       cert-manager-issuers             3h9m    True    Applied revision: main/04437305d3780aca25115d5fe77ae193c48a3cc2<br/>flux-system       dns                              12d     True    Applied revision: main/04437305d3780aca25115d5fe77ae193c48a3cc2<br/>flux-system       flux-system                      12d     True    Applied revision: main/04437305d3780aca25115d5fe77ae193c48a3cc2<br/>flux-system       gateway-api                      12d     True    Applied revision: main/04437305d3780aca25115d5fe77ae193c48a3cc2<br/>flux-system       kube-prometheus-stack            12d     True    Applied revision: main/04437305d3780aca25115d5fe77ae193c48a3cc2<br/>flux-system       kube-prometheus-stack-monitors   3h15m   True    Applied revision: main/04437305d3780aca25115d5fe77ae193c48a3cc2<br/>flux-system       metallb                          12d     True    Applied revision: main/04437305d3780aca25115d5fe77ae193c48a3cc2<br/>flux-system       networking                       12d     True    Applied revision: main/04437305d3780aca25115d5fe77ae193c48a3cc2<br/>flux-system       traefik                          12d     True    Applied revision: main/04437305d3780aca25115d5fe77ae193c48a3cc2<br/>flux-system       traefik-config                   3h15m   True    Applied revision: main/04437305d3780aca25115d5fe77ae193c48a3cc2<br/>...<br/><br/>mmontes@k8s-master:~$ kubectl get helmrelease -A<br/>NAMESPACE         NAME                         AGE    READY   STATUS<br/>dns               duckdns                      12d    True    Release reconciliation succeeded<br/>dns               pihole                       12d    True    Release reconciliation succeeded<br/>monitoring        kube-prometheus-stack        12d    True    Release reconciliation succeeded<br/>networking        metallb                      12d    True    Release reconciliation succeeded<br/>networking        traefik-external             10d    True    Release reconciliation succeeded<br/>networking        traefik-internal             10d    True    Release reconciliation succeeded<br/>pki               cert-manager                 12d    True    Release reconciliation succeeded<br/>pki               letsencrypt                  3h8m   True    Release reconciliation succeeded<br/>...</span></pre><p id="d24e" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">è¿™é‡Œæ˜¯Fluxæ­£åœ¨åè°ƒçš„å›è´­åè®®ï¼Œæ¥ä¸‹æ¥çš„éƒ¨åˆ†å°†ä»‹ç»å®‰è£…å’Œé…ç½®æ‰€æœ‰å¯ç”¨çš„ç½‘ç»œç»„ä»¶ï¼Œä¸è¿‡æ‚¨å¯ä»¥éšæ„æŸ¥çœ‹ã€‚</p><div class="np nq gp gr nr ns"><a href="https://github.com/mmontes11/k8s-infrastructure" rel="noopener  ugc nofollow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd iu gy z fp nx fr fs ny fu fw is bi translated">GitHub-mmontes 11/k8s-åŸºç¡€è®¾æ–½:ğŸ—ä½¿ç”¨Fluxçš„ï¸åŸºç¡€è®¾æ–½å’Œç§Ÿæˆ·å¼•å¯¼</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">ä½¿ç”¨Fluxçš„åŸºç¡€è®¾æ–½å’Œç§Ÿæˆ·å¼•å¯¼ã€‚å½“â€¦æ—¶ï¼ŒFluxä½¿ç”¨çš„æ¯ä¸ªç°‡çš„å…¥å£ç‚¹</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">github.com</p></div></div><div class="ob l"><div class="oh l od oe of ob og jz ns"/></div></div></a></div><h1 id="76a8" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">é‡‘å±lb</h1><p id="34c2" class="pw-post-body-paragraph kf kg it kh b ki mc kk kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc im bi translated">ä¸ºäº†æé«˜å¯ç”¨æ€§ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<code class="fe mq mr ms mt b">LoadBalancer</code>æœåŠ¡è¿›å…¥æˆ‘ä»¬çš„é›†ç¾¤ã€‚ä¸æ‰˜ç®¡Kubernetesäº§å“ä¸åŒï¼ŒIPä¸ä¼šè‡ªåŠ¨æä¾›ç»™<code class="fe mq mr ms mt b">LoadBalancer</code>æœåŠ¡ï¼Œå®ƒä»¬å°†ä¿æŒå¾…å®šçŠ¶æ€ã€‚åœ¨è£¸æœºé›†ç¾¤ä¸­è‡ªåŠ¨é…ç½®è¿™äº›IPä¸æ˜¯å¾ˆå¥½å—ï¼Ÿè¿™æ˜¯Kubernetesæ§åˆ¶å™¨<a class="ae ld" href="https://metallb.universe.tf/" rel="noopener ugc nofollow" target="_blank"> Metallb </a>çš„ä½¿å‘½ï¼Œå®ƒä¸ºæ‚¨çš„<code class="fe mq mr ms mt b">LoadBalancer</code>æœåŠ¡æä¾›å’Œåˆ†é…IPåœ°å€ï¼Œä¸äº‘æä¾›å•†çš„åšæ³•ç›¸åŒã€‚</p><p id="0e1f" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">æˆ‘ä»¬å°†ä½¿ç”¨<code class="fe mq mr ms mt b">HelmRelease</code>åœ¨é›†ç¾¤ä¸­å®‰è£…Metallbã€‚</p><pre class="na nb nc nd gt ng mt nh bn ni nj bi"><span id="aaee" class="nk lf it mt b be nl nm l nn no">apiVersion: helm.toolkit.fluxcd.io/v2beta1<br/>kind: HelmRelease<br/>metadata:<br/>  name: metallb<br/>spec:<br/>  chart:<br/>    spec:<br/>      chart: metallb<br/>      sourceRef:<br/>        kind: HelmRepository<br/>        name: metallb<br/>      version: "0.13.7"<br/>  interval: 1h0m0s<br/>  values:<br/>    prometheus:<br/>      rbacPrometheus: true<br/>      serviceAccount: metallb<br/>      namespace: networking<br/>      serviceMonitor:<br/>        enabled: true<br/>        controller:<br/>          additionalLabels:<br/>            release: kube-prometheus-stack<br/>        speaker:<br/>          additionalLabels:<br/>            release: kube-prometheus-stack</span></pre><p id="253f" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">ç„¶åï¼Œæˆ‘ä»¬å°†å£°æ˜ä¸€ä¸ª<code class="fe mq mr ms mt b">IPAddressPool</code>æ¥æä¾›ä¸€ç³»åˆ—IPä¾›<code class="fe mq mr ms mt b">LoadBalancer</code>æœåŠ¡ç¨åä½¿ç”¨ã€‚æ­£å¦‚æˆ‘ä»¬ä¹‹å‰æåˆ°çš„ï¼ŒTailscaleçš„å­ç½‘è·¯ç”±å™¨åœ¨VPNä¸­é€šå‘Šäº†<code class="fe mq mr ms mt b">192.168.0.0/24</code> CIDRï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿<code class="fe mq mr ms mt b">IPAddressPool</code>ä¸­å£°æ˜çš„IPè¦†ç›–äº†è¿™ä¸ªèŒƒå›´ï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥ä»VPNå¯»å€ã€‚</p><pre class="na nb nc nd gt ng mt nh bn ni nj bi"><span id="a8fd" class="nk lf it mt b be nl nm l nn no">apiVersion: metallb.io/v1beta1<br/>kind: IPAddressPool<br/>metadata:<br/>  name: load-balancer<br/>spec:<br/>  addresses:<br/>    - 192.168.0.50-192.168.0.99</span></pre><p id="ac30" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ªIPæ± ä¸ä¼šåœ¨æœ¬åœ°ç½‘ç»œä¸­å…¬å¸ƒï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª<code class="fe mq mr ms mt b">L2Advertisement</code>æ¥è¿™æ ·åšã€‚å¦åˆ™ï¼Œæµé‡ä¸ä¼šè¢«è·¯ç”±åˆ°è¿™äº›IPã€‚</p><pre class="na nb nc nd gt ng mt nh bn ni nj bi"><span id="c0c8" class="nk lf it mt b be nl nm l nn no">apiVersion: metallb.io/v1beta1<br/>kind: L2Advertisement<br/>metadata:<br/>  name: l2advertisement<br/>spec:<br/>  ipAddressPools:<br/>    - load-balancer</span></pre><p id="4ca9" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">å¦‚æœä½ æƒ³çŸ¥é“Metallbæ˜¯å¦‚ä½•åœ¨å¹•ååšL2å¹¿å‘Šçš„ï¼Œçœ‹çœ‹è¿™äº›<a class="ae ld" href="https://metallb.universe.tf/configuration/_advanced_l2_configuration/" rel="noopener ugc nofollow" target="_blank">æ–‡ä»¶</a>ã€‚</p><h1 id="d963" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">DuckDNS</h1><p id="8619" class="pw-post-body-paragraph kf kg it kh b ki mc kk kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc im bi translated">ä¸‹ä¸€æ­¥å°†æ˜¯å»ºç«‹ä¸€ä¸ªå…¬å…±DNSè®°å½•æ¥è§£ææˆ‘ä»¬çš„å…¬å…±IPï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä»å¤–éƒ¨ç½‘ç»œå¯»å€æˆ‘ä»¬çš„é›†ç¾¤ã€‚è¿™å°†ä½¿æˆ‘ä»¬èƒ½å¤Ÿè§£å†³DNS01æŒ‘æˆ˜ï¼Œä»¥ä¾¿ç¨åä½¿ç”¨â€œè®©æˆ‘ä»¬åŠ å¯†â€æ¥é¢å‘TLSè¯ä¹¦ã€‚æˆ‘ä»¬å°†ä½¿ç”¨<a class="ae ld" href="https://www.duckdns.org/" rel="noopener ugc nofollow" target="_blank"> DuckDNS </a>ï¼Œä¸€ä¸ªå…è´¹æä¾›<code class="fe mq mr ms mt b">duckdns.org</code>å­åŸŸåçš„DNSæä¾›å•†ã€‚</p><p id="9cc9" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">å› ä¸ºæˆ‘æœ‰ä¸€ä¸ªåŠ¨æ€çš„IPåœ°å€ï¼Œæ‰€ä»¥æˆ‘éœ€è¦å®šæœŸæ›´æ–°DNSè®°å½•ï¼Œè¿™æœ‰å¯èƒ½é€šè¿‡<a class="ae ld" href="https://hub.docker.com/r/linuxserver/duckdns" rel="noopener ugc nofollow" target="_blank"> linuxserver/duckdns </a>æ˜ åƒè‡ªåŠ¨å®Œæˆã€‚å®ƒåœ¨å†…éƒ¨åˆ›å»ºä¸€ä¸ªcrontabï¼Œä½¿ç”¨DuckDNS APIå®šæœŸæ›´æ–°æ‚¨çš„å…¬å…±IPã€‚</p><pre class="na nb nc nd gt ng mt nh bn ni nj bi"><span id="a47d" class="nk lf it mt b be nl nm l nn no">apiVersion: helm.toolkit.fluxcd.io/v2beta1<br/>kind: HelmRelease<br/>metadata:<br/>  name: duckdns<br/>spec:<br/>  releaseName: duckdns<br/>  chart:<br/>    spec:<br/>      chart: duckdns<br/>      sourceRef:<br/>        kind: HelmRepository<br/>        name: mmontes<br/>        namespace: flux-system<br/>      version: "0.3.0"<br/>  interval: 5m<br/>  values:<br/>    image:<br/>      repository: linuxserver/duckdns<br/>      pullPolicy: IfNotPresent<br/>      tag: 0168fda3-ls117<br/><br/>    subdomains:<br/>      - mmontes.duckdns.org<br/>    ...<br/>    secretRef:<br/>      name: duckdns</span></pre><h1 id="fd29" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">è¯ä¹¦ç®¡ç†å™¨</h1><p id="9edd" class="pw-post-body-paragraph kf kg it kh b ki mc kk kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc im bi translated">å¦‚æœä¸æ­£ç¡®åœ°è‡ªåŠ¨åŒ–TLSè¯ä¹¦çš„é¢å‘å’Œè½®æ¢ï¼Œä¼šä½¿æ‚¨çš„ç¾¤é›†æ“ä½œå˜å¾—éå¸¸å¤æ‚ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<a class="ae ld" href="https://cert-manager.io/" rel="noopener ugc nofollow" target="_blank"> cert-manager </a>ï¼Œå®ƒæ˜¯ä¸€ä¸ªKubernetesæ“ä½œè€…ï¼Œè´Ÿè´£åœ¨æ‚¨çš„Kubernetesé›†ç¾¤ä¸­é¢å‘å’Œæ›´æ–°x.509è¯ä¹¦ã€‚</p><p id="5173" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">å®ƒæ”¯æŒå¤šä¸ªè¯ä¹¦æºï¼ŒåŒ…æ‹¬é›†ç¾¤å†…CAsã€Hashicorp Vaultã€Venafiå’ŒLet's Encryptã€‚ç”±äºæˆ‘ä»¬æƒ³è¦ä¸€ä¸ªç”±æ‰€æœ‰å®¢æˆ·ç«¯éƒ½ä¿¡ä»»çš„å…¬å…±CAé¢å‘çš„è¯ä¹¦ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è‡ªåŠ¨åŒ–è¯ä¹¦ç®¡ç†ç¯å¢ƒ(<a class="ae ld" href="https://cert-manager.io/docs/configuration/acme/" rel="noopener ugc nofollow" target="_blank"> ACME </a>)é¢å‘è€…åœ¨<a class="ae ld" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank">è®©æˆ‘ä»¬åŠ å¯†</a>ä¸­é¢å‘è¯ä¹¦ã€‚</p><p id="3e49" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">ç¬¬ä¸€ä»¶äº‹å°†æ˜¯ä½¿ç”¨å¦ä¸€ä¸ª<code class="fe mq mr ms mt b">HelmRelease</code>èµ„æºå®‰è£…cert-managerã€‚è¯·æ³¨æ„ï¼Œæˆ‘ä»¬å·²ç»å¯ç”¨äº†ä¸€ä¸ªå®éªŒæ€§çš„ç‰¹æ€§gateæ¥ä¸Gateway APIé›†æˆï¼Œæˆ‘ä»¬å°†åœ¨åé¢è¿›è¡Œä»‹ç»ã€‚</p><pre class="na nb nc nd gt ng mt nh bn ni nj bi"><span id="0c93" class="nk lf it mt b be nl nm l nn no">apiVersion: helm.toolkit.fluxcd.io/v2beta1<br/>kind: HelmRelease<br/>metadata:<br/>  name: cert-manager<br/>spec:<br/>  chart:<br/>    spec:<br/>      chart: cert-manager<br/>      sourceRef:<br/>        kind: HelmRepository<br/>        name: jetstack<br/>      version: "1.10.1"<br/>  interval: 1h0m0s<br/>  values:<br/>    installCRDs: true<br/>    featureGates: "ExperimentalGatewayAPISupport=true"<br/>    prometheus:<br/>      enabled: true<br/>      servicemonitor:<br/>        enabled: true<br/>        prometheusInstance: kube-prometheus-stack<br/>        labels:<br/>          release: kube-prometheus-stack</span></pre><p id="889c" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><code class="fe mq mr ms mt b">Certificate</code>èµ„æºæ˜¯ä¸è¯ä¹¦ç®¡ç†å™¨äº¤äº’çš„æ–¹å¼ã€‚å®ƒä»¬å¼•ç”¨äº†<code class="fe mq mr ms mt b">Issuer</code>æˆ–<code class="fe mq mr ms mt b">ClusterIssuer</code>èµ„æºï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å°†è¦é…ç½®çš„ã€‚æˆ‘ä»¬å°†ä¸ºLet'såˆ›å»ºä¸€ä¸ª<code class="fe mq mr ms mt b">ClusterIssuer</code>,ç”¨<a class="ae ld" href="https://cert-manager.io/docs/configuration/acme/dns01/" rel="noopener ugc nofollow" target="_blank"> DNS01æŒ‘æˆ˜æ±‚è§£å™¨</a>è¿›è¡ŒåŠ å¯†ï¼Œä»¥ä¾¿å‘å¸ƒé€šé…ç¬¦è¯ä¹¦ã€‚è¿™ä¸ªè§£ç®—å™¨åœ¨DuckDNSä¸­åˆ›å»ºäº†ä¸€ä¸ªTXTè®°å½•ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥éªŒè¯æˆ‘ä»¬æ˜¯è¿™ä¸ªåŸŸåçš„åˆæ³•æ‰€æœ‰è€…ã€‚</p><p id="df6f" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">ä¸å¹¸çš„æ˜¯ï¼Œè¯ä¹¦ç®¡ç†å™¨æœ¬èº«ä¸æ”¯æŒDuckDNSï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨<a class="ae ld" href="https://cert-manager.io/docs/configuration/acme/dns01/webhook/" rel="noopener ugc nofollow" target="_blank"> webhook </a>è§£ç®—å™¨ã€‚è¿™ä¸ª<a class="ae ld" href="https://github.com/ebrianne/cert-manager-webhook-duckdns/tree/master/deploy/cert-manager-webhook-duckdns" rel="noopener ugc nofollow" target="_blank">èˆµå›¾</a>å¾ˆå¥½çš„æŠ½è±¡äº†<code class="fe mq mr ms mt b">ClusterIssuer</code>å’Œå‡†å…¥webhookæœåŠ¡å™¨çš„åˆ›å»ºã€‚</p><pre class="na nb nc nd gt ng mt nh bn ni nj bi"><span id="9a97" class="nk lf it mt b be nl nm l nn no">apiVersion: helm.toolkit.fluxcd.io/v2beta1<br/>kind: HelmRelease<br/>metadata:<br/>  name: letsencrypt<br/>spec:<br/>  chart:<br/>    spec:<br/>      chart: cert-manager-webhook-duckdns<br/>      sourceRef:<br/>        kind: HelmRepository<br/>        name: letsencrypt<br/>      version: "v1.2.4"<br/>  interval: 1h0m0s<br/>  values:<br/>    fullnameOverride: letsencrypt<br/>    groupName: mmontes.io<br/><br/>    certManager:<br/>      namespace: pki<br/>      serviceAccountName: cert-manager<br/><br/>    secret:<br/>      existingSecret: true<br/>      existingSecretName: "duckdns"<br/><br/>    clusterIssuer:<br/>      email: martin11lrx@gmail.com<br/>      staging:<br/>        create: true<br/>      production:<br/>        create: true</span></pre><p id="05d9" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">ä¸€æ—¦ä¸€åˆ‡å°±ç»ªå¹¶å¼€å§‹è¿è¡Œï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°æ‚¨çš„<code class="fe mq mr ms mt b">ClusterIssuer</code>èµ„æºå·²ç»å‡†å¤‡å¥½å‘å¸ƒè¯ä¹¦ã€‚</p><pre class="na nb nc nd gt ng mt nh bn ni nj bi"><span id="49ee" class="nk lf it mt b be nl nm l nn no">mmontes@k8s-master:~$ kubectl get clusterissuer -n pki -o wide<br/>NAME                     READY   STATUS                                                 AGE<br/>letsencrypt-production   True    The ACME account was registered with the ACME server   21h<br/>letsencrypt-staging      True    The ACME account was registered with the ACME server   21h</span></pre><h1 id="92e8" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">ç½‘å…³API</h1><p id="0066" class="pw-post-body-paragraph kf kg it kh b ki mc kk kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc im bi translated">ç”±äºGateway APIä»å¤„äºæ—©æœŸé˜¶æ®µï¼Œå®ƒè¿˜æ²¡æœ‰ä¸Kubernetesä¸€èµ·å¼€ç®±å³ç”¨ã€‚æ­£å¦‚åœ¨<a class="ae ld" href="https://gateway-api.sigs.k8s.io/guides/#install-experimental-channel" rel="noopener ugc nofollow" target="_blank">æ–‡æ¡£</a>ä¸­æ‰€æè¿°çš„ï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…ä¸€ä¸ªåŒ…å«CRDå’Œè®¸å¯webhookæœåŠ¡å™¨çš„æ¸…å•åŒ…æ¥éªŒè¯å®ƒä»¬ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åè°ƒè¿™ä¸ªæŒ‡å‘æˆ‘ä»¬çš„å›è´­è·¯å¾„çš„<code class="fe mq mr ms mt b">Kustomization</code>æ¥å®‰è£…å®ƒä»¬ã€‚</p><pre class="na nb nc nd gt ng mt nh bn ni nj bi"><span id="ce1d" class="nk lf it mt b be nl nm l nn no">apiVersion: kustomize.toolkit.fluxcd.io/v1beta2<br/>kind: Kustomization<br/>metadata:<br/>  name: gateway-api<br/>  namespace: flux-system<br/>spec:<br/>  interval: 5m<br/>  sourceRef:<br/>    kind: GitRepository<br/>    name: flux-system<br/>  path: ./infrastructure/gateway-api<br/>  prune: true<br/>  timeout: 5m</span></pre><p id="bd77" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">å½“æˆ‘ä»¬å®Œæˆæ—¶ï¼Œæˆ‘ä»¬å°†é…ç½®<code class="fe mq mr ms mt b">GatewayClass</code>å’Œ<code class="fe mq mr ms mt b">Gateway</code>èµ„æºã€‚æ­£å¦‚æˆ‘ä»¬ä¹‹å‰æåˆ°çš„ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯æŠ½è±¡æˆ‘ä»¬æ­£åœ¨å»ºç«‹çš„è¿æ¥ï¼Œå› æ­¤åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜åªéœ€è¦å†³å®šä»–ä»¬æ˜¯åœ¨ä»–ä»¬çš„<code class="fe mq mr ms mt b">HTTPRoute</code>èµ„æºä¸­å¼•ç”¨å†…éƒ¨çš„è¿˜æ˜¯å¤–éƒ¨çš„<code class="fe mq mr ms mt b">Gateway</code>ã€‚</p><p id="b3ee" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">å…³äºå¹³å°æ–¹é¢çš„äº‹æƒ…ï¼Œcert-managerå¯ä»¥è‡ªåŠ¨ä¸ºæˆ‘ä»¬çš„<code class="fe mq mr ms mt b">Gateway</code>èµ„æºé¢å‘TLSè¯ä¹¦ï¼Œæˆ‘ä»¬åªéœ€è¦æ·»åŠ <code class="fe mq mr ms mt b">cert-manager.io/cluster-issuer</code>æ³¨é‡Šæ¥æŒ‡ç¤ºæˆ‘ä»¬æƒ³è¦ä½¿ç”¨å“ªä¸ª<code class="fe mq mr ms mt b">ClusterIssuer</code>ã€‚åœ¨è¿™äº›åœºæ™¯ä¸‹ï¼Œcert-managerå°†ç›‘è§†å¸¦æ³¨é‡Šçš„<code class="fe mq mr ms mt b">Gateway</code>èµ„æºï¼Œå¹¶ä¸º<code class="fe mq mr ms mt b">listeners</code>æ•°ç»„ä¸‹çš„<code class="fe mq mr ms mt b">hostname</code>å­—æ®µé¢å‘è¯ä¹¦ã€‚</p><pre class="na nb nc nd gt ng mt nh bn ni nj bi"><span id="b6e0" class="nk lf it mt b be nl nm l nn no">apiVersion: gateway.networking.k8s.io/v1alpha2<br/>kind: GatewayClass<br/>metadata:<br/>  name: traefik-external<br/>  labels:<br/>    gatewayclass.mmontes.io/type: traefik-external<br/>spec:<br/>  controllerName: traefik.io/gateway-controller<br/>---<br/>apiVersion: gateway.networking.k8s.io/v1beta1<br/>kind: Gateway<br/>metadata:<br/>  name: traefik-external<br/>  annotations:<br/>    cert-manager.io/cluster-issuer: letsencrypt-production<br/>spec:<br/>  gatewayClassName: traefik-external<br/>  listeners:<br/>    - name: websecure<br/>      port: 8443<br/>      protocol: HTTPS<br/>      hostname: "*.mmontes.duckdns.org"<br/>      allowedRoutes:<br/>        namespaces:<br/>          from: All<br/>      tls:<br/>        mode: Terminate<br/>        certificateRefs:<br/>          - name: websecure-external-tls<br/>            kind: Secret<br/>            group: core</span></pre><p id="350b" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">æˆ‘ä»¬éœ€è¦å¦ä¸€ä¸ªä¸“ç”¨äºå†…éƒ¨æµé‡çš„<code class="fe mq mr ms mt b">Gateway</code>å’Œ<code class="fe mq mr ms mt b">GatewayClass</code>å®ä¾‹ã€‚å”¯ä¸€çš„åŒºåˆ«æ˜¯<code class="fe mq mr ms mt b">Gateway</code>å°†åŒ¹é…<code class="fe mq mr ms mt b">internal.mmontes.duckdns.org</code>ä¸»æœºåã€‚</p><pre class="na nb nc nd gt ng mt nh bn ni nj bi"><span id="3d37" class="nk lf it mt b be nl nm l nn no">apiVersion: gateway.networking.k8s.io/v1alpha2<br/>kind: GatewayClass<br/>metadata:<br/>  name: traefik-internal<br/>  labels:<br/>    gatewayclass.mmontes.io/type: traefik-internal<br/>spec:<br/>  controllerName: traefik.io/gateway-controller<br/>---<br/>apiVersion: gateway.networking.k8s.io/v1beta1<br/>kind: Gateway<br/>metadata:<br/>  name: traefik-internal<br/>  annotations:<br/>    cert-manager.io/cluster-issuer: letsencrypt-production<br/>spec:<br/>  gatewayClassName: traefik-internal<br/>  listeners:<br/>    - name: websecure<br/>      port: 8443<br/>      protocol: HTTPS<br/>      hostname: "*.internal.mmontes.duckdns.org"<br/>      allowedRoutes:<br/>        namespaces:<br/>          from: All<br/>      tls:<br/>        mode: Terminate<br/>        certificateRefs:<br/>          - name: websecure-internal-tls<br/>            kind: Secret<br/>            group: core</span></pre><p id="ba5a" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå·²å®‰è£…çš„<code class="fe mq mr ms mt b">Gateway</code>èµ„æºæ²¡æœ‰åœ¨æˆ‘ä»¬çš„é›†ç¾¤ä¸­è¿è¡Œçš„å®ç°ï¼Œå› æ­¤å®ƒä»¬å°†ä¿æŒæœªå°±ç»ªçŠ¶æ€ï¼Œç›´åˆ°æˆ‘ä»¬æä¾›ä¸€ä¸ªå®ç°ã€‚</p><h1 id="4c14" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">ç‰¹æ‹‰è²å…‹</h1><p id="dcf8" class="pw-post-body-paragraph kf kg it kh b ki mc kk kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc im bi translated">å®‰è£…ç½‘å…³APIèµ„æºåï¼Œæˆ‘ä»¬å°†å®‰è£…<a class="ae ld" href="https://doc.traefik.io/traefik/providers/kubernetes-gateway/" rel="noopener ugc nofollow" target="_blank"> Traefik </a>æ¥åè°ƒå®ƒä»¬ï¼Œå¹¶é…ç½®é›†ç¾¤çš„å…¥å£ã€‚æ­£å¦‚æˆ‘ä»¬åœ¨å‰é¢çš„ç« èŠ‚ä¸­æ‰€æè¿°çš„ï¼Œç›®æ ‡æ¶æ„å°†æœ‰ä¸¤ä¸ªTraefikå®ä¾‹æ¥æ»¡è¶³æˆ‘ä»¬çš„è¿æ¥éœ€æ±‚:<code class="fe mq mr ms mt b">traefik-internal</code>å’Œ<code class="fe mq mr ms mt b">traefik-external</code>ã€‚</p><p id="0ed5" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">å‰ä¸€ä¸ªå°†ä½¿ç”¨æ¥è‡ª<code class="fe mq mr ms mt b">traefik-internal</code> <code class="fe mq mr ms mt b">Gateway</code>çš„é…ç½®ï¼Œå¹¶å°†é€šè¿‡åœ¨<code class="fe mq mr ms mt b">192.168.0.50</code> IPä¸­å…¬å¸ƒçš„<code class="fe mq mr ms mt b">LoadBalancer</code>å…¬å¼€ï¼Œç¨åå°†ç”±æœ¬åœ°DNSè§£æã€‚</p><pre class="na nb nc nd gt ng mt nh bn ni nj bi"><span id="09e7" class="nk lf it mt b be nl nm l nn no">apiVersion: helm.toolkit.fluxcd.io/v2beta1<br/>kind: HelmRelease<br/>metadata:<br/>  name: traefik-internal<br/>spec:<br/>  chart:<br/>    spec:<br/>      chart: traefik<br/>      sourceRef:<br/>        kind: HelmRepository<br/>        name: traefik<br/>      version: "20.8.0"<br/>  interval: 1h0m0s<br/>  values:<br/>    ...<br/>    additionalArguments:<br/>      - "--experimental.kubernetesgateway"<br/>      - "--providers.kubernetesgateway"<br/>      - "--providers.kubernetesgateway.labelselector=gatewayclass.mmontes.io/type=traefik-internal"<br/>    service:<br/>      annotations:<br/>        metallb.universe.tf/loadBalancerIPs: 192.168.0.50<br/>    deployment:<br/>      enabled: true<br/>      kind: DaemonSet<br/>    resources:<br/>      requests:<br/>        cpu: "300m"<br/>        memory: "200Mi"<br/>      limits:<br/>        memory: "200Mi"</span></pre><p id="dc8c" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">è€Œåè€…å°†ä½¿ç”¨åœ¨<code class="fe mq mr ms mt b">traefik-external</code> <code class="fe mq mr ms mt b">Gateway</code>èµ„æºä¸­æä¾›çš„é…ç½®ï¼Œå¹¶é€šè¿‡åœ¨<code class="fe mq mr ms mt b">192.168.0.90</code> IPä¸­å…¬å¸ƒçš„<code class="fe mq mr ms mt b">LoadBalancer</code>å…¬å¼€ï¼Œç¨åæˆ‘ä»¬å°†é€šè¿‡è·¯ç”±å™¨ä¸­çš„ç«¯å£è½¬å‘å‘äº’è”ç½‘å…¬å¼€ã€‚</p><pre class="na nb nc nd gt ng mt nh bn ni nj bi"><span id="e33e" class="nk lf it mt b be nl nm l nn no">apiVersion: helm.toolkit.fluxcd.io/v2beta1<br/>kind: HelmRelease<br/>metadata:<br/>  name: traefik-external<br/>spec:<br/>  chart:<br/>    spec:<br/>      chart: traefik<br/>      sourceRef:<br/>        kind: HelmRepository<br/>        name: traefik<br/>      version: "20.8.0"<br/>  interval: 1h0m0s<br/>  values:<br/>    ...<br/>    additionalArguments:<br/>      - "--serverstransport.insecureskipverify"<br/>      - "--experimental.kubernetesgateway"<br/>      - "--providers.kubernetesgateway"<br/>      - "--providers.kubernetesgateway.labelselector=gatewayclass.mmontes.io/type=traefik-external"<br/>    service:<br/>      annotations:<br/>        metallb.universe.tf/loadBalancerIPs: 192.168.0.90<br/>    deployment:<br/>      enabled: true<br/>      kind: DaemonSet<br/>    resources:<br/>      requests:<br/>        cpu: "300m"<br/>        memory: "200Mi"<br/>      limits:<br/>        memory: "200Mi"</span></pre><p id="627b" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">å½“Traefikå®ä¾‹å¯åŠ¨å¹¶è¿è¡Œæ—¶ï¼Œ<code class="fe mq mr ms mt b">Gateway</code>èµ„æºåº”è¯¥å‡†å¤‡å¥½äº†ã€‚</p><pre class="na nb nc nd gt ng mt nh bn ni nj bi"><span id="363b" class="nk lf it mt b be nl nm l nn no">mmontes@k8s-master:~$ kubectl get gateway -n networking<br/>NAME               CLASS              ADDRESS   READY   AGE<br/>traefik-external   traefik-external             True    11d<br/>traefik-internal   traefik-internal             True    11d</span></pre><h1 id="b277" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">åº”ç”¨ç¨‹åº</h1><p id="6ae7" class="pw-post-body-paragraph kf kg it kh b ki mc kk kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc im bi translated">æ­¤æ—¶ï¼Œæˆ‘ä»¬èƒ½å¤Ÿé…ç½®<code class="fe mq mr ms mt b">HTTPRoute</code>èµ„æºï¼Œä»¥ä¾¿é€šè¿‡æ–°çš„<code class="fe mq mr ms mt b">Gateways</code>å…¬å¼€æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚ç¬¬ä¸€ä¸ªå°†æ˜¯<a class="ae ld" href="https://github.com/mmontes11/github-explorer" rel="noopener ugc nofollow" target="_blank"> GitHub explorer </a>ï¼Œå®ƒå°†å¯¹å…¬å…±äº’è”ç½‘ä¸Šçš„ä»»ä½•äººå¼€æ”¾ã€‚</p><pre class="na nb nc nd gt ng mt nh bn ni nj bi"><span id="76aa" class="nk lf it mt b be nl nm l nn no">apiVersion: gateway.networking.k8s.io/v1beta1<br/>kind: HTTPRoute<br/>metadata:<br/>  name: github-explorer<br/>spec:<br/>  hostnames:<br/>    - github-explorer.mmontes.duckdns.org<br/>  parentRefs:<br/>    - group: gateway.networking.k8s.io<br/>      kind: Gateway<br/>      name: traefik-external<br/>      namespace: networking<br/>  rules:<br/>    - backendRefs:<br/>      - kind: Service<br/>        name: github-explorer<br/>        port: 80</span></pre><p id="d931" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">å¦ä¸€ä¸ªå°†æ˜¯Grafanaï¼Œä½†åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒå°†åªåœ¨å†…éƒ¨æ›å…‰ã€‚</p><pre class="na nb nc nd gt ng mt nh bn ni nj bi"><span id="7924" class="nk lf it mt b be nl nm l nn no">apiVersion: gateway.networking.k8s.io/v1beta1<br/>kind: HTTPRoute<br/>metadata:<br/>  name: grafana<br/>spec:<br/>  parentRefs:<br/>    - name: traefik-internal<br/>      namespace: networking<br/>  hostnames:<br/>    - "grafana.internal.mmontes.duckdns.org"<br/>  rules:<br/>    - backendRefs:<br/>      - kind: Service<br/>        name: kube-prometheus-stack-grafana<br/>        port: 80</span></pre><h1 id="7f81" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">çš®éœå°”</h1><p id="b97e" class="pw-post-body-paragraph kf kg it kh b ki mc kk kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc im bi translated">æ—¢ç„¶<code class="fe mq mr ms mt b">traefik-internal</code>æ­£åœ¨ä¸º<code class="fe mq mr ms mt b">192.168.0.50</code> IPä¸Šçš„æµé‡æä¾›æœåŠ¡ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æˆ‘ä»¬çš„VPNä¸­é…ç½®ä¸€ä¸ªæœ¬åœ°DNSæ¥å°†<code class="fe mq mr ms mt b">internal.mmontes.duckdns.org</code>è§£æåˆ°é‚£ä¸ªIPã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†éƒ¨ç½²ä¸€ä¸ª<a class="ae ld" href="https://pi-hole.net/" rel="noopener ugc nofollow" target="_blank"> Pihole </a>ä½œä¸ºæˆ‘ä»¬çš„æœ¬åœ°DNSæœåŠ¡å™¨ã€‚</p><pre class="na nb nc nd gt ng mt nh bn ni nj bi"><span id="7bf0" class="nk lf it mt b be nl nm l nn no">apiVersion: helm.toolkit.fluxcd.io/v2beta1<br/>kind: HelmRelease<br/>metadata:<br/>  name: pihole<br/>spec:<br/>  releaseName: pihole<br/>  chart:<br/>    spec:<br/>      chart: pihole<br/>      sourceRef:<br/>        kind: HelmRepository<br/>        name: pihole<br/>      version: "2.11.0"<br/>  interval: 1h0m0s<br/>  values:<br/>    image:<br/>      repository: "pihole/pihole"<br/>      pullPolicy: IfNotPresent<br/><br/>    serviceDns:<br/>      mixedService: false<br/>      type: LoadBalancer<br/>      port: 53<br/>      externalTrafficPolicy: Local<br/>      annotations:<br/>        metallb.universe.tf/loadBalancerIPs: 192.168.0.53<br/>        metallb.universe.tf/allow-shared-ip: pihole-dns-tcp,pihole-dns-udp<br/>    ...    <br/>    dnsmasq:<br/>      customDnsEntries:<br/>        - address=/internal.mmontes.duckdns.org/192.168.0.50</span></pre><p id="6fa3" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">å¦‚æ‚¨æ‰€çŸ¥ï¼Œæœ¬åœ°DNSæœåŠ¡å™¨å°†åœ¨<code class="fe mq mr ms mt b">192.168.0.53</code> IPä¸Šå¯ç”¨ï¼Œè¿™ä¹Ÿæ˜¯Tailscaleå­ç½‘è·¯ç”±å™¨é€šå‘Šçš„ã€‚ç°åœ¨æˆ‘ä»¬èƒ½å¤Ÿé…ç½®Tailscaleæ¥ä½¿ç”¨è¿™ä¸ªDNSæœåŠ¡å™¨ã€‚</p><figure class="na nb nc nd gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oi"><img src="../Images/cb70d1344471a3534b0ac0e7185ff6ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6A11hf_Eh-qsJYr4PoM1rA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">Tailscale DNSé…ç½®ã€‚åœ¨DNS &gt;æ·»åŠ åç§°æœåŠ¡å™¨&gt;è‡ªå®šä¹‰ä¸­å¯ç”¨</figcaption></figure><h1 id="cc60" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">è·¯ç”±å™¨</h1><p id="b040" class="pw-post-body-paragraph kf kg it kh b ki mc kk kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc im bi translated">æœ€åä½†åŒæ ·é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦å°†<code class="fe mq mr ms mt b">192.168.0.90</code>å…¬å¼€ç»™äº’è”ç½‘ï¼Œä»¥ä½¿<code class="fe mq mr ms mt b">traefik-external</code>å…¬å¼€çš„åº”ç”¨ç¨‹åºå¯ç”¨ã€‚</p><figure class="na nb nc nd gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oj"><img src="../Images/344f7da21692d6580b3a0eaf3e56869a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VTUfd1yZU7wcU9KkL8gL-w.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">åœ¨è·¯ç”±å™¨ä¸­é…ç½®ç«¯å£è½¬å‘</figcaption></figure><p id="ab12" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">å¯é€‰åœ°ï¼Œæœ¬åœ°DNSå¯ä»¥è¢«é…ç½®ä¸ºæœ¬åœ°ç½‘ç»œçš„DNSï¼Œè¿™æ ·æœ¬åœ°ç½‘ç»œå†…éƒ¨çš„è®¾å¤‡ä¸éœ€è¦è¿æ¥åˆ°VPNæ¥è®¿é—®å†…éƒ¨åº”ç”¨ã€‚å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼ŒPiholeå°†åœ¨DNSçº§åˆ«é˜»æ­¢å¹¿å‘Šã€‚</p><h1 id="deb0" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">æµ‹è¯•è¿é€šæ€§</h1><p id="1761" class="pw-post-body-paragraph kf kg it kh b ki mc kk kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc im bi translated">æœ€åï¼Œå…³é”®æ—¶åˆ»åˆ°äº†ï¼Œæˆ‘ä»¬å°†åœ¨ä¸åŒçš„åœºæ™¯ä¸­æµ‹è¯•è®¿é—®å¤–éƒ¨åº”ç”¨ç¨‹åº<code class="fe mq mr ms mt b"><a class="ae ld" href="https://github-explorer.mmontes.duckdns.org/" rel="noopener ugc nofollow" target="_blank">https://github-explorer.mmontes.duckdns.org</a></code>å’Œå†…éƒ¨åº”ç”¨ç¨‹åº<code class="fe mq mr ms mt b"><a class="ae ld" href="https://grafana.internal.mmontes.duckdns.org/" rel="noopener ugc nofollow" target="_blank">https://grafana.internal.mmontes.duckdns.org</a></code>çš„è¿æ¥æ€§ã€‚</p><p id="f550" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">è®©æˆ‘ä»¬ä»Tailscale VPNå†…éƒ¨è®¿é—®:</p><figure class="na nb nc nd gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ok"><img src="../Images/af34dfed8cef2212808629863270e81d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*44yzkjsSimW8En2rPVaZOg.gif"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">ä»Tailscale VPNæˆåŠŸè®¿é—®å¤–éƒ¨åº”ç”¨ç¨‹åº</figcaption></figure><figure class="na nb nc nd gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ok"><img src="../Images/ec9a280a1bdcc0d388acc364042b2f54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*JROuJzpw1EkEr1EEi9Mtsw.gif"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">ä»Tailscale VPNæˆåŠŸè®¿é—®å†…éƒ¨åº”ç”¨ç¨‹åº</figcaption></figure><p id="2437" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">é€šè¿‡ä½¿ç”¨Tailscale DNSæœåŠ¡å™¨<code class="fe mq mr ms mt b">100.100.100.100</code>è§£æå®ƒä»¬çš„DNSåç§°ï¼Œæˆ‘ä»¬æˆåŠŸåœ°è¿æ¥åˆ°äº†è¿™ä¸¤ä¸ªåº”ç”¨ç¨‹åºã€‚è®©æˆ‘ä»¬å†è¯•ä¸€æ¬¡ï¼Œä½†è¿™æ¬¡æ˜¯ä»å¤–éƒ¨ç½‘ç»œè¿æ¥ã€‚</p><figure class="na nb nc nd gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ok"><img src="../Images/2f2e2efcc610749a33ff312eae283a6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*5mE39LAW81ZW1Tnqa6-oig.gif"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">ä»å¤–éƒ¨ç½‘ç»œæˆåŠŸè®¿é—®å¤–éƒ¨åº”ç”¨ç¨‹åº</figcaption></figure><figure class="na nb nc nd gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ok"><img src="../Images/3e60e4a7aedb290293cb8f7701f839bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*Uu8FDweLOfH4V1-d8Fk1RA.gif"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">è¯•å›¾ä»å¤–éƒ¨ç½‘ç»œè®¿é—®å†…éƒ¨åº”ç”¨ç¨‹åº</figcaption></figure><p id="81fb" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">æˆ‘ä»¬è®¾æ³•è¿æ¥åˆ°å¤–éƒ¨åº”ç”¨ç¨‹åºï¼Œä½†åœ¨å°è¯•è¿æ¥åˆ°å†…éƒ¨åº”ç”¨ç¨‹åºæ—¶ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ª404é”™è¯¯ï¼Œè¿™æ˜¯é¢„æœŸçš„è¡Œä¸ºã€‚åœ¨å¼•æ“ç›–ä¸‹ï¼Œå†…éƒ¨åº”ç”¨ç¨‹åºDNSè¢«è§£æä¸ºæˆ‘ä»¬çš„å…¬å…±IPï¼Œå› æ­¤æ­£åœ¨ç‚¹å‡»<code class="fe mq mr ms mt b">traefik-external</code>ï¼Œå®ƒæ²¡æœ‰æ³¨å†Œå†…éƒ¨åº”ç”¨ç¨‹åºã€‚</p><h1 id="2deb" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">åŒ…æ‰</h1><p id="5feb" class="pw-post-body-paragraph kf kg it kh b ki mc kk kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc im bi translated">æˆ‘ä»¬å·²ç»é‡Šæ”¾äº†æ–°çš„ç½‘å…³APIçš„åŠ›é‡æ¥è®¾è®¡ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼Œå®ç°å¹³å°å’Œåº”ç”¨ç¨‹åºå›¢é˜Ÿä¹‹é—´æ›´å¥½çš„åä½œã€‚æˆ‘ä»¬æŠ½è±¡äº†<code class="fe mq mr ms mt b">Gateway</code>èµ„æºä¸­çš„å¹³å°ç»†èŠ‚ï¼Œå› æ­¤åº”ç”¨å›¢é˜Ÿåªéœ€åœ¨<code class="fe mq mr ms mt b">HTTPRoutes</code>ä¸­å£°æ˜ä»–ä»¬çš„åº”ç”¨éœ€è¦å“ªç§è¿æ¥æ¨¡å‹ã€‚</p><p id="c91f" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">ä¸ºäº†ç»™é‚£äº›<code class="fe mq mr ms mt b">Gateways</code>æä¾›è¿æ¥ï¼Œæˆ‘ä»¬é€šè¿‡ä½¿ç”¨Metallbå’ŒTailscaleçš„ä¸€äº›å‡ºè‰²åŠŸèƒ½ï¼Œè®¾æ³•ä»æˆ‘ä»¬çš„VPNå†…éƒ¨å¯»å€æˆ‘ä»¬çš„<code class="fe mq mr ms mt b">LoadBalancer</code>IPã€‚è¿™å®ç°äº†åˆ°æˆ‘ä»¬åœ¨Kubernetesä¸­è¿è¡Œçš„å·¥ä½œè´Ÿè½½çš„åŠ å¯†ç‚¹å¯¹ç‚¹è¿æ¥ï¼Œä¸ä¼ ç»Ÿçš„é›†ä¸­å¼VPNè§£å†³æ–¹æ¡ˆç›¸æ¯”ï¼Œå»¶è¿Ÿæ›´ä½ã€‚</p><p id="bc93" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">é»‘å®¢å¿«ä¹ï¼æ„Ÿè°¢é˜…è¯»ã€‚</p></div><div class="ab cl ol om hx on" role="separator"><span class="oo bw bk op oq or"/><span class="oo bw bk op oq or"/><span class="oo bw bk op oq"/></div><div class="im in io ip iq"><h1 id="0eee" class="le lf it bd lg lh os lj lk ll ot ln lo lp ou lr ls lt ov lv lw lx ow lz ma mb bi translated">èµ„æº</h1><div class="np nq gp gr nr ns"><a href="https://github.com/mmontes11/k8s-bootstrap" rel="noopener  ugc nofollow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd iu gy z fp nx fr fs ny fu fw is bi translated">GitHub - mmontes11/k8s-bootstrap:ğŸš€ä½¿ç”¨kubeadmçš„Kubernetesé›†ç¾¤å¼•å¯¼</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">ä½¿ç”¨kubeadmçš„Kubernetesé›†ç¾¤å¼•å¯¼ã€‚</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">github.com</p></div></div><div class="ob l"><div class="oc l od oe of ob og jz ns"/></div></div></a></div><div class="np nq gp gr nr ns"><a href="https://github.com/mmontes11/k8s-infrastructure" rel="noopener  ugc nofollow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd iu gy z fp nx fr fs ny fu fw is bi translated">GitHub-mmontes 11/k8s-åŸºç¡€è®¾æ–½:ğŸ—ä½¿ç”¨Fluxçš„ï¸åŸºç¡€è®¾æ–½å’Œç§Ÿæˆ·å¼•å¯¼</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">ä½¿ç”¨Fluxçš„åŸºç¡€è®¾æ–½å’Œç§Ÿæˆ·å¼•å¯¼ã€‚å½“â€¦æ—¶ï¼ŒFluxä½¿ç”¨çš„æ¯ä¸ªç°‡çš„å…¥å£ç‚¹</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">github.com</p></div></div><div class="ob l"><div class="oh l od oe of ob og jz ns"/></div></div></a></div><ul class=""><li id="ff65" class="mh mi it kh b ki kj km kn kq mj ku mk ky ml lc mm mn mo mp bi translated"><a class="ae ld" href="https://github.com/kubernetes/community/tree/master/sig-network" rel="noopener ugc nofollow" target="_blank">https://github . com/kubernetes/community/tree/master/SIG-network</a></li><li id="0691" class="mh mi it kh b ki mu km mv kq mw ku mx ky my lc mm mn mo mp bi translated"><a class="ae ld" href="https://gateway-api.sigs.k8s.io/" rel="noopener ugc nofollow" target="_blank">https://gateway-api.sigs.k8s.io/</a></li><li id="aea6" class="mh mi it kh b ki mu km mv kq mw ku mx ky my lc mm mn mo mp bi translated"><a class="ae ld" href="https://tailscale.com/" rel="noopener ugc nofollow" target="_blank">https://tailscale.com/</a></li><li id="8029" class="mh mi it kh b ki mu km mv kq mw ku mx ky my lc mm mn mo mp bi translated"><a class="ae ld" href="https://tailscale.com/kb/1081/magicdns/" rel="noopener ugc nofollow" target="_blank">https://tailscale.com/kb/1081/magicdns/</a></li><li id="a9c4" class="mh mi it kh b ki mu km mv kq mw ku mx ky my lc mm mn mo mp bi translated"><a class="ae ld" href="https://tailscale.com/kb/1019/subnets/" rel="noopener ugc nofollow" target="_blank">https://tailscale.com/kb/1019/subnets/</a></li><li id="3a79" class="mh mi it kh b ki mu km mv kq mw ku mx ky my lc mm mn mo mp bi translated"><a class="ae ld" href="https://traefik.io/" rel="noopener ugc nofollow" target="_blank">https://traefik.io/</a></li><li id="afc6" class="mh mi it kh b ki mu km mv kq mw ku mx ky my lc mm mn mo mp bi translated"><a class="ae ld" href="https://doc.traefik.io/traefik/providers/kubernetes-gateway/" rel="noopener ugc nofollow" target="_blank">https://doc . trae fik . io/trae fik/providers/kubernetes-gateway/</a></li><li id="521f" class="mh mi it kh b ki mu km mv kq mw ku mx ky my lc mm mn mo mp bi translated"><a class="ae ld" href="https://metallb.universe.tf/" rel="noopener ugc nofollow" target="_blank">https://metallb.universe.tf/</a></li><li id="26e4" class="mh mi it kh b ki mu km mv kq mw ku mx ky my lc mm mn mo mp bi translated"><a class="ae ld" href="https://metallb.universe.tf/configuration/_advanced_l2_configuration/" rel="noopener ugc nofollow" target="_blank">https://metal lb . universe . TF/configuration/_ advanced _ L2 _ configuration/</a></li><li id="6946" class="mh mi it kh b ki mu km mv kq mw ku mx ky my lc mm mn mo mp bi translated"><a class="ae ld" href="https://cert-manager.io/" rel="noopener ugc nofollow" target="_blank">https://cert-manager.io/</a></li><li id="9b6b" class="mh mi it kh b ki mu km mv kq mw ku mx ky my lc mm mn mo mp bi translated">https://cert-manager.io/docs/configuration/acme/dns01/<a class="ae ld" href="https://cert-manager.io/docs/configuration/acme/" rel="noopener ugc nofollow" target="_blank"/></li><li id="9626" class="mh mi it kh b ki mu km mv kq mw ku mx ky my lc mm mn mo mp bi translated">ã€https://pi-hole.net/ T4ã€‘</li><li id="3c56" class="mh mi it kh b ki mu km mv kq mw ku mx ky my lc mm mn mo mp bi translated"><a class="ae ld" href="https://www.duckdns.org/" rel="noopener ugc nofollow" target="_blank">https://www.duckdns.org/</a></li><li id="047d" class="mh mi it kh b ki mu km mv kq mw ku mx ky my lc mm mn mo mp bi translated"><a class="ae ld" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank">https://letsencrypt.org/</a></li></ul></div></div>    
</body>
</html>