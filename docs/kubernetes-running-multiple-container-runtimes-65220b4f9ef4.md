# Kubernetes â€”è¿è¡Œå¤šä¸ªå®¹å™¨è¿è¡Œæ—¶

> åŸæ–‡ï¼š<https://itnext.io/kubernetes-running-multiple-container-runtimes-65220b4f9ef4?source=collection_archive---------0----------------------->

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘æƒ³å‘ä½ å±•ç¤ºå¦‚ä½•åœ¨ Kubernetes ä¸Šè¿è¡Œå¤šä¸ª OCI å®¹å™¨è¿è¡Œæ—¶ã€‚æ‚¨å°†çœ‹åˆ°å¦‚ä½•é…ç½® containerd æ¥è¿è¡Œ runC å’Œ Kata å®¹å™¨ã€‚ç„¶åæˆ‘ä»¬å°†ä½¿ç”¨ Kubernetes `RuntimeClass` API è®©å·¥ä½œè´Ÿè½½é€‰æ‹©ä¸åŒçš„å®¹å™¨è¿è¡Œæ—¶ã€‚

# ä¸ºä»€ä¹ˆä¸åŒçš„å®¹å™¨è¿è¡Œæ—¶

å½“å¤šä¸ªç§Ÿæˆ·å…±äº«ä¸€ä¸ªé›†ç¾¤æ—¶ï¼Œå·¥ä½œè´Ÿè½½çš„å¼‚æ„æ€§é€šå¸¸æ„å‘³ç€ä¸åŒçš„æ‰§è¡Œå’Œæ•°æ®ä¿¡ä»»è¾¹ç•Œã€‚è¿™æ ·çš„é›†ç¾¤æ‹¥æœ‰ä¸€ç»„ç®¡ç†å’Œæ“ä½œé›†ç¾¤æ‰€éœ€çš„å¯ä¿¡ä¸­å¤®æœåŠ¡ï¼ŒåŒæ—¶è¿˜æ‰˜ç®¡ä¸åŒç§Ÿæˆ·æ‹¥æœ‰çš„â€œä¸å¯ä¿¡â€å·¥ä½œè´Ÿè½½ï¼Œè¿™ç§æƒ…å†µå¹¶ä¸å°‘è§ã€‚è™½ç„¶ä¾èµ–äº Linux åç§°ç©ºé—´å’Œ cgroup çš„é€šç”¨å®¹å™¨åŒ–æ–¹æ³•å¯èƒ½é€‚åˆè¿è¡Œå¯ä¿¡å·¥ä½œè´Ÿè½½ï¼Œä½†æ˜¯ä½¿ç”¨åŸºäºç®¡ç†ç¨‹åºçš„å®¹å™¨åŒ–æŠ€æœ¯çš„æ›´å¼ºçš„å·¥ä½œè´Ÿè½½éš”ç¦»å¯èƒ½æ›´å¥½åœ°å‡è½»ä¸æ”¯æŒä¸å¯ä¿¡å·¥ä½œè´Ÿè½½ç›¸å…³è”çš„å¨èƒæ¨¡å‹ã€‚

å¦ä¸€ä¸ªä¾‹å­æ¶‰åŠ GPU å·¥ä½œè´Ÿè½½ï¼Œå…¶ä¸­åŸºäºè™šæ‹Ÿæœºç®¡ç†ç¨‹åºçš„å®¹å™¨è¿è¡Œæ—¶å¯ç”¨äºæ”¯æŒ GPU ç›´é€šå’Œ GPU ä¸­ä»‹ç›´é€šã€‚[å•æ ¹ I/O è™šæ‹ŸåŒ–(SR-IOV)](https://github.com/kata-containers/kata-containers/blob/main/docs/use-cases/using-SRIOV-and-kata.md) å’Œ[é«˜æ€§èƒ½ç”¨æˆ·æ¨¡å¼åº”ç”¨](https://github.com/kata-containers/kata-containers/blob/main/docs/use-cases/using-SPDK-vhostuser-and-kata.md)ä¹Ÿå¯ä»¥é€šè¿‡éä¼ ç»Ÿå®¹å™¨è¿è¡Œæ—¶å¾—åˆ°æ›´å¥½çš„æœåŠ¡ã€‚

Kubernetes æä¾›äº†`[RuntimeClass](https://kubernetes.io/docs/concepts/containers/runtime-class/)` [API](https://kubernetes.io/docs/concepts/containers/runtime-class/) ï¼Œå…è®¸å·¥ä½œè´Ÿè½½é€‰æ‹©æœ€é€‚åˆå…¶éœ€æ±‚çš„å®¹å™¨è¿è¡Œæ—¶ã€‚è¿™ä¸ªèµ„æºæœ€åˆæ˜¯åœ¨ Kubernetes 1.12 ä¸­ä½œä¸ºè‡ªå®šä¹‰èµ„æºå®šä¹‰(CRD)å¼•å…¥çš„ã€‚åæ¥åœ¨ Kubernetes 1.14 ä¸­ï¼Œå®ƒè¢«å®ç°ä¸ºå†…ç½®çš„é›†ç¾¤èµ„æºã€‚

# å…³äºå½¢å®¹å™¨

Kata Containers æ˜¯ä¸€ä¸ªå¼€æºå®¹å™¨è¿è¡Œæ—¶ï¼Œå®ƒåœ¨è½»é‡çº§è™šæ‹Ÿæœºä¸Šè¿è¡Œå®¹å™¨å·¥ä½œè´Ÿè½½ã€‚å®ƒåˆ©ç”¨ç¡¬ä»¶è™šæ‹ŸåŒ–æŠ€æœ¯æ¥å®æ–½å¼ºå¤§çš„å·¥ä½œè´Ÿè½½éš”ç¦»ã€‚åŸºäº [Clear Linux](https://clearlinux.org/) çš„ä¸“ç”¨æœ€å°æ¥å®¾ Linux å†…æ ¸å’Œæ¥å®¾æ˜ åƒè¿è¡Œå·¥ä½œè´Ÿè½½ã€‚è¿™ç§éƒ¨ç½²æ¨¡å‹ç¡®ä¿å®¹å™¨åŒ–çš„æµç¨‹ä¸å†èƒ½å¤Ÿè®¿é—®ä¸»æœºå†…æ ¸ã€‚å®ƒç®€åŒ–äº†ä¸»æœºå†…æ ¸ä¸Šé˜²æ­¢å®¹å™¨åˆ©ç”¨æ‰€éœ€çš„å®‰å…¨ç­–ç•¥ã€‚

![](img/5593f2755be04fbd1a1feff3a763548d.png)

ä¼ ç»Ÿå®¹å™¨ä¸å½¢å®¹å™¨

Kata Containers æ˜¯ OCI å…¼å®¹çš„ï¼Œé€šè¿‡ä¸€ä¸ª CRI å…¼å®¹çš„å«ç‰‡ä¸ containerd ä¸€èµ·å·¥ä½œã€‚å®ƒåˆ©ç”¨ Linux æµé‡æ§åˆ¶åœ¨å®¹å™¨çš„`veth`æ¥å£å’Œè™šæ‹Ÿæœºçš„`TAP`æ¥å£ä¹‹é—´é‡å®šå‘æµé‡ã€‚æœ‰å…³ Kata å®¹å™¨æ¶æ„çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§å…¶æ–‡æ¡£[è¿™é‡Œ](https://github.com/kata-containers/kata-containers/blob/main/docs/design/architecture.md)ã€‚

è‡³æ­¤ï¼Œè®©æˆ‘ä»¬ç»§ç»­è®¾ç½®å’Œé…ç½® Kubernetes æ¥ä½¿ç”¨ runC å’Œ Kata å®¹å™¨ğŸš¢ğŸš¢ğŸš¢ï¼

# è°ƒé… Kubernetes é›†ç¾¤

åœ¨æˆ‘çš„è®¾ç½®ä¸­ï¼Œæˆ‘ä½¿ç”¨`kubeadm`æä¾›äº†ä¸€ä¸ª Kubernetes v1.22.0 é›†ç¾¤ã€‚æˆ‘çš„é›†ç¾¤ä¸­ä½¿ç”¨çš„ containerd ç‰ˆæœ¬æ˜¯ 1.4.9ã€‚

æœ¬èŠ‚çš„å‰©ä½™éƒ¨åˆ†å°†åªå¼ºè°ƒç›¸å…³çš„å®‰è£…å’Œé…ç½®æ­¥éª¤ã€‚å…³äºä½¿ç”¨`kubeadm`ä¾›åº” Kubernetes çš„è¯¦ç»†ä¿¡æ¯å¯ä»¥åœ¨ Kubernetes [æ–‡æ¡£](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/)ä¸­æ‰¾åˆ°ï¼Œä»¥åŠå…³äº i [å®‰è£…å®¹å™¨](https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd)çš„é‡è¦ä¿¡æ¯ã€‚

ğŸ‘·*ä¸éœ€è¦* `*docker-ce*` *å’Œ* `*docker-ce-cli*` *è½¯ä»¶åŒ…å°±å¯ä»¥å®‰è£…* `*containerd.io*` *è½¯ä»¶åŒ…ã€‚*

æˆ‘çš„é›†ç¾¤ç”± 3 ä¸ª DigitalOcean droplets ç»„æˆï¼Œæ‹¥æœ‰ 4GB å†…å­˜å’Œ 2 ä¸ª CPUï¼Œè¿è¡Œ Ubuntu 20.04:

*   æ‰˜ç®¡ Kubernetes æ§åˆ¶å¹³é¢
*   `k8s-worker`ä½¿ç”¨ runC æœåŠ¡å¯ä¿¡å·¥ä½œè´Ÿè½½
*   `k8s-worker-untrusted`ä½¿ç”¨ runC å’Œ Kata å®¹å™¨æ¥æœåŠ¡å·¥ä½œè´Ÿè½½ï¼Œä¸å¯ä¿¡çš„å·¥ä½œè´Ÿè½½è¢«æŒ‡å®šç»™ Kata å®¹å™¨

![](img/902f41d2b98be9da3aab70b404e08050.png)

æˆ‘ä½¿ç”¨ [Calico](https://docs.projectcalico.org/getting-started/kubernetes/quickstart) ä½œä¸º CNI æ’ä»¶æ¥æ”¯æŒ pod ç½‘ç»œã€‚

åœ¨ä½¿ç”¨`kubeadm init`å‘½ä»¤åˆå§‹åŒ–æ§åˆ¶å¹³é¢ä¹‹å‰ï¼Œè®©æˆ‘ä»¬åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„`/etc/containerd/config.toml`å¤„ä¿®æ”¹å®¹å™¨çš„é…ç½®æ–‡ä»¶ã€‚

ğŸ”§*`*kata-deploy*`*å·¥å…·æ˜¯åœ¨ Kubernetes ä¸Šå®‰è£… Kata å®¹å™¨çš„ç®€å•æ–¹æ³•ã€‚å‡ºäºæ¼”ç¤ºçš„ç›®çš„ï¼Œæˆ‘å°†åœ¨æœ¬æ–‡ä¸­æ‰‹åŠ¨é…ç½® containerd å¹¶å®‰è£… Kata å®¹å™¨ã€‚**

# *ç”¨ Kata å®¹å™¨é…ç½® containerd*

*ğŸ“*æ‰€æœ‰åç»­ä»£ç ç¤ºä¾‹éƒ½éœ€è¦å¯¹é›†ç¾¤èŠ‚ç‚¹çš„ç›´æ¥ SSH è®¿é—®ï¼Œä»¥åŠåœ¨èŠ‚ç‚¹ä¸Šä¿®æ”¹å®¹å™¨çš„é…ç½®æ–‡ä»¶çš„æƒé™ã€‚**

*ä½¿ç”¨`containerd config default`å‘½ä»¤åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šé‡æ–°ç”Ÿæˆ containerd çš„é»˜è®¤é…ç½®:*

*é‡æ–°ç”Ÿæˆ containerd çš„é»˜è®¤é…ç½®*

*åœ¨å°†è¦å®‰è£… Kata å®¹å™¨çš„`k8s-worker-untrusted`èŠ‚ç‚¹ä¸Šï¼Œä¸ºå®¹å™¨çš„é…ç½®æ–‡ä»¶æ‰“è¡¥ä¸ï¼Œå¦‚ä¸‹æ‰€ç¤º:*

*ä¿®è¡¥ containerd çš„é…ç½®æ–‡ä»¶ä»¥åŒ…å« kata shimv2*

*è¿™ä¸ªè¡¥ä¸ç”¨`kata`å¤„ç†ç¨‹åºæ‰©å±•äº†å®¹å™¨çš„`cri`æ’ä»¶ã€‚æ­£å¦‚åœ¨ [Kubernetes æ–‡æ¡£](https://kubernetes.io/docs/concepts/containers/runtime-class/#hahahugoshortcode-s3-hbhb)ä¸­æ‰€è§£é‡Šçš„ï¼Œè¿™ä¸ªå¤„ç†ç¨‹åºçš„åç§°å°†åœ¨åé¢çš„`RuntimeClass`èµ„æºè§„èŒƒä¸­å¼•ç”¨ã€‚*

*containerd ä½¿ç”¨`runtime_type`å±æ€§æ¥æ ‡è¯†ä¸åº•å±‚ OCI è¿è¡Œæ—¶äº¤äº’æ‰€éœ€çš„å«ç‰‡ã€‚containerd é€šè¿‡åœ¨å¥æŸ„åç§°å’Œç‰ˆæœ¬å‰é¢åŠ ä¸Šå‰ç¼€`containerd-shim`å°†`runtime_type`ç¿»è¯‘æˆ shim çš„äºŒè¿›åˆ¶åç§°ã€‚æ¯”å¦‚`io.containerd.kata.v2`ç¿»è¯‘æˆ`containerd-shim-kata-v2`ï¼Œ`io.containerd.runc.v1`å˜æˆ`containerd-shim-runc-v1`ç­‰ç­‰ã€‚*

*`containerd-shim-kata-v2`å®ç°äº†[å®¹å™¨è¿è¡Œæ—¶ V2](https://github.com/containerd/containerd/blob/main/runtime/v2/README.md) APIã€‚é€šè¿‡è¿™ä¸ªå«ç‰‡ï¼ŒKubernetes å°†èƒ½å¤ŸæŒ‡å¯¼å¡å¡”æ¨å‡ºåŠèˆ±å’Œ OCI å…¼å®¹çš„å®¹å™¨ã€‚*

*å°†`privileged_without_host_devices`å±æ€§è®¾ç½®ä¸º`true`ä¼šå°† containerd é…ç½®ä¸ºä¸å…è®¸ç‰¹æƒ kata å®¹å™¨ç›´æ¥è®¿é—®ä¸»æœºè®¾å¤‡ã€‚*

*ğŸ“*è¿™ä¸ªè¡¥ä¸æ²¡æœ‰æ•…æ„ç¦ç”¨ runCï¼Œä»¥æ˜¾ç¤ºä¸€ä¸ªèŠ‚ç‚¹èƒ½å¤Ÿæ‰˜ç®¡å¤šä¸ªå®¹å™¨è¿è¡Œæ—¶ã€‚**

*æˆåŠŸåº”ç”¨è¡¥ä¸åï¼Œä½¿ç”¨`systemctl`é‡å¯ containerd:*

*ä½¿ç”¨ systemctl é‡æ–°å¯åŠ¨ containerd*

# *åœ¨ä¸å—ä¿¡ä»»çš„èŠ‚ç‚¹ä¸Šå®‰è£… Kata å®¹å™¨*

*ä½¿ç”¨`snap`åœ¨`k8s-worker-untrusted`èŠ‚ç‚¹ä¸Šå®‰è£… Kata å®¹å™¨ 2.1.1:*

*åœ¨ä¸å—ä¿¡ä»»çš„èŠ‚ç‚¹ä¸Šå®‰è£… Kata å®¹å™¨*

*ä½¿ç”¨`kata-containers.runtime` CLI ç¡®ä¿`k8s-worker-untrusted`èŠ‚ç‚¹å¯ä»¥è¿è¡Œ Kata å®¹å™¨:*

*ç¡®ä¿ä¸å—ä¿¡ä»»çš„èŠ‚ç‚¹å¯ä»¥è¿è¡Œ Kata å®¹å™¨*

# *åˆå§‹åŒ– Kubernetes æ§åˆ¶å¹³é¢*

*ç”¨`kubeadm init`å‘½ä»¤åˆå§‹åŒ–`k8s-control-plane`èŠ‚ç‚¹ä¸Šçš„ Kubernetes æ§åˆ¶å¹³é¢:*

*åˆå§‹åŒ– Kubernetes æ§åˆ¶å¹³é¢*

*åœ¨`k8s-worker`å’Œ`k8s-worker-untrusted`èŠ‚ç‚¹ä¸Šï¼Œä½¿ç”¨`kubeadm join`å‘½ä»¤å°†å·¥ä½œè€…åŠ å…¥æ§åˆ¶å¹³é¢:*

*å°†å·¥äººåŠ å…¥æ§åˆ¶å¹³é¢*

*ç¡®è®¤æ‰€æœ‰èŠ‚ç‚¹éƒ½æ­£å¸¸è¿è¡Œ:*

*ç¡®è®¤æ‰€æœ‰èŠ‚ç‚¹éƒ½æ­£å¸¸*

*æ‰€æœ‰åç»­çš„`kubectl`å‘½ä»¤éƒ½ä½¿ç”¨ç”±`kubeadm`ç”Ÿæˆçš„é»˜è®¤ kubeconfigï¼Œå®ƒå¯ä»¥åœ¨`k8s-control-plane`èŠ‚ç‚¹çš„`/etc/kubernetes`æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°ã€‚*

# *è°ƒåº¦ä¸å¯ä¿¡çš„å·¥ä½œè´Ÿè½½*

*ä¸ºäº†ç¡®ä¿æ‰€æœ‰ä¸å¯ä¿¡çš„å·¥ä½œè´Ÿè½½éƒ½å°†è¢«è°ƒåº¦åˆ°`k8s-worker-untrusted`èŠ‚ç‚¹ä¸Šï¼Œæˆ‘ä»¬å°†[ç”¨ä»»æ„çš„`example.org/workload=untrusted`æ ‡ç­¾æ¥æ ‡è®°](https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/)å’Œ[èŠ‚ç‚¹:](https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#nodeselector)*

*æ±¡æŸ“å¹¶æ ‡è®° k8s-worker-ä¸å¯ä¿¡èŠ‚ç‚¹*

*åˆ›å»º kata `RuntimeClass`èµ„æº:*

*åˆ›å»º kata RuntimeClass èµ„æº*

*åˆ›å»ºâ€œä¸å—ä¿¡ä»»çš„â€`Deployment`èµ„æºï¼Œå…¶ä¸­ pod ç”±ä¸€ä¸ª`curl`å®¹å™¨å’Œä¸€ä¸ª`nginx`å®¹å™¨ç»„æˆ:*

*éƒ¨ç½²ä¸å—ä¿¡ä»»çš„å·¥ä½œè´Ÿè½½*

*ç¡®è®¤`nginx-untrusted`éƒ¨ç½²æˆåŠŸé“ºå¼€:*

*ç¡®è®¤ä¸å—ä¿¡ä»»çš„å·¥ä½œè´Ÿè½½å·²æˆåŠŸè½¬å‡º*

## *æ£€æŸ¥ QEMU æµç¨‹*

*è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹`k8s-worker-untrusted`èŠ‚ç‚¹ä¸Š pod çš„ QEMU è¿‡ç¨‹:*

*æ£€æŸ¥ pod çš„ QEMU æµç¨‹*

*åº”è¯¥åªæœ‰ä¸€ä¸ª QEMU è¿›ç¨‹ï¼Œå³ä½¿ pod è¿è¡Œ 2 ä¸ªå®¹å™¨ã€‚å…³äºåŠ è½½çš„è®¾å¤‡å’Œåˆ°`vmlinuz`å†…æ ¸çš„è·¯å¾„çš„ä¿¡æ¯å¯ä»¥åœ¨è¿›ç¨‹å‚æ•°ä¸­çœ‹åˆ°ã€‚*

*åœ¨æˆ‘çš„è®¾ç½®ä¸­ï¼Œ`vmlinuz-5.10.25.container`è®¿å®¢å†…æ ¸çš„å¤§å°çº¦ä¸º 5.2MBã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒåŒä¸€ä¸ª droplet ä¸Šçš„`vmlinuz-5.4.0-80-generic`ä¸»æœºå†…æ ¸å¤§çº¦æ˜¯ 12MBã€‚è¿™ç§å°å†…æ ¸ä½¿å¾—å®ƒèƒ½å¤Ÿç›¸å¯¹å¿«é€Ÿåœ°æ—‹è½¬æ–°çš„è±†èšã€‚*

## *è®¿é—®æ¥å®¾è™šæ‹Ÿæœºæ§åˆ¶å°*

*`kata-containers.runtime` CLI æœ‰ä¸€ä¸ª`exec`å‘½ä»¤ï¼Œå®ƒæä¾›äº†ä¸€ç§é€šè¿‡è°ƒè¯•æ§åˆ¶å°è¿›å…¥å®¢æˆ·è™šæ‹Ÿæœºçš„æœºåˆ¶ã€‚*

*âš ï¸ *é»˜è®¤* [*æ¸…é™¤ Linux*](https://clearlinux.org/) *é•œåƒå¯èƒ½ä¸ä¼šè¿”å›ä¸€ä¸ª* `*tty*` *å¸¦å…¨ shell è®¿é—®ã€‚å‚è§æœ¬* [*GitHub ä¸€æœŸ*](https://github.com/kata-containers/kata-containers/issues/2010) *ã€‚**

*è¦ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œè¯·åœ¨`/etc/kata-runtime/configuration.toml`é…ç½®æ–‡ä»¶ä¸­å¯ç”¨ kata ä»£ç†çš„`debug_console_enabled` å±æ€§:*

*å¯ç”¨ kata ä»£ç†çš„ debug_console_enabled å±æ€§*

*åœ¨`k8s-worker-untrusted`èŠ‚ç‚¹ä¸Šå¯åŠ¨`kata-monitor`è¿›ç¨‹:*

*å¯åŠ¨å½¢ç›‘æ§ç¨‹åº*

*ç„¶åä½¿ç”¨æ²™ç®± ID ä½œä¸ºå‚æ•°æ‰§è¡Œ`kata-containers.runtime exec`å‘½ä»¤:*

*ä½¿ç”¨â€œkata-containers.rutime execâ€å‘½ä»¤è®¿é—®æ¥å®¾è™šæ‹Ÿæœºæ§åˆ¶å°*

*ğŸ¤”*å¦‚æœæˆ‘ä»¬å°†* `*nginx-untrusted*` *å·¥ä½œè´Ÿè½½æ‰©å±•åˆ° 3 ä¸ªå‰¯æœ¬ï¼Œæ‚¨è®¤ä¸ºæœ€ç»ˆä¼šæœ‰å¤šå°‘å°è™šæ‹Ÿæœºï¼Ÿæˆ‘ä»¬æœ€ç»ˆä¼šæœ‰ 3 å°è™šæ‹Ÿæœºå—ï¼Ÿæˆ–è€…è¿™ 6 ä¸ªå®¹å™¨æœ€ç»ˆä¼šå…±äº«åŒä¸€ä¸ªè™šæ‹Ÿæœºå—ï¼Ÿä½ è®¤ä¸ºç¼©æ”¾æ“ä½œéœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿ**

# *å¯ä¿¡å’Œä¸å¯ä¿¡å·¥ä½œè´Ÿè½½ä¹‹é—´çš„å·®å¼‚*

*ä½œä¸ºæœ€åçš„æµ‹è¯•ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ç›¸åŒçš„ pod è§„èŒƒéƒ¨ç½²ç±»ä¼¼çš„`Deployment`èµ„æºã€‚è¯¥å·¥ä½œè´Ÿè½½å°†æ‰®æ¼”æˆ‘ä»¬çš„â€œå¯ä¿¡â€å·¥ä½œè´Ÿè½½çš„è§’è‰²:*

*éƒ¨ç½²å¯ä¿¡å·¥ä½œè´Ÿè½½*

*è¿™æ˜¯æˆ‘çš„`default`åç§°ç©ºé—´åœ¨æ‰©å±•ä¸å¯ä¿¡å·¥ä½œè´Ÿè½½å’Œéƒ¨ç½²å¯ä¿¡å·¥ä½œè´Ÿè½½åçš„æ ·å­:*

*åŒ…å«å¯ä¿¡å’Œä¸å¯ä¿¡å·¥ä½œè´Ÿè½½çš„â€œé»˜è®¤â€å‘½åç©ºé—´*

*è¯·æ³¨æ„ï¼Œæ‰€æœ‰å—ä¿¡ä»»çš„ pod éƒ½è¢«å®‰æ’åœ¨`k8s-worker`èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œè€Œä¸å—ä¿¡ä»»çš„ pod åˆ™åœ¨`k8s-worker-untrusted`èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚*

*æ­¤æ—¶ï¼Œåœ¨å¯ä¿¡å’Œä¸å¯ä¿¡å·¥ä½œè´Ÿè½½ä¹‹é—´æ²¡æœ‰ä»»ä½•å¼ºåˆ¶çš„ç½‘ç»œè¾¹ç•Œã€‚è±†èšå¯ä»¥è‡ªç”±åœ°äº’ç›¸äº¤è°ˆã€‚*

*ä¾‹å¦‚ï¼Œæˆ‘å¯ä»¥ä½¿ç”¨å¯ä¿¡çš„`curl`æ¥è”ç³»ä¸å¯ä¿¡çš„`nginx`:*

*å¯ä¿¡çš„ curl å¯ä»¥åˆ°è¾¾ä¸å¯ä¿¡çš„ nginx*

*æˆ‘ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸å¯ä¿¡çš„`curl`è”ç³»å¯ä¿¡çš„`nginx`:*

*ä¸å¯ä¿¡çš„ curl å¯ä»¥åˆ°è¾¾å¯ä¿¡çš„ nginx*

*éƒ¨ç½²`[NetworkPolicy](https://kubernetes.io/docs/concepts/services-networking/network-policies/)`èµ„æºæ¥é™åˆ¶å¯ä¿¡åŸŸå’Œä¸å¯ä¿¡åŸŸä¹‹é—´çš„æµé‡çš„ä»»åŠ¡å°†ç•™ç»™è¯»è€…æ¥å®Œæˆã€‚*

# *ç»“è®º*

*åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨`kubeadm`åœ¨ DigitalOcean ä¸Šæä¾›äº†ä¸€ä¸ª Kubernetes v1.22.0 é›†ç¾¤ã€‚æˆ‘ä»¬æŒ‡å®šä¸€ä¸ªèŠ‚ç‚¹ä¸ºå¯ä¿¡å·¥ä½œè´Ÿè½½æœåŠ¡ï¼Œè€Œå¦ä¸€ä¸ªèŠ‚ç‚¹ä¸ºä¸å¯ä¿¡å·¥ä½œè´Ÿè½½æœåŠ¡ã€‚åœ¨åˆå§‹åŒ–é›†ç¾¤ä¹‹å‰ï¼Œæˆ‘ä»¬æ‰‹åŠ¨ä¿®è¡¥ containerd çš„é…ç½®æ–‡ä»¶ï¼Œå¹¶åœ¨ä¸å—ä¿¡ä»»çš„èŠ‚ç‚¹ä¸Šå®‰è£… Kata å®¹å™¨ã€‚åœ¨å®é™…è®¾ç½®ä¸­ï¼Œ`[kata-deploy](https://github.com/kata-containers/kata-containers/tree/main/tools/packaging/kata-deploy)`å·¥å…·å°†æ˜¯åœ¨ Kubernetes ä¸Šéƒ¨ç½² Kata å®¹å™¨çš„æ›´å¥½é€‰æ‹©ã€‚*

*ç„¶åï¼Œæˆ‘ä»¬å°†å¯ä¿¡å’Œä¸å¯ä¿¡å·¥ä½œè´Ÿè½½éƒ¨ç½²åˆ°é›†ç¾¤ä¸Šã€‚é€šè¿‡ä½¿ç”¨é€‚å½“çš„[æ±¡ç‚¹](https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/)å’Œ[æ ‡ç­¾](https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#nodeselector)ï¼Œæ‰€æœ‰ä¸å¯ä¿¡çš„å·¥ä½œè´Ÿè½½éƒ½è¢«è°ƒåº¦åˆ°ä¸å¯ä¿¡çš„èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚å°½ç®¡å¯ä¿¡å’Œä¸å¯ä¿¡å·¥ä½œè´Ÿè½½ç”±ä¸åŒçš„å®¹å™¨è¿è¡Œæ—¶æä¾›æœåŠ¡ï¼Œä½†æ˜¯å®ƒä»¬èƒ½å¤Ÿç›¸äº’é€šä¿¡ã€‚éƒ¨ç½²`[NetworkPolicy](https://kubernetes.io/docs/concepts/services-networking/network-policies/)`èµ„æºä»¥åŠ å¼ºå¯ä¿¡åŸŸå’Œä¸å¯ä¿¡åŸŸä¹‹é—´çš„ç½‘ç»œè¾¹ç•Œçš„ä»»åŠ¡ç•™ç»™è¯»è€…æ¥å®Œæˆã€‚*