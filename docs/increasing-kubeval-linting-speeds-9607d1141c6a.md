# æé«˜åº“è´ç“¦å°”æ—æŒºé€Ÿåº¦ğŸš€

> åŸæ–‡ï¼š<https://itnext.io/increasing-kubeval-linting-speeds-9607d1141c6a?source=collection_archive---------2----------------------->

![](img/3000fe62cc6ed47280b63b0794a32adc.png)

åœ¨ Mettleï¼Œæˆ‘ä»¬æ‰€æœ‰çš„å·¥ä½œè´Ÿè½½éƒ½åœ¨ Kubernetes ä¸Šè¿è¡Œï¼Œå®ƒä»¬æ˜¯ä½¿ç”¨åä¸º Flux([https://github.com/fluxcd/flux](https://github.com/fluxcd/flux))çš„ GitOps è¿è¥å•†éƒ¨ç½²çš„ã€‚

# ä»€ä¹ˆæ˜¯ GitOpsï¼Ÿ

é‚£ä¹ˆä»€ä¹ˆæ˜¯ GitOps å‘¢ï¼Ÿä»è¡¨é¢ä¸Šçœ‹ï¼Œè¿™å¾ˆç®€å•ã€‚GitOps çš„æ ¸å¿ƒæ˜¯ä½¿ç”¨ä¸€ä¸ªç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ(æ¯”å¦‚ Git)æ¥å­˜æ”¾ Kubernetes éƒ¨ç½²çš„æ‰€æœ‰ä¿¡æ¯ã€æ–‡æ¡£å’Œä»£ç ï¼Œç„¶åä½¿ç”¨è‡ªåŠ¨åŒ–æ§åˆ¶å™¨å°†æ›´æ”¹éƒ¨ç½²åˆ°é›†ç¾¤ã€‚GitOps ä¸ºå¼€å‘äººå‘˜æä¾›äº†ä¸€ç§ä½¿ç”¨ Git å’Œä»–ä»¬è‡ªå·±çš„ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿæ¥ç®¡ç†æ“ä½œå·¥ä½œæµçš„æ–¹æ³•ï¼Œç‰¹åˆ«æ˜¯å¯¹äº Kubernetesã€‚

ç®€è€Œè¨€ä¹‹ï¼Œä½¿ç”¨ pull è¯·æ±‚åˆå¹¶ä»£ç çš„è¿‡ç¨‹ä¹Ÿç”¨äºå°†å·¥ä½œè´Ÿè½½éƒ¨ç½²åˆ° Kubernetesã€‚

# è¿ç»­ç´¯è®¡

åƒä»»ä½•å¥½çš„æ‹‰å¼è¯·æ±‚(PR)å·¥ä½œæµä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦è¿è¡ŒæŒç»­çš„é›†æˆæµ‹è¯•ï¼Œä»¥éªŒè¯æˆ‘ä»¬çš„æ›´æ”¹å¯åˆå¹¶åˆ°æˆ‘ä»¬çš„ä»£ç åº“ä¸­ã€‚è¿™ä¸æˆ‘ä»¬åœ¨æºä»£ç æ§åˆ¶ä¸­ç»´æŠ¤çš„ Kubernetes æ¸…å•æ²¡æœ‰ä»€ä¹ˆä¸åŒã€‚

æˆ‘ä»¬åœ¨ Mettle çš„æ‰€æœ‰å®šåˆ¶å¤´ç›”å›¾è¡¨éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªåä¸º **mettle/k8s-helm-charts çš„é›†ä¸­å­˜å‚¨åº“ä¸­ã€‚**ç„¶åä½¿ç”¨ Flux HelmReleases å°†è¿™äº›å›¾è¡¨éƒ¨ç½²åˆ°æˆ‘ä»¬çš„ Kubernetes é›†ç¾¤ä¸­ï¼Œè¦äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§[https://docs . Flux CD . io/projects/helm-operator/en/latest/references/helm release-custom-resource . html](https://docs.fluxcd.io/projects/helm-operator/en/latest/references/helmrelease-custom-resource.html)

# CI é—®é¢˜

æˆ‘ä»¬é€šè¿‡æ‰§è¡Œ`helm template`æ¥éªŒè¯æˆ‘ä»¬çš„ helm å›¾è¡¨ï¼Œç„¶åå°†æ¯ä¸ªå›¾è¡¨çš„è¾“å‡ºä¾æ¬¡ä¼ é€åˆ°`kubeval`([https://github.com/instrumenta/kubeval](https://github.com/instrumenta/kubeval))(è§ä¸‹æ–‡)ï¼Œä»¥éªŒè¯æ¸…å•ä¸ç‰¹å®šç‰ˆæœ¬çš„ Kubernetes çš„æ¨¡å¼å®šä¹‰ä¸€è‡´ã€‚

é—®é¢˜æ˜¯æ¯æ¬¡æ‰§è¡Œ`kubeval`ä¼¼ä¹éƒ½è¦èŠ±è´¹å¾ˆé•¿æ—¶é—´ï¼Œæˆ‘ä»¬æ„è¯†åˆ°è¿™æ˜¯å› ä¸º kubeval æ¯æ¬¡éƒ½å¿…é¡»æ‹‰ä¸‹æ‰€æœ‰çš„æ¨¡å¼æ¥éªŒè¯èˆµå›¾ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœæˆ‘ä»¬å‘å­˜å‚¨åº“æ·»åŠ æ›´å¤šçš„å›¾è¡¨ï¼Œåªä¼šæ··æ·†é—®é¢˜ã€‚

**å›¾å¼:**[**https://github.com/instrumenta/kubernetes-json-schema**](https://github.com/instrumenta/kubernetes-json-schema)

# ç«äº‰æƒ…æŠ¥è§£å†³æ–¹æ¡ˆ

åœ¨æŸ¥çœ‹ Kubeval å¯ç”¨çš„æ——å¸œæ—¶ï¼Œæˆ‘æ³¨æ„åˆ°ä»¥ä¸‹ä¸€ä¸ª:

```
-s, --schema-location string Base URL used to download schemas. Can also be specified with the environment variable KUBEVAL_SCHEMA_LOCATION.
```

å¦‚æœæˆ‘ä»¬å¯ä»¥åœ¨æœ¬åœ°ä¸‹è½½å¿…è¦çš„æ¨¡å¼ï¼Œç„¶åå°† kubeval æŒ‡å‘å®ƒä»¬ï¼Œè¿™å°†å¤§å¤§å‡å°‘æ˜¾ç¤ºæˆ‘ä»¬çš„èˆµå›¾æ‰€éœ€çš„æ—¶é—´ã€‚

æˆ‘ç€æ‰‹åˆ›å»ºäº†ä¸€ä¸ªåä¸º`kubernetes-toolkit`çš„å®¹å™¨ï¼Œå…¶ä¸­åŒ…å«äº†æˆ‘ä»¬ç”¨æ¥éªŒè¯ kubernetes æ¸…å•çš„æ‰€æœ‰åŒ…å’ŒäºŒè¿›åˆ¶æ–‡ä»¶(ä¾‹å¦‚ kubectlã€helmï¼Œå½“ç„¶è¿˜æœ‰ kubeval)ã€‚

æ­¤å¤–ï¼Œä¹Ÿæ˜¯æœ€é‡è¦çš„ä¸€ç‚¹ï¼Œæˆ‘ä¼šåœ¨æ„å»ºæ—¶åœ¨å®¹å™¨ä¸­ä¸‹è½½ç‰¹å®šç‰ˆæœ¬çš„ kubectl çš„æ¨¡å¼ã€‚è¿™æ–¹é¢çš„ bash è„šæœ¬å¦‚ä¸‹æ‰€ç¤º

Kubernetes çš„ç‰ˆæœ¬åœ¨æ„å»ºæ—¶ä½œä¸ºå‚æ•°ä¼ é€’ç»™`Dockerfile`ï¼Œä»¥ç¡®ä¿å®‰è£…äº†æ­£ç¡®çš„`kubectl`ç‰ˆæœ¬ï¼Œæœ€é‡è¦çš„æ˜¯**å®¹å™¨ä¸­åªå­˜å‚¨äº†è¯¥ç‰ˆæœ¬çš„æ¨¡å¼å®šä¹‰ã€‚**

ç»´æŠ¤ç‰¹å®šæ¨¡å¼é›†çš„é€»è¾‘å¦‚ä¸‹æ‰€ç¤º:

æ­¤å¤–ï¼Œæˆ‘ä»¬éœ€è¦å°†è¿è¡Œ`kubeval`çš„ bash è„šæœ¬è°ƒæ•´ä¸º:

æˆ‘ä»¬ç°åœ¨è®¾ç½®`KUBEVAL_SCHEMA_LOCATION`ç¯å¢ƒå˜é‡ï¼Œä»¥ç¡®ä¿ä½¿ç”¨å®¹å™¨å†…çš„æ¨¡å¼ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬ä½¿ç”¨
`â€”- kubernetes-version`æ ‡å¿—æ˜ç¡®å‘Šè¯‰ kubeval è¦éªŒè¯å“ªä¸ªç‰ˆæœ¬çš„ Kubernetesï¼Œè¿™æ˜¯å¿…éœ€çš„ï¼Œå› ä¸ºå®¹å™¨åªåŒ…å« 1.17 ç‰ˆæœ¬çš„æ¨¡å¼ã€‚

æœ€åï¼Œæˆ‘ä»¬éœ€è¦åœ¨ CircleCI é…ç½®æ–‡ä»¶(å¦‚ä¸‹)ä¸­å°†è¿™ä¸€åˆ‡è”ç³»èµ·æ¥

æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ä¸º kubernetes çš„æ¯ä¸ªç‰ˆæœ¬æ„å»ºä¸€ä¸ªæ–°ç‰ˆæœ¬çš„`kubernetes-toolkit`å®¹å™¨ï¼Œå¹¶ç›¸åº”åœ°æ›´æ–°æˆ‘ä»¬ç›¸åº”çš„ CI ä½œä¸šã€‚

# é€€å…³è´§ç‰©

æˆ‘æƒ³ä¸ºè¿™ä¸ªæƒ³æ³•å¤§å£°å–Šå‡ºæ¥[https://twitter.com/karlstoney](https://twitter.com/karlstoney)å®ƒä»¥æœ€å°çš„æ”¹å˜å°†æˆ‘ä»¬çš„æ„å»ºæ—¶é—´ä» 20 åˆ†é’Ÿå‡å°‘åˆ°å¤§çº¦ 5 ç§’ã€‚