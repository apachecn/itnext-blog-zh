# ååº”è®¾ç½®çŠ¶æ€ç”¨æ³•å’Œé™·é˜±

> åŸæ–‡ï¼š<https://itnext.io/react-setstate-usage-and-gotchas-ac10b4e03d60?source=collection_archive---------0----------------------->

![](img/651693188ebf89b808998ee4a6b5c3d6.png)

> [*ç‚¹å‡»è¿™é‡Œåœ¨ LinkedIn*](https://www.linkedin.com/cws/share?url=https%3A%2F%2Fitnext.io%2Freact-setstate-usage-and-gotchas-ac10b4e03d60%3Futm_source%3Dmedium_sharelink%26utm_medium%3Dsocial%26utm_campaign%3Dbuffer) ä¸Šåˆ†äº«è¿™ç¯‡æ–‡ç« 

React ç±»ç»„ä»¶æœ‰ä¸€ä¸ªå†…éƒ¨çŠ¶æ€ï¼Œåƒ props ä¸€æ ·å½±å“ç»„ä»¶çš„æ¸²æŸ“å’Œè¡Œä¸ºã€‚ä¸ props ä¸åŒï¼ŒçŠ¶æ€æ˜¯ç»„ä»¶çš„æœ¬åœ°çŠ¶æ€ï¼Œåªèƒ½åœ¨ç»„ä»¶å†…éƒ¨åˆå§‹åŒ–å’Œæ›´æ–°ã€‚

# **åˆå§‹åŒ–**

åœ¨ä½¿ç”¨ state ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºåˆå§‹çŠ¶æ€å£°æ˜ä¸€ç»„ç¼ºçœå€¼ã€‚è¿™å¯ä»¥é€šè¿‡åœ¨æ„é€ å‡½æ•°ä¸­åˆ›å»ºä¸€ä¸ªçŠ¶æ€å¯¹è±¡æˆ–è€…ç›´æ¥åœ¨ç±»ä¸­åˆ›å»ºæ¥å®ç°ã€‚

```
class Counter extends React.Component {
  constructor(props, context) {
    super(props, context)
    this.state = {
      quantity: 1,
      counter: 0
    }
  }
}class Counter extends React.Component {
  state = {
    quantity: 1,
    counter: 0
  }
}
```

# **æ›´æ–°**

çŠ¶æ€å¯ä»¥å“åº”äºäº‹ä»¶å¤„ç†ç¨‹åºã€æœåŠ¡å™¨å“åº”æˆ–å±æ€§æ”¹å˜è€Œè¢«æ›´æ–°ã€‚React ä¸ºæ­¤æä¾›äº†ä¸€ä¸ªåä¸º`setState`çš„æ–¹æ³•ã€‚

`setState()`å°†ç»„ä»¶çŠ¶æ€çš„æ›´æ”¹æ’å…¥é˜Ÿåˆ—ï¼Œå¹¶å‘Šè¯‰ React è¯¥ç»„ä»¶åŠå…¶å­ç»„ä»¶éœ€è¦ç”¨æ›´æ–°åçš„çŠ¶æ€é‡æ–°å‘ˆç°ã€‚

```
this.setState({quantity: 2})
```

è¿™é‡Œï¼Œæˆ‘ä»¬ä¼ é€’äº†ä¸€ä¸ªåŒ…å«æˆ‘ä»¬æƒ³è¦æ›´æ–°çš„çŠ¶æ€çš„å¯¹è±¡`setState()`ã€‚ä¼ é€’çš„å¯¹è±¡ä¼šæœ‰å¯¹åº”äºç»„ä»¶çŠ¶æ€ä¸­çš„é”®çš„é”®ï¼Œç„¶å`setState()`é€šè¿‡å°†å¯¹è±¡åˆå¹¶åˆ°çŠ¶æ€æ¥æ›´æ–°æˆ–è®¾ç½®çŠ¶æ€ã€‚

# **è®¾ç½®çŠ¶æ€å¹¶é‡æ–°æ¸²æŸ“**

`setState()`å°†æ€»æ˜¯å¯¼è‡´é‡æ–°æ¸²æŸ“ï¼Œé™¤é`shouldComponentUpdate()`è¿”å›`false`ã€‚ä¸ºäº†é¿å…ä¸å¿…è¦çš„æ¸²æŸ“ï¼Œåªåœ¨æ–°çŠ¶æ€ä¸åŒäºå‰ä¸€çŠ¶æ€æ—¶è°ƒç”¨`setState()`æ˜¯æœ‰æ„ä¹‰çš„ï¼Œå¹¶ä¸”å¯ä»¥é¿å…åœ¨æŸäº›ç”Ÿå‘½å‘¨æœŸæ–¹æ³•(å¦‚`componentDidUpdate`)ä¸­æ— é™å¾ªç¯åœ°è°ƒç”¨`setState()`ã€‚

> ä» 16 å¼€å§‹ï¼Œç”¨`null`è°ƒç”¨`setState`ä¸å†è§¦å‘æ›´æ–°ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å†³å®šæ˜¯å¦åœ¨æˆ‘ä»¬çš„`setState`æ–¹æ³•æœ¬èº«ä¸­æ›´æ–°çŠ¶æ€ï¼

# **ç­¾å**

```
setState(updater[, callback])
```

ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¸¦æœ‰ç­¾åçš„`updater`å‡½æ•°:

```
(prevState, props) => stateChange
```

`prevState`æ˜¯å¯¹ä¹‹å‰çŠ¶æ€çš„å¼•ç”¨ã€‚åº”è¯¥ä¸ä¼šç›´æ¥å˜å¼‚ã€‚ç›¸åï¼Œåº”è¯¥é€šè¿‡åŸºäºæ¥è‡ª`prevState`å’Œ`props`çš„è¾“å…¥æ„å»ºä¸€ä¸ªæ–°å¯¹è±¡æ¥è¡¨ç¤ºå˜åŒ–ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡`props.step`å¢åŠ çŠ¶æ€å€¼:

```
this.setState((prevState, props) => {
  return {counter: prevState.counter + props.step};
})
```

> ç”±äº`setState`çš„å¼‚æ­¥ç‰¹æ€§ï¼Œä¸å»ºè®®ä½¿ç”¨`this.state`åœ¨`setState`å†…è·å¾—å‰ä¸€ä¸ªçŠ¶æ€ã€‚è€Œæ˜¯ä¸€ç›´ä¾é ä¸Šé¢çš„æ–¹å¼ã€‚æ›´æ–°å‡½æ•°æ¥æ”¶åˆ°çš„`prevState`å’Œ`props`éƒ½ä¿è¯æ˜¯æœ€æ–°çš„ã€‚æ›´æ–°å™¨çš„è¾“å‡ºä¸`prevState`æµ…åˆå¹¶ã€‚

`setState()`çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¯é€‰çš„å›è°ƒå‡½æ•°ï¼Œä¸€æ—¦`setState`å®Œæˆå¹¶ä¸”ç»„ä»¶è¢«é‡æ–°æ¸²æŸ“ï¼Œè¿™ä¸ªå‡½æ•°å°±ä¼šè¢«æ‰§è¡Œã€‚`componentDidUpdate`åº”æ”¹ä¸ºåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹åº”ç”¨æ­¤ç±»é€»è¾‘ã€‚

ä½ å¯ä»¥ç›´æ¥ä¼ é€’ä¸€ä¸ªå¯¹è±¡ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ç»™`setState`ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚è¿™å°†æ‰§è¡ŒçŠ¶æ€å˜åŒ–åˆ°æ–°çŠ¶æ€çš„æµ…å±‚åˆå¹¶ã€‚

```
this.setState({quantity: 2})
```

# æ‰¹å¤„ç†çŠ¶æ€æ›´æ–°

å¦‚æœè¿›è¡Œäº†å¤šæ¬¡`setState()`è°ƒç”¨ï¼ŒReact å¯èƒ½ä¼šåœ¨è€ƒè™‘æ›´æ–°é¡ºåºçš„åŒæ—¶æ‰¹é‡æ›´æ–°çŠ¶æ€ã€‚ç›®å‰(React 16 åŠæ›´æ—©ç‰ˆæœ¬)ï¼Œ**é»˜è®¤æƒ…å†µä¸‹åªæœ‰ React äº‹ä»¶å¤„ç†ç¨‹åºå†…éƒ¨çš„æ›´æ–°è¢«æ‰¹å¤„ç†**ã€‚äº‹ä»¶ç»“æŸæ—¶ï¼Œæ›´æ”¹æ€»æ˜¯ä¸€èµ·åˆ·æ–°ï¼Œæ‚¨çœ‹ä¸åˆ°ä¸­é—´çŠ¶æ€ã€‚

æ— è®ºæ‚¨åœ¨ React äº‹ä»¶å¤„ç†ç¨‹åºä¸­è°ƒç”¨å¤šå°‘ä¸ªç»„ä»¶ï¼Œå®ƒä»¬éƒ½åªä¼šåœ¨äº‹ä»¶ç»“æŸæ—¶äº§ç”Ÿä¸€æ¬¡é‡æ–°æ¸²æŸ“ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå­èŠ‚ç‚¹å’Œçˆ¶èŠ‚ç‚¹åœ¨å¤„ç† click äº‹ä»¶æ—¶éƒ½è°ƒç”¨äº†`setState()`ï¼Œé‚£ä¹ˆå­èŠ‚ç‚¹åªä¼šé‡æ–°æ¸²æŸ“ä¸€æ¬¡ã€‚

ç›´åˆ° React 16ï¼Œ**åœ¨ React äº‹ä»¶å¤„ç†ç¨‹åº**ä¹‹å¤–é»˜è®¤æ²¡æœ‰æ‰¹å¤„ç†ã€‚å› æ­¤ï¼Œå¦‚æœæ¯ä¸ª`setState()`ä½äºä»»ä½•äº‹ä»¶å¤„ç†ç¨‹åºä¹‹å¤–ï¼Œå®ƒä»¬å°†è¢«ç«‹å³å¤„ç†ã€‚ä¾‹å¦‚:

```
promise.then(() => {
  // We're not in an event handler, so these are flushed separately.
  this.setState({a: true}); // Re-renders with {a: true, b: false }
  this.setState({b: true}); // Re-renders with {a: true, b: true }
})
```

ç„¶è€Œï¼Œ`ReactDOM`æä¾›äº†ä¸€ä¸ª apiï¼Œå¯ä»¥ç”¨æ¥å¼ºåˆ¶æ‰¹é‡æ›´æ–°ã€‚

```
promise.then(() => {
  // Forces batching
  ReactDOM.unstable_batchedUpdates(() => {
    this.setState({a: true}); // Doesn't re-render yet
    this.setState({b: true}); // Doesn't re-render yet
  });
  // When we exit unstable_batchedUpdates, re-renders once
})
```

å†…éƒ¨ React äº‹ä»¶å¤„ç†ç¨‹åºéƒ½åŒ…è£…åœ¨`unstable_batchedUpdates`ä¸­ï¼Œå› æ­¤é»˜è®¤æƒ…å†µä¸‹å®ƒä»¬æ˜¯æ‰¹å¤„ç†çš„ã€‚åœ¨`unstable_batchedUpdates`ä¸­åŒ…è£…ä¸€ä¸ªæ›´æ–°ä¸¤æ¬¡æ²¡æœ‰æ•ˆæœã€‚å½“æœ€å¤–å±‚çš„`unstable_batchedUpdates`è°ƒç”¨é€€å‡ºæ—¶ï¼Œæ›´æ–°è¢«åˆ·æ–°ã€‚

> è¯¥ API æ˜¯â€œä¸ç¨³å®šçš„â€,å› ä¸ºå½“æ‰¹å¤„ç†åœ¨ React æ ¸å¿ƒä¸­å·²ç»é»˜è®¤å¯ç”¨æ—¶ï¼Œå®ƒå°†è¢«åˆ é™¤ã€‚

# åœ¨ React ç»„ä»¶å¤–éƒ¨å£°æ˜çŠ¶æ€æ›´æ”¹

è¿™ä¸€éƒ¨åˆ†çš„çµæ„Ÿæ¥è‡ªä¸‹é¢ä¸¹Â·é˜¿å¸ƒæ‹‰è«å¤«çš„æ¨æ–‡ã€‚

ç”±äº`setState`æœŸæœ›å‚æ•°ä¸­æœ‰ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥åœ¨ React ç±»ä¹‹å¤–çš„æŸä¸ªåœ°æ–¹å®ç°ï¼Œç„¶åä½œä¸º`setState`çš„å‚æ•°å¯¼å…¥å¹¶åœ¨ç»„ä»¶å†…éƒ¨ä½¿ç”¨ã€‚å¦‚æœéœ€è¦é¢å¤–çš„å‚æ•°ï¼Œé«˜é˜¶å‡½æ•°å¯ä»¥å¸®å¿™ã€‚

```
const multiplyBy = multiplier => state => ({
  value: state.value * multiplier
})
```

ç”±äºçŠ¶æ€æ›´æ–°ç°åœ¨æ˜¯æ™®é€šçš„ JavaScriptï¼Œæµ‹è¯•å¤æ‚çš„çŠ¶æ€è½¬æ¢ä¸ä¼šæ¶‰åŠ React ç»„ä»¶çš„æµ…å±‚å‘ˆç°ã€‚

# setState å’Œç”Ÿå‘½å‘¨æœŸæ–¹æ³•

åœ¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸­è°ƒç”¨`setState`éœ€è¦ä¸€å®šç¨‹åº¦çš„è°¨æ…ã€‚æœ‰ä¸€äº›æ–¹æ³•è°ƒç”¨ setState æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œä¹Ÿæœ‰ä¸€äº›æ–¹æ³•åº”è¯¥æœ‰æ¡ä»¶åœ°è°ƒç”¨ã€‚è®©æˆ‘ä»¬å…·ä½“æƒ…å†µå…·ä½“åˆ†æã€‚

## ç»„ä»¶å°†å®‰è£…

`setState`å¯ä»¥åœ¨è¿™é‡Œè°ƒç”¨ã€‚æ›´æ–°åçš„çŠ¶æ€å°†åœ¨å³æ—¶å‘ˆç°ä¸­ä½¿ç”¨ï¼Œåªè¦å®ƒä¸æ˜¯åŸºäºæ‰¿è¯ºè§£æè®¡ç®—çš„ã€‚å»ºè®®ä½¿ç”¨`componentDidMount`å¯¹æ‰¿è¯ºè§£æç­‰æ‰§è¡Œä»»ä½•çŠ¶æ€æ›´æ–°ã€‚ä¸ä½¿ç”¨è¯¥æ–¹æ³•çš„å¦ä¸€ä¸ªåŸå› æ˜¯ï¼Œåœ¨ React çš„æœªæ¥ç‰ˆæœ¬(17 ä»¥å)ä¸­ï¼Œè¯¥æ–¹æ³•å°†è¢«å¼ƒç”¨ã€‚

[](https://github.com/reactjs/rfcs/blob/master/text/0006-static-lifecycle-methods.md) [## reactj/RFC

### RFC-å¯¹å˜æ›´åšå‡ºååº”çš„ RFC

github.com](https://github.com/reactjs/rfcs/blob/master/text/0006-static-lifecycle-methods.md) 

## ç»„ä»¶å®‰è£…

è¿™æ˜¯å¼‚æ­¥æ¸²æŸ“çš„é¦–é€‰æ–¹æ³•ã€‚

## componentWillReceiveProps

æ­¤æ–¹æ³•çš„ä¸»è¦ç›®çš„æ˜¯è®¡ç®—ä¸€äº›ä» props æ´¾ç”Ÿçš„å€¼ï¼Œä»¥ä¾¿åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­ä½¿ç”¨ã€‚è™½ç„¶ï¼Œå¦‚æœè®¡ç®—è¶³å¤Ÿå¿«ï¼Œå®ƒå¯ä»¥åœ¨`render`å®Œæˆã€‚åœ¨è¿™é‡Œä½¿ç”¨ç»å¯¹å®‰å…¨ã€‚

## shouldComponentUpdate

è¿™æ˜¯æ›´æ–°ç»„ä»¶çŠ¶æ€æ²¡æœ‰æ„ä¹‰çš„æ–¹æ³•ä¹‹ä¸€ã€‚å®ƒåœ¨æ›´æ–°é˜¶æ®µ(props æˆ–çŠ¶æ€æ›´æ”¹)ç”± React åœ¨å†…éƒ¨è°ƒç”¨ã€‚åœ¨è¿™é‡Œè°ƒç”¨`setState`ä¼šå¯¼è‡´æ— é™å¾ªç¯ï¼Œå› ä¸ºè¿™æ˜¯å®ƒåœ¨æ›´æ–°çŠ¶æ€æ—¶è°ƒç”¨çš„ä¸‹ä¸€ä¸ªæ–¹æ³•ã€‚å¦‚æœéœ€è¦åœ¨é“å…·æ›´æ–°é˜¶æ®µè®¾ç½®çŠ¶æ€ï¼Œä½¿ç”¨`componentWillReceiveProps`ã€‚

## ç»„ä»¶å°†æ›´æ–°

è¿™é‡Œä¸è¦ç”¨`setState`ã€‚å’Œ`shouldComponentUpdate`ç±»ä¼¼çš„åŸå› ã€‚

## æä¾›ï¼›ç»™äºˆ

åœ¨è¿™é‡Œè°ƒç”¨`setState`ä¼šä½¿æ‚¨çš„ç»„ä»¶æˆä¸ºäº§ç”Ÿæ— é™å¾ªç¯çš„ç«äº‰è€…ã€‚`render`åº”ä¿æŒçº¯å‡€ï¼Œå¹¶ç”¨äºæ ¹æ®çŠ¶æ€æˆ–é“å…·æœ‰æ¡ä»¶åœ°åœ¨ JSX ç‰‡æ®µ/å­ç»„ä»¶ä¹‹é—´åˆ‡æ¢ã€‚render ä¸­çš„å›è°ƒå¯ç”¨äºæ›´æ–°çŠ¶æ€ï¼Œç„¶åæ ¹æ®æ›´æ”¹é‡æ–°å‘ˆç°ã€‚

> å¦‚æœä½ å‘ç°è‡ªå·±ä¸å¾—ä¸åœ¨`render`ä¸­å†™`setState`ï¼Œä½ å¯èƒ½éœ€è¦é‡æ–°è€ƒè™‘è®¾è®¡ã€‚äº‹å®ä¸Šï¼Œè¿™å¯èƒ½æ˜¯å®ç°çŠ¶æ€æœºæ¨¡å¼çš„å®Œç¾ç”¨ä¾‹ã€‚

[](https://medium.freecodecamp.org/boost-your-react-with-state-machines-1e9641b0aa43) [## ä½¿ç”¨çŠ¶æ€æœºå¢å¼ºæ‚¨çš„ååº”

### æ··åˆ React å’ŒçŠ¶æ€æœºå¯¹äºå¼€å‘äººå‘˜æ¥è¯´æ˜¯æå¤§çš„ç”Ÿäº§åŠ›æå‡ã€‚å®ƒè¿˜æé«˜äº†é€šå¸¸â€¦

medium.freecodecamp.org](https://medium.freecodecamp.org/boost-your-react-with-state-machines-1e9641b0aa43) 

## componentDidUpdate

è¿™é‡Œè°ƒç”¨`setState`æœ€å¸¸è§çš„ç”¨ä¾‹æ˜¯æ›´æ–° DOM ä»¥å“åº”å±æ€§æˆ–çŠ¶æ€çš„å˜åŒ–ã€‚è¿™é‡Œï¼Œåœ¨å†æ¬¡æ›´æ–°çŠ¶æ€ä¹‹å‰ï¼Œæ‚¨ç­‰å¾…ç»„ä»¶è¢«å‘ˆç°ã€‚è¿™ä½¿å¾—å®ƒæˆä¸ºè®¾ç½®ä¾èµ–äºå‘ˆç°çš„ DOM å€¼çš„çŠ¶æ€å€¼çš„å€™é€‰å¯¹è±¡ã€‚è¯·è®°ä½æ£€æŸ¥æ‚¨æ˜¯å¦å†æ¬¡æ›´æ–°äº†ç›¸åŒçš„çŠ¶æ€ï¼Œå› ä¸ºåœ¨è°ƒç”¨`setState()`ä¹‹åä¼šå†æ¬¡è°ƒç”¨è¯¥æ–¹æ³•ã€‚ä¾‹å¦‚:

```
componentDidUpdate = (prevProps, prevState) => {
  let width = ReactDOM.findDOMNode(this).parentNode.offsetWidth
  if (prevState && prevState.width !== width) {
    this.setState({ width })
  }
}
```

## ç»„ä»¶å°†å¸è½½

è¿™é‡Œä¸è¦ç”¨`setState`ã€‚ä½ çš„ç»„ä»¶æ­£åœ¨æ¶ˆå¤±ã€‚

å‚è€ƒ

*   [https://reactjs.org/docs/react-component.html#setstate](https://reactjs.org/docs/react-component.html#setstate)
*   [https://stack overflow . com/questions/48563650/does-react-keep-the-order-for-state-updates/48610973 # 48610973](https://stackoverflow.com/questions/48563650/does-react-keep-the-order-for-state-updates/48610973#48610973)

***é™„:å¦‚æœè¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œä¸€å®šè¦é¼“æŒğŸ‘ï¼Œå…³æ³¨æˆ‘çš„*** [***æ¨ç‰¹***](https://twitter.com/nitishk88) ***ï¼Œå¹¶åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼***