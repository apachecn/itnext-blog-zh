# è§£é‡Š:Rust åœ¨ Web å¼€å‘ä¸­çš„æœªæ¥

> åŸæ–‡ï¼š<https://itnext.io/explained-rust-futures-for-web-development-b1d0632490e7?source=collection_archive---------1----------------------->

## *æ­£å¦‚æˆ‘åœ¨ä¸Šä¸€ç¯‡æ–‡ç« * *ä¸­è§£é‡Šçš„é‚£æ ·ï¼ŒæœŸè´§æ˜¯å¼‚æ­¥ç¯å¢ƒçš„ä¸€éƒ¨åˆ†ã€‚æˆ‘ä»¬éœ€è¦è¯­æ³•ã€ç±»å‹å’Œè¿è¡Œæ—¶æ¥ä»¥éé˜»å¡çš„æ–¹å¼è¿è¡Œä»£ç ã€‚æœŸè´§æ˜¯ Rust å¼‚æ­¥æ•…äº‹çš„å…¸å‹éƒ¨åˆ†ã€‚*

# ä¸¤ç§è§‚ç‚¹

å¦‚æœä½ æ¥è‡ª NodeJSï¼ŒRust çš„æœªæ¥æ²¡æœ‰å¤šå¤§æ„ä¹‰ã€‚åœ¨ NodeJS ä¸­ï¼Œä¸€åˆ‡éƒ½æ˜¯å¼‚æ­¥å‘ç”Ÿçš„ã€‚å› æ­¤ï¼Œä¸ºäº†è®©ä½ èƒ½å¤Ÿè¯´â€œå˜¿ï¼Œæˆ‘çœŸçš„éœ€è¦ç­‰å¾…è¿™ä¸ª GET HTTP è°ƒç”¨çš„ç­”æ¡ˆâ€ï¼Œä½ æŠŠ`.then()`æ”¾åœ¨äº†`Promise`ä¸Šï¼Œè¿™æ ·ä½ å°±å¯ä»¥ç¡®ä¿å½“ HTTP è°ƒç”¨ç»“æŸæ—¶ï¼Œä½ åªæ˜¯æ‰§è¡Œäº†`.then()`ä¸­çš„ä»£ç ã€‚

åœ¨ Rust ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€åˆ‡éƒ½æ˜¯é˜»å¡å’ŒåŒæ­¥çš„ï¼Œæ‰€ä»¥ä½ å¯èƒ½ä¼šé—®è‡ªå·±:â€œä¸ºä»€ä¹ˆè¦ä¸ºå¤æ‚æ€§è€Œçƒ¦æ¼ï¼Œè¿™æ­£æ˜¯æˆ‘æœ€åˆæƒ³è¦çš„ï¼â€

Rust æ˜¯ä¸€ç§ç³»ç»Ÿç¼–ç¨‹è¯­è¨€ã€‚å› æ­¤ï¼Œè¦åœ¨ Rust ä¸­ç¼–å†™åº”ç”¨ç¨‹åºï¼Œæ‚¨å¿…é¡»å§‹ç»ˆèº«å…¼ä¸¤èŒã€‚â€œç³»ç»Ÿ Hat"(â›‘â€å’Œâ€œç¨‹åºå‘˜å¸½â€(ğŸ©).ç³»ç»Ÿ Hat(â›‘)è®©ä½ ä»æœºå™¨çš„è§’åº¦è€ƒè™‘ä»€ä¹ˆæ˜¯æœ€å¥½çš„ğŸ©)è´Ÿè´£è½¯ä»¶çš„è¯­æ³•å’Œç¼–å†™æ–¹å¼ã€‚

å¦‚æœä½ æ¥è‡ª NodeJSï¼Œç³»ç»Ÿæ˜¯ç”± Googles V8 è¿è¡Œæ—¶è´Ÿè´£çš„ï¼Œæ‰€ä»¥ä½ å¯ä»¥ä¸“æ³¨äºè¯­æ³•ã€‚åœ¨ Rust ä¸­ï¼Œä½ å¯ä»¥ä» crates é‚£é‡Œå¾—åˆ°å¸®åŠ©ï¼Œå°½ç®¡ä½ éœ€è¦è‡ªå·±åšå‡ºæŸäº›å†³å®šã€‚

è¿™å°±æ˜¯æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æœŸè´§çš„åŸå› ã€‚å› æ­¤ï¼Œæ‚¨éœ€è¦åœ¨åº”ç”¨ç¨‹åºä¸­å°† Futures ä½œä¸ºä¸€ç§ç±»å‹æ¥å¤„ç†ï¼Œç„¶åç¡®ä¿ä½¿ç”¨è¿è¡Œæ—¶æ¥å®é™…æ‰§è¡Œå®ƒä»¬ã€‚å¦‚æœä½ åœ¨æ¶ˆè´¹æœŸè´§(ä¾‹å¦‚å½“ä½ ä½¿ç”¨çš„ä¸€ä¸ªç®±å­è¿”å›ä¸€ä¸ª`Future`)ï¼Œä½ å¿…é¡»ç†è§£æ•°æ®æ¥è‡ªå“ªé‡Œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦ç¨‹åºå‘˜å¸½**å’Œ**ç³»ç»Ÿå¸½ã€‚

# `Future`ç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼ŸğŸ©

Rust ä¸­çš„ä¸€ä¸ª`Future`å®é™…ä¸Šæ˜¯ä¸€ä¸ª`trait`ï¼Œå¦‚æœä½ æƒ³å®ç°å®ƒï¼Œçœ‹èµ·æ¥æ˜¯è¿™æ ·çš„:

```
trait Future {
    type Item;
    type Error; fn poll(&mut self) -> Poll<Self::Item, Self::Error>;
}
```

`poll`æ–¹æ³•å¾ˆé‡è¦ã€‚è¿™å°†ä»ä½ çš„è¿è¡Œæ—¶å¾—åˆ°è°ƒç”¨ï¼Œå¹¶å°†è¿”å›`[Async::Ready](https://docs.rs/futures/0.1/futures/enum.Async.html)` [æˆ–](https://docs.rs/futures/0.1/futures/enum.Async.html) `[Async::NotReady](https://docs.rs/futures/0.1/futures/enum.Async.html)`ã€‚

å¦‚æœæ‚¨æƒ³ä»è¿œç¨‹ä½ç½®æˆ–æ–‡ä»¶ç³»ç»Ÿè·å–ä¸åŒçš„æ‚å¿—æœŸï¼Œæ‚¨å¯ä»¥ä¸ºæ­¤åˆ›å»ºå¹¶è¿”å›è‡ªå·±çš„`Future`:

```
struct Magazine {
    issues: Vec<u8>
}
```

è¿˜æœ‰`impl`ä¸Šé¢çš„`Future`ç‰¹è´¨:

```
impl Future for Magazine {
    // here we return a single byte
    type Item = u8;
    type Error = io::Error; // this method is getting called from the runtime. Everytime we can read
    // a byte into the buffer, we return `Async::Ready`
    fn poll(&mut self) -> Poll<Self::Item, Self::Error> {
        let mut buffer = [0;1];
        match self.0.poll_read(&mut buf) {
            Ok(Async::Ready(_num_bytes_read)) => Ok(Async::Ready(buffer[0])),
            Ok(Async::NotReady) => Ok(Async::NotReady),
            Err(e) => Err(e)
        }
    }
}
```

è¿è¡Œæ—¶ä¼šç”¨ä½ è¯·æ±‚çš„ä¿¡æ¯å¡«å……ç¼“å†²åŒºï¼Œä¸€æ—¦ç¼“å†²åŒºæ»¡äº†ï¼Œ`Future`å°±ä¼šè¿”å›`Async::Ready`ã€‚

è¿™å°±æ˜¯é“é”ˆä¸­çš„ä¸€ä¸ª`Future`çš„åŸºæœ¬ç²¾é«“ã€‚

# ä»€ä¹ˆæ—¶å€™ä½¿ç”¨æœŸè´§ï¼ŸğŸ©

> *ä¸ºä¸€ä¸ªç±»å‹å®ç°* `*Future*` *trait æ˜¯ä½ å‘Šè¯‰æœºå™¨â€œå˜¿ï¼Œè¿™å¯èƒ½è¦èŠ±ç‚¹æ—¶é—´ï¼Œåœ¨æ‰§è¡Œè¿™éƒ¨åˆ†ä»£ç æ—¶è€ƒè™‘ä¸€ä¸‹â€çš„æ–¹å¼ã€‚*

Rust æ˜¯ä¸€ç§åŒæ­¥è¯­è¨€ã€‚æ‰€æœ‰çš„äº‹æƒ…éƒ½æ˜¯ä¸€è¡Œä¸€è¡Œåœ°å‘ç”Ÿï¼Œå¹¶ä¸”ä¸€ç›´ç­‰åˆ°æ¯ä¸ªç»“æœéƒ½è¢«å¤„ç†å®Œã€‚è¿™ä¸æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œé™¤éä½ æƒ³åšéœ€è¦æ›´é•¿æ—¶é—´å¤„ç†çš„ä»»åŠ¡ã€‚

å¦‚æœä½ ç”¨ Rust åˆ›å»ºä¸€ä¸ªå¾®æœåŠ¡ï¼Œä½ éœ€è¦ä¸ºä¸€äº›æ•°æ®è·å–å¦å¤–ä¸‰ä¸ªå¾®æœåŠ¡ï¼Œç„¶åä½ åˆå¹¶æ•°æ®å¹¶æŠŠå®ƒå†™å…¥æ•°æ®åº“ï¼Œè¿™æ˜¯ä¸€ä¸ªä½ æƒ³è€ƒè™‘ä½¿ç”¨ Futures çš„ç”¨ä¾‹ã€‚

# ä¸ºä»€ä¹ˆä½¿ç”¨æœŸè´§å¯ä»¥èŠ‚çœæ—¶é—´ï¼Ÿâ›‘

åœ¨æˆ‘ä»¬çš„æµ‹è¯•åœºæ™¯ä¸­ï¼Œæ¯”æ–¹è¯´ï¼Œæ¯ä¸ª HTTP è°ƒç”¨å¯èƒ½éœ€è¦ 1 åˆ†é’Ÿã€‚ç°åœ¨ï¼Œä¸æ˜¯ç­‰å¾… 3 åˆ†é’Ÿæ¥å®Œæˆæ‰€æœ‰çš„è°ƒç”¨ï¼Œè€Œæ˜¯å¸Œæœ›å¹¶è¡Œè¿è¡Œå®ƒä»¬ï¼Œè¿™æ ·æ‚¨ä»ç„¶åªéœ€ç­‰å¾… 1 åˆ†é’Ÿè€Œä¸æ˜¯ 3 åˆ†é’Ÿã€‚

å› æ­¤ï¼Œæ‚¨åˆ›å»ºäº†ä¸‰ä¸ªæ–¹æ³•ï¼Œæ¯ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ª`Future`ï¼Œæ”¶é›†å®ƒä»¬ï¼Œç„¶åå°†å®ƒä»¬ä¼ é€’ç»™è¿è¡Œæ—¶(ä¾‹å¦‚ï¼Œé€šè¿‡`tokio::run`ä¼ é€’ç»™ tokio)ã€‚

# æœŸè´§æ€ä¹ˆç”¨ï¼ŸğŸ© + â›‘

å¦‚æœæ¿æ¡ç®±è¿”å›ä¸€ä¸ª`Future`ï¼Œä¸€æ—¦`Future`å‡†å¤‡å¥½ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`[.and_then()](https://docs.rs/futures/0.1.26/futures/future/struct.AndThen.html)`å¤„ç†ç»“æœã€‚åœ¨`Future`ä¸Šä½¿ç”¨`[.map()](https://docs.rs/futures/0.1.26/futures/future/struct.Map.html)`å¯ä»¥æ”¹å˜`Future`çš„ç±»å‹ã€‚

åœ¨å¼‚æ­¥ Rust ä¸–ç•Œä¸­ï¼Œæˆ‘ä»¬å¿…é¡»å¤„ç†ä¸åŒç±»å‹çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬ä¸æ˜¯ä½¿ç”¨å­—ç¬¦ä¸²å’Œæ•°å­—ï¼Œè€Œæ˜¯å¤„ç†å€¼æµã€‚æ‚¨å¾ˆå¯èƒ½ä¼šå¤„ç†æµã€‚

ä¸€ä¸ª`Stream`æ˜¯ä¸€ä¸ªæœªæ¥çš„å»¶ä¼¸ã€‚æœªæ¥æ˜¯å…³äºäº§ç”Ÿä¸€ä¸ªå•ä¸€çš„å€¼ï¼Œè€Œ`Stream`æ˜¯äº§ç”Ÿå€¼ï¼Œåªè¦å®ƒä»¬å­˜åœ¨ã€‚

*   [æµ](https://docs.rs/futures/0.1.26/futures/stream/index.html):ä¸€ä¸ª`Stream`å°±åƒä¸€ä¸ª`Future`ä¸€æ ·ï¼Œæ˜¯ä¸€ä¸ªä½ å¯ä»¥åœ¨ä¸€ä¸ªç±»å‹ä¸Š`impl`çš„ç‰¹å¾ã€‚è¿™å…è®¸æ‚¨è¿­ä»£è¿”å›å€¼(å³`Some(_)`æˆ–`None`)ã€‚
*   [æ¥æ”¶å™¨](https://docs.rs/futures/0.1.26/futures/sink/index.html):ç”¨äºè¿ç»­(ä»¥å¼‚æ­¥æ–¹å¼)å°†æ•°æ®å†™å…¥å¥—æ¥å­—æˆ–æ–‡ä»¶ç³»ç»Ÿ

æ‰€ä»¥æµæ˜¯ç”¨æ¥è¯»æ•°æ®çš„ï¼Œæ¥æ”¶å™¨æ˜¯ç”¨æ¥å†™æ•°æ®çš„ã€‚åœ¨æˆ‘ä»¬çš„ç½‘ç»œç”Ÿæ€ç³»ç»Ÿä¸­æœ‰ä¸¤ç§ç±»å‹çš„æµ:

*   å­—èŠ‚æµ(å¦‚ HTTP ä¸»ä½“æˆ– TCP æµ)
*   æ¶ˆæ¯æµ(å¦‚ WebSocket å¸§æˆ– UDP æ•°æ®åŒ…)ï¼Œå…¶ä¸­æ¯ä¸ªæ¶ˆæ¯éƒ½æœ‰å›ºå®šçš„å¤§å°

# ä»£ç ç¤ºä¾‹

è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªç”¨ä¾‹ï¼Œæ‚¨æ­£åœ¨ä½¿ç”¨çš„æ¿æ¡ç®±è¿”å›ä¸€ä¸ª`Future`ã€‚åœ¨åš HTTP è°ƒç”¨çš„æ—¶å€™ï¼Œ`reqwest`å°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚åœ¨ä»`reqwest`è¿”å›çš„`Future`ä¸Šï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`.and_then()`æ¥å¤„ç†ç»“æœ(ğŸ©):

```
// We have to use "r#" before "async" because "async" is a reserved keyword.
use reqwest::r#async::Client;// The return type has to be `Future<Item=(), Error=()>` to be able
// to use `tokio::run`. 
// If it has a different type, you have to use `tokio::block_on`
fn fetch_data() -> impl Future<Item=(), Error=()> {
    Client::new()
        .get(url)
        .send()
        .and_then(|res| {
            res.into_body().concat2()
        })
        .map_err(|err| println!("request error: {}", err))
        .map(|body| {
            // here you can use the body to write it to a file
            // or return it via Ok()
            // If you return it via for example Ok(users)
            // then you need to adjust the return type in impl Future<Item=TYPE
            // Examples can be found here: 
            // https://github.com/gruberb/futures_playground // For now, lets just turn the body into a Vector
            let v = body.to_vec();
        })
}
```

ä¸€æ—¦ä½ åˆ›å»ºäº†è¿”å›ä¸€ä¸ª`Future` ( `fetch_data()`)ï¼Œ**çš„æ–¹æ³•ï¼Œä½ å¿…é¡»æŠŠå®ƒä¼ é€’ç»™ä¸€ä¸ªè¿è¡Œæ—¶**ï¼Œæ¯”å¦‚ tokio (â›‘):

```
tokio::run(fetch_data());
```

# é«˜çº§æ¦‚è¿°

1.  æ‚¨ä»å¤–éƒ¨æ¿æ¡ç®±æ”¶åˆ°ä¸€ä¸ª`Future`
2.  ä¸€ä¸ª`Future`å¾ˆå¯èƒ½è¿”å›ä¸€ä¸ª`Stream`å€¼ï¼Œæ‰€ä»¥ä½ å¿…é¡»å°†è¿™ä¸ª`Stream`å½¢æˆä¸€ä¸ªä½ å¯ä»¥åŒæ­¥å¤„ç†çš„ç±»å‹(æ¯”å¦‚ä¸€ä¸ªå‘é‡æˆ–è€…å­—ç¬¦ä¸²)
3.  æ‚¨é€šè¿‡`-> impl Future<Item=(), Error=()>`ä»ä¸€ä¸ªæ–¹æ³•ä¸­è¿”å›æ•´ä¸ªæœªæ¥ï¼Œå…¶ä¸­å¤§æ‹¬å·`()`æ˜¯æ‚¨æƒ³è¦è¿”å›çš„å®é™…ç±»å‹çš„å ä½ç¬¦
4.  æ‚¨é€šè¿‡`tokio::run(method())`å°†æ–¹æ³•ä¼ é€’ç»™è¿è¡Œæ—¶ï¼Œå¦‚ tokio
5.  `run`è°ƒç”¨å°†å¯åŠ¨è¿è¡Œæ—¶ï¼Œè®¾ç½®æ‰€éœ€çš„èµ„æºï¼Œç„¶åå°†è¿™ä¸ªæœªæ¥æ”¾åœ¨ä¸€ä¸ªçº¿ç¨‹æ± ä¸­ï¼Œå¹¶å¼€å§‹è½®è¯¢æ‚¨çš„æœªæ¥
6.  ç„¶åï¼Œå®ƒä¼šå°è¯•å°†å·¥ä½œä¼ é€’ç»™æ“ä½œç³»ç»Ÿ
7.  æ¯æ¬¡è¿è¡Œæ—¶è½®è¯¢ä½ çš„`Future`ï¼Œå¦‚æœä½ çš„`Future`æ­£åœ¨ç­‰å¾…çš„åº•å±‚ I/O èµ„æºæ²¡æœ‰å‡†å¤‡å¥½ï¼Œå®ƒå°†è¿”å›`NotReadyâ€‹`ã€‚è¿è¡Œæ—¶çœ‹åˆ°è¿™ä¸ª`NotReadyâ€‹`è¿”å›å€¼å¹¶è®©ä½ çš„`Future`ä¼‘çœ 
8.  ä¸€æ—¦æ¥è‡ªåº•å±‚ I/O èµ„æºçš„äº‹ä»¶åˆ°æ¥ï¼Œè¿è¡Œæ—¶å°†æ£€æŸ¥è¯¥ I/O èµ„æºæ˜¯å¦ä¸æ‚¨çš„`Future`ç›¸å…³è”ï¼Œå¹¶å†æ¬¡å¼€å§‹è½®è¯¢ã€‚è¿™ä¸€æ¬¡ï¼Œæ‚¨çš„`Future`å°†èƒ½å¤Ÿè¿”å›ä¸€ä¸ªå¸¦æœ‰å€¼çš„`Ready`ï¼Œå› ä¸ºåº•å±‚ I/O èµ„æºå·²ç»æä¾›äº†ä¸€ä¸ªå€¼
9.  ç„¶åï¼Œè¿è¡Œæ—¶ä¼šå°†`Future`çš„çŠ¶æ€è®¾ç½®ä¸ºå°±ç»ªï¼Œå¹¶å¤„ç†ä»£ç çš„`.and_then()`éƒ¨åˆ†

ä¸ NodeJS ä¸åŒçš„æ˜¯ï¼Œ`Future`æ˜¯é€šè¿‡`tokio::run`è€Œä¸æ˜¯ä¹‹å‰æ‰§è¡Œçš„ã€‚åœ¨ Node ä¸­ï¼Œåªè¦ä½ å†™äº†ä¸€ä¸ª`Promise`ï¼Œå¯¹è±¡å°±ä¼šè¢«ç«‹å³è¿”å›ã€‚

# æœŸè´§æœ‰ä»€ä¹ˆä¸ä¸€æ ·æˆ–è€…éš¾çš„ï¼Ÿâ›‘

è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸Šé¢çš„ä¾‹å­:

*   æˆ‘ä»¬ç”¨æˆ‘ä»¬çš„è¯·æ±‚`Client::new()`å’Œ`.send()`åˆ›å»ºä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯
*   æˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ª`[Response](https://github.com/seanmonstar/reqwest/blob/master/src/async_impl/response.rs#L24)`å›æ¥:

```
pub struct Response {
    status: StatusCode,
    headers: HeaderMap,
    url: Box<Url>,
    body: Decoder,
    ...
}
```

*   æœºèº«æœ¬èº«å°±æ˜¯ä¸€ä¸ªè§£ç å™¨ï¼Œå¯ä»¥é€šè¿‡`[.into_body()](https://github.com/seanmonstar/reqwest/blob/master/src/async_impl/response.rs#L113)`å˜æˆä¸€ä¸ª`Body`ã€‚
*   `Body`æœ¬èº«[å®ç°](https://github.com/seanmonstar/reqwest/blob/master/src/async_impl/decoder.rs#L155)ä¸€ä¸ª[æµ](https://docs.rs/futures/0.1.26/futures/stream/trait.Stream.html)(å¦‚å‰æ‰€è¿°)ã€‚
*   ç°åœ¨æˆ‘ä»¬å¯ä»¥ä» Rust çš„ Futures API ä¸­æ‰¾åˆ°ç­”æ¡ˆ:æˆ‘ä»¬å¯ä»¥é€šè¿‡`[.concat2()](https://docs.rs/futures/0.1.26/futures/stream/struct.Concat2.html)`å°†ä¸€ä¸ªå­—èŠ‚æµè½¬æ¢æˆä¸€ä¸ªæ¡ç›®

```
...
        .and_then(|res| {
            res.into_body().concat2()
        })
...
```

*   æˆ‘ä»¬å°†`.map()`éƒ¨åˆ†ä¸­çš„è¿™ä¸€é¡¹ä½œä¸º`body`
*   åœ¨ä½ çš„ä»£ç ç¼–è¾‘å™¨çš„å¸®åŠ©ä¸‹ï¼Œä½ ä¼šå‘ç°è¿™ä¸ª`body`å®é™…ä¸Šæ˜¯ä¸€ä¸ª`[Chunk](https://github.com/hyperium/hyper/blob/master/src/body/chunk.rs)`ï¼Œä»åº“`[Hyper](https://github.com/hyperium/hyper)`è¿”å›
*   æˆ‘ä»¬ç°åœ¨å¯ä»¥æŠŠè¿™ä¸ª`Chunk`å˜æˆä¸€ä¸ª`[Vector](https://doc.rust-lang.org/std/vec/struct.Vec.html)`

```
...
        .map(|body| {
            let v = body.to_vec();
            // do whatever with v
        })
...
```

ä»é‚£æ—¶èµ·ï¼Œæˆ‘ä»¬å›åˆ°äº†â€œæ­£å¸¸çš„â€é“é”ˆåœ°å¸¦ï¼Œå¯ä»¥å¿˜è®°åˆšåˆšå‘ç”Ÿçš„äº‹æƒ…ğŸ™ƒã€‚

> *ä½ å¯ä»¥åœ¨è¿™ä¸ª* [*GitHub èµ„æºåº“*](https://github.com/gruberb/futures_playground) *ä¸­æ‰¾åˆ°å®Œæ•´çš„ä¾‹å­ã€‚åœ¨é‚£é‡Œæˆ‘æ¥æ”¶åˆ°ä¸€ä¸ª* `*JSON*` *å¹¶æŠŠå®ƒå†™åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚*

è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¸€å¼€å§‹å¤„ç†æœŸè´§å¦‚æ­¤è‰°éš¾çš„åŸå› ä¹‹ä¸€ã€‚ä½ å¿…é¡»è€ƒè™‘æ¯” NodeJS æ›´ä½çš„å±‚æ¬¡ã€‚æ­¤å¤–ï¼Œ`async/await`è¯­æ³•[è¿˜ä¸æ˜¯æœ€ç»ˆçš„](https://internals.rust-lang.org/t/await-syntax-discussion-summary/9914)ï¼Œè¿™å¯¼è‡´äº†æ›´å¤šçš„é”…ç‚‰ä»£ç ã€‚

è¿™äº›å¿ƒç†æ­¥éª¤æœ‰åŠ©äºä½ åœ¨å¤„ç†æœŸè´§äº¤æ˜“æ—¶ä¸è¿·å¤±æ–¹å‘:

1.  æˆ‘ä»è¿™ä¸ªåº“ä¸­å¾—åˆ°çš„è¿”å›ç±»å‹æˆ–å€¼æ˜¯ä»€ä¹ˆï¼Ÿ
2.  æˆ‘å¦‚ä½•è®¿é—®è¿™ä¸ªå“åº”çš„å€¼çš„`Stream`?
3.  å½“æˆ‘é€šè¿‡`.concat2()`æ”¶é›†æ‰€æœ‰å€¼æ—¶ï¼Œåº“å°†æŠŠè¿™ä¸ª`Stream`å˜æˆä»€ä¹ˆï¼Ÿ
4.  æˆ‘å¦‚ä½•å°†è¿™ç§æ–°ç±»å‹è½¬æ¢æˆ Vector æˆ–å¦ä¸€ç§ Rust std æ ¼å¼ï¼Œä»¥ä¾¿å¯ä»¥å°†å…¶ä¼ é€’ç»™åŒæ­¥æ–¹æ³•ï¼Ÿ

![](img/a1af3570fda438757f4b661f7781cf11.png)

åŸºæœ¬ä¸Šï¼Œä½ æ€»æ˜¯æƒ³å¼„æ¸…æ¥šå¦‚ä½•è®¿é—®å€¼æµï¼Œæ”¶é›†å®ƒä»¬ï¼Œç„¶åå¤„ç†ç»“æœå¯¹è±¡ã€‚

# å¦‚ä½•æ‰§è¡Œå¤šä¸ª`Future`ï¼ŸğŸ©

ä¸€èˆ¬æ¥è¯´ï¼Œä½ æƒ³æŠŠä½ çš„å€¼æ”¶é›†æˆ`Streams`ï¼Œè¿™æ ·å¯¹äºä½ ä»`Stream`ä¸­å¾—åˆ°çš„æ¯ä¸€é¡¹ï¼Œä½ å¯ä»¥æ´¾ç”Ÿå‡ºä¸€ä¸ªæ–°çš„`Future`æ¥å¤„ç†å®ƒã€‚

Rust Futures API æœ‰ä¸€ä¸ªåä¸º`[FuturesUnordered](https://docs.rs/futures/0.1.26/futures/stream/futures_unordered/struct.FuturesUnordered.html)`çš„æ–¹æ³•ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥æ·»åŠ å¤šä¸ª`Future`:

```
use futures::stream::futures_unordered::FuturesUnordered;
use hyper::{client::ResponseFuture, Client};fn setup_requests() -> FuturesUnordered<ResponseFuture> {
    let mut list_of_futures = FuturesUnordered::new(); let client = Client::new(); let first = client.get(URL);
    list_of_futures.push(first); let second = client.get(URL);
    list_of_futures.push(second); list_of_futures
}
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨`[hyper](https://github.com/hyperium/hyper)`è¿›è¡Œ HTTP è°ƒç”¨ã€‚ä½ å¯ä»¥åœ¨ Github ä¸Šæ‰¾åˆ°å‰©ä¸‹çš„ä»£ç [ã€‚](https://github.com/chicagohaskell/async-futures-talk/blob/master/rustlb/examples/multi-http/src/main.rs)

å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯`reqwest`ï¼Œè¯­æ³•çœ‹èµ·æ¥ä¼šç•¥æœ‰ä¸åŒã€‚è¿™é‡Œä½ `.join()`å¤šä¸ªè¯·æ±‚ï¼Œå¹¶ä½œä¸ºâ€œä¸€ä¸ªæœªæ¥â€è¿”å›ã€‚

```
fn fetch() -> impl Future<Item=(), Error=()> {
    let client = Client::new(); let json = |mut res : Response | {
        res.json::<STRUCT_TYPE>()
    }; let request1 =
        client
            .get(URL)
            .send()
            .and_then(json); let request2 =
        client
            .get(URL)
            .send()
            .and_then(json); request1.join(request2)
        .map(|(res1, res2)|{
            println!("{:?}", res1);
            println!("{:?}", res2);
        })
        .map_err(|err| {
            println!("stdout error: {}", err);
        })
}
```

å®Œæ•´ä»£ç ä¹Ÿå¯ä»¥åœ¨ [GitHub](https://github.com/seanmonstar/reqwest/blob/master/examples/async_multiple_requests.rs) ä¸Šæ‰¾åˆ°ã€‚

# æœŸè´§çš„æœªæ¥å¦‚ä½•ï¼ŸğŸ© + â›‘

æœŸè´§ä»·æ ¼ç¨³å®šåœ¨ 1.37ï¼Œå¤§çº¦åœ¨ 6 æœˆä»½ã€‚è¯­æ³•å’Œè¿è¡Œæ—¶ä¹Ÿæœ‰å˜åŒ–ï¼Œè¿™å°†æœ‰åŠ©äºå‡å°‘æ‚¨å¿…é¡»ç¼–å†™çš„ä»£ç é‡ï¼Œä»¥ä¾¿å°†è¿™ä¸ªå€¼æµä»`Future`ä¸­å–å‡ºå¹¶è½¬æ¢æˆåŒæ­¥ Rust æ ¼å¼ã€‚

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨`[Runtime](https://github.com/rustasync/runtime)` crateï¼Œå®ƒå¯ä»¥ä¸ºæ‚¨èŠ‚çœå‡ ä¹æ‰€æœ‰çš„æ ·æ¿ä»£ç ã€‚å°½ç®¡ç»å†ä¸Šè¿°è¿‡ç¨‹æœ‰åŠ©äºä½ æ›´æ·±å±‚æ¬¡åœ°ç†è§£æœªæ¥ã€‚

# æ‘˜è¦

å¦‚æœæ‚¨æ‰§è¡Œå¼‚æ­¥æ“ä½œï¼Œæ¯”å¦‚ä»æ“ä½œç³»ç»Ÿè·å–æ–‡ä»¶æˆ–å‘è¿œç¨‹æœåŠ¡å™¨å‘å‡º HTTP è¯·æ±‚ï¼Œé‚£ä¹ˆ Futures å…è®¸æ‚¨ä»¥éé˜»å¡çš„æ–¹å¼å¤„ç†è¿”å›å€¼ã€‚

å¦‚æœå®ƒæ˜¯åŒæ­¥çš„ï¼Œæ‚¨å°†ä¸å¾—ä¸é˜»å¡æ­£åœ¨è¿è¡Œæ“ä½œçš„çº¿ç¨‹ï¼Œå¹¶ç­‰å¾…ç»“æœï¼Œç›´åˆ°æ‚¨ç»§ç»­ã€‚ä¸ºäº†ä»¥å¼‚æ­¥æ–¹å¼å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªè¿è¡Œæ—¶ï¼Œå®ƒè‡ªå·±åˆ›å»ºçº¿ç¨‹ï¼Œå¹¶æ‰¿æ‹…æœªæ¥ã€‚å½“æ“ä½œç³»ç»Ÿå‘è¿è¡Œæ—¶è¿”å›å€¼æ—¶ï¼Œå®ƒå°†å¡«å……`Future`ä¸­çš„å€¼ã€‚

ä¸€æ—¦`Future`å®Œæˆï¼Œè¿è¡Œæ—¶è®¾ç½®`Async::Ready`ï¼Œä»£ç çš„`.and_then()`éƒ¨åˆ†å°†è¢«æ‰§è¡Œã€‚