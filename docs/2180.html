<html>
<head>
<title>React Hooks â€” designing a simple forms API â€” part 5 â€” dynamic forms</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">react Hooksâ€”â€”è®¾è®¡ç®€å•çš„è¡¨å•APIâ€”â€”ç¬¬5éƒ¨åˆ†â€”â€”åŠ¨æ€è¡¨å•</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://itnext.io/react-hooks-designing-a-simple-forms-api-part-5-dynamic-forms-b8ceea4a4ff?source=collection_archive---------5-----------------------#2019-04-12">https://itnext.io/react-hooks-designing-a-simple-forms-api-part-5-dynamic-forms-b8ceea4a4ff?source=collection_archive---------5-----------------------#2019-04-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="899e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ç¡®ä¿æˆ‘ä»¬çš„ReactåŸºäºé’©å­çš„è¡¨å•åº“èƒ½å¤Ÿæ”¯æŒåŠ¨æ€è¡¨å•ï¼Œå¹¶åœ¨æ­¤è¿‡ç¨‹ä¸­äº†è§£ä¸€äº›å…³äºé’©å­çŠ¶æ€å’Œé’©å­æµ‹è¯•çš„æœ‰è¶£äº‹æƒ…ã€‚æˆ‘ä»¬çš„åº“å·²ç»æ”¯æŒå¸¦æœ‰é¢„å®šä¹‰è¾“å…¥é›†çš„è¡¨å•ï¼Œä½†æ˜¯å®ƒä¸æ”¯æŒè¾“å…¥æ•°é‡éœ€è¦éšç€æ—¶é—´å¢åŠ æˆ–å‡å°‘çš„è¡¨å•ã€‚</p><p id="177a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">åœ¨æœ¬ç³»åˆ—çš„ç¬¬1éƒ¨åˆ†<a class="ae ko" href="https://medium.com/@shanplourde/react-hooks-designing-a-simple-forms-api-part-1-307b04bc6007" rel="noopener">ä¸­ï¼Œæˆ‘ä»¬ç ”ç©¶äº†å¦‚ä½•ä½¿ç”¨Reacté’©å­æ¥è®¾è®¡ä¸€ä¸ª<code class="fe kp kq kr ks b">useForm</code> Reactè¡¨å•åº“ã€‚ç¬¬1éƒ¨åˆ†ä»‹ç»äº†è¿™ä¸ªåº“çš„åŠ¨æœºå’Œä¸€äº›æ€»ä½“è®¾è®¡ç›®æ ‡ã€‚</a></p><p id="b83f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">åœ¨æœ¬ç³»åˆ—<a class="ae ko" href="https://medium.com/@shanplourde/react-hooks-designing-a-simple-forms-api-part-2-1fe5d12f23d9" rel="noopener">çš„ç¬¬2éƒ¨åˆ†</a>ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª<code class="fe kp kq kr ks b">useInput</code>é’©å­ï¼Œå°†å…¶é›†æˆåˆ°æˆ‘ä»¬çš„<code class="fe kp kq kr ks b">useForm</code>é’©å­ä¸­ï¼Œå›é¡¾äº†æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆçš„çŠ¶æ€ç®¡ç†ï¼Œåˆå¹¶äº†ä¸€äº›é¢å¤–çš„æµ‹è¯•ï¼Œå¹¶æ›´è¯¦ç»†åœ°å›é¡¾äº†æµ‹è¯•ç­–ç•¥ã€‚</p><p id="f5a1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">åœ¨ç¬¬3éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºäº†éªŒè¯ã€å¼‚æ­¥éªŒè¯å’Œå¼‚æ­¥è¡¨å•æäº¤ã€‚å®ƒä¸ºæˆ‘ä»¬æä¾›äº†åŸºäºReact hooksçš„è¡¨å•APIçš„å…³é”®å…ƒç´ ã€‚</p><p id="748b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae ko" rel="noopener ugc nofollow" target="_blank" href="/react-hooks-designing-a-simple-forms-api-part-4-scaling-to-other-input-types-e738db0a3fc3">åœ¨ç¬¬4éƒ¨åˆ†</a>ä¸­ï¼Œæˆ‘ä»¬æ‰©å±•äº†æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆï¼Œä»¥æ”¯æŒæ ‡å‡†HTMLè¾“å…¥ç±»å‹å’Œè‡ªå®šä¹‰è¾“å…¥ã€‚</p><h1 id="4f20" class="kt ku it bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">å·¥ä½œç¤ºä¾‹</h1><p id="6098" class="pw-post-body-paragraph jq jr it js b jt lr jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn im bi translated">è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸€éƒ¨åˆ†å°†åŒ…å«çš„æ‰€æœ‰å†…å®¹çš„æ¼”ç¤ºã€‚</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="mb mc l"/></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">æ¼”ç¤ºæˆ‘ä»¬å°†ä»ç¬¬5éƒ¨åˆ†å¼€å‘çš„åŠ¨æ€è¡¨å•</figcaption></figure><p id="38f9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae ko" href="https://github.com/shanplourde/react-hooks-form-util" rel="noopener ugc nofollow" target="_blank">å®Œæ•´çš„è§£å†³æ–¹æ¡ˆå¯ä»¥åœ¨æˆ‘çš„GitHub </a>ä¸­æ‰¾åˆ°ã€‚æ¼”ç¤ºä¸­æœ‰å¾ˆå¤šæ ·æ¿æ–‡ä»¶ï¼Œä½†æˆ‘å¸Œæœ›åœ¨è¿™ä¸€ç‚¹ä¸Šæœ‰éå¸¸æ˜ç¡®çš„ä¾‹å­ã€‚è¯·æ³¨æ„ï¼Œç”±äºCodeSandboxè®¾è®¡å†³å®šä¸æ”¯æŒä»<code class="fe kp kq kr ks b">package.json</code>åŠ è½½<code class="fe kp kq kr ks b">devDependencies</code>ï¼Œæµ‹è¯•åœ¨æ­¤æ—¶æ²¡æœ‰é€šè¿‡CodeSandboxã€‚</p><h1 id="c0df" class="kt ku it bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">æ”¯æŒåŠ¨æ€æ”¹å˜è¡¨å•è¾“å…¥çš„åŠ¨æœº</h1><p id="917e" class="pw-post-body-paragraph jq jr it js b jt lr jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn im bi translated">æˆ‘èƒ½æƒ³åˆ°è®¸å¤šæ·»åŠ æˆ–åˆ é™¤è¡¨å•å­—æ®µçš„åŠŸèƒ½æœ‰ç”¨çš„è¡¨å•ç¤ºä¾‹ã€‚ä¾‹å¦‚:</p><ul class=""><li id="bf9b" class="mh mi it js b jt ju jx jy kb mj kf mk kj ml kn mm mn mo mp bi translated">æ•è·è¡¨æ ¼æ•°æ®ï¼Œå¹¶å…è®¸ç”¨æˆ·æ·»åŠ æˆ–åˆ é™¤è¡Œ</li><li id="d451" class="mh mi it js b jt mq jx mr kb ms kf mt kj mu kn mm mn mo mp bi translated">ä½ çš„å·¥ä½œæˆ–å±…ä½å†å²(æˆ‘æœ€è¿‘ä¸å¾—ä¸å¡«å†™è¿™äº›è¡¨æ ¼ä¸­çš„ä¸€ç§ï¼Œä½œä¸ºæˆ‘å³å°†å¼€å§‹çš„æ–°å·¥ä½œçš„èƒŒæ™¯è°ƒæŸ¥çš„ä¸€éƒ¨åˆ†ğŸ˜ƒ)</li><li id="23f6" class="mh mi it js b jt mq jx mr kb ms kf mt kj mu kn mm mn mo mp bi translated">åŸºæœ¬ä¸Šä»»ä½•1:nçš„æ•°æ®è¾“å…¥åœºæ™¯</li></ul><p id="de6a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">è¿™ä¸ªç‰¹æ€§è‚¯å®šä¼šå¢åŠ ä»·å€¼ï¼Œæˆ‘è®¤ä¸ºç¡®ä¿<code class="fe kp kq kr ks b">useForm</code>è®¾è®¡æ”¯æŒå®ƒæ˜¯å€¼å¾—çš„ã€‚</p><h1 id="77a4" class="kt ku it bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">è®¾è®¡æ”¯æŒåŠ¨æ€è¡¨å•çš„å…¬å…±API</h1><p id="8217" class="pw-post-body-paragraph jq jr it js b jt lr jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn im bi translated"><code class="fe kp kq kr ks b">useForm</code>å…è®¸è¡¨å•å¼€å‘äººå‘˜ä½¿ç”¨<code class="fe kp kq kr ks b">api.addInput</code>åŠŸèƒ½æ·»åŠ æ–°çš„è¾“å…¥ã€‚ä½†æ˜¯è¡¨å•å¼€å‘äººå‘˜ä¸èƒ½åˆ é™¤è¾“å…¥ï¼Œå¦‚æœè¡¨å•å·²ç»å‘ˆç°ï¼Œå½“å‰ç‰ˆæœ¬çš„<code class="fe kp kq kr ks b">api.addInput</code>å°±ä¼šä¸­æ–­ã€‚</p><h2 id="b1b8" class="mv ku it bd kv mw mx dn kz my mz dp ld kb na nb lh kf nc nd ll kj ne nf lp ng bi translated">å°†api.removeInputæ·»åŠ åˆ°<code class="fe kp kq kr ks b">useForm</code> API</h2><p id="a25b" class="pw-post-body-paragraph jq jr it js b jt lr jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn im bi translated"><code class="fe kp kq kr ks b">api.removeInput</code>åº”è¯¥å…è®¸ä»ç°æœ‰è¡¨å•ä¸­åˆ é™¤è¾“å…¥ã€‚å½“è¢«è°ƒç”¨æ—¶ï¼Œå®ƒåº”è¯¥ç§»é™¤ä¸è¢«ç§»é™¤çš„è¾“å…¥ç›¸å…³è”çš„æ‰€æœ‰çŠ¶æ€ï¼Œä¾‹å¦‚è¾“å…¥å€¼ã€éªŒè¯çŠ¶æ€ç­‰ã€‚</p><h2 id="6a34" class="mv ku it bd kv mw mx dn kz my mz dp ld kb na nb lh kf nc nd ll kj ne nf lp ng bi translated">ä¿®æ­£äº†<code class="fe kp kq kr ks b">api.addInput</code>ä¸å…è®¸æ–°è¾“å…¥è¢«æ·»åŠ åˆ°æ¸²æŸ“è¡¨å•çš„é”™è¯¯</h2><p id="3445" class="pw-post-body-paragraph jq jr it js b jt lr jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn im bi translated">è™½ç„¶<code class="fe kp kq kr ks b">api.addInput</code>æ˜¯æ·»åŠ æ–°è¾“å…¥çš„åŸºç¡€ï¼Œä½†Reacté’©å­æœ‰ä¸€ä¸ªå…³é”®è¦æ±‚â€”â€”æ¸²æŸ“çš„é’©å­æ•°é‡å¿…é¡»ç­‰äºä¸Šä¸€ä¸ªæ¸²æŸ“å‘¨æœŸã€‚</p><p id="8c7a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">è¿™æ˜¯é—®é¢˜çš„æ ¹æœ¬åŸå› ã€‚ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹æˆ‘çš„ç›¸å…³æ–‡ç« ã€‚æœ¬è´¨ä¸Šï¼Œæˆ‘çš„<code class="fe kp kq kr ks b">useInput</code>é’©å­ä¸æ”¯æŒåŠ¨æ€è¡¨å•ï¼Œå› ä¸ºReacté’©å­åœ¨æ¯ä¸ªæ¸²æŸ“å‘¨æœŸéƒ½éœ€è¦è¿™ç§ä¸€è‡´æ€§ã€‚å¾ˆé«˜å…´çŸ¥é“ä½ æ˜¯å¦æ‰“ç®—ç”¨é’©å­æ¥è®¾è®¡ä¸€ä¸ªå¯ä»¥ä¼¸ç¼©çš„ç»“æ„ã€‚</p><h1 id="aa85" class="kt ku it bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">å®æ–½ç»†èŠ‚</h1><p id="a814" class="pw-post-body-paragraph jq jr it js b jt lr jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn im bi translated"><code class="fe kp kq kr ks b">api.removeInput</code>æ˜¯å¯¹<code class="fe kp kq kr ks b">useForm</code>çš„ä¸€ä¸ªå¾®ä¸è¶³é“çš„è¡¥å……ã€‚å®ƒåªéœ€è¦åˆ é™¤ä¸è¢«åˆ é™¤çš„è¾“å…¥ç›¸å…³è”çš„æ‰€æœ‰çŠ¶æ€:</p><pre class="lw lx ly lz gt nh ks ni nj aw nk bi"><span id="4f4c" class="mv ku it ks b gy nl nm l nn no">const removeInput = id =&gt; {<br/>    delete inputs[id];<br/>    delete inputUiState[id];<br/>    delete validators[id];<br/>    delete formValidity[id];<br/>    delete inputValues[id];<br/>    delete originalValues[id];</span><span id="e8c9" class="mv ku it ks b gy np nm l nn no">setInputUiState(inputUiState);<br/>  };</span></pre><p id="1273" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe kp kq kr ks b">useInput</code>æ˜¯ä¸€ä¸ªé’©å­ï¼ŒReactä¸å…è®¸æˆ‘ä»¬ä½¿ç”¨å®ƒæ¥å¢åŠ æˆ–å‡å°‘è¾“å…¥ï¼Œå› ä¸ºé’©å­çš„è®¾è®¡å†³ç­–è¦æ±‚åœ¨æ¸²æŸ“å‘¨æœŸä¸­è°ƒç”¨çš„é’©å­æ•°é‡ä¿æŒä¸€è‡´ã€‚æ‰€ä»¥æˆ‘ä»¬å¿…é¡»ç§»é™¤<code class="fe kp kq kr ks b">useInput</code>é’©å­ï¼Œå¹¶å°†<code class="fe kp kq kr ks b">useInput</code>ç®¡ç†çš„æ‰€æœ‰çŠ¶æ€ç§»å…¥<code class="fe kp kq kr ks b">useForm</code>ã€‚</p><h2 id="f191" class="mv ku it bd kv mw mx dn kz my mz dp ld kb na nb lh kf nc nd ll kj ne nf lp ng bi translated">ä½¿ç”¨è¾“å…¥çŠ¶æ€æ‘˜è¦</h2><p id="809b" class="pw-post-body-paragraph jq jr it js b jt lr jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn im bi translated">useInputä¿æŒä»¥ä¸‹çŠ¶æ€ã€‚æ‰€æœ‰è¿™äº›çŠ¶æ€éƒ½éœ€è¦è½¬ç§»åˆ°<code class="fe kp kq kr ks b">useForm</code>:</p><ul class=""><li id="c18e" class="mh mi it js b jt ju jx jy kb mj kf mk kj ml kn mm mn mo mp bi translated"><code class="fe kp kq kr ks b">inputValue</code></li><li id="da99" class="mh mi it js b jt mq jx mr kb ms kf mt kj mu kn mm mn mo mp bi translated"><code class="fe kp kq kr ks b">originalValue</code> â€”ç”¨äºè·Ÿè¸ªåŸå§‹çŠ¶æ€</li><li id="1bfa" class="mh mi it js b jt mq jx mr kb ms kf mt kj mu kn mm mn mo mp bi translated"><code class="fe kp kq kr ks b">visited</code> â€”å½“è¾“å…¥è·å¾—ç„¦ç‚¹æ—¶æ”¹å˜</li></ul><h2 id="122c" class="mv ku it bd kv mw mx dn kz my mz dp ld kb na nb lh kf nc nd ll kj ne nf lp ng bi translated">ä½¿ç”¨è¡¨å•çŠ¶æ€æ‘˜è¦</h2><p id="6779" class="pw-post-body-paragraph jq jr it js b jt lr jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn im bi translated"><code class="fe kp kq kr ks b">useForm</code>å·²ç»è·Ÿè¸ªæ‰€æœ‰è¾“å…¥å€¼ã€‚æ‰€ä»¥<code class="fe kp kq kr ks b">useInput.inputValue</code>åœ¨æŸç§ç¨‹åº¦ä¸Šæ˜¯å¤šä½™çš„ã€‚useFormä¸éœ€è¦åšä»»ä½•äº‹æƒ…æ¥æ”¯æŒ<code class="fe kp kq kr ks b">useInput.inputValue</code>ã€‚</p><h2 id="1177" class="mv ku it bd kv mw mx dn kz my mz dp ld kb na nb lh kf nc nd ll kj ne nf lp ng bi translated">ä½¿ç”¨è¾“å…¥âŸ¹input.js</h2><p id="822f" class="pw-post-body-paragraph jq jr it js b jt lr jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn im bi translated">ç”±äº<code class="fe kp kq kr ks b">useInput</code>ä¸å†æ˜¯é’©å­ï¼Œæˆ‘å†³å®šæ”¹åä¸º<code class="fe kp kq kr ks b">input.js</code>ã€‚<code class="fe kp kq kr ks b">createInput</code>æ˜¯å–ä»£<code class="fe kp kq kr ks b">useInput</code>çš„æ–°åŠŸèƒ½ã€‚<code class="fe kp kq kr ks b">createInput</code>æ²¡æœ‰å›½å®¶ã€‚æ‰€æœ‰çŠ¶æ€å°†ç”±<code class="fe kp kq kr ks b">useForm</code>ç®¡ç†ã€‚å› æ­¤ï¼Œ<code class="fe kp kq kr ks b">createInput</code>ç¡®ä¿å¯¹äºå®ƒå¤„ç†çš„æ¯ä¸ªäº‹ä»¶ï¼Œå®ƒéƒ½å°†äº‹ä»¶ä¼ é€’ç»™ä¼ å…¥çš„<code class="fe kp kq kr ks b">props</code>ã€‚</p><pre class="lw lx ly lz gt nh ks ni nj aw nk bi"><span id="76b0" class="mv ku it ks b gy nl nm l nn no">const getInputValue = ({ type, checked, value, options }) =&gt; {<br/>  if (type === "checkbox") return checked;<br/>  if (type === "select-multiple")<br/>    return [...options]<br/>      .map(option =&gt; ({<br/>        value: option.value,<br/>        selected: option.selected<br/>      }))<br/>      .filter(option =&gt; option.selected)<br/>      .map(option =&gt; option.value);<br/>  if (type === "radio") {<br/>    if (checked) return value;<br/>    return undefined;<br/>  }<br/>  return value;<br/>};</span><span id="dac2" class="mv ku it ks b gy np nm l nn no">export const createInput = ({ id, value, props = {} }) =&gt; {<br/>  const getSharedProps = () =&gt; ({<br/>    id,<br/>    ...props,<br/>    onChange: (event, inputValue) =&gt; {<br/>      const value = inputValue || getInputValue(event.target);<br/>      props.onChange &amp;&amp; props.onChange({ event, id, value });<br/>    },<br/>    onBlur: (event, inputValue) =&gt; {<br/>      const value = inputValue || getInputValue(event.target);<br/>      props.onBlur &amp;&amp; props.onBlur({ event, id, value });<br/>    },<br/>    onFocus: evt =&gt; {<br/>      props.onFocus &amp;&amp; props.onFocus({ evt, id, value });<br/>    }<br/>  });</span><span id="2fde" class="mv ku it ks b gy np nm l nn no">const getInputProps = inputProps =&gt; ({<br/>    ...getSharedProps(),<br/>    value: value,<br/>    ...(typeof inputProps === "function" ? inputProps(props) : inputProps)<br/>  });</span><span id="962c" class="mv ku it ks b gy np nm l nn no">const getCheckProps = inputProps =&gt; ({<br/>    ...getSharedProps(),<br/>    checked: value,<br/>    ...(typeof inputProps === "function" ? inputProps(props) : inputProps)<br/>  });</span><span id="bddd" class="mv ku it ks b gy np nm l nn no">return {<br/>    id,<br/>    value,<br/>    getInputProps,<br/>    getCheckProps<br/>  };<br/>};</span></pre><h2 id="9364" class="mv ku it bd kv mw mx dn kz my mz dp ld kb na nb lh kf nc nd ll kj ne nf lp ng bi translated">ä½¿ç”¨è¡¨å•æ›´æ”¹</h2><p id="af73" class="pw-post-body-paragraph jq jr it js b jt lr jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn im bi translated">åœ¨è¿™æ¬¡<code class="fe kp kq kr ks b">useForm</code>çš„è¿­ä»£ä¸­ï¼Œæœ€å¤§çš„å˜åŒ–æ˜¯è¿ç§»äº†æ‰€æœ‰ç”±<code class="fe kp kq kr ks b">useInput</code> hookç®¡ç†çš„çŠ¶æ€ã€‚<code class="fe kp kq kr ks b"> api.removeInput</code>è¢«æ·»åŠ ã€‚</p><p id="da7a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">å¼‚æ­¥éªŒè¯ç å‘å¸ƒå’Œä¿®å¤</strong></p><p id="f98d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">æˆ‘ä¹‹å‰ä½¿ç”¨äº†ä¸€ä¸ª<code class="fe kp kq kr ks b">useRef</code>é’©å­æ¥è¯•å›¾é€šè¿‡å¼‚æ­¥éªŒè¯ä¿æŒæœ€æ–°çš„çŠ¶æ€ã€‚æˆ‘å¿˜è®°äº†<code class="fe kp kq kr ks b">useState</code>å’Œ<code class="fe kp kq kr ks b">setState</code>å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥å¦‚æœä½ éœ€è¦æ ¹æ®å½“å‰çŠ¶æ€æ”¹å˜çŠ¶æ€ä¸ºä¸€ä¸ªå€¼ï¼Œä½ éœ€è¦ä½¿ç”¨å‡½æ•°ç‰ˆæœ¬çš„useStateã€‚ä¾‹å¦‚:</p><pre class="lw lx ly lz gt nh ks ni nj aw nk bi"><span id="c8c8" class="mv ku it ks b gy nl nm l nn no">const [formValidity, setFormValidity] = useState({});</span><span id="48c3" class="mv ku it ks b gy np nm l nn no">...</span><span id="a5e5" class="mv ku it ks b gy np nm l nn no">setFormValidity(current =&gt; ({<br/>        ...current,<br/>        [id]: { isValidating: true, value }<br/>      }));</span></pre><p id="cd12" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">useForm.jsçš„å®Œæ•´æºä»£ç å¦‚ä¸‹:</p><pre class="lw lx ly lz gt nh ks ni nj aw nk bi"><span id="0f75" class="mv ku it ks b gy nl nm l nn no">import { useState, useRef } from "react";<br/>import { createInput } from "./input";<br/>import { runValidators, validateInputEvents } from "./validators";</span><span id="ca93" class="mv ku it ks b gy np nm l nn no">export const defaultFormProps = {<br/>  autoComplete: "on"<br/>};</span><span id="2ca1" class="mv ku it ks b gy np nm l nn no">export const useForm = ({ id, initialState = {} }) =&gt; {<br/>  const [inputValues] = useState({<br/>    ...initialState<br/>  });<br/>  const [formValidity, setFormValidity] = useState({});<br/>  const [validators] = useState({});<br/>  const [uiState, setUiState] = useState({<br/>    isValidating: false,<br/>    isValid: true,<br/>    isSubmitting: false<br/>  });<br/>  const [inputs] = useState({});<br/>  const [inputUiState, setInputUiState] = useState({});<br/>  const [originalValues] = useState({});</span><span id="ced2" class="mv ku it ks b gy np nm l nn no">const validationRuntimeMap = useRef(new Map());</span><span id="6665" class="mv ku it ks b gy np nm l nn no">const validateAll = async eventType =&gt; {<br/>    const promises = [];<br/>    let newUiState = { ...uiState };</span><span id="11a3" class="mv ku it ks b gy np nm l nn no">Object.keys(validators).forEach(async field =&gt; {<br/>      promises.push(<br/>        runValidators({<br/>          field,<br/>          validators: validators[field],<br/>          eventType,<br/>          value: inputs[field].value,<br/>          inputValues<br/>        })<br/>      );<br/>    });</span><span id="ccf5" class="mv ku it ks b gy np nm l nn no">newUiState = {<br/>      ...newUiState,<br/>      isValidating: true<br/>    };<br/>    setUiState(newUiState);</span><span id="4eba" class="mv ku it ks b gy np nm l nn no">const results = await Promise.all(promises).catch(() =&gt; {<br/>      // Do nothing, validation library handles errors.<br/>    });<br/>    results.forEach(result =&gt; {<br/>      formValidity[result.field] = result;<br/>    });</span><span id="fe7e" class="mv ku it ks b gy np nm l nn no">setUiState({ ...newUiState, isValidating: false });<br/>  };</span><span id="2187" class="mv ku it ks b gy np nm l nn no">const onSubmit = async (evt, props) =&gt; {<br/>    evt.preventDefault();<br/>    let newUiState = { ...uiState };<br/>    try {<br/>      await validateAll(validateInputEvents.onSubmit, evt.timeStamp);<br/>      const isFormValid = !Object.keys(formValidity).some(<br/>        field =&gt; !formValidity[field].valid<br/>      );</span><span id="6bdb" class="mv ku it ks b gy np nm l nn no">newUiState = {<br/>        ...newUiState,<br/>        isSubmitting: true,<br/>        isValid: isFormValid<br/>      };<br/>      setUiState(newUiState);<br/>      if (props.onSubmit) {<br/>        await props.onSubmit({ evt, inputValues });<br/>      }<br/>    } catch (e) {<br/>      setUiState({ ...newUiState, isSubmitting: false });<br/>    } finally {<br/>      setUiState({ ...newUiState, isSubmitting: false });<br/>    }<br/>  };</span><span id="3774" class="mv ku it ks b gy np nm l nn no">const getFormProps = (props = {}) =&gt; ({<br/>    ...defaultFormProps,<br/>    ...props,<br/>    onSubmit: evt =&gt; {<br/>      onSubmit(evt, props);<br/>    }<br/>  });</span><span id="79a8" class="mv ku it ks b gy np nm l nn no">const onInputChange = ({ event, id, value }) =&gt; {<br/>    inputValues[id] = value;<br/>    setInputUiState({<br/>      ...inputUiState,<br/>      [id]: { ...inputUiState[id], pristine: value === originalValues[id] }<br/>    });</span><span id="e863" class="mv ku it ks b gy np nm l nn no">runInputValidations({<br/>      id,<br/>      value,<br/>      eventType: validateInputEvents.onChange,<br/>      timeStamp: event.timeStamp<br/>    });<br/>  };</span><span id="1adf" class="mv ku it ks b gy np nm l nn no">const isValidatorAlreadyRunning = (id, value) =&gt;<br/>    formValidity[id] &amp;&amp;<br/>    formValidity[id].isValidating &amp;&amp;<br/>    formValidity[id].value === value;</span><span id="2bb2" class="mv ku it ks b gy np nm l nn no">// Discard oldest async validations on a given input<br/>  const isCurrentValidationRunLatest = (runtimeMap, id, timeStamp) =&gt;<br/>    runtimeMap.get(id) === undefined || runtimeMap.get(id) &lt;= timeStamp;</span><span id="8aeb" class="mv ku it ks b gy np nm l nn no">const runInputValidations = async ({ id, value, eventType, timeStamp }) =&gt; {<br/>    validationRuntimeMap.current.set(id, timeStamp);<br/>    const filteredValidators = validators[id].filter(validator =&gt; {<br/>      return validator.when.some(whenItem =&gt; whenItem === eventType);<br/>    });<br/>    if (filteredValidators.length === 0) return;</span><span id="3c03" class="mv ku it ks b gy np nm l nn no">if (validators[id]) {<br/>      const isCurrentRunLatest = () =&gt;<br/>        isCurrentValidationRunLatest(<br/>          validationRuntimeMap.current,<br/>          id,<br/>          timeStamp<br/>        );</span><span id="2124" class="mv ku it ks b gy np nm l nn no">if (isValidatorAlreadyRunning(id, value)) {<br/>        // No need to do anything at this point since validator is already running,<br/>        return;<br/>      }<br/>      if (!isCurrentRunLatest()) return;</span><span id="2478" class="mv ku it ks b gy np nm l nn no">setFormValidity(current =&gt; ({<br/>        ...current,<br/>        [id]: { isValidating: true, value }<br/>      }));</span><span id="a888" class="mv ku it ks b gy np nm l nn no">if (!isCurrentRunLatest()) return;</span><span id="c017" class="mv ku it ks b gy np nm l nn no">if (!isCurrentRunLatest()) return;</span><span id="472e" class="mv ku it ks b gy np nm l nn no">setFormValidity(current =&gt; ({<br/>        ...current,<br/>        [id]: { ...current[id], isValidating: true, value }<br/>      }));</span><span id="d1b5" class="mv ku it ks b gy np nm l nn no">if (!isCurrentRunLatest()) return;</span><span id="81da" class="mv ku it ks b gy np nm l nn no">try {<br/>        const validationResults = await runValidators({<br/>          field: id,<br/>          validators: validators[id],<br/>          eventType: eventType,<br/>          value,<br/>          runId: timeStamp,<br/>          inputValues<br/>        });</span><span id="fcb4" class="mv ku it ks b gy np nm l nn no">if (!isCurrentRunLatest()) return;</span><span id="8f4b" class="mv ku it ks b gy np nm l nn no">setFormValidity(current =&gt; ({ ...current, [id]: validationResults }));<br/>      } catch {<br/>        // Do nothing, validation library handles errors<br/>      }<br/>    }<br/>  };</span><span id="af0a" class="mv ku it ks b gy np nm l nn no">const onInputBlur = async ({ event, id, value }) =&gt; {<br/>    runInputValidations({<br/>      id,<br/>      value,<br/>      eventType: validateInputEvents.onBlur,<br/>      timeStamp: event.timeStamp<br/>    });<br/>  };</span><span id="0a76" class="mv ku it ks b gy np nm l nn no">const onInputFocus = ({ event, id }) =&gt; {<br/>    setInputUiState({<br/>      ...inputUiState,<br/>      [id]: { ...inputUiState[id], visited: true }<br/>    });<br/>  };</span><span id="dbdc" class="mv ku it ks b gy np nm l nn no">const isBlurWithinRadioGroup = (event, id) =&gt;<br/>    event.relatedTarget &amp;&amp; event.relatedTarget.getAttribute("name") === id;</span><span id="be8c" class="mv ku it ks b gy np nm l nn no">const onRadioGroupBlur = async ({ id, value, event }) =&gt; {<br/>    if (isBlurWithinRadioGroup(event, id)) return;</span><span id="37a8" class="mv ku it ks b gy np nm l nn no">runInputValidations({<br/>      id,<br/>      value,<br/>      eventType: validateInputEvents.onBlur,<br/>      timeStamp: event.timeStamp<br/>    });<br/>  };</span><span id="0109" class="mv ku it ks b gy np nm l nn no">const addInput = ({<br/>    id,<br/>    value,<br/>    validators: inputValidators = [],<br/>    inputProps = {<br/>      onChange: onInputChange,<br/>      onBlur: onInputBlur,<br/>      onFocus: onInputFocus<br/>    }<br/>  }) =&gt; {<br/>    originalValues[id] =<br/>      typeof originalValues[id] === "undefined" ? value : originalValues[id];<br/>    inputValues[id] =<br/>      typeof inputValues[id] === "undefined" ? value : inputValues[id];</span><span id="3e18" class="mv ku it ks b gy np nm l nn no">const input = createInput({<br/>      id,<br/>      value: inputValues[id],<br/>      props: inputProps<br/>    });<br/>    inputs[id] = input;<br/>    inputUiState[id] = inputUiState[id] || {<br/>      pristine: true,<br/>      visited: false<br/>    };<br/>    validators[id] = inputValidators;<br/>    return input;<br/>  };</span><span id="d177" class="mv ku it ks b gy np nm l nn no">const addRadioGroup = ({ id, value, validators = [], inputProps }) =&gt; {<br/>    const input = addInput({<br/>      id,<br/>      value,<br/>      validators,<br/>      inputProps: {<br/>        ...inputProps,<br/>        onChange: onInputChange,<br/>        onBlur: onRadioGroupBlur,<br/>        onFocus: onInputFocus<br/>      }<br/>    });<br/>    return input;<br/>  };</span><span id="b4d5" class="mv ku it ks b gy np nm l nn no">const removeInput = id =&gt; {<br/>    delete inputs[id];<br/>    delete inputUiState[id];<br/>    delete validators[id];<br/>    delete formValidity[id];<br/>    delete inputValues[id];<br/>    delete originalValues[id];</span><span id="1866" class="mv ku it ks b gy np nm l nn no">setInputUiState(inputUiState);<br/>  };</span><span id="f1c0" class="mv ku it ks b gy np nm l nn no">return {<br/>    id,<br/>    getFormProps,<br/>    formValidity,<br/>    uiState,<br/>    inputs,<br/>    inputValues,<br/>    inputUiState,<br/>    api: {<br/>      addInput,<br/>      addRadioGroup,<br/>      removeInput<br/>    }<br/>  };<br/>};</span></pre><h1 id="4fae" class="kt ku it bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">æµ‹è¯•æ›´æ–°</h1><p id="d391" class="pw-post-body-paragraph jq jr it js b jt lr jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn im bi translated">ä½œä¸ºæ­¤æ¬¡æ›´æ–°çš„ä¸€éƒ¨åˆ†ï¼Œå¯¹æµ‹è¯•è¿›è¡Œäº†è®¸å¤šæ›´æ”¹ã€‚åœ¨æˆ‘çš„æµ‹è¯•ä¸­ï¼Œæˆ‘æ²¡æœ‰å§‹ç»ˆå¦‚ä¸€åœ°ä½¿ç”¨<code class="fe kp kq kr ks b">act()</code>ã€‚æˆ‘ä»threepointoneçš„<a class="ae ko" href="https://github.com/threepointone/react-act-examples/blob/master/sync.md" rel="noopener ugc nofollow" target="_blank"> react-act-examples </a>ä¸­å­¦åˆ°äº†ä¸€äº›å¥½çš„æŠ€å·§ï¼Œå¸®åŠ©æˆ‘æé«˜äº†å¯¹<code class="fe kp kq kr ks b">act()</code>çš„ä½¿ç”¨ã€‚</p><p id="6535" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">åœ¨æˆ‘çš„é’©å­æµ‹è¯•ä¸­ï¼Œæˆ‘åœ¨å˜²ç¬‘è®¡æ—¶å™¨ã€‚åœ¨æˆ‘çš„ä¸€äº›æµ‹è¯•ä¸­ï¼Œæ—¶é—´çš„æµé€ä¼šæ›´æ–°çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œæ¨¡æ‹Ÿé•¿æ—¶é—´è¿è¡ŒéªŒè¯çš„å¼‚æ­¥æµ‹è¯•ä½¿ç”¨setTimeoutï¼Œå› æ­¤éªŒè¯åº“å°†é¦–å…ˆå°†<code class="fe kp kq kr ks b">useForm.uiState</code>éªŒè¯çŠ¶æ€è®¾ç½®ä¸º<code class="fe kp kq kr ks b">isValidating</code>ï¼Œè¿™æ˜¯æˆ‘æƒ³è¦æµ‹è¯•çš„ï¼Œç„¶åä¸€æ—¦æ—¶é—´è¿‡å»ï¼Œ<code class="fe kp kq kr ks b">uiState.isValidating</code>å°†è¢«è®¾ç½®ä¸º<code class="fe kp kq kr ks b">false</code>ï¼Œå¹¶ä¸”éªŒè¯ç»“æœè¢«è®¾ç½®ã€‚</p><p id="c323" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">æˆ‘å¯¹<code class="fe kp kq kr ks b">jest.runAllTimers</code>çš„è°ƒç”¨ä¿®æ”¹äº†é’©å­çš„çŠ¶æ€ï¼Œä»»ä½•æ—¶å€™é’©å­çš„çŠ¶æ€è¢«ä¿®æ”¹ï¼Œä½ è°ƒç”¨çš„å‡½æ•°åº”è¯¥è¢«åŒ…è£…åœ¨ä¸€ä¸ªåŠ¨ä½œä¸­ï¼Œå³<code class="fe kp kq kr ks b">act(() =&gt; jest.runAllTimers());</code>ã€‚è¿™å¯ä»¥å‡è½»ç»ˆç«¯ä¸­çš„æµ‹è¯•è­¦å‘Šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi nq"><img src="../Images/6e106696e0382521d5cb332fe5cbdc38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XfcXGHlae2GGiC9O.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">ç”±äºjest.runAllTimers()ä¿®æ”¹æŒ‚é’©çŠ¶æ€ä½†æœªåœ¨act()å†…è°ƒç”¨ï¼Œå¯¼è‡´æµ‹è¯•è­¦å‘Š</figcaption></figure><pre class="lw lx ly lz gt nh ks ni nj aw nk bi"><span id="2e73" class="mv ku it ks b gy nl nm l nn no">it("should be able to add an input with valid asynchronous validation and get correct formValidity input state", async () =&gt; {<br/>    const customValidator = createValidator({<br/>      validateFn: async ({ value }) =&gt;<br/>        await new Promise(resolve =&gt; {<br/>          setTimeout(() =&gt; resolve(true), 1);<br/>        }),<br/>      error: "CUSTOM_ASYNC_ERROR"<br/>    });</span><span id="091a" class="mv ku it ks b gy np nm l nn no">const { result, waitForNextUpdate } = renderHook(() =&gt;<br/>      useForm({ id: "test" })<br/>    );</span><span id="27b3" class="mv ku it ks b gy np nm l nn no">act(() =&gt; {<br/>      result.current.api.addInput({<br/>        id: "test",<br/>        value: "",<br/>        validators: [{ ...customValidator, when: [validateInputEvents.onBlur] }]<br/>      });<br/>    });<br/>    act(<br/>      async () =&gt;<br/>        await result.current.inputs.test.getInputProps().onBlur({<br/>          preventDefault: noop,<br/>          target: {<br/>            value: ""<br/>          }<br/>        })<br/>    );<br/>    expect(result.current.formValidity).toEqual({<br/>      test: { isValidating: true, value: "" }<br/>    });</span><span id="5c97" class="mv ku it ks b gy np nm l nn no">act(() =&gt; jest.runAllTimers());<br/>    await waitForNextUpdate();</span><span id="1ddf" class="mv ku it ks b gy np nm l nn no">expect(result.current.formValidity).toEqual({<br/>      test: { field: "test", valid: true }<br/>    });<br/>  });</span></pre><h1 id="0c00" class="kt ku it bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">æ‘˜è¦</h1><p id="f5bb" class="pw-post-body-paragraph jq jr it js b jt lr jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn im bi translated">åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬é‡æ„äº†æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆä»¥æ”¯æŒåŠ¨æ€è¡¨å•ï¼Œå¹¶åˆ›å»ºäº†ä¸€ä¸ªåŠ¨æ€è¡¨å•ç¤ºä¾‹ã€‚</p><p id="0f09" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">åœ¨åé¢çš„éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºå…¶ä»–ä¸»é¢˜ï¼Œæ¯”å¦‚å‡å°‘æ ·æ¿æ–‡ä»¶ã€ä»JSONæ¨¡å¼æ·»åŠ éªŒè¯ã€æ‰¿è¯ºå–æ¶ˆã€å»æŠ–åŠ¨ã€é’©å­æ€§èƒ½è€ƒè™‘å’Œå…¶ä»–è®¾è®¡ä¼˜åŒ–ã€‚</p><p id="64df" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">æ­¤æ—¶ï¼Œè¯¥åº“å¯èƒ½å·²ç»â€œè¶³å¤Ÿå¥½â€å¯ä»¥ç”¨äºç”Ÿäº§äº†ğŸ˜ƒã€‚åœ¨å¼€å§‹è‡ªå·±åˆ¶ä½œè¡¨å•åº“ä¹‹å‰ï¼Œè¯·è®°ä½åˆ¶ä½œä¸€ä¸ªâ€œè¶³å¤Ÿå¥½â€çš„è¡¨å•åº“éœ€è¦ä»˜å‡ºçš„åŠªåŠ›å’Œæ€è€ƒï¼</p><p id="2455" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">é™¤éæ‚¨æœ‰ä¸€ä¸ªä¸éœ€è¦éªŒè¯é€»è¾‘çš„æå…¶ç®€å•çš„è¡¨å•ï¼Œæ˜¯çš„ï¼Œæ‚¨å¯ä»¥ç”¨Reactæ‹¼å‡‘ä¸€ä¸ªè¡¨å•ï¼Œä½†æ˜¯å®ƒä¼šéå¸¸æœ‰é™ã€‚ä¸€æ—¦ä½ éœ€è¦è¶Šè¿‡ç®€å•çš„è¡¨å•ï¼Œä½¿ç”¨è¡¨å•åº“ã€‚å¦åˆ™ï¼Œä½ å¯èƒ½æ²¡æœ‰å……åˆ†åˆ©ç”¨ä½ çš„æ—¶é—´ã€‚é™¤éä½ æ˜¯å‡ºäºè‡ªå·±çš„å­¦ä¹ ç›®çš„ï¼Œå½“ç„¶ï¼Œæˆ‘æ€»æ˜¯å»ºè®®é€šè¿‡å¼€å‘ä½ æ„Ÿå…´è¶£çš„ä¸œè¥¿æ¥å­¦ä¹ ã€‚</p><p id="a8b3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜ã€åé¦ˆæˆ–å»ºè®®ï¼Œæˆ–è€…æ‚¨å¸Œæœ›æˆ‘ä»‹ç»æœ¬ç³»åˆ—ä¸­çš„å…¶ä»–å†…å®¹ï¼Œè¯·å‘Šè¯‰æˆ‘ã€‚</p></div></div>    
</body>
</html>