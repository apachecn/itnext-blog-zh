# NSQ æ•™ç¨‹:ä½¿ç”¨ NSQ æ„å»ºä¸€ä¸ªç®€å•çš„æ¶ˆæ¯é˜Ÿåˆ—

> åŸæ–‡ï¼š<https://itnext.io/nsq-tutorial-build-a-simple-message-queue-using-nsq-1ae1a279dfab?source=collection_archive---------1----------------------->

ä½ å¥½ï¼Œäº²çˆ±çš„ç¨‹åºå‘˜ï¼Œæ¬¢è¿æ¥åˆ°æˆ‘çŒ®ç»™ *NSQ* çš„æŠ€æœ¯æ–‡ç« ç³»åˆ—ã€‚æ²¡æœ‰å¤ªå¤šå…³äºè¿™é¡¹æŠ€æœ¯çš„æ•™ç¨‹ï¼Œæ‰€ä»¥æˆ‘å†³å®šåšä¸€ä¸ªã€‚å¸Œæœ›ä½ å–œæ¬¢ï¼

![](img/b06d5f19849266d16b61d3967a93e86b.png)

ç”±[å®‰å¨œæ–¯å¡”è¥¿å¨…Â·æœå°”å‰å°”](https://unsplash.com/@dulgier?utm_source=medium&utm_medium=referral)åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šæ‹æ‘„çš„ç…§ç‰‡

# ä¸ºä»€ä¹ˆæ˜¯ NSQï¼Ÿ

NSQ æ˜¯ä¸€ä¸ªç”¨ Go ç¼–å†™çš„å®æ—¶åˆ†å¸ƒå¼æ¶ˆæ¯å¹³å°ï¼Œç”±çŸ¥åæœåŠ¡ bit.ly åˆ›å»º

ä¸ç±»ä¼¼çš„ç³»ç»Ÿ(å¦‚ RabbitMQ)ç›¸æ¯”ï¼Œå®ƒç®€å•æ˜äº†ï¼Œæ˜“äºä½¿ç”¨ï¼Œæœ‰ä¸€ä¸ªå¾ˆå¥½çš„ç›´è§‚çš„ç®¡ç†ç”¨æˆ·ç•Œé¢ã€‚å¦‚æœæ‚¨ä»¥å‰ä»æœªä½¿ç”¨è¿‡ä»»ä½•æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼ŒNSQ æ˜¯äº†è§£å…¶åŸç†çš„æœ€ä½³é€‰æ‹©ã€‚

# æ¶ˆæ¯é˜Ÿåˆ—çš„æ¦‚å¿µ:

æ¶ˆæ¯é˜Ÿåˆ—æ˜¯[å‘å¸ƒè€…/è®¢é˜…è€…](https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern)æ¶æ„æ¨¡å¼çš„å®ç°ï¼Œç”¨äºç³»ç»Ÿä¸åŒéƒ¨åˆ†(åº”ç”¨ç¨‹åºã€æœåŠ¡ç­‰)ä¹‹é—´çš„é€šä¿¡ã€‚

![](img/5c4ef44e7a317cc7f545120fa334b2b0.png)

æ¢å¥è¯è¯´ï¼Œå½“ä¸€ä¸ªäº‹ä»¶å‘ç”Ÿæ—¶(æ¯”å¦‚åˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·)ï¼Œä¸€ä¸ªæ¶ˆæ¯è¢«å‘å¸ƒåˆ°ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ã€‚ä»»ä½•å¯¹è¯¥äº‹ä»¶æ„Ÿå…´è¶£çš„æœåŠ¡éƒ½ä¼šè®¢é˜…è¯¥æ¶ˆæ¯ã€‚

æ¶ˆæ¯ä¸€å‘å¸ƒï¼Œæ„Ÿå…´è¶£çš„æœåŠ¡(æ¶ˆè´¹è€…)å°±ä¼šæ”¶åˆ°æ¶ˆæ¯å¹¶æ‰§è¡Œä¸€äº›æ“ä½œã€‚(ä¾‹å¦‚ï¼Œå‘æ–°ç”¨æˆ·å‘é€ç”µå­é‚®ä»¶)ã€‚

# 1.ä¸‹è½½ NSQ

å»[https://nsq.io/deployment/installing.html](https://nsq.io/deployment/installing.html)ä¸ºä½ çš„æ“ä½œç³»ç»Ÿä¸‹è½½ nsq äºŒè¿›åˆ¶æ–‡ä»¶ã€‚

æ‰“å¼€æå–çš„æ–‡ä»¶å¤¹ï¼Œä½ å¯ä»¥çœ‹åˆ°ä¸åŒçš„å¯æ‰§è¡Œæ–‡ä»¶:

*   nsqlookupd.exe
*   nsqd.exe
*   nsqadmin.exe
*   ..*è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„ï¼Œä½†å¯¹æˆ‘ä»¬æ¥è¯´å¹¶ä¸é‡è¦*

# 2.è¿è¡Œ nsqlookupd

åœ¨æ‚¨å–œæ¬¢çš„ shell/å‘½ä»¤ç»ˆç«¯ä¸­æ‰“å¼€æå–çš„ç›®å½•å¹¶è¿è¡Œ:

æ‚¨åº”è¯¥ä¼šçœ‹åˆ°ä»¥ä¸‹è¾“å‡º:

```
$ ./nsqlookupd 
[nsqlookupd] 2019/10/21 13:21:18.830625 INFO: nsqlookupd v1.2.0 (built w/go1.12.9) 
[nsqlookupd] 2019/10/21 13:21:18.832649 INFO: TCP: listening on [::]:4160 
[nsqlookupd] 2019/10/21 13:21:18.832649 INFO: HTTP: listening on [::]:4161
```

å®ƒè¡¨ç¤º nsqlookupd æ­£åœ¨è¿è¡Œï¼Œå¹¶ä¸”æœ‰ä¸¤ä¸ªæ¥å£:
ä¸€ä¸ªä½¿ç”¨ TCPï¼Œç«¯å£ä¸º 4160ï¼Œå¦ä¸€ä¸ªä½¿ç”¨ HTTPï¼Œç«¯å£ä¸º 4161ã€‚

ä¸ºäº†æ£€æŸ¥å®ƒæ˜¯å¦å·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥æ‰“å¼€æµè§ˆå™¨å¹¶è®¿é—®[http://localhost:4161/topics](http://localhost:4161/topics)

è¿™æ˜¯ä½ åº”è¯¥å¾—åˆ°çš„ç­”æ¡ˆï¼Œæ²¡å…³ç³»ã€‚ç›®å‰æˆ‘ä»¬è¿˜æ²¡æœ‰ä»»ä½•æ³¨å†Œçš„ä¸»é¢˜ã€‚

æ‚¨è¿˜å¯ä»¥è·å¾—æ‰€æœ‰é¢‘é“ã€ç‰¹å®šä¸»é¢˜çš„åˆ¶ä½œè€…ã€nsqd çš„èŠ‚ç‚¹ã€åˆ›å»ºä¸»é¢˜ã€é¢‘é“ç­‰ã€‚åœ¨æ–‡æ¡£[ä¸­æ‰¾åˆ°æ›´å¤šä¿¡æ¯ã€‚](https://nsq.io/components/nsqlookupd.html)

åŸºæœ¬ä¸Š **nsqlookupd** æ˜¯ä¸€ä¸ªå‘ç°æœåŠ¡ï¼Œå¸®åŠ©æ¶ˆè´¹è€…æ‰¾åˆ°ç‰¹å®šä¸»é¢˜çš„ nsqd ç”Ÿäº§è€…ã€‚

**nsqlookupd** æ˜¯ç®¡ç†æ‹“æ‰‘ä¿¡æ¯çš„å®ˆæŠ¤ç¨‹åºã€‚å®¢æˆ·ç«¯æŸ¥è¯¢ nsqlookupd ä»¥å‘ç°ç‰¹å®šä¸»é¢˜çš„ nsqd ç”Ÿäº§è€…ï¼Œnsqd èŠ‚ç‚¹å¹¿æ’­ä¸»é¢˜å’Œé¢‘é“ä¿¡æ¯ã€‚

# 3.è¿è¡Œ nsqd

ç°åœ¨åœ¨ shell nsqd ä¸­è¿è¡Œ:

æ‚¨åº”è¯¥ä¼šçœ‹åˆ°ä»¥ä¸‹è¾“å‡º:

```
[nsqd] 2019/10/21 13:39:56.997863 INFO: nsqd v1.2.0 (built w/go1.12.9) 
[nsqd] 2019/10/21 13:39:56.998861 INFO: ID: 791 
[nsqd] 2019/10/21 13:39:57.000861 INFO: NSQ: persisting topic/channel metadata to nsqd.dat 
[nsqd] 2019/10/21 13:39:57.011825 INFO: HTTP: listening on [::]:4151 [nsqd] 2019/10/21 13:39:57.011825 INFO: TCP: listening on [::]:4150
```

# 4.å‘å¸ƒæ¶ˆæ¯

ç°åœ¨æ˜¯æ—¶å€™å‘é˜Ÿåˆ—å‘å¸ƒæˆ‘ä»¬çš„ç¬¬ä¸€æ¡æ¶ˆæ¯äº†ã€‚æ‰“å¼€[é‚®å·®](https://www.getpostman.com/)æˆ–ä»»ä½•å…¶ä»–å·¥å…·è¿›è¡Œ HTTP è°ƒç”¨ï¼Œå‘**POST:**[**HTTP://localhost:4151/pubï¼Ÿç”¨ JSON ä½“æµ‹è¯•**](http://localhost:4151/pub?topic=test)

/pub æ˜¯åˆ›å»ºæ¶ˆæ¯çš„ NSQ ç«¯ç‚¹ã€‚å®ƒéœ€è¦ä¸€ä¸ªåä¸º**â€œtopicâ€**çš„æŸ¥è¯¢å‚æ•°ã€‚Topic è¡¨ç¤ºæ¶ˆæ¯çš„åç§°ï¼Œä»»ä½•ä»¥ç›¸åŒä¸»é¢˜å‘å¸ƒçš„æ¶ˆæ¯éƒ½å°†è¢«è¯¥ä¸»é¢˜çš„æ¯ä¸ªæ”¶å¬è€…ä½¿ç”¨ã€‚ğŸ“¨

å¦‚æœè¯·æ±‚æ˜¯ 200 OKï¼Œæˆ‘ä»¬çš„æ–°ä¸»é¢˜å°†è‡ªåŠ¨åˆ›å»ºã€‚æ‚¨å°†åœ¨ nsqd çš„æ§åˆ¶å°ä¸­æ”¶åˆ°ä¸€ä¸ªé€šçŸ¥:

```
[nsqd] 2019/10/21 13:49:04.740353 INFO: TOPIC(test): created 
[nsqd] 2019/10/21 13:49:04.740353 INFO: NSQ: persisting topic/channel metadata to nsqd.dat
```

å¦ä¸€è¡Œè¡¨ç¤ºå…³äºåˆ›å»ºçš„ä¸»é¢˜çš„ä¿¡æ¯è¢«æŒä¹…åŒ–åˆ°å…ƒæ•°æ® nsqd.dat æ–‡ä»¶ä¸­ã€‚

ç”¨ä»»ä½•æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€ bin ç›®å½•ä¸­çš„ nsqd.dat æ–‡ä»¶ï¼Œæ‚¨å°†åœ¨é‚£é‡Œçœ‹åˆ°æ‚¨çš„ä¸»é¢˜ã€‚ä½†æ˜¯æˆ‘ä»¬æœ‰ä¸€ä¸ªæ›´å¥½çš„é€‰é¡¹æ¥æŸ¥çœ‹å’Œç»´æŠ¤ä¸»é¢˜ã€‚ä½¿ç”¨ **NSQ ç®¡ç†**çš„æ—¶é—´ã€‚

# 5.å¯åŠ¨ NSQ ç®¡ç†

ç°åœ¨åœ¨ shell nsqadmin ä¸­è¿è¡Œ:

æ‚¨å°†åœ¨æ§åˆ¶å°âŒä¸­çœ‹åˆ°ä¸€ä¸ªé”™è¯¯

```
[nsqadmin] 2019/10/21 14:18:04.255018 FATAL: failed to instantiate nsqadmin - --nsqd-http-address or --lookupd-http-address required
```

é”™è¯¯æç¤ºæ‚¨éœ€è¦å‘ nsqd æˆ– nsqdlookup æä¾›åœ°å€ã€‚æˆ‘ä»¬å¼€å§‹å§ï¼

```
./nsqadmin --nsqd-http-address localhost:4151
```

ç°åœ¨ï¼Œæ‚¨å°†çœ‹åˆ°ä¸€æ¡æ¶ˆæ¯ï¼Œè¡¨æ˜ nsqadmin æ­£åœ¨è¿è¡Œ:

```
[nsqadmin] 2019/10/21 14:21:41.223806 INFO: nsqadmin v1.2.0 (built w/go1.12.9) 
[nsqadmin] 2019/10/21 14:21:41.224804 INFO: HTTP: listening on [::]:4171
```

åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€è¯¥åœ°å€ [http://localhost:4171](http://localhost:4171)

ä½ åº”è¯¥èƒ½åœ¨é‚£é‡Œçœ‹åˆ°ä¸€ä¸ªä¸»é¢˜â€œæµ‹è¯•â€ã€‚æ­¤å¤–ï¼Œå¦‚æœæ‚¨è½¬åˆ°**èŠ‚ç‚¹**é€‰é¡¹å¡ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ nsqd å®ä¾‹æ­£åœ¨è¿è¡Œå¹¶å·²è¿æ¥ã€‚ğŸ‘

å¦‚æœæ‚¨æŒ‰ä¸‹**æŸ¥æ‰¾**é€‰é¡¹å¡ï¼Œæ‚¨å°†çœ‹åˆ°ä¸€æ¡è­¦å‘Šã€‚è¿™æ˜¯å› ä¸ºç°åœ¨æˆ‘ä»¬ç›´æ¥è¿æ¥åˆ° nsqdï¼Œé¿å…ä½¿ç”¨ nsqdlookup,ã€ŠNSQã€‹çš„åˆ›ä½œè€…ä¸æ¨èä½¿ç”¨å®ƒã€‚

ç°åœ¨ä½¿ç”¨ç‰¹å®šçš„ lookupd åœ°å€è¿è¡Œè¯¥å‘½ä»¤:

```
$ ./nsqadmin --lookupd-http-address localhost:4161
```

æ‰“å¼€ NSQ ç®¡ç†ç•Œé¢ï¼Œç‚¹å‡»æŸ¥æ‰¾æ ‡ç­¾â€¦ä¼¼ä¹å¯ä»¥ã€‚ä½†æ˜¯å†æ¬¡æ£€æŸ¥**èŠ‚ç‚¹**æ ‡ç­¾ã€‚ç­‰å¾…..é›¶èŠ‚ç‚¹ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ

ç°åœ¨ï¼Œæˆ‘ä»¬å°† **nsqadmin** è¿æ¥åˆ° **nsqlookupd** ï¼Œä½†æ˜¯ **nsqd** å®ä¾‹æ²¡æœ‰è¿æ¥åˆ°ä»»ä½•ä¸œè¥¿ã€‚æ‰€ä»¥æˆ‘ä»¬çš„é“¾æ¡æ–­äº†ğŸ’¥ï¼

æ­£ç¡®çš„ä¾èµ–å…³ç³»åº”è¯¥æ˜¯*nsq admin->nsqlookupd<-nsqd*ã€‚è®©æˆ‘ä»¬ä¿®ç†å®ƒã€‚

åªéœ€å…³é—­ nsqd å®ä¾‹ï¼Œç„¶åæŒ‡å®š nsqlookupd åœ°å€å†æ¬¡è¿è¡Œå®ƒ:

```
./nsqd -lookupd-tcp-address localhost:4160
```

è¿™æ¬¡æˆ‘ä»¬è¦ç”¨ lookupd çš„ TCP åœ°å€ï¼Œç«¯å£æ˜¯ 4160ã€‚

åˆ·æ–°ç®¡ç†ç•Œé¢ï¼Œä¸€åˆ‡éƒ½åº”è¯¥å†æ¬¡å·¥ä½œã€‚ä¸¤ä¸ªæ ‡ç­¾å·¥ä½œå®Œç¾ï¼âœ¨

# 6.åˆ›å»ºæ¶ˆè´¹è€…åº”ç”¨ç¨‹åº

æˆ‘ä»¬éœ€è¦ä¸€ä¸ªåŸºæœ¬çš„åº”ç”¨ç¨‹åºæ¥ä½¿ç”¨æˆ‘ä»¬çš„æ¶ˆæ¯ã€‚è®©æˆ‘ä»¬ä¸ºæ­¤åˆ›å»ºä¸€ä¸ªç®€å•çš„ Node.js åº”ç”¨ç¨‹åºã€‚

ç”¨ä»»æ„åç§°åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶å¤¹ï¼Œå¹¶è¿è¡Œä»¥ä¸‹å‘½ä»¤:

```
npm init -y npm i express nsqjs
```

åˆ›å»º http æœåŠ¡å™¨éœ€è¦ Express åº“ï¼Œnsqjs æ˜¯ NSQ å›¢é˜Ÿæä¾›çš„å®˜æ–¹å®¢æˆ·ç«¯åº“ã€‚[é“¾æ¥æ­¤å¤„](https://github.com/dudleycarr/nsqjs)

åˆ›å»º server.js æ–‡ä»¶

åœ¨æˆ‘ä»¬çš„é¡¹ç›®ç›®å½•ä¸­è¿è¡Œ:

æ‚¨ç°åœ¨å°†æ¥æ”¶æ‰€æœ‰æ’é˜Ÿçš„æ¶ˆæ¯ã€‚æ¶ˆè´¹è€…åº”ç”¨ç¨‹åºæ§åˆ¶å°åº”æ˜¾ç¤ºä»¥ä¸‹å†…å®¹:

```
NSQ Consumer is listening on port 3000! Received message [0c6020dfa34cf000]: { "text": "some message" }
```

è¿™æ˜¯å› ä¸ºæˆ‘ä»¬çš„æ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œç›´åˆ°è¢«ä½¿ç”¨ã€‚

åœ¨â€œNSQ ç®¡ç†â€ä¸­ï¼Œå¦‚æœæ‚¨é€‰æ‹©â€œèŠ‚ç‚¹â€,æ‚¨å°†çœ‹åˆ°å‡ ç§’é’Ÿå‰æ–°çš„å®¢æˆ·ç«¯ä¸»æœºå·²è¿æ¥ã€‚

# 7.æµ‹è¯•æ¥æ”¶æ¶ˆæ¯

ä¿æŒ server.js è¿è¡Œï¼Œç°åœ¨è¯·æ±‚ POSTMAN å‘å¸ƒæ–°æ¶ˆæ¯åˆ°ä¸»é¢˜â€œtestâ€

**POST**[**http://localhost:4151/pubï¼Ÿtopic=test**](http://localhost:4151/pub?topic=test)
åŒä½“

```
{ "text": "CONNNCTED!!! YEAH!!" }
```

æ‚¨åº”è¯¥ä¼šç«‹å³åœ¨æ§åˆ¶å°ä¸­çœ‹åˆ°å®ƒã€‚æ­å–œä½ ã€‚ğŸ‰æ‚¨æœ‰ä¸€ä¸ªå·¥ä½œçš„æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿã€‚ğŸ–… ğŸ–… ğŸ–…

âš ï¸:å¦‚æœä½ åœ¨ NSQ Admin ä¸­æŒ‰ Counterï¼Œä½ ä¼šçœ‹åˆ°å®ƒä¸å†æ˜¯é›¶äº†ã€‚

å¦‚æœä½ å‘å…¶ä»–ä¸»é¢˜å‘é€æ¶ˆæ¯ï¼Œä½ ä¸ä¼šçœ‹åˆ°å®ƒï¼Œå› ä¸ºæˆ‘ä»¬åªè®¢é˜…äº†ä¸€ä¸ªä¸»é¢˜â€œæµ‹è¯•â€ã€‚

ğŸš€å¦‚æœä½ ä»é‚£ç¯‡æ–‡ç« ä¸­è¯»åˆ°äº†ä¸€äº›æœ‰è¶£çš„ä¸œè¥¿ï¼Œè¯·å–œæ¬¢å¹¶å…³æ³¨æˆ‘çš„æ›´å¤šå¸–å­ã€‚è°¢è°¢ä½ äº²çˆ±çš„ç¼–ç å‘˜ï¼ğŸ˜

*åŸå‘å¸ƒäº 2019 å¹´ 11 æœˆ 22 æ—¥*[*https://dev . to*](https://dev.to/vguleaev/nsq-tutorial-build-a-simple-message-queue-using-nsq-43eh)*ã€‚*