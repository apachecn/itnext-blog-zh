# ä½¿ç”¨ Rust å’Œ Ptrace è°ƒç”¨ç³»ç»Ÿè°ƒç”¨

> åŸæ–‡ï¼š<https://itnext.io/using-rust-and-ptrace-to-invoke-syscalls-262dc585fcd3?source=collection_archive---------0----------------------->

![](img/6135c83a4feade7564f74cf0ac8a3611.png)

# ğŸ”Šä»‹ç»

**é¢„å…ˆè­¦å‘Šæœ¬æ–‡å°†ç›´æ¥é’ˆå¯¹ Linux** ğŸ§ **x86_64 CPU æ¶æ„å‘è¡Œç‰ˆã€‚** **x86_32ã€ARM32 å’Œ ARM64 CPU æ¶æ„å°†æ— æ³•å·¥ä½œ** *ï¼Œä½†åªè¦å¯¹ä»£ç ç¨åŠ ä¿®æ”¹å°±ç»å¯¹å¯è¡Œï¼Œä»¥æ¦‚æ‹¬æ¶æ„çš„ç‰¹å®šå¯„å­˜å™¨ç»“æ„å’ŒæŒ‡ä»¤ç¼–ç *ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘åœ¨æœ¬æ•™ç¨‹ä¸­çš„è®¾ç½®å°†æ˜¯ä¸€å° windows æœºå™¨ï¼Œæˆ‘å°†ä½¿ç”¨ [WSL](https://learn.microsoft.com/en-us/windows/wsl/install) åŠ è½½ä¸€ä¸ªæˆ‘å°†è¦ä½¿ç”¨çš„ **Ubuntu 20.04.4 LTS** å‘è¡Œç‰ˆã€‚æœ¬æ–‡é€‰æ‹©çš„è¯­è¨€å°†æ˜¯ [**Rust**](https://www.rust-lang.org/) **ã€‚**åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼ŒRust çš„æœ€æ–°ç¨³å®šç‰ˆæœ¬æ˜¯æˆ‘å°†ä½¿ç”¨çš„ **1.65.0** ã€‚æˆ‘ä½¿ç”¨çš„ Rust Crate ä¾èµ–é¡¹å°†å¼•ç”¨å®ƒä»¬å„è‡ªçš„ç‰ˆæœ¬ã€‚å¦‚æœä½ æƒ³è·³è¿‡å‰é¢æˆ–è€…åªçœ‹ç»“æœä»£ç ï¼Œå®Œæ•´çš„é¡¹ç›®å¯ä»¥åœ¨[https://github.com/0xFounders/ptrace_syscalls](https://github.com/0xFounders/ptrace_syscalls)æ‰¾åˆ°

# ğŸ“šæ—…ç¨‹

1.  åˆ›å»ºæˆ‘ä»¬çš„æµ‹è¯•å—å®³è€…æµç¨‹
2.  åˆ›å»ºæˆ‘ä»¬çš„å®¿ä¸»è¿›ç¨‹
3.  åœ¨å—å®³è€…è¿›ç¨‹ä¸­è°ƒç”¨ç³»ç»Ÿè°ƒç”¨
4.  æŒ‡é’ˆå‚æ•°
5.  èµ„æºè½¬å‚¨/æœªæ¥é˜…è¯»ï¼Œæœªæ¥å·¥ä½œ

# ğŸ§ªåˆ›å»ºäº†æˆ‘ä»¬çš„æµ‹è¯•å—å®³è€…æµç¨‹

å¯¹äºè¿™ä¸ªé¡¹ç›®ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªè¿‡ç¨‹æ¥ä½œä¸ºæˆ‘ä»¬çš„æµ‹è¯•ã€‚æˆ‘ä»¬çš„æµ‹è¯•è¿‡ç¨‹æœ€å¥½æ˜¯ä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„è¿‡ç¨‹ï¼Œç”¨ä¸€äº›æ­£å¸¸æ§åˆ¶æµçš„æŒ‡ç¤ºå™¨æ¥ç¡®è®¤æˆ‘ä»¬åœ¨å¢å¼ºåæ²¡æœ‰ç ´åä»»ä½•ä¸œè¥¿ã€‚å› æ­¤ï¼Œç”±æ‰“å°åˆ°æ§åˆ¶å°çš„ç®€å•æ— é™ while å¾ªç¯ç»„æˆçš„ç¨‹åºå°†æˆä¸ºå®Œç¾çš„æµ‹è¯•å—å®³è€…ã€‚

## æ—¥å¿—â€”[https://crates.io/crates/log](https://crates.io/crates/log)

æ—¥å¿—ç®±åªæ˜¯ä¸€ä¸ªè½»å‹çš„[ç¥ç¦](https://blessed.rs/crates)æ—¥å¿—ç®±ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥æ”¶é›†æ—¥å¿—æ•°æ®ã€‚å®ƒå…è®¸æˆ‘ä»¬æ”¶é›†ä¸åŒçº§åˆ«çš„å¯è¯»æ€§æ—¥å¿—æ•°æ®:è·Ÿè¸ªã€æ—¥å¿—ã€ä¿¡æ¯ã€è­¦å‘Šã€é”™è¯¯ã€‚

## æ¼‚äº® _ ç¯å¢ƒ _ è®°å½•è€…â€”[https://crates.io/crates/pretty_env_logger](https://crates.io/crates/pretty_env_logger)

æ—¥å¿—ç®±åªæ˜¯ä¸€ä¸ªè–„è–„çš„é—¨é¢ï¼Œpretty_env_logger å°†å®é™…å¤„ç†æ”¶é›†çš„æ•°æ®ï¼Œå¹¶ä¸ºæˆ‘ä»¬è¾“å‡ºåˆ°æ§åˆ¶å°ã€‚å®ƒä¹Ÿå¼€ç®±å³ç”¨ï¼Œæä¾›äº†å¾ˆå¥½çš„æ ¼å¼å’Œé¢œè‰²ç¼–ç çš„æ–‡æœ¬ã€‚

## å±¥è¡Œ

ä¸‹é¢æ˜¯æˆ‘å¯¹æµ‹è¯•çš„ç†æƒ³å—å®³è€…è¿‡ç¨‹çš„ç®€å•å®ç°ã€‚è¯·æ³¨æ„ï¼Œæˆ‘å°†ä¸[è´§ç‰©å·¥ä½œåŒº](https://doc.rust-lang.org/book/ch14-03-cargo-workspaces.html)ä¸€èµ·å·¥ä½œï¼Œå—å®³è€…ç®±å’Œä¸»äººç®±å°†ä¸€èµ·åœ¨å·¥ä½œåŒºã€‚å¦‚æœä½ æƒ³è¿½æ±‚ä¸€ä¸ªä¸åŒçš„å·¥ä½œæµç¨‹ï¼Œåªè¦çŸ¥é“ä½ å¦‚ä½•è¿è¡Œä½ çš„è´§ç‰©åº”ç”¨ç¨‹åºå¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚

ä¸ºäº†æ£€æŸ¥å®Œæ•´æ€§ï¼Œä¸‹é¢æ˜¯ Visual Studio ä»£ç ä¸­çš„é¡¹ç›®ç»“æ„ã€‚è¯·æ³¨æ„ç›®æ ‡æ–‡ä»¶å¤¹åœ¨çˆ¶ç›®å½•ä¸­ï¼Œè€Œä¸æ˜¯åœ¨å—å®³è€…æ–‡ä»¶å¤¹ä¸‹ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬çš„å·¥ä½œåŒºå·¥ä½œæµå°†æ‰€æœ‰æˆå‘˜æ„å»ºè¾“å‡ºæ”¶é›†åˆ°ä¸€ä¸ªå…¬å…±ç›®æ ‡æ–‡ä»¶å¤¹ä¸­ã€‚

![](img/d12d7579d5b5677212a9279ab6be544e.png)

# ğŸ åˆ›å»ºæˆ‘ä»¬çš„å®¿ä¸»è¿›ç¨‹

## Ptrace æ¦‚è¿°

ä» Linux æ‰‹å†Œé¡µæ–‡æ¡£å¼€å§‹ï¼Œæˆ‘ä»¬å¯ä»¥å¿«é€Ÿäº†è§£ Ptrace æ¥å£çš„ä¸€èˆ¬è®¾è®¡æ„å›¾ã€‚

[https://man7.org/linux/man-pages/man2/ptrace.2.html](https://man7.org/linux/man-pages/man2/ptrace.2.html)

> **ptrace** ()ç³»ç»Ÿè°ƒç”¨æä¾›äº†ä¸€ç§æ–¹æ³•ï¼Œé€šè¿‡è¿™ç§æ–¹æ³•ï¼Œä¸€ä¸ªè¿›ç¨‹
> (â€œè·Ÿè¸ªå™¨â€)å¯ä»¥è§‚å¯Ÿå’Œæ§åˆ¶å¦ä¸€ä¸ª
> è¿›ç¨‹(â€œè¢«è·Ÿè¸ªè€…â€)çš„æ‰§è¡Œï¼Œå¹¶æ£€æŸ¥å’Œæ›´æ”¹è¢«è·Ÿè¸ªè€…çš„
> å†…å­˜å’Œå¯„å­˜å™¨ã€‚ä¸»è¦ç”¨äºå®ç°
> æ–­ç‚¹è°ƒè¯•å’Œç³»ç»Ÿè°ƒç”¨è·Ÿè¸ªã€‚

æˆ‘ä»¬å°†æŒ‘æˆ˜ Ptrace çš„æé™ï¼Œä»¥ä¾¿åœ¨è¿œç¨‹è¿›ç¨‹ä¸­ä»å¤–éƒ¨è°ƒç”¨ç³»ç»Ÿè°ƒç”¨ã€‚ä¾‹å¦‚ï¼Œåˆ°æœ¬æ–‡ç»“æŸæ—¶ï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿä½¿ç”¨[mmap](https://man7.org/linux/man-pages/man2/mmap.2.html)/[mun map](https://man7.org/linux/man-pages/man3/munmap.3p.html)syscalls åœ¨ç”¨æˆ·ç©ºé—´è¿›ç¨‹ä¸­åˆ†é…å†…å­˜ï¼Œå¹¶æ§åˆ¶ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºçš„æŒ‡ä»¤æŒ‡é’ˆå’Œå¯„å­˜å™¨æ¥è°ƒç”¨ä»»ä½•ä»»æ„çš„ syscallã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°†è®¾ç½®æˆ‘ä»¬çš„ä¸»æœºç®€å•åœ°è¿æ¥åˆ°è¿›ç¨‹ï¼Œå¹¶æ£€æŸ¥å½“å‰æ§åˆ¶æµçš„å¯„å­˜å™¨ã€‚æˆ‘ä»¬éœ€è¦æ›´å¤šçš„æ¿æ¡ç®±æ¥å®Œæˆè¿™é¡¹å·¥ä½œã€‚

## è¿™ä¸ªé”™è¯¯â€”[https://crates.io/crates/thiserror](https://crates.io/crates/thiserror)

å¦ä¸€ä¸ª[å—ç¥ç¦çš„](https://blessed.rs/crates)æ¿æ¡ç®±

> ä¸ºæ ‡å‡†åº“çš„`[std::error::Error](https://doc.rust-lang.org/std/error/trait.Error.html)`ç‰¹å¾æä¾›äº†ä¸€ä¸ªæ–¹ä¾¿çš„è¡ç”Ÿå®ã€‚

æˆ‘ä»¬å°†ä½¿ç”¨æ­¤é”™è¯¯æ¥ä¿ƒè¿›é”™è¯¯å¤„ç†ï¼Œä»¥æä¾›ä¸€ä¸ªæ²¡æœ‰ææ…Œçš„ä½“éªŒã€‚

## sysinfoâ€”[https://crates.io/crates/sysinfo](https://crates.io/crates/sysinfo)

sysinfo æ¿æ¡ç®±ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªç”Ÿæ´»è´¨é‡å‡½æ•°ï¼Œé€šè¿‡åç§°è€Œä¸æ˜¯ Pid æ¥æŸ¥æ‰¾è¿›ç¨‹ã€‚è¿™åœ¨å¿«é€Ÿæ„å»ºåŸå‹æ—¶å¾ˆæœ‰ç”¨ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥å°†ç›®æ ‡æµç¨‹åç¡¬ç¼–ç ä¸ºâ€œå—å®³è€…â€ã€‚ä½ å¯ä»¥äº‰è®ºè¿™æ˜¯ç‰¹æ€§è†¨èƒ€ï¼ŒåŒ…æ‹¬æ•´ä¸ªæœºç®±çš„ä¾èµ–ï¼Œä»…ä»…é€šè¿‡åå­—è·å¾—ä¸€ä¸ªè¿›ç¨‹çš„ pidã€‚æˆ‘åŒæ„ã€‚ä½†æ˜¯ï¼Œæ‡’æƒ°çš„ğŸ¦¥åœ¨å®éªŒæ—¶å ä¸Šé£â€¦

## https://crates.io/crates/nix

nix crate å°†ä¸ºæˆ‘ä»¬æä¾›ä¸€äº›å¯¹ ptrace çš„ç”Ÿæ´»è´¨é‡ç»‘å®šï¼Œè¿™äº›ç»‘å®šæŠ½è±¡äº†ä¸€äº›åŠŸèƒ½ï¼Œæä¾›äº†æ›´å®¹æ˜“å¤„ç†é”™è¯¯çš„ç»“æœç±»å‹ã€‚å®ƒè¿˜ä¸ºé¡µé¢å’Œå†…å­˜æ˜ å°„/ä¿æŠ¤æä¾›äº†å¸¸é‡ï¼Œæˆ‘ä»¬å°†åœ¨åé¢çš„*æŒ‡é’ˆå‚æ•°*éƒ¨åˆ†ä¸­ç”¨åˆ°ã€‚

## å±¥è¡Œ

## ç¤ºèŒƒ

å¥½æäº†ï¼Œæˆ‘ä»¬èƒ½å¤Ÿè¿æ¥åˆ°å—å®³è€…è¿›ç¨‹å¹¶æˆªè·å®ƒçš„å½“å‰å¯„å­˜å™¨ï¼Œå°†å®ƒä»¬æ‰“å°åˆ°æ§åˆ¶å°ã€‚

![](img/3c1fdb56ded53ad6c3a80279789ba553.png)

åŠ å…¥æˆ˜æ–—ï¼Œæ‹¦æˆªè®°å½•

å¦‚æœè¿™å¯¹æ‚¨æ¯«æ— æ„ä¹‰ï¼Œæˆ‘é¼“åŠ±æ‚¨çœ‹ä¸€çœ‹ x86_64 å¯„å­˜å™¨çš„ç»“æ„ã€‚ç‰¹åˆ«è¦æ³¨æ„ rip å¯„å­˜å™¨ï¼Œå®ƒæ˜¯æˆ‘ä»¬å½“å‰çš„æŒ‡ä»¤æŒ‡é’ˆï¼Œrax å¯„å­˜å™¨æ˜¯è¿”å›å€¼å¯„å­˜å™¨ã€‚ä¸€æ—¦æˆ‘ä»¬å¼€å§‹è¯•å›¾åŠ«æŒå—å®³è€…è¿›ç¨‹çš„æ§åˆ¶æµï¼Œrip å¯„å­˜å™¨å°±ä¼šå¼•èµ·æˆ‘ä»¬çš„ç‰¹åˆ«å…´è¶£ğŸ˜ˆ

![](img/d18aa6cc8f1e7b6a53746f86bfa42db1.png)

ã€https://web.stanford.edu/class/cs107/guide/x86-64.html 

# ğŸ–¥ï¸åœ¨å—å®³è€…è¿›ç¨‹ä¸­è°ƒç”¨ç³»ç»Ÿè°ƒç”¨

## æ¦‚è§‚

1.  ä½¿ç”¨ ptrace æ‹¦æˆªè¿›ç¨‹æ§åˆ¶æµå¹¶è·å–å½“å‰å¯„å­˜å™¨
2.  ç¼“å­˜å½“å‰å¯„å­˜å™¨ã€å½“å‰æŒ‡ä»¤æŒ‡é’ˆå’Œå½“å‰æŒ‡ä»¤
3.  å°†è°ƒç”¨ç³»ç»Ÿè°ƒç”¨çš„æ±‡ç¼–æŒ‡ä»¤å†™å…¥å½“å‰æŒ‡ä»¤æŒ‡é’ˆ
4.  ä¸º syscall è®¾ç½®æ‰€æœ‰ç›¸åº”çš„å¯„å­˜å™¨å‚æ•°
5.  å•æ­¥æ‰§è¡Œè¿›ç¨‹ï¼ŒæœŸå¾… SIGTRAP ä½œä¸ºä¸‹ä¸€ä¸ªä¿¡å·
6.  ç¼“å­˜ç»“æœå¯„å­˜å™¨ä½œä¸ºç³»ç»Ÿè°ƒç”¨çš„ç»“æœ
7.  æ¢å¤åŸå§‹å¯„å­˜å™¨å’ŒåŸå§‹æŒ‡ä»¤ï¼Œä»¥ç»§ç»­æ­£å¸¸çš„åº”ç”¨ç¨‹åºæ‰§è¡Œ

## ç³»ç»Ÿè°ƒç”¨ç¨‹åºé›†

x86_64 ä¸­ syscall çš„æ“ä½œç æ˜¯ 0x0F05ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å½“å‰æŒ‡ä»¤æŒ‡é’ˆæŒ‡å‘è¯¥æ“ä½œç ï¼Œä»¥ä¾¿å°†æ§åˆ¶æµè½¬ç§»åˆ°ç³»ç»Ÿè°ƒç”¨ã€‚æˆ‘ä»¬ä¸èƒ½ç®€å•åœ°ç”¨ ptrace å†™ä¸¤ä¸ªå­—èŠ‚ï¼Œå› ä¸ºå®ƒéœ€è¦ä¸€ä¸ª*å­—*ï¼Œè¿™ä¸ªå­—å¾ˆå®¹æ˜“æ··æ·†ï¼Œå› ä¸ºå®ƒå®é™…ä¸Šæ„å‘³ç€ x86_64 ä¸Šçš„ u64ã€‚æ ¹æ®æˆ‘åœ¨ Windows ç”Ÿæ€ç³»ç»Ÿä¸­çš„ç»éªŒï¼ŒW ORD é€šå¸¸æŒ‡çš„æ˜¯ u16ã€‚è¿™è®©æˆ‘åœ¨è¿™ä¸ªé¡¹ç›®ä¸­æœ‰äº›å›°æƒ‘ã€‚æ— è®ºå¦‚ä½•ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°å°† 2 å­—èŠ‚æ“ä½œç æ‰©å±•ä¸º 8 å­—èŠ‚ï¼Œè€Œæ— éœ€ä»»ä½•æ“ä½œæŒ‡ä»¤ NOP (0x90)ã€‚ç”¨ NOP æ‰©å±•æŒ‡ä»¤ä»¥å¯¹é½å®ƒçš„æŠ€æœ¯æœ‰æ—¶è¢«ç§°ä¸ºâ€œNOP Sledâ€ã€‚

![](img/e3ad0fa80276e8359f104d909f29c41d.png)

[https://www.felixcloutier.com/x86/syscall.html](https://www.felixcloutier.com/x86/syscall.html)

![](img/56a75f7285e1b60bea5f2617f72e1137.png)

https://c9x.me/x86/html/file_module_x86_id_217.html

## ç³»ç»Ÿè°ƒç”¨â€”ã€https://crates.io/crates/syscalls 

ç³»ç»Ÿè°ƒç”¨ç®±å°†ä¸ºç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨å·/rax æä¾›å¸¸é‡ã€‚è¯·å‚è€ƒ Sysno æšä¸¾åœ¨å®ç°ä¸­çš„ç”¨æ³•ã€‚

## å±¥è¡Œ

å¯¹äºæˆ‘ä»¬ç²¾æ˜çš„è¯»è€…æ¥è¯´ï¼Œæ‚¨å°†ç«‹å³è·å¾—ç»“æœå¯„å­˜å™¨çš„ rax å€¼ã€‚rax å¯„å­˜å™¨å°†å¯¹åº”äº syscall è¿”å›å‚æ•°ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œå—å®³è€…è¿›ç¨‹çš„ pid ä¸º 13958ï¼Œä¸»æœº getpid syscall åœ¨ rax å¯„å­˜å™¨ä¸­æ­£ç¡®è¿”å›ç›¸åŒçš„ PID 13958ã€‚æˆ‘çœŸçš„å¾ˆæ„Ÿæ¿€ä½ çš„ç†æ™ºæ£€æŸ¥ï¼ŒğŸ§ .

![](img/e25fc411adfaabd231d695a0e9fe1d5f.png)

getpid ç³»ç»Ÿè°ƒç”¨

ç°åœ¨ç³»ç»Ÿè°ƒç”¨æ¥å—ä¸€ä¸ªå‚æ•°æ€ä¹ˆæ ·ï¼Œæˆ‘å°†ä½¿ç”¨ exitï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå‚æ•°å¯¹åº”äºåº”ç”¨ç¨‹åºé€€å‡ºä»£ç ã€‚

```
sys_call(Sysno::exit, 42, 0, 0, 0, 0, 0)?;
```

![](img/307e8a11f997918f6da2258dc821cc87.png)

ä¸»æœºå´©æºƒï¼Œå—å®³è€…é€€å‡ºï¼Œä½†è¿™æ˜¯æ„æ–™ä¹‹ä¸­çš„ï¼Œæˆ‘ä»¬æ¯•ç«Ÿé€€å‡ºäº†ã€‚æ³¨æ„ï¼Œé€€å‡ºä»£ç æ˜¯æˆ‘ä»¬æŒ‡å®šçš„æ•´æ•° 42ï¼Œæ‰€ä»¥å‚æ•°è¢«å¡ä½äº†ã€‚

å—¯ï¼Œä¸€ä¸ªè‡ªå˜é‡æ˜¯è¾“å‡ºå˜é‡çš„ä¾‹å­æ€ä¹ˆæ ·ï¼Ÿæˆ‘ä»¬å¯ä»¥ä½¿ç”¨[æ—¶é—´](https://man7.org/linux/man-pages/man2/time.2.html)ç³»ç»Ÿè°ƒç”¨ã€‚å®ƒéœ€è¦ä¸€ä¸ªæŒ‡å‘ time_t å˜é‡çš„æŒ‡é’ˆæ¥å†™å…¥å½“å‰çš„ unix æ—¶é—´æˆ³ã€‚

```
// tyepdef time_t int64
time_t time(time_t *tloc);
```

è®¾ç½®ç³»ç»Ÿè°ƒç”¨å¹¶æä¾›è¾“å‡ºå˜é‡

```
// Call time syscall
let mut output = 0i64;
let result = user_process.sys_call
 (Sysno::time, &mut output as *mut _ as u64, 0, 0, 0, 0, 0)?;
log::info!("Syscall Result: {:#?}", result);
log::info!("Time: {}", output);
```

è¿˜æœ‰â€¦ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Ÿçœ‹èµ·æ¥ä¸å¤ªå¯¹çš„æ—¶é—´æ˜¯é›¶ã€‚

![](img/61844fe36cb9a8caef7fb26cfb866c0f.png)

å¸¦æœ‰æœ¬åœ°æŒ‡é’ˆçš„æ—¶é—´ç³»ç»Ÿè°ƒç”¨

![](img/0e5b4e4345ff5a4f7fdf7f3a777c87b3.png)

é¢„æœŸæ—¶é—´å“åº”ï¼Œunix i64 æ—¶é—´æˆ³

å¦‚æœæˆ‘ä»¬è¿è¡Œ date å‘½ä»¤æ¥è¾“å‡ºå½“å‰çš„ unix æ—¶é—´æˆ³ï¼Œæˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°éå¸¸ä¸åŒçš„è¾“å‡ºã€‚æ—¶é—´ç»“æœåº”è¯¥è‡³å°‘æ¥è¿‘æ—¥æœŸå‘½ä»¤è¾“å‡ºã€‚é™¤éæˆ‘ä»¬åœ¨å‘çƒ§çš„æ¢¦é‡ŒğŸ˜´å›åˆ° 1970 å¹´ 1 æœˆ 1 æ—¥çš„åˆå¤œï¼Œæ—¶é—´ä¸åº”è¯¥æ˜¯ 0â€¦

> Unix æ—¶é—´æ˜¯è‡ª 1970 å¹´ 1 æœˆ 1 æ—¥ 00:00:00 UTC ä»¥æ¥ç»è¿‡çš„ç§’æ•°ï¼Œä¸åŒ…æ‹¬é—°ç§’ã€‚è¿™ä¸ªæ—¶é—´è¢«å‘½åä¸º Unix çºªå…ƒï¼Œå› ä¸ºå®ƒæ˜¯ Unix æ—¶é—´çš„å¼€å§‹ã€‚

![](img/3d360ed282a095fc27ca142f8fa9a948.png)

# â†ªï¸æŒ‡é’ˆå‚æ•°

è¿è¡Œ times syscall æ—¶å‡ºç°é—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯æˆ‘ä»¬åœ¨ä¸»æœºè¿›ç¨‹å†…å­˜ç©ºé—´ä¸­æŒ‡å®šäº†ä¸€ä¸ªå†…å­˜åœ°å€ã€‚åŒæ ·ï¼Œå¦‚æœä¸ä½¿ç”¨ç‰¹å®šçš„æ“ä½œå‡½æ•°ï¼Œæˆ‘ä»¬å°±æ— æ³•å†™å…¥å—å®³è€…è¿›ç¨‹å†…å­˜ï¼Œå¦‚æœä¸ä½¿ç”¨è¿™äº›æ“ä½œï¼Œå—å®³è€…ä¹Ÿæ— æ³•å†™å…¥æˆ‘ä»¬çš„ä¸»æœºè¿›ç¨‹å†…å­˜ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ç›´æ¥åœ¨å—å®³è€…è¿›ç¨‹ä¸­åˆ†é…å†…å­˜å¹¶ä½¿ç”¨è¯¥ç©ºé—´çš„åœ°å€ä½œä¸ºå‚æ•°ï¼Œç„¶åä»è¯¥å†…å­˜ä¸­è¯»å–ä»¥æ£€ç´¢è¾“å‡ºæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æ¯«ä¸å¥‡æ€ªï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ mmap å’Œ munmap ç³»ç»Ÿè°ƒç”¨æ¥å¤„ç†å—å®³è€…è¿›ç¨‹ä¸­çš„æ•°æ®ç®¡ç†ã€‚

## [Mmap](https://man7.org/linux/man-pages/man2/mmap.2.html)

> mmap()åœ¨
> è°ƒç”¨è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­åˆ›å»ºæ–°çš„æ˜ å°„ã€‚æ–°æ˜ å°„çš„èµ·å§‹åœ°å€æ˜¯ addr ä¸­æŒ‡å®šçš„
> ã€‚length å‚æ•°æŒ‡å®šæ˜ å°„çš„
> é•¿åº¦(å¿…é¡»å¤§äº 0)ã€‚
> 
> å¦‚æœ addr ä¸ºç©ºï¼Œé‚£ä¹ˆå†…æ ¸é€‰æ‹©(é¡µé¢å¯¹é½)
> åœ°å€æ¥åˆ›å»ºæ˜ å°„ï¼›è¿™æ˜¯åˆ›å»ºæ–°æ˜ å°„æœ€æ–¹ä¾¿çš„
> æ–¹æ³•ã€‚

```
void *mmap(void *addr, size_t length, int prot, int flags,
                  int fd, off_t offset);
```

## Munmap

> å‡½æ•° munmap()åº”åˆ é™¤åŒ…å«è¿›ç¨‹
> åœ°å€ç©ºé—´ä»»ä½•éƒ¨åˆ†çš„æ•´ä¸ª
> é¡µé¢çš„ä»»ä½•æ˜ å°„ï¼Œä» addr å¼€å§‹ï¼Œä¸€ç›´åˆ° len å­—èŠ‚ã€‚å¯¹è¿™äº›é¡µé¢çš„è¿›ä¸€æ­¥å¼•ç”¨
> å°†å¯¼è‡´äº§ç”Ÿä¸€ä¸ª SIGSEGV ä¿¡å·
> ç»™è¯¥è¿‡ç¨‹ã€‚å¦‚æœåœ¨æŒ‡å®šçš„
> åœ°å€èŒƒå›´å†…æ²¡æœ‰æ˜ å°„ï¼Œåˆ™ munmap()æ— æ•ˆã€‚
> 
> å®ç°å¯èƒ½è¦æ±‚ addr æ˜¯ sysconf()è¿”å›çš„
> é¡µé¢å¤§å°çš„å€æ•°ã€‚

```
int munmap(void *addr, size_t len);
```

## è§£å†³åŠæ³•

1.  ä½¿ç”¨ mmap syscall åœ¨å—å®³è€…è¿›ç¨‹ä¸­ä¿ç•™è™šæ‹Ÿå†…å­˜
2.  æ ¹æ®éœ€è¦è¯»å–æˆ–å†™å…¥è™šæ‹Ÿå†…å­˜
3.  ä»å¯¹æˆ‘ä»¬åœ¨å—å®³è€…ä¸­ä¿ç•™çš„è™šæ‹Ÿå†…å­˜çš„å¼•ç”¨ä¸­æä¾› syscall æŒ‡é’ˆå‚æ•°

## å±¥è¡Œ

æˆ‘ä»¬è¯»å†™è¿›ç¨‹å†…å­˜çš„âš ï¸How å·²ç»è¢«é‡æ„ä¸ºç›´æ¥ä»è¿›ç¨‹çš„å†…å­˜æ–‡ä»¶ä¸­è¯»å–ã€‚è¿™å°†æˆ‘ä»¬ä» ptrace çš„*å­—*å¤§å°é™åˆ¶*çš„è¦æ±‚ä¸­è§£æ”¾å‡ºæ¥ã€‚*ç”±äº linux ä¸­çš„ä¸€åˆ‡æœ¬è´¨ä¸Šéƒ½æ˜¯æ–‡ä»¶ï¼ŒRust çš„æ ‡å‡†æ–‡ä»¶åŠŸèƒ½å¯ä»¥ç”¨æ¥ä¸è¿›ç¨‹çš„å†…å­˜æ–‡ä»¶è¿›è¡Œäº¤äº’ã€‚è¿™ç§å®ç°ä¸Šçš„æ”¹å˜å°†ä½¿æˆ‘ä»¬ä¸ mmap å†…å­˜çš„äº¤äº’å˜å¾—æ›´åŠ å®¹æ˜“ã€‚è¿™ä¸€å˜åŒ–çš„çµæ„Ÿæ¥è‡ªç‰›é€¼çš„ crate [pete](https://crates.io/crates/pete) æä¾›äº†æ›´åŠ è¯¦å°½çš„å®‰å…¨ rust ptrace apiã€‚pete æ¿æ¡ç®±çš„è¡ç”Ÿä»£ç å°†è¢«ç›¸åº”åœ°å¼•ç”¨ã€‚

![](img/c70ba75c8e4f4fe32e9d3e367286eebd.png)

å¼ºåˆ¶æ€§ Linux ä¸€åˆ‡éƒ½æ˜¯ä¸€ä¸ªæ–‡ä»¶ç¬‘è¯

âš ï¸In ä¸ºäº†æä¾›ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´ã€æ­£ç¡®çš„ apiï¼Œæˆ‘ä»¬éœ€è¦å°†å¤§éƒ¨åˆ†ä»£ç è½¬ç§»åˆ°ä¸€ä¸ªå•ç‹¬çš„ lib æ–‡ä»¶ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å°±æœ‰äº†ä¸€ä¸ª namespace/mod æ–‡ä»¶æ¥åˆ©ç”¨å¯è§æ€§ä¿®é¥°ç¬¦ã€‚é€šè¿‡ main.rs ä¸­çš„æ‰€æœ‰ä»£ç ï¼Œmain å‡½æ•°å¯ä»¥è®¿é—®åœ¨å®ç°ä¸­åº”è¯¥çœŸæ­£è¢«è§†ä¸ºç§æœ‰çš„å‡½æ•°ï¼Œå› ä¸ºå®ƒä»¬æ˜¯åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­å®šä¹‰çš„ã€‚

![](img/23ebcc14de337d77a51bb1733d7c048b.png)

çœŸæ£’æ—¶é—´è¾“å‡ºæ˜¯ç°å®çš„ï¼Œè€Œä¸æ˜¯é›¶ d:)

ç°åœ¨è¿˜æœ‰ä¸€ä¸ªåœºæ™¯æˆ‘ä»¬æ²¡æœ‰è®¨è®ºï¼Œsyscall ä¸­çš„è¾“å…¥æŒ‡é’ˆå‚æ•°æ€ä¹ˆæ ·ã€‚ [chdir sycall](https://linux.die.net/man/2/chdir) åº”è¯¥è¶³å¤Ÿäº†ã€‚

```
int chdir(const char *path);
```

å¹¶ä¸”ï¼Œå¯¹ main.rs wallah è¿›è¡Œäº†ä¸€äº›å°çš„ç¼–è¾‘ã€‚

```
use std::ffi::CString;

use host::{HostError, HostResult, UserProcess};
use nix::{
    libc::{MAP_ANONYMOUS, MAP_PRIVATE, PROT_READ, PROT_WRITE},
    unistd::Pid,
};
use syscalls::Sysno;
use sysinfo::{ProcessExt, System, SystemExt};

fn main() -> HostResult<()> {
    pretty_env_logger::formatted_builder()
        .filter_level(log::LevelFilter::Trace)
        .init();

    let process_name = "victim";
    log::info!("Host Process Pid: {}", std::process::id());

    // Create sysinfo object and refresh to collect current os state
    let mut sys = System::new_all();
    sys.refresh_all();

    // Find our target process or die
    let process = sys
        .processes_by_name(process_name)
        .take(1)
        .next()
        .ok_or_else(|| HostError::ProcessNotFound(process_name.to_string()))?;

    // Cast our sysinfo::Pid into a nix::unistd::Pid
    let pid = Pid::from_raw(process.pid().into());

    // Attach to the process
    let user_process = UserProcess::attach(pid)?;

    // Refactor out the expect later, but the input should never fail because we know the input does not contain an internal 0 byte.
    let output_message = CString::new("/home/chase").expect("CString::new failed");

    // We want the bytes of the Cstring.
    let output_message = output_message.as_bytes();

    // Allocate 8 bytes of data, i64 is 8 bytes
    let mut user_memory = user_process.allocate_memory(
        0,
        output_message.len() as u64,
        (PROT_READ | PROT_WRITE) as u64,
        (MAP_PRIVATE | MAP_ANONYMOUS) as u64,
        u64::MAX,
        0,
    )?;
    log::info!("UserMemory Result Address: {:#X}", user_memory.address());

    // Read the memory and demonstrate it is zero'd out
    let read = user_process.read_user_memory(&user_memory, user_memory.len() as usize)?;
    log::info!("Allocated Memory: {:?}", read);

    // Write to the memory out cstring
    user_process.write_user_memory(&mut user_memory, 0, output_message)?;

    // We can check if the call succeeded by the resultant rax value.
    let result = user_process
        .sys_call(Sysno::chdir, user_memory.address(), 0, 0, 0, 0, 0)?
        .rax;

    log::info!("Result {result:?}");

    Ok(())
}
```

![](img/8a70a92aa6e858284fbd9159e042dca1.png)

åœ¨è¿è¡Œæˆ‘ä»¬çš„ç¨‹åºåï¼Œè¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½•è¢«æ”¹å˜ï¼Œå¹¶æ˜¾ç¤ºæˆ‘ä»¬æœŸæœ›çš„/home/chase

# ç»“è®º

æˆ‘ä»¬å·²ç»ä¸ºåœ¨ x86_64 ä¸Šä½¿ç”¨ ptrace åœ¨è¿œç¨‹è¿›ç¨‹ä¸­è°ƒç”¨ syscall è®¾è®¡äº†ä¸€ä¸ªç›¸å½“ä¸é”™çš„ apiã€‚è¿™å¾ˆé…·ï¼Œä½†æ˜¯æˆ‘ä»¬ç›®å‰å—é™äºæ‰€æä¾›çš„ç³»ç»Ÿè°ƒç”¨çš„èƒ½åŠ›ã€‚å¦‚æœå°†æ¥æˆ‘ä»¬å¯ä»¥åœ¨å—å®³è€…è¿›ç¨‹ä¸­è°ƒç”¨ç”¨æˆ·ç©ºé—´å‡½æ•°ï¼Œæ¯”å¦‚ libc putsï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è¾“å‡ºåˆ°å—å®³è€…çš„æ§åˆ¶å°ï¼Œè¿™å°†éå¸¸æœ‰ç”¨ã€‚åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†è¿™æ ·åšï¼Œå¹¶å­¦ä¹ å¦‚ä½•è¯†åˆ«å¤–éƒ¨è¿›ç¨‹ä¸­ç”¨æˆ·ç©ºé—´å‡½æ•°çš„åœ°å€ï¼Œåœ¨å—å®³è€…è¿›ç¨‹ä¸­ä½¿ç”¨è°ƒç”¨ [dlopen](https://man7.org/linux/man-pages/man3/dlopen.3.html) æ¥å°†ä»»æ„å…±äº«å¯¹è±¡åŠ è½½åˆ°å…¶åœ°å€ç©ºé—´ä¸­ï¼Œè¿™ç§æŠ€æœ¯è¢«ç§°ä¸ºè¿›ç¨‹æ³¨å…¥ğŸ’‰ã€‚

# èµ„æºè½¬å‚¨/æœªæ¥é˜…è¯»ï¼Œæœªæ¥å·¥ä½œ

## æœ€ç»ˆé¡¹ç›® Github é¡¹ç›®

*   ã€https://github.com/0xFounders/ptrace_syscalls 

## èµ„æº

*   [https://man7.org/linux/man-pages/man5/proc.5.html](https://man7.org/linux/man-pages/man5/proc.5.html)
*   [https://hackeradam.com/x86-64-linux-syscalls/](https://hackeradam.com/x86-64-linux-syscalls/)
*   [https://stack overflow . com/questions/2535989/what-the-calling-conventions-for-UNIX-Linux-system-calls-and-user-space-f](https://stackoverflow.com/questions/2535989/what-are-the-calling-conventions-for-unix-linux-system-calls-and-user-space-f)
*   [https://blog . package cloud . io/the-definitive-guide-to-Linux-system-calls/](https://blog.packagecloud.io/the-definitive-guide-to-linux-system-calls/)

## æœªæ¥çš„å·¥ä½œ

*   æ”¯æŒ x86_32
*   æ”¯æ’‘è‡‚ 32
*   æ”¯æ’‘è‡‚ 64
*   (å¯èƒ½ï¼Ÿ)æ”¯æŒå †æ ˆå‚æ•°ï¼Œä¾‹å¦‚ï¼Œå…·æœ‰å¤šäºå¯„å­˜å™¨å‚æ•°æ•°é‡çš„ syscall è°ƒç”¨ã€‚æˆ‘ç›¸å¯¹ç¡®å®š x86_64 æ²¡æœ‰éœ€è¦å †æ ˆå‚æ•°çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä¾‹å¦‚è¶…è¿‡ 6 ä¸ªå‚æ•°ï¼Œå°½ç®¡æˆ‘ä¸ç¡®å®šå…¶ä»–æ¶æ„æ˜¯å¦ä¹Ÿæ˜¯å¦‚æ­¤ã€‚