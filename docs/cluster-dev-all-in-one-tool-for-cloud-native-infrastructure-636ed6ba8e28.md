# Cluster.dev:ç”¨äºäº‘æœ¬åœ°åŸºç¡€è®¾æ–½çš„ä¸€ä½“åŒ–å·¥å…·

> åŸæ–‡ï¼š<https://itnext.io/cluster-dev-all-in-one-tool-for-cloud-native-infrastructure-636ed6ba8e28?source=collection_archive---------4----------------------->

å°† Terraformã€Helmã€ArgoCD ç­‰æ†ç»‘åˆ°ä¸€ä¸ªç®€å•çš„æ¡†æ¶ä¸­ï¼Œä½¿ç”¨ Cluster.dev åˆ›å»ºå’Œç®¡ç†ç«¯åˆ°ç«¯åŸºç¡€è®¾æ–½ã€‚

![](img/2afe02e00caf45741d011cf9caee78d7.png)

å›¾ç‰‡æ¥æº: [cluster.dev](https://cluster.dev/)

*æ³¨æ„:Cluster.dev ç”±ä¸€ä¸ªæ¥è‡ªä¹Œå…‹å…°çš„å›¢é˜Ÿæä¾›æ”¯æŒï¼Œå…¶æˆå‘˜å·²ç»è®¾æ³•ä»åŸºè¾…æ’¤ç¦»ï¼Œç›®å‰æ˜¯å®‰å…¨çš„ã€‚(*ğŸ‡ºğŸ‡¦*#ç«™åœ¨ä¹Œå…‹å…°)*

éšç€äº‘åŸç”Ÿæ¶æ„çš„å¤æ‚æ€§å¢åŠ ï¼Œç®¡ç†åŸºç¡€æ¶æ„æ‰€éœ€çš„å·¥å…·æ•°é‡ä»¥åŠå¤§è§„æ¨¡ç®¡ç†å’Œæ“ä½œè¿™äº›å·¥å…·çš„ä¸“ä¸šçŸ¥è¯†å¢åŠ äº†å¤§å¤šæ•°åŸºç¡€æ¶æ„å›¢é˜Ÿé¢ä¸´çš„æŒ‘æˆ˜ã€‚ä¾‹å¦‚ï¼Œè¦åœ¨ Kubernetes ä¸Šè¿è¡Œåº”ç”¨ç¨‹åºï¼Œå›¢é˜Ÿéœ€è¦é¦–å…ˆé€šè¿‡ Terraformã€Pulumi æˆ– Crossplane æä¾›äº‘åŸºç¡€è®¾æ–½ã€‚ç„¶åï¼Œå¯ä»¥é€šè¿‡ Helm æˆ– kustomize æ‰“åŒ…åº”ç”¨ç¨‹åºï¼Œå¹¶é€šè¿‡ ArgoCD æˆ–å…¶ä»– CI/CD å·¥å…·è¿›è¡Œéƒ¨ç½²ã€‚æœ€åï¼Œå¯èƒ½ä¼šæœ‰å…¶ä»–è„šæœ¬ã€cronjobsã€Argo å·¥ä½œæµå’Œ secrets manager å°†ä¸€åˆ‡è”ç³»åœ¨ä¸€èµ·ã€‚

å¯¹äºå…·æœ‰ä¼˜ç§€çš„ IaC å’Œ GitOps å®è·µçš„å·²å»ºç«‹çš„å›¢é˜Ÿæ¥è¯´ï¼Œè¿™ä¸ªæŒ‘æˆ˜å¯èƒ½ä¼šå¾—åˆ°éƒ¨åˆ†è§£å†³ã€‚ç„¶è€Œï¼Œå¯¹äºç°åœ¨å¸Œæœ›é‡‡ç”¨ç°ä»£åŸºç¡€æ¶æ„æœ€ä½³å®è·µçš„ç»„ç»‡æ¥è¯´ï¼Œå¤„ç†æ‰€æœ‰è¿™äº›å·¥å…·å’Œå·¥ä½œæµå¯èƒ½ä¼šä»¤äººæœ›è€Œç”Ÿç•ã€‚å½“åŸºç¡€æ¶æ„è¿˜å¿…é¡»æ‰“åŒ…å¹¶äº¤ä»˜ç»™è¿è¡Œè®¸å¯è½¯ä»¶æˆ–æœ¬åœ°è½¯ä»¶çš„å®¢æˆ·æ—¶ï¼Œè¿™ç§æƒ…å†µä¹ŸåŒæ ·é€‚ç”¨ã€‚

Cluster.dev æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œæ—¨åœ¨é€šè¿‡å°†æ‰€æœ‰æµè¡Œçš„åŸºç¡€è®¾æ–½å·¥å…·æ•´åˆåˆ°ä¸€ä¸ªæ¡†æ¶ä¸­æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å®ƒä½¿ç”¨ä¸€ä¸ªâ€œå †æ ˆæ¨¡æ¿â€ä»¥ä¸€ç§ç†Ÿæ‚‰çš„å£°æ˜æ€§æ¸…å•æ–¹æ³•æ¥å®šä¹‰æ‰€æœ‰çš„åŸºç¡€ç»“æ„éƒ¨åˆ†ã€‚å †æ ˆæ¨¡æ¿å¯ä»¥æ˜¯ä»»ä½•ä¸œè¥¿ï¼Œä» Terraform æ¨¡å—åˆ° shell è„šæœ¬ã€èˆµå›¾ã€ArgoCD åº”ç”¨ç¨‹åºï¼Œç”šè‡³æ˜¯ OPA/Kyverno ç­–ç•¥ã€‚

# é‡è¦æ¦‚å¿µ

æ¯ä¸ªå †æ ˆæ¨¡æ¿éƒ½ç”±å•å…ƒç»„æˆï¼Œè¿™äº›å•å…ƒæ¥æ”¶å˜é‡å’Œæ¥è‡ªå…¶ä»–å•å…ƒçš„è¾“å‡ºï¼Œä»¥éƒ¨ç½²ä¸€äº›åŸºç¡€è®¾æ–½ã€‚è¿™ä¸ªå•å…ƒå¯ä»¥æ˜¯ä¸€ä¸ª bash è„šæœ¬æ¥åˆ›å»ºä¸€äº› TLS è¯ä¹¦ã€ä¸€ä¸ª Terraform æ¨¡å—æˆ–ä¸€äº›å®šåˆ¶çš„è§£å†³æ–¹æ¡ˆã€‚

![](img/47de80bc6831525a3f846e956242c03a.png)

æ·±å…¥ç ”ç©¶æ¨¡æ¿ï¼Œcluster.dev å…¬å¼€äº†ç†Ÿæ‚‰çš„ YAML æ¨¡æ¿é€»è¾‘(ç±»ä¼¼äº Helm/Go æ¨¡æ¿)ä»¥åŠç±»ä¼¼ Terraform çš„è¯­æ³•ã€‚åœ¨æœ€é«˜å±‚ï¼Œæœ‰ä¸€ä¸ª`project.yaml`å’Œç§˜å¯†ã€‚è¯¥æ–‡ä»¶å¯å®šä¹‰å…¨å±€å˜é‡ï¼Œå¦‚ AWS åŒºåŸŸ(å¦‚`us-east-1`)æˆ–é€šå¸¸å®šä¹‰åœ¨ Terraform/Terragrunt æ¨¡å—æ ¹çš„å˜é‡(å¦‚ Terraform provider)ã€‚

```
name: my_project 
kind: project 
backend: aws-backend 
variables:   
  organization: my-org   
  region: us-east-1   
  state_bucket_name: cluster-dev-state
exports:   
  AWS_PROFILE: development
```

secrets çš„å·¥ä½œæ–¹å¼ç±»ä¼¼äº external-secretsï¼Œé€šè¿‡ sop ä¸äº‘æä¾›å•†çš„ secret store(ä¾‹å¦‚ AWS Secrets Manager)æˆ–åŠ å¯†çš„ Secrets é›†æˆã€‚

```
name: my-aws-secret
kind: Secret
driver: aws_secretmanager
spec: 
    region: us-east-1
    aws_secret_name: my-secret
```

ç„¶åï¼Œæˆ‘ä»¬æœ‰äº†`backend.yaml`ï¼Œç±»ä¼¼äº Terraform åç«¯å®šä¹‰:

```
name: aws-backend
kind: Backend
provider: s3
spec:  
  bucket: {{ .project.variables.state_bucket_name }}  
  region: {{ .project.variables.region }}
```

æ³¨æ„ç†Ÿæ‚‰çš„ go-templating å°†å˜é‡ä»é¡¶å±‚`project.yaml`ä¼ å…¥åç«¯å®šä¹‰ã€‚

æœ€åï¼Œæˆ‘ä»¬æœ‰å„ç§`stack.yaml`æ–‡ä»¶æ¥å®šä¹‰å„ä¸ªå•å…ƒã€‚ä¸€ä¸ªç®€å•çš„ EKS ä¾‹å­å¯èƒ½æ˜¯è¿™æ ·çš„:

```
name: eks-demo
template: https://github.com/shalb/cdev-aws-eks?ref=v0.2.0
kind: Stack
backend: aws-backend
variables:
  region: {{ .project.variables.region }}
  organization: {{ .project.variables.organization }}
  domain: cluster.dev
  instance_type: "t3.medium"
  eks_version: "1.20"
```

ç›®å‰åªæœ‰ä¸‰ä¸ªâ€œå®˜æ–¹â€æ”¯æŒçš„æ¨¡æ¿( [AWS K3s](https://github.com/shalb/cdev-aws-k3s) ã€ [AWS EKS](https://github.com/shalb/cdev-aws-eks) å’Œ[æ•°å­—æµ·æ´‹ K8s](https://github.com/shalb/cdev-do-k8s) )ï¼Œä½†é‰´äºå…¶è®¾è®¡ï¼Œç°æœ‰çš„ Terraform æ¨¡å—å¯ä»¥ç”¨æ¥è½»æ¾æ”¯æŒå…¶ä»–æ¨¡å—ã€‚

# æ¼”ç¤ºå®‰è£…

ä¸ºäº†æµ‹è¯•è¿™ä¸€ç‚¹ï¼Œæˆ‘ä½¿ç”¨äº† [AWS EKS](https://github.com/shalb/cdev-aws-eks) ç¤ºä¾‹æ¨¡æ¿ï¼Œå®ƒä¸º AWS VPCã€53 å·å…¬è·¯ã€EKS æ‰“åŒ…äº† Terraform æ¨¡å—ï¼Œç„¶åå®‰è£… cert-managerã€ingress-nginx å’Œ argocd Helm charts(å®Œæ•´çš„å †æ ˆå®šä¹‰åœ¨æ­¤[åˆ—å‡º](https://github.com/shalb/cdev-aws-eks/blob/main/aws-eks.yaml))ã€‚

è¦ä½¿ç”¨ Cluster.devï¼Œéœ€è¦å®‰è£… [Terraform](https://www.terraform.io/downloads) å’Œ [Cluster.dev äºŒè¿›åˆ¶æ–‡ä»¶](https://docs.cluster.dev/get-started-install/)ã€‚ä¸å¹¸çš„æ˜¯ï¼ŒMac M1s è¿˜ä¸è¢«æ”¯æŒï¼Œæ‰€ä»¥æˆ‘ä¸ºè¿™ä¸ªæ¼”ç¤ºåˆ›å»ºäº†ä¸€ä¸ª Linux AMD64 VMã€‚

```
$ cdev project create [https://github.com/shalb/cdev-aws-eks](https://github.com/shalb/cdev-aws-eks) --interactive
```

åœ¨äº¤äº’æ¨¡å¼ä¸‹è¿è¡Œ`cdev`æä¾›äº†å…³äº Cluster.dev æ‰€æœŸæœ›çš„æ›´å¤šä¿¡æ¯(ä¾‹å¦‚ï¼Œå®ƒå¦‚ä½•é€šè¿‡ AWS è®¤è¯ã€S3 æ¡¶æŒæœ‰çŠ¶æ€ç­‰)ã€‚

![](img/67c93427e5d9652082dd42c5c247c2fa.png)

åœ¨å¡«å†™é¡¹ç›®åç§°ã€ç»„ç»‡åç§°ã€AWS åŒºåŸŸå’Œ DNS åŒºåŸŸåŸŸåä¹‹åï¼Œé¡¹ç›®åç«¯å’Œç¤ºä¾‹å †æ ˆæ–‡ä»¶ä¼šè‡ªåŠ¨ç”Ÿæˆã€‚è¿™ä¹Ÿå¯ä»¥åœ¨ Github ä¸Šçš„`[example](https://github.com/shalb/cdev-aws-eks/tree/main/examples)`ç›®å½•ä¸‹çœ‹åˆ°ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œ`cdev plan`æ¥é¢„è§ˆå°†è¦åˆ›å»ºçš„èµ„æº:

![](img/5e6dea58beb06f4c8922b352edf79e79.png)

ç±»ä¼¼åœ°ï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œ`cdev apply`æ¥åˆ›å»ºè®¡åˆ’å¥½çš„å·¥ä»¶ã€‚

# ç”¨ä¾‹

å¯¹äºæœ‰ç»éªŒçš„ Terraform ç”¨æˆ·æ¥è¯´ï¼ŒCluster.dev åº”è¯¥çœ‹èµ·æ¥éå¸¸ç±»ä¼¼äº Terraform å’Œ Terragruntã€‚æ¼”ç¤ºæ¨¡æ¿å°±åƒä¸€ä¸ªç®€å•çš„ Terraform åŒ…è£…å™¨ï¼Œå°† EKS åˆ›å»ºä¸èˆµå›¾éƒ¨ç½²æ†ç»‘åœ¨ä¸€èµ·ã€‚è¿™æ˜¯ä¸€ä¸ªç›¸å½“äººä¸ºçš„ä¾‹å­ï¼Œå› ä¸º Terraform ä¹Ÿå¯ä»¥å¤„ç†èˆµå›¾ã€‚ç„¶è€Œï¼ŒCluster.dev æœ€æœ‰è¶£çš„éƒ¨åˆ†éšè—åœ¨å•å…ƒçš„é’©å­ä¸­ã€‚æœ€æ˜æ˜¾çš„ä¾‹å­æ˜¯å®ƒå¦‚ä½•å•ç‹¬ç®¡ç† aws-auth:

```
- name: eks_auth    
  type: kubernetes    
  provider_version: "0.6.0"    
  pre_hook:      
    command: *getKubeconfig      
    on_destroy: true    
  kubeconfig: ../kubeconfig_{{ .name }}    
  depends_on: this.eks    
  source: ./eks/
```

EKS Terraform æ¨¡å—ç”¨æˆ·ç†Ÿæ‚‰è®© Terraform ç®¡ç† aws-auth çš„[é™·é˜±ï¼Œå› ä¸º](https://www.koslib.com/posts/troubleshooting-terraform-eks-module/) [*Terraform åªèƒ½å¼•ç”¨é…ç½®åº”ç”¨å‰å·²çŸ¥çš„å€¼*](https://www.terraform.io/language/providers/configuration) ã€‚Cluster.dev èƒ½å¤Ÿé€šè¿‡å°†å®ƒä½œä¸ºä¸€ä¸ªå•å…ƒæ¥ç®¡ç†æ¥è§„é¿è¿™ä¸ªé—®é¢˜ã€‚

Cluster.dev æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œé€‚ç”¨äº:

1.  åŸºç¡€è®¾æ–½å›¢é˜Ÿæ‹¥æœ‰ä¸€ç³»åˆ—ä¸åŒçš„å·¥å…·ã€‚å¯¹äºåœ¨æœ¬åœ°è¿è¡Œé—ç•™åº”ç”¨ç¨‹åºä»¥åŠåœ¨ Kubernetes ä¸Šè¿è¡Œæ–°çš„äº‘åŸç”Ÿåº”ç”¨ç¨‹åºçš„å›¢é˜Ÿæ¥è¯´ï¼Œè¿™ä¸€ç‚¹å¯èƒ½æ›´åŠ æ˜æ˜¾ã€‚
2.  å¹³å°å·¥ç¨‹å›¢é˜Ÿè´Ÿè´£ä¸ºæ–°å›¢é˜Ÿç»´æŠ¤ä¸€ä¸ªå¯åŠ¨æ¨¡æ¿ï¼Œä»¥æ„å»ºå’Œæµ‹è¯•ä»–ä»¬çš„æ–°æœåŠ¡ã€‚è¿™ä¹Ÿé€‚ç”¨äºéœ€è¦å¿«é€Ÿå¯åŠ¨åŸºç¡€è®¾æ–½çš„å’¨è¯¢æˆ–åŸºäºé¡¹ç›®çš„å›¢é˜Ÿã€‚
3.  æ ¹æ®åˆåŒæœ‰ä¹‰åŠ¡äº¤ä»˜åŸºç¡€è®¾æ–½ä»£ç å’Œè®¸å¯åº”ç”¨ç¨‹åºçš„è½¯ä»¶ä¾›åº”å•†ã€‚åœ¨é‡‘èç§‘æŠ€é¢†åŸŸï¼Œè¿™ä»ç„¶éå¸¸æ™®éï¼Œå¤§å‹é‡‘èæœºæ„æ›´å€¾å‘äºåœ¨è‡ªå·±çš„æ•°æ®ä¸­å¿ƒè¿è¡Œï¼Œè€Œä¸æ˜¯ä½¿ç”¨ SaaS çš„äº§å“ã€‚

ä½†æ˜¯ï¼Œå¦‚æœæ‚¨çš„ç»„ç»‡çš„ç»“æ„ä½¿å¾—å¤„ç† Terraform å’Œ Helm/argod çš„å›¢é˜Ÿä¸åŒï¼ŒCluster.dev å¯èƒ½å¹¶ä¸é€‚åˆã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨çš„ç»„ç»‡ä¸­çš„å¼€å‘äººå‘˜è´Ÿè´£åˆ›å»º/ç»´æŠ¤æŒèˆµå›¾ï¼Œé‚£ä¹ˆå¼•å…¥å¦ä¸€ä¸ªå·¥å…·æ¥æŠ½è±¡å®ƒå°†ä¼šæ›´åŠ å›°éš¾ï¼Œç‰¹åˆ«æ˜¯å¦‚æœå·²ç»æœ‰ä¸€ä¸ªè¿è¡Œçš„ CI/CD ç®¡é“æ¥å¤„ç†å®ƒã€‚

çœ‹çœ‹ Cluster.dev å¦‚ä½•é»˜è®¤æ”¯æŒæ›´å¤šçš„æ¨¡æ¿å¹¶ä¸éåœ°å½¢å·¥å…·(å¦‚ Pulumi å’Œ Crossplane)é›†æˆå°†ä¼šå¾ˆæœ‰è¶£ã€‚ä»–ä»¬çš„æ–‡æ¡£ç½‘ç«™ä¸Šæœ‰ä¸€ç¯‡å¾ˆå¥½çš„æ¯”è¾ƒæ–‡ç« ï¼Œä½†æ˜¯éšç€è¿™äº›å·¥å…·è¶Šæ¥è¶Šå—æ¬¢è¿ï¼Œé‡æ–°è¯„ä¼°ä¼šå¾ˆæœ‰è¶£ã€‚