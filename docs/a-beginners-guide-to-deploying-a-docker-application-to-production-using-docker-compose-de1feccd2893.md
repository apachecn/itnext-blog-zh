# ä½¿ç”¨ Docker Compose å°† Docker åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒçš„åˆå­¦è€…æŒ‡å—

> åŸæ–‡ï¼š<https://itnext.io/a-beginners-guide-to-deploying-a-docker-application-to-production-using-docker-compose-de1feccd2893?source=collection_archive---------0----------------------->

## Docker: Docker æ’°å†™

## åœ¨è¿™ä¸€è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹  Docker Compose å¦‚ä½•å·¥ä½œï¼Œä»¥åŠå¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å®ƒæ¥éƒ¨ç½²å’Œç®¡ç†å¤šä¸ªå®¹å™¨ã€‚

![](img/43ccdb4d60022a20ca08e39d8ea35f7d.png)

(æ¥æº:[**unsplash.com**](https://unsplash.com/photos/Z-HBjM62f6M))

åœ¨ [**ä¹‹å‰çš„è¯¾ç¨‹**](https://medium.com/sysf/docker/home) ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºäº† Docker çš„åŸºç¡€çŸ¥è¯†ã€‚æˆ‘ä»¬å­¦ä¹ äº† Docker å®¹å™¨çš„æ„é€ ï¼ŒDocker æ–‡ä»¶çš„ç»“æ„ï¼Œå¦‚ä½•åˆ›å»ºå›¾åƒï¼Œå¦‚ä½•ç®¡ç†å®¹å™¨ï¼Œç­‰ç­‰ã€‚è¿™åªæ˜¯æˆ‘ä»¬æ“ä½œ Docker éœ€è¦çŸ¥é“çš„åŸºæœ¬ä¿¡æ¯ã€‚

å¦‚æœæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºåƒ HTTP æœåŠ¡å™¨ä¸€æ ·ç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ª Docker å®¹å™¨ä¸­è¿è¡Œå®ƒã€‚æ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªå®šåˆ¶çš„ Docker æ˜ åƒï¼Œå°†åº”ç”¨ç¨‹åºä»£ç å¤åˆ¶åˆ°æ˜ åƒä¸­ï¼Œå¹¶ä»ä¸­è¿è¡Œä¸€ä¸ªå®¹å™¨ã€‚æ‚¨å¯ä»¥å®‰è£…ä¸€ä¸ªç”¨äºæ°¸ä¹…æ•°æ®å­˜å‚¨çš„å·ï¼Œå¹¶å°†ä¸»æœºä¸Šçš„ä¸€ä¸ªç«¯å£ç»‘å®šåˆ°å®¹å™¨ä¸Šçš„ç«¯å£ï¼Œä»¥å…¬å¼€æ‚¨çš„æœåŠ¡ã€‚å°±æ˜¯è¿™æ ·ã€‚ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ç›‘æ§å®¹å™¨ï¼Œä»¥é˜²å®ƒå…³é—­ã€‚

ç„¶è€Œï¼Œå®é™…ä¸Šï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ˜¯ç”±ä¸åŒçš„æœåŠ¡ç»„æˆçš„ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯èƒ½æœ‰ä¸€ä¸ªä¸º web åº”ç”¨ç¨‹åºæœåŠ¡çš„å‰ç«¯æœåŠ¡ï¼Œä¸€ä¸ªä¸ºå‰ç«¯æä¾› REST API çš„åç«¯æœåŠ¡ï¼Œä»¥åŠä¸€ä¸ªå­˜å‚¨ç”¨æˆ·æ•°æ®çš„æ•°æ®åº“æœåŠ¡ã€‚

è¿™äº›æœåŠ¡å¯ä»¥ç›¸äº’ä¾èµ–ã€‚ä¾‹å¦‚ï¼Œå‰ç«¯æœåŠ¡ä¾èµ–äºåç«¯æœåŠ¡ï¼Œåç«¯æœåŠ¡ä¾èµ–äºæ•°æ®åº“æœåŠ¡ã€‚é™¤éæˆ‘ä»¬å¯åŠ¨å¹¶è¿è¡Œæ‰€æœ‰çš„æœåŠ¡ï¼Œå¦åˆ™æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå°†æ— æ³•æ­£å¸¸è¿è¡Œã€‚å®ƒä»¬å¯èƒ½éœ€è¦ä»¥æ­£ç¡®çš„é¡ºåºå¯åŠ¨ï¼Œæ‰èƒ½é¡ºåˆ©è¿›è¡Œã€‚

æ‰‹åŠ¨æ“ä½œå¾ˆéº»çƒ¦ã€‚ä¸æ˜¯å›¢é˜Ÿä¸­çš„æ¯ä¸ªäººéƒ½çŸ¥é“æ•´ä¸ªåº”ç”¨ç¨‹åºçš„ä¸Šä¸‹æ–‡ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„å…ƒæ•°æ®ï¼Œä½ ä¸èƒ½æŠŠäº‹æƒ…æç ¸ã€‚ä½ éœ€è¦æŸç§**ç¼–æ’å·¥å…·**æ¥è‡ªåŠ¨ç®¡ç†ä½ çš„æœåŠ¡ã€‚æ‚¨å¸Œæœ›è¿™ä¸ªå·¥å…·é…ç½®æ‚¨çš„æœåŠ¡ã€ç®¡ç†å¯åŠ¨å’Œå…³é—­ä»¥åŠå¤„ç†æ•…éšœã€‚è¿™å°±æ˜¯ **Docker Compose** çš„ç”¨æ­¦ä¹‹åœ°ã€‚

# Docker æ’°å†™

Docker Compose æ˜¯ä¸€ä¸ªç®¡ç†å¤šå®¹å™¨åº”ç”¨ç¨‹åºçš„å·¥å…·ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¸Šé¢è®¨è®ºçš„ web åº”ç”¨ç¨‹åºã€‚æ¯ä¸ª**å®¹å™¨å……å½“ä¸€ä¸ªæœåŠ¡**ï¼Œä¸ºåº”ç”¨ç¨‹åºçš„æ•´ä¸ªåŠŸèƒ½æä¾›è´¡çŒ®ã€‚è¿™ä¸ªæ¨¡å‹è¢«ç§°ä¸º [**CaaS**](https://blog.back4app.com/caas-container-as-a-service/) (å®¹å™¨å³æœåŠ¡)ã€‚

> *ğŸ’¡*å¦‚æœæ‚¨ä½¿ç”¨ Docker for Desktopï¼Œä¾‹å¦‚ macOS å’Œ Windows æ“ä½œç³»ç»Ÿï¼Œé‚£ä¹ˆæ‚¨å·²ç»å®‰è£…äº† Docker Composeï¼Œå¦åˆ™æ‚¨å¯ä»¥ä» [**æ­¤**](https://docs.docker.com/compose/install/) é¡µé¢æ‰‹åŠ¨ä¸‹è½½ã€‚

Docker Compose ä¸æ˜¯ Docker Engine çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤å¿…é¡»å•ç‹¬å®‰è£…ã€‚åƒ Docker Engine ä¸€æ ·ï¼ŒDocker Compose ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå‘½ä»¤è¡Œç•Œé¢(CLI)æ¥ä¸ä¹‹äº¤äº’ã€‚æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œ`$ docker-compose --version`å‘½ä»¤æ¥éªŒè¯å®ƒçš„å®‰è£…ã€‚

![](img/d23e78fac739fd8b10e42e9d6f67e00e.png)

$ docker-æ’°å†™-ç‰ˆæœ¬

é‚£ä¹ˆ Docker æ˜¯å¦‚ä½•ä½œæ›²çš„å‘¢ï¼ŸDocker Compose åªæ˜¯ä¸€ä¸ªç¼–æ’å·¥å…·ï¼Œä»…æ­¤è€Œå·²ã€‚ä½œä¸ºä¸€ä¸ªäººï¼Œæ‚¨ä¼šåšäº›ä»€ä¹ˆæ¥æ„å»ºæ˜ åƒã€å¯åŠ¨ã€åœæ­¢å’Œç›‘æ§å®¹å™¨ã€å¯¹è¿è¡Œä¸­çš„å®¹å™¨è¿›è¡Œå¥åº·æ£€æŸ¥ã€å¤„ç†æ•…éšœç­‰ã€‚ï¼ŒDocker Compose ä¼šä¸ºæ‚¨åšåˆ°è¿™ä¸€ç‚¹ã€‚

![](img/ea9e5dfaef8bdba4b9719df910b89bf9.png)

$ docker-æ’°å†™-å¸®åŠ©

åœ¨æ„å»º Docker æ˜ åƒæ—¶ï¼Œ`$ docker build`å‘½ä»¤æŸ¥çœ‹`Dockerfile`å¹¶é€å±‚æ„å»ºæ˜ åƒã€‚ç±»ä¼¼åœ°ï¼Œ`$ docker-compose`å­å‘½ä»¤æŸ¥çœ‹`docker-compose.yml`æ–‡ä»¶å¹¶è¿è¡ŒæŒ‡ä»¤ã€‚è¿™äº›æŒ‡ä»¤é…ç½®è¦è¿è¡Œçš„æœåŠ¡(*å®¹å™¨*)ã€‚

`docker-compose.yml`æ–‡ä»¶è¢«ç§°ä¸º**åˆæˆæ–‡ä»¶**ï¼Œå› ä¸ºå®ƒä½¿ç”¨ Docker Compose æ¥åˆæˆæœåŠ¡ã€‚ä¸ Dockerfile ä¸åŒï¼Œè¯¥æ–‡ä»¶éµå¾ª [**YAML**](https://en.wikipedia.org/wiki/YAML) è¯­æ³•ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ‚¨ä¹Ÿå¯ä»¥å¯¹è¯¥æ–‡ä»¶ä½¿ç”¨`.yaml`æ‰©å±•åã€‚

> *ğŸ’¡*å½“æˆ‘ä»¬è¿è¡Œ`$ docker-compose`å‘½ä»¤æ—¶ï¼ŒDocker Compose é»˜è®¤åœ¨å½“å‰ç›®å½•ä¸­æŸ¥æ‰¾åä¸º`docker-compose.yml/.yaml`çš„æ–‡ä»¶ï¼Œä½†æ˜¯ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`-f`æˆ–`--file`æ ‡å¿—è¦†ç›–æ–‡ä»¶è·¯å¾„ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ JSON æ–‡ä»¶(ã€‚json)ï¼Œå› ä¸º YAML æ˜¯ JSON çš„è¶…é›†ã€‚

åˆæˆæ–‡ä»¶åŒ…å«æœåŠ¡åˆ—è¡¨ã€‚æœåŠ¡åŒ…å«è¦è¿è¡Œçš„å®¹å™¨çš„é…ç½®ã€‚è¯¥é…ç½®å¯ä»¥æŒ‡å®šå“ªä¸ª Docker æ˜ åƒç”¨äºå®¹å™¨ã€å®‰è£…ä»€ä¹ˆå·ã€æš´éœ²ä»€ä¹ˆç«¯å£ç­‰ã€‚Docker Compose è¿˜å¯ä»¥åœ¨å¯åŠ¨æœåŠ¡æ—¶åŠ¨æ€æ„å»º Docker æ˜ åƒ(*æ¥è‡ª Dockerfile* )ã€‚

åˆæˆæ–‡ä»¶è¿˜å¯ä»¥åˆ›å»ºæœåŠ¡å¯ä»¥ä½¿ç”¨çš„å·ã€‚å®ƒè¿˜å¯ä»¥é…ç½®æœåŠ¡å¯èƒ½åŠ å…¥çš„ç½‘ç»œã€‚æˆ‘ä»¬è¿˜å¯ä»¥å®šä¹‰æ¯ä¸ªæœåŠ¡å¿…é¡»å¯åŠ¨å’Œå…³é—­çš„å¯åŠ¨é¡ºåºã€‚Docker Compose æ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§çš„å·¥å…·ï¼Œå®ƒå°†æˆ‘ä»¬ä»æ‰‹åŠ¨ç®¡ç†å®¹å™¨çš„è´Ÿæ‹…ä¸­è§£æ”¾å‡ºæ¥ã€‚æ‰€ä»¥è®©æˆ‘ä»¬å¼€å§‹å§ã€‚

# æ’°å†™æ–‡ä»¶

åˆæˆæ–‡ä»¶æ˜¯ä¸€ä¸ª YAML æ–‡ä»¶ï¼Œå®ƒæä¾›æœåŠ¡ä»¥åŠç½‘ç»œã€å·ã€ç¯å¢ƒå˜é‡ç­‰çš„é…ç½®ã€‚ç”±æœåŠ¡ä½¿ç”¨(*å®ƒä»¬çš„å®¹å™¨*)ã€‚è¿™ä¸ªæ–‡ä»¶é€šå¸¸è¢«å‘½åä¸º`docker-compose.yml`ï¼Œæ”¾åœ¨é¡¹ç›®ç›®å½•ä¸­ã€‚å½“æˆ‘ä»¬ä»é¡¹ç›®ç›®å½•ä¸­è¿è¡Œ`$ docker-compose [options] <subcommand> [suboptions]`å‘½ä»¤æ—¶ï¼ŒDocker Compose å°†è¯»å–è¿™ä¸ªæ–‡ä»¶æ¥åˆ†ææœåŠ¡ï¼Œä»¥ä¾¿å®ƒå¯ä»¥å¯åŠ¨ã€åœæ­¢æœåŠ¡æˆ–å¯¹å®ƒä»¬åšå…¶ä»–äº‹æƒ…ã€‚

> *ğŸ’¡*ä¸ Dockerfile ä¸åŒï¼ŒCompose file æä¾›äº†å¤§é‡é€‰é¡¹ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¾ˆéš¾åœ¨ä¸€ç¯‡æ–‡ç« ä¸­æè¿°æ¯ä¸€ä»¶å°äº‹ã€‚æˆ‘ä¼šå°½åŠ›æŠ¥é“é‡è¦çš„è¯é¢˜ã€‚è¦äº†è§£æ›´å¤šä¿¡æ¯ï¼Œæ‚¨å¯ä»¥éšæ—¶æŒ‰ç…§ [**æœ¬**](https://docs.docker.com/compose/compose-file) å®˜æ–¹æ–‡æ¡£è¿›è¡Œæ’°å†™æ–‡ä»¶å‚è€ƒã€‚

(æ¥æº:[**gist.github.com**](https://gist.github.com/thatisuday/e68b4003629da23bb317c009cb34ba14))

ä¸€ä¸ªå…¸å‹çš„`docker-compose.yml`æ–‡ä»¶çœ‹èµ·æ¥å¦‚ä¸Šã€‚`version`é”®æŒ‡å®šè¦ä½¿ç”¨çš„åˆæˆæ–‡ä»¶çš„ç‰ˆæœ¬ã€‚ç›®å‰æœ€æ–°ç‰ˆæœ¬æ˜¯`[3.9](https://docs.docker.com/compose/compose-file/)`(*2020 å¹´ 12 æœˆ*)ã€‚ç‰¹å®šçš„åˆæˆæ–‡ä»¶ç‰ˆæœ¬ä¸ç‰¹å®šçš„ Docker å¼•æ“ç‰ˆæœ¬å…¼å®¹ï¼Œ [**è¿™é‡Œçš„**](https://docs.docker.com/compose/compose-file/compose-versioning/) æ˜¯å…¼å®¹æ€§çŸ©é˜µã€‚

> *ğŸ’¡*å…¸å‹çš„åˆæˆæ–‡ä»¶ç‰ˆæœ¬æ˜¯ä»¥`<major>:<minor>`å‘å¸ƒçš„å½¢å¼ã€‚å¦‚æœæˆ‘ä»¬çœç•¥äº†`:<minor>`éƒ¨åˆ†ï¼ŒDocker Compose ä¼šè‡ªåŠ¨å‡å®šä¸º`0`æ¬¡è¦ç‰ˆæœ¬ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åº”è¯¥æ˜ç¡®æåˆ°æ¬¡è¦ç‰ˆæœ¬ã€‚

ä½¿ç”¨`services`å­—æ®µï¼Œæˆ‘ä»¬å®šä¹‰ Docker ç¼–å†™åº”è¯¥å¯åŠ¨çš„å®¹å™¨(*æœåŠ¡*)ã€‚åœ¨ä¸Šé¢çš„ç»„åˆæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸‰ä¸ªæœåŠ¡ï¼Œå³`database`ã€`frontend`å’Œ`backend`ã€‚Docker Compose å°†ä½¿ç”¨è¿™äº›æœåŠ¡åæ¥å‘½åå°†è¦åˆ›å»ºçš„æ˜ åƒã€å®¹å™¨æˆ–å·ã€‚

`database`æœåŠ¡(*å®¹å™¨*)ä½¿ç”¨äº†`mysql:latest`å›¾åƒã€‚æˆ‘ä»¬ä½¿ç”¨æœåŠ¡çš„`[image](https://docs.docker.com/compose/compose-file/compose-file-v3/#image)`å­—æ®µå®šä¹‰åº”è¯¥ä»å“ªä¸ªå›¾åƒåˆ›å»ºå®¹å™¨ã€‚Docker ä» Docker Hub ä¸‹è½½è¿™ä¸ªæ˜ åƒå¹¶åˆ›å»ºä¸€ä¸ªå®¹å™¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥å®¹å™¨å°†å…¬å¼€`3306`ç«¯å£ï¼Œå¹¶æŒ‰ç…§å…¶ [Dockerfile](https://github.com/docker-library/mysql/blob/ee33a2144a0effe9459abf02f20a6202ae645e94/8.0/Dockerfile.debian) çš„æŒ‡å®šè¿è¡Œ MySQL æœåŠ¡å™¨ã€‚è¿™æ˜¯åˆæˆæ–‡ä»¶ä¸­æœåŠ¡çš„æœ€ä½é…ç½®ã€‚

`backend`æœåŠ¡ä½¿ç”¨æ¥è‡ª Docker Hub çš„`node:latest`å›¾åƒã€‚ç„¶è€Œï¼Œæˆ‘ä»¬ä¸ºå®¹å™¨å¯åŠ¨åšäº†ä¸€äº›é¢å¤–çš„é…ç½®ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨`[working_dir](https://docs.docker.com/compose/compose-file/compose-file-v3/#domainname-hostname-ipc-mac_address-privileged-read_only-shm_size-stdin_open-tty-user-working_dir)`å­—æ®µå°†`/app`è®¾ç½®ä¸ºå®¹å™¨çš„å·¥ä½œç›®å½•ã€‚ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨`[volumes](https://docs.docker.com/compose/compose-file/compose-file-v3/#volumes)`å­—æ®µå°†ä¸»æœºçš„`./backend`ç›®å½•æŒ‚è½½åˆ°å®¹å™¨çš„`/app`ç›®å½•ã€‚ç„¶åæˆ‘ä»¬ä½¿ç”¨`[command](https://docs.docker.com/compose/compose-file/compose-file-v3/#command)`å­—æ®µæ‰§è¡Œ`node ./server.js`å‘½ä»¤ï¼Œè¿™å°†å¯åŠ¨ä¸€ä¸ª HTTP æœåŠ¡å™¨ï¼Œè€Œ`[expose](https://docs.docker.com/compose/compose-file/compose-file-v3/#expose)`å­—æ®µæŒ‡å®šè¦å…¬å¼€çš„å®¹å™¨ç«¯å£ã€‚

> *ğŸ’¡*åˆæˆæ–‡ä»¶ä¸­ä½¿ç”¨çš„æ‰€æœ‰(ä¸»æœºçš„)ç›¸å¯¹è·¯å¾„å°†ç›¸å¯¹äº`docker-compose.yml`æ–‡ä»¶ã€‚`[entrypoint](https://docs.docker.com/compose/compose-file/compose-file-v3/#entrypoint)`ã€`[working_dir](https://docs.docker.com/compose/compose-file/compose-file-v3/#domainname-hostname-ipc-mac_address-privileged-read_only-shm_size-stdin_open-tty-user-working_dir)`ã€`[command](https://docs.docker.com/compose/compose-file/compose-file-v3/#command)`å’Œ`[expose](https://docs.docker.com/compose/compose-file/compose-file-v3/#expose)`å­—æ®µå€¼ä¼šè¦†ç›–ä»å…¶åˆ›å»ºå®¹å™¨çš„æ˜ åƒçš„`ENTRYPOINT`ã€`WORKDIR`ã€`CMD`å’Œ`EXPOSE`æŒ‡ä»¤ã€‚

æœåŠ¡ä¸ä½¿ç”¨å…¬å…±å›¾åƒã€‚æˆ‘ä»¬ä¸ä½¿ç”¨`image`å­—æ®µï¼Œè€Œæ˜¯ä½¿ç”¨`[build](https://docs.docker.com/compose/compose-file/compose-file-v3/#build)`å­—æ®µæŒ‡å®šä¸Šä¸‹æ–‡ç›®å½•çš„è·¯å¾„ã€‚Docker Compose å°†ä¸ºè¯¥æœåŠ¡çš„å®¹å™¨åŠ¨æ€åˆ›å»ºä¸€ä¸ªå›¾åƒã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨å¯¹è±¡é…ç½®æŒ‡å®šè‡ªå®šä¹‰ Dockerfile è·¯å¾„å’Œä¸Šä¸‹æ–‡ç›®å½•ï¼Œå¦‚è¿™é‡Œçš„[æ‰€è¿°](https://docs.docker.com/compose/compose-file/compose-file-v3/#build)ã€‚

`[ports](https://docs.docker.com/compose/compose-file/compose-file-v3/#ports)`å­—æ®µå°†ä¸»æœºç«¯å£ä¸æš´éœ²çš„å®¹å™¨ç«¯å£ç»‘å®šåœ¨ä¸€èµ·ã€‚è¯¥å­—æ®µæä¾›äº†æ›´å¤šé…ç½®é€‰é¡¹ï¼Œå¦‚æœ¬æ–‡ä¸­[æ‰€è¿°ã€‚](https://docs.docker.com/compose/compose-file/compose-file-v3/#ports)`[depends_on](https://docs.docker.com/compose/compose-file/compose-file-v3/#depends_on)`å­—æ®µæ§åˆ¶æœåŠ¡å¦‚ä½•å¯åŠ¨ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œç”±äº`frontend`æœåŠ¡ä¾èµ–äº`database`å’Œ`backend`æœåŠ¡ï¼Œæ‰€ä»¥å®ƒä»¬è¢«é¦–å…ˆå¯åŠ¨ã€‚ä¸€æ—¦è¿™äº›æœåŠ¡(*å®¹å™¨*)è¢«å¯åŠ¨ï¼Œ`frontend`æœåŠ¡(*å®¹å™¨*)å°†è¢«åˆ›å»ºã€‚

## è¦†ç›–åˆæˆæ–‡ä»¶

é€šå¸¸ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¼šç»å†å¤šç§ç¯å¢ƒã€‚é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨æœ¬åœ°æœºå™¨ä¸Šå¼€å‘åº”ç”¨ç¨‹åºï¼Œç„¶åæˆ‘ä»¬å°†å®ƒæ”¾åœ¨ QA çš„è¯•è¿è¡Œç¯å¢ƒä¸­ï¼Œç„¶åæ”¾åœ¨ CI æœåŠ¡å™¨ä¸Šè¿›è¡Œæµ‹è¯•ï¼Œæœ€åå®ƒè¿›å…¥ç”Ÿäº§ç¯å¢ƒã€‚

åœ¨è¿™äº›ç¯å¢ƒä¸­è¿è¡Œåº”ç”¨ç¨‹åºæœåŠ¡çš„é…ç½®ä¸ä¼šæ€»æ˜¯ç›¸åŒçš„ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½å¸Œæœ›åœ¨å¼€å‘ç¯å¢ƒä¸­å…¬å¼€æœåŠ¡çš„ä¸åŒç«¯å£ï¼Œå¦‚`8080`ï¼Œè€Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ‚¨çš„ç†æƒ³é€‰æ‹©æ˜¯`80`ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ„å»ºå‚æ•°æˆ–ç¯å¢ƒå˜é‡æ¥æ§åˆ¶è¿™äº›å€¼(ä¸‹ä¸€ä¸ªä¸­è®¨è®ºçš„*ï¼Œä½†æ˜¯æœ‰æ—¶ä½ éœ€è¦ä¸€ä¸ªé…ç½®å˜æ›´ï¼Œè€Œä½¿ç”¨è¿™äº›å˜é‡æ˜¯æ— æ³•å®ç°çš„ã€‚æ‰€ä»¥ç†æƒ³çš„é€‰æ‹©æ˜¯æ¯ä¸ªç¯å¢ƒæœ‰å¤šä¸ªåˆæˆæ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨`--file`æˆ–`-f`æ ‡å¿—æ¥å†³å®šä½¿ç”¨å“ªä¸ªé…ç½®æ–‡ä»¶ã€‚*

ç„¶è€Œï¼Œå¦‚æœæ‚¨çš„é…ç½®æ–‡ä»¶å¾ˆå¤§ï¼Œå¹¶ä¸”æ‚¨éœ€è¦åœ¨å¤šä¸ªç¯å¢ƒä¸­éƒ¨ç½²æ‚¨çš„åº”ç”¨ç¨‹åºï¼Œé‚£ä¹ˆç®¡ç†å¤šä¸ªé…ç½®æ–‡ä»¶å°±æˆäº†ä¸€é¡¹å•è°ƒä¹å‘³çš„ä»»åŠ¡ã€‚æœ‰æ›´å¥½çš„å‡ºè·¯ã€‚ä½¿ç”¨`-f`æ ‡å¿—ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šå¤šä¸ªåˆæˆæ–‡ä»¶ã€‚Docker Compose å°†ä»å³åˆ°å·¦åˆå¹¶è¿™äº›æ–‡ä»¶ï¼Œå¹¶å‡†å¤‡æœ€ç»ˆçš„åˆæˆé…ç½®ã€‚

```
$ docker-compose -f compose.yml -f compose.dev.yml ...
```

`$ docker-compose`å‘½ä»¤å¯ä»¥æ¥å—å¤šä¸ªåˆæˆæ–‡ä»¶ã€‚ç„¶åï¼Œå®ƒå°†ä»å³åˆ°å·¦åˆå¹¶é…ç½®ã€‚åœ¨ä¸Šè¿°æƒ…å†µä¸‹ï¼Œ`compose.dev.yml`æ–‡ä»¶ä¼šè¦†ç›–`compose.yml`æ–‡ä»¶çš„é…ç½®ã€‚

> *ğŸ’¡*æˆ‘ä»¬å¯ä»¥æœ‰å¤šä¸ªè¦†ç›–æ–‡ä»¶ã€‚åªéœ€åœ¨`$ docker-compose`å‘½ä»¤ä¸­ä½¿ç”¨`-f`æ ‡å¿—æŒ‡å®šé¢å¤–çš„è¦†ç›–æ–‡ä»¶ï¼Œç»“æœé…ç½®å°†é€šè¿‡ä»å³åˆ°å·¦åˆå¹¶æ–‡ä»¶æ¥åˆ›å»ºã€‚

å¦‚æœæ²¡æœ‰æä¾›`-f`æ ‡å¿—ï¼ŒDocker Compose å°†åœ¨å½“å‰ç›®å½•ä¸­æŸ¥æ‰¾`docker-compose.yml`æ–‡ä»¶ã€‚å®ƒè¿˜ä¼šåœ¨å½“å‰ç›®å½•ä¸­æŸ¥æ‰¾`docker-compose.override.yml`æ–‡ä»¶ï¼Œå¦‚æœå­˜åœ¨ï¼Œå®ƒä¼šè¦†ç›–`docker-compose.yml`æ–‡ä»¶ã€‚

åœ¨è¦†ç›–æ–‡ä»¶ä¸­ï¼Œé…ç½®çš„ç»“æ„åº”è¯¥ä¸å®ƒæ‰€è¦†ç›–çš„æ–‡ä»¶å‡ ä¹ä¸€è‡´ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦è¦†ç›–ä¸€ä¸ªæœåŠ¡çš„å‡ ä¸ªå­—æ®µï¼Œé‚£ä¹ˆ`services > service_name`å­—æ®µåº”è¯¥åœ¨é‚£é‡Œã€‚å¦‚æœæˆ‘ä»¬åœ¨è¦†ç›–æ–‡ä»¶ä¸­å¼•å…¥ä¸€ä¸ªæ–°æœåŠ¡ï¼Œå®ƒå°†è¢«æ·»åŠ åˆ°æœ€ç»ˆé…ç½®ä¸­ã€‚è®©æˆ‘ä»¬çœ‹çœ‹è¦†ç›–æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚

(æ¥æº:[gist.github.comT21](https://gist.github.com/thatisuday/b0dca85227a2a0ca4a4bfb6950597c9d))

è¦éªŒè¯å¹¶æ‰“å°ç»“æœé…ç½®ï¼Œæ‚¨åº”è¯¥ä½¿ç”¨`$ docker-compose [options] [config](https://docs.docker.com/compose/reference/config/)`å‘½ä»¤ã€‚æœ€ç»ˆé…ç½®( `*result.yml*`æŒ‡ç¤ºçš„*)ç”±ä¸‹é¢çš„å‘½ä»¤ç”Ÿæˆã€‚*

```
$ docker-compose -f docker-compose.yml -f docker-compose.prod.yml config
```

æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ç»“æœã€‚æœåŠ¡ä¿æŒåŸæ ·ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰è¦†ç›–å®ƒã€‚`cache`æœåŠ¡è¿›å…¥æœ€ç»ˆé…ç½®ï¼Œå› ä¸ºå®ƒæ˜¯åœ¨è¦†ç›–æ–‡ä»¶ä¸­å®šä¹‰çš„ã€‚`backend`æœåŠ¡ä¸­çš„`image`å­—æ®µè¢«æ›¿æ¢ï¼Œå› ä¸ºå®ƒæ˜¯å•å€¼å­—æ®µã€‚

`frontend`æœåŠ¡é…ç½®æœ€æœ‰è¶£ã€‚æ–°çš„`command`å±æ€§è¢«æ·»åŠ åˆ°è¦†ç›–çš„æœ€ç»ˆé…ç½®ä¸­ã€‚å¤šå€¼å­—æ®µä¸ä¼šè¢«è¦†ç›–ã€‚ç›¸åï¼Œå®ƒä»¬çš„å€¼å°†è¢«åˆå¹¶ï¼Œå¦‚æ‚¨åœ¨`depends_on`å’Œ`ports`å­—æ®µä¸­æ‰€è§ã€‚ä½†æ˜¯ï¼Œåœ¨`volumes`çš„æƒ…å†µä¸‹ï¼Œå¦‚æœå®¹å™¨ç›®å½•ç›¸åŒï¼Œåˆ™åªèƒ½å­˜åœ¨ä¸€ä¸ªæŒ‚è½½ç‚¹ã€‚

> *ğŸ’¡*è¦äº†è§£æ›´å¤šå…³äºè¦†ç›–çš„ä¿¡æ¯ï¼Œè¯·é˜…è¯»æœ¬ æ–‡æ¡£ã€‚

## ä½¿ç”¨ç¯å¢ƒå˜é‡

ç¯å¢ƒå˜é‡å¯ä»¥ç”¨æ¥æ›¿æ¢`docker-compose.yml`æ–‡ä»¶ä¸­çš„å˜é‡ã€‚è¿™åœ¨é’ˆå¯¹ç‰¹å®šäºç¯å¢ƒçš„é…ç½®æ›´æ”¹æ—¶éå¸¸æœ‰ç”¨ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå°ä¾‹å­ã€‚

(æ¥æº:[**gist.github.com**](https://gist.github.com/thatisuday/17f261dcc2cbc46e8c87247f182277ff))

åœ¨ä¸Šé¢çš„`docker-compose.yml`æ–‡ä»¶ä¸­ï¼Œ`${NGINX_VERSION}`ã€`${NGINX_WWW_DIR}`å’Œ`$NGINX_PORT`çš„å€¼å°†è¢«åŒåçš„ç¯å¢ƒå˜é‡æä¾›çš„å€¼æ‰€æ›¿ä»£ã€‚

> *ğŸ’¡*å¦‚æœ`NGINX_VERSION`ç¯å¢ƒå˜é‡ä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`${NGINX_VERSION:-latest}`è¯­æ³•å›é€€åˆ°`latest`å€¼ã€‚è¦äº†è§£æ›´å¤šå…³äºæ­¤ç±»è¯­æ³•çš„ä¿¡æ¯ï¼Œè¯·é˜…è¯»æœ¬ æ–‡æ¡£ã€‚

è¿è¡Œ`$ docker-compose`å‘½ä»¤æ—¶ï¼Œå°†ä» shell ç¯å¢ƒä¸­è·å–è¿™äº›å˜é‡çš„å€¼ã€‚å¦‚æœ shell ç¯å¢ƒä¸­ä¸å­˜åœ¨æŸä¸ªç¯å¢ƒå˜é‡ï¼Œé‚£ä¹ˆ Docker ä¼šåœ¨åˆæˆæ–‡ä»¶çš„ç›®å½•ä¸­æŸ¥æ‰¾è¯¥ç¯å¢ƒå˜é‡åœ¨`.env`æ–‡ä»¶ä¸­çš„å€¼(å¦‚æœå­˜åœ¨ï¼Œåˆ™æŸ¥æ‰¾*)ã€‚*

```
# .env file
NGINX_WWW_DIR=./www
NAME_WITH_QUOTES="John Doe"
```

è¯¥æ–‡ä»¶åŒ…å«åˆæˆæ–‡ä»¶çš„é»˜è®¤ç¯å¢ƒå˜é‡ã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æ–‡æœ¬æ–‡ä»¶ï¼ŒåŒ…å«å¤šå¯¹ç¯å¢ƒå˜é‡ã€‚å› ä¸º shell ä¸å¤„ç†è¿™ä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥åŒå¼•å·æˆ–å•å¼•å·å°†è¢«ç”¨ä½œå€¼çš„ä¸€éƒ¨åˆ†ï¼Œä¾‹å¦‚ä¸Šé¢ç¤ºä¾‹ä¸­çš„`"John Doe"`ã€‚

> *ğŸ’¡*ä½ å¯ä»¥ä½¿ç”¨`--env-file`æ ‡å¿—å’Œ`$ docker-compose`å‘½ä»¤æŒ‡å®šè‡ªå®šä¹‰`.env`æ–‡ä»¶çš„è·¯å¾„(*å¦‚* `*.prod.env*`)ã€‚è¦äº†è§£æ›´å¤š`.env`æ–‡ä»¶æ ¼å¼ï¼Œè¯·é˜…è¯» [**æœ¬**](https://docs.docker.com/compose/env-file/) æ–‡æ¡£ã€‚

`docker-compose.yml`ä¸­çš„ç¯å¢ƒå˜é‡å¯¹äºæœåŠ¡çš„å®¹å™¨ä¸æ˜¯è‡ªåŠ¨å¯ç”¨çš„ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨æƒ³è¦ä¼ é€’åœ¨æ‰§è¡Œ`$ docker-compose`å‘½ä»¤æœŸé—´å‡ºç°çš„ç¯å¢ƒå˜é‡ï¼Œæ‚¨éœ€è¦ä½¿ç”¨æœåŠ¡çš„`[environment](https://docs.docker.com/compose/compose-file/compose-file-v3/#environment)`é…ç½®å°†å®ƒä»¬æ‰‹åŠ¨ä¼ é€’ç»™å®¹å™¨ã€‚

(æ¥æº:[**gist.github.com**](https://gist.github.com/thatisuday/4d16688aa1461a58817a0e85cdf12736))

åœ¨ä¸Šé¢çš„`docker-compose.yml`æ–‡ä»¶ä¸­ï¼Œ`environment`å­—æ®µå‘å®¹å™¨æä¾›ç¯å¢ƒå˜é‡å€¼ã€‚ç”±äº`LOG_DIRECTORY`çš„å€¼æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥ä¸ä¼šæ”¹å˜ã€‚`LOG_PREFIX`çš„å€¼å–è‡ªåˆæˆæ–‡ä»¶å¯ç”¨çš„ç¯å¢ƒå˜é‡ã€‚å¦‚æœæˆ‘ä»¬æ²¡æœ‰ä¸ºç¯å¢ƒå˜é‡æä¾›å€¼ï¼Œæ¯”å¦‚`LOG_LEVEL`ï¼Œé‚£ä¹ˆå®ƒçš„å€¼ä¹Ÿå°†ä»åˆæˆæ–‡ä»¶å¯ç”¨çš„ç¯å¢ƒå˜é‡ä¸­è·å–ã€‚

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨æœåŠ¡é…ç½®çš„`[env_file](https://docs.docker.com/compose/compose-file/compose-file-v3/#env_file)`å­—æ®µæ¥æä¾›æœåŠ¡çº§åˆ«çš„`.env`æ–‡ä»¶ã€‚æ­£å¦‚æ‚¨æ‰€çœ‹åˆ°çš„ï¼Œæœ‰å¤šç§æ–¹æ³•å¯ä»¥ä¸ºæ­£åœ¨è¿è¡Œçš„æœåŠ¡æä¾›ç¯å¢ƒå˜é‡(*å®¹å™¨*)ã€‚å½“åŒä¸€ä¸ªç¯å¢ƒå˜é‡çš„å€¼åœ¨å¤šä¸ªä¸Šä¸‹æ–‡ä¸­å¯ç”¨æ—¶ï¼ŒDocker Compose å†³å®šä½¿ç”¨å“ªä¸ªå€¼ã€‚

```
1\. Value from the compose file (*environment*)
2\. Value from the shell environment (*of container*)
3\. Environment (.env) file (*env_file*)
4\. Dockerfile (*ENV instruction*)
5\. Value is not defined
```

> *ğŸ’¡*è¦äº†è§£ Docker compose ä¸­çš„ç¯å¢ƒå˜é‡ï¼Œè¯·é˜…è¯» [**æœ¬**](https://docs.docker.com/compose/environment-variables/) æ–‡æ¡£ã€‚

å¦‚æœæœåŠ¡çš„æ˜ åƒæ˜¯ä½¿ç”¨`build`å­—æ®µè€Œä¸æ˜¯`image`å­—æ®µåŠ¨æ€æ„å»ºçš„ï¼Œé‚£ä¹ˆé€šè¿‡`environment`å­—æ®µæä¾›çš„ç¯å¢ƒå˜é‡åœ¨æ„å»ºæœŸé—´ä¸å¯ç”¨ã€‚è¿™æ„å‘³ç€å¦‚æœ Dockerfile æ­£åœ¨è¿›è¡Œä¸€äº›å˜é‡æ›¿æ¢ï¼Œå˜é‡å€¼å°†ä¸ºç©ºã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨**æ„å»ºå‚æ•°**ã€‚

## ä½¿ç”¨ç”Ÿæˆå‚æ•°

æ„å»ºå‚æ•°æ˜¯æ„å»ºæ—¶ç¯å¢ƒå˜é‡ã€‚è¿™äº›ä»…åœ¨ä» Dockerfile æ–‡ä»¶æ„å»ºæ˜ åƒæ—¶å¯ç”¨ã€‚æˆ‘ä»¬åœ¨ Dockerfile æ–‡ä»¶ä¸­ä½¿ç”¨`[ARG](https://docs.docker.com/engine/reference/builder/#arg)`æŒ‡ä»¤æŒ‡å®šä¸€ä¸ªæ„å»ºå‚æ•°ã€‚

```
*# Dockerfile*
ARG tag=latest
FROM node:**$tag**ARG working_directory
WORKDIR **$working_directory**
```

è¿™äº›å¯ä»¥ç”¨ docker æ–‡ä»¶ä¸­çš„ç¼ºçœå€¼`ARG=VAL`æ¥å®šä¹‰ï¼Œæˆ–è€…åªç”¨åç§°æ¥å®šä¹‰ã€‚åœ¨æ„å»ºæ˜ åƒæ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨å¸¦æœ‰`$ docker build`å‘½ä»¤çš„`--build-arg <key>=<val>`æ ‡å¿—æ¥è¦†ç›–æˆ–æä¾›è¿™äº›å˜é‡çš„å€¼ã€‚åœ¨`docker-compose.yml`ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨`build`å¯¹è±¡çš„`[args](https://docs.docker.com/compose/compose-file/compose-file-v3/#args)`å­—æ®µæ¥æä¾›è¿™äº›å€¼ã€‚æ‚¨å¯ä»¥ä¸ºæ„å»ºå‚æ•°æä¾›ä¸€ä¸ªå›ºå®šå€¼ï¼Œä¹Ÿå¯ä»¥ä»ç¯å¢ƒå˜é‡ä¸­æ›¿æ¢å®ƒçš„å€¼ã€‚

(æ¥æº:[**gist.github.com**](https://gist.github.com/thatisuday/6973d29dfa2c9e8e181539e1b7ac1a79))

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¸º`tag`æ„å»ºå‚æ•°æä¾›äº†ä¸€ä¸ªå›ºå®šçš„`12.10.0`å€¼ï¼Œç„¶è€Œï¼Œ`working_directory`çš„å€¼å–è‡ª`FRONTEND_WORDIR`ç¯å¢ƒå˜é‡çš„å€¼ã€‚å¦‚æœæˆ‘ä»¬æ²¡æœ‰ä¸ºä¸€ä¸ªæ„å»ºå‚æ•°(æ¯”å¦‚`log_level`)æä¾›ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆå®ƒçš„å€¼ä¹Ÿå°†ä»ç¯å¢ƒå˜é‡ä¸­è·å–ã€‚

> *ğŸ’¡*å¦‚æœè¦†ç›–çš„åˆæˆæ–‡ä»¶åœ¨`environment`æˆ–`args`ä¸­æœ‰ä¸€ä¸ªå˜é‡ï¼Œè¯¥å˜é‡ä¹Ÿå­˜åœ¨äºå®ƒæ‰€è¦†ç›–çš„åˆæˆæ–‡ä»¶ä¸­ï¼Œé‚£ä¹ˆå®ƒçš„å€¼å°†è¢«æ›¿æ¢ï¼Œè€Œä¸æ˜¯å¤åˆ¶ç¯å¢ƒå˜é‡æˆ–æ„å»ºå‚æ•°ã€‚

# è¿è¡Œ Docker æ’°å†™

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»è®¨è®ºäº†åˆæˆæ–‡ä»¶çš„ç»“æ„å’Œè¯­æ³•ã€‚ç°åœ¨æ˜¯æ—¶å€™çœ‹çœ‹ Docker Compose åœ¨ç°å®ç”Ÿæ´»ä¸­æ˜¯å¦‚ä½•å·¥ä½œçš„äº†ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªç”±ä¸‰ä¸ªæœåŠ¡ç»„æˆçš„ç¤ºä¾‹ web åº”ç”¨ç¨‹åºã€‚ä½¿ç”¨ **PHP-Apache** æœåŠ¡å™¨ä¸ºæµè§ˆå™¨ä¸­çš„ web åº”ç”¨ç¨‹åºæä¾›æœåŠ¡çš„`frontend`æœåŠ¡ï¼Œä½¿ç”¨ **ExpressJS** HTTP æœåŠ¡å™¨ä¸º REST API æä¾›æœåŠ¡çš„`backend`æœåŠ¡ï¼Œä»¥åŠä½¿ç”¨ **Redis** æœåŠ¡å™¨ç¼“å­˜ API å“åº”çš„`cache`æœåŠ¡ã€‚

```
**docker-compose-example/**
â”œâ”€â”€ .gitignore
â”œâ”€â”€ backend/
|  â”œâ”€â”€ .dockerignore
|  â”œâ”€â”€ Dockerfile
|  â”œâ”€â”€ package-lock.json
|  â”œâ”€â”€ package.json
|  â””â”€â”€ server.js
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ www/
   â””â”€â”€ index.php
```

> *ğŸ’¡*ä½ å¯ä»¥åœ¨ [**è¿™ä¸ª**](https://github.com/course-one/docker-compose-example) GitHub èµ„æºåº“ä¸­æ‰¾åˆ°æœ¬æ–‡ç”¨åˆ°çš„ä¸Šè¿°æ–‡ä»¶å’Œä¾‹å­ã€‚

`docker-compose.yml`æ–‡ä»¶ä¸ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå®šä¹‰äº†æœåŠ¡ã€‚å› ä¸ºæˆ‘ä»¬ä½¿ç”¨é»˜è®¤æ–‡ä»¶åï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦åœ¨`$ docker-compose`å‘½ä»¤ä¸­ä½¿ç”¨`-f`æ ‡å¿—ã€‚ä¸ºäº†ä½¿äº‹æƒ…çœ‹èµ·æ¥ç®€å•ï¼Œæˆ‘ä»¬æ²¡æœ‰ç”¨å…¶ä»–åˆæˆæ–‡ä»¶è¦†ç›–è¿™ä¸ªæ–‡ä»¶ã€‚

(docker-compose.yml /æ¥æº:[**gist.github.com**](https://gist.github.com/thatisuday/2abf8c5a4a49fcc11c12adfc66b84641))

`www/`ç›®å½•åŒ…å«ç½‘ç«™çš„æ–‡ä»¶ï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸­æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨ã€‚`index.php`æ˜¯ä½¿ç”¨`<ul><li>` HTML æ ‡ç­¾å‘ˆç°è¿™ä¸ªåˆ—è¡¨çš„é¡µé¢ã€‚å¯¹äºè¿™ä¸ªæœåŠ¡ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`[php:8.0.0-apache-buster](https://hub.docker.com/_/php)`æ˜ åƒåˆ›å»ºä¸€ä¸ª`frontend`æœåŠ¡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥å›¾åƒå…¬å¼€ç«¯å£`80`ï¼Œå¹¶æä¾›æ¥è‡ª`/var/www/html`ç›®å½•çš„ web å†…å®¹ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†é¡¹ç›®çš„`./www`ç›®å½•(*ä¸»æœºç›®å½•*)æŒ‚è½½åˆ°å®¹å™¨çš„`/var/www/html`ç›®å½•ä¸­ã€‚

(index.php/æ¥æº:[**gist.github.com**](https://gist.github.com/thatisuday/fbdce0a853d1615459f4a321f64b4313))

`frontend`æœåŠ¡ä¸­çš„`index.php`æ–‡ä»¶é€šè¿‡å‘`/users`ç«¯ç‚¹ä¸Šçš„`backend`æœåŠ¡å‘å‡º GET è¯·æ±‚æ¥è¯·æ±‚`users`ã€‚`backend`æœåŠ¡é€šè¿‡è¿è¡Œåœ¨ Node ä¸Šçš„ Express æœåŠ¡å™¨æä¾› REST APIã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä»`backend/`ç›®å½•æ„å»ºä¸€ä¸ªè‡ªå®šä¹‰æ˜ åƒã€‚è¯¥è‡ªå®šä¹‰å›¾åƒçš„çˆ¶å›¾åƒæ˜¯`[node:15.4.0-alpine3.10](https://hub.docker.com/_/node)`ã€‚

(docker file/source:[**gist.github.com**](https://gist.github.com/thatisuday/6f35f28fa5c4b6c1c7f4d7bd23d3ad5d))

å½“`backend`æœåŠ¡åœ¨`/users`ç«¯ç‚¹ä¸Šæ”¶åˆ° GET è¯·æ±‚æ—¶ï¼Œå®ƒä»`[jsonplaceholder.typicode.com/users](https://jsonplaceholder.typicode.com/users)`å…¬å…± URL è·å–ç”¨æˆ·åˆ—è¡¨ï¼Œå¹¶è¯·æ±‚`cache`æœåŠ¡å­˜å‚¨å®ƒã€‚ä¸‹æ¬¡å®ƒæ”¶åˆ°ç›¸åŒçš„è¯·æ±‚æ—¶ï¼Œå®ƒå°†ä½¿ç”¨ç¼“å­˜ï¼Œè€Œä¸æ˜¯å‘å‡ºå¤–éƒ¨ HTTP è¯·æ±‚ã€‚

`cache`æœåŠ¡ä½¿ç”¨`[redis:6.0.9-alpine](https://hub.docker.com/_/redis)`å›¾åƒä¸ºå…¶æœåŠ¡åˆ›å»ºä¸€ä¸ªå®¹å™¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥å›¾åƒæ˜¾ç¤ºç«¯å£`6379`ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯åŠ¨ HTTP æœåŠ¡å™¨çš„`server.js`è„šæœ¬å¦‚ä¸‹æ‰€ç¤ºã€‚

(server . js/source:[**gist.github.com**](https://gist.github.com/thatisuday/c286d1f52437c53d64639330f2c6f791)

è®©æˆ‘ä»¬çœ‹çœ‹ä¸Šé¢çš„`server.js`æ–‡ä»¶ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨ URL `redis://cache:6379`å¤„è¿æ¥ä¸€ä¸ª Redis æœåŠ¡å™¨(åœ¨èŠ‚ç‚¹ä¸Šä½¿ç”¨ `[*node-redis*](https://github.com/NodeRedis/node-redis)` *å®¢æˆ·ç«¯çš„*)ã€‚å¥½å¥½çœ‹çœ‹ç½‘å€ã€‚é€šå¸¸ï¼ŒRedis è¿æ¥ URL å…·æœ‰`redis://<host>:<port>`æ–¹æ¡ˆï¼Œå…¶ä¸­`host`æ˜¯ Redis æœåŠ¡å™¨çš„ IP åœ°å€æˆ–`domain.name`ï¼Œè€Œ`port`æ˜¯ Redis æœåŠ¡å™¨ç›‘å¬ä¼ å…¥è¯·æ±‚çš„ç«¯å£ã€‚**

åœ¨â€œ[**Docker**](https://medium.com/sysf/a-beginners-guide-to-networking-in-docker-ca5b822fb935)â€è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº† Docker ç½‘ç»œä»¥åŠ Docker å¦‚ä½•ä½¿ç”¨ä¸»æœºåè§£æå…¶ä»–å®¹å™¨çš„ IP åœ°å€ã€‚æˆ‘ä»¬è¿˜ä½¿ç”¨äº†å¸¦æœ‰`$ docker run`çš„`--net-alias=<alias>`æ ‡å¿—æ¥ä¸º IP åœ°å€çš„è§£ææä¾›ä¸€ä¸ªå®šåˆ¶çš„ç½‘ç»œåˆ«åã€‚

å½“ Docker Compose å¯åŠ¨æœåŠ¡æ—¶ï¼Œå®ƒå°†ä½¿ç”¨ç½‘ç»œåˆ«åä¸ºæ¯ä¸ªæœåŠ¡åˆ›å»ºä¸€ä¸ªå®¹å™¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç½‘ç»œåˆ«åå°†ä¸æœåŠ¡åç›¸åŒã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`redis://cache:6379` URL å’Œ`cache`ï¼Œå› ä¸º`host`å°†è¢«è§£æä¸º`cache`æœåŠ¡å®¹å™¨çš„ IP åœ°å€ã€‚

> *ğŸ’¡*åŒæ ·çš„é€»è¾‘ä¹Ÿé€‚ç”¨äº`frontend`æœåŠ¡ä¸­çš„`index.php`æ–‡ä»¶ï¼Œæˆ‘ä»¬ä»è§£æä¸º`http://<backend-container-ip>/users`çš„`[http://backend/users](http://backend/users)`ç«¯ç‚¹æå–æ¥è‡ª`backend`æœåŠ¡çš„ç”¨æˆ·åˆ—è¡¨ã€‚

åœ¨`backend`æœåŠ¡ä¸­ï¼Œæˆ‘ä»¬å·²ç»å°†`[init](https://docs.docker.com/compose/compose-file/compose-file-v3/#init)`å­—æ®µè®¾ç½®ä¸º`true`ã€‚å®ƒå°†ä½¿ç”¨`--init`æ ‡å¿—å¯åŠ¨ä¸€ä¸ªæœåŠ¡å®¹å™¨ã€‚æˆ‘ä»¬å·²ç»åœ¨ [**è¿™èŠ‚**](https://medium.com/sysf/creating-your-first-docker-application-b0ce40ac67d1) è¯¾ä¸­è®¨è®ºäº†è¿™ä¸ªæ ‡å¿—ã€‚å®ƒåº”è¯¥åœ¨è¿è¡Œ Node.js åº”ç”¨ç¨‹åºæ—¶ä½¿ç”¨ã€‚

æˆ‘ä»¬æ¥è®¨è®ºä¸€ä¸‹`depends_on`å­—æ®µã€‚`frontend`æœåŠ¡ä¾èµ–äº`backend`å’Œ`cache`æœåŠ¡ï¼Œè€Œ`backend`æœåŠ¡ä¾èµ–äº`cache`æœåŠ¡ã€‚æœåŠ¡ä¸­çš„`depends_on`å­—æ®µå°†å¸®åŠ© Docker æ„å»ºä¸€ä¸ª**å¯åŠ¨è®¢å•**ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œé¦–å…ˆä¼šå¯åŠ¨`cache`æœåŠ¡ï¼Œç„¶åæ˜¯`backend`æœåŠ¡ï¼Œæœ€åæ˜¯`frontend`æœåŠ¡ã€‚

> *ğŸ’¡*ä¸€ä¸ª**å¯åŠ¨å‘½ä»¤**ä¸æ˜¯å¿…é¡»çš„ï¼Œè€Œæ˜¯ä¸€ä¸ªå¥½çš„å®è·µã€‚ä¾‹å¦‚ï¼Œå¦‚æœ`backend`æœåŠ¡æ²¡æœ‰å¯åŠ¨ï¼Œé‚£ä¹ˆ`frontend`æœåŠ¡å‘`backend`æœåŠ¡å‘å‡ºçš„è¯·æ±‚å°†ä¼šå¤±è´¥ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´`frontend`æœåŠ¡å®¹å™¨å´©æºƒã€‚

ä»ä¸Šé¢çš„`docker-compose.yml`æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬åªå°†ä¸»æœºçš„ç«¯å£`8080`ç»‘å®šåˆ°`frontend`æœåŠ¡çš„ç«¯å£`80`ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å°†èƒ½å¤Ÿä»æµè§ˆå™¨ä¸­çš„`http://localhost:8080` URL è®¿é—®`frontend`æœåŠ¡çš„ Apache web æœåŠ¡å™¨ã€‚

## å¯åŠ¨æœåŠ¡

ä¸ºäº†ä»`docker-compose.yml`æ–‡ä»¶å¯åŠ¨æœåŠ¡ï¼Œæˆ‘ä»¬ä½¿ç”¨`$ docker-compose [up](https://docs.docker.com/compose/reference/up/)`å‘½ä»¤ã€‚è¯¥å‘½ä»¤è¯»å–å½“å‰ç›®å½•ä¸‹`docker-compose.yml`æ–‡ä»¶çš„å†…å®¹ï¼Œå¹¶æŒ‰ç…§æ­£ç¡®çš„å¯åŠ¨é¡ºåºå¯åŠ¨æœåŠ¡ã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨`-f`æ ‡å¿—æ¥æä¾›ä¸€ä¸ªå®šåˆ¶çš„`docker-compose.yml`æ–‡ä»¶åŠå…¶è¦†ç›–ã€‚

è¯¥å‘½ä»¤é¦–å…ˆä» Docker Hub è·å–`redis`å’Œ`php`å›¾åƒï¼Œå¹¶ä¸º`backend`æœåŠ¡æ„å»ºä¸€ä¸ªå®šåˆ¶å›¾åƒã€‚ç„¶åï¼Œå®ƒä¸ºæ¯ä¸ªæœåŠ¡åˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼Œå¹¶å°†ç»ˆç«¯è¿æ¥åˆ°æ¯ä¸ªå®¹å™¨çš„è¿è¡Œè¿›ç¨‹ï¼Œä»¥æ‰“å°æ—¥å¿—è¾“å‡ºã€‚

![](img/64f9283d340972c3d47679ec972a038c.png)

$ docker-æ’°å†™

é»˜è®¤æƒ…å†µä¸‹ï¼ŒDocker Compose åœ¨å‰å°æ¨¡å¼å¯åŠ¨æœåŠ¡ï¼Œå°±åƒ`$ docker run`å‘½ä»¤ä¸€æ ·ã€‚è¦åœ¨åå°å¯åŠ¨æœåŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¸¦æœ‰`$ docker-compose [up](https://docs.docker.com/compose/reference/up/)`å‘½ä»¤çš„`--detach`æˆ–`-d`æ ‡å¿—ã€‚

> *ğŸ’¡*ä½¿ç”¨`$ docker-compose [doptions] up [roptions]`æ—¶ï¼Œ`doptions`æ˜¯`[docker-compose](https://docs.docker.com/compose/reference/overview/)`å‘½ä»¤çš„å‘½ä»¤è¡Œé€‰é¡¹ï¼Œ`roptions`æ˜¯`[up](https://docs.docker.com/compose/reference/up/)`å‘½ä»¤çš„å‘½ä»¤è¡Œé€‰é¡¹ã€‚

æˆ‘ä»¬å¯ä»¥çœ‹åˆ° Docker ä½¿ç”¨`$ docker ps`å‘½ä»¤åˆ›å»ºçš„å®¹å™¨ã€‚æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ° Docker Compose ä½¿ç”¨`$ docker images`å‘½ä»¤æå–æˆ–æ„å»ºçš„å›¾åƒã€‚

![](img/e30dca926685e40c8308af48c2ab3965.png)

$ docker ps / $ docker å›¾åƒ

Docker Compose ä½¿ç”¨**é¡¹ç›®ç›®å½•**åç§°å’ŒæœåŠ¡åç§°æ¥å‘½åå®ƒå·²ç»å¯åŠ¨çš„ Docker å®¹å™¨ã€‚å®ƒä½¿ç”¨ç›¸åŒçš„æ–¹æ¡ˆæ¥å‘½åå¯èƒ½ä¸ºæœåŠ¡æ„å»ºçš„è‡ªå®šä¹‰ Docker æ˜ åƒã€‚

> *ğŸ’¡*é»˜è®¤æƒ…å†µä¸‹ï¼ŒDocker Compose ä½¿ç”¨**é¡¹ç›®ç›®å½•å**ä½œä¸ºé¡¹ç›®åã€‚ä¸ºäº†æä¾›å®šåˆ¶çš„é¡¹ç›®åç§°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨`$ docker-compose`å‘½ä»¤ä¸­ä½¿ç”¨`--project-name`æˆ–`-p`æ ‡å¿—ã€‚æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨`COMPOSE_PROJECT_NAME`ç¯å¢ƒå˜é‡æ¥åšåŒæ ·çš„äº‹æƒ…( [ref](https://docs.docker.com/compose/faq/#how-do-i-run-multiple-copies-of-a-compose-file-on-the-same-host) )ã€‚

è®©æˆ‘ä»¬æ‰“å¼€æµè§ˆå™¨å¹¶è®¿é—®`http://localhost:8080` URL æ¥è®¿é—®`frontend`æœåŠ¡çš„ Apache HTTP æœåŠ¡å™¨ã€‚

![](img/c04300ce09ba1419c72814ec106b2d76.png)

( [http://localhost:8080](http://localhost:8080) )

æœ€åˆï¼Œé¡µé¢ä¸ä¼šå“åº” 5 ç§’é’Ÿï¼Œå› ä¸ºæˆ‘ä»¬åœ¨`server.js`æ–‡ä»¶ä¸­æ·»åŠ äº†ä¸€ä¸ªæœ‰æ„çš„å»¶è¿Ÿ(*æ¥æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ*)ã€‚ä½†æ˜¯åœ¨è¿ç»­çš„é¡µé¢é‡æ–°åŠ è½½ä¸­ï¼Œå®ƒä¼šå¿«é€Ÿå“åº”ï¼Œå› ä¸ºæˆ‘ä»¬ä»`cache`æœåŠ¡ä¸­æä¾›ç”¨æˆ·åˆ—è¡¨ï¼Œè€Œä¸æ˜¯ä»å¤–éƒ¨ API ä¸­è·å–ã€‚

![](img/8b842dc2e4c2e5afd597d18938e1e2aa.png)

$ docker ç½‘ç»œ ls

ä¸`$ docker run`å‘½ä»¤ä¸åŒï¼ŒDocker Compose å¯åŠ¨çš„å®¹å™¨ä¸åŠ å…¥é»˜è®¤çš„`bridge`ç½‘ç»œ( [*more info*](https://medium.com/sysf/a-beginners-guide-to-networking-in-docker-ca5b822fb935) )ã€‚Docker Compose ä¸ºæ¯ä¸ªé¡¹ç›®åˆ›å»ºä¸€ä¸ªæ–°æ¡¥æ¥ç½‘ç»œï¼Œè¯¥é¡¹ç›®çš„æ‰€æœ‰å®¹å™¨éƒ½åŠ å…¥è¿™ä¸ªç½‘ç»œã€‚è¯¥ç½‘ç»œçš„åç§°ä¹Ÿä½¿ç”¨é¡¹ç›®åç§°ã€‚

![](img/33971143dd3baaca47ad433bab989d91.png)

$ docker ç½‘ç»œæ£€æŸ¥

å¦‚æœæˆ‘ä»¬æ£€æŸ¥ id ä¸º`0ac18af6517d`æˆ–åç§°ä¸º`docker-compose-example_default`çš„ç½‘ç»œï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°è¿æ¥åˆ°è¯¥ç½‘ç»œçš„å®¹å™¨ã€‚ä»ä¸Šé¢çš„æ—¥å¿—ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸‰ä¸ªå®¹å™¨åŠ å…¥äº†è¿™ä¸ªç½‘ç»œï¼Œå®ƒä»¬æ˜¯æˆ‘ä»¬çš„æœåŠ¡å®¹å™¨ã€‚ä½ ä¹Ÿå¯ä»¥çœ‹åˆ°ä»–ä»¬çš„ IP åœ°å€ã€‚

![](img/7aced11f58bee7132a4b369641bcc9b8.png)

$ docker å· ls

Docker Compose è¿˜ä¸ºæœåŠ¡å®¹å™¨å®‰è£…å·ã€‚åœ¨æˆ‘ä»¬çš„`docker-compose.yml`æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰ä»»ä½• Docker ç®¡ç†çš„å·( [*æ›´å¤šä¿¡æ¯*](https://medium.com/sysf/docker-container-as-an-executable-to-process-images-using-go-golang-5233f9bd3bf7) )ï¼Œä½†æ˜¯`redis`æ˜ åƒçš„`[Dockerfile](https://github.com/docker-library/redis/blob/7ccc22760cc9b659916678a52654be8f43757551/6.0/alpine/Dockerfile)`æœ‰ä¸€ä¸ª`VOLUME`æŒ‡ä»¤ï¼Œåˆ›å»ºä¸€ä¸ªåŒ¿åå·ã€‚è¿™ä¸ªå·ç”±`redis`æ˜ åƒç”¨äºæŒä¹…å­˜å‚¨å’Œç¼“å­˜çš„å¯é‡ç”¨æ€§ã€‚

## å…³é—­æœåŠ¡

å½“`$ docker-compse up`å‘½ä»¤åœ¨æ²¡æœ‰`-d`æˆ–`--detach`æ ‡å¿—çš„æƒ…å†µä¸‹è¿è¡Œæ—¶ï¼Œå®ƒåœ¨å‰å°è¿è¡Œï¼Œæˆ‘ä»¬çš„ç»ˆç«¯è¢«é˜»å¡ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰å®¹å™¨éƒ½è¿æ¥åˆ°æˆ‘ä»¬çš„ç»ˆç«¯ï¼Œä¸ºäº†æ€æ­»å®ƒä»¬ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸­æ–­ä¿¡å·ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`CTRL+C`æ€æ­»æ‰€æœ‰çš„å®¹å™¨å¹¶åœæ­¢æ‰€æœ‰çš„æœåŠ¡ã€‚

![](img/51caba771063175d5b7711e3c13062e9.png)

$ docker ps

ä»ä¸Šé¢çš„ç»“æœä¸­å¯ä»¥çœ‹å‡ºï¼ŒDocker Compose ä»¥åå‘å¯åŠ¨é¡ºåºåœæ­¢äº†æ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼Œä»è€Œä¼˜é›…åœ°å…³é—­äº†æœåŠ¡ã€‚å¦‚æœæˆ‘ä»¬ç°åœ¨ä½¿ç”¨`$ docker ps`åˆ—å‡ºå®¹å™¨ï¼Œå°†ä¸ä¼šæœ‰ä»»ä½•æ­£åœ¨è¿è¡Œçš„å®¹å™¨(*é™¤éä½ åœ¨è¿™ä¸ªé¡¹ç›®ä¹‹å¤–æœ‰å…¶ä»–æ­£åœ¨è¿è¡Œçš„å®¹å™¨*)ã€‚

å¦‚æœæœåŠ¡æ˜¯ä½¿ç”¨`-d`æˆ–`--detach`æ ‡å¿—åœ¨åå°å¯åŠ¨çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¸èƒ½å†ä½¿ç”¨`CTRL+C`äº†ã€‚è¦åœæ­¢è¿è¡Œå®¹å™¨ï¼Œæˆ‘ä»¬éœ€è¦ä»é¡¹ç›®ç›®å½•è¿è¡Œ`$ docker-compose [down](https://docs.docker.com/compose/reference/down/)`å‘½ä»¤ï¼Œåœ¨é‚£é‡Œå¯ä»¥æ‰¾åˆ°å¯åŠ¨æœåŠ¡çš„`docker-compose.yml`æ–‡ä»¶ã€‚

> *ğŸ’¡*å¦‚æœæ‚¨åœ¨ä½¿ç”¨`up`å­å‘½ä»¤æ—¶ä½¿ç”¨äº†å¸¦æœ‰`$ docker-compose`å‘½ä»¤çš„`-p`æˆ–`--project-name`æ ‡å¿—ï¼Œé‚£ä¹ˆæ‚¨éœ€è¦åœ¨ä½¿ç”¨`down`å­å‘½ä»¤å…³é—­æœåŠ¡æ—¶ä½¿ç”¨ç›¸åŒçš„æ ‡å¿—ã€‚

## é…ç½®`docker-compose up`å‘½ä»¤

å…³é—­æœåŠ¡åï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ä¸ä¸Šä¸€æ¬¡ç›¸åŒçš„é…ç½®å†æ¬¡è¿è¡Œ`$ docker-compose up`å‘½ä»¤ï¼Œé‚£ä¹ˆ Docker Compose å°†å°è¯•åˆ©ç”¨ä¸Šä¸€æ¬¡è¿è¡Œçš„èµ„æºã€‚

é¦–å…ˆï¼Œå¦‚æœ`docker-compose.yml`ä¸­çš„æœåŠ¡é…ç½®æ²¡æœ‰æ”¹å˜ï¼Œé‚£ä¹ˆå®ƒå°†é‡ç”¨å…ˆå‰å¯åŠ¨çš„å®¹å™¨ï¼Œè€Œä¸æ˜¯é‡æ–°åˆ›å»ºå®ƒä»¬ã€‚è¿™å°±åƒå¯¹æœåŠ¡çš„æ¯ä¸ªå®¹å™¨ä½¿ç”¨`$ docker start`å‘½ä»¤ã€‚ä¸ºäº†åœ¨æœåŠ¡çš„é…ç½®æ²¡æœ‰æ”¹å˜çš„æƒ…å†µä¸‹ä¸ºå…¶å¼ºåˆ¶åˆ›å»ºå®¹å™¨ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨å¸¦æœ‰`$ docker-compose up`çš„`[--force-recreate](https://docs.docker.com/compose/reference/up/)`æ ‡å¿—ã€‚

Docker Compose ä¸ä¼šä¸ºæœåŠ¡æ„å»ºæ˜ åƒ(*å¸¦æœ‰* `*build*` *å­—æ®µ*)ï¼Œå¦‚æœå®ƒä»¬çš„æ˜ åƒå·²ç»å­˜åœ¨(*è§* `*$ docker images*` *æ—¥å¿—*)ï¼Œå³ä½¿ä¸Šä¸‹æ–‡ç›®å½•çš„å†…å®¹å·²ç»æ›´æ”¹ã€‚ä¸ºäº†å¼ºåˆ¶æ„å»ºå›¾åƒï¼Œæˆ‘ä»¬ä½¿ç”¨å¸¦æœ‰`$ docker-compose up`çš„`[--build](https://docs.docker.com/compose/reference/up/)`æ ‡å¿—ã€‚

Docker Compose å°†ä»¥å‰çš„å®¹å™¨åˆ›å»ºçš„åŒ¿åå·é‡æ–°ç”¨äºæ–°å®¹å™¨ã€‚è¿™æ ·ï¼Œæ–°çš„`cache`å®¹å™¨å¯ä»¥é‡ç”¨æ—§å®¹å™¨ä¸­çš„ç¼“å­˜ã€‚ä¸ºäº†å¼ºåˆ¶ Docker Compose ä¸ºæ–°å®¹å™¨æ›´æ–°åŒ¿åå·ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†å¸¦æœ‰`$ docker-compose up`çš„`[--renew-anon-volumes](https://docs.docker.com/compose/reference/up/)`æˆ–`[-V](https://docs.docker.com/compose/reference/up/)`æ ‡å¿—ã€‚

```
$ docker-compose up --build --force-recreate -V
```

# å¢å¼º Docker åˆæˆ

Docker Compose è®©æˆ‘ä»¬èƒ½å¤Ÿé…ç½®æ­£åœ¨è¿è¡Œçš„æœåŠ¡åŠå…¶å®¹å™¨çš„å„ä¸ªæ–¹é¢ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæœåŠ¡é…ç½®ç½‘ç»œï¼Œè€Œä¸æ˜¯ä½¿ç”¨é»˜è®¤ç½‘ç»œã€‚è®©æˆ‘ä»¬å¯¹å½“å‰çš„é¡¹ç›®åšä¸€äº›æ”¹è¿›ã€‚

## é…ç½®ç½‘ç»œ

æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡å®¹å™¨å¯ä»¥åŠ å…¥çš„ç½‘ç»œï¼Œè€Œä¸æ˜¯è¦æ±‚ Docker Compose ä¸ºæœåŠ¡å®¹å™¨åˆ›å»ºä¸€ä¸ªé»˜è®¤ç½‘ç»œã€‚ä½¿ç”¨åˆæˆæ–‡ä»¶ä¸­çš„é¡¶çº§`[networks](https://docs.docker.com/compose/compose-file/compose-file-v3/#network-configuration-reference)`å­—æ®µï¼Œæˆ‘ä»¬å®šä¹‰äº†ç½‘ç»œåŠå…¶é…ç½®ã€‚åœ¨æœåŠ¡é…ç½®ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨`[networks](https://docs.docker.com/compose/compose-file/compose-file-v3/#networks)`å­—æ®µæ¥æä¾›å®¹å™¨å°†åŠ å…¥çš„ç½‘ç»œï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

(æ¥æº:gist.github.com)

æœåŠ¡çº§åˆ«`networks`å­—æ®µå¯ä»¥æ˜¯ä¸€ä¸ªç®€å•çš„å­—ç¬¦ä¸²åˆ—è¡¨ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå…·æœ‰å•ä¸ªç½‘ç»œé…ç½®çš„å¯¹è±¡ã€‚åœ¨ä¸Šé¢çš„åˆæˆæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ä¸º`cache`å®¹å™¨æä¾›äº†ä¸€ä¸ªç½‘ç»œåˆ«åã€‚å› æ­¤ï¼Œ`backend`å®¹å™¨ä¹Ÿå¯ä»¥ä½¿ç”¨`redis://redis-server:6379` URL è®¿é—®`cache`å®¹å™¨çš„ Redis æœåŠ¡å™¨ã€‚

æ‚¨å¯ä»¥é…ç½® Docker Compose åˆ›å»ºçš„é»˜è®¤ç½‘ç»œï¼Œè€Œä¸æ˜¯å®šä¹‰æ–°ç½‘ç»œã€‚å¦‚æœä½ ä½¿ç”¨`default`ç½‘ç»œåï¼ŒDocker Compose ä¼šè®¤ä¸ºä½ æ˜¯åœ¨è¦æ±‚é…ç½®å®ƒå·²ç»å¯åŠ¨çš„é‚£ä¸ªã€‚è¿™æ ·ï¼Œæ‚¨å¯ä»¥æ·»åŠ ç½‘ç»œåˆ«åï¼Œè€Œæ— éœ€å®šä¹‰æ–°ç½‘ç»œã€‚

> *ğŸ’¡*æ‚¨è¿˜å¯ä»¥ä½¿ç”¨æœåŠ¡çº§åˆ«å’Œé¡¶çº§`networks`å­—æ®µä¸ºå®¹å™¨æä¾›è‡ªå®šä¹‰ IP åœ°å€ã€‚æ¬²äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯» [**æœ¬**](https://docs.docker.com/compose/compose-file/compose-file-v3/#networks) æ–‡æ¡£ã€‚

ä¸é¡¶çº§`networks`å­—æ®µç±»ä¼¼ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‡å®šä¸€ä¸ªé¡¶çº§`volumes`å­—æ®µæ¥åˆ›å»ºè‡ªå®šä¹‰å·ï¼Œå¹¶ä½¿ç”¨æœåŠ¡çº§åˆ«`volumes`å­—æ®µæ¥é™„åŠ è¿™äº›å·ã€‚æ¬²äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»æœ¬ æ–‡æ¡£ã€‚

## å¤„ç†æ•…éšœ

é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæœåŠ¡å®¹å™¨å› ä¸ºå¤±è´¥è€Œåœæ­¢ï¼Œå®ƒå°†æ°¸è¿œä¸ä¼šå†æ¬¡å¯åŠ¨ã€‚ä¸ºäº†å¯ç”¨æœåŠ¡çš„è‡ªåŠ¨é‡å¯(*å®¹å™¨*)ï¼Œæˆ‘ä»¬éœ€è¦æä¾›ä¸€ä¸ª**é‡å¯ç­–ç•¥**ã€‚æˆ‘ä»¬ä½¿ç”¨å¸¦æœ‰`$ docker run`å‘½ä»¤çš„`--restart`æ ‡å¿—æ¥æä¾›é‡å¯ç­–ç•¥ã€‚ [**è¿™é‡Œçš„**](https://docs.docker.com/config/containers/start-containers-automatically/#use-a-restart-policy) éƒ½æ˜¯é‡å¯ç­–ç•¥ã€‚

(æ¥æº:[**gist.github.com**](https://gist.github.com/thatisuday/b6c9bfc0430e46950782e0f499cd1425))

é»˜è®¤æƒ…å†µä¸‹ï¼Œé‡å¯ç­–ç•¥æ˜¯`no`ã€‚å¦‚æœæä¾›äº†`on-failure`é‡å¯ç­–ç•¥ï¼Œå¦‚æœå®¹å™¨( *PID 1 è¿›ç¨‹åœ¨å…¶ä¸­*)ç”±äºå®¹å™¨ä¸­çš„éé›¶é€€å‡ºä»£ç é”™è¯¯è€Œåœæ­¢ï¼ŒæœåŠ¡å°†é‡å¯ã€‚å¦‚æœæä¾›äº†`always`é‡å¯ç­–ç•¥ï¼Œå®ƒå°†æ€»æ˜¯é‡å¯ï¼Œé™¤éæ‰‹åŠ¨åœæ­¢ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒå°†åœ¨ Docker å®ˆæŠ¤ç¨‹åºé‡å¯æ—¶é‡å¯ã€‚å¦‚æœæä¾›äº†`unless-stopped`é‡å¯ç­–ç•¥ï¼Œå¦‚æœå®¹å™¨æ²¡æœ‰è¢«æ‰‹åŠ¨åœæ­¢ï¼Œå®ƒå°†é‡å¯ã€‚

> *ğŸ’¡*å¦‚æœä½¿ç”¨`$ docker [stop](https://docs.docker.com/engine/reference/commandline/stop/)`æˆ–`$ docker [kill](https://docs.docker.com/engine/reference/commandline/kill/)`å‘½ä»¤åœæ­¢æ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼Œåˆ™è¢«è§†ä¸ºæ‰‹åŠ¨åœæ­¢ã€‚

åœ¨`docker-compose.yml`æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æœåŠ¡çº§åˆ«`[restart](https://docs.docker.com/compose/compose-file/compose-file-v3/#restart)`å­—æ®µæä¾›é‡å¯ç­–ç•¥ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªé‡å¯ç­–ç•¥ã€‚

(docker-compse.yml /æ¥æº:[**gist.github.com**](https://gist.github.com/thatisuday/f5eb8cd277a40166fb3b3ea4f61e8755))

åœ¨ä¸Šé¢çš„åˆæˆæ–‡ä»¶ä¸­ï¼Œ`backend`æœåŠ¡æœ‰ä¸€ä¸ªé‡å¯ç­–ç•¥`always`ã€‚è¿™æ„å‘³ç€å¦‚æœæ²¡æœ‰æ‰‹åŠ¨åœæ­¢ï¼Œ`backend`æœåŠ¡(*å®¹å™¨*)å°†ä¸€ç›´å¯åŠ¨ã€‚ç”±äºæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨`$ docker [stop](https://docs.docker.com/engine/reference/commandline/stop/)`å’Œ`$ docker [kill](https://docs.docker.com/engine/reference/commandline/kill/)`å‘½ä»¤æ¥æŸ¥çœ‹å®ƒæ˜¯å¦é‡å¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»è¿›å…¥æ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼Œè‡ªå·±æ€æ­»æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹( *PID 1* )ã€‚

![](img/39bb3b10692ccaa20de9114b3a4c2609.png)

$ docker ps

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œä½¿ç”¨`$ docker [exec](https://docs.docker.com/engine/reference/commandline/exec/)`å‘½ä»¤ï¼Œæˆ‘ä»¬åœ¨è¿è¡Œçš„`backend`å®¹å™¨ä¸­æ‰§è¡Œäº†`[kill](https://man7.org/linux/man-pages/man1/kill.1.html) 1` shell å‘½ä»¤ã€‚Docker ä¼šå°†æ­¤è§†ä¸ºå¤±è´¥ï¼Œå¹¶å†æ¬¡é‡å¯å®¹å™¨ã€‚æ‚¨å¯ä»¥ä»ç°åœ¨æ˜¾ç¤ºä¸º`Up 4 seconds`çš„`STATUS`æ ä¸­éªŒè¯è¿™ä¸€ç‚¹ã€‚

> *ğŸ’¡æ‚¨è¿˜åº”è¯¥è€ƒè™‘ä¸ºå®¹å™¨æ·»åŠ ä¸€ä¸ª`[healthcheck](https://docs.docker.com/compose/compose-file/compose-file-v3/#healthcheck)`é…ç½®ï¼Œç”¨äºæœåŠ¡çš„å®šæœŸå¥åº·æ£€æŸ¥ã€‚*

## å®Œç¾çš„å¯åŠ¨é¡ºåº

é€šè¿‡åœ¨æœåŠ¡é…ç½®ä¸­æ·»åŠ `depends_on`å­—æ®µï¼Œæˆ‘ä»¬å®šä¹‰äº†æœåŠ¡çš„å¯åŠ¨å’Œå…³é—­é¡ºåºã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿é¦–å…ˆå¯åŠ¨çˆ¶æœåŠ¡ã€‚ç„¶è€Œï¼Œæœ‰ä¸€ä¸ªè­¦å‘Šã€‚

å½“å¯åŠ¨ä¸€ä¸ªå®¹å™¨æ—¶ï¼ŒDocker Compose åªç­‰åˆ°å®¹å™¨æ­£åœ¨è¿è¡Œå¹¶ä¸”åº”ç”¨ç¨‹åºè¿›ç¨‹å·²ç»å¯åŠ¨ã€‚å®ƒä¸ä¼šç­‰åˆ°æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå‡†å¤‡å°±ç»ªã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬çš„`server.js`ä¸­æœ‰ä¸€ä¸ª`setTimeout(start_server, 5000)`ï¼Œé‚£ä¹ˆ Docker Compose å°±ä¸ä¼šç­‰å¾…ï¼Œä¹‹åä½¿ç”¨`backend`æœåŠ¡( *HTTP æœåŠ¡å™¨*)å°±å®‰å…¨äº†ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¯åŠ¨åº”ç”¨ç¨‹åºçš„å‘½ä»¤ä¸Šä½¿ç”¨ä¸€ä¸ªåŒ…è£…å™¨è„šæœ¬ã€‚è¦äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·éµå¾ª [**æœ¬**](https://docs.docker.com/compose/startup-order/) æ–‡æ¡£ã€‚

## èµ„æº

1.  Docker åˆæˆæ–‡ä»¶æä¾›äº†è®¸å¤šå…¶ä»–é€‰é¡¹ï¼Œä¸æˆ‘ä»¬åœ¨æœ¬è¯¾ä¸­æ¢ç´¢çš„é€‰é¡¹ä¸åŒã€‚ä½ å¯ä»¥ä»è¿™ä¸ª[(*v3*)çš„ Compose æ–‡ä»¶ä¸­æ¢ç´¢å…¶ä»–å¯ç”¨çš„é€‰é¡¹ã€‚](https://docs.docker.com/compose/compose-file/compose-file-v3/#healthcheck)
2.  è¦è·å¾— Docker Compose çš„æ¦‚è¿°ï¼Œè¯·éµå¾ªæœ¬ æ–‡æ¡£çš„ [**ã€‚**](https://docs.docker.com/compose/)
3.  Docker Compose CLI æä¾›äº†å…¶ä»–å‘½ä»¤ï¼Œå¦‚ä»åˆæˆæ–‡ä»¶å¯åŠ¨å•ä¸ªæœåŠ¡çš„`$ docker-compose [run](https://docs.docker.com/compose/reference/run/)`ï¼Œä»åˆæˆæ–‡ä»¶åˆ—å‡ºæ­£åœ¨è¿è¡Œçš„å®¹å™¨çš„`$ docker-compose [ps](https://docs.docker.com/compose/reference/ps/)`ï¼Œä»¥åŠè®¸å¤šå…¶ä»–é‡è¦å‘½ä»¤ã€‚è¦äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·éµå¾ª [**æœ¬**](https://docs.docker.com/compose/reference/overview/) æ–‡æ¡£ã€‚
4.  ä¸ºäº†åœ¨ VSCode ä¸­è·å¾—æ›´å¥½çš„å¼€å‘ä½“éªŒï¼Œå¯ä»¥è€ƒè™‘å®‰è£… [**Docker æ‰©å±•**](https://github.com/microsoft/vscode-docker) å’Œ [**YAML æ‰©å±•**](https://github.com/redhat-developer/vscode-yaml) ã€‚

![](img/e3da3bf1cee07cd997d46904bbbf70b4.png)

([**thatisuday.com**](http://thatisuday.com)/[/**GitHub**](https://github.com/thatisuday)/[/**Twitter**/](https://twitter.com/thatisuday)[/**stack overflow**](https://stackoverflow.com/users/2790983/uday-hiwarale)**/[**insta gram**](https://www.instagram.com/thatisuday/))**

**![](img/fdebb498630e863a0129025be5b74fb3.png)**