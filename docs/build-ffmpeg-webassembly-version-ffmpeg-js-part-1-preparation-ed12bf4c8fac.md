# æ„å»º FFmpeg WebAssembly ç‰ˆæœ¬(= ffmpeg.wasm):ç¬¬ 1 éƒ¨åˆ†å‡†å¤‡

> åŸæ–‡ï¼š<https://itnext.io/build-ffmpeg-webassembly-version-ffmpeg-js-part-1-preparation-ed12bf4c8fac?source=collection_archive---------4----------------------->

![](img/8c0c378d4f8e771bf56ebf20e4685f63.png)

> 2020 å¹´ 8 æœˆæ›´æ–°:ä¿®æ”¹æ•…äº‹ï¼Œä½¿å…¶åœ¨ MacOS ä¸­å·¥ä½œã€‚

åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæ‚¨å°†å­¦ä¹ :

1.  è¿™ä¸ªç³»åˆ—çš„èƒŒæ™¯
2.  å¦‚ä½•ç”¨ docker(ä»¥åŠåœ¨ MacOS ä¸­ä¸ç”¨ Docker)æ„å»ºåŸç”Ÿ FFmpeg

# è¿™ä¸ªç³»åˆ—çš„èƒŒæ™¯

è¿™ä¸€ç³»åˆ—æ•…äº‹æ—¨åœ¨è¾¾åˆ°ä»¥ä¸‹ç›®çš„:

1.  å¯¹äºæƒ³å­¦ä¹ å¦‚ä½•ä½¿ç”¨ Emscripten å°† C/C++åº“ç¼–è¯‘æˆ JavaScript çš„äººæ¥è¯´ï¼Œè¿™æ˜¯ä¸€æœ¬æŒ‡å—(å¸Œæœ›æ˜¯ç›®å‰ä¸ºæ­¢æœ€æœ‰ç”¨å’Œè¯¦ç»†çš„)
2.  ä¸ªäººç¬”è®°

# ä¸ºä»€ä¹ˆæ˜¯ FFmpegï¼Ÿ

FFmpeg æ˜¯ä¸€ä¸ªå…è´¹çš„å¼€æºé¡¹ç›®ï¼Œç”±ä¸€ä¸ªåºå¤§çš„è½¯ä»¶å¥—ä»¶åº“å’Œç¨‹åºç»„æˆï¼Œç”¨äºå¤„ç†è§†é¢‘ã€éŸ³é¢‘å’Œå…¶ä»–å¤šåª’ä½“æ–‡ä»¶å’Œæµã€‚(æ¥è‡ªç»´åŸºç™¾ç§‘)

è¿™æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„åº“ï¼Œæ²¡æœ‰ä¸€ä¸ª JavaScript åº“å…·æœ‰å®Œå…¨ç›¸åŒçš„åŠŸèƒ½ã€‚å¦‚æœä½ åœ¨è°·æ­Œä¸Šæœç´¢â€œffmpeg.js â€,ä½ ä¼šå‘ç°å¾ˆå°‘æœ‰ç°å­˜çš„åº“å’Œæˆ‘ä»¬å°†è¦æ„å»ºçš„å®Œå…¨ä¸€æ ·:

*   ffmpeg . js:[https://github.com/Kagami/ffmpeg.js](https://github.com/Kagami/ffmpeg.js/)
*   https://github.com/bgrins/videoconverter.js

åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™äº›åº“éƒ½å¾ˆæ£’ï¼Œéšæ—¶å¯ç”¨ï¼Œä½†æ˜¯å®ƒä»¬å­˜åœ¨ä»¥ä¸‹é—®é¢˜:

1.  FFmpeg å’Œ Emscripten çš„ç‰ˆæœ¬éƒ½å·²è¿‡æ—¶ã€‚
2.  å¤šå¹´æœªè¿›è¡Œæœ‰æ•ˆç»´æŠ¤ã€‚*(Kagami/ffmpeg . js 2020 å¹´ 4 æœˆç»§ç»­å¼€å‘)*

æˆ‘æ›¾è€ƒè™‘æ¥ç®¡å…¶ä¸­ä¸€ä¸ªåº“ï¼Œä½†ç”±äºè¿™äº›å¹´æ¥å‘ç”Ÿäº†å¤ªå¤šçš„å˜åŒ–ï¼Œæˆ‘å†³å®šä»å¤´å¼€å§‹ï¼ŒåŒæ—¶ç¼–å†™äº†è¿™ä¸€ç³»åˆ—æ•™ç¨‹æ¥å¸®åŠ©äººä»¬å­¦ä¹ å¦‚ä½•åœ¨çœŸå®çš„ C/C++åº“ä¸­ä½¿ç”¨ Emscriptenã€‚

# å¦‚ä½•ç”¨ Docker æ„å»ºåŸç”Ÿ FFmpeg

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä»å®ƒçš„å­˜å‚¨åº“ä¸­å…‹éš† FFmpeg æºä»£ç ï¼Œå› ä¸º`master`åˆ†æ”¯æ­£åœ¨å¼€å‘ä¸­ï¼Œæˆ‘ä»¬æœ€å¥½é€‰æ‹©ä¸€ä¸ªç‰¹å®šçš„ç‰ˆæœ¬æ¥ç¼–è¯‘ã€‚

åœ¨æˆ‘å†™è¿™ä¸ªæ•…äº‹çš„æ—¶å€™ï¼ŒFFmpeg çš„æœ€æ–°ç¨³å®šç‰ˆæœ¬æ˜¯ n4.3.1ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†åœ¨æ•´ä¸ªæ•…äº‹ä¸­ä½¿ç”¨è¿™ä¸ªç‰ˆæœ¬ã€‚

åœ¨å®Œæˆäº†å­˜å‚¨åº“çš„å…‹éš†ä¹‹åï¼Œæ˜¯æ—¶å€™ç”¨ GCC æ„å»ºä»¥ç¡®ä¿å®ƒèƒ½å¤Ÿå·¥ä½œäº†ã€‚

å®é™…ä¸Šï¼Œå¦‚æœä½ å¾ˆæ€¥çš„è¯ï¼Œå¯ä»¥è·³è¿‡è¿™ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯æ ¹æ®æˆ‘è‡ªå·±çš„ç»éªŒï¼Œæœ€å¥½æ˜¯å…ˆç†Ÿæ‚‰ä¸€ä¸‹åº“çš„æ„å»ºç³»ç»Ÿã€‚

æ„å»ºå’Œå®‰è£… FFmpeg çš„æŒ‡ä»¤å¯ä»¥åœ¨èµ„æºåº“çš„æ ¹ç›®å½•ä¸‹çš„ [**INSTALL.md**](https://github.com/FFmpeg/FFmpeg/blob/n4.3.1/INSTALL.md) ä¸­æ‰¾åˆ°:

```
Installing FFmpeg:1\. Type `./configure` to create the configuration. A list of configure options is printed by running `configure -help`.`configure` can be launched from a directory different from the FFmpeg sources to build the objects out of tree. To do this, use an absolute path when launching `configure`, e.g. `/ffmpegdir/ffmpeg/configure`.2\. Then type `make` to build FFmpeg. GNU Make 3.81 or later is required.3\. Type `make install` to install all binaries and libraries you built.NOTICE
 - - -- Non system dependencies (e.g. libx264, libvpx) are disabled by default.
```

å› ä¸ºæˆ‘ä»¬ä¸éœ€è¦å®é™…å®‰è£… FFmpegï¼Œæ‰€ä»¥åªéœ€è¦ç¬¬ 1 æ­¥å’Œç¬¬ 2 æ­¥ã€‚

æœ‰ä¸¤ç§æ„å»ºæ–¹å¼ï¼Œä¸€ç§æ˜¯åŸç”Ÿæ–¹å¼ï¼Œéœ€è¦ä½ å®‰è£…è½¯ä»¶åŒ…(ä¾‹å¦‚ emsdkï¼ŒNode.js)ã€‚å¤§å¤šæ•°æ—¶å€™å®ƒæ˜¯æœ‰æ•ˆçš„ï¼Œä½†æ˜¯æœ‰æ—¶ä½ å¯èƒ½ä¼šé¢ä¸´ç”±äºè½¯ä»¶åŒ…ç‰ˆæœ¬å’Œæ“ä½œç³»ç»Ÿçš„å˜åŒ–è€Œéš¾ä»¥è§£å†³çš„é”™è¯¯ã€‚å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ [Docker](https://www.docker.com/) ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªç¨³å®šå’Œé™æ€çš„æ„å»ºç¯å¢ƒã€‚å¼ºçƒˆæ¨èä½¿ç”¨ Dockerï¼Œå› ä¸ºå®ƒå¯ä»¥èŠ‚çœæ‚¨å®‰è£…(å’Œåˆ é™¤)è½¯ä»¶åŒ…çš„æ—¶é—´ã€‚

æˆ‘ä¸ä¼šåœ¨è¿™é‡Œä»‹ç»å¦‚ä½•å®‰è£…åŒ…ï¼Œä½†æ˜¯æˆ‘æŠŠè„šæœ¬åˆ†æˆäº†`build.sh`å’Œ`build-with-docker.sh`ï¼Œä½ å¯ä»¥è‡ªå·±å®‰è£…æ‰€æœ‰çš„åŒ…å¹¶è¿è¡Œ`build.sh`ã€‚

> ä¸ºäº†ç¡®ä¿æœ¬æ•™ç¨‹èƒ½å¤Ÿæœ€å¤§é™åº¦åœ°è¦†ç›–ç¯å¢ƒï¼Œæˆ‘ä½¿ç”¨ Github åŠ¨ä½œæ¥æµ‹è¯•å®ƒæ˜¯å¦èƒ½åœ¨ Linux å’Œ MacOS ä¸Šå·¥ä½œã€‚å¯¹äº Linux ç”¨æˆ·ï¼Œæˆ‘ä¼šä½¿ç”¨ Docker way / `build-with-docker.sh`æ¥æ„å»ºã€‚å¯¹äº MacOS ç”¨æˆ·ï¼Œç”±äº Github Actions ä¸æ”¯æŒ Dockerï¼Œæ‰€ä»¥æˆ‘ä¼šä½¿ç”¨ native way / `build.sh`æ¥æ„å»ºã€‚

ç°åœ¨ï¼Œè®©æˆ‘ä»¬ç”¨ä¸‹é¢çš„å†…å®¹åˆ›å»ºä¸€ä¸ªåä¸º`build.sh`çš„æ–‡ä»¶ã€‚

è¦ä»¥æœ¬æœºæ–¹å¼æ„å»ºï¼Œåªéœ€è¿è¡Œå‘½ä»¤:

```
$ bash build.sh
```

è¦ä½¿ç”¨ Docker æ„å»ºï¼Œåˆ›å»ºä¸€ä¸ªåä¸º`build-with-docker.sh`çš„æ–‡ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹:

å’Œè¿è¡Œå‘½ä»¤:

```
$ bash build-with-docker.sh
```

> `--disable-x86asm`æ˜¯ç¦ç”¨ x86 æ±‡ç¼–ç‰¹æ€§æ‰€å¿…éœ€çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¸æ‰“ç®—ä½¿ç”¨å®ƒã€‚
> 
> æ ¹æ®ä½ çš„ç½‘é€Ÿå’Œç”µè„‘çš„ç¡¬ä»¶è§„æ ¼ï¼Œå®Œæˆç¼–è¯‘å¯èƒ½éœ€è¦ 10~30 åˆ†é’Ÿã€‚
> 
> å½“ gcc 9 å¼•å…¥æ›´å¤šçš„çº¦æŸæ—¶ï¼Œä½ åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­çœ‹åˆ°å¤§é‡çš„è­¦å‘Šæ˜¯æ­£å¸¸çš„ã€‚

ç¼–è¯‘åŸç”Ÿ FFmpeg åº”è¯¥éœ€è¦ä¸€äº›æ—¶é—´ã€‚å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œæ‚¨åº”è¯¥å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡Œ`ffmpeg`:

```
$ ./ffmpeg
```

æ‚¨åº”è¯¥ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„å†…å®¹:

> ffmpeg ç‰ˆæœ¬ n4.3.1 ç‰ˆæƒæ‰€æœ‰ 2000â€“2019 FFmpeg å¼€å‘è€…
> ç”¨ gcc 8 (GCC)
> æ„å»ºçš„é…ç½®:â€”disable-x86 ASM
> libavutil 56ã€‚22.100 / 56.22.100
> libavcodec 58ã€‚35.100 / 58.35.100
> libavformat 58ã€‚20.100 / 58.20.100
> libavdevice 58ã€‚5.100 / 58.5.100
> libavfilter 7ã€‚40.101 / 7.40.101
> libswscale 5ã€‚3.100 / 5.3.100
> libswresample 3ã€‚3.100 / 3.3.100
> è¶…å¿«é€ŸéŸ³è§†é¢‘ç¼–ç å™¨
> ç”¨æ³•:ffmpeg[options][[infile options]-I infile]â€¦{[outfile options]outfile }â€¦
> 
> ä½¿ç”¨-h è·å¾—å®Œæ•´çš„å¸®åŠ©ï¼Œæˆ–è€…æ›´å¥½çš„æ˜¯ï¼Œè¿è¡Œ' man ffmpeg '

ä½ å¯ä»¥è®¿é—®è¿™é‡Œçš„çŸ¥è¯†åº“ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•è¯¦ç»†å·¥ä½œçš„:[https://github.com/ffmpegwasm/FFmpeg/tree/n4.3.1-p1](https://github.com/ffmpegwasm/FFmpeg/tree/n4.3.1-p1)

å¹¶ä¸”å¯ä»¥åœ¨è¿™é‡Œéšæ„ä¸‹è½½å»ºé€ ç¥å™¨:[https://github.com/ffmpegwasm/FFmpeg/releases/tag/n4.3.1-p1](https://github.com/ffmpegwasm/FFmpeg/releases/tag/n4.3.1-p1)

ç°åœ¨æˆ‘ä»¬å·²ç»å®Œæˆäº†å‡†å¤‡ï¼Œä¸‹é¢æˆ‘ä»¬ç»§ç»­è¿›å…¥[æ„å»º FFmpeg WebAssembly ç‰ˆæœ¬(= ffmpeg.wasm): Part.2 ç”¨ Emscripten ç¼–è¯‘](https://medium.com/@jeromewus/build-ffmpeg-webassembly-version-ffmpeg-js-part-2-compile-with-emscripten-4c581e8c9a16)å¼€å§‹ç”¨ Emscripten ç¼–è¯‘ FFmpegã€‚ğŸ˜ƒ