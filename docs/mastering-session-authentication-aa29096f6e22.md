# æŒæ¡ä¼šè¯è®¤è¯

> åŸæ–‡ï¼š<https://itnext.io/mastering-session-authentication-aa29096f6e22?source=collection_archive---------0----------------------->

## å…³äºå¦‚ä½•ä½¿ç”¨ MongoDBã€Expressã€React å’Œ Node æ„å»ºåŸºäºä¼šè¯çš„èº«ä»½éªŒè¯åº”ç”¨ç¨‹åºçš„å®Œæ•´æ¼”ç»ƒ

![](img/21c093cc03a807a69f908aa30ee0fc39.png)

åŸå§‹ç…§ç‰‡ç”±[å¡ç¼ªå°”Â·æ³½å‹’](https://unsplash.com/@samuelzeller)æ‹æ‘„

ä»Šå¤©ï¼Œæˆ‘ä»¬å¼€å§‹äº†æ„å»º MERN å †æ ˆè®¤è¯åº”ç”¨çš„æ—…ç¨‹ï¼Œè¯¥åº”ç”¨å°†æä¾›:è¾“å…¥éªŒè¯ã€é”™è¯¯å¤„ç†ã€ä¼šè¯è®¤è¯ã€å—ä¿æŠ¤çš„å‰ç«¯è·¯ç”±å’ŒæŒä¹…ç™»å½•â€”â€”å³ä½¿æœåŠ¡å™¨é‡å¯æˆ–ç”¨æˆ·åˆ·æ–°é¡µé¢ã€‚

è¿™æ˜¯ä¸€ä¸ª*ä¸€æ­¥ä¸€æ­¥çš„æŒ‡å—/æ•™ç¨‹*ï¼Œå› ä¸ºæˆ‘ä¼šå°½å¯èƒ½è¯¦ç»†åœ°ä»‹ç»ï¼ŒåŒæ—¶åœ¨éœ€è¦æ—¶æä¾›æ–‡æ¡£é“¾æ¥ã€‚
åœ¨æˆ‘ä»¬å¼€å§‹ä¹‹å‰ï¼Œè¿™é‡Œæœ‰ä¸€ä»½æˆ‘ä»¬å°†ä½¿ç”¨çš„æŠ€æœ¯æ¸…å•:
**MongoDB Atlasã€Mongooseã€Joiã€BCryptã€ESMã€Expressã€Express-Sessionã€Reactã€Reduxã€Node.jsã€Postmanã€** heavy **ES6+** ç”¨æ³•

å°±æ˜¯è¿™æ ·ï¼è¿™å‡ ä¹æ˜¯æˆ‘ä»¬æ•´ä¸ªé¡¹ç›®æ‰€éœ€è¦çš„ä¸€åˆ‡ã€‚
**æˆ‘ä»¬å°†ä¸ä½¿ç”¨ Passport.js æˆ– JWTs** ã€‚
æœ€åï¼Œæˆ‘å–œæ¬¢é€ å‹ï¼Œä½†æˆ‘ä»¬çš„ç”¨æˆ·ç•Œé¢å°†ä¼šéå¸¸ç®€å•&æ— é£æ ¼ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œå¹¶ä¸”è¿™ä¸ªé¡¹ç›®å¯ä»¥ä½œä¸ºæœªæ¥é¡¹ç›®çš„æ¡†æ¶ã€‚

å¥½äº†ï¼Œäº‹ä¸å®œè¿Ÿï¼Œæˆ‘ä»¬å¼€å§‹å§ï¼

# æ­¥éª¤ 1: Node.js è®¾ç½®

è®©æˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ªé¡¹ç›®ç›®å½•å¹¶åˆå§‹åŒ–æˆ‘ä»¬çš„èŠ‚ç‚¹åº”ç”¨ç¨‹åºã€‚å¦‚æœä½ è¿˜æ²¡æœ‰å®‰è£… Node.jsï¼Œå»[ä»–ä»¬çš„ç½‘ç«™](https://nodejs.org/en/)æŒ‰ç…§ä¸‹è½½è¯´æ˜æ“ä½œã€‚

ä¸€æ—¦ä½ è¿™æ ·åšäº†ï¼Œåœ¨ä½ çš„ç»ˆç«¯ä¸­è¿è¡Œè¿™ä¸‰ä¸ªå‘½ä»¤:
`mkdir SessionAuth && cd SessionAuth`
`mkdir backend && cd backend`
`npm init esm -y`ã€‚esm å°†å…è®¸æˆ‘ä»¬åœ¨åç«¯ä½¿ç”¨å¿ƒçˆ±çš„å¯¼å…¥/å¯¼å‡ºè¯­æ³•ã€‚
**-y** ç®€å•è·³è¿‡å¡«å†™å§“åã€æè¿°ã€ä½œè€…ç­‰çš„é—®é¢˜ã€‚(å¦‚æœæ‚¨æ„¿æ„ï¼Œæ‚¨å¯ä»¥æ›´æ–°è¿™äº›å†…å®¹)
**NPM init ESM-y**å‘½ä»¤ä¸ºæˆ‘ä»¬åˆ›å»ºäº†ä¸€äº›ä¸œè¥¿ï¼Œä½†æ˜¯ä¸‹ä¸€æ­¥æ˜¯è®¾ç½®æˆ‘ä»¬çš„é¡¹ç›®ç›®å½•ç»“æ„ã€‚è¿™é‡Œæˆ‘å°†ä½¿ç”¨ä¸€ä¸ªéå¸¸ç®€å•çš„æ–¹æ³•:

```
SessionAuth/
   **|â€” backend/**
      |â€” node_modules/
      **|â€” .gitignore**
      |â€” package-lock.json
      |â€” package.json
      **|â€” src/**
         **|â€” models/
         |â€” routes/
         |â€” util/
         |â€” validations/**
         |â€” index.js
         |â€” **server.js** <= renamed *main.js* to *server.js*
```

****** `**All boldened lines in the code snippets represent new code.**` **
æˆ‘å°† **main.js** é‡å‘½åä¸º **server.js** ï¼Œå› ä¸ºè¿™å°†åŒ…å«æ‰€æœ‰ä¸æœåŠ¡å™¨ç›¸å…³çš„é€»è¾‘ã€‚è®©æˆ‘ä»¬å¿«é€Ÿæ›´æ–°æˆ‘ä»¬çš„ **index.js** å¯¼å…¥:

```
*--- backend/src/index.js ---*
require = require("esm")(module/*, options*/)
module.exports = require("**./server.js**")
```

**ã€‚gitignore** æ–‡ä»¶æ˜¯å¯é€‰çš„ï¼Œä½†æ˜¯å¦‚æœä½ æ­£åœ¨ä½¿ç”¨ gitï¼Œæˆ‘*å¼ºçƒˆ*å»ºè®®ç°åœ¨åˆ›å»ºä¸€ä¸ªå¹¶æ·»åŠ è¿™ä¸¤è¡Œ:

```
*--- backend/.gitignore ---***/node_modules
config.js**
```

**node_modules** æ–‡ä»¶å¤¹ä¸éœ€è¦ç­¾å…¥ç‰ˆæœ¬æ§åˆ¶ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰åˆ›å»º **config.js** æ–‡ä»¶ï¼Œä½†æ˜¯ç°åœ¨æœ€å¥½å¿½ç•¥å®ƒã€‚
åœ¨ä½ çš„æ–‡ä»¶ç»“æ„çœ‹èµ·æ¥åƒä¸Šé¢è¿™æ ·ä¹‹åï¼Œè®©æˆ‘ä»¬åœ¨æˆ‘ä»¬çš„ç»ˆç«¯ä¸­ç¡®ä¿æˆ‘ä»¬åœ¨**åç«¯**ç›®å½•ä¸­ã€‚å¦‚æœæ²¡æœ‰ï¼Œ`cd backend/`ã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥å®‰è£…åç«¯ä¾èµ–é¡¹äº†ã€‚ä¸‹é¢æ˜¯ç»ˆç«¯å‘½ä»¤:
`npm i bcryptjs connect-mongo crypto-js express express-session joi mongoose` æˆ‘ä¼šåœ¨æˆ‘ä»¬ä½¿ç”¨å®ƒä»¬çš„æ—¶å€™è§£é‡Šæ¯ä¸€ä¸ªåŒ…ï¼Œæ‰€ä»¥ç°åœ¨è¯·è€å¿ƒç­‰å¾…ã€‚æˆ‘ä»¬è¿˜æƒ³å®‰è£…ä¸€ä¸ªåä¸º **nodemon** (èŠ‚ç‚¹ç›‘è§†å™¨)çš„å¼€å‘ä¾èµ–é¡¹ã€‚è¿™å°†ä½¿æˆ‘ä»¬åœ¨ä¿®æ”¹æ—¶ä¸å¿…é‡å¯æœåŠ¡å™¨:`npm i -D nodemon` ç°åœ¨è®©æˆ‘ä»¬æ•´ç†ä¸€ä¸‹æˆ‘ä»¬çš„**åŒ…**

```
*--- backend/package.json ---* {
  "name": "backend",
  "version": "1.0.0",
  "description": "",
  "main": "**./src/index.js**",
  "module": "**./src/server.js**",
  "scripts": {
 **"start": "node index.js",
    "dev": "nodemon index.js"**
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "bcryptjs": "^2.4.3",
    "connect-mongo": "^2.0.3",
    "crypto-js": "^3.1.9-1",
    "esm": "^3.2.20",
    "express": "^4.16.4",
    "express-session": "^1.15.6",
    "joi": "^14.3.1",
    "mongoose": "^5.4.19"
  },
  "devDependencies": {
    "nodemon": "^1.18.10"
  }
}
```

æˆ‘ä»¬æ›´æ–°æˆ‘ä»¬çš„â€œmainâ€å’Œâ€œmodule â€,ä»¥æŸ¥çœ‹æˆ‘ä»¬åˆ›å»ºçš„ **src/** æ–‡ä»¶å¤¹ã€‚
æˆ‘ä»¬å»æ‰äº†â€œ**æµ‹è¯•**â€è„šæœ¬ï¼Œæ·»åŠ äº†â€œ**å¯åŠ¨**â€å’Œâ€œ**å¼€å‘**â€è„šæœ¬ã€‚åœ¨æœ¬æ¼”ç»ƒä¸­ï¼Œæˆ‘ä»¬å°†ä¸»è¦ä½¿ç”¨ dev è„šæœ¬ã€‚è®°ä¸‹æ‰€æœ‰çš„ä¾èµ–é¡¹å’Œæˆ‘ä»¬çš„ devDependenciesï¼Œå¹¶ä»”ç»†æ£€æŸ¥ä½ çš„æ–‡ä»¶çœ‹èµ·æ¥æ˜¯å¦ç›¸åŒï¼Œä½†æ˜¯ä¸è¦æ‹…å¿ƒä½ çš„ç‰ˆæœ¬å·æ˜¯å¦ä¸åŒã€‚åªè¦ä½ åƒæˆ‘ä¸€æ ·å®‰è£…å®ƒä»¬ï¼Œä½ çš„å°±ä¼šæ˜¯æœ€æ–°çš„ã€‚

ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹ç©äº†ï¼

# æ­¥éª¤ 2:æœåŠ¡å™¨è®¾ç½®

è®©æˆ‘ä»¬ä»åŸºç¡€å¼€å§‹ã€‚åœ¨ **src/** æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªåä¸º **config.js** çš„æ–‡ä»¶(è¿˜è®°å¾—æˆ‘ä»¬å¿½ç•¥çš„é‚£ä¸ªå—ï¼Ÿ).è¿™ä¸ªæ–‡ä»¶å°†åŒ…å«æˆ‘ä»¬æ‰€æœ‰çš„ç¯å¢ƒå˜é‡ã€‚åœ¨ç”Ÿäº§è¿‡ç¨‹ä¸­ï¼Œè¿™äº›å°†ç”±[**process . env**](https://nodejs.org/api/process.html#process_process_env)**å¯¹è±¡è®¾ç½®ã€‚æˆ‘ä»¬ç¨åå°†åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šçš„å˜é‡ï¼Œä½†ç°åœ¨ï¼Œæˆ‘çš„çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„:**

```
*--- backend/config.js ---* **export const {
  PORT = 5000,
  NODE_ENV = 'development'
} = process.env;**
```

**è¿™å¯èƒ½çœ‹èµ·æ¥å¾ˆæœ‰è¶£ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨è¿™é‡Œæ‰€åšçš„å°±æ˜¯ä» **process.env** å¯¹è±¡ä¸­ææ„ **PORT** å’Œ **NODE_ENV** å˜é‡ï¼Œå¹¶åœ¨å®ƒä»¬ä¸å­˜åœ¨çš„æƒ…å†µä¸‹ç»™å‡ºé»˜è®¤å€¼(åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå®ƒä»¬ä¸å­˜åœ¨â€”â€”é»˜è®¤å€¼æ˜¯æˆ‘ä»¬å°†è¦ä½¿ç”¨çš„)ã€‚é™¤äº† 3000ï¼Œä½ å¯ä»¥é€‰æ‹©ä»»ä½•ç«¯å£*ã€‚æˆ‘ä»¬å°†ä¸ºæˆ‘ä»¬çš„å®¢æˆ·èŠ‚çœ 3000 è‹±é•‘ã€‚***

**å¥½äº†ï¼Œç°åœ¨è¿›å…¥æˆ‘ä»¬çš„ **server.js** :**

```
*--- backend/server.js ---* **import express from 'express';
import { PORT, NODE_ENV } from './config';****const app = express();****app.disable('x-powered-by');****app.use(express.urlencoded({ extended: true }));
app.use(express.json());****app.listen(PORT, () => console.log(`Listening on port ${PORT}`));**
```

**æˆ‘ä»¬å¯¼å…¥ **express** å‡½æ•°ï¼Œè°ƒç”¨å®ƒâ€”â€”è¿”å›ä¸€ä¸ªå¯¹è±¡â€”â€”å¹¶å°†å…¶ä¿å­˜åˆ°å¸¸é‡ **app** (å¸¸è§„å‘½å)ä¸­ã€‚
æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç¦ç”¨**â€˜x-powered-byâ€™**ï¼Œè¿™ä½¿å¾—ç”¨æˆ·æ›´éš¾çœ‹å‡ºæˆ‘ä»¬åœ¨ä½¿ç”¨ Expressã€‚ä¸ºä»€ä¹ˆè¿™æ˜¯ä¸€ä»¶å¥½äº‹ï¼Ÿé»‘å®¢å¯¹æˆ‘ä»¬çš„å †æ ˆäº†è§£å¾—è¶Šå°‘è¶Šå¥½ã€‚
ç„¶åï¼Œæˆ‘ä»¬æ·»åŠ ä¸¤è¡Œä¸­é—´ä»¶ï¼Œè®°ä¸º **app.use(** *ä¸­é—´ä»¶* **)** ã€‚æˆ‘ä»¬è¿‡å»å¿…é¡»å®‰è£…ä¸€ä¸ªåä¸º body-parser çš„ç‹¬ç«‹ä¾èµ–é¡¹ï¼Œä½†æ˜¯ç°åœ¨ Express å†…ç½®äº†è¿™äº›å¥½ä¸œè¥¿ã€‚è¿™ä¸¤è¡Œå…è®¸æˆ‘ä»¬è§£æ HTTP è¯·æ±‚çš„ä¸»ä½“å’Œ JSON æœ‰æ•ˆè´Ÿè½½ã€‚
ç„¶åï¼Œæˆ‘ä»¬è°ƒç”¨åº”ç”¨ç¨‹åºä¸Šçš„ **listen** æ–¹æ³•ï¼Œä» **config.js** ä¼ å…¥æˆ‘ä»¬çš„ç«¯å£å’Œä¸€ä¸ªå›è°ƒï¼Œè®©æˆ‘ä»¬çŸ¥é“æˆ‘ä»¬å·²è¿æ¥ã€‚è®©æˆ‘ä»¬å‰å¾€æˆ‘ä»¬çš„ç»ˆç«¯ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦å·¥ä½œï¼**

**![](img/763a59f2f86bdd7631953b5ceed20730.png)**

**è¿è¡Œ`npm run dev`ä¹‹åï¼Œæˆ‘ä»¬åº”è¯¥ä¼šçœ‹åˆ°è¾“å‡ºâ€œç›‘å¬ç«¯å£ 5000â€ã€‚
è½¬åˆ°[http://localhost:5000/](http://localhost:5000/)
ä½ åº”è¯¥çœ‹åˆ°â€œ**æ— æ³•å¾—åˆ°/**â€
å¬èµ·æ¥æ˜¯ä¸ªé”™è¯¯ï¼Œæˆ‘çŸ¥é“ï¼Œä½†è¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚**

**é‚£å¥½å§ã€‚å¼€å§‹è·¯ç”±å§ã€‚åœ¨æˆ‘ä»¬çš„ routes æ–‡ä»¶å¤¹ä¸­ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªæ–‡ä»¶: **index.js** å’Œ **user.js** ã€‚æˆ‘ä»¬çš„ç´¢å¼•è·¯ç”±å°†ç®€å•åœ°å¯¼å‡ºä¸€ä¸ªåŒ…å«æ‰€æœ‰åç«¯è·¯ç”±çš„å¯¹è±¡ã€‚ç°åœ¨ï¼Œå®ƒçœ‹èµ·æ¥åƒè¿™æ ·:**

```
*--- backend/routes/index.js ---* **import userRoutes from './user';**// syntactic sugar for { userRoutes: userRoutes }
**export { userRoutes };**
```

**å¯¹äºæˆ‘ä»¬çš„ç”¨æˆ·è·¯çº¿ï¼Œè®©æˆ‘ä»¬è¿™æ ·åš:**

```
*--- backend/routes/user.js ---* **import express from 'express';****const userRoutes = express.Router();****userRoutes.post("", (req, res) => {
  res.send(req.body);
});****export default userRoutes;**
```

**è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ **express åˆ›å»ºä¸€ä¸ªè·¯ç”±å™¨ã€‚Router()** æˆ‘ä»¬åœ¨ä¸Šé¢å®šä¹‰äº†ä¸€ä¸ªâ€œpostâ€æ–¹æ³•ï¼Œå¯¹åº”ä¸€ä¸ª POST è¯·æ±‚ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è·¯å¾„(ä½†å®ƒæ˜¯ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ï¼ä¸€ä¼šå„¿å†è¯¦ç»†ä»‹ç»)ï¼Œç¬¬äºŒä¸ªæ˜¯æ¥æ”¶è¯·æ±‚å’Œå“åº”å¯¹è±¡çš„å›è°ƒã€‚åœ¨è¿™ä¸ªå›è°ƒå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†æˆ‘ä»¬å¸Œæœ›è·¯ç”±åšä»€ä¹ˆã€‚è¿™é‡Œæˆ‘ä»¬å‘Šè¯‰å“åº”â€œå‘é€â€å›è¯·æ±‚çš„â€œä¸»ä½“â€ã€‚**

**æœ€åï¼Œå›åˆ°æˆ‘ä»¬çš„ **server.js** :**

```
*--- backend/server.js ---* import express from 'express';
**import { userRoutes } from './routes/index';**
import { PORT, NODE_ENV } from './config';const app = express();app.disable('x-powered-by');app.use(express.urlencoded({ extended: true }));
app.use(express.json());**const apiRouter = express.Router();
app.use('/api', apiRouter);
apiRouter.use('/users', userRoutes);**app.listen(PORT, () => console.log(`Listening on port ${PORT}`));
```

**åœ¨æˆ‘ä»¬çš„ **server.js** ä¸­ï¼Œå¯¼å…¥æˆ‘ä»¬çš„ **userRoutes** ï¼Œç„¶ååšä¸¤ä»¶äº‹:
1ã€‚æˆ‘ä»¬åƒä¹‹å‰ä¸€æ ·è®¾ç½®äº†å¦ä¸€ä¸ªè·¯ç”±å™¨ï¼Œåä¸º **apiRouter** ï¼Œå¹¶å‘Šè¯‰æˆ‘ä»¬çš„**åº”ç”¨**å¯¹ä»»ä½•ä»¥â€œ **/api** å¼€å¤´çš„è·¯å¾„ä½¿ç”¨è¿™ä¸ªè·¯ç”±å™¨ã€‚
2ã€‚ç„¶åæˆ‘ä»¬å‘Šè¯‰æˆ‘ä»¬çš„ **apiRouter** ä½¿ç”¨æˆ‘ä»¬çš„ **userRoutes** ï¼Œå¯¹äºä»»ä½•ä»¥â€œ **/users** å¼€å¤´çš„è·¯å¾„ã€‚
è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ **routes/user.js** ä¸­ä½¿ç”¨ç©ºå­—ç¬¦ä¸²ä½œä¸ºè·¯å¾„â€”â€”å› ä¸ºæˆ‘ä»¬åœ¨ server.js ä¸­æä¾›äº†â€œ/usersâ€è·¯å¾„ã€‚**

**ç°åœ¨æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ï¼æˆ‘å°†ä½¿ç”¨[é‚®é€’å‘˜](https://www.getpostman.com/)ã€‚åœ¨æˆ‘å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼ŒGoogle Chrome æ‰©å±•å·²ç»è¿‡æ—¶äº†ï¼Œæ‰€ä»¥æˆ‘æ­£åœ¨ä½¿ç”¨å¯ä»¥å…è´¹ä¸‹è½½çš„åŸç”Ÿåº”ç”¨ã€‚æ‚¨å¯ä»¥éšæ„ä½¿ç”¨ä»»ä½•é€‰é¡¹æ¥æµ‹è¯• HTTP è¯·æ±‚ã€‚**

**![](img/b1fbdf9dbc963ca09351f61fb226e0b8.png)**

**å¦‚æœè¿™æ˜¯ä½ ç¬¬ä¸€æ¬¡ä½¿ç”¨ Postmanï¼Œå®ƒå¯èƒ½çœ‹èµ·æ¥åƒæœ‰ä¸€ç™¾ä¸‡ä¸ªæŒ‰é’®ã€æ—‹é’®å’Œä¸‹æ‹‰æ¡†ã€‚æˆ‘å·²ç»çªå‡ºæ˜¾ç¤ºå¹¶æ ‡è®°äº†æˆ‘ä»¬æµ‹è¯•çš„ä¸€æ­¥ä¸€æ­¥çš„å·¥ä½œæµç¨‹ã€‚**

**å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œæˆ‘ä»¬åº”è¯¥å¾—åˆ°ä¸€ä¸ª 200 çº§åˆ«çš„å“åº”ï¼Œä»è¯·æ±‚ä¸­å‘é€å›ä¸»ä½“ã€‚æˆ‘ä»¬è¿›å±•é¡ºåˆ©ã€‚è®©æˆ‘ä»¬ä¿æŒä¸‹å»ï¼ğŸ™Œ**

# **æ­¥éª¤ 3:MongoDB/mongose é›†æˆ**

**è¯¥å»å®åœ°è€ƒå¯Ÿäº†ï¼è®©æˆ‘ä»¬åˆ›å»ºæˆ‘ä»¬çš„ MongoDB Atlas å¸æˆ·ã€‚æˆ‘è®°å¾—ç¬¬ä¸€æ¬¡ä½¿ç”¨ Atlas æ—¶ï¼Œæˆ‘æ„Ÿåˆ°éå¸¸å¤±è½â€¦æ‰€ä»¥æˆ‘ä»¬å°†ä¸€èµ·åšè¿™ä»¶äº‹ã€‚(å¦‚æœä½ æ˜¯åœ°å›¾é›†ä¸“å®¶ï¼Œè¯·ç›´æ¥è·³è¿‡)ã€‚**

**1.é¦–å…ˆå» https://www.mongodb.com/[åˆ›å»ºä¸€ä¸ªå…è´¹è´¦æˆ·ã€‚ä¸€æ—¦ä½ çš„å¸æˆ·è¢«åˆ›å»ºï¼Œä½ åº”è¯¥è¢«å¼•å¯¼åˆ°ä¸€ä¸ªé¡µé¢ï¼Œåœ¨é‚£é‡Œä½ å¯ä»¥åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªâ€œé›†ç¾¤â€ã€‚é€‰æ‹©æ‚¨çš„é¦–é€‰é¡¹ï¼Œæˆ‘ä½¿ç”¨äº†æ‰€æœ‰é¢„å…ˆé€‰æ‹©çš„é€‰é¡¹:AWSã€my regionã€free-tier storageï¼Œå¹¶ä¸”æ²¡æœ‰è´¹å¿ƒæ›´æ”¹é›†ç¾¤åç§°ã€‚ç„¶åå°†å¼€å§‹é›†ç¾¤åˆ›å»ºè¿‡ç¨‹(è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´)ã€‚
2ã€‚åœ¨â€œClustersâ€é¡µé¢ä¸­ï¼Œå•å‡»é¡µé¢ä¸­é—´é™„è¿‘çš„ **Security** é€‰é¡¹å¡ï¼Œç„¶åå•å‡»â€œ**Add new userâ€**æŒ‰é’®ã€‚åˆ›å»ºç”¨æˆ·å/å¯†ç ï¼Œå¹¶ä½¿ç”¨æ‰€æœ‰é»˜è®¤è®¾ç½®ã€‚æˆ‘ä»¬å¸Œæœ›è¿™ä¸ªç”¨æˆ·æ‹¥æœ‰â€œ**è¯»å†™æƒé™**â€ã€‚
3ã€‚æ¥ä¸‹æ¥ï¼Œä»ç„¶åœ¨**å®‰å…¨**é€‰é¡¹å¡ä¸­ï¼Œå•å‡» **IP ç™½åå•**å­é€‰é¡¹å¡ã€‚ç„¶åç‚¹å‡»**æ·»åŠ  IP åœ°å€**æŒ‰é’®å’Œ**æ·»åŠ å½“å‰ IP åœ°å€**æŒ‰é’®ã€‚(æˆ‘ä»¬å¿«å¥½äº†ï¼)
4ã€‚ç°åœ¨ï¼Œè½¬åˆ°å®‰å…¨é€‰é¡¹å¡æ—è¾¹çš„**æ¦‚è¿°**é€‰é¡¹å¡ã€‚åœ¨é¡µé¢ä¸­é—´é™„è¿‘ï¼Œå•å‡»**è¿æ¥**ï¼Œç„¶åå•å‡»â€œ**è¿æ¥æ‚¨çš„åº”ç”¨ç¨‹åºâ€**æŒ‰é’®(å¯¹æˆ‘æ¥è¯´ï¼Œè¿™æ˜¯ä¸­é—´çš„é€‰é¡¹)ã€‚å¤åˆ¶æä¾›çš„è¿æ¥å­—ç¬¦ä¸²ã€‚æˆ‘ä»¬å°†åœ¨æˆ‘ä»¬çš„ **config.js** ä¸­ä½¿ç”¨å®ƒ:](https://www.mongodb.com/)**

```
*--- backend/config.js ---* export const {
  PORT = 5000,
  NODE_ENV = 'development', **MONGO_URI = 'mongodb+srv://*YOURUSERNAME*:*YOURPASSWORD*@cluster0bdxbr.mongodb.net/testretryWrites=true'**} = process.env;
```

**æé†’:å¦‚æœä½ æ­£åœ¨ä½¿ç”¨ GitHub æˆ–è€…ä½ æ­£åœ¨ä¸Šä¼ ä½ çš„ä»£ç ï¼Œåœ¨ä½ çš„**ä¸­å¿½ç•¥è¿™ä¸ªé…ç½®æ–‡ä»¶ã€‚gitignore** ã€‚
**ä¸è¦åˆ†äº«æˆ‘ä»¬æ”¾åœ¨ config.js ä¸­çš„ä»»ä½•ä¿¡æ¯** è¯·ç¡®ä¿å¡«å†™æ‚¨çš„çœŸå®ç”¨æˆ·å&å¯†ç ã€‚
ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ›´æ–°æˆ‘ä»¬çš„ **server.js** å¹¶è¿æ¥è¿™ä¸ªæ•°æ®åº“ã€‚**

```
*--- backend/server.js ---* import express from 'express';
**import mongoose from 'mongoose';**
import { userRoutes } from './routes/index';
import { PORT, NODE_ENV, **MONGO_URI** } from './config';**(async () => {
**  **try {**
    **await mongoose.connect(MONGO_URI, { useNewUrlParser: true });
    console.log('MongoDB connected');** const app = express();
    app.disable('x-powered-by');
    app.use(express.urlencoded({ extended: true }));
    app.use(express.json()); const apiRouter = express.Router();
    app.use('/api', apiRouter);
    apiRouter.use('/users', userRoutes); app.listen(PORT, () => console.log(`Listening on port ${PORT}`));
  **} catch (err) {
    console.log(err)**
  **}
})();**
```

**å“‡â€¦è¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿæˆ‘ä»¬æ¥åˆ†è§£ä¸€ä¸‹ã€‚
é¦–å…ˆæˆ‘ä»¬å¯¼å…¥ [**çŒ«é¼¬**](https://mongoosejs.com/) ï¼Œä¸€ä¸ªå¯¹è±¡æ•°æ®å»ºæ¨¡(ODM)åº“ã€‚æˆ‘ä»¬è¿˜å°†**è’™æˆˆ _URI** æ·»åŠ åˆ°æˆ‘ä»¬çš„é…ç½®å¯¼å…¥ä¸­ã€‚
ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨ mongoose è¿æ¥åˆ°æˆ‘ä»¬çš„ MongoDB Atlasï¼Œä½¿ç”¨æˆ‘ä»¬å¯¼å…¥çš„ URI å’Œä¸€ä¸ªåŒ…å«`useNewUrlParser: true`çš„ options å¯¹è±¡(è¿™å…è®¸æˆ‘ä»¬çš„ URI è¢«è§£æ)ã€‚
æ•´ä¸ªè¿‡ç¨‹æ˜¯*å¼‚æ­¥çš„*ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›æˆ‘ä»¬çš„æœåŠ¡å™¨åœ¨æ•°æ®åº“è¿æ¥ä¹‹å‰å¯åŠ¨ã€‚
æˆ‘ä»¬*å¯ä»¥*ç”¨**ã€‚ç„¶åæ˜¯**ï¼Œä½†æ˜¯å¯¹äºæ•´ä¸ªåº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ [**å¼‚æ­¥/ç­‰å¾…**](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function) ã€‚ä¸ºäº†é€‚åº”è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å°†æ‰€æœ‰ä»£ç åŒ…è£…åœ¨ä¸€ä¸ªå¼‚æ­¥çš„[life](https://developer.mozilla.org/en-US/docs/Glossary/IIFE)(ç«‹å³è°ƒç”¨çš„å‡½æ•°è¡¨è¾¾å¼)ä¸­ã€‚
æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª **try/catch** å—ï¼Œå¦‚æœå‡ºç°é—®é¢˜ï¼Œå®ƒå°†è®°å½•æ§åˆ¶å°ä¸­çš„ä»»ä½•é”™è¯¯ã€‚å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œæˆ‘ä»¬åº”è¯¥ä¼šçœ‹åˆ°ä¸¤ä¸ª **console.log** è¾“å‡ºã€‚**

**![](img/5258fcd0a3e495787de427d67506200d.png)**

# **æ­¥éª¤ 4:æ¨¡å‹å’ŒéªŒè¯**

**è¿™ä¸€æ­¥å¯èƒ½æœ‰ç‚¹å¤æ‚ï¼Œä½†æ˜¯ä¸è¦æ‹…å¿ƒï¼æˆ‘ä»¬åœ¨ä¸€èµ·ã€‚
åœ¨æˆ‘ä»¬çš„ **models/** æ–‡ä»¶å¤¹ä¸­ï¼Œåˆ›å»ºä¸€ä¸ª **user.js** æ–‡ä»¶ã€‚
æˆ‘ä»¬å°†ä½¿ç”¨ [Bcrypt](https://www.npmjs.com/package/bcryptjs) å¯¹ç”¨æˆ·çš„å¯†ç è¿›è¡ŒåŠ ç›å’Œå“ˆå¸Œå¤„ç†ï¼Œç„¶åå°†å®ƒä»¬ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚**åˆ‡å‹¿ä¿å­˜çº¯æ–‡æœ¬å¯†ç **ã€‚
æˆ‘ä½¿ç”¨ BCrypt çš„ **sync** ç‰ˆæœ¬å‡½æ•°(å®ƒä½¿ç”¨ **async/await** )æ¥ä¿æŒæˆ‘ä»¬çš„ä»£ç æ›´å¹²å‡€ã€‚æˆ‘æŠŠè¿™ä¸ªåˆ†æˆä¸¤éƒ¨åˆ†:**

```
*--- backend/routes/user.js ---* **import mongoose from 'mongoose';
import { compareSync, hashSync } from 'bcryptjs';****const UserSchema = new mongoose.Schema({
  username: {
    type: String,
    validate: {
      validator: username => User.doesNotExist({ username }),
      message: "Username already exists"
    }
  },
  email: {
    type: String,
    validate: {
      validator: email => User.doesNotExist({ email }),
      message: "Email already exists"
    }
  },
  password: {
    type: String,
    required: true
  }
}, { timestamps: true });
...**
```

**æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ã€‚æˆ‘ä»¬ä»å¯¼å…¥**mongose**å’Œæˆ‘ä»¬éœ€è¦çš„ Bcrypt å‡½æ•°å¼€å§‹ã€‚
æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª**ç”¨æˆ·æ¨¡å¼**ã€‚è¿™åŸºæœ¬ä¸Šæ˜¯å¦‚ä½•å°†æˆ‘ä»¬çš„ç”¨æˆ·å¯¹è±¡ä¿å­˜åœ¨æˆ‘ä»¬çš„æ•°æ®åº“ä¸­çš„è“å›¾ã€‚æˆ‘ä»¬çš„ç”¨æˆ·å¾ˆç®€å•ï¼Œåªéœ€è¦ç”¨æˆ·åã€ç”µå­é‚®ä»¶å’Œå¯†ç ([æ›´å¤šå…³äº mongoose æ¨¡å¼)](https://mongoosejs.com/docs/guide.html)ã€‚æˆ‘ä»¬æŒ‡å®šè¿™äº›å­—æ®µå°†æ˜¯**å­—ç¬¦ä¸²**ï¼Œä¸ºç”¨æˆ·åå’Œç”µå­é‚®ä»¶æ·»åŠ ä¸€ä¸ªå®šåˆ¶çš„**éªŒè¯å™¨**ï¼Œä¸ºå¯†ç æ·»åŠ ä¸€ä¸ªç®€å•çš„**å¿…éœ€çš„**éªŒè¯å™¨ï¼Œä»¥åŠ**æ—¶é—´æˆ³**ã€‚æˆ‘ä»¬éœ€è¦åœ¨è¿™é‡Œå†è¡¥å……ä¸€ç‚¹:**

```
*--- backend/routes/user.js ---* **...
UserSchema.pre('save', function () {
  *if* (*this*.isModified('password')) {
    *this*.password = hashSync(*this*.password, 10);
  }
});****UserSchema.statics.doesNotExist = async function (field) {
  *return* *await* *this*.where(field).countDocuments() === 0;
};****UserSchema.methods.comparePasswords = function (password) {
  *return* compareSync(password, *this*.password);
};****const User = mongoose.model('User', UserSchema);
export default User;**
```

**æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæˆ‘ä»¬çš„ UserSchema æ·»åŠ ä¸€ä¸ªâ€œpre-hookâ€**æˆ–â€œä¸­é—´ä»¶â€ã€‚è¿™æ®µä»£ç å°†åœ¨æˆ‘ä»¬çš„ç”¨æˆ·å®ä¾‹ä¿å­˜ä¹‹å‰è¿è¡Œã€‚ç”±äºè¯æ³•èŒƒå›´çš„åŸå› ï¼Œæˆ‘ä»¬ä¸èƒ½å¯¹è¿™ä¸‰ç§æ–¹æ³•ä½¿ç”¨ç®­å¤´å‡½æ•°ã€‚
**è¿™ä¸ª**å°±æ˜¯æˆ‘ä»¬çš„ **pre** æ–¹æ³•æ‰€æŒ‡çš„ç”¨æˆ·å®ä¾‹ã€‚æˆ‘ä»¬ä»”ç»†æ£€æŸ¥æ˜¯å¦æä¾›äº†ä¸€ä¸ªå¯†ç ï¼Œç„¶åå°†è¯¥å¯†ç é‡ç½®ä¸ºå®ƒçš„ salted å’Œ hashed ç‰ˆæœ¬ã€‚
ç„¶åæˆ‘ä»¬å®šä¹‰æˆ‘ä»¬çš„è‡ªå®šä¹‰éªŒè¯å™¨ï¼Œ**ä¸å­˜åœ¨ï¼Œ**ï¼Œå®ƒæ˜¯åœ¨æˆ‘ä»¬çš„ **UserSchema** ä¸Šå®šä¹‰çš„*ç±»æ–¹æ³•*ã€‚ä½¿ç”¨ä¸¤ä¸ª mongoose æ–¹æ³•å’Œä¸€ä¸ªæ¯”è¾ƒæ“ä½œç¬¦ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šç”¨æˆ·æ˜¯å¦å­˜åœ¨ã€‚è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥æ­¥éª¤ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ async/awaitã€‚
æˆ‘ä»¬è¿˜å®šä¹‰äº†ä¸€ä¸ª*å®ä¾‹æ–¹æ³•*ã€ **comparePasswordsã€**ï¼Œå®ƒç®€å•åœ°å°†ä¸€ä¸ªçº¯æ–‡æœ¬å¯†ç ä¸ä¸€ä¸ªç”¨æˆ·å®ä¾‹çš„æ•£åˆ—å¯†ç è¿›è¡Œæ¯”è¾ƒã€‚
æœ€åï¼Œæˆ‘ä»¬æ˜ç¡®å®šä¹‰æˆ–**ç”¨æˆ·**æ¨¡å‹å¹¶å¯¼å‡ºã€‚****

****ä¸‹ä¸€ç«™:éªŒè¯ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ [Joi](https://www.npmjs.com/package/joi) è¿›è¡ŒéªŒè¯ã€‚ä½†æ˜¯ä½ å¯èƒ½ä¼šé—®ï¼Œâ€œæˆ‘ä»¬ä¸æ˜¯åˆšåˆšåœ¨æ¨¡å‹ä¸­æ·»åŠ äº†éªŒè¯å—ï¼Ÿâ€æ˜¯çš„â€¦â€¦ä½†æ˜¯ï¼Œè¿™äº›æœ¬è´¨ä¸Šæ˜¯æˆ‘ä»¬çš„æ•°æ®åº“çº§éªŒè¯ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨åˆ›å»ºç”¨æˆ·å®ä¾‹ä¹‹å‰ï¼Œåœ¨ä¸Šé¢å†æ£€æŸ¥ä¸€å±‚éªŒè¯ã€‚åœ¨ Joi çš„å¸®åŠ©ä¸‹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å˜å¾—æ›´å…·ä½“ã€‚åœ¨æˆ‘ä»¬çš„ **validations/** æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ª **user.js** æ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤º:****

```
***--- backend/validations/user.js ---* **import Joi from 'joi';****const email = Joi.string().email().required();
const username = Joi.string().alphanum().min(3).max(30).required();****const message = 'must be between 6-16 characters, ' +
  'have at least one capital letter, ' +
  'one lowercase letter, one digit, ' +
  'and one special character';****const password = Joi.string()
  .regex(/*^*(?=.*[A-Za-z])(?=.*\d)(?=.*[!@#$%^&*])[a-zA-Z0-9!@#$%^&*]{6,16}*$*/)
  .options({
    language: {
      string: {
        regex: {
          base: message
        }
      }
    }
});****export const signUp = Joi.object().keys({
  email,
  username,
  password
});****export const signIn = Joi.object().keys({
  email,
  password
});****
```

****ç”±äº[æ–‡æ¡£](https://www.npmjs.com/package/joi)å¾ˆç²¾å½©ï¼Œæˆ‘ä¸ä¼šèŠ±å¤ªå¤šæ—¶é—´è§£é‡Šè¿™é‡Œå‘ç”Ÿäº†ä»€ä¹ˆã€‚æˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª**ç”µå­é‚®ä»¶**ã€**ç”¨æˆ·å**å’Œ**å¯†ç **ï¼Œæ¯ä¸ªéƒ½é™„åŠ äº†éªŒè¯ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒJoi ä¼šåœ¨æŸäº›å†…å®¹æ— æ•ˆæ—¶æä¾›ä¸€æ¡æ¶ˆæ¯ï¼Œä½†æ˜¯å¯¹äºå¯†ç å­—æ®µï¼Œå®ƒå®é™…ä¸Šä¼šæ‰“å°å‡ºç”¨æˆ·çŒœæµ‹çš„å¯†ç ã€‚å¯†ç åº”è¯¥æ°¸è¿œä¸å¯è§ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå®šåˆ¶çš„**æ¶ˆæ¯**å¹¶æ·±å…¥åˆ°**é€‰é¡¹**å¯¹è±¡ä¸­æ¥ä¼ é€’å®ƒã€‚ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥è·å–å¯†ç éªŒè¯çš„å…·ä½“ç»†èŠ‚ã€‚
æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨æˆ‘ä»¬çš„**ç”µå­é‚®ä»¶**ã€**ç”¨æˆ·å**å’Œ**å¯†ç **æ¥åˆ›å»ºå’Œå¯¼å‡ºä¸¤ä¸ª **Joi å¯¹è±¡**ã€‚æˆ‘ä»¬å°†ä½¿ç”¨è¿™äº›æ¥éªŒè¯ç”¨æˆ·çš„è¾“å…¥ã€‚****

****è®©æˆ‘ä»¬å›åˆ°æˆ‘ä»¬çš„ **routes/user.js** æ–‡ä»¶:****

```
****import Joi from 'joi';**
import express from 'express';
**import User from '../models/user';
import { signUp } from '../validations/user';****const userRouter = express.Router();
userRouter.post("", async (req, res) => {
  *try* {
    const { username, email, password } = req.body
    *await* Joi.validate({ username, email, password }, signUp);** **const newUser = new User({ username, email, password });
    *await* newUser.save();
    res.send({ userId: newUser.id, username });
  } *catch* (err) {
    res.status(400).send(err);
  }
});**export default userRouter;**
```

****æˆ‘ä»¬å¼•å…¥äº† **Joi** ï¼Œæˆ‘ä»¬çš„**ç”¨æˆ·**æ¨¡å‹ï¼Œä»¥åŠæˆ‘ä»¬çš„**æ³¨å†Œ**éªŒè¯å™¨ã€‚
ç„¶åæˆ‘ä»¬ä¿®æ”¹æˆ‘ä»¬çš„ **post** æ–¹æ³•ï¼Œä½¿ç”¨ **async** å’Œä¸€ä¸ª **try/catch** å—ã€‚
æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ææ„ **req.body** å¹¶è°ƒç”¨ **Joi.validate** æ–¹æ³•ï¼Œä¼ é€’ä¸€ä¸ªåŒ…å«ç”¨æˆ·è¾“å…¥å’Œæˆ‘ä»¬çš„**æ³¨å†Œ**éªŒè¯å™¨çš„å¯¹è±¡ã€‚å¦‚æœé€šè¿‡ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª**æ–°ç”¨æˆ·**å®ä¾‹å¹¶å°è¯•ä¿å­˜è¯¥ç”¨æˆ·ã€‚å¦‚æœé€šè¿‡äº†ï¼Œæˆ‘ä»¬å°±å‘é€å›æˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬çš„å‰ç«¯å¯ä»¥è®¿é—®çš„å†…å®¹ã€‚å¦‚æœæœ‰ä»»ä½•å¤±è´¥ï¼Œå®ƒå°†è¢«æ•è·ï¼Œæˆ‘ä»¬é€šè¿‡å°†çŠ¶æ€ä»£ç è®¾ç½®ä¸º **400** å¹¶å‘å›é”™è¯¯æ¥åšå‡ºå“åº”(æˆ‘ä»¬å°†åœ¨ä»¥åæ”¹è¿›æˆ‘ä»¬çš„é”™è¯¯å¤„ç†)ã€‚æœ‰äººå¯èƒ½ä¼šé—®ï¼Œâ€œå¦‚æœ req.body åªåŒ…å«ä¸€ä¸ªåŒ…å«ç”¨æˆ·åã€ç”µå­é‚®ä»¶å’Œå¯†ç çš„ JSON å¯¹è±¡ï¼Œä¸ºä»€ä¹ˆè¿˜è¦å°†å…¶ææ„å‘¢ï¼Ÿä¸ºä»€ä¹ˆä¸ç›´æ¥å°†æ•´ä¸ªä¸»ä½“ä¼ é€’ç»™æˆ‘ä»¬çš„éªŒè¯å™¨å’Œæ–°çš„ç”¨æˆ·å‡½æ•°å‘¢ï¼Ÿâ€å—¯â€¦â€¦é—®é¢˜æ˜¯æˆ‘ä»¬ä¸çŸ¥é“è¿™æ˜¯å¦æ˜¯èº«ä½“æ‰€åŒ…å«çš„å…¨éƒ¨ã€‚æˆ‘ä»¬å·²ç»çœ‹åˆ°ä½¿ç”¨ Postmanï¼Œç”¨æˆ·å¯ä»¥åœ¨è¯·æ±‚çš„ä¸»ä½“/å‚æ•°ä¸­æ”¾å…¥ä»»ä½•ä»–ä»¬æƒ³è¦çš„ä¸œè¥¿ã€‚æœ‰äº†æˆ‘ä»¬å®šä¹‰çš„éªŒè¯å™¨å’Œæ¨¡å¼ï¼Œè¿™é‡Œæ²¡æœ‰å¤ªå¤§çš„é£é™©ï¼Œä½†æ˜¯ä¸€ä¸ªå¥½çš„ç»éªŒæ³•åˆ™æ˜¯æ°¸è¿œä¸è¦ç›¸ä¿¡æ¥è‡ªç”¨æˆ·çš„è¾“å…¥ã€‚****

****è®©æˆ‘ä»¬ç”¨ Postman æ¥æµ‹è¯•ä¸€ä¸‹ï¼****

****![](img/c53ec00da312795233619b17d2cb4420.png)****

****å°±æœåŠ¡å™¨è€Œè¨€ï¼Œè¿™é‡Œçš„æƒ…å†µçœ‹èµ·æ¥å¾ˆå¥½ã€‚æ³¨æ„åˆ°æˆ‘ä»¬å¾—åˆ°çš„å›åº”äº†å—ï¼Ÿæˆ‘ä»¬çš„ Redux å•†åº—ä»¥åä¼šå–œæ¬¢çš„ã€‚
ç°åœ¨ï¼Œè®©æˆ‘ä»¬è½¬åˆ°æˆ‘ä»¬çš„ MongoDB Atlas å¸æˆ·ï¼Œä»ä¸»é›†ç¾¤é¡µé¢ä¸­ï¼Œå•å‡»â€œ**é›†åˆ**â€ã€‚****

****![](img/999057f015c328167de806c1b8434c6c.png)****

****æˆ‘ä»¬çš„ç”¨æˆ·æ¥äº†ï¼æ‚¨å¯ä»¥çœ‹åˆ°å¯†ç ç¡®å®ç»è¿‡äº†å“ˆå¸Œå¤„ç†ã€‚****

****![](img/8c355e6ca087f03a53acecc0efc8be04.png)****

****å¦‚æœæˆ‘ä»¬è¯•å›¾è¾“å…¥ä»»ä½•æ— æ•ˆçš„å†…å®¹ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ªåŒ…å«ä¸€æ¡å¥½æ¶ˆæ¯çš„å“åº”ï¼Œç¨åæˆ‘ä»¬å°†åœ¨å®¢æˆ·ç«¯ä½¿ç”¨è¿™æ¡æ¶ˆæ¯å‘ç”¨æˆ·æ˜¾ç¤ºã€‚****

****åœ¨è¿›å…¥å‰ç«¯ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªåç«¯æ­¥éª¤è¦å®Œæˆã€‚
ç°åœ¨ä¸èƒ½åœï¼âœŠ****

# ****ç¬¬äº”æ­¥:ä¼šè¯****

****è®©æˆ‘ä»¬è¿›å…¥æ­£é¢˜ã€‚åœ¨æˆ‘ä»¬çš„ **config.js** ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å†æ·»åŠ å‡ è¡Œä»£ç :****

```
***--- backend/config.js --* ...
  **SESS_NAME = 'sid',
  SESS_SECRET = 'secret!session',
  SESS_LIFETIME = 1000 * 60 * 60 * 2**
} = process.env;**
```

****è¿™é‡Œæˆ‘ä»¬ææ„/å®šä¹‰ä¸€ä¸ªä¼šè¯**åç§°**ï¼Œ**ç§˜å¯†**ï¼Œå’Œ**å¯¿å‘½**(æˆ‘åªç”¨äº†ä¸¤å¤©)ã€‚è¿™ä¸ª **SESS_SECRET** ç”¨äºä½¿ç”¨ HMAC æ•£åˆ— sessionIDã€‚è¿™ä¸ªç§˜å¯†é€šå¸¸åº”è¯¥æ˜¯åœ¨æ‚¨çš„ç¯å¢ƒä¸­å®šä¹‰çš„æ·±å¥¥çš„ä¸œè¥¿(ä¾‹å¦‚ Heroku ç­‰)ï¼Œä½†æ˜¯å¯¹äºå¼€å‘æ¥è¯´ï¼Œè¿™æ˜¯å¯ä»¥çš„ã€‚ **SESS_NAME** ç¨åå°†ç”¨äºå¼•ç”¨æˆ‘ä»¬çš„ä¼šè¯ã€‚****

****å¥½äº†ï¼Œè®©æˆ‘ä»¬å›åˆ°æˆ‘ä»¬çš„ **server.js** æ–‡ä»¶ã€‚æˆ‘ä¼šæŠŠå®ƒä¸€åˆ†ä¸ºäºŒ:****

```
***--- backend/server.js ---*
import express from 'express';
import mongoose from 'mongoose';
**import session from "express-session";**
**import connectStore from "connect-mongo";**
import { userRoutes } from './routes/index';
import {
PORT, NODE_ENV, MONGO_URI, **SESS_NAME**, **SESS_SECRET**, **SESS_LIFETIME**
} from "./config";(async () => { 
...**
```

****é¦–å…ˆï¼Œæˆ‘ä»¬å¤„ç†ä¸€äº›è¿›å£å•†å“ã€‚
ä½¿ç”¨**å¿«é€Ÿä¼šè¯**æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥æ³¨æ„ä¸€äº›äº‹æƒ…:****

> ********è­¦å‘Š*** é»˜è®¤çš„æœåŠ¡å™¨ç«¯ä¼šè¯å­˜å‚¨`*MemoryStore*`ï¼Œæ˜¯*ç‰¹æ„*ä¸ä¸ºç”Ÿäº§ç¯å¢ƒè®¾è®¡çš„ã€‚å®ƒåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ä¼šæ³„æ¼å†…å­˜ï¼Œä¸ä¼šæ‰©å±•åˆ°å•ä¸ªè¿›ç¨‹ä¹‹å¤–ï¼Œå¹¶ä¸”åªç”¨äºè°ƒè¯•å’Œå¼€å‘ã€‚â€
> *â€”* [*å¿«é€Ÿ-ä¼šè¯æ–‡æ¡£*](https://github.com/expressjs/session)*****

*****å•Šå“¦ã€‚æˆ‘ä»¬åº”è¯¥åšç‚¹ä»€ä¹ˆï¼Œå¯¹å—ï¼Ÿ
è¿›å…¥ [**è¿æ¥-mongo**](https://github.com/jdesboeufs/connect-mongo) ã€‚è¿™å°†æŠŠæˆ‘ä»¬çš„ä¼šè¯ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œå¹¶å…è®¸åœ¨æˆ‘ä»¬çš„æœåŠ¡å™¨å…³é—­æˆ–é‡å¯æ—¶é‡æ–°å»ºç«‹è¿æ¥ã€‚å½“æˆ‘ä»¬*æ³¨é”€æ—¶é”€æ¯*æˆ‘ä»¬çš„ä¼šè¯æ—¶ï¼Œè¿™ä¸ªä¼šè¯ä¿¡æ¯ä¼šè‡ªåŠ¨ä»æˆ‘ä»¬çš„æ•°æ®åº“ä¸­åˆ é™¤ã€‚å¾ˆé…·ï¼Œå¯¹å§ï¼Ÿè®©æˆ‘ä»¬ç»§ç»­å‰è¿›:*****

```
****--- backend/server.js ---*
    ...
    const app = express();
    **const MongoStore = connectStore(session);** app.use(express.urlencoded({ extended: true }));
    app.use(express.json());
 **app.use(session({
      name: SESS_NAME,
      secret: SESS_SECRET,
      saveUninitialized: false,
      resave: false,
      store: new MongoStore({
        mongooseConnection: mongoose.connection,
        collection: 'session',
        ttl: parseInt(SESS_LIFETIME) / 1000
      }),
      cookie: {
        sameSite: true,
        secure: NODE_ENV === 'production',
        maxAge: parseInt(SESS_LIFETIME)
      }
    }));
    ...*****
```

*****æˆ‘ä»¬è°ƒç”¨ **connectStore** ä¼ å…¥æˆ‘ä»¬çš„**ä¼šè¯**ä¸­é—´ä»¶ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ°å¸¸é‡ **MongoStore** ä¸­ã€‚
ç°åœ¨ï¼Œæˆ‘ä»¬å‘Šè¯‰æˆ‘ä»¬çš„**åº”ç”¨**ä½¿ç”¨**ä¼šè¯**ä¸­é—´ä»¶ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ªé€‰é¡¹å¯¹è±¡ã€‚æˆ‘ä»¬å·²ç»è¦†ç›–äº†**åç§°**å’Œ**ç§˜å¯†**ï¼Œä½†æ˜¯æˆ‘ä»¬åˆä¼ é€’äº†ä¸¤ä¸ªé€‰é¡¹:
`saveUninitialized: false`ï¼›è¿™ç¬¦åˆåœ¨è®¾ç½® cookie ä¹‹å‰éœ€è¦è®¸å¯çš„æ³•å¾‹ã€‚
T1ï¼›å¦‚æœä¼šè¯æœªè¢«ä¿®æ”¹ï¼Œè¿™å¯ä»¥é˜²æ­¢ä¸å¿…è¦çš„é‡æ–°ä¿å­˜ã€‚
å•†åº—**é€‰é¡¹æ˜¯æˆ‘ä»¬æ’å…¥ **MongoStore** çš„åœ°æ–¹ã€‚æˆ‘ä»¬å°†é€šè¿‡å®ƒçš„ä¸‰ä¸ªé€‰é¡¹:
`mongooseConnection: mongoose.connection`ï¼›è¿™ä½¿ç”¨äº†æˆ‘ä»¬åœ¨ä¸Šé¢å»ºç«‹çš„è¿æ¥ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸å¿…è¿æ¥ Mongo ä¸¤æ¬¡ã€‚
T3ï¼›è¿™æŒ‡å®šäº†æˆ‘ä»¬çš„ä¼šè¯ä¿¡æ¯åœ¨æ•°æ®åº“ä¸­çš„ä¿å­˜ä½ç½®ã€‚
T4ï¼›(â€œç”Ÿå­˜æ—¶é—´â€)æˆ‘ä»¬å¸Œæœ›è¿™ä¸æˆ‘ä»¬çš„ **SESS_LIFETIME** ç›¸åŒ¹é…ï¼Œé™¤äº† connect-mongo ä½¿ç”¨ç§’è€Œä¸æ˜¯æ¯«ç§’ï¼Œæ‰€ä»¥æˆ‘ä»¬é™¤ä»¥ 1000ã€‚æˆ‘ä»¬åœ¨è¿™é‡Œå’Œä¸‹é¢ä¹Ÿä½¿ç”¨ **ParseInt()** ï¼Œå› ä¸ºä¸€äº›ç¯å¢ƒå˜é‡åœ¨ç”Ÿäº§ä¸­ç»å¸¸è¢«è®¾ç½®ä¸ºå­—ç¬¦ä¸²ã€‚æˆ‘ä»¬æƒ³è¦ä¸€ä¸ªæ•°å­—ã€‚
æ¥ä¸‹æ¥ç»™æˆ‘ä»¬çš„ **cookie** ä¸€äº›é€‰é¡¹:
`sameSite: true`ï¼›è¿™æœ‰åŠ©äºé˜²æ­¢ CSRF è¢­å‡»ã€‚
`secure: NODE_ENV === â€˜productionâ€™`ï¼›æˆ‘ä»¬åªåœ¨ç”Ÿäº§è¿‡ç¨‹ä¸­å°† cookie è®¾ç½®ä¸ºå®‰å…¨çš„ã€‚*æˆä¸º* **çœŸ***éœ€è¦ä¸€ä¸ªæ”¯æŒ https çš„ç½‘ç«™ã€‚*
**maxAge** ç®€å•åœ°æŒ‡å®šäº†æˆ‘ä»¬çš„ cookie çš„å¹´é¾„ã€‚
æˆ‘åªæ˜¯ä¸ºè¿™äº›é€‰é¡¹æä¾›ä¸€ä¸ªé«˜å±‚æ¬¡çš„è§£é‡Šï¼Œè¿˜æœ‰*è®¸å¤šé»˜è®¤é€‰é¡¹æ­£åœ¨è®¾ç½®*ã€‚[æ–‡æ¡£](https://github.com/expressjs/session)è¯¦ç»†è§£é‡Šäº†æ‰€æœ‰è¿™äº›ã€‚*******

***åœ¨å®Œæˆåç«¯ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸¤ä¸ªæ–‡ä»¶è¦å¤„ç†ã€‚åœ¨åˆ›å»ºä¼šè¯è·¯ç”±ä¹‹å‰ï¼Œæˆ‘ä»¬å°†åœ¨ **util/helpers.js** ä¸­å®šä¹‰ä¸¤ä¸ªåŠ©æ‰‹æ–¹æ³•:***

```
**--- backend/util/helpers.js ---* **export const parseError = err => {
  if (err.isJoi) return err.details[0];
  return JSON.stringify(err, Object.getOwnPropertyNames(err));
};****export const sessionizeUser = user => {
  return { userId: user.id, username: user.username };
}***
```

***ç¬¬ä¸€ä¸ªå‡½æ•°å°†å…è®¸æˆ‘ä»¬åŒºåˆ† **Joi** é”™è¯¯å’Œæˆ‘ä»¬ç¨åæŠ›å‡ºçš„è‡ªå®šä¹‰**é”™è¯¯**å¹¶æå–æ¶ˆæ¯ï¼Œæˆ‘ä»¬å°†æ¶ˆæ¯å‘é€ç»™å®¢æˆ·ç«¯å¹¶æ˜¾ç¤ºç»™æˆ‘ä»¬çš„ç”¨æˆ·ã€‚
ç¬¬äºŒä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«æˆ‘ä»¬å¸Œæœ›ä¿å­˜åˆ°ä¼šè¯ä¸­å¹¶ç¨åå‘é€å› Redux å­˜å‚¨çš„å†…å®¹ã€‚
è®©æˆ‘ä»¬å°†æˆ‘ä»¬çš„é”™è¯¯è§£æå™¨æ·»åŠ åˆ° **routes/user.js** ï¼Œå¹¶å°†æˆ‘ä»¬çš„ç”¨æˆ·ä¿å­˜åˆ°æˆ‘ä»¬çš„**ä¼šè¯**:***

```
**--- backend/routes/user.js ---* import Joi from 'joi';
import express from 'express';
import User from '../models/user';
import { signUp } from '../validations/user';
**import { parseError, sessionizeUser } from "../util/helpers";**const userRouter = express.Router();
userRouter.post("", async (req, res) => {
  try {
    const { username, email, password } = req.body;
    await Joi.validate({ username, email, password }, signUp); const newUser = new User({ username, email, password });
    **const sessionUser = sessionizeUser(newUser);**
    await newUser.save(); **req.session.user = sessionUser;**
    res.send(**sessionUser**);
 } catch (err) {
   res.status(400).send(**parseError(err)**);
  }
});export default userRouter;*
```

***åœ¨è®¾ç½®äº†**å¿«é€Ÿä¼šè¯**ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥è®¿é—®ä¼šè¯å¯¹è±¡*ï¼Œè¯¥å¯¹è±¡åªä¿å­˜åœ¨æœåŠ¡å™¨ç«¯*(å®¢æˆ·ç«¯ä¸èƒ½è®¿é—®è¯¥ä¼šè¯)ã€‚è®°ä½è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†ç”¨æˆ·çš„ id å’Œç”¨æˆ·åä¿å­˜åˆ°æˆ‘ä»¬çš„ä¼šè¯ä¸­ã€‚***

***![](img/c7cd0e9dde13d8d8bb7f76a48add0972.png)***

***ä¸ºäº†å±•ç¤ºå®ƒçš„å·¥ä½œåŸç†ï¼Œæˆ‘åœ¨æˆ‘ä»¬å­˜å‚¨ç”¨æˆ·çš„åœ°æ–¹æ”¾äº†ä¸€ä¸ª**console . log(req . session)**ã€‚ç„¶åæˆ‘ç”¨ Postman åˆ›å»ºäº†å¦ä¸€ä¸ªç”¨æˆ·ï¼Œä»–å°±åœ¨é‚£é‡Œï¼***

***å¥½äº†ï¼Œç°åœ¨è®©æˆ‘ä»¬åœ¨ **routes/** æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ª **session.js** :***

```
**--- backend/routes/session.js ---* **import express from "express";
import Joi from "joi";
import User from "../models/user";
import { signIn } from "../validations/user";
import { parseError, sessionizeUser } from "../util/helpers";
import { SESS_NAME } from "../config";****const sessionRouter = express.Router();** *...**
```

***é¦–å…ˆï¼Œæˆ‘ä»¬è¿›å£æˆ‘ä»¬éœ€è¦çš„ä¸€åˆ‡ã€‚é™¤äº†å¯èƒ½ **SESS_NAME** ä¹‹å¤–ï¼Œè¿™é‡Œæ²¡æœ‰ä»€ä¹ˆå¥½æƒŠè®¶çš„ï¼Œä½ å¾ˆå¿«å°±ä¼šæ˜ç™½ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦å®ƒã€‚ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰**ä¼šè¯è·¯ç”±å™¨**ï¼Œå°±åƒæˆ‘ä»¬å®šä¹‰**ç”¨æˆ·è·¯ç”±å™¨**ä¸€æ ·ã€‚***

***ç°åœ¨ï¼Œæˆ‘ä»¬å°†ä»ç™»å½•å¼€å§‹å®šä¹‰ä¸‰ä¸ª API ç«¯ç‚¹:***

```
**--- backend/routes/session.js ---
...*
**sessionRouter.post("", async (req, res) => {
  try {
    const { email, password } = req.body
    await Joi.validate({ email, password }, signIn);** **const user = await User.findOne({ email });
    if (user && user.comparePasswords(password)) {
      const sessionUser = sessionizeUser(user);** **req.session.user = sessionUser
      res.send(sessionUser);
    } else {
      throw new Error('Invalid login credentials');
    }
  } catch (err) {
    res.status(401).send(parseError(err));
  }
});
...***
```

***æˆ‘ä»¬æ¥è°ˆè°ˆè¿™ä¸ªã€‚æˆ‘ä»¬åœ¨æˆ‘ä»¬çš„ **sessionRouter** ä¸Šå®šä¹‰äº†ä¸€ä¸ª post æ–¹æ³•ï¼Œæˆ‘ä»¬æ·»åŠ äº† **async** ï¼Œä»è¯·æ±‚ä½“ä¸­æå–äº† **email** å’Œ**å¯†ç **ï¼Œå¹¶ä½¿ç”¨äº†æˆ‘ä»¬çš„**sign in****Joi**validatorã€‚
å¦‚æœé€šè¿‡ï¼Œæˆ‘ä»¬ä½¿ç”¨**findOne**mongose æ–¹æ³•æŸ¥è¯¢æˆ‘ä»¬çš„ç”¨æˆ·é›†åˆï¼Œç¡®ä¿ä½¿ç”¨ **await** ã€‚ç„¶åæˆ‘ä»¬æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦å¾—åˆ°äº†ä¸€ä¸ªç”¨æˆ·ï¼Œä»¥åŠæä¾›çš„å¯†ç æ˜¯å¦ä¸æ•£åˆ—å¯†ç åŒ¹é…(è¿™é‡Œçš„é€»è¾‘é¡ºåºå¾ˆé‡è¦)ã€‚å¦‚æœæˆåŠŸï¼Œæˆ‘ä»¬å°†ç”¨æˆ·ä¼šè¯åŒ–ï¼Œå°†ä»–ä»¬çš„æ•°æ®å­˜å‚¨åœ¨ä¼šè¯å¯¹è±¡ä¸­ï¼Œå¹¶å°†ä»–ä»¬çš„ä¿¡æ¯å‘é€ç»™å®¢æˆ·ç«¯ã€‚å¦åˆ™ï¼Œæˆ‘ä»¬æ•æ‰ä»»ä½•é”™è¯¯ï¼Œæ— è®ºæ˜¯ä¸€ä¸ª **Joi** é”™è¯¯è¿˜æ˜¯æˆ‘ä»¬è¯´`new Error(â€˜Invalid login credentialsâ€™)`æ—¶æŠ›å‡ºçš„é”™è¯¯ï¼Œè®¾ç½®ä¸€ä¸ªå¤±è´¥çŠ¶æ€ä»£ç ï¼Œå¹¶å‘å›è§£æåçš„é”™è¯¯ã€‚***

***ä¸‹ä¸€æ­¥:æ³¨é”€ã€‚***

```
**--- backend/routes/session.js ---
...* **sessionRouter.delete("", ({ session }, res) => {
  try {
    const user = session.user;
    if (user) {
      session.destroy(err => {
        if (err) throw (err);** **res.clearCookie(SESS_NAME);
        res.send(user);
      });
    } else {
      throw new Error('Something went wrong');
    }
  } catch (err) {
    res.status(422).send(parseError(err));
  }
});
...***
```

***è¿™é‡Œæˆ‘ä»¬ä»è¯·æ±‚å¯¹è±¡ä¸­ææ„å‡º**ä¼šè¯**(å› ä¸ºæˆ‘ä»¬ä¸éœ€è¦ä»»ä½•å…¶ä»–ä¸œè¥¿)å¹¶å°†ç”¨æˆ·ä»è¯¥ä¼šè¯ä¸­æ‹‰å‡ºã€‚å¦‚æœæœ‰ï¼Œæˆ‘ä»¬è°ƒç”¨å†…ç½®çš„**é”€æ¯**æ–¹æ³•ã€‚
ç„¶åæˆ‘ä»¬åœ¨æˆ‘ä»¬çš„å“åº”ä¸Šè°ƒç”¨**clear cookie(***session _ name****)***æ–¹æ³•ï¼Œå°†ç”¨æˆ·å‘é€å›å®¢æˆ·ç«¯ã€‚***

***æˆ‘ä»¬çš„æœ€åä¸€ä¸ªç«¯ç‚¹åªæ˜¯æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•ã€‚è¿™ä¸ªå¾ˆç®€å•:***

```
**--- backend/routes/session.js ---
...* **sessionRouter.get("", ({ session: { user }}, res) => {
  res.send({ user });
});****export default sessionRouter;***
```

***æˆ‘ä»¬å°†è¯·æ±‚åˆ†è§£ç»™ç”¨æˆ·ã€‚è¿™è¦ä¹ˆæ˜¯æˆ‘ä»¬çš„ç”¨æˆ·ï¼Œè¦ä¹ˆæ˜¯æœªå®šä¹‰çš„ã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å‘é€å›ä¸€ä¸ª**ç”¨æˆ·**çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æŒ‡å‘æˆ‘ä»¬ä»ä¼šè¯ä¸­å¾—åˆ°çš„ä»»ä½•å†…å®¹ã€‚***

***æˆ‘ä»¬åªæœ‰ä¸¤ä¸ªä»»åŠ¡è¦å®Œæˆäº†ï¼åœ¨ **routes/index.js** ä¸­:***

```
**--- backend/routes/index.js ---* import userRoutes from './user';
**import sessionRoutes from './session';**export { userRoutes, **sessionRoutes** };*
```

***Annnnd in our **server.js** :***

```
**--- backend/server.js ---*
    ...
    const apiRouter = express.Router();
    app.use('/api', apiRouter);
    apiRouter.use('/users', userRoutes);
 **apiRouter.use('/session', sessionRoutes);
    ...***
```

***å°±æ˜¯è¿™æ ·ï¼æˆ‘ä»¬çš„åç«¯ç°åœ¨å®Œæˆäº†ï¼ğŸ‰ç»™è‡ªå·±ä¸€ä¸ªé¼“åŠ±ã€‚ä½ åˆšåˆšä»å¤´å¼€å§‹å†™äº†ä¸€ä¸ªåç«¯ï¼ğŸ‘***

# ***æ­¥éª¤ 6:ååº”/è¿˜åŸè®¾ç½®***

***åœ¨ç»§ç»­ä¹‹å‰ï¼Œå¦‚æœè¿™æ˜¯æ‚¨ç¬¬ä¸€æ¬¡ä½¿ç”¨ React å’Œ Reduxï¼Œè¿™äº›æ¦‚å¿µå¯èƒ½å¬èµ·æ¥æœ‰ç‚¹æ··ä¹±ï¼Œä½†æ˜¯ä¸è¦æ‹…å¿ƒï¼å®ƒä»¬éå¸¸é‡å¤ï¼Œåªæ˜¯éœ€è¦ç»ƒä¹ ã€‚å’Œå¾€å¸¸ä¸€æ ·ï¼Œæˆ‘å°†ä»é«˜å±‚æ¬¡ä¸Šè§£é‡Šäº‹æƒ…ï¼Œä½†å¦‚æœä½ æ„Ÿåˆ°å¤´æ™•ï¼Œæˆ‘å¼ºçƒˆæ¨è [React](https://reactjs.org/) å’Œ [Redux](https://redux.js.org/) æ–‡æ¡£ã€‚ä»–ä»¬å¤ªæ£’äº†ï¼æœ€åï¼Œæ³¨æ„*éšå¼è¿”å›*ã€‚æˆ‘ä»¬ä¼šç”¨åˆ°å¾ˆå¤šã€‚å‡†å¤‡å¥½äº†å—ï¼Ÿ***

***è®©æˆ‘ä»¬å°†ç›®å½•å‘ä¸Šåˆ‡æ¢åˆ°æˆ‘ä»¬çš„æ ¹é¡¹ç›®ç›®å½•ï¼Œ **SessionAuth** : `cd ..`
ç°åœ¨è¿è¡Œè¿™ä¸ªå‘½ä»¤:`npx create-react-app frontend` è¿™å°†è®¾ç½®ä¸€ä¸ª React åº”ç”¨ç¨‹åºï¼Œè€Œä¸éœ€è¦ä»»ä½•æ„å»ºé…ç½®ã€‚è¿™ç»™æˆ‘ä»¬åˆ¶é€ äº†ç›¸å½“å¤šçš„æ—¶é—´ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åšä¸€äº›æ¸…ç†å·¥ä½œã€‚
ä½ å¯ä»¥éšæ„ä¿ç•™ä»»ä½•ä½ æƒ³è¦/éœ€è¦çš„æ–‡ä»¶ã€‚æˆ‘å¯¹è¿™ä¸ªåº”ç”¨ç¨‹åºè¿›è¡Œäº†ç²¾ç®€ï¼Œä»¥ä¾¿å®ƒå¯ä»¥åœ¨æœªæ¥çš„åº”ç”¨ç¨‹åºä¸­é‡å¤ä½¿ç”¨ï¼Œæ²¡æœ‰ä»»ä½•è´Ÿæ‹…ã€‚æˆ‘åˆ é™¤äº†`public/**favicon.ico**, **manifest.json**, src/**App.css**, **App.test.js**, **index.css**, **logo.svg**, **serviceWorker.js**`ï¼Œå¹¶é‡æ–°æ•´ç†äº†æˆ‘çš„æ–‡ä»¶ç»“æ„ï¼Œå¦‚ä¸‹æ‰€ç¤º:***

```
*SessionAuth/
   |â€” backend/
   |â€” frontend/
      |â€” node_modules/
      |â€” public/
         |â€” index.html
      |â€” src/
         **|â€” actions/
         |â€” components/** |â€” App.js <= moved **|â€” reducers/**
 **|â€” errors/
            |â€” session/
         |â€” store/
         |â€” util/** |â€” index.js
 |â€” .gitignore
 |â€” package-lock.json
 |â€” package.json*
```

***æˆ‘ä¹Ÿç»™ index.html ä¿®å‰ªäº†ä¸€ä¸‹:***

```
**--- frontend/public/index.html ---* <!DOCTYPE *html*>
<html *lang*="en">
  <head>
    <meta *charset*="utf-8" />
    <meta
      *name*="viewport"
      *content*="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>**Session Auth**</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
  <div *id*="root"></div>
  </body>
</html>*
```

***ä¸‹ä¸€ç«™æ˜¯æˆ‘ä»¬çš„ **App.js** :***

```
**--- frontend/src/components/App.js ---* **import React from 'react';****export default () => (
  <>
    <h1>Hello world</h1>
  </>
);***
```

***åœ¨éå¸¸é«˜çš„å±‚é¢ä¸Šï¼Œ [**ç»„ä»¶**](https://reactjs.org/docs/components-and-props.html) åªæ˜¯è¿”å›[**ã€JSXã€‘**](https://reactjs.org/docs/introducing-jsx.html)çš„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°äº§ç”Ÿ **React å…ƒç´ **ï¼Œè¿™äº›å…ƒç´ éšåè¢«æ¸²æŸ“åˆ° DOM ä¸­ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬ä¸ä¼šä½¿ç”¨ä»»ä½•æœ‰çŠ¶æ€çš„ç»„ä»¶ã€‚
æˆ‘ä»¬å°†ä½¿ç”¨[ç‰‡æ®µ](https://reactjs.org/docs/fragments.html)ï¼Œå®ƒå…è®¸æˆ‘ä»¬å¯¹å…ƒç´ è¿›è¡Œåˆ†ç»„ï¼Œè€Œæ— éœ€å‘ DOM æ·»åŠ é¢å¤–çš„èŠ‚ç‚¹ã€‚è¿™é‡Œæˆ‘ä»¬ç”¨ä¸€ä¸ªæ¥å®‰ç½®æˆ‘ä»¬çš„ **h1** ã€‚æˆ‘ä»¬è¿‡ä¼šå„¿ä¼šå›åˆ°è¿™é‡Œã€‚***

***ç°åœ¨ä¸ºæˆ‘ä»¬çš„ **index.js** :***

```
**--- frontend/src/index.js ---* import React from 'react';
import ReactDOM from 'react-dom';
import App from '.**/components**/App';
// delete old imports we don't needReactDOM.render(
  <App />, 
  document.getElementById('root')
);*
```

***ç¨åæˆ‘ä»¬ä¼šåœ¨è¿™é‡Œæ·»åŠ æ›´å¤šçš„å†…å®¹ï¼Œä½†æ˜¯ç°åœ¨ï¼Œè¿™å·²ç»å¾ˆå¥½äº†ã€‚æˆ‘ä»¬æ­£åœ¨æ¸²æŸ“æ¥è‡ªæˆ‘ä»¬çš„**index.html**çš„`<div *id*=â€rootâ€></div>`å†…çš„ **App** ç»„ä»¶ï¼Œå®ƒåè¿‡æ¥æ¸²æŸ“é‚£ä¸ª **h1** ã€‚

è¿˜è®°å¾—æˆ‘ä»¬ä¸ºå®¢æˆ·ä¿å­˜**ç«¯å£ 3000** çš„æ—¶å€™å—ï¼Ÿå—¯ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦ä¸€ç§æ–¹æ³•è®©æˆ‘ä»¬çš„å®¢æˆ·ç«¯ä¸æˆ‘ä»¬çš„åç«¯è¿›è¡Œé€šä¿¡ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ª [**ä»£ç†**](https://facebook.github.io/create-react-app/docs/proxying-api-requests-in-development) ã€‚
åœ¨æˆ‘ä»¬çš„*å‰ç«¯*åº•éƒ¨ **package.json** æˆ‘ä»¬æ·»åŠ :***

```
**--- frontend/package.json ---* ...
     "browserslist": [
      ">0.2%",
      "not dead",
      "not ie <= 11",
      "not op_mini all"
    ],
  **"proxy": "http://localhost:5000"**
}*
```

***è¿™å‘Šè¯‰æˆ‘ä»¬çš„æœåŠ¡å™¨åœ¨æˆ‘ä»¬å‘â€œ/api/sessionâ€è¿™æ ·çš„ä¸œè¥¿å‘å‡ºè¯·æ±‚æ—¶ä½¿ç”¨æˆ‘ä»¬çš„åç«¯èµ„æºã€‚***

***ç°åœ¨ï¼Œ**åœ¨ä¸€ä¸ªå•ç‹¬çš„ç»ˆç«¯æ ‡ç­¾æˆ–çª—å£ä¸­ï¼Œ**ä¿æŒåç«¯æœåŠ¡å™¨è¿è¡Œï¼Œå°†ç›®å½•æ›´æ”¹åˆ°æˆ‘ä»¬çš„ **frontend/** æ–‡ä»¶å¤¹:`cd frontend/`ï¼Œå¹¶è¿è¡Œè¿™ä¸ªå‘½ä»¤:`npm start`
ç°åœ¨è½¬åˆ° [http://localhost:3000/](http://localhost:3000/) ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°â€œHello worldâ€ã€‚***

***ç°åœ¨åœ¨**å¦ä¸€ä¸ªå•ç‹¬çš„**ç»ˆç«¯æ ‡ç­¾æˆ–çª—å£ä¸­(ä½ ç°åœ¨åº”è¯¥è‡³å°‘æ‰“å¼€ä¸‰ä¸ª)ï¼Œç¡®ä¿ä½ åœ¨**å‰ç«¯/** ç›®å½•ä¸­å¹¶å®‰è£…è¿™äº›ä¾èµ–é¡¹:`npm i react-redux react-router-dom redux redux-thunk` å¥½çš„ã€‚ç°åœ¨ä¸€åˆ‡å°±ç»ªï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹é›†æˆ Redux äº†ï¼
è®©æˆ‘ä»¬ä»åœ¨ **util/session.js** ä¸­åˆ›å»º HTTP è¯·æ±‚å‡½æ•°å¼€å§‹:***

```
**--- frontend/util/session.js ---* **export const signup = user => (
  fetch("api/users", {
    method: "POST",
    body: JSON.stringify(user),
    headers: {
      "Content-Type": "application/json"
    }
  })
);****export const login = user => (
  fetch("api/session", {
    method: "POST",
    body: JSON.stringify(user),
    headers: {
      "Content-Type": "application/json"
    }
  })
);****export const logout = () => (
  fetch("api/session", { method: "DELETE" })
);***
```

***è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ [Fetch API](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch) æ¥è®¿é—®æˆ‘ä»¬çš„ä¸‰ä¸ªåç«¯ç«¯ç‚¹ã€‚è¿˜è®°å¾—æˆ‘ä»¬åœ¨ä½¿ç”¨ Postman çš„æ—¶å€™é€‰æ‹©äº†â€œ**åº”ç”¨/json** â€å—ï¼Ÿæˆ‘ä»¬æƒ³åœ¨è¿™é‡ŒåšåŒæ ·çš„äº‹æƒ…ï¼Œä½†æ˜¯æˆ‘ä»¬é€šè¿‡ä½¿ç”¨ **json.stringify()** æ¥ç¡®ä¿æˆ‘ä»¬è¯·æ±‚çš„**ä¸»ä½“**æ˜¯ JSON æ ¼å¼çš„ã€‚***

***åœ¨æˆ‘ä»¬ç»§ç»­å‰è¿›ä¹‹å‰ï¼Œè®©æˆ‘ä»¬æ¥è®¨è®ºä¸€ä¸‹æˆ‘ä»¬å¸Œæœ›å¦‚ä½•å¡‘é€ æˆ‘ä»¬çš„å‰ç«¯çŠ¶æ€â€”â€”æŒ‡çš„æ˜¯æˆ‘ä»¬çš„ Redux å­˜å‚¨ã€‚***

***å½“è€ƒè™‘çŠ¶æ€å½¢çŠ¶æ—¶ï¼Œé—®è¿™ä¸¤ä¸ªé—®é¢˜æ˜¯æœ‰å¥½å¤„çš„ã€‚åœ¨ä»»ä½•ç»™å®šæ—¶åˆ»ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºéœ€è¦è®¿é—®å“ªäº›æ•°æ®ï¼Ÿ
2ã€‚æˆ‘ä»¬å¦‚ä½•ä»¥ä¸€ç§[è§„èŒƒåŒ–](https://redux.js.org/recipes/structuring-reducers/normalizing-state-shape)çš„æ–¹å¼ç»„ç»‡è¿™äº›æ•°æ®ï¼Ÿ
ç”±äºè¿™ä¸ªåº”ç”¨ç¨‹åºå°†åªåŒ…æ‹¬è·Ÿè¸ªä¼šè¯å’Œæ³¨å†Œ/ç™»å½•é”™è¯¯ï¼Œä»¥ä¸‹æ˜¯æˆ‘ç°åœ¨çš„æƒ³æ³•:***

```
*{
  session: { id, username },
  errors: ""
}*
```

***æˆ‘ä»¬æŠŠå®ƒä¿æŒå¾—éå¸¸ç®€å•ã€‚
ç°åœ¨è®©æˆ‘ä»¬è®¾ç½®æˆ‘ä»¬çš„**è¡ŒåŠ¨**ã€‚åœ¨**åŠ¨ä½œ/** ä¸­åˆ›å»ºä¸€ä¸ª **session.js** :***

```
**--- frontend/actions/session.js ---* **import * as apiUtil from â€˜../util/sessionâ€™;****export const RECEIVE_CURRENT_USER = â€˜RECEIVE_CURRENT_USERâ€™;
export const LOGOUT_CURRENT_USER = â€˜LOGOUT_CURRENT_USERâ€™;****const receiveCurrentUser = user => ({
  type: RECEIVE_CURRENT_USER,
  user
});****const logoutCurrentUser = () => ({
  type: LOGOUT_CURRENT_USER
});
...***
```

***åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†è·å–å‡½æ•°ä½œä¸º **apiUtil** å¯¼å…¥ï¼Œå› æ­¤åœ¨ä½¿ç”¨**æ³¨å†Œ/ç™»å½•/æ³¨é”€**æ—¶ï¼Œæˆ‘ä»¬ä¸ä¼šæœ‰ä»»ä½•åç§°ç©ºé—´å†²çªã€‚
æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®šä¹‰ä¸¤ç§**åŠ¨ä½œç±»å‹**ï¼Œè¿™å°†å¸®åŠ©æˆ‘ä»¬çš„ reducers å†³å®šå¦‚ä½•å¤„ç†æˆ‘ä»¬çš„åŠ¨ä½œã€‚ä½¿ç”¨å­—ç¬¦ä¸²å¸¸é‡å¹¶å¯¼å‡ºå®ƒä»¬å¯ä»¥ç¡®ä¿æˆ‘ä»¬çš„ reducers ä¸ä¼šè®©ä¸€ä¸ªæ‰“å­—é”™è¯¯æ‚„æ‚„æºœèµ°ã€‚æ­¤å¤–ï¼Œå½“å¤„ç†è¾ƒå¤§çš„åº”ç”¨ç¨‹åºæ—¶ï¼Œæ‰€æœ‰è¿™äº›éƒ½å¯ä»¥æŠ½è±¡åˆ°ä¸€ä¸ª **actionTypes.js** æ–‡ä»¶ä¸­ã€‚ä¹‹åï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ª**åŠ¨ä½œ**ã€‚åŠ¨ä½œæ˜¯ JavaScript å¯¹è±¡ï¼Œä¸ºæˆ‘ä»¬çš„ Redux å­˜å‚¨æä¾›æ•°æ®è´Ÿè½½(åœ¨æœ¬ä¾‹ä¸­æ¥è‡ªæˆ‘ä»¬çš„åç«¯)ã€‚***

***ç¨åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸­é—´ä»¶ï¼Œå®ƒæ ¹æ®å¯¹è±¡æ˜¯*å‡½æ•°*è¿˜æ˜¯ *POJO* (æ™®é€šçš„ ol' JavaScript å¯¹è±¡)è¿™ä¸€å‰ææ¥å†³å®šæ˜¯è¿›è¡Œæ›´å¤šçš„ API è°ƒç”¨è¿˜æ˜¯è¿›å…¥ä¸‹ä¸€æ­¥â€”â€”reducersã€‚
ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†å®šä¹‰**åŠ¨ä½œåˆ›å»ºè€…ï¼Œ**æˆ‘ä»¬çš„ç»„ä»¶å°†**åˆ†æ´¾**å“ªäº›åŠ¨ä½œåˆ›å»ºè€…ä»åç«¯æ”¶é›†èµ„æºã€‚
åœ¨è¿™äº›è¯·æ±‚å‘å‡ºåï¼Œè¿™äº›**åŠ¨ä½œåˆ›å»ºè€…**å°†ä¼š**åˆ†æ´¾**æˆ‘ä»¬çš„**åŠ¨ä½œ**ã€‚ç„¶å**reducer**å°†è¿‡æ»¤æ•°æ®ï¼Œå¹¶åœ¨æˆ‘ä»¬çš„ Redux å­˜å‚¨ä¸­åˆ†é…å®ƒçš„ä½ç½®ã€‚***

***å¥½å§ï¼Œé‚£ä¹ˆâ€¦è®©æˆ‘ä»¬æ¥å®šä¹‰è¿™äº›åŠ¨ä½œåˆ›å»ºè€…:***

```
**--- frontend/actions/session.js ---* **...
export const login = user => async dispatch => {
  const response = await apiUtil.login(user);
  const data = await response.json();****if (response.ok) {
    return dispatch(receiveCurrentUser(data));
  }
  // todo: handle errors
};****export const signup = user => async dispatch => {
  const response = await apiUtil.signup(user);
  const data = await response.json();

  if (response.ok) {
    return dispatch(receiveCurrentUser(data));
  }
  // todo: handle errors
};****export const logout = () => async dispatch => {
  const response = await apiUtil.logout();
  const data = await response.json();****if (response.ok) {
    return dispatch(logoutCurrentUser());
  }
  // todo: handle errors
};***
```

***è¿™ä¸‰ä¸ªå‡½æ•°éµå¾ªç›¸åŒçš„é€»è¾‘:è¿”å›ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œè¯¥å‡½æ•°å°† **dispatch** ä½œä¸ºå‚æ•°ï¼Œå‘å‡ºä¸€ä¸ª HTTP è¯·æ±‚ï¼Œå¹¶ä»å“åº”ä¸­æå–æ•°æ®ã€‚
å¦‚æœå“åº”æ²¡é—®é¢˜(200 çº§)ï¼Œè°ƒåº¦ä¸€ä¸ª**åŠ¨ä½œ**æˆ‘ä»¬ä¸Šé¢å®šä¹‰çš„æœ‰æ•ˆè½½è·ã€‚å¦‚æœå“åº”ä¸æ­£å¸¸ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¤„ç†é”™è¯¯ã€‚è¿™æ ·æƒ³è±¡ä¼šæœ‰æ‰€å¸®åŠ©:***

```
*export const login = function(user) {
  return async function(dispatch) {
    ...
  };
};*
```

***ä½†æ˜¯å› ä¸ºæˆ‘ä»¬æ˜¯ JavaScript ä¸“å®¶ï¼Œæˆ‘ä»¬å°†ä¿æŒå®ƒçš„ ESNextã€‚
è®©æˆ‘ä»¬è¿…é€Ÿæ‰¾åˆ°å¤„ç†è¿™äº›é”™è¯¯çš„æ–¹æ³•ã€‚åœ¨æˆ‘ä»¬çš„ **actions/** æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ª **error.js** :***

```
**--- frontend/actions/error.js ---* **export const RECEIVE_ERRORS = 'RECEIVE_ERRORS';
export const CLEAR_ERRORS = 'CLEAR_ERRORS';****export const receiveErrors = ({ message }) => ({
  type: RECEIVE_ERRORS,
  message
});****export const clearErrors = () => ({
  type: CLEAR_ERRORS
});***
```

***åŒæ ·çš„æ¨¡å¼ã€‚ç°åœ¨ï¼Œå›åˆ°æˆ‘ä»¬çš„**ä¼šè¯ã€‚js** :***

```
**--- frontend/actions/session.js ---* import * as apiUtil from â€˜../util/sessionâ€™; **import { receiveErrors } from "./error";
...** if (response.ok) {
    return dispatch(receiveCurrentUser(data));
  } **return dispatch(receiveErrors(data));**
};
...
if (response.ok) {
    return dispatch(receiveCurrentUser(data));
  } **return dispatch(receiveErrors(data));**
};
...
if (response.ok) {
    return dispatch(logoutCurrentUser());
  } **return dispatch(receiveErrors(data));** };*
```

***æˆ‘ä»¬çš„è¡ŒåŠ¨ç»“æŸäº†ï¼ğŸ’ª***

***è®©æˆ‘ä»¬å¼€å§‹æˆ‘ä»¬çš„å‡é€Ÿå™¨ï¼åœ¨ **reducers/root.js** ä¸­:***

```
**--- frontend/reducers/root.js ---* **import { combineReducers } from 'redux';
import errors from './errors/errors';
import session from './session/session';****export default combineReducers({
  session,
  errors
});***
```

***æˆ‘ä»¬è¿˜æ²¡æœ‰åˆ›å»ºæˆ‘ä»¬çš„**é”™è¯¯**å’Œ**ä¼šè¯**å‡å°‘å™¨ï¼Œä½†æ˜¯**ç»„åˆå‡å°‘å™¨**åšäº†æˆ‘ä»¬åœ¨è¿™é‡Œæ‰€æœŸæœ›çš„äº‹æƒ…ã€‚å®ƒç»“åˆäº†æˆ‘ä»¬çš„å‡é€Ÿå™¨ï¼Œå°†å®ƒä»¬æ”¾åœ¨æˆ‘ä»¬å‰ç«¯çŠ¶æ€çš„*ç›¸åŒæ·±åº¦æ°´å¹³*ã€‚è¿™äº›å¯ä»¥åµŒå¥—å¾—æ›´æ·±ï¼Œå°½ç®¡åµŒå¥—å¤ªæ·±çš„çŠ¶æ€ä¼šäº§ç”Ÿä»£ç å‘³é“ã€‚ä½ ç»å¸¸ä¼šåœ¨è¿™é‡Œçœ‹åˆ°ä¸€ä¸ª**å®ä½“**ç¼©å‡å™¨ï¼Œå®ä½“ç¼©å‡å™¨å°†ä¼šåˆå¹¶æ›´å¤šçš„ç¼©å‡å™¨ï¼Œæ¯”å¦‚ç”¨æˆ·ã€å¸–å­ç­‰ç­‰â€¦***

***ç°åœ¨è®©æˆ‘ä»¬åˆ›å»ºè¿™ä¸¤ä¸ªå‡é€Ÿå™¨ã€‚è®©æˆ‘ä»¬åœ¨ **reducers/** ä¸­åˆ›å»ºå¦ä¸€ä¸ª **session.js** æ–‡ä»¶:***

```
**--- frontend/reducers/session/session.js ---* **import {
  RECEIVE_CURRENT_USER,
  LOGOUT_CURRENT_USER
} from "../../actions/session";****const _nullSession = { userId: null, username: null }**
**export default (state = _nullSession, { type, user }) => {
  Object.freeze(state);
  switch (type) {
    case RECEIVE_CURRENT_USER:
      return user;
    case LOGOUT_CURRENT_USER:
      return _nullSession;
    default:
      return state;
  }
};***
```

***æˆ‘ä»¬ç¨å¾®è®¨è®ºä¸€ä¸‹è¿™ä¸ªã€‚**ç¼©å‡å™¨**æ˜¯ä¸€ä¸ªæ¥å—ä¸¤ä¸ªå‚æ•°çš„å‡½æ•°â€”â€”å½“å‰çŠ¶æ€å’ŒåŠ¨ä½œã€‚å…³äºå‡é€Ÿå™¨æˆ‘æƒ³æŒ‡å‡ºä¸‰ç‚¹:
1ã€‚å®ƒä»¬è¿›å…¥*çš„çŠ¶æ€å¹¶ä¸æ˜¯æ•´ä¸ªçŠ¶æ€*ã€‚ä¾‹å¦‚ï¼Œ*è¿™ä¸ª* **ä¼šè¯**å‡é€Ÿå™¨*ä¸èƒ½*å½±å“æˆ‘ä»¬**é”™è¯¯**çš„çŠ¶æ€å½¢çŠ¶æˆ–çŠ¶æ€çš„ä»»ä½•å…¶ä»–éƒ¨åˆ†ã€‚åªæœ‰**ä¼šè¯**ã€‚
2ã€‚*æ¯ä¸€ä¸ªåŠ¨ä½œéƒ½å‡»ä¸­æ¯ä¸€ä¸ªå‡é€Ÿå™¨*ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ‰€æœ‰çš„åŠ¨ä½œéƒ½æœ‰ä¸€ä¸ª**ç±»å‹**å±æ€§ï¼Œä»¥åŠä¸ºä»€ä¹ˆ reducers ä½¿ç”¨ switch è¯­å¥ã€‚
3ã€‚**åƒä¸‡ä¸è¦çªå˜çŠ¶æ€ã€‚** *æ°¸ä¸çªå˜çš„çŠ¶æ€ã€‚*è®© Redux åšå®ƒçš„äº‹ã€‚***

***è¿™æ ·ä¸€æ¥ï¼Œè¿™é‡Œçš„ä»£ç å°±ä¸ä¼šå¤ªå·®äº†ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å¯¼å…¥åŠ¨ä½œç±»å‹ã€‚ç„¶åæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª **_nullSession** ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä¸€ç›´è°ƒç”¨**ã€‚ç”¨æˆ·å**æˆ–**ã€‚å¦‚æœæ²¡æœ‰ç”¨æˆ·ç™»å½•ï¼Œå°±ä¸ä¼šå‡ºé”™ã€‚
æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»™ä¼ å…¥çŠ¶æ€ä¸€ä¸ªé»˜è®¤å€¼â€”â€”æˆ‘ä»¬çš„ç©ºä¼šè¯â€”â€”å¹¶ææ„ action å¯¹è±¡ã€‚æˆ‘ä»¬è¿˜å†»ç»“äº†çŠ¶æ€ï¼Œè¿™é˜²æ­¢äº†ä»»ä½•æ„å¤–çš„çªå˜ï¼Œå¹¶è®©å…¶ä»–äººçŸ¥é“ä»–ä»¬æ­£åœ¨ä½¿ç”¨æˆ‘ä»¬çš„ä»£ç ï¼Œâ€œåé€€ï¼â€
å¼€ä¸ªç©ç¬‘ã€‚ä½†å®ƒæ¸…æ¥šåœ°è¡¨æ˜ã€‚
æœ€åï¼Œæ ¹æ®åŠ¨ä½œ**ç±»å‹**ï¼Œæˆ‘ä»¬è¿”å›çš„ä»£ç å¯èƒ½ä¼šä¹Ÿå¯èƒ½ä¸ä¼šæ”¹å˜æˆ‘ä»¬çš„ Redux å­˜å‚¨ã€‚*****

***æˆ‘ä»¬çš„è¯¯å·®å‡å°‘å™¨å°†éå¸¸ç›¸ä¼¼ã€‚**reducers/errors/errors . js**:***

```
**--- frontend/reducers/errors/errors.js ---* **import { RECEIVE_CURRENT_USER } from "../../actions/session";
import { CLEAR_ERRORS, RECEIVE_ERRORS } from "../../actions/error";****export default (state = "", { message, type }) => {
  Object.freeze(state);
  switch (type) {
    case RECEIVE_ERRORS:
      return message;
    case RECEIVE_CURRENT_USER:
    case CLEAR_ERRORS:
      return "";
    default:
      return state;
  }
};***
```

***è¿™é‡Œå”¯ä¸€çš„åŒºåˆ«æ˜¯ï¼Œå½“æˆ‘ä»¬æ¥æ”¶å½“å‰ç”¨æˆ·æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿä¼šæ¸…é™¤é”™è¯¯ã€‚è¿™å°±æ˜¯ä½ ç»å¸¸ä¼šçœ‹åˆ°ä¸åŒçš„åŠ¨ä½œè§¦å‘çŠ¶æ€çš„ä¸åŒéƒ¨åˆ†ã€‚***

***å”‰ï¼Œæˆ‘ä»¬å¿«æ»¡è¶³ Redux äº†â€¦
è®©æˆ‘ä»¬åˆ›å»ºæˆ‘ä»¬çš„ **store/store.js** :***

```
**--- frontend/store/store.js ---* **import { createStore, applyMiddleware } from "redux";
import thunk from "redux-thunk";
import reducer from "../reducers/root";****export default preloadedState => (
  createStore(
    reducer,
    preloadedState,
    applyMiddleware(thunk)
  )
);***
```

***è¿™æ˜¯å°†æ‰€æœ‰ä¸œè¥¿ç»“åˆåœ¨ä¸€èµ·çš„ä¸œè¥¿ã€‚ **createStore** ï¼Œå—¯ï¼Œåˆ›å»ºæˆ‘ä»¬çš„ Redux storeï¼Œå®ƒåŒ…å«æˆ‘ä»¬ç²¾å¿ƒåˆ¶ä½œçš„å‰ç«¯çŠ¶æ€ã€‚Redux Thunk æ˜¯å¸®åŠ©æˆ‘ä»¬ç®€åŒ–å¼‚æ­¥æ“ä½œçš„ä¸­é—´ä»¶ã€‚æˆ‘ä»¬å¯¼å‡ºä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªé¢„åŠ è½½çŠ¶æ€ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›æˆ‘ä»¬çš„å­˜å‚¨ã€‚è¿™ä¸ª**é¢„åŠ è½½çŠ¶æ€**æ˜¯æˆ‘ä»¬ä¿æŒç”¨æˆ·ç™»å½•çš„æ–¹å¼ã€‚***

***ç°åœ¨è®©æˆ‘ä»¬é€šè¿‡å‰å¾€æˆ‘ä»¬çš„ **index.js** å°† Redux æ’å…¥æˆ‘ä»¬çš„åº”ç”¨ç¨‹åº:***

```
**--- frontend/src/index.js ---* import React from 'react';
import ReactDOM from 'react-dom';
import App from './components/App';
**import configureStore from './store/store';
import { Provider } from "react-redux";****let preloadedState = {};
const store = configureStore(preloadedState);**ReactDOM.render(
  **<Provider *store*={store}>**
    <App />
 **</Provider>,**
  document.getElementById("root")
);
***// FOR TESTING, remove before production* window.getState = store.getState;***
```

***æˆ‘ä»¬å¯¼å…¥æˆ‘ä»¬åœ¨ **store.js** å’Œ **Provider** ä¸­åˆ›å»ºçš„å‡½æ•°ã€‚æˆ‘ä»¬è®©é¢„åŠ è½½çŠ¶æ€ç°åœ¨ç­‰äºä¸€ä¸ªç©ºå¯¹è±¡ï¼Œå¹¶å®šä¹‰æˆ‘ä»¬çš„**å­˜å‚¨**ã€‚é€šè¿‡å°†æˆ‘ä»¬çš„**åº”ç”¨**åŒ…è£…åœ¨**æä¾›è€…**ä¸­ï¼Œå¹¶å°†**å•†åº—**ä½œä¸ºé“å…·ä¼ é€’ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åº”ç”¨çš„ä»»ä½•åœ°æ–¹è®¿é—®æˆ‘ä»¬çš„ Redux å•†åº—ã€‚ **Props** å¯ä»¥è¢«è®¤ä¸ºæ˜¯æä¾›ç»™ç»„ä»¶çš„å‚æ•°ï¼Œå› ä¸ºå®ƒä»¬æ˜¯é€šè¿‡ **prop** å¯¹è±¡è®¿é—®çš„ã€‚
æœ€åï¼Œæˆ‘ä»¬å°† **getState** æ–¹æ³•ä¿å­˜åˆ°çª—å£ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥åœ¨æ§åˆ¶å°ä¸­çœ‹åˆ°æˆ‘ä»¬çš„çŠ¶æ€ï¼Œç„¶è€Œå¯¹äºæ›´å¤§çš„åº”ç”¨ç¨‹åºï¼Œæˆ‘æ¨è [redux-logger](https://github.com/LogRocket/redux-logger) ã€‚***

***è®©æˆ‘ä»¬å‰å¾€ [http://localhost:3000/](http://localhost:3000/) ä»¥ç¡®ä¿ä¸€åˆ‡ä»ç„¶æ­£å¸¸ï¼Œå¹¶å°è¯•æˆ‘ä»¬çš„ **getState** å‡½æ•°ã€‚***

***![](img/7bc437e8cbdc8c4918e8ed41568f92f1.png)***

***ä½¿ç”¨è°·æ­Œ Chrome å¼€å‘è€…å·¥å…·ï¼Œ
Windows: `CTRL-SHIFT-J`æˆ–`F12`
Mac: `âŒ¥-âŒ˜-J`ï¼Œ
æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„çŠ¶æ€ï¼***

***Redux ç°åœ¨å‡†å¤‡å¥½æ‘‡æ»šäº†ï¼ç¬¬ 6 æ­¥åˆ°æ­¤ç»“æŸï¼ğŸ˜…***

# ***ç¬¬ä¸ƒæ­¥:ç»„ä»¶***

*****è¿™æ˜¯æœ€åä¸€æ­¥ã€‚æˆ‘ä»¬çš„æ—…ç¨‹å³å°†ç»“æŸã€‚æˆ‘ä»¬æ‰€è¦åšçš„å°±æ˜¯åˆ›å»ºä¸€äº›ç»„ä»¶ï¼Œä¸ºå…¶ä¸­ä¸€äº›ç»„ä»¶æ·»åŠ ä¿æŠ¤ï¼Œå¹¶å®ç°ä¸€ç§æ–¹æ³•ï¼Œè®©ç”¨æˆ·åœ¨åˆ·æ–°é¡µé¢æ—¶ä¿æŒç™»å½•ã€‚
è®©æˆ‘ä»¬ä»ç»„ä»¶å¼€å§‹â€”â€”æ€»å…±æœ‰äº”ä¸ªç»„ä»¶ï¼ŒåŒ…æ‹¬ **App.js** ã€‚
åˆ›å»ºä¸€ä¸ª**ç»„ä»¶/Welcome.js** :*****

```
**--- frontend/src/components/Welcome.js ---* **import React from 'react';
import { Link } from 'react-router-dom';****export default () => (
  <>
    <h1>Welcome!</h1>
    <Link to='/login'>Login</Link>
    <Link to='/signup'>Signup</Link>
    <Link to='/dashboard'>Dashboard</Link>
  </>
);***
```

***ä¸€å¦‚æ—¢å¾€ï¼Œæˆ‘ä»¬ä»è¿›å£å¼€å§‹ã€‚ **Link** é™¤äº†å…¶è·¯å¾„æ˜¯ç»å¯¹çš„ä¹‹å¤–ï¼Œå…¶è¡Œä¸ºå°±åƒä¸€ä¸ªé”šæ ‡ç­¾ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬ä½¿ç”¨å¦ä¸€ä¸ªç‰‡æ®µï¼Œæ·»åŠ ä¸€æ¡æ¬¢è¿æ¶ˆæ¯å’Œä¸‰ä¸ªé“¾æ¥ã€‚å¾ˆç®€å•ã€‚
æ¥ä¸‹æ¥æ˜¯ **components/Signup.js** ã€‚æˆ‘æŠŠå®ƒåˆ†æˆä¸‰ä»½:***

```
**--- frontend/src/components/Signup.js ---* **import React from "react";
import { connect } from "react-redux";
import { Link } from "react-router-dom";
import { signup } from "../actions/session";****const mapStateToProps = ({ errors }) => ({
  errors
});****const mapDispatchToProps = dispatch => ({
  signup: user => dispatch(signup(user))**
**});
.**..*
```

***æˆ‘ä»¬è¿›å£ä¸­å”¯ä¸€çš„æ–°æ¥è€…æ˜¯**é€šã€‚è¿™ä¸ªå‡½æ•°å°†å…è®¸æˆ‘ä»¬çš„ç»„ä»¶è®¿é—®æˆ‘ä»¬çš„ Redux å­˜å‚¨ã€‚æˆ‘ä»¬æ¥ç€å®šä¹‰ä¸¤ä¸ªå‡½æ•°:
**mapStateToProps**ï¼›è¿™å°†**çŠ¶æ€**ä½œä¸ºä¸€ä¸ªå‚æ•°ï¼Œå¹¶è®©æˆ‘ä»¬çš„ç»„ä»¶è®¿é—® Redux å­˜å‚¨çš„ç‰¹å®šéƒ¨åˆ†(åœ¨æœ¬ä¾‹ä¸­æ˜¯æˆ‘ä»¬çš„é”™è¯¯)ã€‚
**mapdispatctoprops**ï¼›è¿™å°†**åˆ†æ´¾**ä½œä¸ºä¸€ä¸ªå‚æ•°ï¼Œå¹¶èµ‹äºˆæˆ‘ä»¬çš„ç»„ä»¶åˆ†æ´¾æˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„**åŠ¨ä½œ**çš„èƒ½åŠ›ã€‚
æˆ‘ä»¬ç»§ç»­:*****

```
**--- frontend/src/components/Signup.js ---* ...
**const Signup = ({ errors, signup }) => {
  const handleSubmit = e => {
    e.preventDefault();
    const user = {
      username: e.target[0].value,
      email: e.target[1].value,
      password: e.target[2].value
    };
    signup(user);
  };** **return (
    <>
      <h1>Signup</h1>
      <p>{errors}</p>
      <form onSubmit={handleSubmit}>
        <label>
          Username:
          <input type="text" name="username" />
        </label>
        <label>
          Email:
          <input type="email" name="email" />
        </label>
        <label>
          Password:
          <input type="password" name="password" />
        </label>
        <input type="submit" value="Submit" />
      </form>
      <Link to="/login">Login</Link>
    </>
    );
  };**
...*
```

***è¿™çœ‹èµ·æ¥æœ‰ç‚¹å¯æ€•ï¼Œä½†è¿™é‡Œå¹¶æ²¡æœ‰å‘ç”Ÿå¤ªå¤šçš„äº‹æƒ…ã€‚è¿™æ˜¯æˆ‘ä»¬åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­å®é™…çš„**ç»„ä»¶**ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬æ¥å—**é“å…·**ä½œä¸ºå‚æ•°ï¼Œå¹¶ææ„æˆ‘ä»¬éœ€è¦çš„ä¸œè¥¿ã€‚è¿™äº›æ¥è‡ªäº**mapStateToProps**/**mapDispatchToPropsã€‚**
æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæäº¤å¤„ç†å‡½æ•°ï¼Œå…¶ä¸­â€œ**e**â€**æ˜¯äº‹ä»¶å¯¹è±¡ã€‚æˆ‘ä»¬é˜»æ­¢é»˜è®¤è¡Œä¸º(åˆ·æ–°é¡µé¢)ï¼Œé€šè¿‡ä»è¡¨å•ä¸­æå–è¾“å…¥å€¼æ¥åˆ›å»ºä¸€ä¸ª**ç”¨æˆ·**å¯¹è±¡ï¼Œå¹¶è°ƒç”¨æˆ‘ä»¬çš„**ç™»å½•**å‡½æ•°ã€‚
é€šå¸¸ï¼Œä½ ä¼šæƒ³è¦ä¸€ä¸ª[å—æ§ç»„ä»¶](https://reactjs.org/docs/forms.html#controlled-components)åœ¨è¿™é‡Œï¼Œä½†æ˜¯æˆ‘ä»¬ä¿æŒäº‹æƒ…ç®€å•ã€‚
æœ€åï¼Œæˆ‘ä»¬å½’è¿˜æˆ‘ä»¬çš„ JSXã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªæ ‡é¢˜ã€æˆ‘ä»¬çš„é”™è¯¯*ã€ä¸€ä¸ªè¡¨å•å’Œå¦ä¸€ä¸ªé“¾æ¥ã€‚*è¿™äº›æ˜¯æ¥è‡ªæˆ‘ä»¬ Redux å•†åº—çš„é”™è¯¯ã€‚å¦‚æœæ²¡æœ‰ï¼ŒReact ä¸ä¼šæ¸²æŸ“ä»»ä½•ä¸œè¥¿ã€‚èŠ±æ‹¬å·æ˜¯æˆ‘ä»¬åœ¨ç»„ä»¶è¿”å›è¯­å¥ä¸­æ·»åŠ  JavaScript ä»£ç çš„æ–¹å¼ã€‚
æ³¨æ„åˆ°`<form onSubmit={handleSubmit}>`ï¼Ÿè¿™å°†åœ¨æˆ‘ä»¬çš„è¡¨å•ä¸Šæ”¾ç½®ä¸€ä¸ª **onsubmit** äº‹ä»¶ï¼Œä¼ é€’æˆ‘ä»¬åœ¨ä¸Šé¢å®šä¹‰çš„å‡½æ•°ä½œä¸ºå›è°ƒã€‚
æœ€åä¸€ç‚¹:*****

```
****--- frontend/src/components/Signup.js ---* ...
**export default connect(
  mapStateToProps,
  mapDispatchToProps
)(Signup);*****
```

*****è¿™å°±æ˜¯è¿æ¥æ˜¯å¦‚ä½•å‘ç”Ÿçš„ã€‚è¿™é‡Œæˆ‘ä»¬å°†æˆ‘ä»¬çš„**æ³¨å†Œ**ç»„ä»¶â€œè¿æ¥â€åˆ° Redux å•†åº—ã€‚*****

*****ç°åœ¨ï¼Œè®©æˆ‘ä»¬åˆ›å»ºæˆ‘ä»¬çš„**ç»„ä»¶/Login.js** æ–‡ä»¶:*****

```
****--- frontend/src/components/Login.js ---* **import React from "react";
import { connect } from "react-redux";
import { Link } from "react-router-dom";
import { login } from "../actions/session";****const mapStateToProps = ({ errors }) => ({
  errors
});****const mapDispatchToProps = dispatch => ({
  login: user => dispatch(login(user))
});****const Login = ({ errors, login }) => {
  const handleSubmit = e => {
    e.preventDefault();
    const user = {
      email: e.target[0].value,
      password: e.target[1].value,
    };
    login(user);
  }** **return (
    <>
      <h1>Login</h1>
      <p>{errors}</p>
      <form onSubmit={handleSubmit}>
        <label>
          Email:
          <input type="email" name="email" />
        </label>
        <label>
          Password:
          <input type="password" name="password" />
        </label>
        <input type="submit" value="Submit" />
      </form>
      <Link to="/signup">Signup</Link>
    </>
  );
};****export default connect(
  mapStateToProps,
  mapDispatchToProps
)(Login);*****
```

*****è¿™é‡Œå”¯ä¸€çš„ä¸åŒæ˜¯æˆ‘ä»¬å¯¼å…¥äº†**ç™»å½•**è€Œä¸æ˜¯æ³¨å†Œï¼Œå¹¶ä¸”å°‘äº†ä¸€ä¸ªè¡¨å•å­—æ®µã€‚*****

*****å¹²å¾—å¥½ï¼
è®©æˆ‘ä»¬ç»§ç»­æˆ‘ä»¬çš„**ç»„ä»¶/Dashboard.js** :*****

```
****--- frontend/src/components/Dashboard.js ---* **import React from "react";
import { connect } from "react-redux";
import { logout } from "../actions/session";****const mapStateToProps = ({ session }) => ({
  session
});****const mapDispatchToProps = dispatch => ({
  logout: () => dispatch(logout())
});****const Dashboard = ({ logout, session }) => (
  <>
    <h1>Hi {session.username}</h1>
    <p>You are now logged in!</p>
    <button onClick={logout}>Logout</button>
  </>
);****export default connect(
  mapStateToProps,
  mapDispatchToProps
)(Dashboard);*****
```

*****æ³¨æ„åˆ°æ¨¡å¼äº†å—ï¼Ÿæˆ‘ä»¬åšåŒæ ·çš„äº‹æƒ…æ˜ å°„çŠ¶æ€å’Œåˆ†æ´¾åˆ°é“å…·å’Œè¿æ¥æˆ‘ä»¬çš„ç»„ä»¶åœ¨åº•éƒ¨ã€‚æˆ‘ä»¬ä½¿ç”¨ä¼šè¯ä¿¡æ¯é€šè¿‡ç”¨æˆ·åé—®å€™ç”¨æˆ·ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªæŒ‰é’®è®©ç”¨æˆ·æ³¨é”€ã€‚*****

*****æœ€åï¼Œæˆ‘ä»¬æ›´æ–°æˆ‘ä»¬çš„ **App.js** :*****

```
****--- frontend/src/components/App.js ---* import React from "react"; **import { Route } from "react-router-dom";
import Welcome from "./Welcome";
import Login from "./Login";
import Signup from "./Signup";
import Dashboard from "./Dashboard";**export default () => (
  <> **<Route exact path="/" component={Welcome} />
    <Route path="/login" component={Login} />
    <Route path="/signup" component={Signup} />
    <Route path="/dashboard" component={Dashboard} />**  </>
);***
```

*****ğŸ¤”å—¯ï¼Œæˆ‘ä»¬è¿›å£æˆ‘ä»¬çš„ç»„ä»¶ï¼Œä½†è¿™æ˜¯ä»€ä¹ˆ**è·¯çº¿**çš„äº‹æƒ…ï¼Ÿå½“ URL ä¸**è·¯å¾„**åŒ¹é…æ—¶ï¼Œ**è·¯ç”±**ç»„ä»¶æ¥å—ä¸€ä¸ª**ç»„ä»¶**å±æ€§ã€‚â€œ **exact** â€æ ‡å¿—æŒ‡å®šè·¯å¾„å¿…é¡»å®Œå…¨æ˜¯â€œ/â€ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªï¼Œæˆ‘ä»¬çš„ **Welcome** ç»„ä»¶å°†åœ¨æ¯ä¸ªé¡µé¢ä¸Šå‘ˆç°ï¼Œå› ä¸ºæ‰€æœ‰è·¯å¾„éƒ½ä»¥â€œ/â€å¼€å¤´ã€‚(è¿™å¯èƒ½å¯¹**å¯¼èˆª**ç»„ä»¶æœ‰ç”¨ï¼)*****

*****ç„¶è€Œï¼Œä¸ºäº†ä½¿ç”¨**è·¯å¾„**ï¼Œæˆ‘ä»¬å¿…é¡»å°†**åº”ç”¨**åŒ…è£…åœ¨å…¶ä¸­ï¼Œå°±åƒæˆ‘ä»¬å¯¹**æä¾›è€…**æ‰€åšçš„é‚£æ ·:*****

```
****--- frontend/src/index.js ---
...* **import { BrowserRouter } from "react-router-dom";**
*...*
ReactDOM.render(
  <Provider *store*={store}>
    **<BrowserRouter>**
      <App />
    **</BrowserRouter>**
</Provider>,
  document.getElementById("root")
);
***...******
```

*****![](img/31d7606d1cc0ae2eb07b2b8036d1eeee.png)*****

*****åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„è·¯çº¿å’Œç½‘é¡µçš„å·¥ä½œã€‚è®©æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹æˆ‘ä»¬çš„é”™è¯¯:*****

*****![](img/243d0b3f7a1a50547e30213d33d3756b.png)*****

*****ä¸é”™ï¼å¥½å§ï¼Œå¦‚æœæˆ‘è¯•ç€æ³¨å†Œå‘¢ï¼Ÿä¼¼ä¹ä»€ä¹ˆéƒ½æ²¡å‘ç”Ÿâ€¦è¿˜æ˜¯çœŸçš„å‘ç”Ÿäº†ï¼Ÿ*****

*****![](img/82dfa6a2bb0191599970b9097f2a8c96.png)*****

*****å¦‚æœæˆ‘ä»¬åœ¨ Chrome æ§åˆ¶å°ä¸­å†æ¬¡æŸ¥çœ‹æˆ‘ä»¬çš„çŠ¶æ€ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒç¡®å®è®©ç”¨æˆ·ç™»å½•äº†ã€‚å¦‚æœæˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬çš„é¥¼å¹²:*****

*****![](img/692fa2d30d4596a7fdae5bec720cbf7e.png)*****

*****æˆ‘ä½¿ç”¨çš„æ˜¯ [Edit This Cookie](https://chrome.google.com/webstore/detail/editthiscookie/fngmhnnpilhplaeedifhccceomclgfbg?hl=en) Chrome æ‰©å±•ï¼Œä½†è¿™ä¹Ÿå¯ä»¥ä½¿ç”¨ Chrome å¼€å‘è€…å·¥å…·æŸ¥çœ‹ã€‚
æˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬çš„é¥¼å¹²åœ¨é‚£é‡Œï¼*****

*****å¦‚æœæˆ‘å¯¼èˆªåˆ°ä»ªè¡¨æ¿(é€šè¿‡æ‰‹åŠ¨é”®å…¥ URL)å¹¶æ³¨é”€ï¼Œcookie å°±ä¼šæ¶ˆå¤±ã€‚æˆ‘ä»¬çš„åç«¯å·¥ä½œï¼
ä½†æ˜¯æˆ‘ä»¬çš„ç½‘ç«™æœ‰ç‚¹é—®é¢˜â€¦â€¦
è®©æˆ‘ä»¬æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚*****

*****æˆ‘ä»¬çš„ä¸‹ä¸€æ­¥æ˜¯åˆ›å»º**ä¿æŠ¤è·¯ç”±**å’Œ**æˆæƒè·¯ç”±**ã€‚å—ä¿æŠ¤çš„è·¯ç”±å°†ä¸å…è®¸å·²æ³¨é”€çš„ç”¨æˆ·è®¿é—®å®ƒä»¬ï¼Œå¹¶å°†å®ƒä»¬é‡å®šå‘åˆ°ç™»å½•é¡µé¢ã€‚æˆæƒè·¯ç”±å°†ä¸å…è®¸å·²ç™»å½•çš„ç”¨æˆ·è®¿é—®ç™»å½•/æ³¨å†Œé¡µé¢ã€‚å¦‚æœæœ‰ï¼Œæˆ‘ä»¬ä¼šå°†å®ƒä»¬é‡å®šå‘åˆ°ä»ªè¡¨æ¿ã€‚ä»æ¦‚å¿µä¸Šè®²ï¼Œè¿™å¬èµ·æ¥å¾ˆç®€å•ï¼Œä½†æ˜¯è¿™é‡Œçš„ä»£ç æœ‰ç‚¹å¤æ‚ã€‚åˆ«æ‹…å¿ƒï¼Œæˆ‘ä»¬å·²ç»åˆ°äº†æœ€åå…³å¤´ï¼Œç°åœ¨æˆ‘ä»¬ä¸èƒ½æ”¾å¼ƒï¼è®©æˆ‘ä»¬å¼€å§‹å§ã€‚åœ¨æ‚¨çš„ **util/** æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ª **route.js** æ–‡ä»¶:*****

```
****--- frontend/src/util/route.js ---* **import React from "react";
import { connect } from "react-redux";
import { Redirect, Route, withRouter } from "react-router-dom";****const mapStateToProps = ({ session: { userId} }) => ({
  loggedIn: Boolean(userId)
});
...*****
```

*****è¿˜æ²¡æœ‰å¤ªç–¯ç‹‚çš„äº‹ã€‚æˆ‘ä»¬çš„å¯¼å…¥ä¸­çš„ä¸¤ä¸ªæ–°æˆå‘˜æ˜¯**é‡å®šå‘**å’Œ**å¸¦è·¯ç”±å™¨**ã€‚ç¬¬ä¸€ä¸ªç®€å•åœ°é‡å®šå‘åˆ°æˆ‘ä»¬é€‰æ‹©çš„ URLã€‚ç¬¬äºŒä¸ªå°±åƒ **connect** ä¸€æ ·ä½¿ç”¨ï¼Œé™¤äº†å®ƒä¸ºæˆ‘ä»¬çš„ç»„ä»¶æä¾›äº†ä¸è·¯çº¿/å‚æ•°/ä½ç½®ç­‰ç›¸å…³çš„æœ‰ç”¨å±æ€§ã€‚æˆ‘ä»¬ä¸ä¼šä½¿ç”¨è¿™äº›å±æ€§ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œä½†æ˜¯æˆ‘åœ¨è¿™é‡Œæ·»åŠ äº† **withRouter** ,å› ä¸ºç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨è¯¥åŠŸèƒ½ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å»æ‹œè®¿æˆ‘ä»¬çš„å¥½æœ‹å‹ã€‚æˆ‘ä»¬æ·±åº¦åœ°ææ„äº†æˆ‘ä»¬çš„çŠ¶æ€å¯¹è±¡ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªç®€å•åœ°å›ç­”è¿™ä¸ªé—®é¢˜çš„é“å…·ï¼Œâ€œæˆ‘ä»¬ç™»å½•äº†å—ï¼Ÿâ€è®©æˆ‘ä»¬ç»§ç»­:*****

```
****--- frontend/src/util/route.js ---
...* **const Auth = ({ loggedIn, path, component: Component }) => (
  <Route
    path={path}
    render={props => (
      loggedIn ?
      <Redirect to='/dashboard' /> :
      <Component {...props} />
    )}
  />
);****const Protected = ({ loggedIn, path, component: Component }) => (
  <Route
    path={path}
    render={props => (
      loggedIn ?
      <Component {...props} /> :
      <Redirect to='/login' />
    )}
  />
);**
*...****
```

*****ä»è¯­æ³•ä¸Šæ¥è¯´ï¼Œæˆ‘å·²ç»å°½å¯èƒ½åœ°è®©å®ƒå¯è¯»æ€§æ›´å¥½ã€‚è¿™ä¸¤ä¸ªåŠŸèƒ½å‡ ä¹ç›¸åŒâ€”â€”å”¯ä¸€çš„åŒºåˆ«æ˜¯**é‡å®šå‘**ã€‚
æˆ‘ä»¬æ¥åˆ†è§£ä¸€ä¸‹ã€‚åœ¨é«˜å±‚æ¬¡ä¸Šï¼Œè¿™äº›åªæ˜¯éšå¼è¿”å›ä¸€ä¸ª **Route** ç»„ä»¶çš„ç»„ä»¶ï¼Œè¯¥ç»„ä»¶å¯èƒ½å‘ˆç°å¦ä¸€ä¸ªç»„ä»¶æˆ–é‡å®šå‘ã€‚æˆ‘ä»¬ä»ç ´åæˆ‘ä»¬çš„é“å…·å¼€å§‹ã€‚éœ€è¦`component: Component`ä»¥ä¾¿ React çŸ¥é“è¿™æ˜¯ä½œä¸ºé“å…·å‡ºç°çš„æ•´ä¸ªç»„ä»¶ã€‚
æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡ä½¿ç”¨æˆ‘ä»¬æä¾›çš„è·¯å¾„å»ºç«‹æˆ‘ä»¬çš„**è·¯çº¿**ã€‚
ç„¶åï¼Œæˆ‘ä»¬ä¸ä½¿ç”¨`component={SomeComponent}`ï¼Œè€Œæ˜¯ä½¿ç”¨ **render** propï¼Œå®ƒå…è®¸æˆ‘ä»¬æä¾›ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œè¯¥å‡½æ•°ä½¿ç”¨ä¸‰å…ƒç»„æ¥æ˜¾ç¤ºæˆ‘ä»¬çš„ç»„ä»¶æˆ–é‡å®šå‘ã€‚
æˆ‘ä»¬è¿˜åˆ©ç”¨[æ‰©å±•æ“ä½œç¬¦](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Spread_syntax)å°†æˆ‘ä»¬çš„é“å…·ä¼ é€’ç»™æ¸²æŸ“ç»„ä»¶ã€‚è¿˜æœ‰ä¸€æ­¥:*****

```
****--- frontend/src/util/route.js ---
...* **export const AuthRoute = withRouter(
  connect(mapStateToProps)(Auth)
);****export const ProtectedRoute = withRouter(
  connect(mapStateToProps)(Protected)
);*****
```

*****æˆ‘ä»¬ç”¨è·¯ç”±å™¨å’Œ**è¿æ¥**è¿™äº›ç»„ä»¶æ¥åŒ…è£…**ä¸­çš„æ‰€æœ‰ä¸œè¥¿ã€‚
ç°åœ¨å›åˆ°æˆ‘ä»¬çš„ **App.js** :*******

```
****--- frontend/src/util/routes.js ---
...* **import { AuthRoute, ProtectedRoute } from "../util/route";**export default () => (
  <>
    <Route exact path="/" component={Welcome} /> **<AuthRoute path="/login" component={Login} />
    <AuthRoute path="/signup" component={Signup} />
    <ProtectedRoute path="/dashboard" component={Dashboard} />**
  </>
);***
```

***æ³¨æ„åˆ°å®ƒä»¬æœ‰å¤šå®¹æ˜“ä½¿ç”¨äº†å—ï¼Ÿæˆ‘ä»¬å¯ä»¥åƒä½¿ç”¨æ™®é€šè·¯çº¿ä¸€æ ·ä½¿ç”¨å®ƒä»¬ï¼æ­¤å¤–ï¼Œç°åœ¨æˆ‘ä»¬æ€»æ˜¯æœ‰è¿™äº›åœ¨æˆ‘ä»¬çš„å¤„ç½®ã€‚***

***ç°åœ¨å» [http://localhost:3000/](http://localhost:3000/) æµ‹è¯•ä¸€ä¸‹ã€‚å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œä½ åº”è¯¥ä¸èƒ½è®¿é—®ä»ªè¡¨æ¿ã€‚
ç”œï¼è¿˜æœ‰ä¸€ä»¶äº‹è¦åšâ€”â€”è€Œä¸”å¾ˆç®€å•ï¼***

***åœ¨æˆ‘ä»¬çš„ **util/session.js** ä¸­ï¼Œè®©æˆ‘ä»¬å†æ·»åŠ ä¸€ä¸ªå‡½æ•°:***

```
****--- frontend/src/util/session.js ---
...* **export const checkLoggedIn = async preloadedState => {
  const response = await fetch('/api/session');
  const { user } = await response.json();
  let preloadedState = {};**
  **if (user) {
    preloadedState = {
      session: user
    };
  }
  return preloadedState;
};*****
```

***è¿™é‡Œï¼Œæˆ‘ä»¬ç‚¹å‡»æœ€åä¸€ä¸ª API ç«¯ç‚¹æ¥æ£€æŸ¥ä¼šè¯æ˜¯å¦å­˜åœ¨ã€‚
ç°åœ¨åœ¨æˆ‘ä»¬çš„ **src/index.js** :***

```
****--- frontend/src/index.js ---
...* **import { checkLoggedIn } from "./util/session";****const renderApp = preloadedState => {
  const store = configureStore(preloadedState);
  ReactDOM.render(
    <Provider store={store}>
      <BrowserRouter>
        <App />
      </BrowserRouter>
    </Provider>,
    document.getElementById("root")
  );
};****(async () => renderApp(*await* checkLoggedIn()))();*****
```

***é¦–å…ˆï¼Œæˆ‘ä»¬å°†ä¸æ¸²æŸ“æˆ‘ä»¬çš„**åº”ç”¨**ç›¸å…³çš„ä¸€åˆ‡å°è£…åˆ°ä¸€ä¸ªå‡½æ•°ä¸­ã€‚ç„¶åæˆ‘ä»¬ä½¿ç”¨å¦ä¸€ä¸ªç”Ÿå‘½ï¼Œå°±åƒæˆ‘ä»¬åœ¨æˆ‘ä»¬çš„æœåŠ¡å™¨ä¸­æ‰€åšçš„ä¸€æ ·ã€‚ä½¿ç”¨ **checkLoggedIn** çš„è¿”å›å€¼ï¼Œæˆ‘ä»¬çš„ **renderApp** å‡½æ•°æ‹¥æœ‰å¯åŠ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ‰€éœ€çš„ä¸€åˆ‡ã€‚
ä¸è¿‡è¯´å¤Ÿäº†ï¼Œæˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹å§ï¼***

***![](img/788ccfaf7235d3dd7713c1260dbcbf1d.png)***

***ç™»å½•åï¼Œæˆ‘ä»¬è¢«è‡ªåŠ¨é‡å®šå‘åˆ°ä»ªè¡¨æ¿(å› ä¸ºç™»å½•/æ³¨å†Œé¡µé¢æ˜¯ **AuthRoute** s)ã€‚***

***æˆ‘ä»¬å¯ä»¥åˆ·æ–°å¹¶ä¿æŒç™»å½•çŠ¶æ€ï¼***

***æ³¨é”€åï¼Œæˆ‘ä»¬ä¼šè¢«è‡ªåŠ¨é‡å®šå‘åˆ°ç™»å½•é¡µé¢(å› ä¸ºä»ªè¡¨æ¿é¡µé¢æ˜¯ä¸€ä¸ª**å—ä¿æŠ¤çš„è·¯ç”±**)ã€‚æˆ‘ä»¬çš„æ§åˆ¶å°æ²¡æœ‰é”™è¯¯ã€çº¢ç¯æˆ–æ•…éšœï¼Œä¸€åˆ‡éƒ½è¿è¡Œé¡ºåˆ©ã€‚***

# ***ğŸ†ä»»åŠ¡å·²å®ŒæˆğŸ†***

***æˆ‘çŸ¥é“è¿™ç¯‡æ–‡ç« å¾ˆé•¿ï¼Œè€Œä¸”è¿™æ˜¯æˆ‘ç¬¬ä¸€æ¬¡åœ¨ç½‘ä¸Šå†™ä¸œè¥¿ï¼Œä½†æ˜¯æˆ‘çœŸçš„å¾ˆäº«å—è¿™ç§ä½“éªŒã€‚å½“ç„¶ï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œæˆ‘å¸Œæœ›ä½ å–œæ¬¢è¿™ä¸ªï¼***

***ä¸‹æ¬¡è§ï¼***

***[åœ¨ GitHub ä¸ŠæŸ¥çœ‹ä»£ç åº“ã€‚](https://github.com/christiancashiola/SessionAuth)
[æ›´å¤šå…³äºæˆ‘ã€‚](http://christiancashiola.me/)***