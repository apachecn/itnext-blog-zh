<html>
<head>
<title>Telegram bot in Go: speak human</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">å›´æ£‹ä¸­çš„ç”µæŠ¥æœºå™¨äºº:è¯´äººè¯</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://itnext.io/telegram-bot-in-go-speak-human-b2b4547cad29?source=collection_archive---------4-----------------------#2019-04-04">https://itnext.io/telegram-bot-in-go-speak-human-b2b4547cad29?source=collection_archive---------4-----------------------#2019-04-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/157357d80dc4783a173837edb9cb45ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*drTPwe0plVns6dfk9yhF9w.jpeg"/></div></div></figure><p id="7f46" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://medium.com/@detunized/telegram-bot-in-go-concurrent-sqlite-e6176fac088e" rel="noopener">ä¸Šæ¬¡</a>æˆ‘å¯¹æˆ‘çš„SQLite accessåŸºç¡€è¿›è¡Œäº†é˜²å¼¹æµ‹è¯•ã€‚è®©æˆ‘ä»¬çœ‹çœ‹å®ƒåœ¨ç”Ÿäº§ä¸­æ˜¯å¦æˆç«‹ã€‚å¤ªç³Ÿç³•äº†ï¼Œæˆ‘æ°¸è¿œä¹Ÿä¸ä¼šæœ‰é‚£ä¹ˆé«˜çš„è´Ÿè·å»æ‰“ç¢ä¸œè¥¿ã€‚å“¦ï¼Œå¥½å§ï¼Œè®©æˆ‘ä»¬æ‹­ç›®ä»¥å¾…ã€‚ä¹Ÿè®¸æˆ‘å¾ˆå¹¸è¿ï¼Œä¸¤ä¸ªå¯æ‚²çš„å¹¶å‘è¯·æ±‚æœ€ç»ˆä¼šä½¿æˆ‘çš„GoäºŒè¿›åˆ¶å´©æºƒã€‚</p><p id="714c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ä»Šå¤©ï¼Œæˆ‘å°†é‡ç‚¹ä»‹ç»ç‰¹æ€§ã€‚æˆ‘æƒ³è®©æˆ‘çš„æœºå™¨äººå˜å¾—æ™ºèƒ½ã€‚ä¸å¤ªå–œæ¬¢ï¼Œåªæ˜¯å½“ä½ è¾“å…¥é”™è¯¯çš„å‘½ä»¤æ—¶ï¼Œå¬èµ·æ¥æ¯”<code class="fe ky kz la lb b">cmd.exe</code>å¥½ä¸€ç‚¹ã€‚æˆ‘ä¸ä¼šæŠŠäº‹æƒ…æå¤§ï¼Œæ›´åƒæ˜¯æŠŠè„šè¶¾æµ¸åœ¨æ°´é‡Œçœ‹çœ‹æ€ä¹ˆæ ·ã€‚</p><p id="35a8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">é¦–å…ˆï¼Œæˆ‘æƒ³æ‰¾åˆ°åŒåçš„æœ€åä¸€ä¸ªäº‹ä»¶ï¼Œå› ä¸ºæˆ‘å°†å®ƒä»¬å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œå¹¶å‘å›äº‹ä»¶çš„æ—¥æœŸã€‚æƒ³è±¡è¿™æ ·çš„äº’åŠ¨:</p><pre class="lc ld le lf gt lg lb lh li aw lj bi"><span id="7774" class="lk ll iq lb b gy lm ln l lo lp">me: eat<br/>bot: Previous 'eat' happened 6 hours ago</span></pre><p id="e7d1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">è¦æ‰¾åˆ°åŒåçš„äº‹ä»¶ï¼Œæˆ‘å¿…é¡»è®©SQLiteç»™æˆ‘ç”¨æˆ·ç›¸åŒçš„é‚£ä¸€è¡Œï¼Œäº‹ä»¶çš„åç§°ä¹Ÿç›¸åŒï¼Œå¹¶ä¸”æˆ‘æƒ³è¦æŒ‰æ—¥æœŸæ’åºåçš„æœ€åä¸€è¡Œã€‚å°†è‹±è¯­è½¬æ¢æˆSQLï¼Œæˆ‘å¾—åˆ°:</p><pre class="lc ld le lf gt lg lb lh li aw lj bi"><span id="705f" class="lk ll iq lb b gy lm ln l lo lp">SELECT date FROM events<br/>    WHERE user = ? AND name = ?<br/>    ORDER BY date<br/>    DESC LIMIT 1</span></pre><p id="0cbf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">å¾ˆç®€å•ï¼Œæ˜¯å§ï¼Ÿç°åœ¨ï¼ŒæŠŠå®ƒè½¬æ¢æˆGoå’Œ<code class="fe ky kz la lb b">crawshaw.io/sqlite</code>,æˆ‘å¾—åˆ°å¦‚ä¸‹ç»“æœ:</p><pre class="lc ld le lf gt lg lb lh li aw lj bi"><span id="4472" class="lk ll iq lb b gy lm ln l lo lp">// Default response<br/>response := fmt.Sprintf("Fist time for '%s'", name)<br/><br/>// Get the last event with the same name and format the response<br/>err := sqlitex.Exec(connection,<br/>    "SELECT date FROM events "+<br/>        "WHERE user = ? AND name = ? "+<br/>        "ORDER BY date "+<br/>        "DESC LIMIT 1",<br/>    func(s *sqlite.Stmt) error {<br/>        response = formatResponse(s.GetInt64("date"), name)<br/>        return nil<br/>    },<br/>    message.From.ID,<br/>    name)<br/><br/>// Send the message back to the user<br/>go func() {<br/>    bot.Send(tgbotapi.NewMessage(message.Chat.ID, response))<br/>}()</span></pre><p id="e1d7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">é‚£é‡Œ<code class="fe ky kz la lb b">formatResponse</code>éå¸¸ç®€é™‹:</p><pre class="lc ld le lf gt lg lb lh li aw lj bi"><span id="f36a" class="lk ll iq lb b gy lm ln l lo lp">func formatResponse(date int64, name string) string {<br/>    last := time.Unix(date, 0)<br/>    return fmt.Sprintf("Previous '%s' happened on '%v'", name, last)<br/>}</span></pre><p id="4ca6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ç°åœ¨äº¤äº’çœ‹èµ·æ¥åƒè¿™æ ·:</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lq"><img src="../Images/2ea9d579e143ccf27df55d3e92b46152.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hjvMPxUPQsB8HKqp.png"/></div></div></figure><p id="aff3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ä¸å®Œå…¨æ˜¯åœ°çƒä¸Šæœ€èªæ˜çš„æœºå™¨äººï¼Œä½†æˆ‘ä»¬è¦å»æŸä¸ªåœ°æ–¹ã€‚</p><p id="d177" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ç°åœ¨ï¼Œæˆ‘æƒ³è®©å®ƒå¬èµ·æ¥å°‘ä¸€ç‚¹æ„šè ¢ï¼Œå¤šä¸€ç‚¹äººæ€§ï¼Œè¿™ä¸¤è€…å¹¶ä¸æ€»æ˜¯ä¸€è‡´çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»–ä»¬æ˜¯ã€‚æˆ‘ä¸å¸Œæœ›æœºå™¨äººè¯´åƒ<code class="fe ky kz la lb b">happened on '2019-04-04 14:13:57 +0200 CEST'</code>è¿™æ ·çš„è¯ï¼Œè€Œæ˜¯åƒ<code class="fe ky kz la lb b">8 minutes since</code>æˆ–<code class="fe ky kz la lb b">1 year since</code>è¿™æ ·çš„è¯ã€‚ä¿¡ä¸ä¿¡ç”±ä½ ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªä¸“é—¨çš„åŒ…è£…ã€‚æ¬¢è¿<a class="ae kw" href="https://github.com/hako/durafmt" rel="noopener ugc nofollow" target="_blank"> hako/durafmt </a>ã€‚åœ¨å®ƒçš„å¸®åŠ©ä¸‹ï¼Œå¾ˆå®¹æ˜“å°†å¯¹è¯å˜æˆè¿™æ ·:</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lr"><img src="../Images/260283a2f15aa3361995d565d3975117.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fTMsj0ZZKdjIKbgb.png"/></div></div></figure><p id="623c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">å¯è¯»æ€§è¦å¥½å¾—å¤šã€‚ä¸ºäº†è®©å®ƒå·¥ä½œï¼Œæˆ‘åªéœ€ç¨å¾®ä¿®æ”¹ä¸€ä¸‹<code class="fe ky kz la lb b">formatResponse</code>å‡½æ•°(ç°åœ¨å®ƒè¿˜å¿…é¡»æ¥å—å½“å‰çš„æ¶ˆæ¯æ—¥æœŸ):</p><pre class="lc ld le lf gt lg lb lh li aw lj bi"><span id="9a59" class="lk ll iq lb b gy lm ln l lo lp">func formatResponse(name string, date int64, prevDate int64) string {<br/>    prev := time.Unix(prevDate, 0)<br/>    now := time.Unix(date, 0)<br/>    duration := durafmt.ParseShort(now.Sub(prev))<br/>    return fmt.Sprintf("%s since last '%s'", duration, name)<br/>}</span></pre><p id="dea6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">å¾ˆç®€å•ã€‚æ²¡æœ‰é‚£ä¹ˆå¤šå°è¯ï¼Œä¸åˆ°ä¸€ä¸ªå°æ—¶çš„å·¥ä½œï¼Œæˆ‘å°±æœ‰äº†ä¸€ä¸ªä¼šè¯´äººè¯çš„æœºå™¨äººï¼Œå®ƒèƒ½å‘Šè¯‰æˆ‘ä¸Šæ¬¡å‘ç”Ÿäº†ä»€ä¹ˆã€‚è£…è¿å®ƒï¼ğŸš¢</p><p id="84fe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">å¦‚æœä½ å¥½å¥‡ï¼Œå¯ä»¥åœ¨GitHub ä¸Šæ‰¾åˆ°ä»£ç <a class="ae kw" href="https://github.com/detunized/since-bot/tree/day-4" rel="noopener ugc nofollow" target="_blank">ã€‚è¿™ä¸ªç‰ˆæœ¬è¢«æ ‡è®°ä¸º<code class="fe ky kz la lb b">day-4</code>ã€‚</a></p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="6915" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kx">åŸè½½äº2019å¹´4æœˆ4æ—¥</em><a class="ae kw" href="https://detunized.net/posts/2019-04-04-telegram-bot-in-go-speak-human/" rel="noopener ugc nofollow" target="_blank"><em class="kx">detunized.net</em></a>T22</p></div></div>    
</body>
</html>