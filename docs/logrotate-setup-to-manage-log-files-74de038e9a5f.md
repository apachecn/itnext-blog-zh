# æ—¥å¿—æ—‹è½¬å®‰è£…ç¨‹åºä»¥ç®¡ç†æ—¥å¿—æ–‡ä»¶

> åŸæ–‡ï¼š<https://itnext.io/logrotate-setup-to-manage-log-files-74de038e9a5f?source=collection_archive---------3----------------------->

![](img/54d64a4778002269f904f706a17df72e.png)

é©¬åº“æ–¯Â·æ–¯çš®æ–¯å…‹åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šçš„ç…§ç‰‡

ä¸€ä¸ªæ™´æœ—çš„å¤œæ™šï¼Œæ‚¨æ¥åˆ°è­¦æŠ¥ç³»ç»Ÿçš„ç”µè¯ï¼Œç§°å…¶ä¸­ä¸€å°ç”Ÿäº§æœåŠ¡å™¨æ²¡æœ‰å“åº”ã€‚æ‚¨ç«‹å³æ‰“å¼€ç¬”è®°æœ¬ç”µè„‘å¹¶å¼€å§‹è°ƒè¯•ï¼Œä»¥æ‰¾åˆ°å¯èƒ½å‡ºé”™çš„åœ°æ–¹ã€‚è¿‡äº†ä¸€æ®µæ—¶é—´åï¼Œä½ å‘ç°å®ƒçš„ç£ç›˜æ˜¯æ»¡çš„ï¼Œå› ä¸ºæ—¥å¿—æ²¡æœ‰è¢«æ¸…é™¤ã€‚ç”±äºæ—¥å¿—å¯¹äºè°ƒè¯•å’Œè¯†åˆ«ç”Ÿäº§ä¸­çš„é”™è¯¯è‡³å…³é‡è¦ï¼Œæ‰€ä»¥æ‚¨ä¿ç•™äº†å®ƒä»¬ã€‚

å¦‚æœæ—¥å¿—ç®¡ç†ä¸å½“ï¼Œè¿™å¯èƒ½å°±æ˜¯ä½ çš„æ•…äº‹ã€‚åœ¨å½“ä»Šä¸–ç•Œï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¼šç”Ÿæˆå¤§é‡æ—¥å¿—æ•°æ®ï¼Œå¹¶ä¸”å¯ä»¥åˆ›å»º GB å¤§å°çš„æ–‡ä»¶ã€‚å¤§å‹æ—¥å¿—æ–‡ä»¶å¾ˆéš¾è°ƒè¯•ï¼Œå ç”¨å¤§é‡ç©ºé—´ï¼Œå¹¶ä¸”ä¼šé™ä½å®šæœŸå¤‡ä»½æœåŠ¡å™¨æ˜ åƒå’Œæ•°æ®çš„é€Ÿåº¦ã€‚å°†æ—¥å¿—æ–‡ä»¶ä¿æŒåœ¨å¯ç®¡ç†çš„å¤§å°å¹¶åˆ é™¤æ— ç”¨çš„æ—§æ—¥å¿—å§‹ç»ˆæ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå·¥å…·æ¥å¸®åŠ©æˆ‘ä»¬æ‰€æœ‰çš„éœ€æ±‚ï¼Œè¿™å¯ä»¥ä½¿ç”¨ logrotate æ¥å®Œæˆã€‚

æ ¹æ® Logrotate [Github é¡µé¢](https://github.com/logrotate/logrotate):

> logrotate å®ç”¨ç¨‹åºæ—¨åœ¨ç®€åŒ–ç”Ÿæˆå¤§é‡æ—¥å¿—æ–‡ä»¶çš„ç³»ç»Ÿä¸Šçš„æ—¥å¿—æ–‡ä»¶ç®¡ç†ã€‚Logrotate å…è®¸è‡ªåŠ¨å¾ªç¯å‹ç¼©ã€åˆ é™¤å’Œé‚®å¯„æ—¥å¿—æ–‡ä»¶ã€‚Logrotate å¯ä»¥è®¾ç½®ä¸ºæ¯å¤©ã€æ¯å‘¨ã€æ¯æœˆæˆ–å½“æ—¥å¿—æ–‡ä»¶è¾¾åˆ°ä¸€å®šå¤§å°æ—¶å¤„ç†æ—¥å¿—æ–‡ä»¶ã€‚

Logrotate å¯ä»¥ç”¨æ¥åšä»¥ä¸‹äº‹æƒ…:

1.  åŸºäºå¤§å°å’Œæ—¶é—´æ—‹è½¬æ–‡ä»¶
2.  å°†æ—¥æœŸæ·»åŠ åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œè¿™æœ‰åŠ©äºè°ƒè¯•
3.  åˆ›å»ºå…·æœ‰æ‰€éœ€æƒé™çš„æ–°æ—¥å¿—æ–‡ä»¶
4.  åˆ é™¤æ—§çš„æ—¥å¿—æ–‡ä»¶
5.  åœ¨æ—¥å¿—è½®è½¬å‰åè¿è¡Œè‡ªå®šä¹‰å‘½ä»¤
6.  å‹ç¼©æ—¥å¿—æ–‡ä»¶ä»¥èŠ‚çœç©ºé—´

åœ¨æˆ‘ä»¬å¼€å§‹ä½¿ç”¨ logrotate ä¹‹å‰ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹ä¸€äº›ç”¨äºè®¾ç½®çš„å¸¸è§é…ç½®å‚æ•°ã€‚

**æ—¥å¿—æ–‡ä»¶**:æˆ‘ä»¬é€šè¿‡åˆ—å‡ºæ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼Œåè·Ÿä¸€ç»„æ‰€éœ€çš„å‚æ•°æ¥å®šä¹‰æ—‹è½¬å‚æ•°ã€‚åœ¨ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ”¾ç½®å¤šä¸ªè¿™æ ·çš„é…ç½®ã€‚

**å¾ªç¯è®¡æ•°**:å®šä¹‰åœ¨å¼€å§‹åˆ é™¤æ—¥å¿—æ–‡ä»¶ä¹‹å‰ï¼Œä¿ç•™å¤šå°‘ä¸ªå­˜æ¡£æ—¥å¿—ã€‚

**å¾ªç¯é—´éš”**:å®šä¹‰å¾ªç¯æ—¥å¿—æ–‡ä»¶çš„é¢‘ç‡ã€‚è¿™åŒ…æ‹¬æ¯æ—¥ã€æ¯å‘¨ã€æ¯æœˆå’Œæ¯å¹´ã€‚å¦‚æœæœªå®šä¹‰ï¼Œåˆ™æ¯å½“ logrotate è¿è¡Œæ—¶ï¼Œå®ƒéƒ½ä¼šæ—‹è½¬ã€‚

**Size** :æˆ‘ä»¬å¯ä»¥å®šä¹‰ Size å‚æ•°æ¥æŒ‡å®šæ—‹è½¬æ–‡ä»¶æ—¶çš„æ–‡ä»¶å¤§å°ã€‚

**å‹ç¼©**:å¦‚æœæˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬çš„å½’æ¡£æ—¥å¿—è¢«å‹ç¼©ï¼Œæˆ‘ä»¬æ·»åŠ è¿™ä¸ªå‚æ•°ã€‚

**å‘½ä»¤**:æˆ‘ä»¬å¯ä»¥ä¸ºæ—¥å¿—æ—‹è½¬è¿è¡Œæ—‹è½¬å‰å’Œæ—‹è½¬åå‘½ä»¤ã€‚è¿™å¯ä»¥ä½¿ç”¨å‚æ•°*é¢„æ—‹è½¬*å’Œ*åæ—‹è½¬*æ¥å®Œæˆã€‚

**missingok** :è¯¥å‚æ•°æŒ‡å®šå¦‚æœæ²¡æœ‰æ—¥å¿—æ–‡ä»¶ï¼Œåˆ™ä¸è¾“å‡ºé”™è¯¯ã€‚

è®©æˆ‘ä»¬ä»ä½¿ç”¨ Ansible å‘½ä»¤å®‰è£… logrotate å¼€å§‹ã€‚

```
- name: Install logrotate
  package: 
    name: logrotate
    state: present
  when: logrotate_scripts is defined
```

ä¸€æ—¦å®‰è£…äº† logrotateï¼Œå®ƒå°†æ¯å¤©ä½¿ç”¨ cron ä½œä¸šè¿è¡Œï¼Œè¯¥ä½œä¸šæ‰§è¡Œä½äºâ€œ/etc/cron.daily/logrotateâ€çš„è„šæœ¬ã€‚æˆ‘ä»¬å¯ä»¥åœ¨â€œ/etc/logrotate.confâ€ä¸­æ‰¾åˆ°é»˜è®¤çš„ logrotate é…ç½®æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«äº†â€œ/etc/logrotate.d/â€ä¸­çš„æ‰€æœ‰é…ç½®ã€‚æˆ‘ä»¬å°†åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸­åˆ›å»ºæ‰€æœ‰éœ€è¦çš„ logrotate é…ç½®æ–‡ä»¶ï¼Œè¿™æ ·å½“ logrotate æ‰§è¡Œæ—¶ï¼Œå®ƒå¯ä»¥ä¸ºæ‰€æœ‰å®šä¹‰çš„æ—¥å¿—æ–‡ä»¶è¿›è¡Œæ—‹è½¬ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ nginx æ—¥å¿—æ—‹è½¬é…ç½®ã€‚

```
- name: Setup logrotate scripts
  template:
    src: logrotate.d.j2
    dest: "{{ logrotate_conf_dir }}{{ item.name }}"
  with_items: "{{ logrotate_scripts }}"
  when: logrotate_scripts is defined
```

åœ¨æˆ‘ä»¬å®šä¹‰çš„æ–‡ä»¶å¤¹ä¸­è®¾ç½® nginx çš„é…ç½®å˜é‡:

```
---
  logrotate_conf_dir: "/etc/logrotate.d/"
  logrotate_scripts:
    - name: nginx
      log_dir: '/var/log/nginx'
      log_extension: 'log'
      options:
        - rotate 7
        - daily
        - size 10M
        - missingok
        - compress
        - create 0644 nginx nginx
      scripts:
          postrotate: "/bin/kill -USR1 `cat /run/nginx.pid 2>/dev/null` 2>/dev/null || true"
```

å…³äº nginx postscript çš„ç»†èŠ‚å¯ä»¥åœ¨[è¿™é‡Œ](https://www.nginx.com/resources/wiki/start/topics/examples/logrotation/)æ‰¾åˆ°ã€‚åˆ›å»ºçš„æœ€ç»ˆé…ç½®æ–‡ä»¶æ·»åŠ å¦‚ä¸‹:

```
/var/log/nginx/*.log {
  rotate 7
  weekly
  size 10M
  missingok
  compress
  delaycompress
  create 0644 nginx nginx
  postrotate
    /bin/kill -USR1 `cat /run/nginx.pid 2>/dev/null` 2>/dev/null || true
  endscript
}
```

å®Œæ•´çš„ä»£ç å¯ä»¥åœ¨è¿™ä¸ª git èµ„æºåº“ä¸­æ‰¾åˆ°:[https://github.com/MiteshSharma/LogrotateUsingAnsible](https://github.com/MiteshSharma/LogrotateUsingAnsible)

***PS:å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·ç”¨æŒå£°æ”¯æŒå®ƒ*** ğŸ‘ ***ã€‚æ¬¢å‘¼***