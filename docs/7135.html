<html>
<head>
<title>Logging Bash History via Promtail, Loki and Grafana</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">é€šè¿‡Promtailã€Lokiå’ŒGrafanaè®°å½•Bashå†å²</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://itnext.io/logging-bash-history-via-promtail-loki-and-grafana-9e70870a6cd?source=collection_archive---------2-----------------------#2022-06-21">https://itnext.io/logging-bash-history-via-promtail-loki-and-grafana-9e70870a6cd?source=collection_archive---------2-----------------------#2022-06-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/db29cafa5759f6c91596d8c026406c3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B0SULCl4XAWCJ50NZ4elng.png"/></div></div></figure><p id="1f0b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æˆ‘ä»¬ç»å¸¸ä½¿ç”¨bashæ§åˆ¶å°ã€‚æœ‰æ—¶ï¼Œæ‚¨å¿…é¡»è®°ä½è°åšäº†ä»€ä¹ˆï¼Œä½•æ—¶è¿è¡Œäº†ä»€ä¹ˆå‘½ä»¤ï¼Œå¹¶è§‚å¯ŸåŸºç¡€æ¶æ„ä¸­çš„ç”¨æˆ·ã€‚æˆ–è€…è¯´ï¼Œå½“ä½ ä½¿ç”¨aptå‡çº§å’Œå‡çº§egï¼ŒNginxæ—¶ï¼Œä½ æœ‰å¤šå®¹æ˜“å¾—åˆ°æ—¶é—´å’Œæ—¥æœŸï¼Ÿå½“ç„¶ï¼Œé™¤éæ‚¨å·²ç»å®ç°äº†GitOpsæ–¹æ³•ï¼Œåœ¨è¿™ç§æ–¹æ³•ä¸­ï¼ŒåŸºç¡€è®¾æ–½ä¸­çš„æ‰€æœ‰æ›´æ”¹éƒ½æ˜¯ä½¿ç”¨Xä½œä¸ºä»£ç æ¥å®Œæˆçš„ã€‚æˆ‘ä¸å¾—ä¸è¿™æ ·é€æ˜åœ°ä¸ºæˆ‘ä»¬çš„åŸºç¡€è®¾æ–½é…ç½®ä¸€åˆ‡ã€‚</p><p id="0dee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ä¸€ä¸ªæœ‰è¶£çš„è§‚å¯Ÿï¼Œé‚£å‡ ä¸ªç›´æ¥ç”¨æ‰‹å»æ‘¸åŸºç¡€è®¾æ–½çš„äººï¼Œå¼€å§‹æ›´åŠ å°å¿ƒç¿¼ç¿¼çš„ä½¿ç”¨æ§åˆ¶å°ï¼ŒåŒ…æ‹¬æˆ‘ã€‚åœ¨ä¸€ä¸ªä¸­å¿ƒä½ç½®è·¨æ•´ä¸ªåŸºç¡€è®¾æ–½è¿è¡ŒBashå‘½ä»¤æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œå°¤å…¶æ˜¯å½“æ‚¨çš„åŸºç¡€è®¾æ–½å¯èƒ½æœ‰è®¸å¤šæœåŠ¡å™¨ï¼Œè€Œæ‚¨è¿˜æ²¡æœ‰ä½¿ç”¨ç¼–æ’ç³»ç»Ÿæ—¶ã€‚</p><p id="47b9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä¸€æ­¥ä¸€æ­¥åœ°é…ç½®ä¸€å°æœåŠ¡å™¨ï¼Œåœ¨æ§åˆ¶å°ä¸­æ˜¾ç¤ºæ‰€æœ‰è¾“å…¥çš„å‘½ä»¤ã€‚ä¸Šè¿°æ‰€æœ‰å‘½ä»¤æœ€å¥½ä¸è‡ªåŠ¨åŸºç¡€ç»“æ„é…ç½®ä¸€èµ·ä½¿ç”¨ï¼Œå› ä¸ºåœ¨æ¯å°æœåŠ¡å™¨ä¸Šé…ç½®æ­¤åŠŸèƒ½éœ€è¦å¾ˆé•¿æ—¶é—´ã€‚</p><p id="791c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä½¿ç”¨å„ç§æŠ€æœ¯ä¸ºBash shellè®¾ç½®æ—¥å¿—ï¼Œå¹¶å°†è¿™äº›æ—¥å¿—è½¬å‘ç»™Grafanaã€‚Grafanaå’ŒLokiåœ¨ä¸åŒçš„ç›‘æ§æœåŠ¡å™¨ä¸Šã€‚è¿™ä½¿å¾—æ¼”ç¤ºå¦‚ä½•ä¸ºè®¾ç½®Bashæ—¥å¿—è®¾ç½®å„ç§ç»„ä»¶å˜å¾—å®¹æ˜“ï¼Œå¹¶ä¸”åº”è¯¥å¾ˆå®¹æ˜“åœ¨æ‚¨è‡ªå·±çš„åŸºç¡€è®¾æ–½ä¸­å¤åˆ¶è¿™ä¸€åŠŸèƒ½ã€‚ä¸Šè¿°æ‰€æœ‰è„šæœ¬å’Œå‘½ä»¤æœ€å¥½ä¸è‡ªåŠ¨åŸºç¡€ç»“æ„é…ç½®ä¸€èµ·ä½¿ç”¨ï¼Œå› ä¸ºåœ¨æ¯å°æœåŠ¡å™¨ä¸Šå•ç‹¬é…ç½®è¯¥åŠŸèƒ½éœ€è¦å¾ˆé•¿æ—¶é—´ã€‚</p><p id="15b2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æˆ‘ä»¬å¼€å§‹å§ï¼</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="d290" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">åˆå§‹æ•°æ®:</strong> <br/> <em class="ld">æœåŠ¡å™¨1: </em>å®éªŒæœåŠ¡å™¨ï¼Œå…¶bashå†å²æˆ‘ä»¬ä¼šæ¨é€åˆ°ç›‘æ§ä¸­ï¼›è¿™ç§æœåŠ¡å™¨çš„æ•°é‡ä¸é™ã€‚èº«ä»½è®¾å®šã€‚<br/> <em class="ld">æœåŠ¡å™¨2: </em>å¸¦æœ‰Grafanaçš„ç›‘æ§æœåŠ¡å™¨ï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸­å®‰è£…Lokiã€‚</p><h1 id="186a" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated"><strong class="ak">æœåŠ¡å™¨1ã€‚è®¾ç½®æ“ä½œå‘˜çš„bashç¯å¢ƒ</strong></h1><p id="c83d" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">ç¡®ä¿æ‚¨å®‰è£…äº†rsyslog:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="be3f" class="mq lf iq mm b gy mr ms l mt mu">apt-get install -y update &amp;&amp; apt-get install -y rsyslog</span></pre><p id="4800" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">æç¤º_å‘½ä»¤</strong></p><p id="67b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ä¸ºäº†è®¾ç½®bashæ—¥å¿—è®°å½•ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨PROMPT_COMMANDç¯å¢ƒå˜é‡ã€‚PROMPT_COMMANDçš„å†…å®¹å°†åœ¨è¿”å›Bashæç¤ºç¬¦ä¹‹å‰æ‰§è¡Œ(å³åœ¨ç»ˆç«¯ä¸­çš„æ¯ä¸ªäº¤äº’å‘½ä»¤æ‰§è¡Œä¹‹å)ã€‚è¿™ä¸ªBashç‰¹æ€§å°†å…è®¸æˆ‘ä»¬é€šè¿‡æœ¬åœ°å¯¹è±¡å‘é€æ—¥å¿—ï¼Œå¹¶ä½¿ç”¨rsyslogå°†å®ƒä»¬å†™å…¥æ—¥å¿—æ–‡ä»¶ã€‚æœ€åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨Promtailæ¥è½¬å‘Lokiæ—¥å¿—ï¼Œå¹¶åœ¨Grafanaä¸­æ˜¾ç¤ºå®ƒä»¬ã€‚</p><p id="9afb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">è¦ä½¿ç”¨<strong class="ka ir"> PROMPT_COMMAND </strong>è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œè¯·å°†ä»¥ä¸‹ä»£ç è¡Œæ·»åŠ åˆ°<em class="ld"/><strong class="ka ir"><em class="ld">/etc/bash . bashrc:</em></strong></p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="341f" class="mq lf iq mm b gy mr ms l mt mu">export PROMPT_COMMAND=â€™RETRN_VAL=$?; if [ -f /tmp/lastoutput.tmp ]; then LAST_OUTPUT=$(cat /tmp/lastoutput.tmp); rm /tmp/lastoutput.tmp; fi; logger -S 10000 -p local6.debug â€œ{\â€user\â€: \â€$(whoami)\â€, \â€path\â€: \â€$(pwd)\â€, \â€pid\â€: \â€$$\â€, \â€b64_command\â€: \â€$(history 1 | sed â€œs/^[ ]*[0â€“9]\+[ ]*//â€ | base64 -w0 )\â€, \â€status\â€: \â€$RETRN_VAL\â€, \â€b64_output\â€: \â€$LAST_OUTPUT\â€}â€; unset LAST_OUTPUT;</span></pre><p id="1ed4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ld">å“ªé‡Œï¼Œ</em></p><p id="b063" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="ld"> RETRN_VAL=$ï¼Ÿï¼›</em> </strong> â€” <em class="ld">è®¾ç½®åŒ…å«å‰ä¸€æ¬¡å‘½ä»¤è¿è¡Œè¿”å›å€¼çš„å˜é‡ã€‚å› ä¸ºPROMPT_COMMANDæ˜¯åœ¨æˆ‘ä»¬çš„æç¤ºç¬¦é‡æ–°æ˜¾ç¤ºä¹‹å‰è¿è¡Œçš„ï¼Œè¿™æœ€ç»ˆæ„å‘³ç€è„šæœ¬å°†åœ¨æˆ‘ä»¬è¿è¡Œæ¯ä¸ªå‘½ä»¤ä¹‹åè¿è¡Œï¼›</em></p><p id="6981" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"><em class="ld">if[-f/tmp/last output . tmp]ï¼›ç„¶åLAST _ OUTPUT = $(cat/tmp/LAST OUTPUT . tmp)ï¼›RM/tmp/last out . tmpï¼›fiï¼›â€” </em> </strong> <em class="ld">æ£€æŸ¥åä¸º/tmp/lastoutput.tmpçš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå°†LAST_OUTPUTçš„å€¼è®¾ç½®ä¸ºæ–‡ä»¶å†…å®¹çš„å€¼ï¼Œå¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œåˆ™åˆ é™¤è¯¥æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶å°†é€šè¿‡æˆ‘ä»¬ç¨ååˆ›å»ºçš„å®ç”¨å‡½æ•°å­˜å‚¨æˆ‘ä»¬çš„å‘½ä»¤çš„è¾“å‡ºï¼›</em></p><p id="7d27" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"><em class="ld">logger-S 10000-p local6.debugâ€”</em></strong><em class="ld">ä½¿ç”¨æœ€å¤š10000ä¸ªå­—ç¬¦çš„loggerå‘½ä»¤ï¼Œå¹¶åœ¨æœ¬åœ°å¯¹è±¡local 6 . debugçº§åˆ«è®¾ç½®ä¼˜å…ˆçº§ã€‚è¿™å°†å…è®¸æˆ‘ä»¬ç¨åä½¿ç”¨rsyslogæ•è·æ—¥å¿—ï¼›</em></p><p id="bb1b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"><em class="ld">" { \ \ " user \ ":\ " $(whoami)\ "ï¼Œ\\"path\": \"$(pwd)\ "ï¼Œ\ \ " PID \ ":\ " $ $ " b64 _ command \ ":\ " $(history 1 | sed-r " s/^\s*[0â€“9]+\s*// " | base64-w0)\ "ï¼Œ\\"status\": \"$RETRN_VAL\ "ï¼Œ\ \ " b64 _ output \ ":\ " $ last _ output \ " } "ï¼›â€” </em> </strong> <em class="ld">åŒ…å«ä¸€æ¡æ—¥å¿—æ¶ˆæ¯ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨JSONæ ¼å¼ã€‚è¿™å°†ä½¿æˆ‘ä»¬åœ¨æ„å»ºELKå †æ ˆæœŸé—´è§£æç™»å½•æ—¥å¿—æ—¶æ›´åŠ å®¹æ˜“ã€‚å¦‚æ‚¨æ‰€è§ï¼Œæˆ‘ä»¬æ³¨å†Œäº†6ä¸ªå­—æ®µï¼ŒåŒ…æ‹¬:</em></p><ul class=""><li id="076d" class="mv mw iq ka b kb kc kf kg kj mx kn my kr mz kv na nb nc nd bi translated"><em class="ld">å½“å‰ç”¨æˆ·</em></li><li id="00cd" class="mv mw iq ka b kb ne kf nf kj ng kn nh kr ni kv na nb nc nd bi translated"><em class="ld">ç”µæµè·¯å¾„</em></li><li id="a48a" class="mv mw iq ka b kb ne kf nf kj ng kn nh kr ni kv na nb nc nd bi translated"><em class="ld"> PID </em></li><li id="d717" class="mv mw iq ka b kb ne kf nf kj ng kn nh kr ni kv na nb nc nd bi translated"><em class="ld">å…ˆå‰æå–çš„è¿è¡Œå‘½ä»¤ä½¿ç”¨</em> <code class="fe nj nk nl mm b"><em class="ld">history</em></code> <em class="ld">å’Œbase64ç¼–ç ã€‚Base64ç¼–ç ç¡®ä¿å‘½ä»¤åœ¨æˆ‘ä»¬çš„JSONå¯¹è±¡ä¸­æ­£ç¡®è½¬ä¹‰ã€‚</em></li><li id="f4fd" class="mv mw iq ka b kb ne kf nf kj ng kn nh kr ni kv na nb nc nd bi translated"><em class="ld">å‰ä¸€æ¬¡è¿è¡Œå‘½ä»¤çš„è¿”å›å€¼</em></li><li id="de4b" class="mv mw iq ka b kb ne kf nf kj ng kn nh kr ni kv na nb nc nd bi translated"><em class="ld">å‘½ä»¤çš„base64ç¼–ç è¾“å‡º(å¦‚æœå­˜åœ¨)ã€‚ç¨åæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨è¿™ä¸€é¢†åŸŸï¼›</em></li></ul><p id="d530" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="ld">æœªè®¾ç½®LAST _ OUTPUT</em> </strong> â€”æˆ‘ä»¬ç¦ç”¨äº†LAST_OUTPUTå˜é‡ï¼Œè¿™æ ·å®ƒå°±ä¸ä¼šåœ¨å‘½ä»¤ä¹‹é—´æŒç»­ã€‚</p><p id="39e5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">æœ€å_è¾“å‡º</strong></p><p id="acf6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æˆ‘ä»¬ç°åœ¨å¯ä»¥è®¾ç½®æˆ‘ä»¬çš„helperå‡½æ•°æ¥æ•è·æˆ‘ä»¬çš„å‘½ä»¤çš„è¾“å‡ºï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å°†å®ƒä»¬å‘é€åˆ°Lokiã€‚å› ä¸ºæ²¡æœ‰è‡ªåŠ¨æ•è·å‘½ä»¤è¾“å‡ºçš„å†…ç½®æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»æ‰§è¡Œå‘½ä»¤ä¸¤æ¬¡ï¼Œæˆ–è€…ä½¿ç”¨å¸®åŠ©å™¨å‡½æ•°åœ¨PROMPT_COMMANDè„šæœ¬ä¸­æ•è·è¾“å‡ºã€‚</p><p id="6d1e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ä»¥ä¸‹å‘½ä»¤å¿…é¡»åŒ…å«åœ¨æ‚¨çš„<strong class="ka ir"><em class="ld">/etc/bash . bashrc</em></strong>æ–‡ä»¶ä¸­:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="159e" class="mq lf iq mm b gy mr ms l mt mu">logoutput() { output=$(while read input; do echo â€œ$inputâ€; done &lt; â€œ${1:-/dev/stdin}â€); echo -e â€œ$outputâ€œ; echo -e â€œ$outputâ€ | head -c 10000 | base64 -w0 &gt; /tmp/lastoutput.tmp; return $?; }</span></pre><p id="dacf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">å¦‚å›¾æ‰€ç¤ºï¼Œlogoutputå‘½ä»¤æ•è·å‘½ä»¤çš„è¾“å‡ºæˆ–è¯»å–æ–‡ä»¶çš„å†…å®¹ï¼Œbase64ç¼–ç å‰10ï¼Œ000ä¸ªå­—ç¬¦ï¼Œå¹¶å°†å®ƒä»¬å†™å…¥<em class="ld"> /tmp/lastoutput.tmp </em>(è®°ä½ï¼Œè¿™ä¸ªæ–‡ä»¶ä»¥å‰åœ¨æˆ‘ä»¬çš„PROMPT_COMMANDä¸­ä½¿ç”¨è¿‡ï¼).è¿™ä¸ªå¸®åŠ©å™¨å‡½æ•°å¯ä»¥ç”¨äºç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œæˆ–è€…å¯ä»¥ä¼ é€’ç»™STDOUTä»¥ä¾¿äºæ—¥å¿—è®°å½•ï¼</p><p id="76d2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">è¿™å°±å®Œæˆäº†æˆ‘ä»¬éœ€è¦å¯¹<em class="ld"> /etc/bash.bashrc </em>æ–‡ä»¶æ‰€åšçš„ä¿®æ”¹ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥ç»§ç»­è®¾ç½®rsyslogäº†ã€‚æ‚¨éœ€è¦ç¡®ä¿å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°æ‚¨çš„<strong class="ka ir"><em class="ld">/etc/bash . bashrc</em></strong><em class="ld"/>é…ç½®ä¸­:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="860d" class="mq lf iq mm b gy mr ms l mt mu">export PROMPT_COMMAND=â€™RETRN_VAL=$?; if [ -f /tmp/lastoutput.tmp ]; then LAST_OUTPUT=$(cat /tmp/lastoutput.tmp); rm /tmp/lastoutput.tmp; fi; logger -S 10000 -p local6.debug â€œ{\â€user\â€: \â€$(whoami)\â€, \â€path\â€: \â€$(pwd)\â€, \â€pid\â€: \â€$$\â€, \â€b64_command\â€: \â€$(history 1 | sed â€œs/^[ ]*[0â€“9]\+[ ]*//â€ | base64 -w0 )\â€, \â€status\â€: \â€$RETRN_VAL\â€, \â€b64_output\â€: \â€$LAST_OUTPUT\â€}â€; unset LAST_OUTPUT; â€˜</span><span id="1547" class="mq lf iq mm b gy nm ms l mt mu">logoutput() { output=$(while read input; do echo â€œ$inputâ€; done &lt; â€œ${1:-/dev/stdin}â€); echo -e â€œ$outputâ€œ; echo -e â€œ$outputâ€ | head -c 10000 | base64 -w0 &gt; /tmp/lastoutput.tmp; return $?; }</span></pre><p id="3e38" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">å†™å…¥/var/log/bash/bash.log </strong></p><p id="9372" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">å°†ä»¥ä¸‹ç”¨äºrsyslogç›‘è§†æœ¬åœ°å¯¹è±¡local6çš„å†…å®¹æ·»åŠ åˆ°ä»¥ä¸‹æ–‡ä»¶:<strong class="ka ir"><em class="ld">/etc/rsyslog . d/bash . conf</em></strong>:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="359f" class="mq lf iq mm b gy mr ms l mt mu">local6.* /var/log/bash/bash.log</span></pre><p id="b4f7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æ­£åœ¨é‡æ–°åŠ è½½rsyslog:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="a1a4" class="mq lf iq mm b gy mr ms l mt mu">service rsyslog restart</span></pre><p id="3f57" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æˆ‘ä»¬è¿˜éœ€è¦ä¸ºæˆ‘ä»¬çš„æ—¥å¿—æ·»åŠ logrotateï¼Œä»¥ä¾¿ä¸æ— é™æœŸåœ°å­˜å‚¨å®ƒä»¬ã€‚æ‰“å¼€<strong class="ka ir"><em class="ld">/etc/log rotate . d/r syslog</em></strong>æ–‡ä»¶ï¼Œå‘å…¶ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="11d7" class="mq lf iq mm b gy mr ms l mt mu">/var/log/bash/bash.log {<br/>    hourly<br/>    missingok<br/>    rotate 1<br/>    compress<br/>    delaycompress<br/>    notifempty<br/>    create 0600 promtail promtail<br/>    sharedscripts<br/>}</span></pre><p id="86ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">è®©æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼</p><p id="66f2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹åœ¨æ§åˆ¶å°ä¸­æ‰§è¡Œå‘½ä»¤åæ—¥å¿—æ˜¯å¦‚ä½•å†™çš„:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="c606" class="mq lf iq mm b gy mr ms l mt mu">cat /var/log/bash/bash.log</span></pre><p id="43ac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æ‚¨åº”è¯¥ä¼šåœ¨ä¸‹é¢çš„æˆªå›¾ä¸­çœ‹åˆ°å®ƒ:</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nn"><img src="../Images/9e691c3a9611bb02795e8e7378381ed0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KbC_k0Qez16aDeMN9mmewg.png"/></div></div></figure><p id="097a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">è®¾ç½®æç¤ºä¿¡æ¯</strong></p><p id="1737" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æˆ‘ä»¬è¿˜éœ€è¦å®‰è£…promtailï¼Œå®ƒä¼šå°†æˆ‘ä»¬çš„æ—¥å¿—æ–‡ä»¶ç›´æ¥å‘é€åˆ°Loki:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="db27" class="mq lf iq mm b gy mr ms l mt mu"># Downliading promtail binary<br/>wget <a class="ae no" href="https://github.com/grafana/loki/releases/download/v2.3.0/promtail-linux-amd64.zip" rel="noopener ugc nofollow" target="_blank">https://github.com/grafana/loki/releases/download/v2.3.0/promtail-linux-amd64.zip</a></span><span id="544e" class="mq lf iq mm b gy nm ms l mt mu"># Unzipping downloaded archive<br/>unzip promtail-linux-amd64.zip</span><span id="066e" class="mq lf iq mm b gy nm ms l mt mu"># Copy promtail binary file<br/>cp -f promtail-linux-amd64 /usr/local/bin/promtail</span><span id="1bf2" class="mq lf iq mm b gy nm ms l mt mu"># Adding promtail user<br/>useradd --no-create-home --shell /bin/false promtail</span></pre><p id="a31b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">è®©æˆ‘ä»¬æŠŠPromtailå˜æˆä¸€é¡¹æœåŠ¡ã€‚ä¸ºæ­¤ï¼Œåˆ›å»º<strong class="ka ir"><em class="ld">/etc/systemd/system/promtail . service</em></strong>æ–‡ä»¶å¹¶æ·»åŠ å†…å®¹:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="dce0" class="mq lf iq mm b gy mr ms l mt mu">[Unit]<br/>Description=Promtail service<br/>After=network.target</span><span id="1d5c" class="mq lf iq mm b gy nm ms l mt mu">[Service]<br/>Type=simple<br/>User=promtail<br/>ExecStart=/usr/local/bin/promtail -config.file /usr/local/bin/config-promtail.ymlServer 2. Install Loki.</span><span id="3b59" class="mq lf iq mm b gy nm ms l mt mu">[Install]<br/>WantedBy=multi-user.target</span></pre><p id="0957" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">é‡æ–°è¯»å–æœåŠ¡é…ç½®æ–‡ä»¶:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="678e" class="mq lf iq mm b gy mr ms l mt mu">sudo systemctl daemon-reload</span></pre><p id="a47b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">å¹¶åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶<strong class="ka ir"><em class="ld">/usr/local/bin/config-promtail . yml</em></strong>ï¼Œå†…å®¹ä¸º:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="5ab0" class="mq lf iq mm b gy mr ms l mt mu">server:<br/>http_listen_port: 9080<br/>grpc_listen_port: 0</span><span id="ea14" class="mq lf iq mm b gy nm ms l mt mu">positions:<br/>filename: /tmp/positions.yaml</span><span id="3e26" class="mq lf iq mm b gy nm ms l mt mu">clients:<br/>- url: http://&lt;monitoring server internal IP&gt;:3100/loki/api/v1/push</span><span id="c474" class="mq lf iq mm b gy nm ms l mt mu">scrape_configs:<br/>- job_name: system</span><span id="5917" class="mq lf iq mm b gy nm ms l mt mu">static_configs:<br/>- targets:<br/>- localhost</span><span id="b9d8" class="mq lf iq mm b gy nm ms l mt mu">labels:<br/>job: bash</span><span id="5000" class="mq lf iq mm b gy nm ms l mt mu">__path__: /var/log/bash/bash.log</span></pre><p id="f7cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">å¯åŠ¨æç¤ºæœåŠ¡:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="738a" class="mq lf iq mm b gy mr ms l mt mu">sudo service promtail start</span></pre><p id="5054" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æ˜¯æ—¶å€™è¿›å…¥ä¸‹ä¸€æ­¥äº†â€”â€”è®¾ç½®ç›‘æ§ã€‚</p><h1 id="0fa2" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated"><strong class="ak">æœåŠ¡å™¨2ã€‚å®‰è£…Lokiå¹¶é…ç½®Grafana </strong></h1><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div class="ab gu cl np"><img src="../Images/3629b24ef26de19da5ee34fce518888f.png" data-original-src="https://miro.medium.com/v2/format:webp/1*k-hdOAQjRXKoyguzKuoeKg.png"/></div></figure><p id="ab41" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">å®‰è£…Loki:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="aa7d" class="mq lf iq mm b gy mr ms l mt mu"># Downloading Loki binary files<br/>wget <a class="ae no" href="https://github.com/grafana/loki/releases/download/v2.3.0/loki-linux-amd64.zip" rel="noopener ugc nofollow" target="_blank">https://github.com/grafana/loki/releases/download/v2.3.0/loki-linux-amd64.zip</a></span><span id="f93d" class="mq lf iq mm b gy nm ms l mt mu"># Unzip<br/>unzip loki-linux-amd64.zip</span><span id="ac95" class="mq lf iq mm b gy nm ms l mt mu"># Copy Loki binary file<br/>cp -f /tmp/loki-linux-amd64 /usr/local/bin/loki</span><span id="49e4" class="mq lf iq mm b gy nm ms l mt mu"># Add Loki user<br/>useradd --no-create-home --shell /bin/false loki</span></pre><p id="2af9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æˆ‘ä»¬å°†Lokiä½œä¸ºæœåŠ¡â€”åˆ›å»º<strong class="ka ir"><em class="ld">/etc/systemd/system/Loki . service</em></strong>æ–‡ä»¶å¹¶æ·»åŠ å†…å®¹:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="0b35" class="mq lf iq mm b gy mr ms l mt mu">[Unit]<br/>Description=Loki service<br/>After=network.target</span><span id="d80a" class="mq lf iq mm b gy nm ms l mt mu">[Service]<br/>Type=simple<br/>User=loki<br/>ExecStart=/usr/local/bin/loki -config.file /usr/local/bin/config-loki.yml</span><span id="378f" class="mq lf iq mm b gy nm ms l mt mu">[Install]<br/>WantedBy=multi-user.target</span></pre><p id="2e3f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶<strong class="ka ir"><em class="ld">/usr/local/bin/config-Loki . yml</em></strong><br/>ï¼Œæ·»åŠ å†…å®¹:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="054c" class="mq lf iq mm b gy mr ms l mt mu">auth_enabled: false</span><span id="fce8" class="mq lf iq mm b gy nm ms l mt mu">server:<br/>    http_listen_port: 3100</span><span id="2961" class="mq lf iq mm b gy nm ms l mt mu">ingester:<br/>    lifecycler:<br/>        address: 127.0.0.1<br/>        ring:<br/>            kvstore:<br/>                store: inmemory<br/>            replication_factor: 1<br/>        final_sleep: 0s<br/>    chunk_idle_period: 5m<br/>    chunk_retain_period: 30s<br/>    max_transfer_retries: 0</span><span id="2109" class="mq lf iq mm b gy nm ms l mt mu">schema_config:<br/>    configs:<br/>        - from: 2018-04-15<br/>          store: boltdb<br/>          object_store: filesystem<br/>          schema: v11<br/>          index:<br/>              prefix: index_<br/>              period: 168h</span><span id="af9e" class="mq lf iq mm b gy nm ms l mt mu">storage_config:<br/>    boltdb:<br/>        directory: /tmp/loki/index</span><span id="2244" class="mq lf iq mm b gy nm ms l mt mu">    filesystem:<br/>        directory: /tmp/loki/chunks</span><span id="df5f" class="mq lf iq mm b gy nm ms l mt mu">limits_config:<br/>    enforce_metric_name: false<br/>    reject_old_samples: true<br/>    reject_old_samples_max_age: 168h</span><span id="7dc3" class="mq lf iq mm b gy nm ms l mt mu">chunk_store_config:<br/>    max_look_back_period: 0s</span><span id="565a" class="mq lf iq mm b gy nm ms l mt mu">table_manager:<br/>    retention_deletes_enabled: false<br/>    retention_period: 0s</span></pre><p id="64be" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">åœ¨å®˜æ–¹<a class="ae no" href="https://grafana.com/docs/loki/latest/configuration" rel="noopener ugc nofollow" target="_blank">æ–‡æ¡£</a>ä¸­é˜…è¯»æ›´å¤šå…³äºé…ç½®çš„ä¿¡æ¯ã€‚</p><p id="9c8c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ä¸ºLokiç´¢å¼•åˆ›å»ºç›®å½•:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="2911" class="mq lf iq mm b gy mr ms l mt mu">mkdir /tmp/loki</span></pre><p id="5343" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æ¥ä¸‹æ¥ï¼Œé‡æ–°å¯åŠ¨å®ˆæŠ¤ç¨‹åº:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="9738" class="mq lf iq mm b gy mr ms l mt mu">sudo systemctl daemon-reload</span></pre><p id="2604" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">å¹¶å¯åŠ¨LokiæœåŠ¡:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="c013" class="mq lf iq mm b gy mr ms l mt mu">sudo service loki enable &amp;&amp; sudo service loki start</span></pre><p id="9e2f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ç›‘æ§æœåŠ¡å™¨ä¸Šçš„LokiæœåŠ¡è¢«é…ç½®ä¸ºä»Promtailæ¥æ”¶æ—¥å¿—ã€‚</p><p id="62c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">è®©æˆ‘ä»¬è¯•ç€é€šè¿‡Grafana </strong> <br/>æŸ¥çœ‹æˆ‘ä»¬çš„bashå†å²è®°å½•ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦ç¡®ä¿æˆ‘ä»¬å¯ä»¥é€šè¿‡GrafanaæŸ¥çœ‹ä»æœåŠ¡å™¨è·å¾—çš„æ—¥å¿—ã€‚</p><p id="50c4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ç™»å½•Grafanaï¼Œå‘æ•°æ®æºæ·»åŠ ä¸€ä¸ªæ–°çš„Lokiæº:<br/> <strong class="ka ir">é…ç½®- &gt;æ•°æ®æº- &gt;æ·»åŠ æ•°æ®æº- &gt; Loki </strong>å¹¶å°†<a class="ae no" href="http://localhost:3100" rel="noopener ugc nofollow" target="_blank"> <em class="ld">æ·»åŠ åˆ°URLå­—æ®µã€‚<br/>å¦‚ä¸‹å›¾æˆªå›¾æ‰€ç¤º:</em></a></p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nq"><img src="../Images/90b7142f3bc1786d6e41781862bed9ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A-0Z6GALlTW5Jvglj6aRDg.png"/></div></div></figure><p id="304e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">æµè§ˆæ—¥å¿—</strong></p><p id="44b9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">è¦æŸ¥çœ‹æ—¥å¿—ï¼Œè¯·ç‚¹æŒ‰è¾¹æ ä¸­çš„â€œæµè§ˆâ€æŒ‰é’®(ğŸ§­)ã€‚å•å‡»æ•°æ®æºï¼Œæ‚¨å¯ä»¥çœ‹åˆ°æ—¥å¿—æ–‡ä»¶åˆ—è¡¨ï¼Œé€‰æ‹©å…¶ä¸­ä¸€ä¸ªæ¥æŸ¥çœ‹æ—¥å¿—ã€‚ä¹Ÿå¯ä»¥è¿™æ ·è¾“å…¥è‡ªå·±çš„æŸ¥è¯¢:<strong class="ka ir"><em class="ld">{ filename = "/var/log/bash/bash . log " }</em></strong>ä¼šç»™å‡ºæ¥è‡ªsyslogçš„æ—¥å¿—ã€‚</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/b0cf18243145b106779352b2bd45957d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3LeIRXxf1yZto8VHJgbe2w.png"/></div></div></figure><h1 id="aee5" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated"><strong class="ak">ç»“è®ºã€‚ä¸‹ä¸€æ­¥æ˜¯ä»€ä¹ˆï¼Ÿ</strong></h1><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/f9c84391fe7c3445f7b2186d9165d78d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8Av-xY-FynbDz6Eg"/></div></div></figure><p id="7fdd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">å°†æ­¤é…ç½®æ‰©å±•åˆ°æˆ‘ä»¬æ‰€æœ‰çš„äº‘é‡å®šå‘å™¨ã€æœ¬åœ°è¿è¥ç­‰ã€‚è®©è·Ÿè¸ªæ­£åœ¨å®Œæˆçš„å·¥ä½œå˜å¾—éå¸¸å®¹æ˜“ã€‚è¿™æœ‰æ—¶ä¼šè®©æˆ‘ä»¬çš„ç”Ÿæ´»æ›´è½»æ¾ã€‚æˆ‘å¸Œæœ›è¿™ç§æ–¹æ³•èƒ½å¤Ÿé€šè¿‡Promtailå’ŒLokiå¸®åŠ©æ‚¨åœ¨Grafanaä¸­é…ç½®bashå†å²æ—¥å¿—ã€‚</p><p id="4003" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">è®¾ç½®æ„‰å¿«ï¼</strong></p></div></div>    
</body>
</html>