<html>
<head>
<title>Proxying HTTP and gRPC requests in Go</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">åœ¨Goä¸­ä»£ç†HTTPå’ŒgRPCè¯·æ±‚</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://itnext.io/proxying-http-and-grpc-requests-in-go-a3201219a37d?source=collection_archive---------3-----------------------#2022-09-11">https://itnext.io/proxying-http-and-grpc-requests-in-go-a3201219a37d?source=collection_archive---------3-----------------------#2022-09-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/afda3899b06e4412f2db5b72e2df263b.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*mf1bsyoq2RLbnCEHdyE2gQ.jpeg"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">golang gopheråƒçˆ†ç±³èŠ±</figcaption></figure><p id="4495" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">åœ¨<a class="ae kw" href="https://hostfactor.io/" rel="noopener ugc nofollow" target="_blank">ä¸»æœºå› å­</a>å¤„ï¼Œæ‰€æœ‰ä¼ å…¥æµé‡éƒ½é€šè¿‡æˆ‘ä»¬çš„ä»£ç†å±‚ï¼Œæ‰€æœ‰ä¼ å‡ºTCPæµé‡éƒ½è¢«é‡å®šå‘åˆ°æˆ‘ä»¬çš„åº”ç”¨ä»£ç†ã€‚æ•è·ä¼ å‡ºçš„TCPæµé‡éå¸¸é‡è¦ï¼Œå› ä¸ºæˆ‘ä»¬æ‰€æœ‰çš„å†…éƒ¨æœåŠ¡éƒ½ä½¿ç”¨HTTPæˆ–gRPC (HTTP/2 ),æˆ‘ä»¬å¸Œæœ›é˜²æ­¢ä»»ä½•ç”¨æˆ·æœåŠ¡å™¨ä¸æˆ‘ä»¬çš„å†…éƒ¨æœåŠ¡è¿›è¡Œé€šä¿¡ã€‚åœ¨åšäº†ä¸€äº›è°ƒæŸ¥ä¹‹åï¼Œæˆ‘ä»¬åœ¨Goä¸­æ‰¾ä¸åˆ°ä»»ä½•å¯ä»¥åœ¨ä¸€ä¸ªæœåŠ¡å™¨ä¸­ä»£ç†HTTP/1å’ŒHTTP/2è¯·æ±‚çš„ç®€å•åº“ï¼Œæ‰€ä»¥æˆ‘ä»¬å†³å®šåˆ›å»ºä¸€ä¸ªã€‚</p><p id="1125" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">å¯¹äºè¿™ä¸ªä¾‹å­ï¼Œè®©æˆ‘ä»¬å‡è®¾æˆ‘ä»¬æƒ³è¦é˜»å¡å¯¹<code class="fe kx ky kz la b">blocked.hostfactor.io</code>çš„æ‰€æœ‰è¯·æ±‚</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="f8a9" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">TCPæœåŠ¡å™¨</h1><p id="c02c" class="pw-post-body-paragraph jy jz iq ka b kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr mk kt ku kv ij bi translated">å› ä¸ºHTTP/1å’ŒHTTP/2éƒ½åœ¨å¹•åä½¿ç”¨TCPï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä»é‚£é‡Œå¼€å§‹ã€‚</p><pre class="ml mm mn mo gt mp la mq mr aw ms bi"><span id="b8bd" class="mt lj iq la b gy mu mv l mw mx">addr, _ := net.ResolveTCPAddr("tcp", ":8080")<br/><br/>list, err := net.ListenTCP("tcp", addr)<br/>if err != nil {<br/> return err<br/>}<br/><br/>go func() {<br/> for {<br/>  conn, err := list.Accept()<br/>  if err != nil {<br/>   if errors.Is(err, net.ErrClosed) || errors.Is(err, io.EOF) {<br/>    return<br/>   }<br/>   continue<br/>  }<br/><br/>  go handleConn(conn.(*net.TCPConn))<br/> }<br/>}()</span></pre><p id="1346" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">è¿™é‡Œï¼Œæˆ‘ä»¬åœ¨ç«¯å£8080ä¸Šå¯åŠ¨ä¸€ä¸ªç®€å•çš„TCPæœåŠ¡å™¨ï¼Œå¹¶å°†è¿æ¥ä¼ é€’ç»™<code class="fe kx ky kz la b">handleConn</code> funcã€‚å°†HTTP/1/2ä½œä¸ºTCPå¤„ç†çš„å¥½å¤„åœ¨äºï¼Œæˆ‘ä»¬å¯ä»¥è®©ä¸€å°æœåŠ¡å™¨ç›‘å¬ä¸€ä¸ªç«¯å£æ¥å¤„ç†è¿™ä¸¤ç§æƒ…å†µã€‚è®©æˆ‘ä»¬æ·±å…¥äº†è§£ä¸€ä¸‹<code class="fe kx ky kz la b">handleConn</code></p><pre class="ml mm mn mo gt mp la mq mr aw ms bi"><span id="410a" class="mt lj iq la b gy mu mv l mw mx">func handleConn(conn *net.TCPConn) {<br/> defer func() {<br/>  _ = conn.Close()<br/> }()<br/><br/> buf := make([]byte, 4096)<br/> n, err := conn.Read(buf)<br/> if err != nil {<br/>  return<br/> }<br/><br/> payload := buf[:n]<br/> req, err := http.ReadRequest(bufio.NewReader(bytes.NewBuffer(payload)))<br/> if err != nil {<br/>  return<br/> }<br/>...</span><span id="6ffe" class="mt lj iq la b gy my mv l mw mx">}</span></pre><p id="03b4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kx ky kz la b">http.ReadRequest</code>å…è®¸æ‚¨å°†åŸå§‹çš„<code class="fe kx ky kz la b">[]byte</code>è½¬æ¢æˆ<code class="fe kx ky kz la b">*http.Request </code>ï¼Œè¿™å…è®¸æˆ‘ä»¬è§£ææœ‰æ•ˆè½½è·ã€‚</p><pre class="ml mm mn mo gt mp la mq mr aw ms bi"><span id="772e" class="mt lj iq la b gy mu mv l mw mx">if req.ProtoMajor &gt;= 2 {<br/> err = l.handleHttp2(bytes.NewBuffer(payload), conn)<br/>} else {<br/> err = l.handleHttpReq(req, conn)<br/>}</span></pre><p id="b6e1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kx ky kz la b">req.ProtoMajor</code>å…è®¸æˆ‘ä»¬åŒºåˆ†è¯·æ±‚æ˜¯HTTP/2 (gRPC)è¿˜æ˜¯HTTP/1</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="ca00" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">å¤„ç†HTTP/1</h1><p id="fe57" class="pw-post-body-paragraph jy jz iq ka b kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr mk kt ku kv ij bi translated">HTTP/1æ˜¯æœ€ç†Ÿæ‚‰çš„æƒ…å†µï¼Œåœ¨Goä¸­å¾—åˆ°æœ€å¤šçš„æ”¯æŒï¼Œæ‰€ä»¥æˆ‘ä»¬ä»è¿™é‡Œå¼€å§‹ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å¿…é¡»æ£€æŸ¥ä¸»æœºæ˜¯å¦ç­‰äºæˆ‘ä»¬ç¦ç”¨çš„<code class="fe kx ky kz la b">blocked.hostfactor.io</code>ä¸»æœº</p><pre class="ml mm mn mo gt mp la mq mr aw ms bi"><span id="2d49" class="mt lj iq la b gy mu mv l mw mx">// Check the host of the request<br/>if req.Host == "banned.hostfactor.io" {<br/> resp.StatusCode = http.StatusNotFound<br/>}</span></pre><p id="ecc8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">è¿˜å¯ä»¥æ£€æŸ¥è·¯å¾„ã€æ–¹æ³•ã€å¤´ç­‰ã€‚æ£€æŸ¥é€šè¿‡åï¼Œæˆ‘ä»¬ä»£è¡¨åŸå§‹è¯·æ±‚è€…å‘é€è¯·æ±‚</p><pre class="ml mm mn mo gt mp la mq mr aw ms bi"><span id="0162" class="mt lj iq la b gy mu mv l mw mx">// Required to forward the request<br/>req.RequestURI = ""<br/>var err error<br/>resp, err = http.DefaultClient.Do(req)<br/>if err != nil {<br/> return err<br/>}</span></pre><p id="f9c8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æœ€åï¼Œæˆ‘ä»¬ç¼–å†™å¯¹connçš„å“åº”ã€‚</p><pre class="ml mm mn mo gt mp la mq mr aw ms bi"><span id="16a1" class="mt lj iq la b gy mu mv l mw mx">return resp.Write(w)</span></pre><p id="5459" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æ€»çš„æ¥è¯´ï¼Œå®ƒçœ‹èµ·æ¥åƒè¿™æ ·</p><pre class="ml mm mn mo gt mp la mq mr aw ms bi"><span id="2555" class="mt lj iq la b gy mu mv l mw mx">func handleHttpReq(req *http.Request, w net.Conn) error {<br/> resp := &amp;http.Response{}<br/> // Check the host of the request<br/> if req.Host == "banned.hostfactor.io" {<br/>  resp.StatusCode = http.StatusNotFound<br/> } else {<br/>  // Required to forward the request<br/>  req.RequestURI = ""<br/>  var err error<br/>  resp, err = http.DefaultClient.Do(req)<br/>  if err != nil {<br/>   return err<br/>  }<br/> }<br/> return resp.Write(w)<br/>}</span></pre></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="bc03" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">å¤„ç†HTTP/2 (gRPC)</h1><p id="1c87" class="pw-post-body-paragraph jy jz iq ka b kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr mk kt ku kv ij bi translated">HTTP/2å’ŒHTTP/1éå¸¸ä¸åŒã€‚åœ¨HTTP/1ä¸­ï¼Œæœ€å°çš„æ•°æ®å•ä½æ˜¯ä¸€ä¸ªè¯·æ±‚ï¼Œè€Œåœ¨HTTP/2ä¸­ï¼Œè¯·æ±‚å’Œå“åº”çš„æ¶ˆæ¯è¢«åˆ†è§£æˆå¸§ã€‚HTTP/1ä¹Ÿä½¿ç”¨çº¯æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œè€ŒHTTP/2ä½¿ç”¨äºŒè¿›åˆ¶ç¼–ç ï¼Œè¿™åœ¨å¤„ç†åŸå§‹TCPè¿æ¥æ—¶ä¼šå¼•èµ·ä¸€äº›éº»çƒ¦ã€‚</p><p id="b4bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Go <code class="fe kx ky kz la b">http</code>åŒ…æ²¡æœ‰å¯¹åº”äºHTTP/2çš„<code class="fe kx ky kz la b">http.ReadRequest</code>å‡½æ•°ã€‚ç›¸åï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨<code class="fe kx ky kz la b">golang.org/x/net/http2</code>åŒ…è§£æå‡ºè¿™äº›é€šè¿‡TCPè¿æ¥ä¼ å…¥çš„å¸§ã€‚</p><p id="c952" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æˆ‘ä»¬é¦–å…ˆéœ€è¦çš„æ˜¯ä¸€ä¸ª<code class="fe kx ky kz la b">Framer</code></p><pre class="ml mm mn mo gt mp la mq mr aw ms bi"><span id="b1e4" class="mt lj iq la b gy mu mv l mw mx">f := http2.NewFramer(conn, conn)</span></pre><p id="50c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ª<code class="fe kx ky kz la b">io.Writer</code>ï¼Œç¬¬äºŒä¸ªæ˜¯ä¸€ä¸ª<code class="fe kx ky kz la b">io.Reader</code>ã€‚ä¸€ä¸ª<code class="fe kx ky kz la b">net.Conn</code>å®ç°äº†è¿™ä¸¤è€…ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç›¸åŒçš„TCPè¿æ¥æ¥è¯»å’Œå†™ã€‚</p><p id="d5e4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">HTTP/2è¦æ±‚åœ¨æ¥æ”¶åˆ°RFC 7540 ä¸­çš„åˆå§‹å¸§æ—¶å‘é€è®¾ç½®ç¡®è®¤ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬åœ¨è¿æ¥æ–­å¼€ä¹‹å‰å®Œæˆè¿™é¡¹å·¥ä½œ</p><pre class="ml mm mn mo gt mp la mq mr aw ms bi"><span id="75d3" class="mt lj iq la b gy mu mv l mw mx">err := f.WriteSettingsAck()<br/>if err != nil {<br/> return err<br/>}</span></pre><p id="e04d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ç°åœ¨æˆ‘ä»¬å·²ç»å»ºç«‹äº†è¿æ¥ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨<code class="fe kx ky kz la b">Framer</code>ä»è¿æ¥ä¸­è¯»å–æ•°æ®å¸§ã€‚å®Œç¾ï¼å”¯ä¸€çš„é—®é¢˜æ˜¯,<code class="fe kx ky kz la b">Framer</code>æ¶ˆè€—äº†æ¥è‡ªTCPè¿æ¥çš„<code class="fe kx ky kz la b">[]byte</code>,å¦‚æœè¯·æ±‚æœ‰æ•ˆï¼Œæˆ‘ä»¬éœ€è¦è½¬å‘å®ƒğŸ¤”ã€‚å› æ­¤ï¼Œå¦‚æœ<code class="fe kx ky kz la b">Framer</code>æ­£åœ¨æ¶ˆè€—å­—èŠ‚ï¼Œæˆ‘ä»¬å¦‚ä½•åœ¨ä¸é‡æ–°å®ç°HTTP/2çš„æƒ…å†µä¸‹å°†æ•°æ®è½¬å‘åˆ°åŸå§‹ä¸»æœºï¼Ÿ</p><p id="4523" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">è¿™å°±æ˜¯<code class="fe kx ky kz la b">io.TeeReader</code>å‰æ¥æ•‘æ´çš„åœ°æ–¹ã€‚æˆ‘ä»¬åªæ˜¯å°†ä»è¿æ¥ä¸­è¯»å–çš„æ‰€æœ‰å­—èŠ‚å¤åˆ¶åˆ°ä¸€ä¸ªç¼“å†²åŒºä¸­ï¼Œå¹¶å°†å®ƒä»¬åˆ†æ´¾ç»™åŸå§‹ä¸»æœº(å¦‚æœè¯·æ±‚æœ‰æ•ˆ)</p><pre class="ml mm mn mo gt mp la mq mr aw ms bi"><span id="5536" class="mt lj iq la b gy mu mv l mw mx">dataBuffer := bytes.NewBuffer(make([]byte, 0))<br/>reader := io.TeeReader(conn, dataBuffer)<br/>f = http2.NewFramer(io.Discard, reader)<br/>decoder := hpack.NewDecoder(1024, nil)</span></pre><p id="4417" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ç°åœ¨ï¼Œæ¯å½“<code class="fe kx ky kz la b">Framer</code>ä»è¿æ¥ä¸­è¯»å–æ—¶ï¼Œå­—èŠ‚ä¹Ÿå°†è¢«å†™å…¥<code class="fe kx ky kz la b">dataBuffer</code>ğŸ‰</p><p id="b840" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æ¥ä¸‹æ¥å°†ä½¿ç”¨<code class="fe kx ky kz la b">decoder</code>é€šè¿‡<code class="fe kx ky kz la b">golang.org/x/net/http2/hpack</code>åŒ…å®é™…è§£ç æŠ¥å¤´</p><p id="2302" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ä»<code class="fe kx ky kz la b">Framer</code>è¯»å–å¸§ï¼Œå¹¶æ£€æŸ¥<code class="fe kx ky kz la b">HeadersFrame</code>ä»¥æŸ¥çœ‹åŸå§‹ä¸»æœº(ä»¥åŠè¯·æ±‚ä¸­æˆ‘ä»¬å…³å¿ƒçš„ä»»ä½•å…¶ä»–å…ƒæ•°æ®)</p><pre class="ml mm mn mo gt mp la mq mr aw ms bi"><span id="b2b9" class="mt lj iq la b gy mu mv l mw mx">auth := ""<br/>for auth == "" {<br/> frame, err := f.ReadFrame()<br/> if err != nil {<br/>  return err<br/> }<br/><br/> switch t := frame.(type) {<br/> case *http2.HeadersFrame:<br/>  out, err := decoder.DecodeFull(t.HeaderBlockFragment())<br/>  if err != nil {<br/>   return err<br/>  }<br/><br/>  for _, v := range out {<br/>   if v.Name == ":authority" {<br/>    auth = v.Value<br/>   }<br/>  }<br/> }<br/>}</span></pre><p id="4e77" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ä»¥ä¸Šå¾ªç¯éå†è¿™äº›å¸§ï¼Œç›´åˆ°æˆ‘ä»¬æ‰¾åˆ°ä¿å­˜äº†<code class="fe kx ky kz la b">:authority</code>çš„<code class="fe kx ky kz la b">HeadersFrame</code>(<a class="ae kw" href="https://www.rfc-editor.org/rfc/rfc7540#section-8.1.2.3" rel="noopener ugc nofollow" target="_blank">ç›¸å½“äºä¸»æœº</a>çš„HTTP/1)ã€‚ä¸€æ—¦æ‰¾åˆ°ï¼Œæˆ‘ä»¬å°±åœæ­¢è¯»å–å¸§ã€‚</p><p id="3f64" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">é…·ï¼ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»é€šè¯»äº†HTTP/2å¸§ï¼Œå¹¶ä¸”çŸ¥é“è¦æ£€æŸ¥å®ƒæ˜¯å¦æœ‰æ•ˆçš„åŸå§‹ä¸»æœº</p><pre class="ml mm mn mo gt mp la mq mr aw ms bi"><span id="946d" class="mt lj iq la b gy mu mv l mw mx">if auth == "blocked.hostfactor.io" {<br/>  return nil<br/>}</span></pre><p id="4836" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ä½†æ˜¯å¦‚æœ<code class="fe kx ky kz la b">:authority</code>æœ‰æ•ˆå‘¢ï¼Ÿæˆ‘ä»¬å¦‚ä½•å°†ä»<code class="fe kx ky kz la b">Framer</code>è¯»å–çš„æ‰€æœ‰æ•°æ®å‘é€åˆ°åŸå§‹ä¸»æœºï¼Ÿé¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåˆ°åŸå§‹ä¸»æœºçš„æ–°TCPè¿æ¥</p><pre class="ml mm mn mo gt mp la mq mr aw ms bi"><span id="b7cf" class="mt lj iq la b gy mu mv l mw mx">dialer, err := net.Dial("tcp", auth)<br/>if err != nil {<br/> return err<br/>}</span></pre><p id="8e1d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ç°åœ¨ï¼Œç”±äºæˆ‘ä»¬ä¸ºå®¢æˆ·æœºä½¿ç”¨äº†ä¸€ä¸ªåŸå§‹çš„TCPè¿æ¥ï¼Œæˆ‘ä»¬å°†ä¸å¾—ä¸å¤„ç†æ¥è‡ªè¯¥è¿æ¥çš„è¯»å’Œå†™ã€‚è®©æˆ‘ä»¬ä»é˜…è¯»æ–¹é¢å¼€å§‹</p><pre class="ml mm mn mo gt mp la mq mr aw ms bi"><span id="39f2" class="mt lj iq la b gy mu mv l mw mx">// The WaitGroup ensures that every byte is read before exiting<br/>wg := sync.WaitGroup{}<br/>wg.Add(1)<br/>dataSent := int64(0)<br/>go func() {<br/> // Copy any data we receive from the host into the original connection<br/> dataSent, err = io.Copy(conn, dialer)<br/> wg.Done()<br/>}()</span></pre><p id="95cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ç°åœ¨æˆ‘ä»¬å¯ä»¥å¤„ç†å¯¹åŸå§‹ä¸»æœºçš„å†™å…¥</p><pre class="ml mm mn mo gt mp la mq mr aw ms bi"><span id="b0be" class="mt lj iq la b gy mu mv l mw mx">_, err = io.Copy(dialer, io.MultiReader(initial, dataBuffer, conn))<br/>wg.Wait()</span></pre><p id="9262" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kx ky kz la b">initial</code>æ˜¯ä»è¯·æ±‚æ–¹è¯»å–çš„åˆå§‹å­—èŠ‚ï¼Œ<code class="fe kx ky kz la b">dataBuffer</code>æ˜¯æˆ‘ä»¬ä»è¿æ¥ä¸­è¯»å–ä»¥æ£€æŸ¥å¸§çš„å­—èŠ‚ï¼Œ<code class="fe kx ky kz la b">conn</code>æ˜¯åŸå§‹å­—èŠ‚ã€‚ä¸€ä¸ª<code class="fe kx ky kz la b">MultiReader</code>ç®€å•åœ°å°†æ‰€æœ‰è¿™äº›é“¾æ¥åœ¨ä¸€èµ·ï¼Œè¿™æ ·å®ƒä»¬å°±å¯ä»¥æŒ‰é¡ºåºè¯»å–å¹¶å‘é€ç»™åŸå§‹ä¸»æœºã€‚è¿™ä¿è¯äº†æˆ‘ä»¬åˆ°ç›®å‰ä¸ºæ­¢è¯»å–çš„æ‰€æœ‰æ•°æ®éƒ½å°†è¢«å‘é€åˆ°åŸå§‹ä¸»æœºã€‚å°†æ‰€æœ‰è¿™äº›æ”¾åœ¨ä¸€èµ·çœ‹èµ·æ¥åƒ</p><pre class="ml mm mn mo gt mp la mq mr aw ms bi"><span id="49a7" class="mt lj iq la b gy mu mv l mw mx">func handleHttp2(initial io.Reader, conn net.Conn) error {<br/> defer func() {<br/>   _ = conn.Close()<br/> }()<br/> dataBuffer := bytes.NewBuffer(make([]byte, 0))<br/> reader := io.TeeReader(conn, dataBuffer)<br/> f := http2.NewFramer(conn, conn)<br/> err := f.WriteSettingsAck()<br/> if err != nil {<br/>  return err<br/> }<br/><br/> f = http2.NewFramer(io.Discard, reader)<br/> decoder := hpack.NewDecoder(1024, nil)<br/><br/> auth := ""<br/> for auth == "" {<br/>  frame, err := f.ReadFrame()<br/>  if err != nil {<br/>   return err<br/>  }<br/><br/>  switch t := frame.(type) {<br/>  case *http2.HeadersFrame:<br/>   out, err := decoder.DecodeFull(t.HeaderBlockFragment())<br/>   if err != nil {<br/>    return err<br/>   }<br/><br/>   for _, v := range out {<br/>    if v.Name == ":authority" {<br/>     auth = v.Value<br/>    }<br/>   }<br/>  }<br/> }<br/><br/> if auth == "blocked.hostfactor.io" {<br/>  return nil<br/> }<br/><br/> dialer, err := net.Dial("tcp", auth)<br/> if err != nil {<br/>  return err<br/> }<br/><br/> _ = dialer.SetReadDeadline(time.Now().Add(5 * time.Second))<br/><br/> wg := sync.WaitGroup{}<br/> wg.Add(1)<br/> dataSent := int64(0)<br/> go func() {<br/>  // Copy any data we receive from the host into the original connection<br/>  dataSent, err = io.Copy(conn, dialer)<br/>  wg.Done()<br/> }()<br/><br/> _, err = io.Copy(dialer, io.MultiReader(initial, dataBuffer, conn))<br/> wg.Wait()<br/><br/> if errors.Is(err, os.ErrDeadlineExceeded) &amp;&amp; dataSent &gt; 0 {<br/>  return nil<br/> }<br/> return err<br/>}</span></pre></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><p id="ffa2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ç°åœ¨ä½ çŸ¥é“äº†ï¼èƒ½å¤Ÿé˜»æ­¢ä»»ä½•é€šè¿‡HTTP/1æˆ–HTTP/2æ¥æ”¶çš„æµé‡çš„ä»£ç†æœåŠ¡å™¨ã€‚</p><p id="f454" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æˆ‘ä»¬åœ¨<a class="ae kw" href="https://hostfactor.io/" rel="noopener ugc nofollow" target="_blank"> Host Factor </a>åˆ©ç”¨å¤§é‡Goå’Œå…¶ä»–å‡ é¡¹ç°ä»£æŠ€æœ¯æ¥ç¡®ä¿æˆ‘ä»¬çš„å®¢æˆ·æ‹¥æœ‰æ‰˜ç®¡å…¶åº”ç”¨ç¨‹åºçš„æœ€ä½³ä½“éªŒã€‚è¯·æ£€æŸ¥ä¸€ä¸‹ï¼</p></div></div>    
</body>
</html>