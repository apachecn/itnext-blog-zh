<html>
<head>
<title>Docker + Rails + Puma + Nginx + Postgres</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">docker+Rails+Puma+Nginx+Postgres</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://itnext.io/docker-rails-puma-nginx-postgres-999cd8866b18?source=collection_archive---------1-----------------------#2018-02-22">https://itnext.io/docker-rails-puma-nginx-postgres-999cd8866b18?source=collection_archive---------1-----------------------#2018-02-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/c060811afbac160085c42605818b1130.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w77ZoWUmK-mCdSkfjZuhxA.jpeg"/></div></div></figure><p id="6329" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">å¦‚æœæ‚¨æ­£åœ¨ç¼–å†™ä¸€ä¸ªrailsåº”ç”¨ç¨‹åºå¹¶ä½¿ç”¨dockeræ¥éƒ¨ç½²æ‚¨çš„åº”ç”¨ç¨‹åºã€‚è¿™ç¯‡æ–‡ç« æ˜¯ç»™ä½ çš„ã€‚</p><p id="f4cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">åœ¨è¿™é‡Œï¼Œæˆ‘åˆ†äº«ç”Ÿäº§å°±ç»ªçš„é…ç½®æ–‡ä»¶ï¼Œè¿™å°†æœ‰åŠ©äºæ‚¨åŠ å¿«éƒ¨ç½²è¿‡ç¨‹ã€‚</p><h1 id="c301" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">è®¾ç½®</h1><p id="fa9c" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">åœ¨ä½ çš„é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º<code class="fe lz ma mb mc b">docker</code>çš„æ–‡ä»¶å¤¹ï¼Œç°åœ¨åœ¨é‡Œé¢å†åˆ›å»ºä¸¤ä¸ªç›®å½•<code class="fe lz ma mb mc b">app</code>å’Œ<code class="fe lz ma mb mc b">web</code>ã€‚</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="8219" class="ml kx iq mc b gy mm mn l mo mp">-app_name<br/>  -app<br/>  -db<br/>  -config<br/>    -database.yml<br/>  ...<br/>  -docker<br/>    -app<br/>      -DockerFile<br/>    -web<br/>      -DockerFile<br/>      -nginx.conf<br/>  -docker-compose.yml</span></pre><blockquote class="mq mr ms"><p id="aa82" class="jy jz mt ka b kb kc kd ke kf kg kh ki mu kk kl km mv ko kp kq mw ks kt ku kv ij bi translated">æˆ‘ä»¬åˆ›å»ºçš„æ–‡ä»¶å¤¹ç»“æ„åªæ˜¯ä¸ºäº†ä»¥æ¨¡å—åŒ–çš„æ–¹å¼ä¿å­˜æˆ‘ä»¬çš„æ–‡ä»¶ï¼Œä½ å¯ä»¥æŠŠå®ƒä¿å­˜åœ¨ä»»ä½•ä½ æƒ³è¦çš„åœ°æ–¹ã€‚</p></blockquote><h1 id="3b59" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">å°†ä½ çš„Railsåº”ç”¨å½’æ¡£</h1><p id="09c1" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">å°†rails appçš„<em class="mt"> DockerFile </em>æ”¾å…¥<code class="fe lz ma mb mc b">app</code>æ–‡ä»¶å¤¹ä¸­ã€‚</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="60d4" class="ml kx iq mc b gy mm mn l mo mp">FROM ruby:2.3.1</span><span id="8151" class="ml kx iq mc b gy mx mn l mo mp">RUN apt-get update -qq &amp;&amp; apt-get install -y build-essential libpq-dev nodejs </span><span id="dda6" class="ml kx iq mc b gy mx mn l mo mp"># Set an environment variable where the Rails app is installed to inside of Docker image</span><span id="d2cc" class="ml kx iq mc b gy mx mn l mo mp">ENV RAILS_ROOT /var/www/app_name<br/>RUN mkdir -p $RAILS_ROOT </span><span id="bdf9" class="ml kx iq mc b gy mx mn l mo mp"># Set working directory<br/>WORKDIR $RAILS_ROOT</span><span id="bc34" class="ml kx iq mc b gy mx mn l mo mp"># Setting env up<br/>ENV RAILS_ENV='production'<br/>ENV RACK_ENV='production' </span><span id="1e75" class="ml kx iq mc b gy mx mn l mo mp"># Adding gems<br/>COPY Gemfile Gemfile<br/>COPY Gemfile.lock Gemfile.lock</span><span id="3bcb" class="ml kx iq mc b gy mx mn l mo mp">RUN bundle install --jobs 20 --retry 5 --without development test </span><span id="fd16" class="ml kx iq mc b gy mx mn l mo mp"># Adding project files<br/>COPY . .<br/>RUN bundle exec rake assets:precompile</span><span id="b6e3" class="ml kx iq mc b gy mx mn l mo mp">EXPOSE 3000</span><span id="43be" class="ml kx iq mc b gy mx mn l mo mp">CMD ["bundle", "exec", "puma", "-C", "config/puma.rb"]</span></pre><p id="2b46" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">è¿™äº›é…ç½®å°†å®‰è£…åŸºæœ¬çš„ç³»ç»Ÿéœ€æ±‚ï¼Œå°†æ‚¨çš„é¡¹ç›®å¤åˆ¶åˆ°dockerå®¹å™¨ï¼Œå®‰è£…gemsï¼Œé¢„ç¼–è¯‘æ‚¨çš„èµ„äº§ã€‚</p><h1 id="2211" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">ä»£ç†æ‚¨çš„webè¯·æ±‚</h1><p id="5fae" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">æˆ‘ä»¬éœ€è¦ä¸€ä¸ª<a class="ae my" href="https://en.wikipedia.org/wiki/Reverse_proxy" rel="noopener ugc nofollow" target="_blank">åå‘ä»£ç†</a>ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯Nginx webæœåŠ¡å™¨ï¼Œæ¥ä»£ç†å¯¹Pumaçš„è¯·æ±‚</p><h2 id="948a" class="ml kx iq bd ky mz na dn lc nb nc dp lg kj nd ne lk kn nf ng lo kr nh ni ls nj bi translated">Nginxçš„DockerFile</h2><p id="bb36" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">å°†Nginxçš„<em class="mt"> DockerFile </em>æ”¾å…¥<code class="fe lz ma mb mc b">web</code>æ–‡ä»¶å¤¹</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="9156" class="ml kx iq mc b gy mm mn l mo mp"># Base image<br/>FROM nginx</span><span id="654f" class="ml kx iq mc b gy mx mn l mo mp"># Install dependencies<br/>RUN apt-get update -qq &amp;&amp; apt-get -y install apache2-utils</span><span id="c030" class="ml kx iq mc b gy mx mn l mo mp"># establish where Nginx should look for files<br/>ENV RAILS_ROOT /var/www/app_name</span><span id="bc9d" class="ml kx iq mc b gy mx mn l mo mp"># Set our working directory inside the image<br/>WORKDIR $RAILS_ROOT</span><span id="917f" class="ml kx iq mc b gy mx mn l mo mp"># create log directory<br/>RUN mkdir log</span><span id="244e" class="ml kx iq mc b gy mx mn l mo mp"># copy over static assets<br/>COPY public public/</span><span id="b680" class="ml kx iq mc b gy mx mn l mo mp"># Copy Nginx config template<br/>COPY docker/web/nginx.conf /tmp/docker.nginx</span><span id="2b0d" class="ml kx iq mc b gy mx mn l mo mp"># substitute variable references in the Nginx config template for real values from the environment <br/># put the final config in its place</span><span id="1f9c" class="ml kx iq mc b gy mx mn l mo mp">RUN envsubst '$RAILS_ROOT' &lt; /tmp/docker.nginx &gt; /etc/nginx/conf.d/default.conf</span><span id="5d5c" class="ml kx iq mc b gy mx mn l mo mp">EXPOSE 80</span><span id="a07a" class="ml kx iq mc b gy mx mn l mo mp"># Use the "exec" form of CMD so Nginx shuts down gracefully on SIGTERM (i.e. `docker stop`)<br/>CMD [ "nginx", "-g", "daemon off;" ]</span></pre><h2 id="d08e" class="ml kx iq bd ky mz na dn lc nb nc dp lg kj nd ne lk kn nf ng lo kr nh ni ls nj bi translated">Nginxé…ç½®æ–‡ä»¶</h2><p id="f3fe" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">å°†<em class="mt"> nginx.conf </em>æ”¾åˆ°<code class="fe lz ma mb mc b">web</code>æ–‡ä»¶å¤¹ä¸­</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="5d0a" class="ml kx iq mc b gy mm mn l mo mp">upstream rails_app {  <br/>   server app:3000;<br/>} </span><span id="057c" class="ml kx iq mc b gy mx mn l mo mp">server {  <br/>   # define your domain  <br/>   server_name www.example.com;   </span><span id="0575" class="ml kx iq mc b gy mx mn l mo mp">   # define the public application root  <br/>   root   $RAILS_ROOT/public;  <br/>   index  index.html;</span><span id="0551" class="ml kx iq mc b gy mx mn l mo mp">   # define where Nginx should write its logs  <br/>   access_log $RAILS_ROOT/log/nginx.access.log;  <br/>   error_log $RAILS_ROOT/log/nginx.error.log;   <br/>  <br/>   # deny requests for files that should never be accessed  <br/>   location ~ /\. {    <br/>      deny all;  <br/>   }</span><span id="a0c2" class="ml kx iq mc b gy mx mn l mo mp">   location ~* ^.+\.(rb|log)$ {    <br/>      deny all;  <br/>   }  <br/> <br/>   # serve static (compiled) assets directly if they exist (for rails production)  <br/>   location ~ ^/(assets|images|javascripts|stylesheets|swfs|system)/   {    <br/>      try_files $uri @rails;     <br/>      access_log off;    <br/>      gzip_static on; </span><span id="3541" class="ml kx iq mc b gy mx mn l mo mp">      # to serve pre-gzipped version     <br/>      expires max;    <br/>      add_header Cache-Control public;     <br/>      <br/>      add_header Last-Modified "";    <br/>      add_header ETag "";    <br/>      break;  <br/>   } <br/>  <br/>   # send non-static file requests to the app server  <br/>   location / {    <br/>      try_files $uri @rails;  <br/>   }   </span><span id="aefe" class="ml kx iq mc b gy mx mn l mo mp">   location @rails {    <br/>      proxy_set_header  X-Real-IP  $remote_addr;    <br/>      proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;         </span><span id="01ed" class="ml kx iq mc b gy mx mn l mo mp">      proxy_set_header Host $http_host;    <br/>      proxy_redirect off;    <br/>      proxy_pass http://rails_app;  <br/>   }<br/>}</span></pre><h1 id="e997" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">ä»‹ç»Dockerç¼–å†™å™¨</h1><p id="ec3c" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">å› ä¸ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå°†è·¨å¤šä¸ªå®¹å™¨è¿è¡Œï¼Œæ‰€ä»¥æœ€å¥½å°†å®ƒä»¬ä½œä¸ºä¸€ä¸ªå®¹å™¨æ¥æ§åˆ¶ã€‚è¿™å°±æ˜¯Docker Composeä¸ºæˆ‘ä»¬åšçš„äº‹æƒ…ã€‚è¦ä½¿ç”¨Docker Composeå¯åŠ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œè¯·åœ¨Railsåº”ç”¨ç¨‹åºçš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶<em class="mt"> docker-compose.yml </em>ã€‚</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="075a" class="ml kx iq mc b gy mm mn l mo mp">version: '3'</span><span id="9682" class="ml kx iq mc b gy mx mn l mo mp">volumes:  <br/>  postgres_data: {} </span><span id="386a" class="ml kx iq mc b gy mx mn l mo mp">services:  <br/>  app:    <br/>    build:      <br/>      context: .      <br/>      dockerfile: ./docker/app/DockerFile    <br/>    depends_on:      <br/>      - db  </span><span id="aee6" class="ml kx iq mc b gy mx mn l mo mp">  db:    <br/>    image: postgres    <br/>    volumes:      <br/>      - postgres_data:/var/lib/postgresql/data  </span><span id="d4c6" class="ml kx iq mc b gy mx mn l mo mp">  web:    <br/>    build:      <br/>      context: .      <br/>      dockerfile: ./docker/web/DockerFile    <br/>    depends_on:      <br/>      - app    <br/>    ports:      <br/>      - 80:80</span></pre><h1 id="76f4" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">å°†æ‚¨çš„æ•°æ®åº“å®¹å™¨åŒ–</h1><p id="63e9" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">æˆ‘ä»¬ç”¨æ¥è¿è¡ŒPostgresæ•°æ®åº“çš„åä¸ºâ€œdbâ€çš„å¼•ç”¨dockerå®¹å™¨ã€‚ä½ éœ€è¦æ›´æ–°ä½ çš„<em class="mt">æ•°æ®åº“</em></p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="86f1" class="ml kx iq mc b gy mm mn l mo mp">default: &amp;default  <br/>  adapter: postgresql  <br/>  encoding: unicode  <br/>  username: postgres  <br/>  password:  <br/>  pool: 5  <br/>  host: db </span><span id="c3ea" class="ml kx iq mc b gy mx mn l mo mp">production:  <br/>  &lt;&lt;: *default  <br/>  database: app_name_production</span></pre></div><div class="ab cl nk nl hu nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ij ik il im in"><p id="2a51" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æ­¤æ—¶ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿä½¿ç”¨<code class="fe lz ma mb mc b">docker-compose build</code>æ„å»ºæ‰€æœ‰å®¹å™¨</p><p id="92ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ä¸€æ—¦æ„å»ºå®Œæˆï¼Œä½ å¯ä»¥ç”¨<code class="fe lz ma mb mc b">docker-compose run app rake db:create RAILS_ENV=production</code>åˆå§‹åŒ–ä½ çš„æ•°æ®åº“ï¼Œç„¶åç”¨<code class="fe lz ma mb mc b">docker-compose run app rake db:migrate db:seed RAILS_ENV=production</code>å¡«å……å®ƒã€‚</p><blockquote class="mq mr ms"><p id="487d" class="jy jz mt ka b kb kc kd ke kf kg kh ki mu kk kl km mv ko kp kq mw ks kt ku kv ij bi translated">å¦‚æœæ‚¨å¸Œæœ›æ‚¨çš„å®¹å™¨æ¯æ¬¡éƒ½è¿è¡Œç›¸åŒçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œé‚£ä¹ˆæ‚¨åº”è¯¥è€ƒè™‘å°†entrypointä¸<a class="ae my" href="https://docs.docker.com/engine/reference/builder/#/cmd" rel="noopener ugc nofollow" target="_blank"> CMD </a>ç»“åˆä½¿ç”¨ã€‚å‚è§<a class="ae my" href="https://docs.docker.com/glossary/?term=ENTRYPOINT" rel="noopener ugc nofollow" target="_blank">å…¥å£ç‚¹</a></p></blockquote><p id="564b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ç°åœ¨æˆ‘ä»¬ç»ˆäºå¯ä»¥ç”¨<code class="fe lz ma mb mc b">docker-compose up -d</code>è¿è¡Œåº”ç”¨ç¨‹åºäº†ã€‚</p><p id="7b91" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">è¦éªŒè¯æ‰€æœ‰ä¸‰ä¸ªå®¹å™¨éƒ½å¯åŠ¨å¹¶è¿è¡Œï¼Œè¯·æ‰§è¡Œ<code class="fe lz ma mb mc b">docker ps</code></p><h1 id="6ccb" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">ç»“è®º</h1><p id="8076" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">é€šè¿‡æ­£ç¡®çš„Dockerè®¾ç½®ï¼Œè½¯ä»¶éƒ¨ç½²è¿‡ç¨‹å¯ä»¥æ¯”ä»¥å¾€ä»»ä½•æ—¶å€™éƒ½æ›´å¿«ã€‚æ­¤å¤–ï¼Œæ— è®ºåº”ç”¨ç¨‹åºåœ¨å“ªé‡Œè¿è¡Œï¼Œæ‚¨éƒ½å¯ä»¥ç¡®ä¿ä¸€è‡´çš„ç¯å¢ƒã€‚</p><p id="086f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">æŸ¥çœ‹<a class="ae my" href="https://gist.github.com/satendra02/1b335b06bfc5921df486f26bd98e0e89" rel="noopener ugc nofollow" target="_blank"> Githubè¦ç‚¹</a></p><h1 id="f7ab" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">é‡è¦è¯´æ˜</h1><p id="9e20" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">å¦‚æœä½ æœ‰ä»»ä½•å…³äºå®ç°çš„é—®é¢˜ï¼Œä¸è¦å¿˜è®°æ£€æŸ¥ä¸‹é¢çš„è¯„è®ºï¼Œä¹Ÿè®¸æˆ‘å·²ç»å›ç­”äº†ä½ çš„é—®é¢˜ã€‚</p><blockquote class="mq mr ms"><p id="409e" class="jy jz mt ka b kb kc kd ke kf kg kh ki mu kk kl km mv ko kp kq mw ks kt ku kv ij bi translated">æ­¤å¤–ï¼Œå¯¹äºRuby &amp; Rails <strong class="ka ir"> </strong>çš„æ›´æ–°ç‰ˆæœ¬ï¼Œè¯·æŸ¥çœ‹<a class="ae my" href="https://scotto.medium.com/2021-docker-ruby-3-rails-6-puma-nginx-postgres-d84c95f68637" rel="noopener">è¿™ç¯‡æ–‡ç« </a>ä½œè€…<a class="ae my" href="https://scotto.medium.com/" rel="noopener"><strong class="ka ir">joo Scotto</strong></a></p></blockquote><p id="3cdf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">(é€šè¿‡æä¾›å¸®åŠ©å…¶ä»–äººæ‰¾åˆ°æˆ‘åœ¨Mediumä¸Šçš„æ–‡ç« ğŸ‘ğŸ½ä¸‹é¢ã€‚)</p></div></div>    
</body>
</html>