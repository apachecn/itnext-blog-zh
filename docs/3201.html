<html>
<head>
<title>Autoscaling Kubernetes apps with Prometheus and KEDA</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ç”¨æ™®ç½—ç±³ä¿®æ–¯å’ŒKEDAè‡ªåŠ¨ç¼©æ”¾Kubernetesåº”ç”¨ç¨‹åº</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://itnext.io/tutorial-auto-scale-your-kubernetes-apps-with-prometheus-and-keda-c6ea460e4642?source=collection_archive---------0-----------------------#2019-10-23">https://itnext.io/tutorial-auto-scale-your-kubernetes-apps-with-prometheus-and-keda-c6ea460e4642?source=collection_archive---------0-----------------------#2019-10-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="7a4a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">å¯ä¼¸ç¼©æ€§æ˜¯äº‘åŸç”Ÿåº”ç”¨çš„å…³é”®è¦æ±‚ã€‚ä½¿ç”¨<a class="ae ko" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>ï¼Œæ‰©å±•æ‚¨çš„åº”ç”¨ç¨‹åºå°±åƒå¢åŠ ç›¸åº”<code class="fe kp kq kr ks b">Deployment</code>æˆ–<code class="fe kp kq kr ks b">ReplicaSet</code>çš„å‰¯æœ¬æ•°é‡ä¸€æ ·ç®€å•â€”â€”ä½†æ˜¯ï¼Œè¿™æ˜¯ä¸€ä¸ªæ‰‹åŠ¨è¿‡ç¨‹ã€‚Kubernetesä½¿ç”¨<a class="ae ko" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.16/#horizontalpodautoscaler-v1-autoscaling" rel="noopener ugc nofollow" target="_blank">æ°´å¹³çª—æ ¼è‡ªåŠ¨ç¼©æ”¾å™¨</a>è§„èŒƒï¼Œä»¥å£°æ˜çš„æ–¹å¼è‡ªåŠ¨ç¼©æ”¾æ‚¨çš„åº”ç”¨ç¨‹åº(å³<code class="fe kp kq kr ks b">Deployment</code>æˆ–<code class="fe kp kq kr ks b">ReplicaSet</code>ä¸­çš„<code class="fe kp kq kr ks b">Pod</code>)ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ”¯æŒä½¿ç”¨CPUåˆ©ç”¨ç‡(<code class="fe kp kq kr ks b">Resource</code>æŒ‡æ ‡)ä½œä¸ºè‡ªåŠ¨ä¼¸ç¼©çš„æ ‡å‡†ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥é›†æˆè‡ªå®šä¹‰å’Œå¤–éƒ¨æä¾›çš„æŒ‡æ ‡ã€‚</p><p id="6330" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">è¿™ç¯‡åšå®¢å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨å¤–éƒ¨æŒ‡æ ‡æ¥è‡ªåŠ¨è°ƒæ•´Kubernetesåº”ç”¨ç¨‹åºã€‚å‡ºäºæ¼”ç¤ºç›®çš„ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨é€šè¿‡<a class="ae ko" href="https://prometheus.io/" rel="noopener ugc nofollow" target="_blank"> Prometheus </a>å…¬å¼€çš„HTTPè®¿é—®è¯·æ±‚åº¦é‡ã€‚æˆ‘ä»¬ä¸ç›´æ¥ä½¿ç”¨<code class="fe kp kq kr ks b">Horizontal Pod Autoscaler</code>ï¼Œè€Œæ˜¯åˆ©ç”¨<a class="ae ko" href="https://github.com/kedacore/keda" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu"> Kubernetesäº‹ä»¶é©±åŠ¨çš„è‡ªåŠ¨ä¼¸ç¼©</strong>åˆå<strong class="js iu">KEDA</strong></a>â€”â€”ä¸€ä¸ªå¼€æºçš„Kubernetesæ“ä½œå™¨ï¼Œå®ƒä¸<code class="fe kp kq kr ks b">Horizontal Pod Autoscaler</code>æœ¬æœºé›†æˆï¼Œä¸ºäº‹ä»¶é©±åŠ¨çš„å·¥ä½œè´Ÿè½½æä¾›ç»†ç²’åº¦çš„è‡ªåŠ¨ä¼¸ç¼©(åŒ…æ‹¬ä»é›¶åˆ°é›¶)ã€‚</p><p id="8f33" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">è¯¥ä»£ç å¯åœ¨<a class="ae ko" href="https://github.com/abhirockzz/kubernetes-keda-prometheus" rel="noopener ugc nofollow" target="_blank"> GitHub </a>ä¸Šè·å¾—</p><blockquote class="kt ku kv"><p id="1094" class="jq jr kw js b jt ju jv jw jx jy jz ka kx kc kd ke ky kg kh ki kz kk kl km kn im bi translated">æˆ‘å¸Œæœ›å¾—åˆ°æ‚¨çš„åé¦ˆå’Œå»ºè®®ï¼æ¬¢è¿éšæ„å‘è¡¨ <a class="ae ko" href="https://twitter.com/abhi_tweeter" rel="noopener ugc nofollow" target="_blank"> <em class="it">æ¨æ–‡</em> </a> <em class="it">æˆ–å‘è¡¨è¯„è®ºğŸ˜ƒ</em></p></blockquote><h1 id="5c05" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">æ¦‚è§‚</h1><p id="3b4e" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">è¿™é‡Œæ€»ç»“äº†ç«¯åˆ°ç«¯çš„å·¥ä½œæ–¹å¼â€”â€”è¿™ä¸€éƒ¨åˆ†å°†è¯¦ç»†è®¨è®ºæ¯ä¸€ç§æ–¹å¼</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi md"><img src="../Images/9002d8fa88549f3d395a858a8b9c7031.png" data-original-src="https://miro.medium.com/v2/resize:fit:748/format:webp/1*LWFL6Vy1qZRQ-j36qnSFIg.jpeg"/></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk translated">äº‹ç‰©å¦‚ä½•åœ¨é«˜å±‚æ¬¡ä¸Šè¿ä½œ</figcaption></figure><ul class=""><li id="41fe" class="mp mq it js b jt ju jx jy kb mr kf ms kj mt kn mu mv mw mx bi translated">è¯¥åº”ç”¨ç¨‹åºä»¥Prometheusæ ¼å¼å…¬å¼€HTTPè®¿é—®è®¡æ•°æŒ‡æ ‡</li><li id="2843" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated">æ™®ç½—ç±³ä¿®æ–¯è¢«é…ç½®ä¸ºæ”¶é›†è¿™äº›æŒ‡æ ‡</li><li id="b27f" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated">KEDAçš„Prometheus scalerç»è¿‡é…ç½®å’Œéƒ¨ç½²ï¼Œå¯æ ¹æ®HTTPè®¿é—®è®¡æ•°æŒ‡æ ‡è‡ªåŠ¨æ‰©å±•åº”ç”¨</li></ul><h1 id="3135" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">KEDAå’Œæ™®ç½—ç±³ä¿®æ–¯</h1><p id="70e3" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">Prometheusæ˜¯ä¸€ä¸ªå¼€æºç³»ç»Ÿç›‘æ§å’Œè­¦æŠ¥å·¥å…·åŒ…ï¼Œæ˜¯<a class="ae ko" href="https://cncf.io/" rel="noopener ugc nofollow" target="_blank">äº‘æœ¬åœ°è®¡ç®—åŸºé‡‘ä¼š</a>çš„ä¸€éƒ¨åˆ†ã€‚Prometheusä»å„ç§æ¥æºæ”¶é›†æŒ‡æ ‡ï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨ä¸ºæ—¶é—´åºåˆ—æ•°æ®ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨åƒ<a class="ae ko" href="https://grafana.com/" rel="noopener ugc nofollow" target="_blank"> Grafana </a>æˆ–å…¶ä»–APIæ¶ˆè´¹è€…è¿™æ ·çš„å·¥å…·æ¥å¯è§†åŒ–æ”¶é›†çš„æ•°æ®ã€‚</p><p id="7040" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">KEDAæ”¯æŒåœ¨KEDAå’Œå¤–éƒ¨ç³»ç»Ÿä¹‹é—´å……å½“æ¡¥æ¢çš„æ¦‚å¿µã€‚ä¸€ä¸ª<code class="fe kp kq kr ks b">Scaler</code>å®ç°ç‰¹å®šäºä¸€ä¸ªç›®æ ‡ç³»ç»Ÿï¼Œå¹¶ä»ä¸­è·å–ç›¸å…³æ•°æ®ï¼Œç„¶åè¢«KEDAç”¨æ¥å¸®åŠ©é©±åŠ¨è‡ªåŠ¨æ‰©å±•ã€‚æ”¯æŒ<a class="ae ko" href="https://github.com/kedacore/keda#event-sources-and-scalers" rel="noopener ugc nofollow" target="_blank">å¤šç§ç¼©æ”¾å™¨</a>(åŒ…æ‹¬Kafkaï¼ŒRedisç­‰ã€‚)åŒ…æ‹¬æ™®ç½—ç±³ä¿®æ–¯ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥ä½¿ç”¨æ™®ç½—ç±³ä¿®æ–¯æŒ‡æ ‡ä½œä¸ºæ ‡å‡†ï¼Œåˆ©ç”¨KEDAæ¥è‡ªåŠ¨è°ƒæ•´ä½ çš„T2ã€‚</p><h1 id="ba56" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">ç¤ºä¾‹åº”ç”¨ç¨‹åº</h1><p id="8824" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">ç¤ºä¾‹<a class="ae ko" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank"> Golang </a>åº”ç”¨ç¨‹åºå…¬å¼€äº†ä¸€ä¸ªHTTPç«¯ç‚¹ï¼Œå¹¶åšäº†ä¸¤ä»¶é‡è¦çš„äº‹æƒ…:</p><ul class=""><li id="fc02" class="mp mq it js b jt ju jx jy kb mr kf ms kj mt kn mu mv mw mx bi translated">ä½¿ç”¨<a class="ae ko" href="https://github.com/prometheus/client_golang/" rel="noopener ugc nofollow" target="_blank"> Prometheus Goå®¢æˆ·ç«¯åº“</a>æ¥æ£€æµ‹åº”ç”¨ç¨‹åºï¼Œå¹¶å…¬å¼€ç”±<code class="fe kp kq kr ks b"><a class="ae ko" href="https://godoc.org/github.com/prometheus/client_golang/prometheus#Counter" rel="noopener ugc nofollow" target="_blank">Counter</a></code>æ”¯æŒçš„<code class="fe kp kq kr ks b">http_requests</code>æŒ‡æ ‡ã€‚æ™®ç½—ç±³ä¿®æ–¯æŒ‡æ ‡ç»ˆç‚¹åœ¨<code class="fe kp kq kr ks b">/metrics</code>å¯ç”¨ã€‚</li></ul><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="5e06" class="nh lb it ks b gy ni nj l nk nl">var httpRequestsCounter = promauto.NewCounter(prometheus.CounterOpts{<br/>        Name: "http_requests",<br/>        Help: "number of http requests",<br/>    })</span></pre><ul class=""><li id="ff26" class="mp mq it js b jt ju jx jy kb mr kf ms kj mt kn mu mv mw mx bi translated">ä¸ºäº†å“åº”ä¸€ä¸ª<code class="fe kp kq kr ks b">GET</code>è¯·æ±‚ï¼Œå®ƒè¿˜åœ¨Redisä¸­å¢åŠ äº†ä¸€ä¸ªé”®(<code class="fe kp kq kr ks b">access_count</code>)â€”â€”è¿™æ˜¯ä½œä¸ºHTTPå¤„ç†ç¨‹åºçš„ä¸€éƒ¨åˆ†å®Œæˆä¸€äº›â€œå·¥ä½œâ€çš„ç®€å•æ–¹æ³•ï¼Œä¹Ÿæœ‰åŠ©äºéªŒè¯PrometheusæŒ‡æ ‡(åº”è¯¥ä¸Redisä¸­çš„<code class="fe kp kq kr ks b">access_count</code>çš„å€¼ç›¸åŒ)</li></ul><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="6011" class="nh lb it ks b gy ni nj l nk nl">func main() {<br/>        http.Handle("/metrics", promhttp.Handler())<br/>        http.HandleFunc("/test", func(w http.ResponseWriter, r *http.Request) {<br/>            defer httpRequestsCounter.Inc()<br/>            count, err := client.Incr(redisCounterName).Result()<br/>            if err != nil {<br/>                fmt.Println("Unable to increment redis counter", err)<br/>                os.Exit(1)<br/>            }<br/>            resp := "Accessed on " + time.Now().String() + "\nAccess count " + strconv.Itoa(int(count))<br/>            w.Write([]byte(resp))<br/>        })<br/>        http.ListenAndServe(":8080", nil)<br/>    }</span></pre><p id="49fc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">è¯¥åº”ç”¨ç¨‹åºä½œä¸º<code class="fe kp kq kr ks b">Deployment</code>éƒ¨ç½²åˆ°Kubernetesï¼Œå¹¶ä¸”è¿˜åˆ›å»ºäº†ä¸€ä¸ª<code class="fe kp kq kr ks b">ClusterIP</code>æœåŠ¡ï¼Œä»¥å…è®¸PrometheusæœåŠ¡å™¨æŠ“å–åº”ç”¨ç¨‹åº<code class="fe kp kq kr ks b">/metrics</code>ç«¯ç‚¹ã€‚</p><blockquote class="kt ku kv"><p id="172e" class="jq jr kw js b jt ju jv jw jx jy jz ka kx kc kd ke ky kg kh ki kz kk kl km kn im bi translated"><a class="ae ko" href="https://github.com/abhirockzz/kubernetes-keda-prometheus/blob/master/go-app.yaml" rel="noopener ugc nofollow" target="_blank"> <em class="it">è¿™é‡Œæ˜¯</em> </a> <em class="it">ä¸ºç”³è¯·</em></p></blockquote><h1 id="44a9" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">æ™®ç½—ç±³ä¿®æ–¯æœåŠ¡å™¨</h1><p id="e3d1" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">æ™®ç½—ç±³ä¿®æ–¯éƒ¨ç½²æ¸…å•åŒ…æ‹¬:</p><ul class=""><li id="54c4" class="mp mq it js b jt ju jx jy kb mr kf ms kj mt kn mu mv mw mx bi translated"><code class="fe kp kq kr ks b">ConfigMap</code>æ•æ‰æ™®ç½—ç±³ä¿®æ–¯é…ç½®</li><li id="9b3f" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated"><code class="fe kp kq kr ks b">Deployment</code>å¯¹äºæ™®ç½—ç±³ä¿®æ–¯æœåŠ¡å™¨æœ¬èº«</li><li id="d5a0" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated"><code class="fe kp kq kr ks b">ClusterIP</code>ç”¨äºè®¿é—®Prometheus UIçš„æœåŠ¡</li><li id="1e16" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated"><code class="fe kp kq kr ks b">ClusterRole</code>ã€<code class="fe kp kq kr ks b">ClusterRoleBinding</code>å’Œ<code class="fe kp kq kr ks b">ServiceAccount</code>å…è®¸KubernetesæœåŠ¡å‘ç°å·¥ä½œ</li></ul><blockquote class="kt ku kv"><p id="166b" class="jq jr kw js b jt ju jv jw jx jy jz ka kx kc kd ke ky kg kh ki kz kk kl km kn im bi translated"><a class="ae ko" href="https://github.com/abhirockzz/kubernetes-keda-prometheus/blob/master/prometheus.yaml" rel="noopener ugc nofollow" target="_blank"> <em class="it">è¿™é‡Œæ˜¯æ™®ç½—ç±³ä¿®æ–¯è®¾ç½®</em>çš„æ¸…å• </a> <em class="it"/></p></blockquote><h1 id="1b29" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">KEDAÂ·æ™®ç½—ç±³ä¿®æ–¯</h1><p id="0dee" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">å¦‚å‰æ‰€è¿°ï¼Œ<code class="fe kp kq kr ks b">Scaler</code>å®ç°å……å½“KEDAå’Œå¤–éƒ¨ç³»ç»Ÿä¹‹é—´çš„æ¡¥æ¢ï¼Œéœ€è¦ä»å¤–éƒ¨ç³»ç»Ÿè·å–æŒ‡æ ‡ã€‚<code class="fe kp kq kr ks b">ScaledObject</code>æ˜¯ä¸€ä¸ªå®šåˆ¶èµ„æºï¼Œä¸ºäº†å°†<code class="fe kp kq kr ks b">Deployment</code>ä¸äº‹ä»¶æº(æœ¬ä¾‹ä¸­ä¸ºPrometheus)åŒæ­¥ï¼Œéœ€è¦éƒ¨ç½²è¯¥èµ„æºã€‚å®ƒåŒ…å«å…³äºè¦æ‰©å±•å“ªä¸ª<code class="fe kp kq kr ks b">Deployment</code>çš„ä¿¡æ¯ã€äº‹ä»¶æºçš„å…ƒæ•°æ®(ä¾‹å¦‚è¿æ¥å­—ç¬¦ä¸²æœºå¯†ã€é˜Ÿåˆ—åç§°)ã€è½®è¯¢é—´éš”ã€å†·å´æ—¶é—´ç­‰ã€‚<code class="fe kp kq kr ks b">ScaledObject</code>å°†å¯¼è‡´ç›¸åº”çš„è‡ªåŠ¨ç¼©æ”¾èµ„æº(HPAå®šä¹‰)æ¥ç¼©æ”¾<code class="fe kp kq kr ks b">Deployment</code></p><blockquote class="kt ku kv"><p id="284d" class="jq jr kw js b jt ju jv jw jx jy jz ka kx kc kd ke ky kg kh ki kz kk kl km kn im bi translated"><em class="it">å½“</em> <code class="fe kp kq kr ks b"><em class="it">ScaledObject</em></code> <em class="it">è¢«åˆ é™¤æ—¶ï¼Œç›¸åº”çš„HPAå®šä¹‰è¢«æ¸…é™¤ã€‚</em></p></blockquote><p id="5823" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ä»¥ä¸‹æ˜¯æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ä½¿ç”¨<code class="fe kp kq kr ks b">Prometheus</code>ç¼©æ”¾å™¨çš„ScaledObjectå®šä¹‰</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="3a4e" class="nh lb it ks b gy ni nj l nk nl">apiVersion: keda.k8s.io/v1alpha1<br/>kind: ScaledObject<br/>metadata:<br/>  name: prometheus-scaledobject<br/>  namespace: default<br/>  labels:<br/>    deploymentName: go-prom-app<br/>spec:<br/>  scaleTargetRef:<br/>    deploymentName: go-prom-app<br/>  pollingInterval: 15<br/>  cooldownPeriod:  30<br/>  minReplicaCount: 1<br/>  maxReplicaCount: 10<br/>  triggers:<br/>  - type: prometheus<br/>    metadata:<br/>      serverAddress: http://prometheus-service.default.svc.cluster.local:9090<br/>      metricName: access_frequency<br/>      threshold: '3'<br/>      query: sum(rate(http_requests[2m]))</span></pre><p id="ff59" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">è¯·æ³¨æ„ä»¥ä¸‹äº‹é¡¹:</p><ul class=""><li id="03d3" class="mp mq it js b jt ju jx jy kb mr kf ms kj mt kn mu mv mw mx bi translated">å®ƒçš„ç›®æ ‡æ˜¯åä¸º<code class="fe kp kq kr ks b">go-prom-app</code>çš„<code class="fe kp kq kr ks b">Deployment</code></li><li id="5d03" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated">è§¦å‘ç±»å‹ä¸º<code class="fe kp kq kr ks b">prometheus</code>ã€‚æ™®ç½—ç±³ä¿®æ–¯<code class="fe kp kq kr ks b">serverAddress</code>ä¸<code class="fe kp kq kr ks b">metricName</code>ã€é˜ˆå€¼å’Œ<a class="ae ko" href="https://prometheus.io/docs/prometheus/latest/querying/basics/" rel="noopener ugc nofollow" target="_blank"> PromQLæŸ¥è¯¢</a> ( <code class="fe kp kq kr ks b">sum(rate(http_requests[2m]))</code>)ä¸€èµ·è¢«æåŠ</li><li id="f2f7" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated">æ ¹æ®<code class="fe kp kq kr ks b">pollingInterval</code>ï¼ŒKEDAå°†æ¯<code class="fe kp kq kr ks b">fifteen</code>ç§’è½®è¯¢ä¸€æ¬¡æ™®ç½—ç±³ä¿®æ–¯ç›®æ ‡ã€‚æœ€å°‘ä¿ç•™ä¸€ä¸ª<code class="fe kp kq kr ks b">Pod</code>(<code class="fe kp kq kr ks b">minReplicaCount</code>)ï¼Œæœ€å¤§æ•°é‡çš„<code class="fe kp kq kr ks b">Pod</code>ä¸ä¼šè¶…è¿‡<code class="fe kp kq kr ks b">maxReplicaCount</code>(æœ¬ä¾‹ä¸­ä¸º<code class="fe kp kq kr ks b">ten</code>)</li></ul><blockquote class="kt ku kv"><p id="dc51" class="jq jr kw js b jt ju jv jw jx jy jz ka kx kc kd ke ky kg kh ki kz kk kl km kn im bi translated"><em class="it">å¯ä»¥å°†</em> <code class="fe kp kq kr ks b"><em class="it">minReplicaCount</em></code> <em class="it">è®¾ç½®ä¸º</em> <code class="fe kp kq kr ks b"><em class="it">zero</em></code> <em class="it">ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒKEDAå°†ä»é›¶åˆ°ä¸€â€œæ¿€æ´»â€éƒ¨ç½²ï¼Œç„¶åè®©HPAè¿›ä¸€æ­¥è‡ªåŠ¨æ‰©å±•(åè¿‡æ¥ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå³ä»ä¸€æ‰©å±•åˆ°é›¶)ã€‚æˆ‘ä»¬æ²¡æœ‰é€‰æ‹©zeroï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªHTTPæœåŠ¡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªéšéœ€åº”å˜çš„ç³»ç»Ÿï¼Œæ¯”å¦‚æ¶ˆæ¯é˜Ÿåˆ—/ä¸»é¢˜æ¶ˆè´¹è€…</em></p></blockquote><h2 id="3ef6" class="nh lb it bd lc nm nn dn lg no np dp lk kb nq nr lo kf ns nt ls kj nu nv lw nw bi translated">è‡ªåŠ¨ç§¤èƒŒåçš„é­”åŠ›</h2><p id="bc7d" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated"><code class="fe kp kq kr ks b">threshold</code>è®¡æ•°ç”¨äºè§¦å‘æ‰©å±•éƒ¨ç½²ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼ŒPromQLæŸ¥è¯¢<code class="fe kp kq kr ks b">sum(rate(http_requests[2m]))</code>è¿”å›åœ¨è¿‡å»ä¸¤åˆ†é’Ÿå†…æµ‹é‡çš„æ¯ç§’HTTPè¯·æ±‚ç‡çš„èšåˆå€¼ã€‚ç”±äº<code class="fe kp kq kr ks b">threshold</code>è®¡æ•°æ˜¯<code class="fe kp kq kr ks b">three</code>ï¼Œè¿™æ„å‘³ç€å¦‚æœ<code class="fe kp kq kr ks b">sum(rate(http_requests[2m]))</code>çš„å€¼ä¿æŒå°äº3ï¼Œå°†æœ‰ä¸€ä¸ªPodã€‚å¦‚æœè¯¥å€¼ä¸Šå‡ï¼Œåˆ™æ¯æ¬¡<code class="fe kp kq kr ks b">sum(rate(http_requests[2m]))</code>å¢åŠ <code class="fe kp kq kr ks b">three</code>å°±ä¼šæœ‰ä¸€ä¸ªé¢å¤–çš„<code class="fe kp kq kr ks b">Pod</code>ï¼Œä¾‹å¦‚ï¼Œå¦‚æœè¯¥å€¼åœ¨<code class="fe kp kq kr ks b">12</code>åˆ°<code class="fe kp kq kr ks b">14</code>ä¹‹é—´ï¼Œåˆ™<code class="fe kp kq kr ks b">Pod</code>çš„æ•°é‡å°†ä¸º<code class="fe kp kq kr ks b">4</code></p><p id="56d2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">å¥½äº†ï¼Œæ˜¯æ—¶å€™åŠ¨æ‰‹è¯•è¯•äº†ï¼</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/09043b87b1d5ebe3296415d26cca1339.png" data-original-src="https://miro.medium.com/v2/resize:fit:768/0*0OYxeGcQpy6XNDWX.gif"/></div></figure><h1 id="69e1" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">å…ˆå†³æ¡ä»¶</h1><p id="4e81" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">ä½ æ‰€éœ€è¦çš„åªæ˜¯ä¸€ä¸ªKubernetesé›†ç¾¤å’Œ<code class="fe kp kq kr ks b">kubectl</code></p><p id="794d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Kubernetesé›†ç¾¤â€”â€”è¿™ä¸ªä¾‹å­ä½¿ç”¨äº†<code class="fe kp kq kr ks b">minikube</code>,ä½†æ˜¯ä¹Ÿå¯ä»¥éšæ„ä½¿ç”¨å…¶ä»–çš„ã€‚æ‚¨å¯ä»¥ä½¿ç”¨æ­¤å¯¼è½¨å®‰è£…å®ƒ<a class="ae ko" href="https://kubernetes.io/docs/tasks/tools/install-minikube/" rel="noopener ugc nofollow" target="_blank">ã€‚</a></p><p id="4c66" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">è¦åœ¨Macä¸Šå®‰è£…æœ€æ–°ç‰ˆæœ¬:</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="a98d" class="nh lb it ks b gy ni nj l nk nl">curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 \<br/>&amp;&amp; chmod +x minikube<br/>sudo mkdir -p /usr/local/bin/<br/>sudo install minikube /usr/local/bin/</span></pre><p id="e0be" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">è¯·<a class="ae ko" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank">å®‰è£…</a> <code class="fe kp kq kr ks b"><a class="ae ko" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank">kubectl</a></code>æ¥è®¿é—®æ‚¨çš„Kubernetesé›†ç¾¤ã€‚</p><p id="e610" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">è¦åœ¨Macä¸Šå®‰è£…æœ€æ–°ç‰ˆæœ¬:</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="6c7a" class="nh lb it ks b gy ni nj l nk nl">curl -LO "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/darwin/amd64/kubectl"<br/>chmod +x ./kubectl<br/>sudo mv ./kubectl /usr/local/bin/kubectl<br/>kubectl version</span></pre><h1 id="63a0" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">è®¾ç½®</h1><h1 id="7296" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">å®‰è£…KEDA</h1><p id="46b6" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">æ ¹æ®æ–‡æ¡£ï¼Œæ‚¨å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼<a class="ae ko" href="https://github.com/kedacore/keda#setup" rel="noopener ugc nofollow" target="_blank">éƒ¨ç½²KEDAã€‚æˆ‘åªæ˜¯ç”¨ä¸€ä¸ªæ•´ä½“YAMLæ¥å®Œæˆè¿™é¡¹å·¥ä½œ</a></p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="8df6" class="nh lb it ks b gy ni nj l nk nl">kubectl apply -f <a class="ae ko" href="https://raw.githubusercontent.com/kedacore/keda/master/deploy/KedaScaleController.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kedacore/keda/master/deploy/KedaScaleController.yaml</a></span></pre><blockquote class="kt ku kv"><p id="4127" class="jq jr kw js b jt ju jv jw jx jy jz ka kx kc kd ke ky kg kh ki kz kk kl km kn im bi translated"><em class="it"> KEDAåŠå…¶ç»„ä»¶å®‰è£…åœ¨</em> <code class="fe kp kq kr ks b"><em class="it">keda</em></code> <em class="it">å‘½åç©ºé—´</em>ä¸­</p></blockquote><p id="a27f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ä¸ºäº†è¯å®ï¼Œ</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="bc77" class="nh lb it ks b gy ni nj l nk nl">kubectl get pods -n keda</span></pre><blockquote class="kt ku kv"><p id="9759" class="jq jr kw js b jt ju jv jw jx jy jz ka kx kc kd ke ky kg kh ki kz kk kl km kn im bi translated"><em class="it">ç­‰å¾…KEDAæ“ä½œç¬¦</em> <code class="fe kp kq kr ks b"><em class="it">Pod</em></code> <em class="it">å¯åŠ¨(</em> <code class="fe kp kq kr ks b"><em class="it">Running</em></code> <em class="it">çŠ¶æ€)åå†è¿›è¡Œ</em></p></blockquote><h1 id="f707" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">ä½¿ç”¨Helmè®¾ç½®Redis</h1><p id="13d7" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">å¦‚æœæ‚¨æ²¡æœ‰å®‰è£…å¤´ç›”ï¼Œåªéœ€ä½¿ç”¨æœ¬æŒ‡å—ã€‚åœ¨è‹¹æœç”µè„‘ä¸Šï¼Œä½ å¯ä»¥ä½¿ç”¨</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="5cdc" class="nh lb it ks b gy ni nj l nk nl">brew install kubernetes-helm<br/>helm init --history-max 200</span></pre><blockquote class="kt ku kv"><p id="6bb6" class="jq jr kw js b jt ju jv jw jx jy jz ka kx kc kd ke ky kg kh ki kz kk kl km kn im bi translated"><code class="fe kp kq kr ks b"><em class="it">helm init</em></code> <em class="it">æ˜¯åˆå§‹åŒ–æœ¬åœ°CLIï¼ŒåŒæ—¶å°†</em> <code class="fe kp kq kr ks b"><em class="it">Tiller</em></code> <em class="it">å®‰è£…åˆ°æ‚¨çš„Kubernetesé›†ç¾¤</em></p></blockquote><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="3a9d" class="nh lb it ks b gy ni nj l nk nl">kubectl get pods -n kube-system | grep tiller</span></pre><p id="f5a4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ç­‰å¾…æ‰‹æŸ„<code class="fe kp kq kr ks b">Pod</code>åˆ‡æ¢åˆ°<code class="fe kp kq kr ks b">Running</code>çŠ¶æ€</p><p id="54a7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">è®¾ç½®å¥½ä¸€ä¸ªèˆµï¼Œè·å¾—RedisæœåŠ¡å™¨å°±åƒè¿è¡Œ:</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="7175" class="nh lb it ks b gy ni nj l nk nl">helm install --name redis-server --set cluster.enabled=false --set usePassword=false stable/redis</span></pre><p id="43bc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">è¦ç¡®è®¤Redisæ˜¯å¦å‡†å¤‡å¥½:</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="f669" class="nh lb it ks b gy ni nj l nk nl">kubectl get pods/redis-server-master-0</span></pre><blockquote class="kt ku kv"><p id="473a" class="jq jr kw js b jt ju jv jw jx jy jz ka kx kc kd ke ky kg kh ki kz kk kl km kn im bi translated"><em class="it">ç­‰å¾…RedisæœåŠ¡å™¨</em> <code class="fe kp kq kr ks b"><em class="it">Pod</em></code> <em class="it">å¯åŠ¨(</em> <code class="fe kp kq kr ks b"><em class="it">Running</em></code> <em class="it">çŠ¶æ€)åå†ç»§ç»­</em></p></blockquote><h1 id="4789" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">éƒ¨ç½²åº”ç”¨ç¨‹åº</h1><p id="9094" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">è¦éƒ¨ç½²:</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="f990" class="nh lb it ks b gy ni nj l nk nl">kubectl apply -f go-app.yaml</span><span id="4f1e" class="nh lb it ks b gy ny nj l nk nl">//output<br/>deployment.apps/go-prom-app created<br/>service/go-prom-app-service created</span></pre><p id="a082" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ç¡®è®¤å®ƒæ˜¯å¦åœ¨è¿è¡Œ</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="cdac" class="nh lb it ks b gy ni nj l nk nl">kubectl get pods -l=app=go-prom-app</span></pre><blockquote class="kt ku kv"><p id="bb3b" class="jq jr kw js b jt ju jv jw jx jy jz ka kx kc kd ke ky kg kh ki kz kk kl km kn im bi translated"><em class="it">ç­‰å¾…åº”ç”¨ç¨‹åº</em> <code class="fe kp kq kr ks b"><em class="it">Pod</em></code> <em class="it">å¯åŠ¨(</em> <code class="fe kp kq kr ks b"><em class="it">Running</em></code> <em class="it">çŠ¶æ€)ï¼Œç„¶åç»§ç»­</em></p></blockquote><h1 id="7614" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">éƒ¨ç½²æ™®ç½—ç±³ä¿®æ–¯æœåŠ¡å™¨</h1><p id="4fde" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">æ™®ç½—ç±³ä¿®æ–¯æ¸…å•ä½¿ç”¨é’ˆå¯¹æ™®ç½—ç±³ä¿®æ–¯çš„<a class="ae ko" href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config" rel="noopener ugc nofollow" target="_blank"> KubernetesæœåŠ¡å‘ç°</a>æ¥åŸºäºæœåŠ¡æ ‡ç­¾åŠ¨æ€æ£€æµ‹åº”ç”¨ç¨‹åº</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="02bd" class="nh lb it ks b gy ni nj l nk nl">kubernetes_sd_configs:<br/>    - role: service<br/>    relabel_configs:<br/>    - source_labels: [__meta_kubernetes_service_label_run]<br/>      regex: go-prom-app-service<br/>      action: keep</span></pre><p id="24db" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">è¦éƒ¨ç½²:</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="b42e" class="nh lb it ks b gy ni nj l nk nl">kubectl apply -f prometheus.yaml</span><span id="95e2" class="nh lb it ks b gy ny nj l nk nl">//output<br/>clusterrole.rbac.authorization.k8s.io/prometheus created<br/>serviceaccount/default configured<br/>clusterrolebinding.rbac.authorization.k8s.io/prometheus created<br/>configmap/prom-conf created<br/>deployment.extensions/prometheus-deployment created<br/>service/prometheus-service created</span></pre><p id="7573" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ç¡®è®¤å®ƒæ˜¯å¦åœ¨è¿è¡Œ</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="ffb0" class="nh lb it ks b gy ni nj l nk nl">kubectl get pods -l=app=prometheus-server</span></pre><blockquote class="kt ku kv"><p id="2511" class="jq jr kw js b jt ju jv jw jx jy jz ka kx kc kd ke ky kg kh ki kz kk kl km kn im bi translated"><em class="it">ç­‰å¾…æ™®ç½—ç±³ä¿®æ–¯æœåŠ¡å™¨</em> <code class="fe kp kq kr ks b"><em class="it">Pod</em></code> <em class="it">å¯åŠ¨(</em> <code class="fe kp kq kr ks b"><em class="it">Running</em></code> <em class="it">çŠ¶æ€)åå†ç»§ç»­</em></p></blockquote><p id="f586" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ä½¿ç”¨<code class="fe kp kq kr ks b">kubectl port-forward</code>è®¿é—®Prometheus UIâ€”â€”æ‚¨å¯ä»¥åœ¨<a class="ae ko" href="http://localhost:9090/" rel="noopener ugc nofollow" target="_blank"> http://localhost:9090 </a>è®¿é—®Prometheus UI(æˆ–APIæœåŠ¡å™¨)</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="7382" class="nh lb it ks b gy ni nj l nk nl">kubectl port-forward service/prometheus-service 9090</span></pre><h1 id="7f3c" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">éƒ¨ç½²KEDAè‡ªåŠ¨ç¼©æ”¾é…ç½®</h1><p id="4a2b" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">ä½ éœ€è¦åˆ›å»º<code class="fe kp kq kr ks b">ScaledObject</code></p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="8a7b" class="nh lb it ks b gy ni nj l nk nl">kubectl apply -f keda-prometheus-scaledobject.yaml</span></pre><p id="0e9f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">æ£€æŸ¥KEDAæ“ä½œå‘˜æ—¥å¿—</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="d4f0" class="nh lb it ks b gy ni nj l nk nl">KEDA_POD_NAME=$(kubectl get pods -n keda -o=jsonpath='{.items[0].metadata.name}')<br/>kubectl logs $KEDA_POD_NAME -n keda</span></pre><p id="5006" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ä½ åº”è¯¥çœ‹çœ‹</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="80ee" class="nh lb it ks b gy ni nj l nk nl">time="2019-10-15T09:38:28Z" level=info msg="Watching ScaledObject: default/prometheus-scaledobject"<br/>time="2019-10-15T09:38:28Z" level=info msg="Created HPA with namespace default and name keda-hpa-go-prom-app"</span></pre><p id="c776" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">æ£€æŸ¥åº”ç”¨ç¨‹åº<code class="fe kp kq kr ks b">Pod</code> -åº”è¯¥æœ‰ä¸€ä¸ªå®ä¾‹æ­£åœ¨è¿è¡Œï¼Œå› ä¸º<code class="fe kp kq kr ks b">minReplicaCount</code>æ˜¯<code class="fe kp kq kr ks b">1</code></p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="0d56" class="nh lb it ks b gy ni nj l nk nl">kubectl get pods -l=app=go-prom-app</span></pre><p id="70c4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ç¡®è®¤HPAèµ„æºä¹Ÿå·²åˆ›å»º</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="387d" class="nh lb it ks b gy ni nj l nk nl">kubectl get hpa</span></pre><p id="e794" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">æ‚¨åº”è¯¥ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„å†…å®¹:</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="f55a" class="nh lb it ks b gy ni nj l nk nl">NAME                   REFERENCE                TARGETS     MINPODS   MAXPODS   REPLICAS   AGE<br/>keda-hpa-go-prom-app   Deployment/go-prom-app   0/3 (avg)   1         10        1          45s</span></pre><h1 id="b4a8" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">è‡ªåŠ¨ç¼©æ”¾æ­£åœ¨è¿›è¡Œä¸­â€¦</h1><h1 id="7f2f" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">å¥å…¨æµ‹è¯•:è®¿é—®åº”ç”¨ç¨‹åº</h1><p id="9f68" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">è¦è®¿é—®æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„RESTç«¯ç‚¹ï¼Œåªéœ€è¿è¡Œ:</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="a338" class="nh lb it ks b gy ni nj l nk nl">kubectl port-forward service/go-prom-app-service 8080</span></pre><p id="8f54" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ç°åœ¨ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿä½¿ç”¨<a class="ae ko" href="http://localhost:8080/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080 </a>è®¿é—®Goåº”ç”¨ç¨‹åº</p><p id="7ff1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">è¦è®¿é—®ç«¯ç‚¹:</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="b0a4" class="nh lb it ks b gy ni nj l nk nl">curl <a class="ae ko" href="http://localhost:8080/test" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/test</a></span></pre><p id="ac51" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">æ‚¨åº”è¯¥ä¼šçœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹å†…å®¹çš„å“åº”:</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="32d9" class="nh lb it ks b gy ni nj l nk nl">Accessed on 2019-10-21 11:29:10.560385986 +0000 UTC m=+406004.817901246<br/>Access count 1</span></pre><p id="2459" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">æ­¤æ—¶ï¼Œä¹Ÿè¦æ£€æŸ¥Redisã€‚æ‚¨ä¼šçœ‹åˆ°<code class="fe kp kq kr ks b">access_count</code>é”®å·²ç»å¢åŠ åˆ°1</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="190f" class="nh lb it ks b gy ni nj l nk nl">kubectl exec -it redis-server-master-0 -- redis-cli get access_count<br/>//output<br/>"1"</span></pre><p id="b5a2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ç¡®è®¤<code class="fe kp kq kr ks b">http_requests</code>åº¦é‡è®¡æ•°ä¹Ÿç›¸åŒ</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="1979" class="nh lb it ks b gy ni nj l nk nl">curl http://localhost:8080/metrics | grep http_requests<br/>//output<br/># HELP http_requests number of http requests<br/># TYPE http_requests counter<br/>http_requests 1</span></pre><h1 id="144d" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">ç”Ÿæˆè´Ÿè½½</h1><p id="ae6b" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">æˆ‘ä»¬å°†ä½¿ç”¨<a class="ae ko" href="https://github.com/rakyll/hey" rel="noopener ugc nofollow" target="_blank"> hey </a>ï¼Œä¸€ä¸ªå®ç”¨ç¨‹åºæ¥ç”Ÿæˆè´Ÿè½½</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="08e5" class="nh lb it ks b gy ni nj l nk nl">curl -o hey https://storage.googleapis.com/hey-release/hey_darwin_amd64 &amp;&amp; chmod a+x hey</span></pre><blockquote class="kt ku kv"><p id="9903" class="jq jr kw js b jt ju jv jw jx jy jz ka kx kc kd ke ky kg kh ki kz kk kl km kn im bi translated"><em class="it">ä¹Ÿå¯ä»¥ä¸‹è½½ç»™</em><a class="ae ko" href="https://storage.googleapis.com/hey-release/hey_linux_amd64" rel="noopener ugc nofollow" target="_blank"><em class="it">Linux</em></a><em class="it">æˆ–è€…</em> <a class="ae ko" href="https://storage.googleapis.com/hey-release/hey_windows_amd64" rel="noopener ugc nofollow" target="_blank"> <em class="it"> Windows </em> </a></p></blockquote><p id="8022" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">åƒè¿™æ ·è°ƒç”¨å®ƒ</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="4c24" class="nh lb it ks b gy ni nj l nk nl">./hey <a class="ae ko" href="http://localhost:8080/test" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/test</a></span></pre><p id="5337" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ç”¨ç¨‹åºå‘é€<code class="fe kp kq kr ks b">200</code>è¯·æ±‚ã€‚æ‚¨åº”è¯¥èƒ½å¤Ÿä½¿ç”¨æ™®ç½—ç±³ä¿®æ–¯æŒ‡æ ‡å’ŒRedisæ¥ç¡®è®¤å®ƒ</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="8a3d" class="nh lb it ks b gy ni nj l nk nl">curl http://localhost:8080/metrics | grep http_requests<br/>//output<br/># HELP http_requests number of http requests<br/># TYPE http_requests counter<br/>http_requests 201</span><span id="2a46" class="nh lb it ks b gy ny nj l nk nl">kubectl exec -it redis-server-master-0 -- redis-cli get access_count<br/>//output<br/>201</span></pre><p id="7700" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ç¡®è®¤å®é™…æŒ‡æ ‡(ç”±PromQLæŸ¥è¯¢è¿”å›)</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="8bc4" class="nh lb it ks b gy ni nj l nk nl">curl -g 'http://localhost:9090/api/v1/query?query=sum(rate(http_requests[2m]))'</span><span id="b80b" class="nh lb it ks b gy ny nj l nk nl">//output<br/>{"status":"success","data":{"resultType":"vector","result":[{"metric":{},"value":[1571734214.228,"1.686057971014493"]}]}}</span></pre><p id="f619" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®é™…ç»“æœæ˜¯<code class="fe kp kq kr ks b">1.686057971014493</code>(åœ¨<code class="fe kp kq kr ks b">value</code>)ã€‚è¿™ä¸è¶³ä»¥è§¦å‘æ¨ªå‘æ‰©å±•ï¼Œå› ä¸ºæˆ‘ä»¬è®¾ç½®çš„é˜ˆå€¼æ˜¯<code class="fe kp kq kr ks b">3</code></p><h1 id="946c" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">æ‘©å°”è´Ÿè·ï¼</h1><p id="9104" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">åœ¨æ–°çš„ç»ˆç«¯ä¸­ï¼Œè·Ÿè¸ªåº”ç”¨ç¨‹åº</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="352f" class="nh lb it ks b gy ni nj l nk nl">kubectl get pods -l=app=go-prom-app -w</span></pre><p id="ceef" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">è®©æˆ‘ä»¬æ¨¡æ‹Ÿä¸€ä¸ªé‡è½½:</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="a5e1" class="nh lb it ks b gy ni nj l nk nl">./hey -n 2000 <a class="ae ko" href="http://localhost:8080/test" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/test</a></span></pre><p id="c7e7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">åœ¨æŸä¸ªæ—¶å€™ï¼Œä½ ä¼šçœ‹åˆ°<code class="fe kp kq kr ks b">Deployment</code>å°†è¢«HPAæ‰©å±•ï¼Œæ–°çš„<code class="fe kp kq kr ks b">Pod</code>å°†è¢«åŠ é€Ÿã€‚</p><p id="1202" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">æ£€æŸ¥HPAä»¥ç¡®è®¤ç›¸åŒï¼Œ</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="bd56" class="nh lb it ks b gy ni nj l nk nl">kubectl get hpa</span><span id="15ec" class="nh lb it ks b gy ny nj l nk nl">NAME                   REFERENCE                TARGETS         MINPODS   MAXPODS   REPLICAS   AGE<br/>keda-hpa-go-prom-app   Deployment/go-prom-app   1830m/3 (avg)   1         10        6          4m22s</span></pre><p id="8774" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">å¦‚æœè´Ÿè½½ä¸æŒç»­ï¼Œåˆ™<code class="fe kp kq kr ks b">Deployment</code>å°†æŒ‰æ¯”ä¾‹ç¼©å°åˆ°åªæœ‰ä¸€ä¸ª<code class="fe kp kq kr ks b">Pod</code>è¿è¡Œçš„ç¨‹åº¦</p><p id="85df" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">å¦‚æœæ‚¨ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥å®é™…æŒ‡æ ‡(ç”±PromQLæŸ¥è¯¢è¿”å›)</p><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="c516" class="nh lb it ks b gy ni nj l nk nl">curl -g 'http://localhost:9090/api/v1/query?query=sum(rate(http_requests[2m]))'</span></pre><h1 id="eff0" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">æ‰“æ‰«å«ç”Ÿ</h1><pre class="me mf mg mh gt nd ks ne nf aw ng bi"><span id="7dc1" class="nh lb it ks b gy ni nj l nk nl">//Delete KEDA<br/>kubectl delete namespace keda</span><span id="badb" class="nh lb it ks b gy ny nj l nk nl">//Delete the app, Prometheus server and KEDA scaled object<br/>kubectl delete -f .</span><span id="c26b" class="nh lb it ks b gy ny nj l nk nl">//Delete Redis<br/>helm del --purge redis-server</span></pre><h1 id="77c1" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">ç»“è®º</h1><p id="e116" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">KEDAå…è®¸æ‚¨æ ¹æ®å¤–éƒ¨æŒ‡æ ‡(å¦‚æ™®ç½—ç±³ä¿®æ–¯æŒ‡æ ‡ã€Redisä¸­çš„é˜Ÿåˆ—é•¿åº¦ã€Kafkaä¸»é¢˜çš„æ¶ˆè´¹è€…å»¶è¿Ÿç­‰)çš„æ•°æ®è‡ªåŠ¨æ‰©å±•æ‚¨çš„Kuberneteséƒ¨ç½²(ä»é›¶æ‰©å±•åˆ°é›¶)ã€‚å®ƒå®Œæˆäº†ä¸å¤–éƒ¨èµ„æºé›†æˆçš„æ‰€æœ‰ç¹é‡å·¥ä½œï¼Œå¹¶é€šè¿‡åº¦é‡æœåŠ¡å™¨å…¬å¼€å…¶åº¦é‡ï¼Œä»¥ä¾¿æ°´å¹³Podè‡ªåŠ¨ç¼©æ”¾å™¨å‘æŒ¥å…¶é­”åŠ›ï¼</p><p id="390f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">è¿™ä¸ªåšå®¢åˆ°æ­¤ä¸ºæ­¢ã€‚æ­¤å¤–ï¼Œå¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« æœ‰ç”¨ï¼Œè¯·å–œæ¬¢å¹¶å…³æ³¨ğŸ˜ƒğŸ˜ƒ</p></div></div>    
</body>
</html>